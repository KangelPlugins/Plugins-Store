__id__ = "dynamic_backgrounds"
__name__ = "Dynamic Backgrounds"
__description__ = "–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω –≤ —á–∞—Ç–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã"
__author__ = "@rei_plugins (@optimist_opti)"
__version__ = "5.4.0"
__icon__ = "formyetgplugins_by_fStikBot/9"
__min_version__ = "11.12.0"

# ‚îÄ‚îÄ‚îÄ –¢–ò–ü–´ –≠–§–§–ï–ö–¢–û–í ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
#
#  clear        ‚Üí —Å–æ–ª–Ω—Ü–µ (–≤—Ä–∞—â–∞—é—â–∏–µ—Å—è –ª—É—á–∏) + –º–µ—Ä—Ü–∞—é—â–∏–µ –∏—Å–∫—Ä—ã
#  partly_cloudy‚Üí —Å–æ–ª–Ω—Ü–µ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ–µ + –ø–ª—ã–≤—É—â–∏–µ –æ–±–ª–∞–∫–∞
#  cloudy       ‚Üí —Ç–æ–ª—å–∫–æ –æ–±–ª–∞–∫–∞ (–ø–ª—ã–≤—É—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ)
#  fog          ‚Üí –º–µ–¥–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ –ø—è—Ç–Ω–∞
#  light_rain   ‚Üí —Ä–µ–¥–∫–∏–µ —Ç–æ–Ω–∫–∏–µ –∫–∞–ø–ª–∏ (–º–æ—Ä–æ—Å—å, Patchy rain)
#  rain         ‚Üí –æ–±—ã—á–Ω—ã–π –¥–æ–∂–¥—å
#  thunder      ‚Üí –¥–æ–∂–¥—å + –≤—Å–ø—ã—à–∫–∏ –º–æ–ª–Ω–∏–∏
#  light_snow   ‚Üí —Ä–µ–¥–∫–∏–µ –ª—ë–≥–∫–∏–µ —Å–Ω–µ–∂–∏–Ω–∫–∏
#  snow         ‚Üí –≥—É—Å—Ç–æ–π —Å–Ω–µ–≥ (–∞–ª–≥–æ—Ä–∏—Ç–º SnowflakesEffect.java)
#  sleet        ‚Üí —Å–º–µ—Å—å —Å–Ω–µ–∂–∏–Ω–æ–∫ –∏ –¥–æ–∂–¥–µ–≤—ã—Ö –∫–∞–ø–µ–ª—å
#  hail         ‚Üí –±—ã—Å—Ç—Ä—ã–µ –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞—Ä–∏–∫–∏-–≥—Ä–∞–¥–∏–Ω—ã
#
# ptype —á–∞—Å—Ç–∏—Ü:
#   0 ‚Äî —Å–Ω–µ–∂–Ω—ã–π —Ö–ª–æ–ø–æ–∫ (—Ç–æ—á–∫–∞)
#   1 ‚Äî 6-–ª—É—á–µ–≤–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞
#   2 ‚Äî –¥–æ–∂–¥–µ–≤–∞—è –∫–∞–ø–ª—è (–ª–∏–Ω–∏—è)
#   3 ‚Äî —Ç—É–º–∞–Ω–Ω–æ–µ –ø—è—Ç–Ω–æ (–±–æ–ª—å—à–∞—è —Ç–æ—á–∫–∞)
#   4 ‚Äî –æ–±–ª–∞–∫–æ (5 –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è –∫—Ä—É–≥–æ–≤)
#   6 ‚Äî —Å–æ–ª–Ω–µ—á–Ω–∞—è –∏—Å–∫—Ä–∞ (–º–µ—Ä—Ü–∞—é—â–∏–π –∫—Ä—É–∂–æ–∫)
#   7 ‚Äî –≥—Ä–∞–¥–∏–Ω–∞ (–±–µ–ª—ã–π —à–∞—Ä–∏–∫ —Å –æ–±–≤–æ–¥–∫–æ–π)

import threading
import math
import random
import time

import requests
from android_utils import log, run_on_ui_thread
from base_plugin import BasePlugin, MethodHook, HookResult, HookStrategy
from client_utils import run_on_queue, get_last_fragment
from hook_utils import find_class
from ui.bulletin import BulletinHelper
from ui.settings import Header, Switch, Text, Divider, Input
from typing import List, Any, Optional

from android.graphics import Paint
from android.content import Intent
from android.net import Uri
from android.view import Gravity as _G
from android.widget import FrameLayout as _FL, LinearLayout as _LL, TextView as _TV
from android.util import TypedValue as _TypedValue
from org.telegram.messenger import AndroidUtilities as _AU
from org.telegram.ui.ActionBar import Theme as _Theme
from org.telegram.ui.Components import LayoutHelper as _LH
from android_utils import OnClickListener
from hook_utils import get_private_field

# ‚îÄ‚îÄ‚îÄ WMO weather codes ‚Üí —Ç–∏–ø —ç—Ñ—Ñ–µ–∫—Ç–∞ (Open-Meteo) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# https://open-meteo.com/en/docs#weathervariables (weathercode / weather_code)
WMO = {
    0:  "clear",        # –Ø—Å–Ω–æ
    1:  "clear",        # –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–µ–Ω–Ω–æ —è—Å–Ω–æ
    2:  "partly_cloudy",# –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å
    3:  "cloudy",       # –ü–∞—Å–º—É—Ä–Ω–æ
    45: "fog",          # –¢—É–º–∞–Ω
    48: "fog",          # –û—Å–µ–¥–∞—é—â–∏–π —Ç—É–º–∞–Ω (–∏–∑–º–æ—Ä–æ–∑—å)
    51: "light_rain",   # –ú–æ—Ä–æ—Å—å —Å–ª–∞–±–∞—è
    53: "light_rain",   # –ú–æ—Ä–æ—Å—å —É–º–µ—Ä–µ–Ω–Ω–∞—è
    55: "rain",         # –ú–æ—Ä–æ—Å—å —Å–∏–ª—å–Ω–∞—è
    56: "light_rain",   # –õ–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å —Å–ª–∞–±–∞—è
    57: "rain",         # –õ–µ–¥—è–Ω–∞—è –º–æ—Ä–æ—Å—å —Å–∏–ª—å–Ω–∞—è
    61: "light_rain",   # –î–æ–∂–¥—å —Å–ª–∞–±—ã–π
    63: "rain",         # –î–æ–∂–¥—å —É–º–µ—Ä–µ–Ω–Ω—ã–π
    65: "rain",         # –î–æ–∂–¥—å —Å–∏–ª—å–Ω—ã–π
    66: "sleet",        # –õ–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å —Å–ª–∞–±—ã–π
    67: "sleet",        # –õ–µ–¥—è–Ω–æ–π –¥–æ–∂–¥—å —Å–∏–ª—å–Ω—ã–π
    71: "light_snow",   # –°–Ω–µ–≥ —Å–ª–∞–±—ã–π
    73: "snow",         # –°–Ω–µ–≥ —É–º–µ—Ä–µ–Ω–Ω—ã–π
    75: "snow",         # –°–Ω–µ–≥ —Å–∏–ª—å–Ω—ã–π
    77: "hail",         # –°–Ω–µ–∂–Ω–∞—è –∫—Ä—É–ø–∞
    80: "light_rain",   # –õ–∏–≤–µ–Ω—å —Å–ª–∞–±—ã–π
    81: "rain",         # –õ–∏–≤–µ–Ω—å —É–º–µ—Ä–µ–Ω–Ω—ã–π
    82: "rain",         # –õ–∏–≤–µ–Ω—å —Å–∏–ª—å–Ω—ã–π
    85: "light_snow",   # –°–Ω–µ–∂–Ω—ã–π –ª–∏–≤–µ–Ω—å —Å–ª–∞–±—ã–π
    86: "snow",         # –°–Ω–µ–∂–Ω—ã–π –ª–∏–≤–µ–Ω—å —Å–∏–ª—å–Ω—ã–π
    95: "thunder",      # –ì—Ä–æ–∑–∞
    96: "thunder",      # –ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º —Å–ª–∞–±—ã–º
    99: "thunder",      # –ì—Ä–æ–∑–∞ —Å –≥—Ä–∞–¥–æ–º —Å–∏–ª—å–Ω—ã–º
}

DP          = 3.0
ANGLE_DIFF  = math.pi / 3.0
UPDATE_SEC  = 30 * 60
CACHE_SEC   = 10 * 60

def _tc(key, fallback=0):
    try:    return _Theme.getColor(key)
    except: return fallback


# ‚îÄ‚îÄ‚îÄ Particle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class Particle:
    __slots__ = ("x","y","vx","vy","velocity","alpha","life_time",
                 "current_time","scale","ptype","angle","spin")

    def __init__(self):
        self.x = self.y = self.vx = self.vy = 0.0
        self.velocity = self.alpha = self.life_time = self.current_time = 0.0
        self.scale = 1.0
        self.ptype = 0
        self.angle = 0.0
        self.spin  = 0.0

    def reset(self):
        self.alpha = 0.0
        self.current_time = 0.0
        self.angle = 0.0
        self.spin  = 0.0


# ‚îÄ‚îÄ‚îÄ WeatherEffect ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class WeatherEffect:

    FREE_POOL = 100

    def __init__(self):
        self.weather_type = "clear"
        self.running      = False
        self.last_view    = None

        self.particles: List[Particle] = []
        self._free: List[Particle]     = [Particle() for _ in range(50)]

        self._last_mono: float = 0.0
        self._lightning_alpha: int = 0
        self._lightning_timer: int = 0
        self._lightning_next:  int = random.randint(80, 240)
        self._lightning_spots: list = []
        self._sun_angle: float = 0.0
        # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç–∏ –º–æ–ª–Ω–∏–∏
        self.cfg_lightning_intensity = 210  # –º–∞–∫—Å. —è—Ä–∫–æ—Å—Ç—å –≤—Å–ø—ã—à–∫–∏ (0‚Äì255)
        self.cfg_lightning_speed     = 18   # —Å–∫–æ—Ä–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è (1‚Äì40)

        # ‚îÄ‚îÄ cfg: —è—Å–Ω–æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_spark_spawn   = 0.85
        self.cfg_spark_count   = 20
        self.cfg_sun_pos_x     = 0.82   # –¥–æ–ª—è —à–∏—Ä–∏–Ω—ã
        self.cfg_sun_pos_y     = 0.12   # –¥–æ–ª—è –≤—ã—Å–æ—Ç—ã
        self.cfg_sun_ray_speed = 0.0003
        # ‚îÄ‚îÄ cfg: –æ–±–ª–∞—á–Ω–æ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_cloud_speed   = 11.0
        self.cfg_cloud_spawn   = 0.97
        self.cfg_cloud_count   = 12
        # ‚îÄ‚îÄ cfg: —Ç—É–º–∞–Ω ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_fog_speed     = 6.0
        self.cfg_fog_spawn     = 0.88
        self.cfg_fog_count     = 12
        # ‚îÄ‚îÄ cfg: –ª—ë–≥–∫–∏–π –¥–æ–∂–¥—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_lrain_speed   = 35.0
        self.cfg_lrain_spawn   = 0.80
        self.cfg_lrain_count   = 50
        # ‚îÄ‚îÄ cfg: –¥–æ–∂–¥—å ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_rain_speed    = 55.0
        self.cfg_rain_spawn    = 0.55
        self.cfg_rain_count    = 150
        # ‚îÄ‚îÄ cfg: –≥—Ä–æ–∑–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_thunder_speed = 75.0
        self.cfg_thunder_spawn = 0.45
        # ‚îÄ‚îÄ cfg: –ª—ë–≥–∫–∏–π —Å–Ω–µ–≥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_lsnow_speed   = 18.0
        self.cfg_lsnow_spawn   = 0.82
        self.cfg_lsnow_count   = 40
        # ‚îÄ‚îÄ cfg: —Å–Ω–µ–≥ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_snow_speed    = 22.0
        self.cfg_snow_spawn    = 0.70
        self.cfg_snow_count    = 100
        # ‚îÄ‚îÄ cfg: grad ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        self.cfg_hail_speed    = 90.0
        self.cfg_hail_spawn    = 0.50
        self.cfg_hail_count    = 120

        # Paint –æ–±—ä–µ–∫—Ç—ã ‚Äî –æ–¥–∏–Ω —Ä–∞–∑
        self._thick = Paint(Paint.ANTI_ALIAS_FLAG)
        self._thick.setStrokeCap(Paint.Cap.ROUND)
        self._thick.setStyle(Paint.Style.STROKE)

        self._thin = Paint(Paint.ANTI_ALIAS_FLAG)
        self._thin.setStrokeCap(Paint.Cap.ROUND)
        self._thin.setStyle(Paint.Style.STROKE)

        self._fill = Paint(Paint.ANTI_ALIAS_FLAG)
        self._fill.setStyle(Paint.Style.FILL)

        self._bg = Paint()
        self._bg.setStyle(Paint.Style.FILL)

        self._refresh_paint()

    # ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    @staticmethod
    def _argb(paint, c: int):
        paint.setARGB((c>>24)&0xFF, (c>>16)&0xFF, (c>>8)&0xFF, c&0xFF)

    def _refresh_paint(self):
        wt = self.weather_type
        if wt in ("rain","thunder","sleet","light_rain"):
            col = 0xFF99BBDD
        elif wt == "fog":
            col = 0xFFCCCCCC
        elif wt == "clear":
            col = 0xFFFFDD88
        elif wt in ("cloudy","partly_cloudy"):
            col = 0xFFDDDDEE
        elif wt == "hail":
            col = 0xFFBBCCDD
        else:
            col = 0xFFDDEEFF
        self._argb(self._thick, col)
        self._argb(self._thin,  col)
        self._argb(self._fill,  col)
        self._thick.setStrokeWidth(DP * 1.5)
        self._thin.setStrokeWidth(DP * 0.5)

    def _alloc(self) -> Particle:
        p = self._free.pop() if self._free else Particle()
        p.reset()
        return p

    def _recycle(self, p: Particle):
        if len(self._free) < self.FREE_POOL:
            self._free.append(p)

    # ‚îÄ‚îÄ Public API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def set_weather(self, wt: str):
        if self.weather_type == wt:
            return
        self.weather_type = wt
        self._lightning_alpha = 0
        self._lightning_timer = 0
        self._lightning_next  = random.randint(80, 240)
        self._last_mono       = 0.0
        for p in self.particles:
            self._recycle(p)
        self.particles.clear()
        self._refresh_paint()
        if self.last_view is not None:
            try:    self.last_view.invalidate()
            except: self.last_view = None

    def apply_cfg(self,
                  spark_spawn, spark_count, sun_pos_x, sun_pos_y, sun_ray_speed,
                  cloud_speed, cloud_spawn, cloud_count,
                  fog_speed, fog_spawn, fog_count,
                  lrain_speed, lrain_spawn, lrain_count,
                  rain_speed, rain_spawn, rain_count,
                  thunder_speed, thunder_spawn,
                  lsnow_speed, lsnow_spawn, lsnow_count,
                  snow_speed, snow_spawn, snow_count,
                  hail_speed, hail_spawn, hail_count,
                  lightning_intensity, lightning_speed):
        def f(v): return max(1.0, float(v))
        def s(v): return max(0.01, min(0.99, float(v)/100.0))
        def i(v): return max(1, int(v))
        self.cfg_spark_spawn   = s(spark_spawn)
        self.cfg_spark_count   = i(spark_count)
        self.cfg_sun_pos_x     = max(0.1, min(0.95, float(sun_pos_x)/100.0))
        self.cfg_sun_pos_y     = max(0.01, min(0.5,  float(sun_pos_y)/100.0))
        self.cfg_sun_ray_speed = max(0.0, float(sun_ray_speed)/10000.0)
        self.cfg_cloud_speed   = f(cloud_speed)
        self.cfg_cloud_spawn   = s(cloud_spawn)
        self.cfg_cloud_count   = i(cloud_count)
        self.cfg_fog_speed     = f(fog_speed)
        self.cfg_fog_spawn     = s(fog_spawn)
        self.cfg_fog_count     = i(fog_count)
        self.cfg_lrain_speed   = f(lrain_speed)
        self.cfg_lrain_spawn   = s(lrain_spawn)
        self.cfg_lrain_count   = i(lrain_count)
        self.cfg_rain_speed    = f(rain_speed)
        self.cfg_rain_spawn    = s(rain_spawn)
        self.cfg_rain_count    = i(rain_count)
        self.cfg_thunder_speed = f(thunder_speed)
        self.cfg_thunder_spawn = s(thunder_spawn)
        self.cfg_lsnow_speed   = f(lsnow_speed)
        self.cfg_lsnow_spawn   = s(lsnow_spawn)
        self.cfg_lsnow_count   = i(lsnow_count)
        self.cfg_snow_speed    = f(snow_speed)
        self.cfg_snow_spawn    = s(snow_spawn)
        self.cfg_snow_count    = i(snow_count)
        self.cfg_hail_speed    = f(hail_speed)
        self.cfg_hail_spawn    = s(hail_spawn)
        self.cfg_hail_count          = i(hail_count)
        self.cfg_lightning_intensity  = max(0, min(255, int(lightning_intensity)))
        self.cfg_lightning_speed      = max(1, int(lightning_speed))
        for p in self.particles:
            self._recycle(p)
        self.particles.clear()

    # ‚îÄ‚îÄ Spawn ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _spawn(self, w: int, h: int):
        wt = self.weather_type
        # –í—ã–±–∏—Ä–∞–µ–º –ø–æ—Ä–æ–≥ –∏ –ª–∏–º–∏—Ç –ø–æ —Ç–∏–ø—É
        if   wt == "clear":         thresh, limit = self.cfg_spark_spawn,   self.cfg_spark_count
        elif wt == "partly_cloudy": thresh, limit = self.cfg_cloud_spawn,   self.cfg_cloud_count
        elif wt == "cloudy":        thresh, limit = self.cfg_cloud_spawn,   self.cfg_cloud_count
        elif wt == "fog":           thresh, limit = self.cfg_fog_spawn,     self.cfg_fog_count
        elif wt == "light_rain":    thresh, limit = self.cfg_lrain_spawn,   self.cfg_lrain_count
        elif wt == "rain":          thresh, limit = self.cfg_rain_spawn,    self.cfg_rain_count
        elif wt == "thunder":       thresh, limit = self.cfg_thunder_spawn, self.cfg_rain_count
        elif wt == "light_snow":    thresh, limit = self.cfg_lsnow_spawn,   self.cfg_lsnow_count
        elif wt == "snow":          thresh, limit = self.cfg_snow_spawn,    self.cfg_snow_count
        elif wt == "sleet":         thresh, limit = self.cfg_snow_spawn,    self.cfg_snow_count
        elif wt == "hail":          thresh, limit = self.cfg_hail_spawn,    self.cfg_hail_count
        else:                       return

        if random.random() > thresh or len(self.particles) >= limit:
            return

        p = self._alloc()
        p.x = random.random() * w
        p.y = random.random() * h

        if wt == "clear":
            # –ò—Å–∫—Ä—ã ‚Äî —Å—Ç–∞—Ç–∏—á–Ω—ã–µ –º–µ—Ä—Ü–∞—é—â–∏–µ —Ç–æ—á–∫–∏
            p.vx = p.vy = p.velocity = 0.0
            p.life_time = 800.0 + random.randint(0, 600)
            p.scale     = random.random() * 0.8 + 0.3
            p.ptype     = 6

        elif wt in ("partly_cloudy", "cloudy"):
            # –û–±–ª–∞–∫–∞ –ø–ª—ã–≤—É—Ç –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ, –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–±–æ–∫—É
            d = 1 if random.random() > 0.5 else -1
            p.x = -120.0 if d > 0 else w + 120.0
            p.y = random.random() * h * 0.65
            p.vx = float(d); p.vy = 0.0
            p.velocity  = self.cfg_cloud_speed + random.random() * 6.0
            p.life_time = 12000.0 + random.randint(0, 5000)
            p.scale     = random.random() * 1.5 + 1.0
            p.ptype     = 4

        elif wt == "fog":
            # –ö–ª—É–± —Ç—É–º–∞–Ω–∞ ‚Äî –±–æ–ª—å—à–æ–µ –º—è–≥–∫–æ–µ –ø—è—Ç–Ω–æ, –º–µ–¥–ª–µ–Ω–Ω–æ –¥—Ä–µ–π—Ñ—É–µ—Ç
            angle = random.uniform(0, math.pi * 2)  # –ª—é–±–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
            p.vx  = math.cos(angle)
            p.vy  = math.sin(angle) * 0.3   # –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –¥—Ä–µ–π—Ñ —Å–∏–ª—å–Ω–µ–µ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–≥–æ
            p.x   = random.random() * w
            p.y   = random.random() * h
            p.velocity  = self.cfg_fog_speed * 0.25 + random.random() * 0.8
            p.life_time = 12000.0 + random.randint(0, 8000)
            p.scale     = random.random() * 1.8 + 1.2   # —Ä–∞–¥–∏—É—Å-–º–Ω–æ–∂–∏—Ç–µ–ª—å
            p.ptype     = 3

        elif wt == "light_rain":
            # –†–µ–¥–∫–∏–µ —Ç–æ–Ω–∫–∏–µ –∫–∞–ø–ª–∏, –º–µ–¥–ª–µ–Ω–Ω–µ–µ –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ
            rad = math.radians(random.randint(-15, 15) + 90)
            p.vx = math.cos(rad); p.vy = math.sin(rad)
            spd = self.cfg_lrain_speed + random.random() * 10.0
            p.velocity  = spd
            p.life_time = max(400.0, ((h-p.y)+80.0) / (spd*16.0/500.0) * 16.0)
            p.scale     = random.random() * 0.4 + 0.2
            p.ptype     = 2

        elif wt in ("rain", "thunder"):
            # –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π –¥–æ–∂–¥—å
            rad = math.radians(random.randint(-20, 20) + 90)
            p.vx = math.cos(rad); p.vy = math.sin(rad)
            spd = (self.cfg_thunder_speed if wt == "thunder"
                   else self.cfg_rain_speed) + random.random() * 20.0
            p.velocity  = spd
            p.life_time = max(300.0, ((h-p.y)+80.0) / (spd*16.0/500.0) * 16.0)
            p.scale     = random.random() * 0.7 + 0.4
            p.ptype     = 2

        elif wt == "light_snow":
            # –†–µ–¥–∫–∏–µ –ª—ë–≥–∫–∏–µ —Å–Ω–µ–∂–∏–Ω–∫–∏, —á—É—Ç—å –∫—Ä—É—Ç–∏—Ç –≤–µ—Ç—Ä–æ–º
            rad = math.radians(random.randint(-25, 25) + 90)
            p.vx = math.cos(rad); p.vy = math.sin(rad)
            p.velocity  = self.cfg_lsnow_speed + random.random() * 3.0
            p.life_time = 3000.0 + random.randint(0, 500)
            p.scale     = random.random() * 0.7 + 0.15
            p.ptype     = random.randint(0, 1)

        elif wt == "snow":
            # –ì—É—Å—Ç–æ–π —Å–Ω–µ–≥ ‚Äî –∫—Ä—É–ø–Ω—ã–µ —Ö–ª–æ–ø—å—è –∏ —à–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫–∏
            rad = math.radians(random.randint(-20, 20) + 90)
            p.vx = math.cos(rad); p.vy = math.sin(rad)
            p.velocity  = self.cfg_snow_speed + random.random() * 4.0
            p.life_time = 2000.0 + random.randint(0, 100)
            p.scale     = random.random() * 1.2 + 0.2
            p.ptype     = random.randint(0, 1)

        elif wt == "sleet":
            # –°–ª—è–∫–æ—Ç—å = ~55% —Å–Ω–µ–∂–∏–Ω–∫–∏ + ~45% –¥–æ–∂–¥—å
            rad = math.radians(random.randint(-20, 20) + 90)
            p.vx = math.cos(rad); p.vy = math.sin(rad)
            if random.random() > 0.45:
                spd = self.cfg_snow_speed + random.random() * 4.0
                p.velocity  = spd
                p.life_time = 2000.0 + random.randint(0, 100)
                p.scale     = random.random() * 0.9 + 0.2
                p.ptype     = random.randint(0, 1)
            else:
                spd = self.cfg_rain_speed * 0.7 + random.random() * 10.0
                p.velocity  = spd
                p.life_time = max(300.0, ((h-p.y)+80.0) / (spd*16.0/500.0) * 16.0)
                p.scale     = random.random() * 0.5 + 0.3
                p.ptype     = 2

        elif wt == "hail":
            # Grad ‚Äî –ø–æ—á—Ç–∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ, –±—ã—Å—Ç—Ä–æ, –º–∞–ª–µ–Ω—å–∫–∏–µ —à–∞—Ä–∏–∫–∏
            rad = math.radians(random.randint(-8, 8) + 90)
            p.vx = math.cos(rad); p.vy = math.sin(rad)
            spd = self.cfg_hail_speed + random.random() * 30.0
            p.velocity  = spd
            p.life_time = max(200.0, ((h-p.y)+80.0) / (spd*16.0/500.0) * 16.0)
            p.scale     = random.random() * 0.6 + 0.35
            p.spin      = float(random.randint(0, 2))   # —Ñ–æ—Ä–º–∞: 0=–≥–µ–∫—Å, 1=—Ä–æ–º–±, 2=–æ—Å–∫–æ–ª–æ–∫
            p.angle     = random.uniform(0, math.pi)    # —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç
            p.ptype     = 7

        self.particles.append(p)

    # ‚îÄ‚îÄ Update ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _update(self, dt: float):
        k     = dt / 500.0
        alive = []
        for p in self.particles:
            p.current_time += dt
            ct = p.current_time
            lt = p.life_time
            if ct >= lt:
                self._recycle(p)
                continue
            if ct < 200.0:
                t = ct / 200.0
                p.alpha = t * t
            else:
                t = (ct - 200.0) / (lt - 200.0)
                p.alpha = 1.0 - t * t
            vk = p.velocity * k
            p.x += p.vx * vk
            p.y += p.vy * vk
            alive.append(p)
        self.particles = alive

    # ‚îÄ‚îÄ Draw particle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _draw_particle(self, canvas, p: Particle):
        a = int(255.0 * p.alpha)
        if a <= 0:
            return
        t = p.ptype

        if t == 0:
            # –°–Ω–µ–∂–Ω—ã–π —Ö–ª–æ–ø–æ–∫
            self._thick.setAlpha(a)
            self._thick.setStrokeWidth(DP * 1.5 * p.scale)
            canvas.drawPoint(p.x, p.y, self._thick)

        elif t == 1:
            # 6-–ª—É—á–µ–≤–∞—è —Å–Ω–µ–∂–∏–Ω–∫–∞ (SnowflakesEffect.java)
            self._thin.setAlpha(a)
            angle = -math.pi / 2.0
            sc = p.scale
            px  =  DP * 4.0  * sc
            px1 = -DP * 1.14 * sc
            py1 =  DP * 3.10 * sc
            x, y = p.x, p.y
            for _ in range(6):
                ca, sa = math.cos(angle), math.sin(angle)
                x1 = ca * px;  y1 = sa * px
                cx = x1 * 0.66; cy = y1 * 0.66
                canvas.drawLine(x, y, x+x1, y+y1, self._thin)
                a2 = angle - math.pi / 2.0
                c2, s2 = math.cos(a2), math.sin(a2)
                bx  =  c2*px1 - s2*py1;  by  = s2*px1 + c2*py1
                bx2 = -c2*px1 - s2*py1;  by2 = -s2*px1 + c2*py1
                canvas.drawLine(x+cx, y+cy, x+bx,  y+by,  self._thin)
                canvas.drawLine(x+cx, y+cy, x+bx2, y+by2, self._thin)
                angle += ANGLE_DIFF

        elif t == 2:
            # –î–æ–∂–¥–µ–≤–∞—è –∫–∞–ø–ª—è ‚Äî –ª–∏–Ω–∏—è –ø–æ –≤–µ–∫—Ç–æ—Ä—É –ø–∞–¥–µ–Ω–∏—è
            fast = p.velocity > 60
            self._thick.setAlpha(a)
            self._thick.setStrokeWidth(DP * (1.1 if fast else 0.8) * p.scale)
            ln = DP * (13.0 if fast else 8.0) * p.scale
            canvas.drawLine(p.x, p.y, p.x + p.vx*ln, p.y + p.vy*ln, self._thick)

        elif t == 3:
            # –¢—É–º–∞–Ω ‚Äî –º—è–≥–∫–æ–µ –ø—è—Ç–Ω–æ –∏–∑ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –∫—Ä—É–≥–æ–≤ (—Ä–∞–¥–∏–∞–ª—å–Ω—ã–π fade)
            # –í–Ω—É—Ç—Ä–∏ —è—Ä—á–µ, —Å–Ω–∞—Ä—É–∂–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω–µ–µ ‚Äî –∏–º–∏—Ç–∞—Ü–∏—è –æ–±—ä—ë–º–Ω–æ–≥–æ –∫–ª—É–±–∞ —Ç—É–º–∞–Ω–∞
            base_r = DP * 60.0 * p.scale
            self._argb(self._fill, 0xFFE8E8E8)
            # 6 –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –∫—Ä—É–≥–æ–≤: –æ—Ç —Ü–µ–Ω—Ç—Ä–∞ –∫ –∫—Ä–∞—é –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å –ø–∞–¥–∞–µ—Ç
            rings = (
                (0.15, 0.10),   # —è–¥—Ä–æ
                (0.30, 0.08),
                (0.50, 0.06),
                (0.68, 0.04),
                (0.84, 0.02),
                (1.00, 0.01),   # –≤–Ω–µ—à–Ω–∏–π –∫—Ä–∞–π ‚Äî –ø–æ—á—Ç–∏ –Ω–µ–≤–∏–¥–∏–º
            )
            for r_frac, opacity in rings:
                ring_a = int(a * opacity)
                if ring_a <= 0: continue
                self._fill.setAlpha(ring_a)
                canvas.drawCircle(p.x, p.y, base_r * r_frac, self._fill)

        elif t == 4:
            # –û–±–ª–∞–∫–æ ‚Äî 5 –ø–µ—Ä–µ–∫—Ä—ã–≤–∞—é—â–∏—Ö—Å—è –∫—Ä—É–≥–æ–≤
            self._argb(self._fill, 0xFFEEEEFF)
            self._fill.setAlpha(min(a, 160))
            sc = p.scale * DP * 10.0
            for ox, oy, os in ((-2.0, 0.0, 0.8), (-0.8, -0.6, 1.0),
                                (0.6, -0.8, 1.2), (2.0, -0.4, 0.9), (1.2, 0.2, 0.7)):
                canvas.drawCircle(p.x + ox*sc, p.y + oy*sc, sc*os, self._fill)

        elif t == 6:
            # –°–æ–ª–Ω–µ—á–Ω–∞—è –∏—Å–∫—Ä–∞ ‚Äî –º–µ—Ä—Ü–∞–µ—Ç —Å–∏–Ω—É—Å–æ–∏–¥–∞–ª—å–Ω–æ
            flicker = 0.5 + 0.5 * math.sin(p.current_time * 0.015)
            self._argb(self._fill, 0xFFFFEE88)
            self._fill.setAlpha(int(a * flicker))
            canvas.drawCircle(p.x, p.y, DP * 1.5 * p.scale, self._fill)

        elif t == 7:
            # –ö—É–±–∏–∫ –ª—å–¥–∞ ‚Äî –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –º–Ω–æ–≥–æ—É–≥–æ–ª—å–Ω–∏–∫, —Ñ–æ—Ä–º–∞ –∑–∞–¥–∞—ë—Ç—Å—è —á–µ—Ä–µ–∑ spin (seed)
            # spin —Ö—Ä–∞–Ω–∏—Ç —Å–ª—É—á–∞–π–Ω—ã–π seed —Ñ–æ—Ä–º—ã (0,1,2), angle ‚Äî –Ω–∞—á–∞–ª—å–Ω—ã–π –ø–æ–≤–æ—Ä–æ—Ç
            seed = int(p.spin) % 3
            base = DP * 4.0 * p.scale
            rot  = p.angle   # —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–≥–æ–ª –ø–æ–≤–æ—Ä–æ—Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –ª—å–¥–∏–Ω–∫–∏
            cx, cy = p.x, p.y

            # –ó–∞–ª–∏–≤–∫–∞ ‚Äî –æ—á–µ–Ω—å –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≥–æ–ª—É–±–æ–π
            self._argb(self._fill, 0x99CCEEFF)
            self._fill.setAlpha(int(a * 0.45))

            # –ö–æ–Ω—Ç—É—Ä ‚Äî —á—É—Ç—å —è—Ä—á–µ
            self._argb(self._thick, 0xCCAADDFF)
            self._thick.setAlpha(int(a * 0.75))
            self._thick.setStrokeWidth(DP * 0.7)

            if seed == 0:
                # –®–µ—Å—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫ (–≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª)
                pts = []
                for k in range(6):
                    ang = rot + k * math.pi / 3.0
                    pts.append((cx + math.cos(ang)*base, cy + math.sin(ang)*base))
                for k in range(6):
                    x1,y1 = pts[k]; x2,y2 = pts[(k+1)%6]
                    canvas.drawLine(x1,y1, x2,y2, self._thick)
                # –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ª–∏–Ω–∏–∏ ‚Äî –∑–≤–µ–∑–¥–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–∞
                self._thick.setAlpha(int(a * 0.3))
                for k in range(6):
                    x1,y1 = pts[k]
                    canvas.drawLine(cx,cy, x1,y1, self._thick)

            elif seed == 1:
                # –†–æ–º–± (—É–ø–ª–æ—â—ë–Ω–Ω—ã–π –∫—Ä–∏—Å—Ç–∞–ª–ª)
                w2 = base * 0.65
                h2 = base * 1.2
                cos_r = math.cos(rot); sin_r = math.sin(rot)
                verts = [
                    ( w2*cos_r - 0   *sin_r,  w2*sin_r + 0   *cos_r),
                    ( 0  *cos_r - h2 *sin_r,  0  *sin_r + h2 *cos_r),
                    (-w2*cos_r - 0   *sin_r, -w2*sin_r + 0   *cos_r),
                    ( 0  *cos_r + h2 *sin_r,  0  *sin_r - h2 *cos_r),
                ]
                self._thick.setAlpha(int(a * 0.75))
                for k in range(4):
                    x1,y1 = verts[k]; x2,y2 = verts[(k+1)%4]
                    canvas.drawLine(cx+x1,cy+y1, cx+x2,cy+y2, self._thick)
                # –î–∏–∞–≥–æ–Ω–∞–ª–∏
                self._thick.setAlpha(int(a * 0.3))
                canvas.drawLine(cx+verts[0][0],cy+verts[0][1], cx+verts[2][0],cy+verts[2][1], self._thick)
                canvas.drawLine(cx+verts[1][0],cy+verts[1][1], cx+verts[3][0],cy+verts[3][1], self._thick)

            else:
                # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—è—Ç–∏—É–≥–æ–ª—å–Ω–∏–∫ (–æ—Å–∫–æ–ª–æ–∫ –ª—å–¥–∞)
                offsets = [
                    (1.0, 0.0), (0.3, -1.1), (-0.9, -0.8),
                    (-1.0, 0.4), (0.1, 1.0),
                ]
                cos_r = math.cos(rot); sin_r = math.sin(rot)
                pts = []
                for ox, oy in offsets:
                    rx = ox*cos_r - oy*sin_r
                    ry = ox*sin_r + oy*cos_r
                    pts.append((cx + rx*base, cy + ry*base))
                self._thick.setAlpha(int(a * 0.75))
                for k in range(5):
                    x1,y1 = pts[k]; x2,y2 = pts[(k+1)%5]
                    canvas.drawLine(x1,y1, x2,y2, self._thick)
                # –¢—Ä–µ—â–∏–Ω–∞
                self._thick.setAlpha(int(a * 0.25))
                canvas.drawLine(cx,cy, pts[2][0],pts[2][1], self._thick)

    # ‚îÄ‚îÄ –°–æ–ª–Ω—Ü–µ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _draw_sun(self, canvas, w: int, h: int, dt: float, alpha: float = 1.0):
        """–†–∏—Å—É–µ—Ç —Å–æ–ª–Ω—Ü–µ. alpha=1.0 ‚Äî —è—Å–Ω–æ, 0.5 ‚Äî –∑–∞ –æ–±–ª–∞–∫–∞–º–∏ (partly_cloudy)."""
        self._sun_angle += dt * self.cfg_sun_ray_speed
        cx = w * self.cfg_sun_pos_x
        cy = h * self.cfg_sun_pos_y

        # –Ø–¥—Ä–æ
        self._argb(self._fill, 0xFFFFCC44)
        self._fill.setAlpha(int(220 * alpha))
        canvas.drawCircle(cx, cy, DP * 14.0, self._fill)

        # –ú—è–≥–∫–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
        self._argb(self._fill, 0x55FFD966)
        self._fill.setAlpha(int(60 * alpha))
        canvas.drawCircle(cx, cy, DP * 22.0, self._fill)

        # 8 –≤—Ä–∞—â–∞—é—â–∏—Ö—Å—è –ª—É—á–µ–π
        self._argb(self._thick, 0xFFFFCC44)
        self._thick.setStrokeWidth(DP * 2.5)
        for i in range(8):
            angle = self._sun_angle + i * math.pi / 4.0
            inner = DP * 18.0
            outer = DP * (28.0 + 4.0 * math.sin(self._sun_angle * 3 + i))
            self._thick.setAlpha(int(180 * alpha))
            canvas.drawLine(
                cx + math.cos(angle)*inner, cy + math.sin(angle)*inner,
                cx + math.cos(angle)*outer, cy + math.sin(angle)*outer,
                self._thick,
            )

    def _draw_cloud_bg(self, canvas, w: int, h: int):
        """–°—Ç–∞—Ç–∏—á–Ω–æ–µ —Ñ–æ–Ω–æ–≤–æ–µ –æ–±–ª–∞–∫–æ –≤–≤–µ—Ä—Ö—É –¥–ª—è cloudy/partly_cloudy."""
        self._argb(self._fill, 0xFFEEEEFF)
        self._fill.setAlpha(30)
        sc = DP * 18.0
        for ox, oy, os in ((-3,0,1.0),(-1,-1,1.3),(1,-1.2,1.5),(3,-0.5,1.1),(2,0.3,0.8)):
            canvas.drawCircle(w*0.5+ox*sc, h*0.1+oy*sc, sc*os, self._fill)

    # ‚îÄ‚îÄ on_draw ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def on_draw(self, view, canvas):
        if not self.running:
            return
        wt = self.weather_type
        try:
            w = view.getWidth()
            h = view.getHeight()
            if w <= 0 or h <= 0:
                return

            now = time.monotonic()
            dt  = min(32.0, (now - self._last_mono)*1000.0) if self._last_mono > 0 else 16.0
            self._last_mono = now

            needs_invalidate = False

            if wt == "clear":
                self._draw_sun(canvas, w, h, dt, alpha=1.0)
                for p in self.particles: self._draw_particle(canvas, p)
                self._spawn(w, h)
                self._update(dt)
                needs_invalidate = True   # —Å–æ–ª–Ω—Ü–µ –≤—Å–µ–≥–¥–∞ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–æ

            elif wt == "partly_cloudy":
                self._draw_sun(canvas, w, h, dt, alpha=0.5)
                self._draw_cloud_bg(canvas, w, h)
                for p in self.particles: self._draw_particle(canvas, p)
                self._spawn(w, h)
                self._update(dt)
                needs_invalidate = True

            elif wt == "cloudy":
                self._draw_cloud_bg(canvas, w, h)
                for p in self.particles: self._draw_particle(canvas, p)
                self._spawn(w, h)
                self._update(dt)
                needs_invalidate = bool(self.particles)

            elif wt in ("fog","light_rain","rain","thunder",
                        "light_snow","snow","sleet","hail"):
                if wt == "thunder":
                    self._lightning_timer += 1
                    if self._lightning_timer >= self._lightning_next:
                        self._lightning_alpha = self.cfg_lightning_intensity
                        self._lightning_timer = 0
                        self._lightning_next  = random.randint(80, 240)
                        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 2-4 —Å–ª—É—á–∞–π–Ω—ã—Ö –ø—è—Ç–Ω–∞ –≤—Å–ø—ã—à–∫–∏
                        self._lightning_spots = [
                            (random.random() * w, random.random() * h,
                             DP * (random.random() * 80 + 60))   # x, y, radius
                            for _ in range(random.randint(2, 4))
                        ]
                    elif self._lightning_alpha > 0:
                        self._lightning_alpha = max(0, self._lightning_alpha - self.cfg_lightning_speed)
                    if self._lightning_alpha > 0 and self._lightning_spots:
                        self._argb(self._fill, 0xFFFFFFEE)
                        for sx, sy, sr in self._lightning_spots:
                            # –ö–∞–∂–¥–æ–µ –ø—è—Ç–Ω–æ ‚Äî 3 –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—á–µ—Å–∫–∏—Ö –∫—Ä—É–≥–∞ (—è—Ä–∫–∏–π —Ü–µ–Ω—Ç—Ä, fade –∫ –∫—Ä–∞—è–º)
                            self._fill.setAlpha(self._lightning_alpha)
                            canvas.drawCircle(sx, sy, sr * 0.35, self._fill)
                            self._fill.setAlpha(self._lightning_alpha * 2 // 5)
                            canvas.drawCircle(sx, sy, sr * 0.65, self._fill)
                            self._fill.setAlpha(self._lightning_alpha // 6)
                            canvas.drawCircle(sx, sy, sr, self._fill)

                for p in self.particles: self._draw_particle(canvas, p)
                self._spawn(w, h)
                self._update(dt)
                needs_invalidate = bool(self.particles) or self._lightning_alpha > 0

            if needs_invalidate:
                view.invalidate()

        except Exception as e:
            log(f"[DynBG] on_draw: {e}")



# ‚îÄ‚îÄ‚îÄ Settings header hook (–∫–∞–∫ –≤ morse_keyboard) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class _SettingsHeaderHook(MethodHook):
    def __init__(self, plugin):
        self._plugin = plugin

    def before_hooked_method(self, param): return

    def after_hooked_method(self, param):
        try:
            activity = param.thisObject
            items    = param.args[0]
            if not items or items.size() == 0: return
            plugin_obj = get_private_field(activity, "plugin")
            if not plugin_obj or str(plugin_obj.getId()) != __id__: return
            callback = get_private_field(activity, "createSubFragmentCallback")
            if callback is not None: return
            header = self._plugin._create_settings_header_view(activity.getContext())
            if not header: return
            from org.telegram.ui.Components import UItem
            try:
                from com.exteragram.messenger.plugins.models import HeaderSetting
                item = UItem.asCustom(header)
                item.settingItem = HeaderSetting(f"{__id__}_header")
            except Exception:
                item = UItem.asCustom(header)
            try: item.setTransparent(True)
            except Exception: pass
            items.add(0, item)
        except Exception: pass


_effect = WeatherEffect()


# ‚îÄ‚îÄ‚îÄ Hooks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class DrawHook(MethodHook):
    def after_hooked_method(self, param):
        try:
            view   = param.thisObject
            canvas = param.args[0]
            if canvas is not None:
                _effect.on_draw(view, canvas)
            _effect.last_view = view
        except Exception as e:
            log(f"[DynBG] DrawHook: {e}")


class ResumeHook(MethodHook):
    def __init__(self, plugin): self._p = plugin
    def after_hooked_method(self, param):
        try:    self._p._on_resumed()
        except Exception as e: log(f"[DynBG] ResumeHook: {e}")


class PauseHook(MethodHook):
    def before_hooked_method(self, param):
        _effect.running = False


# ‚îÄ‚îÄ‚îÄ Plugin ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

class DynamicBackgroundsPlugin(BasePlugin):

    TAG = "[DynBG]"

    _CMDS = {
        ".bg clear":         "clear",
        ".bg partly_cloudy": "partly_cloudy",
        ".bg cloudy":        "cloudy",
        ".bg fog":           "fog",
        ".bg light_rain":    "light_rain",
        ".bg rain":          "rain",
        ".bg thunder":       "thunder",
        ".bg light_snow":    "light_snow",
        ".bg snow":          "snow",
        ".bg sleet":         "sleet",
        ".bg hail":          "hail",
    }
    _LABELS = {
        "clear":         "‚òÄÔ∏è –Ø—Å–Ω–æ",
        "partly_cloudy": "‚õÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å",
        "cloudy":        "‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ",
        "fog":           "üå´ –¢—É–º–∞–Ω",
        "light_rain":    "üå¶ –õ—ë–≥–∫–∏–π –¥–æ–∂–¥—å",
        "rain":          "üåß –î–æ–∂–¥—å",
        "thunder":       "‚õà –ì—Ä–æ–∑–∞",
        "light_snow":    "üå® –õ—ë–≥–∫–∏–π —Å–Ω–µ–≥",
        "snow":          "‚ùÑÔ∏è –°–Ω–µ–≥",
        "sleet":         "üåß –°–ª—è–∫–æ—Ç—å",
        "hail":          "üå® –ì—Ä–∞–¥",
    }

    def __init__(self):
        super().__init__()
        self._weather_type  = "clear"
        self._last_update   = 0.0
        self._cache         = {}
        self._loop_running  = False
        self._fetch_lock    = threading.Lock()
        self._location_name = "‚Äî"

    # ‚îÄ‚îÄ Lifecycle ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def on_plugin_load(self):
        self.log(f"{self.TAG} v5.4 loading")
        self._setup_hooks()
        self._apply_cfg()
        self._start_weather_loop()
        self.add_on_send_message_hook()
        self._install_settings_header_hook()
        BulletinHelper.show_success("Dynamic Backgrounds üå¶")

    def _install_settings_header_hook(self):
        try:
            PSA = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
            if not PSA: return
            method = PSA.getClass().getDeclaredMethod(
                "fillItems",
                find_class("java.util.ArrayList"),
                find_class("org.telegram.ui.Components.UniversalAdapter"),
            )
            method.setAccessible(True)
            self.hook_method(method, _SettingsHeaderHook(self))
            self.log(f"{self.TAG} settings header hooked")
        except Exception as e:
            self.log(f"{self.TAG} header hook: {e}")

    def on_plugin_unload(self):
        self._loop_running = False
        _effect.running    = False

    # ‚îÄ‚îÄ Settings subpages ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _sub_clear(self) -> List[Any]:
        return [
            Header(text="‚òÄÔ∏è –Ø—Å–Ω–æ ‚Äî –°–æ–ª–Ω—Ü–µ"),
            Input(key="sun_pos_x",     text="–ü–æ–∑–∏—Ü–∏—è X",          default="82",
                  subtext="0‚Äì100% –æ—Ç —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞",  icon="msg_media", on_change=self._apply_cfg),
            Input(key="sun_pos_y",     text="–ü–æ–∑–∏—Ü–∏—è Y",          default="12",
                  subtext="0‚Äì50% –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞",   icon="msg_media", on_change=self._apply_cfg),
            Input(key="sun_ray_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è",  default="3",
                  subtext="0 = —Å—Ç–æ–∏—Ç, –≤—ã—à–µ = –±—ã—Å—Ç—Ä–µ–µ", icon="msg_media", on_change=self._apply_cfg),
            Divider(),
            Header(text="‚òÄÔ∏è –Ø—Å–Ω–æ ‚Äî –ò—Å–∫—Ä—ã"),
            Input(key="spark_spawn",   text="–ß–∞—Å—Ç–æ—Ç–∞ –∏—Å–∫—Ä",       default="85",
                  subtext="0‚Äì100 (–º–µ–Ω—å—à–µ = —á–∞—â–µ)",    icon="msg_media", on_change=self._apply_cfg),
            Input(key="spark_count",   text="–ú–∞–∫—Å. –∏—Å–∫—Ä",         default="20",
                  subtext="—à—Ç—É–∫",                     icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_cloudy(self) -> List[Any]:
        return [
            Header(text="‚õÖ / ‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ—Å—Ç—å"),
            Input(key="cloud_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å –æ–±–ª–∞–∫–æ–≤", default="11",
                  subtext="px/500ms", icon="msg_media", on_change=self._apply_cfg),
            Input(key="cloud_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–≤–Ω–∞",  default="97",
                  subtext="0‚Äì100 (–º–µ–Ω—å—à–µ = —á–∞—â–µ)", icon="msg_media", on_change=self._apply_cfg),
            Input(key="cloud_count", text="–ú–∞–∫—Å. –æ–±–ª–∞–∫–æ–≤",   default="12",
                  subtext="—à—Ç—É–∫", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_fog(self) -> List[Any]:
        return [
            Header(text="üå´ –¢—É–º–∞–Ω"),
            Input(key="fog_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å —á–∞—Å—Ç–∏—Ü", default="6",
                  subtext="px/500ms", icon="msg_media", on_change=self._apply_cfg),
            Input(key="fog_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–≤–Ω–∞",  default="88",
                  subtext="0‚Äì100 (–º–µ–Ω—å—à–µ = —á–∞—â–µ)", icon="msg_media", on_change=self._apply_cfg),
            Input(key="fog_count", text="–ú–∞–∫—Å. —á–∞—Å—Ç–∏—Ü",    default="12",
                  subtext="—à—Ç—É–∫", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_light_rain(self) -> List[Any]:
        return [
            Header(text="üå¶ –õ—ë–≥–∫–∏–π –¥–æ–∂–¥—å / –ú–æ—Ä–æ—Å—å"),
            Input(key="lrain_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å", default="35",
                  subtext="px/500ms", icon="msg_media", on_change=self._apply_cfg),
            Input(key="lrain_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–≤–Ω–∞", default="80",
                  subtext="0‚Äì100", icon="msg_media", on_change=self._apply_cfg),
            Input(key="lrain_count", text="–ú–∞–∫—Å. –∫–∞–ø–µ–ª—å",   default="50",
                  subtext="—à—Ç—É–∫", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_rain(self) -> List[Any]:
        return [
            Header(text="üåß –î–æ–∂–¥—å"),
            Input(key="rain_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å", default="55",
                  subtext="px/500ms", icon="msg_media", on_change=self._apply_cfg),
            Input(key="rain_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–≤–Ω–∞", default="55",
                  subtext="0‚Äì100 (–º–µ–Ω—å—à–µ = —á–∞—â–µ)", icon="msg_media", on_change=self._apply_cfg),
            Input(key="rain_count", text="–ú–∞–∫—Å. –∫–∞–ø–µ–ª—å",   default="150",
                  subtext="—à—Ç—É–∫", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_thunder(self) -> List[Any]:
        return [
            Header(text="‚ö° –ì—Ä–æ–∑–∞"),
            Input(key="thunder_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å –¥–æ–∂–¥—è", default="75",
                  subtext="px/500ms", icon="msg_media", on_change=self._apply_cfg),
            Input(key="thunder_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ –¥–æ–∂–¥—è", default="45",
                  subtext="0‚Äì100", icon="msg_media", on_change=self._apply_cfg),
            Divider(),
            Header(text="‚ö° –ú–æ–ª–Ω–∏—è"),
            Input(key="lightning_intensity", text="–Ø—Ä–∫–æ—Å—Ç—å –≤—Å–ø—ã—à–∫–∏", default="210",
                  subtext="0‚Äì255", icon="msg_media", on_change=self._apply_cfg),
            Input(key="lightning_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å –∑–∞—Ç—É—Ö–∞–Ω–∏—è", default="18",
                  subtext="1‚Äì40 (–º–µ–Ω—å—à–µ = –¥–æ–ª—å—à–µ —Å–≤–µ—Ç–∏—Ç)", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_light_snow(self) -> List[Any]:
        return [
            Header(text="üå® –õ—ë–≥–∫–∏–π —Å–Ω–µ–≥"),
            Input(key="lsnow_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å", default="18",
                  subtext="px/500ms", icon="msg_media", on_change=self._apply_cfg),
            Input(key="lsnow_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–≤–Ω–∞", default="82",
                  subtext="0‚Äì100", icon="msg_media", on_change=self._apply_cfg),
            Input(key="lsnow_count", text="–ú–∞–∫—Å. —Å–Ω–µ–∂–∏–Ω–æ–∫", default="40",
                  subtext="—à—Ç—É–∫", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_snow(self) -> List[Any]:
        return [
            Header(text="‚ùÑÔ∏è –°–Ω–µ–≥ / –ë—É—Ä–∞–Ω"),
            Input(key="snow_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å", default="22",
                  subtext="px/500ms", icon="msg_media", on_change=self._apply_cfg),
            Input(key="snow_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–≤–Ω–∞", default="70",
                  subtext="0‚Äì100", icon="msg_media", on_change=self._apply_cfg),
            Input(key="snow_count", text="–ú–∞–∫—Å. —Å–Ω–µ–∂–∏–Ω–æ–∫", default="100",
                  subtext="—à—Ç—É–∫ (—Å–ª—è–∫–æ—Ç—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–µ –∂–µ)", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _sub_hail(self) -> List[Any]:
        return [
            Header(text="üå® –õ–µ–¥—è–Ω–∞—è –∫—Ä—É–ø–∞ / –ì—Ä–∞–¥"),
            Input(key="hail_speed", text="–°–∫–æ—Ä–æ—Å—Ç—å", default="90",
                  subtext="px/500ms (–æ—á–µ–Ω—å –±—ã—Å—Ç—Ä–æ)", icon="msg_media", on_change=self._apply_cfg),
            Input(key="hail_spawn", text="–ß–∞—Å—Ç–æ—Ç–∞ —Å–ø–∞–≤–Ω–∞", default="50",
                  subtext="0‚Äì100", icon="msg_media", on_change=self._apply_cfg),
            Input(key="hail_count", text="–ú–∞–∫—Å. –≥—Ä–∞–¥–∏–Ω",   default="120",
                  subtext="—à—Ç—É–∫", icon="msg_media", on_change=self._apply_cfg),
        ]

    def _apply_cfg(self, _=None):
        def _i(k, d):
            try:    return max(1, int(self.get_setting(k, str(d))))
            except: return d
        _effect.apply_cfg(
            spark_spawn=_i("spark_spawn",85),     spark_count=_i("spark_count",20),
            sun_pos_x=_i("sun_pos_x",82),         sun_pos_y=_i("sun_pos_y",12),
            sun_ray_speed=_i("sun_ray_speed",3),
            cloud_speed=_i("cloud_speed",11),     cloud_spawn=_i("cloud_spawn",97),
            cloud_count=_i("cloud_count",12),
            fog_speed=_i("fog_speed",6),          fog_spawn=_i("fog_spawn",88),
            fog_count=_i("fog_count",12),
            lrain_speed=_i("lrain_speed",35),     lrain_spawn=_i("lrain_spawn",80),
            lrain_count=_i("lrain_count",50),
            rain_speed=_i("rain_speed",55),       rain_spawn=_i("rain_spawn",55),
            rain_count=_i("rain_count",150),
            thunder_speed=_i("thunder_speed",75), thunder_spawn=_i("thunder_spawn",45),
            lsnow_speed=_i("lsnow_speed",18),     lsnow_spawn=_i("lsnow_spawn",82),
            lsnow_count=_i("lsnow_count",40),
            snow_speed=_i("snow_speed",22),       snow_spawn=_i("snow_spawn",70),
            snow_count=_i("snow_count",100),
            hail_speed=_i("hail_speed",90),       hail_spawn=_i("hail_spawn",50),
            hail_count=_i("hail_count",120),
            lightning_intensity=_i("lightning_intensity",210),
            lightning_speed=_i("lightning_speed",18),
        )

    def create_settings(self) -> List[Any]:
        return [
            Header(text="Dynamic Backgrounds"),
            Switch(key="enabled", text="–í–∫–ª—é—á–∏—Ç—å —ç—Ñ—Ñ–µ–∫—Ç", default=True, icon="msg_settings"),
            Divider(),
            Header(text="–ü–æ–≥–æ–¥–∞"),
            Input(key="city", text="–ì–æ—Ä–æ–¥ (–∑–∞–ø–∞—Å–Ω–æ–π)", default="",
                  subtext="–ï—Å–ª–∏ –∑–∞–¥–∞–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤–º–µ—Å—Ç–æ GPS/IP. –ü—Ä–∏–º–µ—Ä: Moscow",
                  icon="msg_location",
                  on_change=lambda v: (self.set_setting("city", str(v).strip()),
                                       self._invalidate_cache())),
            Text(text="–û–±–Ω–æ–≤–∏—Ç—å –ø–æ–≥–æ–¥—É —Å–µ–π—á–∞—Å", icon="media_repost",
                 on_click=self._force_refresh),
            Input(key="update_interval", text="–ò–Ω—Ç–µ—Ä–≤–∞–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è", default="30",
                  subtext="–º–∏–Ω—É—Ç (–º–∏–Ω–∏–º—É–º 5)", icon="msg_calendar2",
                  on_change=lambda v: self.set_setting("update_interval", str(max(5, int(v or 30))))),
            Divider(),
            Header(text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —á–∞—Å—Ç–∏—Ü"),
            Text(text="‚òÄÔ∏è –Ø—Å–Ω–æ",                  icon="msg_list", create_sub_fragment=self._sub_clear),
            Text(text="‚õÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å",  icon="msg_list", create_sub_fragment=self._sub_cloudy),
            Text(text="‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ / –ü–∞—Å–º—É—Ä–Ω–æ",    icon="msg_list", create_sub_fragment=self._sub_cloudy),
            Text(text="üå´ –¢—É–º–∞–Ω",                  icon="msg_list", create_sub_fragment=self._sub_fog),
            Text(text="üå¶ –õ—ë–≥–∫–∏–π –¥–æ–∂–¥—å / –ú–æ—Ä–æ—Å—å",  icon="msg_list", create_sub_fragment=self._sub_light_rain),
            Text(text="üåß –î–æ–∂–¥—å",                  icon="msg_list", create_sub_fragment=self._sub_rain),
            Text(text="‚ö° –ì—Ä–æ–∑–∞",                  icon="msg_list", create_sub_fragment=self._sub_thunder),
            Text(text="üå® –õ—ë–≥–∫–∏–π —Å–Ω–µ–≥",            icon="msg_list", create_sub_fragment=self._sub_light_snow),
            Text(text="‚ùÑÔ∏è –°–Ω–µ–≥ / –ë—É—Ä–∞–Ω",           icon="msg_list", create_sub_fragment=self._sub_snow),
            Text(text="üåß –°–ª—è–∫–æ—Ç—å",                icon="msg_list", create_sub_fragment=self._sub_snow),
            Text(text="üå® –õ–µ–¥—è–Ω–∞—è –∫—Ä—É–ø–∞ / –ì—Ä–∞–¥",   icon="msg_list", create_sub_fragment=self._sub_hail),
            Divider(),
            Header(text="–ê–≤—Ç–æ—Ä—ã"),
            Text(
                text="@rei_plugins",
                icon="msg_openprofile",
                on_click=lambda v: self._open_profile("rei_plugins"),
            ),
            Text(
                text="@optimist_opti",
                icon="msg_openprofile",
                on_click=lambda v: self._open_profile("optimist_opti"),
            ),
        ]

    def _force_refresh(self, _):
        self._last_update = 0.0
        self._cache.clear()
        run_on_queue(self._fetch_and_apply)
        BulletinHelper.show_info("–û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–≥–æ–¥—É‚Ä¶")

    def _invalidate_cache(self):
        self._cache.clear()
        self._last_update = 0.0

    def _create_settings_header_view(self, context):
        try:
            container = _FL(context)
            content   = _LL(context)
            content.setOrientation(_LL.VERTICAL)

            # –ê–≤–∞—Ç–∞—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            try:
                from org.telegram.messenger import MessagesController, UserConfig
                from org.telegram.ui.Components import AvatarDrawable, BackupImageView
                account = int(getattr(UserConfig, "selectedAccount", 0))
                mc   = MessagesController.getInstance(account)
                uc   = UserConfig.getInstance(account)
                user = mc.getUser(uc.getClientUserId()) if mc and uc else None
                if user:
                    img = BackupImageView(context)
                    img.setRoundRadius(_AU.dp(40))
                    img.setForUserOrChat(user, AvatarDrawable(user))
                    content.addView(img, _LH.createLinear(80, 80, _G.CENTER_HORIZONTAL, 0, 20, 0, 12))
            except Exception as e:
                self.log(f"{self.TAG} avatar: {e}")

            title_tv = _TV(context)
            title_tv.setText("Dynamic Backgrounds")
            title_tv.setTextSize(_TypedValue.COMPLEX_UNIT_DIP, 22)
            title_tv.setGravity(_G.CENTER)
            title_tv.setTextColor(_tc(_Theme.key_windowBackgroundWhiteBlackText))
            try: title_tv.setTypeface(_AU.getTypeface(_AU.TYPEFACE_ROBOTO_MEDIUM))
            except Exception: pass
            content.addView(title_tv, _LH.createLinear(-2, -2, _G.CENTER_HORIZONTAL, 16, 0, 16, 4))

            desc_tv = _TV(context)
            desc_tv.setText("–î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π –ø–æ–≥–æ–¥—ã")
            desc_tv.setTextSize(_TypedValue.COMPLEX_UNIT_DIP, 13)
            desc_tv.setGravity(_G.CENTER)
            desc_tv.setTextColor(_tc(_Theme.key_windowBackgroundWhiteGrayText))
            content.addView(desc_tv, _LH.createLinear(-2, -2, _G.CENTER_HORIZONTAL, 24, 0, 24, 12))

            authors_row = _LL(context)
            authors_row.setOrientation(_LL.HORIZONTAL)
            authors_row.setGravity(_G.CENTER)

            def make_link(name, username):
                tv = _TV(context)
                tv.setText(name)
                tv.setTextSize(_TypedValue.COMPLEX_UNIT_DIP, 13)
                tv.setTextColor(_tc(_Theme.key_windowBackgroundWhiteBlueText))
                tv.setClickable(True)
                tv.setOnClickListener(OnClickListener(
                    lambda v, u=username: self._open_profile(u)))
                return tv

            sep = _TV(context)
            sep.setText("  ‚Ä¢  ")
            sep.setTextSize(_TypedValue.COMPLEX_UNIT_DIP, 13)
            sep.setTextColor(_tc(_Theme.key_windowBackgroundWhiteGrayText))

            authors_row.addView(make_link("@rei_plugins",  "rei_plugins"))
            authors_row.addView(sep)
            authors_row.addView(make_link("@optimist_opti", "optimist_opti"))
            content.addView(authors_row, _LH.createLinear(-2, -2, _G.CENTER_HORIZONTAL, 0, 0, 0, 20))

            container.addView(content, _LH.createFrame(-1, -2, _G.CENTER))
            return container
        except Exception as e:
            self.log(f"{self.TAG} header view: {e}")
            return None

    def _open_profile(self, username):
        try:
            frag = get_last_fragment()
            act  = frag.getParentActivity() if frag else None
            if act:
                try:
                    intent = Intent(Intent.ACTION_VIEW,
                                    Uri.parse(f"tg://resolve?domain={username}"))
                    intent.setPackage(act.getPackageName())
                    act.startActivity(intent)
                except Exception:
                    act.startActivity(Intent(Intent.ACTION_VIEW,
                        Uri.parse(f"https://t.me/{username}")))
        except Exception as e:
            self.log(f"{self.TAG} open_profile: {e}")

    def _open_api_site(self, _):
        try:
            fragment = get_last_fragment()
            if not fragment: return
            activity = fragment.getParentActivity()
            if not activity: return
            intent = Intent(Intent.ACTION_VIEW)
            intent.setData(Uri.parse("https://www.weatherapi.com/signup.aspx"))
            activity.startActivity(intent)
        except Exception as e:
            self.log(f"{self.TAG} open_api_site: {e}")

    # ‚îÄ‚îÄ Commands ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        msg = params.message
        if not isinstance(msg, str) or not msg.startswith(".bg"):
            return HookResult()
        cmd = msg.strip().lower()

        if cmd in (".bg", ".bg help"):
            params.message = (
                "üå¶ Dynamic Backgrounds\n\n"
                ".bg clear / partly_cloudy / cloudy / fog\n"
                ".bg light_rain / rain / thunder\n"
                ".bg light_snow / snow / sleet / hail\n"
                ".bg auto   ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ API\n"
                ".bg status ‚Äî —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ"
            )
            return HookResult(strategy=HookStrategy.MODIFY, params=params)

        if cmd == ".bg status":
            e   = _effect
            params.message = (
                f"üå¶ DynBG v5.4\n"
                f"–õ–æ–∫–∞—Ü–∏—è: {self._location_name}\n"
                f"–ü–æ–≥–æ–¥–∞: {self._LABELS.get(self._weather_type, self._weather_type)}\n"
                f"–ß–∞—Å—Ç–∏—Ü: {len(e.particles)}\n"
                f"–ê–Ω–∏–º–∞—Ü–∏—è: {'‚ñ∂Ô∏è' if e.running else '‚è∏'}"
            )
            return HookResult(strategy=HookStrategy.MODIFY, params=params)

        if cmd == ".bg auto":
            self._last_update = 0.0
            self._cache.clear()
            run_on_queue(self._fetch_and_apply)
            params.message = "üîÑ –û–±–Ω–æ–≤–ª—è—é –ø–æ–≥–æ–¥—É‚Ä¶"
            return HookResult(strategy=HookStrategy.MODIFY, params=params)

        wt = self._CMDS.get(cmd)
        if wt is None:
            params.message = f"‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: {cmd}\n–ù–∞–ø–∏—à–∏ .bg help"
            return HookResult(strategy=HookStrategy.MODIFY, params=params)

        self._weather_type = wt
        self._last_update  = time.time()
        run_on_ui_thread(self._sync)
        params.message = f"{self._LABELS[wt]} ‚Äî –ø—Ä–∏–º–µ–Ω—ë–Ω!"
        return HookResult(strategy=HookStrategy.MODIFY, params=params)

    # ‚îÄ‚îÄ Hooks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _setup_hooks(self):
        try:
            ChatClass = find_class("org.telegram.ui.ChatActivity")
            if ChatClass:
                self.hook_all_methods(ChatClass, "onResume", ResumeHook(self))
                self.hook_all_methods(ChatClass, "onPause",  PauseHook())
                self.log(f"{self.TAG} ChatActivity hooked")
            draw_hook = DrawHook()
            for cname in (
                "org.telegram.ui.ChatActivity$ChatActivityFragmentView",
                "org.telegram.ui.Components.SizeNotifierFrameLayout",
                "org.telegram.ui.ActionBar.ActionBar",
            ):
                cls = find_class(cname)
                if not cls: continue
                for mname in ("dispatchDraw", "onDraw"):
                    try:
                        res = self.hook_all_methods(cls, mname, draw_hook)
                        if res:
                            self.log(f"{self.TAG} hooked {cname}.{mname}")
                            return
                    except Exception: pass
            self.log(f"{self.TAG} WARNING: draw hook not found!")
        except Exception as e:
            self.log(f"{self.TAG} _setup_hooks: {e}")

    def _on_resumed(self):
        if not self.get_setting("enabled", True):
            return
        def go():
            _effect.running = True
            self._sync()
            self.log(f"{self.TAG} resumed, weather={self._weather_type}")
        run_on_ui_thread(go)

    def _sync(self):
        wt = self._weather_type if self.get_setting("enabled", True) else "clear"
        _effect.set_weather(wt)

    # ‚îÄ‚îÄ Weather loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    def _get_update_interval(self) -> float:
        try:    return max(5, int(self.get_setting("update_interval", "30"))) * 60.0
        except: return UPDATE_SEC

    def _start_weather_loop(self):
        self._loop_running = True
        def loop():
            while self._loop_running:
                if time.time() - self._last_update >= self._get_update_interval():
                    self._fetch_and_apply()
                time.sleep(60)
        threading.Thread(target=loop, daemon=True, name="DynBG-loop").start()

    def _fetch_and_apply(self):
        if not self._fetch_lock.acquire(blocking=False):
            return
        try:
            # 1. –ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
            lat, lon, location_name = self._get_location()
            if lat is None:
                self.log(f"{self.TAG} location unavailable, skip")
                return

            # 2. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –ø–æ–≥–æ–¥—É Open-Meteo (–±–µ—Å–ø–ª–∞—Ç–Ω–æ, –±–µ–∑ –∫–ª—é—á–∞)
            ck = f"{lat:.3f}_{lon:.3f}"
            if ck in self._cache:
                data, ts = self._cache[ck]
                if time.time() - ts < CACHE_SEC:
                    self.log(f"{self.TAG} cached ({location_name})")
                    wt = data
                    self._weather_type = wt
                    self._last_update  = time.time()
                    self._location_name = location_name
                    run_on_ui_thread(self._sync)
                    return

            r = requests.get(
                "https://api.open-meteo.com/v1/forecast"
                f"?latitude={lat}&longitude={lon}"
                "&current=weather_code"
                "&forecast_days=1",
                timeout=10,
                headers={"User-Agent": "DynamicBackgrounds/5.4"},
            )
            self.log(f"{self.TAG} Open-Meteo {r.status_code}")
            if r.status_code != 200:
                self.log(f"{self.TAG} error: {r.text[:200]}")
                return

            code = r.json().get("current", {}).get("weather_code", 0)
            wt   = WMO.get(int(code), "clear")
            self.log(f"{self.TAG} WMO {code} ‚Üí {wt} @ {location_name}")

            self._cache[ck]      = (wt, time.time())
            self._weather_type   = wt
            self._location_name  = location_name
            self._last_update    = time.time()
            run_on_ui_thread(self._sync)
        except Exception as e:
            self.log(f"{self.TAG} _fetch_and_apply: {e}")
        finally:
            self._fetch_lock.release()

    def _get_location(self):
        """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (lat, lon, name). –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: —Ä—É—á–Ω–æ–π –≥–æ—Ä–æ–¥ ‚Üí GPS ‚Üí IP."""
        # ‚îÄ‚îÄ –ü–æ–ø—ã—Ç–∫–∞ 0: —Ä—É—á–Ω–æ–π –≥–æ—Ä–æ–¥ –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–µ—Å–ª–∏ –∑–∞–¥–∞–Ω) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        city = self.get_setting("city", "").strip()
        if city:
            try:
                r = requests.get(
                    "https://geocoding-api.open-meteo.com/v1/search"
                    f"?name={requests.utils.quote(city)}&count=1&language=ru",
                    timeout=8,
                    headers={"User-Agent": "DynamicBackgrounds/5.4"},
                )
                if r.status_code == 200:
                    results = r.json().get("results", [])
                    if results:
                        res  = results[0]
                        lat  = float(res["latitude"])
                        lon  = float(res["longitude"])
                        name = res.get("name", city)
                        self.log(f"{self.TAG} manual city '{city}' ‚Üí {lat},{lon}")
                        return lat, lon, name
            except Exception as e:
                self.log(f"{self.TAG} manual geocoding: {e}")

        # ‚îÄ‚îÄ –ü–æ–ø—ã—Ç–∫–∞ 1: Android LocationManager ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        try:
            from android.content import Context
            from android.location import LocationManager
            from org.telegram.messenger import ApplicationLoader
            ctx = ApplicationLoader.applicationContext
            lm  = ctx.getSystemService(Context.LOCATION_SERVICE)
            best = None
            for provider in (LocationManager.GPS_PROVIDER,
                             LocationManager.NETWORK_PROVIDER):
                try:
                    if not lm.isProviderEnabled(provider):
                        continue
                    loc = lm.getLastKnownLocation(provider)
                    if loc is None:
                        continue
                    age = (time.time() * 1000 - loc.getTime()) / 1000
                    if age > 3600:   # –Ω–µ —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞
                        continue
                    if best is None or loc.getAccuracy() < best.getAccuracy():
                        best = loc
                except Exception:
                    continue
            if best is not None:
                lat = best.getLatitude()
                lon = best.getLongitude()
                name = self._reverse_geocode(lat, lon)
                self.log(f"{self.TAG} GPS location: {lat:.3f},{lon:.3f}")
                return lat, lon, name
        except Exception as e:
            self.log(f"{self.TAG} LocationManager: {e}")

        # ‚îÄ‚îÄ –ü–æ–ø—ã—Ç–∫–∞ 2: ip-api.com (–±–µ–∑ –∫–ª—é—á–∞, ~1000 –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        try:
            r = requests.get("http://ip-api.com/json/?fields=lat,lon,city,country",
                             timeout=6,
                             headers={"User-Agent": "DynamicBackgrounds/5.4"})
            if r.status_code == 200:
                d    = r.json()
                lat  = float(d["lat"])
                lon  = float(d["lon"])
                name = f"{d.get('city','?')}, {d.get('country','?')}"
                self.log(f"{self.TAG} IP location: {name}")
                return lat, lon, name
        except Exception as e:
            self.log(f"{self.TAG} ip-api: {e}")

        return None, None, "?"

    def _reverse_geocode(self, lat: float, lon: float) -> str:
        """–ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º —á–µ—Ä–µ–∑ Open-Meteo geocoding."""
        try:
            r = requests.get(
                f"https://nominatim.openstreetmap.org/reverse"
                f"?lat={lat}&lon={lon}&format=json&zoom=10",
                timeout=5,
                headers={"User-Agent": "DynamicBackgrounds/5.4"},
            )
            if r.status_code == 200:
                addr = r.json().get("address", {})
                city = (addr.get("city") or addr.get("town")
                        or addr.get("village") or addr.get("county", "?"))
                country = addr.get("country_code", "").upper()
                return f"{city}, {country}"
        except Exception:
            pass
        return f"{lat:.2f},{lon:.2f}"
