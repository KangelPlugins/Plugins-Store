__id__ = "randomizer_plugin"
__name__ = "Universal Randomizer"
__description__ = "–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª—É—á–∞–π–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏–∑ —Å–ø–∏—Å–∫–∞, –∑–∞–¥–∞–Ω–Ω–æ–≥–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç ID, username, –∞–¥—Ä–µ—Å–∞, —á–∏—Å–ª–∞, —Å–ª–æ–≤–∞ –∏ —Ç.–¥. –ö–æ–º–∞–Ω–¥—ã: .rnd, .set, .clr, .add"
__author__ = "Raitorinkus"
__version__ = "1.1.0"  # Updated commands and added success dialogs
__icon__ = "RTnKs/0"
__min_version__ = "11.12.0"

import random
import traceback
from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import send_message, log, get_last_fragment
from android_utils import run_on_ui_thread
from markdown_utils import parse_markdown
from ui.settings import Header, Text, Divider, Switch, Input
from org.telegram.tgnet import TLRPC
from java.util import ArrayList, Locale
from android.app import AlertDialog
from ui.alert import AlertDialogBuilder


class UniversalRandomizerPlugin(BasePlugin):
    def create_settings(self):
        settings = [
            Header(text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Universal Randomizer"),
            Text(text="–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏", icon="msg_settings", create_sub_fragment=self.create_general_settings),
            Text(text="–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã–≤–æ–¥–∞", icon="filled_button_share_solar", create_sub_fragment=self.create_output_settings),
            Text(text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤", icon="msg_info", create_sub_fragment=self.create_dialog_settings),
            Divider(text=(
                "–ö–æ–º–∞–Ω–¥—ã:\n"
                ".rnd ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n"
                ".set ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫\n"
                ".clr ‚Äî –æ—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞\n"
                ".add ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n"
                "–ü—Ä–∏–º–µ—Ä: .add @user1,@user2"
            ))
        ]
        log("Settings created successfully")
        return settings

    def create_general_settings(self):
        return [
            Input(
                key="item_list",
                text="–°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤",
                default="",
                subtext="–í–≤–µ–¥–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä: @user1,123,New York). –ë–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É."
            ),
            Input(
                key="selection_count",
                text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±–æ—Ä–æ–≤",
                default="1",
                subtext="–£–∫–∞–∂–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 10000."
            )
        ]

    def create_dialog_settings(self):
        return [
            Header(text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–∏–∞–ª–æ–≥–æ–≤"),
            Switch(
                key="show_settings_in_dialog",
                text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ .set –≤ –¥–∏–∞–ª–æ–≥–µ",
                icon="msg_info",
                subtext="–ö–æ–º–∞–Ω–¥–∞ .set –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –≤–º–µ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ —á–∞—Ç",
                default=True
            ),
            Switch(
                key="show_errors_in_dialog",
                text="–û—à–∏–±–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–µ",
                icon="msg_help",
                subtext="–û—à–∏–±–∫–∏ –∫–æ–º–∞–Ω–¥ –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–∫–Ω–∞—Ö",
                default=True
            ),
            Switch(
                key="show_success_in_dialog",
                text="–£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –≤ –¥–∏–∞–ª–æ–≥–µ",
                icon="msg_check",
                subtext="–°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∏ –æ—á–∏—Å—Ç–∫–µ –±—É–¥—É—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å—Å—è –≤ –¥–∏–∞–ª–æ–≥–æ–≤—ã—Ö –æ–∫–Ω–∞—Ö",
                default=True
            ),
        ]

    def create_output_settings(self):
        return [
            Switch(
                key="sort_asc",
                text="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ê-–Ø)",
                default=False,
                subtext="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ç –ê –¥–æ –Ø.",
                on_change=lambda value: self._update_sort_settings("sort_asc", value)
            ),
            Switch(
                key="sort_desc",
                text="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–Ø-–ê)",
                default=False,
                subtext="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ç –Ø –¥–æ –ê.",
                on_change=lambda value: self._update_sort_settings("sort_desc", value)
            ),
            Switch(
                key="sort_len_asc",
                text="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–ª–∏–Ω–µ (–∫–æ—Ä–æ—Ç–∫–∏–µ –ø–µ—Ä–≤—ã–µ)",
                default=False,
                subtext="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ç –∫–æ—Ä–æ—Ç–∫–∏—Ö –∫ –¥–ª–∏–Ω–Ω—ã–º.",
                on_change=lambda value: self._update_sort_settings("sort_len_asc", value)
            ),
            Switch(
                key="sort_len_desc",
                text="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–ª–∏–Ω–µ (–¥–ª–∏–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–µ)",
                default=False,
                subtext="–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –æ—Ç –¥–ª–∏–Ω–Ω—ã—Ö –∫ –∫–æ—Ä–æ—Ç–∫–∏–º.",
                on_change=lambda value: self._update_sort_settings("sort_len_desc", value)
            ),
            Switch(
                key="use_blockquote",
                text="–í—ã–≤–æ–¥–∏—Ç—å –≤ —Ü–∏—Ç–∞—Ç–µ",
                default=False,
                subtext="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Ü–∏—Ç–∞—Ç–µ."
            )
        ]

    def _update_sort_settings(self, key, value):
        """Ensure only one sort option is enabled at a time."""
        if value:
            sort_keys = ["sort_asc", "sort_desc", "sort_len_asc", "sort_len_desc"]
            for other_key in sort_keys:
                if other_key != key:
                    self.set_setting(other_key, False)

    def _get_parsed_items(self):
        """Get parsed list of items, cached for performance."""
        item_list = self.get_setting("item_list", "").strip()
        if not item_list:
            return []
        return [item.strip() for item in item_list.split(",") if item.strip()]

    def on_plugin_load(self):
        log("on_plugin_load called")
        self.add_on_send_message_hook()
        log("add_on_send_message_hook called")
        log("–ü–ª–∞–≥–∏–Ω Universal Randomizer –∑–∞–≥—Ä—É–∑–∏–ª—Å—è —É—Å–ø–µ—à–Ω–æ!")

    def show_smart_error_dialog(self, error_type, details=None):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É–º–Ω–æ–µ –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ —Å –∞–Ω–∞–ª–∏–∑–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏"""
        show_in_dialog = self.get_setting("show_errors_in_dialog", True)
        if show_in_dialog:
            run_on_ui_thread(lambda: self._show_smart_error_dialog_ui(error_type, details))

    def show_success_dialog(self, title, message):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –æ–± —É—Å–ø–µ—à–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏"""
        show_in_dialog = self.get_setting("show_success_in_dialog", True)
        log(f"show_success_dialog called: title='{title}', message='{message}', show_in_dialog={show_in_dialog}")
        if show_in_dialog:
            log("Calling _show_success_dialog_ui on UI thread")
            run_on_ui_thread(lambda: self._show_success_dialog_ui(title, message))
        else:
            log("Success dialog disabled in settings")

    def _show_success_dialog_ui(self, title, message):
        """UI —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–∞ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏"""
        log(f"_show_success_dialog_ui called: title='{title}', message='{message}'")
        try:
            fragment = get_last_fragment()
            log(f"Fragment: {fragment}")
            activity = fragment.getParentActivity() if fragment else None
            log(f"Activity: {activity}")

            if not activity:
                log("No activity found, cannot show dialog")
                return

            log("Creating AlertDialogBuilder")
            builder = AlertDialogBuilder(activity)
            builder.set_title(title)
            builder.set_message(message)
            builder.set_positive_button("–û–ö", lambda b, w: b.dismiss())
            builder.set_cancelable(True)
            log("Showing dialog")
            builder.show()
            log("Dialog shown successfully")

        except Exception as e:
            log(f"Error showing success dialog: {e}")
            import traceback
            log(f"Traceback: {traceback.format_exc()}")
            # Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π Android
            pass

    def _show_smart_error_dialog_ui(self, error_type, details):
        """UI —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —É–º–Ω–æ–≥–æ –¥–∏–∞–ª–æ–≥–∞ –æ—à–∏–±–∫–∏"""
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None

            if not activity:
                return

            title, message = self._analyze_randomizer_error_situation(error_type, details)

            builder = AlertDialogBuilder(activity)
            builder.set_title(title)
            builder.set_message(message)
            builder.set_positive_button("–ü–æ–Ω—è—Ç–Ω–æ", lambda b, w: b.dismiss())
            builder.set_cancelable(True)
            builder.show()

        except Exception as e:
            log(f"Error showing error dialog: {e}")
            # Fallback –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π Android
            pass

    def _analyze_randomizer_error_situation(self, error_type, details):
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""

        if error_type == "empty_list":
            title = "üìù –ü—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫"
            message = (
                "–°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–Ω–¥–æ–º–∏–∑–∞—Ü–∏–∏ –ø—É—Å—Ç.\n\n"
                "üîß –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã:\n"
                "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É .add\n"
                "‚Ä¢ –ò–ª–∏ –∑–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–≥–∏–Ω–∞\n"
                "‚Ä¢ –í–≤–µ–¥–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é\n\n"
                "üí° –ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ .add @user1,@user2,@user3\n"
                "‚Ä¢ .add 1,2,3,4,5\n"
                "‚Ä¢ .add –ú–æ—Å–∫–≤–∞,–õ–æ–Ω–¥–æ–Ω,–ü–∞—Ä–∏–∂"
            )

        elif error_type == "invalid_count":
            count = details or "???"
            title = "üî¢ –ù–µ–≤–µ—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ"
            message = (
                f"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ '{count}' –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.\n\n"
                "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è:\n"
                "‚Ä¢ –ü–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞: 1, 2, 3...\n"
                "‚Ä¢ –ú–∞–∫—Å–∏–º—É–º: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ\n\n"
                "‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:\n"
                "‚Ä¢ –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–µ —á–∏—Å–ª–∞: -1, -5\n"
                "‚Ä¢ –ù–æ–ª—å: 0\n"
                "‚Ä¢ –¢–µ–∫—Å—Ç: abc, –º–Ω–æ–≥–æ\n"
                "‚Ä¢ –ë–æ–ª—å—à–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–∫–µ\n\n"
                "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–≥–∏–Ω–∞"
            )

        elif error_type == "count_exceeds_list":
            count = details.get("count", "???") if details else "???"
            list_size = details.get("list_size", "???") if details else "???"
            title = "üìä –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
            message = (
                f"–ó–∞–ø—Ä–æ—à–µ–Ω–æ {count} —ç–ª–µ–º–µ–Ω—Ç–æ–≤, –Ω–æ –≤ —Å–ø–∏—Å–∫–µ —Ç–æ–ª—å–∫–æ {list_size}.\n\n"
                "üîß –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:\n"
                "‚Ä¢ –£–º–µ–Ω—å—à–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö\n"
                "‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Å–ø–∏—Å–æ–∫\n"
                "‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .add –¥–ª—è –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è\n\n"
                "üí° –¢–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –º–æ–∂–Ω–æ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫–æ–º–∞–Ω–¥–æ–π .set"
            )

        elif error_type == "invalid_add_format":
            title = "üìù –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∏—è"
            message = (
                "–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.\n\n"
                "‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç:\n"
                ".add —ç–ª–µ–º–µ–Ω—Ç1,—ç–ª–µ–º–µ–Ω—Ç2,—ç–ª–µ–º–µ–Ω—Ç3\n\n"
                "üí° –ü—Ä–∏–º–µ—Ä—ã:\n"
                "‚Ä¢ .add @user1,@user2\n"
                "‚Ä¢ .add 100,200,300\n"
                "‚Ä¢ .add –ú–æ—Å–∫–≤–∞,–õ–æ–Ω–¥–æ–Ω\n"
                "‚Ä¢ .add –∫—Ä–∞—Å–Ω—ã–π,—Å–∏–Ω–∏–π,–∑–µ–ª—ë–Ω—ã–π\n\n"
                "‚ùå –ò–∑–±–µ–≥–∞–π—Ç–µ:\n"
                "‚Ä¢ –ü—É—Å—Ç—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–µ–∂–¥—É –∑–∞–ø—è—Ç—ã–º–∏\n"
                "‚Ä¢ –¢–æ–ª—å–∫–æ –ø—Ä–æ–±–µ–ª–æ–≤"
            )

        elif error_type == "no_valid_elements":
            title = "üö´ –ù–µ—Ç –≤–∞–ª–∏–¥–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
            message = (
                "–ü–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ –æ—Å—Ç–∞–ª–æ—Å—å –≤–∞–ª–∏–¥–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤.\n\n"
                "üîç –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
                "‚Ä¢ –í—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–æ—Å—Ç–æ—è—Ç —Ç–æ–ª—å–∫–æ –∏–∑ –ø—Ä–æ–±–µ–ª–æ–≤\n"
                "‚Ä¢ –°–ø–∏—Å–æ–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –∑–∞–ø—è—Ç—ã–µ\n"
                "‚Ä¢ –≠–ª–µ–º–µ–Ω—Ç—ã –±—ã–ª–∏ —É–¥–∞–ª–µ–Ω—ã –ø—Ä–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏\n\n"
                "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–ø–∏—Å–∫–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö"
            )

        else:  # unexpected_error
            title = "‚ö†Ô∏è –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞"
            message = (
                "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –≤ —Ä–∞–Ω–¥–æ–º–∞–π–∑–µ—Ä–µ.\n\n"
                "üîß –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n"
                "‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∫–æ–º–∞–Ω–¥—É\n"
                "‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–≥–∏–Ω–∞\n"
                "‚Ä¢ –û—á–∏—Å—Ç–∏—Ç—å –∏ –∑–∞–Ω–æ–≤–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫\n"
                "‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\n\n"
                "üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n"
                "‚Ä¢ .rnd ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è\n"
                "‚Ä¢ .set ‚Äî –ø—Ä–æ—Å–º–æ—Ç—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫\n"
                "‚Ä¢ .clr ‚Äî –æ—á–∏—Å—Ç–∫–∞ —Å–ø–∏—Å–∫–∞\n"
                "‚Ä¢ .add ‚Äî –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤"
            )

        return title, message

    def _show_settings_dialog(self, settings_text):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –¥–∏–∞–ª–æ–≥–æ–≤–æ–º –æ–∫–Ω–µ"""
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None

            if not activity:
                return

            title = "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Randomizer"
            ok_button = "–û–ö"

            builder = AlertDialogBuilder(activity)
            builder.set_title(title)
            builder.set_message(settings_text)
            builder.set_positive_button(ok_button, lambda b, w: b.dismiss())
            builder.set_cancelable(True)
            builder.show()

        except Exception:
            pass  # –¢–∏—Ö–æ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –¥–∏–∞–ª–æ–≥–∞

    def on_send_message_hook(self, account, params) -> HookResult:
        # Only process text messages that are valid commands
        if not hasattr(params, 'message') or not isinstance(params.message, str):
            return HookResult(strategy=HookStrategy.PASS)

        text = params.message.strip()
        if not text:
            return HookResult(strategy=HookStrategy.PASS)

        # Check if the message is a valid command
        if not (text.startswith(".rnd") or text == ".rnd" or
                text.startswith(".set") or text == ".set" or
                text.startswith(".clr") or text == ".clr" or
                text.startswith(".add") or text == ".add"):
            return HookResult(strategy=HookStrategy.PASS)

        # .set
        if text.startswith(".set") or text == ".set":
            item_list = self.get_setting("item_list", "").strip()
            selection_count = self.get_setting("selection_count", "1")
            sort_asc = self.get_setting("sort_asc", False)
            sort_desc = self.get_setting("sort_desc", False)
            sort_len_asc = self.get_setting("sort_len_asc", False)
            sort_len_desc = self.get_setting("sort_len_desc", False)
            use_blockquote = self.get_setting("use_blockquote", False)
            items = self._get_parsed_items()
            item_count = len(items)
            sort_type_display = (
                "–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–ê-–Ø)" if sort_asc else
                "–ü–æ –∞–ª—Ñ–∞–≤–∏—Ç—É (–Ø-–ê)" if sort_desc else
                "–ü–æ –¥–ª–∏–Ω–µ (–∫–æ—Ä–æ—Ç–∫–∏–µ –ø–µ—Ä–≤—ã–µ)" if sort_len_asc else
                "–ü–æ –¥–ª–∏–Ω–µ (–¥–ª–∏–Ω–Ω—ã–µ –ø–µ—Ä–≤—ã–µ)" if sort_len_desc else
                "–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏"
            )
            settings_text = (
                f"‚öôÔ∏è –¢–µ–∫—É—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:\n"
                f"- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {item_count}\n"
                f"- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–±–æ—Ä–æ–≤: {selection_count}\n"
                f"- –¢–∏–ø —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏: {sort_type_display}\n"
                f"- –í—ã–≤–æ–¥–∏—Ç—å –≤ —Ü–∏—Ç–∞—Ç–µ: {'–í–∫–ª—é—á–µ–Ω–æ' if use_blockquote else '–í—ã–∫–ª—é—á–µ–Ω–æ'}\n"
                f"- –ü–µ—Ä–≤—ã–µ 5 —ç–ª–µ–º–µ–Ω—Ç–æ–≤: {', '.join(items[:5] + ['...'] if item_count > 5 else items) if items else '–ü—É—Å—Ç–æ'}"
            )
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –¥–∏–∞–ª–æ–≥–æ–≤
            show_in_dialog = self.get_setting("show_settings_in_dialog", True)
            if show_in_dialog:
                run_on_ui_thread(lambda: self._show_settings_dialog(settings_text))
                return HookResult(strategy=HookStrategy.CANCEL)
            else:
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —á–∞—Ç–µ
                parsed = parse_markdown(settings_text)
                params.message = parsed.text
                params.entities = parsed.entities if parsed.entities else ArrayList()
                log("Settings displayed successfully")
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

        # .clr
        if text.startswith(".clr") or text == ".clr":
            log("Processing .clr")
            self.set_setting("item_list", "")

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
            success_message = "üßπ –°–ø–∏—Å–æ–∫ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –æ—á–∏—â–µ–Ω."
            show_in_dialog = self.get_setting("show_success_in_dialog", True)
            log(f"Clear command: show_in_dialog={show_in_dialog}")
            if show_in_dialog:
                log("Showing clear success dialog")
                self.show_success_dialog("–°–ø–∏—Å–æ–∫ –æ—á–∏—â–µ–Ω", success_message)
                return HookResult(strategy=HookStrategy.CANCEL)
            else:
                log("Sending clear success message to chat")
                params.message = success_message
                params.entities = ArrayList()
                log("List cleared successfully")
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

        # .add
        if text.startswith(".add") or text == ".add":
            new_items = text[len(".add"):].strip()
            if not new_items:
                self.show_smart_error_dialog("invalid_add_format")
                return HookResult(strategy=HookStrategy.CANCEL)
            current_items = set(self._get_parsed_items())
            new_items_list = [item.strip() for item in new_items.split(",") if item.strip()]
            added_items = [item for item in new_items_list if item not in current_items]
            if not added_items:
                error_message = "‚ùå –í—Å–µ —É–∫–∞–∑–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ."
                show_in_dialog = self.get_setting("show_success_in_dialog", True)
                if show_in_dialog:
                    self.show_success_dialog("–≠–ª–µ–º–µ–Ω—Ç—ã –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã", error_message)
                    return HookResult(strategy=HookStrategy.CANCEL)
                else:
                    params.message = error_message
                    params.entities = ArrayList()
                    return HookResult(strategy=HookStrategy.MODIFY, params=params)
            current_items.update(added_items)
            updated_list = ",".join(current_items)
            self.set_setting("item_list", updated_list)

            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∏–∞–ª–æ–≥ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ —á–∞—Ç
            success_message = f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ: {', '.join(added_items)}"
            show_in_dialog = self.get_setting("show_success_in_dialog", True)
            log(f"Add command: show_in_dialog={show_in_dialog}")
            if show_in_dialog:
                log("Showing add success dialog")
                self.show_success_dialog("–≠–ª–µ–º–µ–Ω—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã", success_message)
                return HookResult(strategy=HookStrategy.CANCEL)
            else:
                log("Sending add success message to chat")
                params.message = success_message
                params.entities = ArrayList()
                log(f"Added items: {', '.join(added_items)}")
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

        # .rnd
        items = self._get_parsed_items()
        sort_asc = self.get_setting("sort_asc", False)
        sort_desc = self.get_setting("sort_desc", False)
        sort_len_asc = self.get_setting("sort_len_asc", False)
        sort_len_desc = self.get_setting("sort_len_desc", False)
        use_blockquote = self.get_setting("use_blockquote", False)
        try:
            selection_count = int(self.get_setting("selection_count", "1"))
            if selection_count < 1 or selection_count > 10000:
                self.show_smart_error_dialog("invalid_count", str(selection_count))
                return HookResult(strategy=HookStrategy.CONTINUE)
        except ValueError:
            invalid_count = self.get_setting("selection_count", "1")
            self.show_smart_error_dialog("invalid_count", invalid_count)
            return HookResult(strategy=HookStrategy.CONTINUE)

        if not items:
            self.show_smart_error_dialog("empty_list")
            return HookResult(strategy=HookStrategy.CONTINUE)

        if selection_count > len(items):
            self.show_smart_error_dialog("count_exceeds_list", {
                "count": selection_count,
                "list_size": len(items)
            })
            return HookResult(strategy=HookStrategy.CONTINUE)

        try:
            selected_items = random.sample(items, selection_count)
            if sort_asc:
                selected_items.sort()
            elif sort_desc:
                selected_items.sort(reverse=True)
            elif sort_len_asc:
                selected_items.sort(key=len)
            elif sort_len_desc:
                selected_items.sort(key=len, reverse=True)

            result_text = f"üé≤ –°–ª—É—á–∞–π–Ω–æ –≤—ã–±—Ä–∞–Ω–æ {selection_count} —ç–ª–µ–º–µ–Ω—Ç(–æ–≤):\n" + "\n".join([f"- {item}" for item in selected_items])
            parsed = parse_markdown(result_text)
            params.message = parsed.text
            params.entities = parsed.entities if parsed.entities else ArrayList()

            if use_blockquote:
                entity = TLRPC.TL_messageEntityBlockquote()
                entity.collapsed = True
                entity.offset = 0
                entity.length = len(params.message.encode("utf-16-le")) // 2
                params.entities.add(entity)

            log(f"Random selection successful: {len(selected_items)} items selected")
            return HookResult(strategy=HookStrategy.MODIFY, params=params)
        except Exception as e:
            self.show_smart_error_dialog("unexpected_error")
            log(f"Error in random selection: {traceback.format_exc()}")
            return HookResult(strategy=HookStrategy.CONTINUE)

    def send_response(self, peer, msg, entities=None):
        log(f"send_response called with peer={peer}, msg={msg}, entities={entities}")
        message_params = {
            "peer": peer,
            "message": msg
        }
        if entities:
            message_params["entities"] = entities
            log(f"Entities attached: {entities}")
        else:
            log("No entities attached")
        run_on_ui_thread(lambda: send_message(message_params))
        log(f"Response sent: {msg}")

    def send_error(self, peer, msg):
        run_on_ui_thread(lambda: send_message({
            "peer": peer,
            "message": f"‚ùå {msg}"
        }))
        log(f"Error sent: {msg}")