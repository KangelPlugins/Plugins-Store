__id__ = "phrase"
__name__ = "–û—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π"
__description__ = "üá∑üá∫ | AI –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, —É–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ (—Å–º–æ—Ç—Ä–µ—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞–≥–∏–Ω–∞).\n\nüá∫üá∏ | AI correction, text improvement and much more (see plugin settings)."
__author__ = "@inclu_01 and @buligaEplugins "
__version__ = "3.4.2-release"
__icon__ = "BuligaPlugins/1"
__min_version__ = "11.12.0"

import re
import json
import requests
from typing import Any

from base_plugin import BasePlugin, HookResult, HookStrategy, AppEvent
from android_utils import log, run_on_ui_thread, OnClickListener, OnLongClickListener
from client_utils import run_on_queue, send_message, get_last_fragment, EXTERNAL_NETWORK_QUEUE
from markdown_utils import parse_markdown
from ui.alert import AlertDialogBuilder
from org.telegram.messenger import ApplicationLoader, UserConfig, AndroidUtilities
from org.telegram.ui.ActionBar import Theme
from android.widget import LinearLayout, TextView, ScrollView, FrameLayout, ImageView, EditText
from android.view import Gravity, View, ViewGroup
from android.graphics import Color
from com.exteragram.messenger.utils import ChatUtils
from java import dynamic_proxy

try:
    from java.util import Locale
    LOCALE_AVAILABLE = True
except Exception:
    LOCALE_AVAILABLE = False

try:
    from org.telegram.ui import ChatActivity, ProfileActivity, DialogsActivity
    from android.os import Bundle, Process
    from android.content import Intent
    CHAT_OPEN_AVAILABLE = True
except Exception:
    CHAT_OPEN_AVAILABLE = False

_SENTENCE_SPLIT_RE = re.compile(r'(?<=[\.!\?])\s+')
_FORMATTING_LEGEND = (
    "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞:\n"
    "**–ñ–∏—Ä–Ω—ã–π**\n"
    "*–ö—É—Ä—Å–∏–≤*\n"
    "_–ü–æ–¥—á—ë—Ä–∫–Ω—É—Ç—ã–π_\n"
    "***–ñ–∏—Ä–Ω—ã–π –∫—É—Ä—Å–∏–≤***\n"
    "~–ó–∞—á–µ—Ä–∫–Ω—É—Ç—ã–π~\n"
    ">„Ö§–¶–∏—Ç–∞—Ç–∞\n"
    "| –°–∫—Ä—ã—Ç—ã–π |\n"
    "````–∫–æ–¥ —Ç–µ–∫—Å—Ç````"
)


def _capitalize_first_alpha(s: str) -> str:
    for i, ch in enumerate(s):
        if ch.isalpha():
            j = i - 1
            while j >= 0 and s[j].isspace():
                j -= 1
            if j >= 0 and s[j].isdigit():
                return s
            return s[:i] + s[i].upper() + s[i+1:]
    return s


def _utf16_to_python_offset(text: str, utf16_offset: int) -> int:
    utf16_pos = 0
    python_pos = 0
    
    for char in text:
        if utf16_pos >= utf16_offset:
            return python_pos
        if ord(char) > 0xFFFF:
            utf16_pos += 2
        else:
            utf16_pos += 1
        python_pos += 1
    
    return python_pos


class PhrasePlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        try:
            log("[PhrasePlugin] Installation complete.")
        except Exception:
            pass
        self._sent_messages = set()
        self._chat_rules_cache = None
        self._last_ai_in = None
        self._last_ai_out = None
        self._ai_inflight = set()
        self._http = requests.Session()
        self._http.headers.update({
            "Content-Type": "application/json; charset=utf-8",
            "User-Agent": "okhttp/4.12.0",
            "Connection": "Keep-Alive",
            "Accept-Encoding": "gzip"
        })
        try:
            self._emote_patterns = self._build_emote_patterns()
        except Exception:
            self._emote_patterns = []
        self._drawer_menu_id = None

    def _get_self_user_id(self):
        try:
            acc = UserConfig.selectedAccount
        except Exception:
            acc = 0
        try:
            cfg = UserConfig.getInstance(acc)
            uid = getattr(cfg, "clientUserId", None)
            if uid:
                return int(uid)
        except Exception:
            pass
        try:
            me = UserConfig.getInstance(acc).getCurrentUser()
            if me and hasattr(me, "id"):
                return int(me.id)
        except Exception:
            pass
        return None

    def _ensure_default_chat_rules(self, rules, raw_str: str = None):
        try:
            if rules is None or not isinstance(rules, list):
                return rules
        except Exception:
            return rules
        try:
            if rules:
                return rules
        except Exception:
            return rules
        try:
            if raw_str is not None and str(raw_str).strip() not in ("", "[]"):
                return rules
        except Exception:
            pass
        uid = self._get_self_user_id()
        if uid is None:
            return rules
        peer_id = str(int(uid))
        rules.append({
            "chat_ids": [peer_id],
            "chats_info": [{"id": peer_id, "title": "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ"}],
            "chat_title": "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
            "name": "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ",
            "category": "",
            "no_fix": True,
            "no_rewrite": True,
            "style_idx": 0,
            "caps_mode": 0,
            "format_mode": -1,
            "disable_premium": False,
            "disable_format": False,
            "collapsed": False
        })
        return rules
    
    def on_plugin_load(self):
        try:
            self.add_on_send_message_hook()
            try:
                self.add_app_event_hook()
            except Exception:
                pass
            self._update_drawer_menu_item()
        except Exception:
            pass

    def on_app_event(self, event_type: AppEvent):
        try:
            if event_type == AppEvent.STOP:
                try:
                    self._sent_messages.clear()
                except Exception:
                    pass
                try:
                    self._ai_inflight.clear()
                except Exception:
                    pass
        except Exception:
            pass

    def _update_drawer_menu_item(self):
        try:
            from base_plugin import MenuItemData, MenuItemType
            try:
                if self._drawer_menu_id is not None:
                    self.remove_menu_item(self._drawer_menu_id)
                    self._drawer_menu_id = None
            except Exception:
                self._drawer_menu_id = None

            show = self._get_bool_setting("show_drawer_menu", False)
            if not show:
                return

            self._drawer_menu_id = self.add_menu_item(MenuItemData(
                menu_type=MenuItemType.DRAWER_MENU,
                text="Phrase Plugin",
                icon="msg_edit",
                on_click=lambda ctx: self._open_settings_page()
            ))
            try:
                log("[PhrasePlugin] Drawer menu item added")
            except Exception:
                pass
        except Exception as e:
            try:
                log(f"[PhrasePlugin] Error updating drawer menu: {e}")
            except Exception:
                pass

    def _open_settings_page(self):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            from com.exteragram.messenger.plugins.ui import PluginSettingsActivity
            fragment = get_last_fragment()
            if not fragment:
                return
            java_plugin = PluginsController.getInstance().plugins.get(self.id)
            if java_plugin:
                run_on_ui_thread(lambda: fragment.presentFragment(PluginSettingsActivity(java_plugin)))
            else:
                try:
                    log("[PhrasePlugin] Could not open settings - plugin or fragment is None")
                except Exception:
                    pass
        except Exception as e:
            try:
                log(f"[PhrasePlugin] Error opening settings: {e}")
            except Exception:
                pass

    def _trigger_settings_reload(self):
        try:
            def do_reload():
                try:
                    current = self.get_setting("_ui_refresh", 0)
                    try:
                        current_val = int(current)
                    except Exception:
                        current_val = 0
                    self.set_setting("_ui_refresh", current_val + 1)
                    frag = get_last_fragment()
                    if not frag:
                        return
                    methods = [
                        "recreateSettings",
                        "reloadSettings",
                        "updateSettings",
                        "invalidate",
                        "rebuildAllItems",
                    ]
                    for name in methods:
                        if hasattr(frag, name):
                            try:
                                getattr(frag, name)()
                                return
                            except Exception:
                                pass

                    try:
                        if hasattr(frag, "listView"):
                            lv = getattr(frag, "listView")
                            if lv and hasattr(lv, "getAdapter"):
                                ad = lv.getAdapter()
                                if ad and hasattr(ad, "notifyDataSetChanged"):
                                    ad.notifyDataSetChanged()
                                    return
                    except Exception:
                        pass
                except Exception:
                    pass
            run_on_ui_thread(do_reload)
        except Exception:
            pass

    def _open_link(self, url: str):
        try:
            frag = get_last_fragment()
            if not frag:
                return
            ctx = frag.getParentActivity()
            if not ctx:
                return
            from android.content import Intent
            from android.net import Uri
            intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
            run_on_ui_thread(lambda: ctx.startActivity(intent))
        except Exception as e:
            try:
                log(f"[PhrasePlugin] open_link error: {e}")
            except Exception:
                pass

    def _get_current_account(self, fragment):
        try:
            return fragment.getCurrentAccount()
        except Exception:
            try:
                return fragment.currentAccount
            except Exception:
                return 0

    def _open_username(self, username: str):
        def go():
            try:
                frag = get_last_fragment()
                if not frag:
                    return
                try:
                    from client_utils import get_messages_controller
                    controller = get_messages_controller()
                except Exception:
                    controller = None
                account = self._get_current_account(frag)
                ok = False
                if controller is not None:
                    try:
                        ok = controller.openByUserName(username, frag, account)
                    except Exception as e:
                        try:
                            log(f"[PhrasePlugin] openByUserName error: {e}")
                        except Exception:
                            pass
                if not ok:
                    try:
                        ctx = frag.getParentActivity()
                        if ctx:
                            from android.content import Intent
                            from android.net import Uri
                            intent = Intent(Intent.ACTION_VIEW, Uri.parse(f"tg://resolve?domain={username}"))
                            ctx.startActivity(intent)
                            return
                    except Exception as e2:
                        try:
                            log(f"[PhrasePlugin] tg://resolve fallback error: {e2}")
                        except Exception:
                            pass
                    self._open_link(f"https://t.me/{username}")
            except Exception as e:
                try:
                    log(f"[PhrasePlugin] open_username error: {e}")
                except Exception:
                    pass
                try:
                    self._open_link(f"https://t.me/{username}")
                except Exception:
                    pass
        run_on_ui_thread(go)

    def _detect_language(self) -> str:
        try:
            pref = str(self.get_setting("ui_language", "")).strip().lower()
        except Exception:
            pref = ""
        if pref in ("ru", "en"):
            return pref
        try:
            if LOCALE_AVAILABLE:
                lang = Locale.getDefault().getLanguage().lower()
                if lang.startswith("ru"):
                    return "ru"
        except Exception:
            pass
        return "en"

    def _load_chat_rules(self):
        if self._chat_rules_cache is not None:
            return self._chat_rules_cache
        try:
            raw = self.get_setting("chat_rules", "[]")
        except Exception:
            raw = "[]"
        try:
            data = json.loads(raw)
            if isinstance(data, list):
                data = self._normalize_chat_rules(data)
                data = self._ensure_default_chat_rules(data, raw_str=raw)
                try:
                    self.set_setting("chat_rules", json.dumps(data, ensure_ascii=False))
                except Exception:
                    pass
                self._chat_rules_cache = data
                return data
        except Exception:
            pass
        self._chat_rules_cache = []
        return []

    def _save_chat_rules(self, rules):
        rules = self._normalize_chat_rules(rules)
        self._chat_rules_cache = rules
        try:
            self.set_setting("chat_rules", json.dumps(rules, ensure_ascii=False))
        except Exception:
            pass

    def _normalize_chat_rules(self, rules):
        try:
            if not isinstance(rules, list):
                return []
        except Exception:
            return []
        out = []
        for r in rules:
            try:
                if not isinstance(r, dict):
                    continue
                if "chat_ids" not in r or not isinstance(r.get("chat_ids"), list):
                    ids = []
                    try:
                        old_single = r.get("chat_id", "")
                        if old_single:
                            ids.append(str(old_single))
                    except Exception:
                        pass
                    r["chat_ids"] = ids
                try:
                    r["chat_ids"] = [str(x) for x in r.get("chat_ids", []) if str(x).strip()]
                except Exception:
                    r["chat_ids"] = []
                try:
                    seen = set()
                    dedup = []
                    for cid in r["chat_ids"]:
                        if cid not in seen:
                            seen.add(cid)
                            dedup.append(cid)
                    r["chat_ids"] = dedup
                except Exception:
                    pass

                if "style_idx" not in r:
                    try:
                        rs = r.get("rewrite_style", 0)
                        if isinstance(rs, str):
                            rs = int(str(rs).strip())
                        elif not isinstance(rs, int):
                            rs = int(rs)
                        if rs < 0:
                            rs = 0
                        r["style_idx"] = rs
                    except Exception:
                        r["style_idx"] = 0

                try:
                    if "rewrite_style" in r:
                        r.pop("rewrite_style", None)
                except Exception:
                    pass

                if "no_fix" not in r:
                    r["no_fix"] = False
                if "no_rewrite" not in r:
                    r["no_rewrite"] = False
                if "category" not in r:
                    r["category"] = ""
                if "caps_mode" not in r:
                    r["caps_mode"] = 0
                if "format_mode" not in r:
                    r["format_mode"] = -1
                if "disable_premium" not in r:
                    r["disable_premium"] = False
                if "disable_format" not in r:
                    r["disable_format"] = False
                if "collapsed" not in r:
                    r["collapsed"] = False

                out.append(r)
            except Exception:
                continue
        return out

    def _get_dialog_id_from_peer(self, peer: Any):
        if peer is None:
            return None
        try:
            try:
                if not hasattr(peer, "user_id") and not hasattr(peer, "chat_id") and not hasattr(peer, "channel_id"):
                    pv = int(peer)
                    if pv:
                        return pv
            except Exception:
                pass
            try:
                uid = getattr(peer, "user_id", 0) or 0
            except Exception:
                uid = 0
            try:
                cid = getattr(peer, "chat_id", 0) or 0
            except Exception:
                cid = 0
            try:
                chid = getattr(peer, "channel_id", 0) or 0
            except Exception:
                chid = 0

            try:
                uid_i = int(uid)
            except Exception:
                uid_i = 0
            try:
                cid_i = int(cid)
            except Exception:
                cid_i = 0
            try:
                chid_i = int(chid)
            except Exception:
                chid_i = 0

            if uid_i:
                return uid_i
            if cid_i:
                return -abs(cid_i)
            if chid_i:
                return -abs(chid_i)
        except Exception:
            pass
        return None

    def _get_peer_kind(self, peer: Any) -> str:
        if peer is None:
            return ""
        try:
            did = self._get_dialog_id_from_peer(peer)
            if did is None:
                return ""
            if did > 0:
                return "user"

            try:
                cid = getattr(peer, "chat_id", 0) or 0
            except Exception:
                cid = 0
            try:
                chid = getattr(peer, "channel_id", 0) or 0
            except Exception:
                chid = 0
            try:
                cid_i = int(cid)
            except Exception:
                cid_i = 0
            try:
                chid_i = int(chid)
            except Exception:
                chid_i = 0

            if cid_i:
                return "chat"
            if chid_i:
                return "channel"
        except Exception:
            pass
        return ""

    def _get_category_rule_for_params(self, params: Any):
        try:
            peer = getattr(params, "peer", None)
            if peer is None:
                return None
            rules = self._load_chat_rules()
            if not rules:
                return None

            cats_present = set()
            try:
                for rr in rules:
                    try:
                        c = str(rr.get("category", "")).strip()
                        if c:
                            cats_present.add(c)
                    except Exception:
                        continue
            except Exception:
                cats_present = set()

            try:
                from client_utils import get_messages_controller
                ctrl = get_messages_controller()
            except Exception:
                ctrl = None

            cat = None

            did = self._get_dialog_id_from_peer(peer)
            if did is None:
                return None
            try:
                did = int(did)
            except Exception:
                return None

            if did > 0:
                user = None
                try:
                    user = ctrl.getUser(abs(did)) if ctrl else None
                except Exception:
                    user = None
                if user:
                    try:
                        if bool(getattr(user, "bot", False)):
                            cat = "bots"
                        else:
                            is_contact = bool(getattr(user, "contact", False) or getattr(user, "mutual_contact", False))
                            if is_contact:
                                cat = "contacts"
                    except Exception:
                        pass
                else:
                    if "contacts" in cats_present:
                        cat = "contacts"
                    elif "bots" in cats_present:
                        cat = "bots"
            else:
                chat = None
                try:
                    chat = ctrl.getChat(abs(did)) if ctrl else None
                except Exception:
                    chat = None

                if chat:
                    try:
                        if bool(getattr(chat, "megagroup", False)):
                            cat = "groups"
                        elif bool(getattr(chat, "broadcast", False)):
                            cat = "channels"
                        else:
                            cat = "groups"
                    except Exception:
                        cat = "groups"
                else:
                    if "channels" in cats_present and "groups" in cats_present:
                        cat = "channels"
                    elif "channels" in cats_present:
                        cat = "channels"
                    elif "groups" in cats_present:
                        cat = "groups"

            if not cat:
                return None
            for r in rules:
                try:
                    if str(r.get("category", "")).strip() == cat:
                        return r
                except Exception:
                    continue
        except Exception:
            pass
        return None

    def _get_effective_rule_for_params(self, params: Any):
        try:
            r = self._get_chat_rule_for_params(params)
            if r is not None:
                return r
        except Exception:
            pass
        try:
            return self._get_category_rule_for_params(params)
        except Exception:
            return None

    def _get_peer_id(self, peer: Any) -> str:
        if peer is None:
            return ""
        try:
            did = self._get_dialog_id_from_peer(peer)
            if did is None:
                return ""
            return str(int(did))
        except Exception:
            return str(peer)

    def _get_display_name_for_dialog_id(self, dialog_id: Any, lang: str, ctrl=None) -> str:
        try:
            did = int(dialog_id)
        except Exception:
            return str(dialog_id)

        if ctrl is None:
            try:
                from client_utils import get_messages_controller
                ctrl = get_messages_controller()
            except Exception:
                ctrl = None

        try:
            chat_utils = ChatUtils.getInstance(UserConfig.selectedAccount)
        except Exception:
            chat_utils = None

        if did > 0:
            user = None
            try:
                user = ctrl.getUser(did) if ctrl else None
            except Exception:
                user = None
            if user:
                try:
                    uname = getattr(user, "username", None)
                    if uname:
                        u = str(uname).strip()
                        if u:
                            return ("@" + u.lstrip("@"))
                except Exception:
                    pass
            try:
                if chat_utils:
                    n = chat_utils.getName(did)
                    if n:
                        return str(n)
            except Exception:
                pass
            if user:
                try:
                    fn = getattr(user, "first_name", "") or ""
                    ln = getattr(user, "last_name", "") or ""
                    nm = (str(fn) + " " + str(ln)).strip()
                    if nm:
                        return nm
                except Exception:
                    pass
            return str(did)

        cid = abs(did)
        chat = None
        try:
            chat = ctrl.getChat(cid) if ctrl else None
        except Exception:
            chat = None
        if chat:
            try:
                uname = getattr(chat, "username", None)
                if uname:
                    u = str(uname).strip()
                    if u:
                        return ("@" + u.lstrip("@"))
            except Exception:
                pass
            try:
                title = getattr(chat, "title", None)
                if title:
                    return str(title)
            except Exception:
                pass

        try:
            if chat_utils:
                n = chat_utils.getName(did)
                if n:
                    return str(n)
        except Exception:
            pass
        return str(did)

    def _get_rule_display_name(self, rule: dict, lang: str) -> str:
        try:
            n = rule.get("name", None)
            if n is not None and str(n).strip():
                return str(n).strip()
        except Exception:
            pass

        try:
            if str(rule.get("category", "")).strip():
                return str(rule.get("chat_title") or rule.get("name") or "?")
        except Exception:
            pass

        ids = []
        try:
            cids = rule.get("chat_ids", [])
            if isinstance(cids, str):
                cids = [cids]
            if isinstance(cids, list):
                ids = [str(x) for x in cids if str(x).strip()]
        except Exception:
            ids = []
        if not ids:
            try:
                old_single = rule.get("chat_id", "")
                if old_single:
                    ids = [str(old_single)]
            except Exception:
                ids = []

        if not ids:
            return str(rule.get("chat_title") or "? ")

        ctrl = None
        try:
            from client_utils import get_messages_controller
            ctrl = get_messages_controller()
        except Exception:
            ctrl = None

        names = []
        for cid in ids:
            try:
                names.append(self._get_display_name_for_dialog_id(cid, lang, ctrl=ctrl))
            except Exception:
                names.append(str(cid))

        if len(names) == 1:
            return names[0]

        prefix = "–ì—Ä—É–ø–ø–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏–π" if lang == "ru" else "Exceptions group"
        shown = names[:4]
        tail = len(names) - len(shown)
        inner = ", ".join([str(x) for x in shown if str(x).strip()])
        if tail > 0:
            inner = (inner + (", " if inner else "") + f"+{tail}")
        return f"{prefix} ({inner})" if inner else prefix

    def _get_chat_rule_for_params(self, params: Any):
        try:
            peer = getattr(params, "peer", None)
            if peer is None:
                return None

            did = self._get_dialog_id_from_peer(peer)
            if did is None:
                return None

            peer_id_str = str(int(did))
            rules = self._load_chat_rules()

            for rule in rules:
                try:
                    r_ids = rule.get("chat_ids", [])
                    if isinstance(r_ids, list):
                        if any(str(x) == peer_id_str for x in r_ids):
                            return rule

                    r_id = rule.get("chat_id", None)
                    if r_id is not None and str(r_id) == peer_id_str:
                        return rule
                except Exception:
                    continue
        except Exception:
            pass
        return None

    def _add_chat_rule(self, lang: str):
        try:
            rules = self._load_chat_rules()
            title = "–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω" if lang == "ru" else "Chat not selected"
            rules.append({
                "chat_id": "",
                "chat_title": title,
                "no_fix": False,
                "no_rewrite": False,
                "style_idx": 0,
                "caps_mode": 0,
                "format_mode": -1,
                "disable_premium": False,
                "disable_format": False,
                "collapsed": False
            })
            self._save_chat_rules(rules)
            try:
                self._trigger_settings_reload()
            except Exception:
                pass
        except Exception:
            pass

    def _remove_chat_rule(self, idx: int):
        try:
            rules = self._load_chat_rules()
            if 0 <= idx < len(rules):
                rules.pop(idx)
                self._save_chat_rules(rules)
                try:
                    self._trigger_settings_reload()
                except Exception:
                    pass
        except Exception:
            pass

    def _update_chat_rule_field(self, idx: int, field: str, value: Any):
        try:
            rules = self._load_chat_rules()
            if not (0 <= idx < len(rules)):
                return
            rule = rules[idx]
            needs_ui_rebuild = False
            if field == "no_fix":
                rule["no_fix"] = bool(value)
                needs_ui_rebuild = True
            elif field == "no_rewrite":
                rule["no_rewrite"] = bool(value)
                needs_ui_rebuild = True
            elif field == "rewrite_style" or field == "style_idx":
                try:
                    v = int(value)
                    if v > 0:
                        rule["style_idx"] = v - 1
                    else:
                        rule["style_idx"] = 0
                except Exception:
                    rule["style_idx"] = 0
            elif field == "caps_mode":
                try:
                    rule["caps_mode"] = int(value)
                except Exception:
                    rule["caps_mode"] = 0
            elif field == "format_mode":
                try:
                    v = int(value)
                    if v > 0:
                        rule["format_mode"] = v - 1
                    else:
                        rule["format_mode"] = -1
                except Exception:
                    rule["format_mode"] = -1
            elif field == "disable_premium":
                rule["disable_premium"] = bool(value)
            elif field == "disable_format":
                rule["disable_format"] = bool(value)
            elif field == "collapsed":
                rule["collapsed"] = bool(value)
            self._save_chat_rules(rules)
            if needs_ui_rebuild:
                try:
                    self._trigger_settings_reload()
                except Exception:
                    pass
        except Exception:
            pass

    def _get_effective_format_mode(self, params: Any) -> int:
        try:
            try:
                fm = self.get_setting("formatting_mode", 2)
                if isinstance(fm, str):
                    fm = int(str(fm).strip())
                elif not isinstance(fm, int):
                    fm = int(fm)
            except Exception:
                fm = 2
            base_mode = fm
            rule = self._get_effective_rule_for_params(params)
            if rule is not None:
                try:
                    rm = rule.get("format_mode", -1)
                    if isinstance(rm, str):
                        rm = int(str(rm).strip())
                    elif not isinstance(rm, int):
                        rm = int(rm)
                except Exception:
                    rm = -1
                if rm in (0, 1, 2):
                    base_mode = rm
            return base_mode
        except Exception:
            return 2

    def _get_effective_process_with_entities(self, params: Any) -> bool:
        try:
            base = self._get_bool_setting("process_with_entities", False)
            rule = self._get_effective_rule_for_params(params)
            if rule is not None:
                disable_premium = rule.get("disable_premium", False)
                if disable_premium:
                    return False
                pe = rule.get("process_premium", None)
                if isinstance(pe, bool):
                    base = pe
            return base
        except Exception:
            return self._get_bool_setting("process_with_entities", False)

    def _open_chat_rule_dialog(self, idx: int, lang: str):
        try:
            if not CHAT_OPEN_AVAILABLE:
                return
        except Exception:
            return
        try:
            args = Bundle()
            args.putBoolean("onlySelect", True)
            args.putBoolean("checkCanWrite", True)
            args.putInt("dialogsType", 0)
            args.putBoolean("allowGlobalSearch", True)

            activity = DialogsActivity(args)

            DelegateBase = dynamic_proxy(DialogsActivity.DialogsActivityDelegate)

            plugin = self

            class ChatRuleDelegate(DelegateBase):
                def __init__(self, fn):
                    super().__init__()
                    self._fn = fn

                def didSelectDialogs(self, fragment, dids, message, param, notify, scheduleDate, topicsFragment):
                    try:
                        self._fn(fragment, dids, message, param, notify, scheduleDate, topicsFragment)
                    except Exception:
                        try:
                            from ui.bulletin import BulletinHelper
                            BulletinHelper.show_error("–û—à–∏–±–∫–∞ –≤—ã–±–æ—Ä–∞ —á–∞—Ç–∞" if lang == "ru" else "Chat selection error")
                        except Exception:
                            pass

            def _on_selected(fragment, dids, message, param, notify, scheduleDate, topicsFragment):
                try:
                    activity.finishFragment()
                except Exception:
                    pass
                try:
                    if dids is None or dids.isEmpty():
                        return
                except Exception:
                    return
                try:
                    selected_id = dids.get(0).dialogId
                except Exception:
                    return
                try:
                    peer_id = str(selected_id)
                    chat_utils = ChatUtils.getInstance(UserConfig.selectedAccount)
                    try:
                        chat_title = chat_utils.getName(selected_id)
                    except Exception:
                        chat_title = peer_id
                except Exception:
                    return
                try:
                    msg = ("–ß–∞—Ç –≤—ã–±—Ä–∞–Ω: " if lang == "ru" else "Chat selected: ") + str(chat_title)
                    plugin._show_bulletin(msg)
                except Exception:
                    pass
                
                try:
                    rules = plugin._load_chat_rules()
                    if idx >= 0 and idx < len(rules):
                        rule = rules[idx]
                        try:
                            if str(rule.get("category", "")).strip():
                                plugin._open_rule_editor(idx, lang)
                                return
                        except Exception:
                            pass
                        if "chat_ids" not in rule or not isinstance(rule["chat_ids"], list):
                            existing_id = rule.get("chat_id", "")
                            rule["chat_ids"] = []
                            if existing_id: rule["chat_ids"].append(existing_id)
                        
                        if peer_id not in rule["chat_ids"]:
                            rule["chat_ids"].append(peer_id)
                            
                            if "chats_info" not in rule: rule["chats_info"] = []
                            rule["chats_info"].append({"id": peer_id, "title": chat_title})
                        
                        if len(rule["chat_ids"]) == 1:
                            rule["chat_title"] = chat_title
                        
                        plugin._save_chat_rules(rules)
                        plugin._open_rule_editor(idx, lang)
                    else:
                        new_rule = {
                            "chat_ids": [peer_id],
                            "chats_info": [{"id": peer_id, "title": chat_title}],
                            "chat_title": chat_title,
                            "no_fix": False,
                            "no_rewrite": False,
                            "style_idx": 0,
                            "caps_mode": 0,
                            "format_mode": -1,
                            "disable_premium": False,
                            "disable_format": False,
                            "collapsed": False
                        }
                        rules.append(new_rule)
                        plugin._save_chat_rules(rules)
                        plugin._open_rule_editor(len(rules) - 1, lang)
                except Exception:
                    pass

            delegate = ChatRuleDelegate(_on_selected)
            activity.setDelegate(delegate)

            fragment = get_last_fragment()
            if fragment:
                fragment.presentFragment(activity)
        except Exception:
            pass

    def create_settings(self):
        from ui.settings import Header, Switch, Text, Divider, Input, Selector
        ai_enabled = self._get_bool_setting("ai_correction", False)
        lang = self._detect_language()

        def _set_lang_ru(_):
            try:
                self.set_setting("ui_language", "ru")
                ctx = ApplicationLoader.applicationContext
                intent = ctx.getPackageManager().getLaunchIntentForPackage(ctx.getPackageName())
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK)
                ctx.startActivity(intent)
                Process.killProcess(Process.myPid())
            except Exception:
                pass

        def _set_lang_en(_):
            try:
                self.set_setting("ui_language", "en")
                ctx = ApplicationLoader.applicationContext
                intent = ctx.getPackageManager().getLaunchIntentForPackage(ctx.getPackageName())
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK)
                ctx.startActivity(intent)
                Process.killProcess(Process.myPid())
            except Exception:
                pass

        def _build_message_settings():
            out = [
                Header(text="–ü—Ä–∞–≤–∏–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏–π" if lang == "ru" else "Message rules"),
                Switch(
                    key="capitalize_sentences",
                    text="–ó–∞–≥–ª–∞–≤–Ω–∞—è –±—É–∫–≤–∞" if lang == "ru" else "Capital letter",
                    default=True,
                    subtext="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å—Ç–∞–≤–∏—Ç –∑–∞–≥–ª–∞–≤–Ω—É—é –±—É–∫–≤—É –≤ –Ω–∞—á–∞–ª–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è" if lang == "ru" else "Automatically capitalizes the first letter of a sentence",
                    icon="msg_palette"
                ),
                Switch(
                    key="add_final_dot",
                    text="–¢–æ—á–∫–∞ –≤ –∫–æ–Ω—Ü–µ" if lang == "ru" else "Dot at the end",
                    default=True,
                    subtext="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç–æ—á–∫—É –≤ –∫–æ–Ω—Ü–µ —Å–æ–æ–±—â–µ–Ω–∏—è" if lang == "ru" else "Automatically adds a dot at the end of the message",
                    icon="msg_palette"
                ),
                Switch(
                    key="ascii_emotes_replace",
                    text="–ó–∞–º–µ–Ω–∞ ASCII-—Å–º–∞–π–ª–æ–≤ –Ω–∞ —ç–º–æ–¥–∑–∏" if lang == "ru" else "Replace ASCII emoticons with emoji",
                    default=False,
                    subtext=":) :( XD = üòÅ ‚òπÔ∏è üòÇ",
                    icon="msg_palette"
                ),
                Switch(
                    key="anticaps",
                    text="–ê–Ω—Ç–∏-–∫–∞–ø—Å" if lang == "ru" else "Anti caps",
                    default=False,
                    subtext="–ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –∫–∞–ø—Å –ø—Ä–∏ –∏–∑–±—ã—Ç–æ—á–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –∑–∞–≥–ª–∞–≤–Ω—ã—Ö" if lang == "ru" else "Normalizes CAPS when there are too many uppercase letters",
                    icon="msg_info",
                    on_change=lambda v: self._trigger_settings_reload()
                ),
            ]
            try:
                if self._get_bool_setting("anticaps", False):
                    out.append(Selector(
                        key="caps_threshold",
                        text="–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫–∞–ø—Å–∞" if lang == "ru" else "Caps sensitivity",
                        default=4,
                        items=["50%", "60%", "70%", "80%", "90%", "100%"],
                        icon="msg_timer"
                    ))
            except Exception:
                pass
            return out

        def _build_exceptions_settings():
            def _open_exception_words(_):
                try:
                    pass
                except Exception:
                    pass
                try:
                    frag = get_last_fragment()
                    if not frag:
                        return
                    act = frag.getParentActivity()
                    if not act:
                        return
                    bld = AlertDialogBuilder(act)
                    bld.set_title("–°–ª–æ–≤–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –ò–ò" if lang == "ru" else "AI exception words")

                    cont = FrameLayout(act)
                    cont.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(10), AndroidUtilities.dp(24), AndroidUtilities.dp(10))

                    inp = EditText(act)
                    try:
                        cur = str(self.get_setting("exception_words", "") or "")
                    except Exception:
                        cur = ""
                    inp.setText(cur)
                    inp.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                    inp.setHint("word1; word2; word3")
                    cont.addView(inp)

                    bld.set_view(cont)

                    def _save(d, w):
                        try:
                            val = str(inp.getText())
                        except Exception:
                            val = ""
                        try:
                            self.set_setting("exception_words", str(val))
                        except Exception:
                            pass
                        try:
                            d.dismiss()
                        except Exception:
                            pass
                    bld.set_positive_button("OK", _save)
                    bld.set_negative_button("–û—Ç–º–µ–Ω–∞" if lang == "ru" else "Cancel", None)
                    bld.show()
                except Exception:
                    pass

            title_exc = "–°–ª–æ–≤–∞ –∏—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è –ò–ò" if lang == "ru" else "AI exception words"
            exc_item = Text(
                text=title_exc,
                icon="msg_info",
                accent=True,
                on_click=_open_exception_words,
            )
            return [
                Header(text="–ò—Å–∫–ª—é—á–µ–Ω–∏—è" if lang == "ru" else "Exceptions"),
                Text(
                    text="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞–º–∏" if lang == "ru" else "Manage rules",
                    icon="msg_folders",
                    accent=True,
                    on_click=lambda v: self._open_rules_manager(lang)
                ),
                Divider(),
                exc_item,
            ]

        def _build_ai_settings():
            ai_enabled_local = self._get_bool_setting("ai_correction", False)
            out = [
                Header(text="–ò–ò" if lang == "ru" else "AI"),
                Switch(
                    key="ai_correction",
                    text="–í–∫–ª—é—á–∏—Ç—å –ò–ò" if lang == "ru" else "Enable AI",
                    default=False,
                    subtext="–ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç –æ—à–∏–±–∫–∏, –ø—É–Ω–∫—Ç—É–∞—Ü–∏—é –∏ —Å—Ç–∏–ª–∏." if lang == "ru" else "Fixes mistakes, punctuation and styles.",
                    icon="msg_photo_text_regular",
                    on_change=lambda v: self._trigger_settings_reload()
                ),
                Switch(
                    key="show_success_bulletin",
                    text="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–∏" if lang == "ru" else "Correction notification",
                    default=True,
                    subtext="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ \"–¢–µ–∫—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ò–ò\"" if lang == "ru" else "Show popup notification \"Text corrected by AI\"",
                    icon="msg_info"
                )
            ]

            if ai_enabled_local:
                ai_part = [
                    Divider(),
                    Switch(
                        key="yandex_rewrite_mode",
                        text="–ò–ò —É–ª—É—á—à–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞" if lang == "ru" else "AI rewriting",
                        default=False,
                        subtext="–ü–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç" if lang == "ru" else "Rewrite text",
                        icon="msg_photo_settings"
                    ),
                    Divider(),
                    Switch(
                        key="ai_punctuation",
                        text="–ó–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è" if lang == "ru" else "Punctuation",
                        default=True,
                        subtext="–ò—Å–ø—Ä–∞–≤–ª—è—Ç—å, –¥–æ–±–∞–≤–ª—è—Ç—å –∑–Ω–∞–∫–∏ –ø—Ä–µ–ø–∏–Ω–∞–Ω–∏—è" if lang == "ru" else "Fix and add punctuation marks",
                        icon="msg_photo_settings"
                    ),
                    Switch(
                        key="ai_spelling",
                        text="–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä—Ñ–æ–≥—Ä–∞—Ñ–∏–∏" if lang == "ru" else "Spelling correction",
                        default=True,
                        subtext="–ò—Å–ø—Ä–∞–≤–ª—è—Ç—å –æ—à–∏–±–∫–∏ –≤ —Å–ª–æ–≤–∞—Ö" if lang == "ru" else "Fix spelling mistakes in words",
                        icon="msg_photo_settings"
                    ),
                    Switch(
                        key="process_with_entities",
                        text="–û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–µ–º–∏—É–º —ç–º–æ–¥–∑–∏" if lang == "ru" else "Process premium emoji",
                        default=False,
                        subtext="–ï—Å–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω–æ, —Ç–æ –ø—Ä–∏ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–∏ –ø—Ä–µ–º–∏—É–º —ç–º–æ–¥–∑–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ò–ò –Ω–µ –±—É–¥–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ç–æ —ç–º–æ–¥–∑–∏ –∑–∞–º–µ–Ω—è—Ç—Å—è –Ω–∞ –æ–±—ã—á–Ω—ã–µ." if lang == "ru" else "If disabled, AI will not process text that contains premium emoji. If enabled, emoji will be replaced with regular ones.",
                        icon="msg_sticker",
                        on_change=lambda v: self._trigger_settings_reload()
                    )
                ]
                if self._get_bool_setting("process_with_entities", False):
                    ai_part.append(
                        Switch(
                            key="premium_manual_mode",
                            text="–†—É—á–Ω–æ–π —Ä–µ–∂–∏–º –ø—Ä–µ–º–∏—É–º —ç–º–æ–¥–∑–∏" if lang == "ru" else "Premium emoji manual mode",
                            default=False,
                            subtext="–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ, —Ç–µ–∫—Å—Ç –≤—Å—Ç–∞–≤–∏—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É –≤–≤–æ–¥–∞ –¥–ª—è —Ä—É—á–Ω–æ–π –ø—Ä–∞–≤–∫–∏ —ç–º–æ–¥–∑–∏." if lang == "ru" else "If enabled, text will be inserted into input for manual emoji editing.",
                            icon="msg_sticker"
                        )
                    )
                out.extend(ai_part)

            return out

        def _build_ui_settings():
            return [
                Header(text="–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å" if lang == "ru" else "Interface"),
                Text(text="Russian", icon="msg_translate", accent=True, on_click=_set_lang_ru),
                Text(text="English", icon="msg_translate", accent=True, on_click=_set_lang_en),
                Divider(),
                Switch(
                    key="show_drawer_menu",
                    text="–ö–Ω–æ–ø–∫–∞ –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é" if lang == "ru" else "Show in drawer menu",
                    default=False,
                    subtext="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –≤ –±–æ–∫–æ–≤–æ–º –º–µ–Ω—é" if lang == "ru" else "Show quick access to settings in side menu",
                    icon="msg_addbot",
                    on_change=lambda v: self._update_drawer_menu_item()
                )
            ]

        settings = [
            Header(text="Phrase"),
            Text(
                text="–ü—Ä–∞–≤–∏–ª–∞ —Å–æ–æ–±—â–µ–Ω–∏–π" if lang == "ru" else "Message rules",
                icon="msg_palette",
                accent=True,
                create_sub_fragment=lambda: _build_message_settings()
            ),
            Text(
                text="–ò—Å–∫–ª—é—á–µ–Ω–∏—è" if lang == "ru" else "Exceptions",
                icon="msg_folders",
                accent=True,
                create_sub_fragment=lambda: _build_exceptions_settings()
            ),
            Text(
                text="–ò–ò" if lang == "ru" else "AI",
                icon="msg_photo_text_regular",
                accent=True,
                create_sub_fragment=lambda: _build_ai_settings()
            ),
            Text(
                text="–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å" if lang == "ru" else "Interface",
                icon="msg_translate",
                accent=True,
                create_sub_fragment=lambda: _build_ui_settings()
            ),
        ]

        def open_channel(_):
            try:
                self._open_username("buligaEplugins")
            except Exception as e:
                try:
                    log(f"[PhrasePlugin] Error opening channel: {e}")
                except Exception:
                    pass
        
        def open_developer(_):
            try:
                self._open_username("inclu_01")
            except Exception as e:
                try:
                    log(f"[PhrasePlugin] Error opening developer: {e}")
                except Exception:
                    pass

        settings.append(
            Text(
                text="–û –ø–ª–∞–≥–∏–Ω–µ" if lang == "ru" else "About",
                icon="msg_info",
                accent=True,
                create_sub_fragment=lambda: [
                    Header(text="–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∏" if lang == "ru" else "Developers"),
                    Text(
                        text="–ö–∞–Ω–∞–ª —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤" if lang == "ru" else "Developers channel",
                        icon="msg_online",
                        accent=True,
                        on_click=open_channel
                    ),
                    Text(
                        text="–†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫ –ø–ª–∞–≥–∏–Ω–∞" if lang == "ru" else "Plugin developer",
                        icon="msg_info",
                        accent=True,
                        on_click=open_developer
                    )
                ]
            )
        )

        return settings

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        try:
            try:
                if self._has_media(params):
                    return HookResult()
            except Exception:
                pass

            try:
                cap = getattr(params, "caption", None)
                if cap is not None and str(cap).strip():
                    return HookResult()
            except Exception:
                pass

            if not hasattr(params, "message"):
                return HookResult()
            
            rule = None
            try:
                peer = getattr(params, "peer", None)
                if peer is not None:
                    rule = self._get_effective_rule_for_params(params)
            except Exception:
                pass

            try:
                if rule is not None:
                    if bool(rule.get("no_fix", False)) and bool(rule.get("no_rewrite", False)) and int(rule.get("caps_mode", 0) or 0) == 0:
                        return HookResult()
            except Exception:
                pass
            
            try:
                raw_msg = getattr(params, "message", "")
                if raw_msg is None:
                    original = ""
                elif isinstance(raw_msg, str):
                    original = raw_msg
                else:
                    original = str(raw_msg)
            except Exception:
                return HookResult()
            
            msg_hash = hash(original)
            if msg_hash in self._sent_messages:
                try:
                    self._sent_messages.discard(msg_hash)
                except Exception:
                    pass
                return HookResult()

            stripped = original.lstrip()

            try:
                if re.fullmatch(r"[\.!\?‚Ä¶]+", stripped):
                    return HookResult()
                link_only_pattern = r"(?i)(https?://\S+|www\.\S+|t\.me/\S+|telegram\.(?:me|dog)/\S+|[A-Za-z0-9.-]+\.[A-Za-z]{2,}\S*)"
                if re.fullmatch(link_only_pattern, stripped.strip()):
                    return HookResult()
            except Exception:
                pass
            
            if stripped and stripped[0] in "/!.\\":
                return HookResult()

            do_capitalize = self._get_bool_setting("capitalize_sentences", True)
            do_final_dot = self._get_bool_setting("add_final_dot", True)
            ai_enabled = self._get_bool_setting("ai_correction", False)
            ascii_replace_enabled = self._get_bool_setting("ascii_emotes_replace", False)
            anticaps_enabled = self._get_bool_setting("anticaps", False)
            caps_threshold = self._get_caps_threshold()
            exception_words = self._parse_exceptions_list("exception_words")

            chat_rule = self._get_effective_rule_for_params(params)
            no_fix = False
            if chat_rule is not None:
                try:
                    cm = chat_rule.get("caps_mode", 0)
                    if isinstance(cm, str):
                        cm = int(str(cm).strip())
                    elif not isinstance(cm, int):
                        cm = int(cm)
                except Exception:
                    cm = 0

                if cm == 1:
                    do_capitalize = True
                    do_final_dot = False
                elif cm == 2:
                    do_capitalize = False
                    do_final_dot = True
                elif cm == 3:
                    do_capitalize = True
                    do_final_dot = True
                elif cm == 4:
                    do_capitalize = False
                    do_final_dot = False

                no_fix = bool(chat_rule.get("no_fix", False))

            format_mode = self._get_effective_format_mode(params)
            has_formatting = self._has_formatting(original)
            has_formatting_entities = False
            try:
                if hasattr(params, "entities") and params.entities:
                    size = params.entities.size()
                    for i in range(size):
                        ent = params.entities.get(i)
                        try:
                            et = str(ent.getClass().getSimpleName())
                        except Exception:
                            continue
                        if "CustomEmoji" in et or "AnimatedEmoji" in et:
                            continue
                        if ("Bold" in et or "Italic" in et or "Code" in et or "Pre" in et or
                            "Underline" in et or "Strike" in et or "Spoiler" in et or
                            "Quote" in et or "Blockquote" in et or "Url" in et or "TextUrl" in et):
                            has_formatting_entities = True
                            break
            except Exception:
                has_formatting_entities = False
            if has_formatting_entities:
                has_formatting = True
            
            if chat_rule is not None:
                try:
                    disable_format = bool(chat_rule.get("disable_format", False))
                    if disable_format:
                        has_formatting = False
                except Exception:
                    pass
            
            process_with_entities = self._get_effective_process_with_entities(params)
            premium_manual_mode = self._get_bool_setting("premium_manual_mode", False)

            if no_fix:
                ai_enabled = False

            if not do_capitalize and not do_final_dot and not ai_enabled and not ascii_replace_enabled and not anticaps_enabled:
                return HookResult()

            has_media = self._has_media(params)
            if has_media:
                return HookResult()
            
            has_premium_entities = False
            try:
                if hasattr(params, "entities") and params.entities:
                    try:
                        entities_size = params.entities.size()
                        for i in range(entities_size):
                            entity = params.entities.get(i)
                            try:
                                entity_type = str(entity.getClass().getSimpleName())
                                if "CustomEmoji" in entity_type or "AnimatedEmoji" in entity_type:
                                    has_premium_entities = True
                                    break
                            except Exception:
                                pass
                    except Exception:
                        pass
            except Exception:
                pass
            
            if has_premium_entities and not process_with_entities:
                return HookResult()

            if has_formatting and format_mode == 2 and not (has_premium_entities and process_with_entities and premium_manual_mode):
                return HookResult()
            
            if ai_enabled:
                try:
                    peer_chk = getattr(params, "peer", None)
                except Exception:
                    peer_chk = None
                try:
                    inflight_chk = self._get_peer_id(peer_chk) if peer_chk else None
                except Exception:
                    inflight_chk = None
                if inflight_chk:
                    try:
                        if inflight_chk in self._ai_inflight:
                            return HookResult()
                    except Exception:
                        pass
                pre_text = original
                
                if anticaps_enabled and self._should_normalize_caps(pre_text, caps_threshold):
                    pre_text = self._normalize_caps(pre_text, exception_words)
                
                style_idx = None
                if ai_enabled:
                    style_idx = self.get_setting("default_style", 0)
                    if not isinstance(style_idx, int):
                        style_idx = 0

                self._process_fix_async(pre_text, params, style_idx=style_idx)
                return HookResult(strategy=HookStrategy.CANCEL)

            msg = original
            
            masked_msg, mask_map = self._mask_ai_exceptions(msg, exception_words)
            msg = masked_msg

            if ascii_replace_enabled:
                msg = self._replace_ascii_emoticons(msg)
            if anticaps_enabled and self._should_normalize_caps(msg, caps_threshold):
                msg = self._normalize_caps(msg, exception_words)

            if do_capitalize:
                parts = _SENTENCE_SPLIT_RE.split(msg)
                new_parts = []
                for p in parts:
                    p_stripped = p.lstrip()
                    if not p_stripped:
                        new_parts.append(p)
                        continue
                    leading_ws_len = len(p) - len(p.lstrip())
                    leading = p[:leading_ws_len]
                    content = p[leading_ws_len:]
                    content = _capitalize_first_alpha(content)
                    new_parts.append(leading + content)
                msg = " ".join([part.strip() for part in new_parts]).strip()

            msg = self._normalize_ru_punctuation(msg)

            if do_final_dot:
                if msg and msg[-1] not in ".!?":
                    msg = msg + "."
            
            msg = self._unmask_ai_exceptions(msg, mask_map)

            if has_premium_entities and process_with_entities and premium_manual_mode:
                ok = False
                try:
                    self._set_input_text(msg)
                    ok = True
                except Exception:
                    ok = False
                if self._get_bool_setting("show_success_bulletin", True):
                    self._show_bulletin_delayed("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–µ–º–∏—É–º-—ç–º–æ–¥–∑–∏. –í—Å—Ç–∞–≤–ª—è—é –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
                if ok:
                    return HookResult(strategy=HookStrategy.CANCEL)

            if has_formatting and format_mode == 1:
                self._set_input_text(msg)
                if self._get_bool_setting("show_success_bulletin", True):
                    self._show_bulletin_delayed("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –í—Å—Ç–∞–≤–ª—è—é –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
                return HookResult(strategy=HookStrategy.CANCEL)

            if has_formatting and format_mode == 0:
                if self._get_bool_setting("show_success_bulletin", True):
                    self._show_bulletin_delayed("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –û—Ç–ø—Ä–∞–≤–ª—é —Å —Å–∏–º–≤–æ–ª–∞–º–∏.")

            if msg != original:
                params.message = msg
                return HookResult(strategy=HookStrategy.MODIFY, params=params)
            return HookResult()

        except Exception as e:
            try:
                log(f"[PhrasePlugin] error: {e}")
            except Exception:
                pass
            return HookResult()

    def _show_bulletin(self, message: str):
        try:
            if not self._get_bool_setting("show_success_bulletin", True):
                return
        except Exception:
            pass
        def _do_show():
            try:
                from ui.bulletin import BulletinHelper
                try:
                    BulletinHelper.show_success(message)
                except Exception:
                    try:
                        BulletinHelper.show_info(message)
                    except Exception:
                        pass
            except Exception as e:
                try:
                    log(f"[PhrasePlugin] Failed to show bulletin: {e}")
                except Exception:
                    pass
        try:
            run_on_ui_thread(_do_show)
        except Exception:
            _do_show()

    def _show_bulletin_delayed(self, message: str, delay_sec: float = 0.25):
        try:
            if not self._get_bool_setting("show_success_bulletin", True):
                return
        except Exception:
            pass
        def _job():
            try:
                import time
                time.sleep(delay_sec)
            except Exception:
                pass
            try:
                run_on_ui_thread(lambda: self._show_bulletin(message))
            except Exception:
                try:
                    self._show_bulletin(message)
                except Exception:
                    pass
        try:
            run_on_queue(_job)
        except Exception:
            _job()

    def _show_formatting_legend(self):
        try:
            try:
                frag = get_last_fragment()
            except Exception:
                frag = None
            act = None
            if frag is not None:
                try:
                    act = frag.getParentActivity()
                except Exception:
                    act = None
            if act is None:
                act = ApplicationLoader.applicationContext
            bld = AlertDialogBuilder(act)
            bld.set_title("–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞")
            bld.set_message(_FORMATTING_LEGEND)
            bld.set_positive_button("–û–ö", lambda d, w: d.dismiss())
            bld.show()
        except Exception as e:
            try:
                log(f"[PhrasePlugin] formatting legend error: {e}")
            except Exception:
                pass

    def _set_input_text(self, text: str):
        try:
            frag = get_last_fragment()
            if not frag:
                return
            enter_getter = getattr(frag, "getChatActivityEnterView", None)
            if enter_getter is None:
                return
            enter = enter_getter()
            if enter is None:
                return
            enter.setFieldText(text)
        except Exception as e:
            try:
                log(f"[PhrasePlugin] set_input_text error: {e}")
            except Exception:
                pass
    
    def _has_media(self, params) -> bool:
        try:
            if hasattr(params, "media") and params.media is not None:
                return True
            if hasattr(params, "mediaPath") and params.mediaPath:
                return True
            if hasattr(params, "document") and params.document is not None:
                return True
            if hasattr(params, "photo") and params.photo is not None:
                return True
            if hasattr(params, "videoEditedInfo") and params.videoEditedInfo is not None:
                return True
            if hasattr(params, "location") and params.location is not None:
                return True
            if hasattr(params, "poll") and params.poll is not None:
                return True
            if hasattr(params, "invoice") and params.invoice is not None:
                return True
            if hasattr(params, "game") and params.game is not None:
                return True
            if hasattr(params, "video") and params.video is not None:
                return True
            if hasattr(params, "audio") and params.audio is not None:
                return True
            if hasattr(params, "voice") and params.voice is not None:
                return True
            if hasattr(params, "videoNote") and params.videoNote is not None:
                return True
            if hasattr(params, "sticker") and params.sticker is not None:
                return True
            if hasattr(params, "animation") and params.animation is not None:
                return True
        except Exception:
            pass
        return False
    
    
    def _uppercase_ratio(self, text: str) -> float:
        text_wo_urls = re.sub(r"https?://\S+", " ", text)
        letters = [c for c in text_wo_urls if c.isalpha()]
        if not letters:
            return 0.0
        uppers = [c for c in letters if c.isupper()]
        return len(uppers) / len(letters)

    def _normalize_caps(self, text: str, exceptions=None) -> str:
        def is_url(tok: str) -> bool:
            return re.match(r"https?://\S+", tok) is not None

        exc_lower = set()
        if exceptions:
            try:
                for e in exceptions:
                    se = str(e).strip()
                    if se:
                        exc_lower.add(se.lower())
            except Exception:
                exc_lower = set()

        tokens = re.split(r"(\s+)", text)
        out = []
        for tok in tokens:
            if tok.strip() == "":
                out.append(tok)
                continue
            if is_url(tok):
                out.append(tok)
                continue
            if exc_lower:
                try:
                    core = tok.strip()
                    core = re.sub(r"^\W+|\W+$", "", core)
                    if core and core.lower() in exc_lower:
                        out.append(tok)
                        continue
                except Exception:
                    pass
            letters = [c for c in tok if c.isalpha()]
            if len(letters) >= 2 and sum(1 for c in letters if c.isupper()) / len(letters) >= 0.6:
                out.append(tok.lower())
            else:
                out.append(tok)
        s = "".join(out)
        parts = _SENTENCE_SPLIT_RE.split(s)
        new_parts = []
        for p in parts:
            p_stripped = p.lstrip()
            if not p_stripped:
                new_parts.append(p)
                continue
            leading_ws_len = len(p) - len(p.lstrip())
            leading = p[:leading_ws_len]
            content = p[leading_ws_len:]
            content = _capitalize_first_alpha(content)
            new_parts.append(leading + content)
        return " ".join([part.strip() for part in new_parts]).strip()

    def _get_caps_threshold(self) -> int:
        index = self.get_setting("caps_threshold", 4)
        thresholds = [50, 60, 70, 80, 90, 100]
        try:
            if isinstance(index, int) and 0 <= index < len(thresholds):
                return thresholds[index]
            s = str(index).strip().rstrip('%')
            n = int(s)
            return max(50, min(100, n))
        except Exception:
            return 80


    def _parse_exceptions_list(self, key: str):
        try:
            raw = str(self.get_setting(key, "")).strip()
        except Exception:
            return []
        if not raw:
            return []
        try:
            raw = raw.replace("\n", ";")
        except Exception:
            pass
        parts = raw.split(";")
        out = []
        for p in parts:
            s = p.strip()
            if s:
                out.append(s)
        return out

    def _mask_ai_exceptions(self, text: str, exceptions) -> tuple:
        try:
            exc_list = list(exceptions) if exceptions else []
        except Exception:
            exc_list = []
        if not text:
            return text, {}
        masked = text
        mapping = {}
        idx = 0
        
        def get_ph(i):
             return f"[[PLACEHOLDER_{i}]]"

        linebreak_pattern = re.compile(r'(\n+)')
        for lb_match in linebreak_pattern.finditer(text):
            lb = lb_match.group(0)
            placeholder = get_ph(idx)
            idx += 1
            mapping[placeholder] = lb
            masked = masked.replace(lb, placeholder, 1)
        
        url_pattern = re.compile(r'https?://[^\s<>\"]+[^\s<>\".,;:!?]', re.IGNORECASE)
        for url_match in url_pattern.finditer(masked):
            url = url_match.group(0)
            placeholder = get_ph(idx)
            idx += 1
            mapping[placeholder] = url
            masked = masked.replace(url, placeholder, 1)

        bare_tme_pattern = re.compile(r'(?:(?<=\s)|^)(?:t\.me|telegram\.me|telegram\.dog)/[^\s<>"\)\]]+', re.IGNORECASE)
        for m in bare_tme_pattern.finditer(masked):
            link = m.group(0)
            placeholder = get_ph(idx)
            idx += 1
            mapping[placeholder] = link
            masked = masked.replace(link, placeholder, 1)

        generic_domain_pattern = re.compile(r'(?:(?<=\s)|^)(?:[A-Za-z0-9-]+\.)+[A-Za-z]{2,}(?:/[^\s<>"]*)?', re.IGNORECASE)
        for m in generic_domain_pattern.finditer(masked):
            dom = m.group(0)
            placeholder = get_ph(idx)
            idx += 1
            mapping[placeholder] = dom
            masked = masked.replace(dom, placeholder, 1)

        email_pattern = re.compile(r'(?:(?<=\s)|^)[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}(?=\s|$|[)\]\}]|[,.;:!?])')
        for m in email_pattern.finditer(masked):
            addr = m.group(0)
            placeholder = get_ph(idx)
            idx += 1
            mapping[placeholder] = addr
            masked = masked.replace(addr, placeholder, 1)
        
        phone_pattern = re.compile(r'(?:(?<=\s)|^)(?:\+?\d[\d\-\s\(\)]{5,}\d)')
        for m in phone_pattern.finditer(masked):
            num = m.group(0)
            placeholder = get_ph(idx)
            idx += 1
            mapping[placeholder] = num
            masked = masked.replace(num, placeholder, 1)

        quote_pairs = [("¬´", "¬ª"), ("‚Äú", "‚Äù"), ("‚Äû", "‚Äú")]
        for oq, cq in quote_pairs:
            try:
                pat = re.compile(re.escape(oq) + r"[\s\S]{1,4000}?" + re.escape(cq))
                while True:
                    m = pat.search(masked)
                    if not m:
                        break
                    seg = m.group(0)
                    placeholder = get_ph(idx)
                    idx += 1
                    mapping[placeholder] = seg
                    masked = masked[:m.start()] + placeholder + masked[m.end():]
            except Exception:
                pass
        try:
            pat = re.compile(r'"[\s\S]{1,4000}?"')
            while True:
                m = pat.search(masked)
                if not m:
                    break
                seg = m.group(0)
                placeholder = get_ph(idx)
                idx += 1
                mapping[placeholder] = seg
                masked = masked[:m.start()] + placeholder + masked[m.end():]
        except Exception:
            pass

        try:
            max_repl = 300
            repl_count = 0
            for exc in exc_list:
                try:
                    ex = str(exc).strip()
                except Exception:
                    ex = ""
                if not ex:
                    continue
                if len(ex) > 200:
                    continue
                try:
                    if re.fullmatch(r"[0-9A-Za-z–ê-–Ø–∞-—è–Å—ë_]+", ex):
                        rex = re.compile(r"(?i)(?<![\\w])" + re.escape(ex) + r"(?![\\w])")
                    else:
                        rex = re.compile(re.escape(ex), re.IGNORECASE)
                    while repl_count < max_repl:
                        m = rex.search(masked)
                        if not m:
                            break
                        seg = m.group(0)
                        placeholder = get_ph(idx)
                        idx += 1
                        mapping[placeholder] = seg
                        masked = masked[:m.start()] + placeholder + masked[m.end():]
                        repl_count += 1
                except Exception:
                    continue
        except Exception:
            pass
        
        return masked, mapping

    def _unmask_ai_exceptions(self, text: str, mapping) -> str:
        if not mapping or not text:
            return text
        res = text
        try:
            items = list(mapping.items())
        except Exception:
            items = []
        items_sorted = sorted(items, key=lambda x: len(str(x[0])), reverse=True)
        for placeholder, src in items_sorted:
            try:
                placeholder_str = str(placeholder)
                src_str = str(src)

                if "PLACEHOLDER_" in placeholder_str:
                     pid = placeholder_str.split("PLACEHOLDER_")[1].replace("]]", "")
                     p_flex = r"\[\[\s*PLACEHOLDER\s*_\s*" + re.escape(pid) + r"\s*\]\]"
                     res = re.sub(p_flex, lambda m: src_str, res, flags=re.IGNORECASE)
                     p_flex_single = r"\[\s*PLACEHOLDER\s*_\s*" + re.escape(pid) + r"\s*\]"
                     res = re.sub(p_flex_single, lambda m: src_str, res, flags=re.IGNORECASE)
                else:
                    res = res.replace(placeholder_str, src_str)
            except Exception:
                continue
        try:
            res = re.sub(r"\[\s*PROPER\s+NAME\s+\d+\s*\]", "", res)
        except Exception:
            pass
        return res

    def _should_normalize_caps(self, text: str, threshold_percent: int) -> bool:
        if threshold_percent == 0:
            return False
        ratio = self._uppercase_ratio(text)
        if ratio >= (threshold_percent / 100.0):
            return True
        if threshold_percent >= 100 and re.search(r"[A-Z–ê-–Ø–Å]{6,}", text):
            return True
        return False

    def _looks_cyrillic(self, s: str) -> bool:
        try:
            return re.search(r"[–ê-–Ø–∞-—è–Å—ë]", s or "") is not None
        except Exception:
            return False

    def _looks_english(self, s: str) -> bool:
        try:
            if not s:
                return False
            latin_count = len(re.findall(r"[a-zA-Z]", s))
            total_alpha = len(re.findall(r"[a-zA-Z–ê-–Ø–∞-—è–Å—ë\u4e00-\u9fff]", s))
            if total_alpha == 0:
                return False
            return (latin_count / total_alpha) > 0.7
        except Exception:
            return False
    def _has_formatting(self, text: str) -> bool:
        if not text:
            return False
        try:
            parsed = parse_markdown(str(text))
            ents = getattr(parsed, "entities", None)
            if ents:
                return True
        except SyntaxError:
            pass
        except Exception:
            pass
        for token in ("**", "__", "*", "_", "~", "`", "|", ">"):
            if token in text:
                return True
        return False

    def _preserve_sentence_start_case(self, original: str, fixed: str) -> str:
        try:
            orig_parts = _SENTENCE_SPLIT_RE.split(original)
            fix_parts = _SENTENCE_SPLIT_RE.split(fixed)
            out = []
            for i, fp in enumerate(fix_parts):
                op = orig_parts[i] if i < len(orig_parts) else ""
                def first_alpha_idx(s: str) -> int:
                    for idx, ch in enumerate(s):
                        if ch.isalpha():
                            return idx
                    return -1
                fi = first_alpha_idx(fp)
                oi = first_alpha_idx(op)
                if fi >= 0 and oi >= 0:
                    if op[oi].islower():
                        fp = fp[:fi] + fp[fi].lower() + fp[fi+1:]
                    elif op[oi].isupper():
                        fp = fp[:fi] + fp[fi].upper() + fp[fi+1:]
                out.append(fp)
            return " ".join([p.strip() for p in out]).strip()
        except Exception:
            return fixed

    def _get_bool_setting(self, key: str, default: bool) -> bool:
        try:
            val = self.get_setting(key, default)
            if isinstance(val, bool):
                return val
            if isinstance(val, (int, float)):
                return bool(val)
            if isinstance(val, str):
                s = val.strip().lower()
                if s in ("1", "true", "on", "yes", "y"):
                    return True
                if s in ("0", "false", "off", "no", "n"):
                    return False
                return default
            return default
        except Exception:
            return default

    def _replace_ascii_emoticons(self, text: str) -> str:
        s = text
        for pat, replacement in self._emote_patterns:
            s = pat.sub(replacement, s)
        return s

    def _normalize_ru_punctuation(self, text: str) -> str:
        s = text
        s = re.sub(r"[ \t]+([,.;:!?])", r"\1", s)
        def _space_after_punct(m):
            p = m.group(1)
            nxt = m.group(2)
            prev_char = m.string[m.start(1)-1] if m.start(1) > 0 else ''
            if p in ".," and prev_char.isalnum() and nxt.isalnum():
                return p + nxt
            if nxt in ",.;:!?":
                return p + nxt
            return p + " " + nxt
        s = re.sub(r"([,.;:!?])(?!\s)([^\s\)\]\}¬ª‚Ä¶\n])", _space_after_punct, s)
        s = re.sub(r"[ \t]{2,}", " ", s)
        s = re.sub(r"\([ \t]+", "(", s)
        s = re.sub(r"[ \t]+\)", ")", s)
        s = re.sub(r"[ \t]+([¬ª])", r"\1", s)
        s = re.sub(r"([¬´])[ \t]+", r"\1", s)
        s = s.strip()
        return s

    def _build_emote_patterns(self):
        try:
            patterns = [
                (re.compile(r'(^|\s)(?:xD|XD|x-?D|X-?D)(?=\s|$|[.,!?:;])', re.IGNORECASE), r'\1üòÇ'),
                (re.compile(r'(^|\s)(?::D|\:-D|=D)(?=\s|$|[.,!?:;])'), r'\1üòÑ'),
                (re.compile(r'(^|\s)(?::\)+|=\)+)(?=\s|$|[.,!?:;])'), r'\1üòÇ'),
                (re.compile(r'(^|\s)(?:\:-?\)|=\)|:\]|=\]|:\>)(?=\s|$|[.,!?:;])'), r'\1üôÇ'),
                (re.compile(r'(^|\s)(?:\^_\^|\^\^|:3)(?=\s|$|[.,!?:;])'), r'\1üòä'),
                (re.compile(r'(^|\s)(?:;\-?\)|;\])(?=\s|$|[.,!?:;])'), r'\1üòâ'),
                (re.compile(r'(^|\s)(?:\:-?[Pp]|=P|=p|:b)(?=\s|$|[.,!?:;])'), r'\1üòõ'),
                (re.compile(r'(^|\s)(?:\:-?\(|=\(|:\[|:\<)(?=\s|$|[.,!?:;])'), r'\1üôÅ'),
                (re.compile(r"(^|\s)(?:\:'\(|T_T|;_;|Q_Q)(?=\s|$|[.,!?:;])"), r'\1üò¢'),
                (re.compile(r'(^|\s)(?:\:-?[Oo]|=O|=o)(?=\s|$|[.,!?:;])'), r'\1üòÆ'),
                (re.compile(r'(^|\s)(?:D:)(?=\s|$|[.,!?:;])'), r'\1üòß'),
                (re.compile(r'(^|\s)(?:o_O|O_o|O_O|o_o)(?=\s|$|[.,!?:;])'), r'\1üò≥'),
                (re.compile(r'(^|\s)(?:\:-?/|:\\|:/)(?=\s|$|[.,!?:;])'), r'\1üòï'),
                (re.compile(r'(^|\s)(?:\:-?\|)(?=\s|$|[.,!?:;])'), r'\1üòê'),
                (re.compile(r'(^|\s)(?:\:-?\*)(?=\s|$|[.,!?:;])'), r'\1üòò'),
                (re.compile(r'(^|\s)(?:>:\(|>:-\(|>=\()(?=\s|$|[.,!?:;])'), r'\1üò†'),
                (re.compile(r'(^|\s)(?:B-?\)|8-?\))(?=\s|$|[.,!?:;])'), r'\1üòé'),
                (re.compile(r'(^|\s)(?:\:-?[Xx]|\:-?\$)(?=\s|$|[.,!?:;])'), r'\1ü§ê'),
                (re.compile(r'(^|\s)(?:<3)(?=\s|$|[.,!?:;])'), r'\1‚ù§Ô∏è'),
                (re.compile(r'(^|\s)(?:</3)(?=\s|$|[.,!?:;])'), r'\1üíî'),
            ]
            return patterns
        except Exception:
            return []


    def _detect_profanity(self, text: str) -> bool:
        profanity_patterns = [
            r'\b–ø–∏–∑–¥',
            r'\b—Ö—É[–π—è–µ—ë]',
            r'\b–µ–±–∞?–ª',
            r'\b–µ–±[–∞—É—ë]',
            r'\b–±–ª—è',
            r'\b—Å—É–∫–∞\b',
            r'\b–¥–µ—Ä—å–º',
            r'\b–≥–æ–≤–Ω',
        ]
        for pattern in profanity_patterns:
            if re.search(pattern, text, re.IGNORECASE):
                return True
        return False
    
    def _apply_yandex_speller(self, text: str) -> str:
        try:
            url = "https://speller.yandex.net/services/spellservice.json/checkText"
            resp = self._http.get(url, params={"text": text, "lang": "ru,en"}, timeout=3)
            if resp.status_code == 200:
                arr = resp.json()
                if not isinstance(arr, list) or not arr:
                    return text
                res = []
                last = 0
                for e in arr:
                    try:
                        pos = int(e.get("pos", 0))
                        ln = int(e.get("len", 0))
                        sgs = e.get("s") or []
                        if not sgs:
                            continue
                        if pos < last:
                            continue
                        segment = text[pos:pos+ln]
                        if "@" in segment or re.search(r'\+?\d[\d\-\s\(\)]{3,}\d', segment):
                            res.append(text[last:pos+ln])
                            last = pos + ln
                            continue
                        res.append(text[last:pos])
                        res.append(str(sgs[0]))
                        last = pos + ln
                    except Exception:
                        pass
                res.append(text[last:])
                return "".join(res)
        except Exception:
            pass
        return text

    def _process_fix_async(self, text: str, params: Any, style_idx: int = None):
        def worker():
            nonlocal style_idx
            try:
                try:
                    peer = getattr(params, "peer", None)
                except Exception:
                    peer = None
                inflight_key = None
                try:
                    inflight_key = self._get_peer_id(peer) if peer else None
                except Exception:
                    inflight_key = None

                if inflight_key:
                    try:
                        if inflight_key in self._ai_inflight:
                            run_on_ui_thread(lambda: self._send_corrected_message(text, params))
                            return
                        self._ai_inflight.add(inflight_key)
                    except Exception:
                        pass

                try:
                    ai_enabled_for_worker = self._get_bool_setting("ai_correction", False)
                except Exception:
                    ai_enabled_for_worker = False
                try:
                    rewrite_mode = bool(ai_enabled_for_worker) and self._get_bool_setting("yandex_rewrite_mode", False)
                except Exception:
                    rewrite_mode = False
                settings = {
                    "no_fix": False,
                    "no_rewrite": not rewrite_mode,
                    "style_idx": 0,
                    "caps_mode": 0,
                    "format_mode": 0,
                    "disable_premium": False,
                    "disable_format": False,
                    "ascii_replace": self._get_bool_setting("ascii_emotes_replace", False),
                }

                exception_words = self._parse_exceptions_list("exception_words")
                chat_rule = self._get_effective_rule_for_params(params)

                if chat_rule:
                    settings["no_fix"] = bool(chat_rule.get("no_fix", False))
                    rule_no_rewrite = bool(chat_rule.get("no_rewrite", False))
                    if rule_no_rewrite:
                        settings["no_rewrite"] = True
                    try:
                        settings["style_idx"] = int(chat_rule.get("style_idx", 0))
                    except Exception:
                        try:
                            settings["style_idx"] = int(chat_rule.get("rewrite_style", 0))
                        except Exception:
                            settings["style_idx"] = 0
                    settings["caps_mode"] = chat_rule.get("caps_mode", 0)
                    settings["format_mode"] = chat_rule.get("format_mode", 0)
                    settings["disable_premium"] = bool(chat_rule.get("disable_premium", False))
                    settings["disable_format"] = bool(chat_rule.get("disable_format", False))

                try:
                    global_ai_punct = self._get_bool_setting("ai_punctuation", True)
                except Exception:
                    global_ai_punct = True
                try:
                    global_ai_spelling = self._get_bool_setting("ai_spelling", True)
                except Exception:
                    global_ai_spelling = True
                

                if style_idx is not None:
                    settings["style_idx"] = style_idx
                else:
                    if not chat_rule:
                        try:
                            settings["style_idx"] = int(self.get_setting("default_style", 0))
                        except Exception:
                            pass

                core_input = text

                masked_text, mask_mapping = self._mask_ai_exceptions(core_input, exception_words)
                text_for_ai = masked_text

                has_profanity = self._detect_profanity(core_input)

                styles_map = {0: "neutral", 1: "formal", 2: "informal"}
                selected_style = styles_map.get(settings["style_idx"], "neutral")

                def post_yandex(endpoint, prompt, style=None, target_language=None):
                    url = f"https://keyboard.yandex.net/gpt/{endpoint}"
                    payload = {"text": prompt}
                    if style and endpoint == "rewrite":
                        payload["style"] = style
                    try:
                        resp = self._http.post(url, json=payload, timeout=4)
                        if resp.status_code == 200:
                            data = resp.json()
                            res_text = data.get("response", "")
                            if isinstance(res_text, str):
                                res_text = res_text.strip()
                            return res_text
                    except Exception:
                        pass
                    return ""

                fixed = text_for_ai

                ai_spelling_flag = self._get_bool_setting("ai_spelling", True)
                ai_punct_flag = self._get_bool_setting("ai_punctuation", True)
                do_fix = (ai_spelling_flag or ai_punct_flag) and not settings["no_fix"] and not has_profanity

                if do_fix:
                    f_res = post_yandex("fix", fixed)
                    if f_res:
                        fixed = f_res
                    else:
                        try:
                            sp = self._apply_yandex_speller(text_for_ai)
                            if sp:
                                fixed = sp
                        except Exception:
                            pass

                do_rewrite = not settings["no_rewrite"] and not has_profanity
                if do_rewrite:
                    stripped_core = (core_input or "").strip()
                    words = stripped_core.split()
                    if len(words) <= 1:
                        do_rewrite = False
                    elif len(words) > 80:
                        do_rewrite = False

                if do_rewrite:
                    if self._looks_cyrillic(core_input):
                        rw_prompt = "–ü–µ—Ä–µ–ø–∏—à–∏ —Ç–µ–∫—Å—Ç, —Å–æ—Ö—Ä–∞–Ω–∏–≤ —Å—Ç–∏–ª—å –∏ —Å–º—ã—Å–ª. –ù–µ –ø–µ—Ä–µ–≤–æ–¥–∏ —Ç–µ–∫—Å—Ç –≤ –¥–µ–ª–æ–≤–æ–π, –µ—Å–ª–∏ –æ–Ω –¥—Ä—É–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–º –∏ –Ω–∞–æ–±–æ—Ä–æ—Ç. –ù–µ –¥–æ–±–∞–≤–ª—è–π –Ω–æ–≤—ã–µ —Ñ–∞–∫—Ç—ã, –¥–∞—Ç—ã, –∏–º–µ–Ω–∞ –∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Å—Ç–∞–≤—å —Å–ª–æ–≤–∞:\n" + fixed
                    else:
                        rw_prompt = "Rewrite the text improving style while keeping the meaning. Do not add new facts, dates, names, or extra words:\n" + fixed
                    r_res = post_yandex("rewrite", rw_prompt, style=selected_style)
                    if r_res:
                        fixed = r_res

                if not fixed:
                    fixed = text_for_ai

                low = fixed.strip().lower()
                if low.startswith("output:"):
                    fixed = fixed[7:].lstrip()
                elif low.startswith("result:"):
                    fixed = fixed[7:].lstrip()

                result_text = fixed

                ai_punct = ai_punct_flag
                global_cap = self._get_bool_setting("capitalize_sentences", True)
                global_dot = self._get_bool_setting("add_final_dot", True)

                cm = settings["caps_mode"]
                if cm == 0:
                    do_cap = global_cap
                    do_dot = global_dot
                elif cm == 1:
                    do_cap = True
                    do_dot = global_dot
                elif cm == 2:
                    do_cap = global_cap
                    do_dot = True
                elif cm == 3:
                    do_cap = True
                    do_dot = True
                elif cm == 4:
                    do_cap = False
                    do_dot = False
                else:
                    do_cap = global_cap
                    do_dot = global_dot

                if do_cap:
                    parts = _SENTENCE_SPLIT_RE.split(result_text)
                    fixed_parts = []
                    for p in parts:
                        if p.strip():
                            fixed_parts.append(_capitalize_first_alpha(p))
                        else:
                            fixed_parts.append(p)
                    result_text = " ".join([part.strip() for part in fixed_parts if part.strip()]).strip()
                else:
                    result_text = self._preserve_sentence_start_case(text, result_text)

                if ai_punct:
                    result_text = self._normalize_ru_punctuation(result_text)

                if not do_dot:
                    s_orig = text.rstrip()
                    s_fix = result_text.rstrip()
                    if s_fix and s_fix.endswith(".") and not (s_orig and s_orig[-1] in ".!?"):
                        result_text = s_fix[:-1]
                elif result_text and result_text[-1] not in ".!?":
                    result_text = result_text + "."

                if mask_mapping:
                    result_text = self._unmask_ai_exceptions(result_text, mask_mapping)

                if settings["ascii_replace"]:
                    result_text = self._replace_ascii_emoticons(result_text)

                final_text = result_text

                self._last_ai_in, self._last_ai_out = text, final_text
                run_on_ui_thread(lambda: self._send_corrected_message(final_text, params))

            except Exception:
                run_on_ui_thread(lambda: self._send_corrected_message(text, params))
            finally:
                try:
                    peer = getattr(params, "peer", None)
                except Exception:
                    peer = None
                try:
                    inflight_key = self._get_peer_id(peer) if peer else None
                except Exception:
                    inflight_key = None
                if inflight_key:
                    try:
                        self._ai_inflight.discard(inflight_key)
                    except Exception:
                        pass

        try:
            run_on_queue(worker, EXTERNAL_NETWORK_QUEUE)
        except Exception:
            run_on_ui_thread(lambda: self._send_corrected_message(text, params))

    def _send_corrected_message(self, corrected: str, params: Any):
        try:
            if not corrected or not corrected.strip():
                return

            try:
                if self._has_media(params):
                    return
            except Exception:
                pass

            base_peer = getattr(params, "peer", None)
            base_reply = getattr(params, "replyToMsg", None)
            base_reply_top = getattr(params, "replyToTopMsg", None)

            if base_peer is None:
                return

            try:
                format_mode = self._get_effective_format_mode(params)
            except Exception:
                format_mode = 2

            has_formatting = self._has_formatting(self._last_ai_in if getattr(self, "_last_ai_in", None) else corrected)
            has_formatting_entities = False
            try:
                if hasattr(params, "entities") and params.entities:
                    size = params.entities.size()
                    for i in range(size):
                        ent = params.entities.get(i)
                        try:
                            et = str(ent.getClass().getSimpleName())
                        except Exception:
                            continue
                        if "CustomEmoji" in et or "AnimatedEmoji" in et:
                            continue
                        if ("Bold" in et or "Italic" in et or "Code" in et or "Pre" in et or
                            "Underline" in et or "Strike" in et or "Spoiler" in et or
                            "Quote" in et or "Blockquote" in et or "Url" in et or "TextUrl" in et):
                            has_formatting_entities = True
                            break
            except Exception:
                has_formatting_entities = False
            if has_formatting_entities:
                has_formatting = True

            try:
                chat_rule_send = self._get_effective_rule_for_params(params)
                if chat_rule_send is not None:
                    disable_format = bool(chat_rule_send.get("disable_format", False))
                    if disable_format:
                        has_formatting = False
            except Exception:
                pass

            process_with_entities = self._get_effective_process_with_entities(params)
            premium_manual_mode = self._get_bool_setting("premium_manual_mode", False)

            has_premium_entities = False
            try:
                if hasattr(params, "entities") and params.entities:
                    try:
                        entities_size = params.entities.size()
                        for i in range(entities_size):
                            entity = params.entities.get(i)
                            try:
                                entity_type = str(entity.getClass().getSimpleName())
                                if "CustomEmoji" in entity_type or "AnimatedEmoji" in entity_type:
                                    has_premium_entities = True
                                    break
                            except Exception:
                                pass
                    except Exception:
                        pass
            except Exception:
                pass

            if has_premium_entities and process_with_entities and premium_manual_mode:
                ok = False
                try:
                    self._set_input_text(corrected)
                    ok = True
                except Exception:
                    ok = False
                if self._get_bool_setting("show_success_bulletin", True):
                    self._show_bulletin_delayed("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ø—Ä–µ–º–∏—É–º-—ç–º–æ–¥–∑–∏. –í—Å—Ç–∞–≤–ª—è—é –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
                if ok:
                    return

            if has_formatting and format_mode == 1:
                self._set_input_text(corrected)
                if self._get_bool_setting("show_success_bulletin", True):
                    self._show_bulletin_delayed("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –í—Å—Ç–∞–≤–ª—è—é –¥–ª—è —Ä—É—á–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.")
                return

            if has_formatting and format_mode == 0:
                if self._get_bool_setting("show_success_bulletin", True):
                    self._show_bulletin_delayed("–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –û—Ç–ø—Ä–∞–≤–ª—é —Å —Å–∏–º–≤–æ–ª–∞–º–∏.")

            try:
                self._sent_messages.add(hash(corrected))
            except Exception:
                pass

            message_params = {
                "peer": base_peer,
                "replyToMsg": base_reply,
                "replyToTopMsg": base_reply_top,
                "message": corrected
            }

            send_message(message_params)

            try:
                self._set_input_text("")
            except Exception:
                pass

            try:
                if self._get_bool_setting("show_success_bulletin", True):
                    def _show_delayed():
                        import time
                        time.sleep(0.3)
                        run_on_ui_thread(lambda: self._show_bulletin("–¢–µ–∫—Å—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω –ò–ò"))
                    run_on_queue(_show_delayed)
            except Exception as e:
                try:
                    log(f"[PhrasePlugin] Failed to show bulletin: {e}")
                except Exception:
                    pass
        except Exception as e:
            try:
                log(f"[PhrasePlugin] send_message error: {e}")
            except Exception:
                pass

    def _open_rules_manager(self, lang: str):
        try:
            frag = get_last_fragment()
            if not frag: return
            act = frag.getParentActivity()
            if not act: return

            bld = AlertDialogBuilder(act)
            
            rules = self._load_chat_rules()
            page = 0
            items_per_page = 5
            selection_mode = False
            selected_indices = set()

            container = LinearLayout(act)
            container.setOrientation(LinearLayout.VERTICAL)
            
            header_frame = FrameLayout(act)
            header_frame.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(10), AndroidUtilities.dp(20), AndroidUtilities.dp(5))
            
            title_tv = TextView(act)
            title_tv.setTextSize(1, 20.0)
            title_tv.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"))
            title_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            header_frame.addView(title_tv, FrameLayout.LayoutParams(-2, -2, Gravity.LEFT | Gravity.CENTER_VERTICAL))

            select_btn = TextView(act)
            select_btn.setTextSize(1, 14.0)
            select_btn.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlueText4))
            select_btn.setGravity(Gravity.CENTER)
            select_params = FrameLayout.LayoutParams(-2, -2, Gravity.RIGHT | Gravity.CENTER_VERTICAL)
            header_frame.addView(select_btn, select_params)
            
            container.addView(header_frame)
            
            add_frame = FrameLayout(act)
            add_frame.setBackground(Theme.getSelectorDrawable(False))
            add_frame.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(12), AndroidUtilities.dp(20), AndroidUtilities.dp(12))
            
            add_text = TextView(act)
            add_text.setText("+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" if lang == "ru" else "+ Add rule")
            add_text.setTextSize(1, 16.0)
            add_text.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlueText4))
            add_text.setGravity(Gravity.CENTER_VERTICAL)
            add_frame.addView(add_text, FrameLayout.LayoutParams(-2, -2, Gravity.LEFT | Gravity.CENTER_VERTICAL))
            
            container.addView(add_frame)
            container.addView(View(act), -1, AndroidUtilities.dp(1))

            scroll = ScrollView(act)
            list_layout = LinearLayout(act)
            list_layout.setOrientation(LinearLayout.VERTICAL)
            scroll.addView(list_layout)
            
            container.addView(scroll, LinearLayout.LayoutParams(-1, 0, 1.0))

            bottom_bar = LinearLayout(act)
            bottom_bar.setOrientation(LinearLayout.HORIZONTAL)
            bottom_bar.setGravity(Gravity.CENTER)
            bottom_bar.setPadding(0, AndroidUtilities.dp(5), 0, AndroidUtilities.dp(5))
            
            prev_btn = TextView(act)
            prev_btn.setText("<")
            prev_btn.setTextSize(1, 24.0)
            prev_btn.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText2))
            prev_btn.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(5), AndroidUtilities.dp(20), AndroidUtilities.dp(5))
            
            page_tv = TextView(act)
            page_tv.setTextSize(1, 16.0)
            page_tv.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
            page_tv.setPadding(AndroidUtilities.dp(10), 0, AndroidUtilities.dp(10), 0)
            
            next_btn = TextView(act)
            next_btn.setText(">")
            next_btn.setTextSize(1, 24.0)
            next_btn.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText2))
            next_btn.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(5), AndroidUtilities.dp(20), AndroidUtilities.dp(5))
            
            bottom_bar.addView(prev_btn)
            bottom_bar.addView(page_tv)
            bottom_bar.addView(next_btn)
            container.addView(bottom_bar)

            dialog = None

            def refresh_ui():
                nonlocal page, selection_mode
                count = len(rules)
                title_tv.setText(f"{'–ü—Ä–∞–≤–∏–ª–∞' if lang == 'ru' else 'Rules'} ({count})")
                
                if count > 5 or selection_mode:
                    select_btn.setVisibility(0)
                    if selection_mode:
                        select_btn.setText(f"{'–£–¥–∞–ª–∏—Ç—å' if lang == 'ru' else 'Delete'} ({len(selected_indices)})")
                        select_btn.setTextColor(Theme.getColor(Theme.key_text_RedBold))
                    else:
                        select_btn.setText("–í—ã–±—Ä–∞—Ç—å..." if lang == 'ru' else "Select...")
                        select_btn.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlueText4))
                else:
                    select_btn.setVisibility(8)

                add_frame.setVisibility(8 if selection_mode else 0)

                total_pages = (count + items_per_page - 1) // items_per_page
                if total_pages < 1: total_pages = 1
                if page >= total_pages: page = total_pages - 1
                if page < 0: page = 0
                
                start = page * items_per_page
                end = min(start + items_per_page, count)
                current_items = rules[start:end]

                list_layout.removeAllViews()
                
                if not rules:
                    empty = TextView(act)
                    empty.setText("–ù–µ—Ç –ø—Ä–∞–≤–∏–ª" if lang == "ru" else "No rules")
                    empty.setPadding(0, AndroidUtilities.dp(20), 0, AndroidUtilities.dp(20))
                    empty.setGravity(Gravity.CENTER)
                    empty.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText2))
                    list_layout.addView(empty)
                
                for i, rule in enumerate(current_items):
                    abs_idx = start + i
                    item = FrameLayout(act)
                    item.setBackground(Theme.getSelectorDrawable(False))
                    item.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(12), AndroidUtilities.dp(20), AndroidUtilities.dp(12))
                    
                    if selection_mode:
                        cb = ImageView(act)
                        is_sel = abs_idx in selected_indices
                        cb.setImageResource(AndroidUtilities.get_drawable_id("msg_round_check_filled" if is_sel else "msg_round_check"))
                        cb.setColorFilter(Theme.getColor(Theme.key_windowBackgroundWhiteBlueText4 if is_sel else Theme.key_windowBackgroundWhiteGrayText2))
                        item.addView(cb, FrameLayout.LayoutParams(AndroidUtilities.dp(24), AndroidUtilities.dp(24), Gravity.LEFT | Gravity.CENTER_VERTICAL))
                        text_pad = 36
                    else:
                        text_pad = 0

                    try:
                        name = self._get_rule_display_name(rule, lang)
                    except Exception:
                        name = rule.get("chat_title") or ("–ß–∞—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω" if lang == "ru" else "Chat not selected")
                    
                    tv = TextView(act)
                    tv.setText(f"{abs_idx + 1}. {name}")
                    tv.setTextSize(1, 16.0)
                    tv.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
                    tv.setPadding(AndroidUtilities.dp(text_pad), 0, 0, 0)
                    item.addView(tv, FrameLayout.LayoutParams(-2, -2, Gravity.LEFT | Gravity.CENTER_VERTICAL))
                    
                    def _on_click(v, idx=abs_idx):
                        if selection_mode:
                            if idx in selected_indices: selected_indices.remove(idx)
                            else: selected_indices.add(idx)
                            refresh_ui()
                        else:
                            try: dialog.dismiss() 
                            except: pass
                            self._open_rule_editor(idx, lang)
                            
                    item.setOnClickListener(OnClickListener(_on_click))

                    if not selection_mode:
                        def _on_long(v, idx=abs_idx):
                            self._show_rule_context_menu(idx, lang, dialog)
                            return True
                        item.setOnLongClickListener(OnLongClickListener(_on_long))

                    list_layout.addView(item)

                page_tv.setText(f"{page + 1} / {total_pages}")
                bottom_bar.setVisibility(0 if total_pages > 1 else 8)

            refresh_ui()

            def _toggle_select(v):
                nonlocal selection_mode
                if selection_mode:
                    if selected_indices:
                        def _confirm_del(d, w):
                            sorted_idx = sorted(list(selected_indices), reverse=True)
                            for i in sorted_idx:
                                self._remove_chat_rule(i)
                            selected_indices.clear()
                            nonlocal rules
                            rules = self._load_chat_rules()
                            refresh_ui()
                        
                        AlertDialogBuilder(act) \
                            .set_title("–£–¥–∞–ª–∏—Ç—å?" if lang == "ru" else "Delete?") \
                            .set_message(f"–£–¥–∞–ª–∏—Ç—å {len(selected_indices)} –ø—Ä–∞–≤–∏–ª?" if lang == "ru" else f"Delete {len(selected_indices)} rules?") \
                            .set_positive_button("–î–∞" if lang == "ru" else "Yes", _confirm_del) \
                            .set_negative_button("–ù–µ—Ç" if lang == "ru" else "No", None) \
                            .show()
                        return
                    else:
                        selection_mode = False
                else:
                    selection_mode = True
                    selected_indices.clear()
                refresh_ui()
            
            select_btn.setOnClickListener(OnClickListener(_toggle_select))

            def _add_click(v):
                try: dialog.dismiss() 
                except: pass
                
                opts = ["–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞", "–í–≤–µ—Å—Ç–∏ @username", "–í—ã–±—Ä–∞—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é"] if lang == "ru" else ["Select from list", "Enter @username", "Choose category"]
                
                bld_add = AlertDialogBuilder(act)
                bld_add.set_items(opts, lambda d, i: [
                    d.dismiss(),
                    self._open_chat_rule_dialog(-1, lang) if i == 0 else (self._add_rule_by_username_dialog(lang) if i == 1 else self._add_category_rule_dialog(lang))
                ])
                bld_add.show()
            add_frame.setOnClickListener(OnClickListener(_add_click))

            def _prev_page(v):
                nonlocal page
                if page > 0:
                    page -= 1
                    refresh_ui()
            prev_btn.setOnClickListener(OnClickListener(_prev_page))

            def _next_page(v):
                nonlocal page
                count = len(rules)
                total = (count + items_per_page - 1) // items_per_page
                if page < total - 1:
                    page += 1
                    refresh_ui()
            next_btn.setOnClickListener(OnClickListener(_next_page))
            
            def _page_click(v):
                pass 
            page_tv.setOnClickListener(OnClickListener(_page_click))

            bld.set_view(container)
            bld.set_negative_button("–ó–∞–∫—Ä—ã—Ç—å" if lang == "ru" else "Close", lambda d, w: [d.dismiss(), self._trigger_settings_reload()])
            dialog = bld.show()
        except Exception as e:
            try: 
                log(f"Manager error: {e}") 
            except: 
                pass

    def _rename_rule_dialog(self, idx: int, lang: str):
        try:
            rules = self._load_chat_rules()
            if not (0 <= idx < len(rules)): return
            rule = rules[idx]
            
            frag = get_last_fragment()
            if not frag: return
            act = frag.getParentActivity()
            if not act: return
            
            bld = AlertDialogBuilder(act)
            bld.set_title("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" if lang == "ru" else "Rename")
            
            cont = FrameLayout(act)
            cont.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(10), AndroidUtilities.dp(24), AndroidUtilities.dp(10))
            
            inp = EditText(act)
            inp.setText(rule.get("name", ""))
            inp.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            inp.setHint("–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–∞–≤–∏–ª–∞" if lang == "ru" else "Rule name")
            cont.addView(inp)
            
            bld.set_view(cont)
            
            def _save(d, w):
                val = str(inp.getText()).strip()
                rule["name"] = val
                self._save_chat_rules(rules)
                d.dismiss()
                self._open_rules_manager(lang)
                
            bld.set_positive_button("OK", _save)
            bld.set_negative_button("–û—Ç–º–µ–Ω–∞" if lang == "ru" else "Cancel", None)
            bld.show()
        except Exception:
            pass

    def _add_rule_by_username_dialog(self, lang: str):
        try:
            frag = get_last_fragment()
            if not frag: return
            act = frag.getParentActivity()
            if not act: return
            
            bld = AlertDialogBuilder(act)
            bld.set_title("–í–≤–µ–¥–∏—Ç–µ @username" if lang == "ru" else "Enter @username")
            
            cont = FrameLayout(act)
            cont.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(10), AndroidUtilities.dp(24), AndroidUtilities.dp(10))
            
            inp = EditText(act)
            inp.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            inp.setHint("@username")
            cont.addView(inp)
            
            bld.set_view(cont)
            
            def _resolve(d, w):
                username = str(inp.getText()).strip()
                if not username: return
                
                if not username.startswith("@"):
                    username = "@" + username
                
                search_name = username[1:]
                
                try:
                    from client_utils import get_messages_controller
                    ctrl = get_messages_controller()
                    
                    peer_id = None
                    title = username
                    
                    try:
                        obj = ctrl.getUserOrChat(search_name)
                        if obj:
                            if hasattr(obj, "id"):
                                try:
                                    cls_name = str(obj.getClass().getSimpleName())
                                except Exception:
                                    cls_name = ""
                                oid_raw = getattr(obj, "id", None)
                                try:
                                    oid_int = int(oid_raw)
                                except Exception:
                                    oid_int = None
                                is_chat = ("Chat" in cls_name) or hasattr(obj, "title")
                                if oid_int is not None:
                                    peer_id = str(-abs(oid_int) if is_chat else abs(oid_int))
                                else:
                                    peer_id = ("-" if is_chat else "") + str(oid_raw)
                                if hasattr(obj, "title"): 
                                    title = obj.title
                                elif hasattr(obj, "first_name"): 
                                    title = f"{obj.first_name} {obj.last_name or ''}".strip()
                    except Exception:
                        pass
                        
                    if not peer_id:
                        from ui.bulletin import BulletinHelper
                        BulletinHelper.show_error("–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∫—ç—à–µ" if lang == "ru" else "Chat not found in cache")
                        return

                    rules = self._load_chat_rules()
                    new_rule = {
                        "chat_ids": [peer_id],
                        "chat_title": title,
                        "no_fix": False,
                        "no_rewrite": False,
                        "style_idx": 0,
                        "caps_mode": 0,
                        "format_mode": -1,
                        "disable_premium": False,
                        "disable_format": False,
                        "collapsed": False
                    }
                    rules.append(new_rule)
                    self._save_chat_rules(rules)
                    d.dismiss()
                    self._open_rules_manager(lang)
                    
                except Exception as e:
                    log(f"Resolve error: {e}")
            
            bld.set_positive_button("OK", _resolve)
            bld.set_negative_button("–û—Ç–º–µ–Ω–∞" if lang == "ru" else "Cancel", None)
            bld.show()
        except Exception:
            pass

    def _add_chat_to_rule_dialog(self, rule_idx: int, lang: str):
        try:
            frag = get_last_fragment()
            if not frag: return
            act = frag.getParentActivity()
            if not act: return

            opts = ["–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø–∏—Å–∫–∞", "–í–≤–µ—Å—Ç–∏ @username"] if lang == "ru" else ["Select from list", "Enter @username"]
            
            bld = AlertDialogBuilder(act)
            bld.set_items(opts, lambda d, i: [
                d.dismiss(),
                self._open_chat_selection_for_rule(rule_idx, lang) if i == 0 else self._add_chat_by_username_to_rule(rule_idx, lang)
            ])
            bld.show()
        except Exception:
            pass

    def _add_chat_by_username_to_rule(self, rule_idx: int, lang: str):
        try:
            frag = get_last_fragment()
            if not frag: return
            act = frag.getParentActivity()
            if not act: return
            
            bld = AlertDialogBuilder(act)
            bld.set_title("–í–≤–µ–¥–∏—Ç–µ @username" if lang == "ru" else "Enter @username")
            
            cont = FrameLayout(act)
            cont.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(10), AndroidUtilities.dp(24), AndroidUtilities.dp(10))
            
            inp = EditText(act)
            inp.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            inp.setHint("@username")
            cont.addView(inp)
            bld.set_view(cont)
            
            def _resolve(d, w):
                username = str(inp.getText()).strip()
                if not username: return
                if not username.startswith("@"): username = "@" + username
                search_name = username[1:]
                
                try:
                    from client_utils import get_messages_controller
                    ctrl = get_messages_controller()
                    
                    peer_id = None
                    title = username
                    
                    try:
                        obj = ctrl.getUserOrChat(search_name)
                        if obj:
                            if hasattr(obj, "id"):
                                try:
                                    cls_name = str(obj.getClass().getSimpleName())
                                except Exception:
                                    cls_name = ""
                                oid_raw = getattr(obj, "id", None)
                                try:
                                    oid_int = int(oid_raw)
                                except Exception:
                                    oid_int = None
                                is_chat = ("Chat" in cls_name) or hasattr(obj, "title")
                                if oid_int is not None:
                                    peer_id = str(-abs(oid_int) if is_chat else abs(oid_int))
                                else:
                                    peer_id = ("-" if is_chat else "") + str(oid_raw)
                                if hasattr(obj, "title"): title = obj.title
                                elif hasattr(obj, "first_name"): title = f"{obj.first_name} {obj.last_name or ''}".strip()
                    except: pass
                    
                    if not peer_id:
                        from ui.bulletin import BulletinHelper
                        BulletinHelper.show_error("–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω" if lang == "ru" else "Chat not found")
                        return

                    rules = self._load_chat_rules()
                    if 0 <= rule_idx < len(rules):
                        rule = rules[rule_idx]
                        if "chat_ids" not in rule: rule["chat_ids"] = []
                        if peer_id not in rule["chat_ids"]:
                            rule["chat_ids"].append(peer_id)
                            if "chats_info" not in rule: rule["chats_info"] = []
                            rule["chats_info"].append({"id": peer_id, "title": title})
                            
                            self._save_chat_rules(rules)
                            d.dismiss()
                            self._open_rule_editor(rule_idx, lang)
                        else:
                             d.dismiss()
                             self._open_rule_editor(rule_idx, lang)
                except Exception as e:
                    log(f"Add chat error: {e}")
            
            bld.set_positive_button("OK", _resolve)
            bld.set_negative_button("–û—Ç–º–µ–Ω–∞" if lang == "ru" else "Cancel", None)
            bld.show()
        except Exception:
            pass

    def _open_chat_selection_for_rule(self, rule_idx: int, lang: str):
        self._open_chat_rule_dialog(rule_idx, lang)

    def _show_rule_context_menu(self, idx: int, lang: str, parent_dialog=None):
        try:
            if parent_dialog:
                try: parent_dialog.dismiss()
                except: pass
            
            frag = get_last_fragment()
            if not frag: return
            act = frag.getParentActivity()
            if not act: return
            
            bld = AlertDialogBuilder(act)
            
            rules = self._load_chat_rules()
            rule = rules[idx] if 0 <= idx < len(rules) else {}
            is_category = False
            try:
                is_category = bool(str(rule.get("category", "")).strip())
            except Exception:
                is_category = False

            if is_category:
                opts = [
                    "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" if lang == "ru" else "Rename",
                    "–£–¥–∞–ª–∏—Ç—å" if lang == "ru" else "Delete"
                ]
            else:
                opts = [
                    "–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å" if lang == "ru" else "Rename",
                    "–ò–∑–º–µ–Ω–∏—Ç—å —á–∞—Ç—ã" if lang == "ru" else "Edit chats",
                    "–£–¥–∞–ª–∏—Ç—å" if lang == "ru" else "Delete"
                ]
            
            container = LinearLayout(act)
            container.setOrientation(LinearLayout.VERTICAL)
            
            for i, opt in enumerate(opts):
                tv = TextView(act)
                tv.setText(opt)
                tv.setTextSize(1, 16.0)
                tv.setTextColor(Theme.getColor(Theme.key_text_RedBold) if i == (len(opts) - 1) else Theme.getColor(Theme.key_dialogTextBlack))
                tv.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(16), AndroidUtilities.dp(24), AndroidUtilities.dp(16))
                tv.setBackground(Theme.getSelectorDrawable(False))
                
                def _clk(v, opt_idx=i):
                    try: bld.dismiss() 
                    except: pass
                    
                    if opt_idx == 0:
                        self._rename_rule_dialog(idx, lang)
                    elif opt_idx == 1 and not is_category:
                        self._open_chat_rule_dialog(idx, lang)
                    elif (opt_idx == 1 and is_category) or (opt_idx == 2 and not is_category):
                        def _confirm_del(d, w):
                            self._remove_chat_rule(idx)
                            self._open_rules_manager(lang)
                        
                        AlertDialogBuilder(act) \
                            .set_title("–£–¥–∞–ª–∏—Ç—å?" if lang == "ru" else "Delete?") \
                            .set_positive_button("–î–∞" if lang == "ru" else "Yes", _confirm_del) \
                            .set_negative_button("–ù–µ—Ç" if lang == "ru" else "No", lambda d,w: self._open_rules_manager(lang)) \
                            .show()
                            
                tv.setOnClickListener(OnClickListener(_clk))
                container.addView(tv)
            
            bld.set_view(container)
            bld.show()
        except Exception:
            pass

    def _open_rule_editor(self, idx: int, lang: str):
        try:
            rules = self._load_chat_rules()
            if not (0 <= idx < len(rules)): return
            rule = rules[idx]
            
            frag = get_last_fragment()
            if not frag: return
            act = frag.getParentActivity()
            if not act: return
            
            bld = AlertDialogBuilder(act)
            try:
                name = self._get_rule_display_name(rule, lang)
            except Exception:
                name = rule.get("chat_title") or "?"
            bld.set_title(name[:20] + "..." if len(name) > 20 else name)

            settings_list = []

            is_category = bool(str(rule.get("category", "")).strip())

            if not is_category:
                chats_header = TextView(act)
                chats_header.setText("–ß–∞—Ç—ã" if lang == "ru" else "Chats")
                chats_header.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlueHeader))
                chats_header.setTextSize(1, 14.0)
                chats_header.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(16), AndroidUtilities.dp(24), AndroidUtilities.dp(8))
                settings_list.append(chats_header)
                
                chats_info = rule.get("chats_info", [])
                cids = rule.get("chat_ids", [])
                if isinstance(cids, str):
                    cids = [cids]
                cids = [str(i) for i in cids]
                rule["chat_ids"] = cids
                
                chats_info = [c for c in chats_info if str(c.get("id")) in cids]
                existing_info_ids = [str(c.get("id")) for c in chats_info]
                title = rule.get("chat_title", "")
                for cid in cids:
                    if cid not in existing_info_ids:
                        chats_info.append({"id": cid, "title": title if len(cids)==1 else cid})
                rule["chats_info"] = chats_info
                
                for info in chats_info:
                    cf = FrameLayout(act)
                    cf.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(8), AndroidUtilities.dp(24), AndroidUtilities.dp(8))
                    
                    ctv = TextView(act)
                    try:
                        ctv.setText(self._get_display_name_for_dialog_id(info.get("id", "?"), lang))
                    except Exception:
                        ctv.setText(info.get("title", str(info.get("id", "?"))))
                    ctv.setTextSize(1, 16.0)
                    ctv.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
                    ctv.setGravity(Gravity.CENTER_VERTICAL | Gravity.LEFT)
                    cf.addView(ctv, FrameLayout.LayoutParams(-2, -2, Gravity.LEFT | Gravity.CENTER_VERTICAL))
                    
                    del_btn = TextView(act)
                    del_btn.setText("‚úï")
                    del_btn.setTextSize(1, 18.0)
                    del_btn.setTextColor(Theme.getColor(Theme.key_text_RedBold))
                    del_btn.setPadding(AndroidUtilities.dp(10), 0, AndroidUtilities.dp(10), 0)
                    del_btn.setGravity(Gravity.CENTER_VERTICAL | Gravity.RIGHT)
                    
                    def _remove_chat(v, target_id=str(info.get("id"))):
                        if len(rule.get("chat_ids", [])) <= 1:
                            def _confirm_del_rule(d, w):
                                self._remove_chat_rule(idx)
                                bld.dismiss()
                                self._open_rules_manager(lang)
                            
                            AlertDialogBuilder(act) \
                                .set_title("–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ?" if lang == "ru" else "Delete rule?") \
                                .set_message("–≠—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —á–∞—Ç. –£–¥–∞–ª–µ–Ω–∏–µ —á–∞—Ç–∞ —É–¥–∞–ª–∏—Ç –ø—Ä–∞–≤–∏–ª–æ —Ü–µ–ª–∏–∫–æ–º." if lang == "ru" else "This is the last chat. Removing it will delete the rule.") \
                                .set_positive_button("–£–¥–∞–ª–∏—Ç—å" if lang == "ru" else "Delete", _confirm_del_rule) \
                                .set_negative_button("–û—Ç–º–µ–Ω–∞" if lang == "ru" else "Cancel", None) \
                                .show()
                            return
                        
                        new_info = [c for c in rule.get("chats_info", []) if str(c.get("id")) != target_id]
                        new_ids = [c for c in rule.get("chat_ids", []) if str(c) != target_id]
                        rule["chats_info"] = new_info
                        rule["chat_ids"] = new_ids
                        self._save_chat_rules(rules)
                        bld.dismiss()
                        self._open_rule_editor(idx, lang)

                    del_btn.setOnClickListener(OnClickListener(_remove_chat))
                    cf.addView(del_btn, FrameLayout.LayoutParams(-2, -2, Gravity.RIGHT | Gravity.CENTER_VERTICAL))
                    
                    settings_list.append(cf)
                
                add_c_btn = TextView(act)
                add_c_btn.setText("+ " + ("–î–æ–±–∞–≤–∏—Ç—å —á–∞—Ç" if lang == "ru" else "Add chat"))
                add_c_btn.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlueText4))
                add_c_btn.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(12), AndroidUtilities.dp(24), AndroidUtilities.dp(12))
                add_c_btn.setBackground(Theme.getSelectorDrawable(False))
                add_c_btn.setOnClickListener(OnClickListener(lambda v: [bld.dismiss(), self._add_chat_to_rule_dialog(idx, lang)]))
                settings_list.append(add_c_btn)
                
                div = View(act)
                div.setBackgroundColor(Theme.getColor(Theme.key_divider))
                settings_list.append(div)
            else:
                hdr = TextView(act)
                hdr.setText("–ö–∞—Ç–µ–≥–æ—Ä–∏—è" if lang == "ru" else "Category")
                hdr.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlueHeader))
                hdr.setTextSize(1, 14.0)
                hdr.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(16), AndroidUtilities.dp(24), AndroidUtilities.dp(8))
                settings_list.append(hdr)
                cat_name = str(rule.get("name") or rule.get("chat_title") or "")
                tv_cat = TextView(act)
                tv_cat.setText(cat_name)
                tv_cat.setTextSize(1, 16.0)
                tv_cat.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
                tv_cat.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(8), AndroidUtilities.dp(24), AndroidUtilities.dp(8))
                settings_list.append(tv_cat)
                div2 = View(act)
                div2.setBackgroundColor(Theme.getColor(Theme.key_divider))
                settings_list.append(div2)

            def add_selector(key, title, items, default):
                frame = FrameLayout(act)
                frame.setBackground(Theme.getSelectorDrawable(False))
                frame.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(8), AndroidUtilities.dp(24), AndroidUtilities.dp(8))
                
                tv = TextView(act)
                tv.setText(title)
                tv.setTextSize(1, 16.0)
                tv.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
                tv.setGravity(Gravity.CENTER_VERTICAL | Gravity.LEFT)
                
                tv_val = TextView(act)
                
                curr_val = rule.get(key, default)
                try:
                    disp_txt = items[curr_val] if 0 <= curr_val < len(items) else items[0]
                except Exception:
                    disp_txt = items[0]
                
                tv_val.setText(disp_txt)
                tv_val.setTextSize(1, 14.0)
                tv_val.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText2))
                tv_val.setGravity(Gravity.CENTER_VERTICAL | Gravity.RIGHT)
                params = FrameLayout.LayoutParams(-2, -2, Gravity.RIGHT | Gravity.CENTER_VERTICAL)
                
                frame.addView(tv)
                frame.addView(tv_val, params)
                
                def _click(v):
                    sel_bld = AlertDialogBuilder(act)
                    sel_bld.set_title(title)
                    
                    list_cont = LinearLayout(act)
                    list_cont.setOrientation(LinearLayout.VERTICAL)
                    
                    for i, item in enumerate(items):
                        row = TextView(act)
                        row.setText(item)
                        row.setTextSize(1, 16.0)
                        row.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                        row.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(16), AndroidUtilities.dp(24), AndroidUtilities.dp(16))
                        row.setBackground(Theme.getSelectorDrawable(False))
                        
                        def _sel(v, val_idx=i, val_txt=item):
                            sel_bld.dismiss()
                            
                            rule[key] = val_idx
                            self._save_chat_rules(rules)
                            
                            disp_txt = val_txt
                            tv_val.setText(disp_txt)
                            
                            update_visibility()
                            
                        row.setOnClickListener(OnClickListener(_sel))
                        list_cont.addView(row)
                    
                    scroll_s = ScrollView(act)
                    scroll_s.addView(list_cont)
                    sel_bld.set_view(scroll_s)
                    sel_bld.show()

                frame.setOnClickListener(OnClickListener(_click))
                return frame

            def add_switch(key, text, default):
                frame = FrameLayout(act)
                frame.setBackground(Theme.getSelectorDrawable(False))
                frame.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(8), AndroidUtilities.dp(24), AndroidUtilities.dp(8))
                
                tv = TextView(act)
                tv.setTextSize(1, 16.0)
                tv.setGravity(Gravity.CENTER_VERTICAL | Gravity.LEFT)

                def _apply_state(is_disabled: bool):
                    try:
                        if key == "no_fix":
                            tv.setText(("–ù–µ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç" if lang == "ru" else "Do not fix text") if is_disabled else ("–ò—Å–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç" if lang == "ru" else "Fix text"))
                        elif key == "no_rewrite":
                            tv.setText(("–ù–µ —É–ª—É—á—à–∞—Ç—å —Ç–µ–∫—Å—Ç" if lang == "ru" else "Do not rewrite") if is_disabled else ("–£–ª—É—á—à–∞—Ç—å —Ç–µ–∫—Å—Ç" if lang == "ru" else "Rewrite"))
                        else:
                            tv.setText(("–í—ã–∫–ª" if lang == "ru" else "Off") if is_disabled else ("–í–∫–ª" if lang == "ru" else "On"))
                    except Exception:
                        try:
                            tv.setText(text)
                        except Exception:
                            pass

                    try:
                        color = Color.parseColor("#F44336") if is_disabled else Color.parseColor("#4CAF50")
                        tv.setTextColor(color)
                    except Exception:
                        try:
                            tv.setTextColor(Theme.getColor(Theme.key_text_RedBold) if is_disabled else Theme.getColor(Theme.key_windowBackgroundWhiteBlueText4))
                        except Exception:
                            try:
                                tv.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
                            except Exception:
                                pass

                val = bool(rule.get(key, default))
                _apply_state(val)

                frame.addView(tv)
                
                def _toggle(v):
                    curr = bool(rule.get(key, default))
                    rule[key] = not curr
                    self._save_chat_rules(rules)
                    _apply_state(not curr)
                    update_visibility()
                
                frame.setOnClickListener(OnClickListener(_toggle))
                return frame

            v_nofix = add_switch("no_fix", "–ù–µ –∏—Å–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç" if lang == "ru" else "Do not fix text", False)
            settings_list.append(v_nofix)
            
            v_norewrite = add_switch("no_rewrite", "–ù–µ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞—Ç—å —Ç–µ–∫—Å—Ç" if lang == "ru" else "Do not rewrite text", False)
            settings_list.append(v_norewrite)
            
            caps = [
                "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (–ø–ª–∞–≥–∏–Ω)" if lang == "ru" else "Default (plugin)",
                "–° –∑–∞–≥–ª–∞–≤–Ω–æ–π" if lang == "ru" else "Start cap",
                "–° —Ç–æ—á–∫–æ–π" if lang == "ru" else "End dot",
                "–ó–∞–≥–ª–∞–≤–Ω–∞—è –∏ —Ç–æ—á–∫–∞" if lang == "ru" else "Both",
                "–û—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –µ—Å—Ç—å" if lang == "ru" else "Keep as is",
            ]
            v_caps = add_selector("caps_mode", "–†–µ–≥–∏—Å—Ç—Ä –∏ —Ç–æ—á–∫–∏" if lang == "ru" else "Case and dots", caps, 0)
            settings_list.append(v_caps)
            
            del_frame = FrameLayout(act)
            del_frame.setBackground(Theme.getSelectorDrawable(False))
            del_frame.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(12), AndroidUtilities.dp(24), AndroidUtilities.dp(12))
            del_tv = TextView(act)
            del_tv.setText("–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ" if lang == "ru" else "Delete rule")
            del_tv.setTextColor(Theme.getColor(Theme.key_text_RedBold))
            del_tv.setTextSize(1, 16.0)
            del_frame.addView(del_tv)
            def _del(v):
                def _confirm(d, w):
                    self._remove_chat_rule(idx)
                    bld.dismiss()
                    self._open_rules_manager(lang)
                AlertDialogBuilder(act) \
                    .set_title("–£–¥–∞–ª–∏—Ç—å?" if lang == "ru" else "Delete?") \
                    .set_positive_button("–î–∞" if lang == "ru" else "Yes", _confirm) \
                    .set_negative_button("–ù–µ—Ç" if lang == "ru" else "No", None) \
                    .show()
            del_frame.setOnClickListener(OnClickListener(_del))
            settings_list.append(del_frame)

            scroll = ScrollView(act)
            cont = LinearLayout(act)
            cont.setOrientation(LinearLayout.VERTICAL)
            
            for v in settings_list:
                cont.addView(v)
            scroll.addView(cont)
            
            def update_visibility():
                pass

            update_visibility()

            bld.set_view(scroll)
            bld.set_positive_button("OK", lambda d, w: [d.dismiss(), self._open_rules_manager(lang)])
            bld.show()
        except Exception as e:
            try: 
                log(f"Editor error: {e}") 
            except: 
                pass

    def _add_category_rule_dialog(self, lang: str):
        try:
            frag = get_last_fragment()
            if not frag:
                return
            act = frag.getParentActivity()
            if not act:
                return

            items = [
                "–ò—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ –∫–∞–Ω–∞–ª—ã",
                "–ò—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ –≥—Ä—É–ø–ø—ã",
                "–ò—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ—Ö –±–æ—Ç–æ–≤",
                "–ò—Å–∫–ª—é—á–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–∞–∫—Ç—ã",
            ] if lang == "ru" else [
                "Exclude all channels",
                "Exclude all groups",
                "Exclude all bots",
                "Exclude all contacts",
            ]
            cats = ["channels", "groups", "bots", "contacts"]

            def _on_sel(d, i):
                try:
                    d.dismiss()
                except Exception:
                    pass
                try:
                    cat = cats[int(i)]
                except Exception:
                    return

                if cat == "channels":
                    name = "–ò—Å–∫–ª—é—á–∏—Ç—å: –ö–∞–Ω–∞–ª—ã" if lang == "ru" else "Exclude: Channels"
                elif cat == "groups":
                    name = "–ò—Å–∫–ª—é—á–∏—Ç—å: –ì—Ä—É–ø–ø—ã" if lang == "ru" else "Exclude: Groups"
                elif cat == "bots":
                    name = "–ò—Å–∫–ª—é—á–∏—Ç—å: –ë–æ—Ç—ã" if lang == "ru" else "Exclude: Bots"
                else:
                    name = "–ò—Å–∫–ª—é—á–∏—Ç—å: –ö–æ–Ω—Ç–∞–∫—Ç—ã" if lang == "ru" else "Exclude: Contacts"

                rules = self._load_chat_rules()
                rules.append({
                    "chat_ids": [],
                    "chats_info": [],
                    "chat_title": name,
                    "name": name,
                    "category": cat,
                    "no_fix": True,
                    "no_rewrite": True,
                    "style_idx": 0,
                    "caps_mode": 0,
                    "format_mode": -1,
                    "disable_premium": False,
                    "disable_format": False,
                    "collapsed": False
                })
                self._save_chat_rules(rules)
                self._open_rules_manager(lang)

            AlertDialogBuilder(act).set_title("–ö–∞—Ç–µ–≥–æ—Ä–∏—è" if lang == "ru" else "Category").set_items(items, _on_sel).show()
        except Exception:
            try:
                self._open_rules_manager(lang)
            except Exception:
                pass
