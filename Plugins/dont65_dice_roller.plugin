# –ü–ª–∞–≥–∏–Ω: Dice Roller (–ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞)
# –ê–≤—Ç–æ—Ä: @dont65
# –í–µ—Ä—Å–∏—è 2.1.0
# –¢—Ä–µ–±—É–µ—Ç: Dont65 Library (dont65_lib)

from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import log
from ui.settings import Header, Divider, Input
from org.telegram.messenger import UserConfig
import random
import traceback

__name__ = "Dice Roller"
__description__ = "üé≤ –ë—Ä–æ—Å–æ–∫ –∫—É–±–∏–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–µ .roll\n\n–ö–æ–º–∞–Ω–¥—ã:\n‚Ä¢ .roll ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±—Ä–æ—Å–æ–∫ (0-100)\n‚Ä¢ .roll [max] ‚Äî –æ—Ç 0 –¥–æ max\n‚Ä¢ .roll [min] [max] ‚Äî –æ—Ç min –¥–æ max"
__icon__ = "wtffffffffffDD/0"
__version__ = "2.1.0"
__id__ = "dont65_dice_roller"
__author__ = "@dont65"
__min_version__ = "11.0.0"

class DiceRollerPlugin(BasePlugin):
    
    def __init__(self):
        super().__init__()
        self.lib_missing = False
        self.Dont65Utils = None
        self._check_library()

    def _check_library(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"""
        try:
            from dont65_lib import Dont65Utils as LibUtils
            self.Dont65Utils = LibUtils
            self.lib_missing = False
            log(f"[{__id__}] –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Dont65Lib –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
        except ImportError:
            self.lib_missing = True
            log(f"[{__id__}] –û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ dont65_lib –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    def _get_user_link(self, current_user):
        """–§–æ—Ä–º–∏—Ä—É–µ—Ç –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        user_id = current_user.id
        
        # –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º user_id –¥–ª—è —Å—Å—ã–ª–∫–∏
        tg_link = f"tg://openmessage?user_id={user_id}"
        
        # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –∫–∞–∫ –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫—É –≤ Markdown
        return f"[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å]({tg_link})"

    def create_settings(self):
        settings = [
            Header("üé≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Dice Roller"),
            Divider(text=f"–í–µ—Ä—Å–∏—è: {__version__}"),
            Divider()
        ]
        
        if self.lib_missing:
            settings.extend([
                Header("‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è Dont65 Library!"),
                Divider(text="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω dont65_lib –¥–ª—è —Ä–∞–±–æ—Ç—ã"),
                Divider(),
                Divider(text="–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç")
            ])
        else:
            settings.extend([
                Divider(text="–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –∫–æ–º–∞–Ω–¥—ã .roll (–±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤)"),
                Input(
                    key="default_min",
                    text="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–∏–Ω–∏–º—É–º",
                    subtext="–ß–∏—Å–ª–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0)",
                    default="0"
                ),
                Input(
                    key="default_max",
                    text="–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–∞–∫—Å–∏–º—É–º",
                    subtext="–ß–∏—Å–ª–æ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 100)",
                    default="100"
                ),
                Divider(),
                Divider(text="üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:"),
                Divider(text="üé≤ .roll ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±—Ä–æ—Å–æ–∫\n(–æ—Ç 0 –¥–æ 100 –∏–ª–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º)"),
                Divider(text="üé≤ .roll [—á–∏—Å–ª–æ]\n–ù–∞–ø—Ä–∏–º–µ—Ä .roll 20 ‚Äî –±—Ä–æ—Å–æ–∫ –æ—Ç 0 –¥–æ 20"),
                Divider(text="üé≤ .roll [min] [max]\n–ù–∞–ø—Ä–∏–º–µ—Ä .roll 50 100 ‚Äî –±—Ä–æ—Å–æ–∫ –æ—Ç 50 –¥–æ 100"),
                Divider()
            ])
        
        return settings

    def on_plugin_load(self):
        if not self.lib_missing:
            self.add_on_send_message_hook(priority=200)

    def on_send_message_hook(self, account, params):
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            if self.lib_missing:
                msg_text = params.message or params.caption or ""
                if msg_text.strip().lower().startswith('.roll'):
                    params.message = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –¢—Ä–µ–±—É–µ—Ç—Å—è Dont65 Library!\n–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω `dont65_lib` –¥–ª—è —Ä–∞–±–æ—Ç—ã Dice Roller."
                    return HookResult(strategy=HookStrategy.MODIFY, params=params)
                return HookResult()

            msg_text = ""
            if hasattr(params, 'message') and params.message:
                msg_text = params.message
            elif hasattr(params, 'caption') and params.caption:
                msg_text = params.caption
            
            if not msg_text.lower().strip().startswith('.roll'):
                return HookResult()

            # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–∞–Ω–¥—ã
            msg_text = msg_text.strip()
            parts = msg_text.split()
            
            # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
            min_val = 0
            max_val = 100
            custom_range = False
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
            current_user = UserConfig.getInstance(account).getCurrentUser()
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_link = self._get_user_link(current_user)

            try:
                if len(parts) == 1:
                    # –°—Ü–µ–Ω–∞—Ä–∏–π 1: ".roll" (–±–µ—Ä–µ–º –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫)
                    try:
                        min_setting = self.get_setting("default_min", "0")
                        max_setting = self.get_setting("default_max", "100")
                        min_val = int(min_setting)
                        max_val = int(max_setting)
                    except ValueError:
                        min_val = 0
                        max_val = 100
                
                elif len(parts) == 2:
                    # –°—Ü–µ–Ω–∞—Ä–∏–π 2: ".roll 20" (—Å—á–∏—Ç–∞–µ–º –æ—Ç 0 –¥–æ 20)
                    min_val = 0
                    max_val = int(parts[1])
                    custom_range = True

                elif len(parts) == 3:
                    # –°—Ü–µ–Ω–∞—Ä–∏–π 3: ".roll 10 20" (–æ—Ç 10 –¥–æ 20)
                    min_val = int(parts[1])
                    max_val = int(parts[2])
                    custom_range = True
                else:
                    raise ValueError("–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤")

                # –ó–∞—â–∏—Ç–∞: –µ—Å–ª–∏ min –±–æ–ª—å—à–µ max (–Ω–∞–ø—Ä–∏–º–µ—Ä .roll 100 50), –º–µ–Ω—è–µ–º –º–µ—Å—Ç–∞–º–∏
                if min_val > max_val:
                    min_val, max_val = max_val, min_val

                # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ —á–∏—Å–ª–∞
                if abs(max_val - min_val) > 1000000:
                    raise ValueError("–î–∏–∞–ø–∞–∑–æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π")

                # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞
                result_num = random.randint(min_val, max_val)

                # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —Å –≥–∏–ø–µ—Ä—Å—Å—ã–ª–∫–æ–π
                if custom_range:
                    response_text = (
                        f"üé≤ {user_link} –∫–∏–Ω—É–ª –∫—É–±–∏–∫.\n"
                        f"üîÑ –î–∏–∞–ø–∞–∑–æ–Ω —á–∏—Å–µ–ª: **{min_val}** - **{max_val}**\n"
                        f"‚úÖ –í—ã–ø–∞–ª–æ: **{result_num}**"
                    )
                else:
                    response_text = (
                        f"üé≤ {user_link} –∫–∏–Ω—É–ª –∫—É–±–∏–∫.\n"
                        f"üîÑ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω: **{min_val}** - **{max_val}**\n"
                        f"‚úÖ –í—ã–ø–∞–ª–æ: **{result_num}**"
                    )

                # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞
                new_params = self.Dont65Utils.reply_with_style(
                    params,
                    body=response_text,
                    header=None,
                    source=None,
                    quote='block'
                )
                
                return HookResult(strategy=HookStrategy.MODIFY_FINAL, params=new_params)

            except ValueError as e:
                error_text = str(e)
                if "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤" in error_text:
                    error_message = (
                        "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤.\n\n"
                        "**–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**\n"
                        "‚Ä¢ `.roll` ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±—Ä–æ—Å–æ–∫\n"
                        "‚Ä¢ `.roll 100` ‚Äî –æ—Ç 0 –¥–æ 100\n"
                        "‚Ä¢ `.roll 50 100` ‚Äî –æ—Ç 50 –¥–æ 100"
                    )
                elif "–î–∏–∞–ø–∞–∑–æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π" in error_text:
                    error_message = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –î–∏–∞–ø–∞–∑–æ–Ω —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π. –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ä–∞–∑–Ω–∏—Ü–∞: 1,000,000"
                else:
                    error_message = (
                        "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã.\n\n"
                        "**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∏—Å–ª–∞!**\n"
                        "**–ü—Ä–∏–º–µ—Ä—ã:**\n"
                        "‚Ä¢ `.roll` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)\n"
                        "‚Ä¢ `.roll 100` (–æ—Ç 0 –¥–æ 100)\n"
                        "‚Ä¢ `.roll 50 100` (–æ—Ç 50 –¥–æ 100)"
                    )
                
                new_params = self.Dont65Utils.reply_with_style(
                    params,
                    body=error_message,
                    header=None,
                    source=None,
                    quote='block'
                )
                
                return HookResult(strategy=HookStrategy.MODIFY_FINAL, params=new_params)

        except Exception:
            log(f"[{__id__}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:\n{traceback.format_exc()}")
        
        return HookResult()

    def on_plugin_unload(self):
        pass