"""
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
 â•šâ•â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘
â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
â•šâ•â•â•â•â•â•   â•šâ•â•â•â•  â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â•â•šâ•â•â•â•â•â•â•   â•šâ•â•    â•šâ•â•â•â•â•â•    â•šâ•â•   â•šâ•â•  â•šâ•â•   

                                â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
                               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘
                               â–‘â–ˆâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–ˆâ–‘
                               â–‘â–ˆâ•‘ âš–ï¸  Ğ›Ğ˜Ğ¦Ğ•ĞĞ—Ğ˜Ğ ĞĞ’ĞĞĞ ĞŸĞĞ” MIT âš–ï¸   â•‘â–ˆâ–‘
                               â–‘â–ˆâ•‘     Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞĞ˜Ğ• Ğ ĞĞ—Ğ Ğ•Ğ¨Ğ•ĞĞ     â•‘â–ˆâ–‘
                               â–‘â–ˆâ•‘   Â©ï¸ 2025 Ğ¡Ğ²Ğ°Ğ³Ğ°ĞĞµĞ¢ÑƒÑ‚Ğ° Corp.     â•‘â–ˆâ–‘
                               â–‘â–ˆâ•‘                                â•‘â–ˆâ–‘
                               â–‘â–ˆâ•‘  ğŸ”’ Ğ—ĞĞ©Ğ˜Ğ©Ğ•ĞĞ ĞĞ’Ğ¢ĞĞ Ğ¡ĞšĞ˜Ğœ ĞŸĞ ĞĞ’ĞĞœ  â•‘â–ˆâ–‘
                               â–‘â–ˆâ•‘     â­ ĞŸĞ Ğ•ĞœĞ˜Ğ£Ğœ ĞšĞĞ§Ğ•Ğ¡Ğ¢Ğ’Ğ â­     â•‘â–ˆâ–‘
                               â–‘â–ˆâ•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â–ˆâ–‘
                               â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘
                                â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘
                                
                                
                            	â–‘â–‘â–’â–’â–“â–“â–ˆâ–ˆ ĞŸĞĞ”ĞŸĞ˜Ğ¡Ğ¬ Ğ¡ĞĞ—Ğ”ĞĞ¢Ğ•Ğ›Ğ¯ â–ˆâ–ˆâ–“â–“â–’â–’â–‘â–‘
                                    	Ğ¡Ğ²Ğ°Ğ³Ğ°ĞĞµĞ¢ÑƒÑ‚Ğ° â„¢
                              	âš–ï¸ ğŸ“‹ ğŸ” Â©ï¸ Â® â„¢ â­ ğŸ–ï¸ ğŸ…
                            	Ğ’ÑĞµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ñ‹ â€¢ 2025 Ğ³Ğ¾Ğ´
"""
import re
import requests
import concurrent.futures
from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import run_on_queue, send_message, get_last_fragment
from android_utils import run_on_ui_thread, log
from ui.alert import AlertDialogBuilder
from ui.settings import Header, Switch


__id__ = "link_shortener"
__name__ = "Link Shortener"
__description__ = "ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾ĞºÑ€Ğ°Ñ‰Ğ°ĞµÑ‚ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ² Ğ¸ÑÑ…Ğ¾Ğ´ÑÑ‰Ğ¸Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸ÑÑ… Ñ‡ĞµÑ€ĞµĞ· clck.ru."
__author__ = "Ğ¡Ğ²Ğ°Ğ³Ğ°ĞĞµĞ¢ÑƒÑ‚Ğ° @swagnonher"
__version__ = "1.0"
__min_version__ = "10.14.4"
__icon__ = "Swagapluginsicon/0" # ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ ĞºĞ¸Ğ´Ğ°ĞµÑˆÑŒ ÑÑ‚Ğ¸Ğº. Ğ½Ğ°Ğ¶Ğ¸Ğ¼Ğ°ĞµÑˆÑŒ Ğ½Ğ° Ğ½ĞµĞ³Ğ¾. Ğ¿Ğ¾Ğ´ĞµĞ»Ğ¸Ñ‚ÑŒÑÑ! Ñ‚Ğ°Ğ¼ Ğ±ÑƒĞ´ĞµÑ‚ "https://t.me/addstickers/exteraicons" Ñ‚ĞµĞ±Ğµ Ğ½Ğ°Ğ´Ğ¾ Ğ²Ğ·ÑÑ‚ÑŒ Ğ¿Ğ¾ÑĞ»ĞµĞ´Ğ½Ğ¸Ğµ ÑĞ»Ğ¾Ğ²Ğ¾ "exteraicons" Ğ¸ Ğ´Ğ°Ğ»ĞµĞµ ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ÑˆÑŒ ĞºĞ°ĞºĞ¾Ğ¹ ÑÑ‚Ğ¸Ğº Ñ…Ğ¾Ñ‡ Ğ´Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ˜Ğ˜Ğ˜ Ğ´Ğ¾Ğ±Ğ¾Ğ²Ğ»ÑÑˆÑŒ +1 Ğ½Ğ° Ğ²ÑÑĞºĞ¸Ğ¹! ĞºÑÑ‚Ğ°Ñ‚Ğ¸ Ğ·Ğ°Ğ¹Ğ´Ğ¸ Ğ² Ğ±Ğ¾Ñ‚Ğ° ÑĞ¾ ÑÑ‚Ğ¸ĞºĞ°Ğ¼Ğ¸ (Ğ½Ñƒ Ğ³Ğ»Ğµ ÑĞ¾Ğ·Ğ´Ğ°Ğ²Ğ°Ñ‚ÑŒ) Ñ Ñ‚Ğ°Ğ¼ ĞµÑ‰Ğµ Ğ½Ğ°Ğ´ĞµĞ»Ğ°Ğ» Ñ‚ĞµĞ±Ğµ Ğ½Ğ° Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°!

# --- ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ²Ğ¾Ñ‚ Ñ‚ÑƒÑ‚ Ñƒ Ğ½Ğ°Ñ Ñ‡Ñ‚Ğ¾Ñ‚Ğ¾ Ñ‚Ğ¸Ğ¿Ğ¾ Ñ‚Ñ€Ğ¸Ğ³ĞµÑ€Ğ¾Ğ²... Ñ Ğ¸ ÑĞ°Ğ¼ Ğ½ĞµĞ´Ğ¾ĞºĞ¾Ğ½Ñ†Ğ° Ğ¿Ğ¾Ğ½ÑĞ» ĞºĞ°Ğº Ğ¾Ğ½Ğ¾ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚(( Ñ‚Ğ°Ğº Ñ‡Ñ‚Ğ¾ Ğ»ÑƒÑ‡ÑˆĞµ Ğ½Ğµ Ñ‚Ñ€Ğ¾Ğ³Ğ°Ğ¹ ---
URL_REGEX = r'(?i)\b(?:https?://|www\.)?[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}(?:/[^\s]*)?'

# --- Ñ‚ÑƒÑ‚ Ñƒ Ğ½Ğ°Ñ ÑĞ½Ğ¿Ğ¾Ğ¸Ğ½Ñ‚ ---
API_ENDPOINT = 'https://clck.ru/--'

# Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ!! Ğ´Ğ°Ğ»ÑŒÑˆĞµ Ñ Ğ´ĞµĞ»Ğ°Ğ» ĞºĞ¾Ğ¼Ğ°Ğ½Ñ‚Ğ°Ñ€Ğ¸Ğ¹ Ğ²Ğ¾ Ğ²Ñ€ĞµĞ¼Ñ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ ĞºĞ¾Ğ´Ğ° Ğ¿Ğ¾ÑÑ‚Ğ¾Ğ¼Ñƒ ÑĞ°Ğ¼ Ñ‡ÑƒÑ‚ĞºĞ° Ğ½Ğµ ĞµĞ±Ñƒ Ñ‡Ğ¾ Ñ‚Ğ°Ğ¼... Ñ‚Ğ°Ğº Ñ‡Ñ‚Ğ¾ Ğ¿Ñ€Ğ¸Ğ´ĞµÑ‚ÑŒÑÑ Ğ² Ğ½ĞµĞ¹Ñ€Ğ¾Ğ½ĞºÑƒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ


class LinkShortenerPlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self.progress_dialog = None

    def on_plugin_load(self):
        """Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°."""
        self.add_on_send_message_hook()
        log("Link Shortener plugin loaded")

    def on_plugin_unload(self):
        """
        Ğ’Ñ‹Ğ·Ñ‹Ğ²Ğ°ĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞµ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°.
        ĞÑ‡Ğ¸ÑÑ‚ĞºĞ° Ñ…ÑƒĞºĞ¾Ğ² Ğ¿Ñ€Ğ¾Ğ¸ÑÑ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸.
        """
        log("Link Shortener plugin unloaded")

    def create_settings(self):
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµÑ‚ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº Ğ´Ğ»Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°."""
        return [
            Header(text="ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ ÑĞ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ñ ÑÑÑ‹Ğ»Ğ¾Ğº"),
            Switch(
                key="enabled",
                text="Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ÑĞ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ ÑÑÑ‹Ğ»Ğ¾Ğº",
                subtext="ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ ÑĞ¾ĞºÑ€Ğ°Ñ‰Ğ°Ñ‚ÑŒ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞµ.",
                default=True
            )
        ]

    def on_send_message_hook(self, account, params):
        """
        ĞŸĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºÑƒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ.
        """
        if not self.get_setting("enabled", True):
            return HookResult()

        if not hasattr(params, "message") or not isinstance(params.message, str):
            return HookResult()
        message_text = params.message
        
        if not message_text:
            return HookResult()

        # --- Ğ›Ğ¾Ğ³Ğ¸ĞºĞ° Ğ¿Ğ¾Ğ¸ÑĞºĞ° ÑÑÑ‹Ğ»Ğ¾Ğº ---
        urls_to_shorten = [
            url for url in re.findall(URL_REGEX, message_text)
            if "clck.ru" not in url
        ]

        if not urls_to_shorten:
            return HookResult()

        try:
            context = get_last_fragment().getParentActivity()
            self.progress_dialog = AlertDialogBuilder(
                context,
                AlertDialogBuilder.ALERT_TYPE_SPINNER
            )
            self.progress_dialog.set_message("Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ ÑÑÑ‹Ğ»Ğ¾Ğº...")
            self.progress_dialog.set_cancelable(False)
            self.progress_dialog.show()
        except Exception as e:
            log(f"Failed to show progress dialog: {e}")
            self.progress_dialog = None

        run_on_queue(lambda: self._process_shortening(message_text, urls_to_shorten, params))

        return HookResult(strategy=HookStrategy.CANCEL)

    def _shorten_link(self, url):
        """ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ½Ğ° ÑĞ¾ĞºÑ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞ¸."""
        try:
            # Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ http:// ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚, Ñ‚.Ğº. API ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ´Ğ»Ñ ÑÑÑ‹Ğ»Ğ¾Ğº Ñ‚Ğ¸Ğ¿Ğ° ficbook.net
            full_url = url if url.startswith(('http://', 'https://')) else 'http://' + url
            response = requests.get(API_ENDPOINT, params={'url': full_url}, timeout=5)
            response.raise_for_status()
            short_url = response.text.strip()
            if short_url.startswith("https://clck.ru/"):
                return short_url
        except requests.RequestException as e:
            log(f"Failed to shorten link {url}: {e}")
        return url

    def _process_shortening(self, original_text, urls_to_shorten, original_params):
        """
        Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ² Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ. Ğ¡Ğ¾ĞºÑ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ğ²ÑĞµ ÑÑÑ‹Ğ»ĞºĞ¸.
        """
        modified_text = original_text
        with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
            future_to_url = {executor.submit(self._shorten_link, url): url for url in set(urls_to_shorten)}
            for future in concurrent.futures.as_completed(future_to_url):
                original_url = future_to_url[future]
                try:
                    shortened_url = future.result()
                    if original_url != shortened_url:
                        modified_text = modified_text.replace(original_url, shortened_url)
                except Exception as e:
                    log(f"Exception processing url {original_url}: {e}")

        run_on_ui_thread(lambda: self._send_and_dismiss(modified_text, original_params))

    def _send_and_dismiss(self, final_message, original_params):
        """
        Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµÑ‚ÑÑ Ğ² UI-Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞµ. Ğ—Ğ°ĞºÑ€Ñ‹Ğ²Ğ°ĞµÑ‚ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³ Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ½Ğ¾Ğ²Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ.
        """
        if self.progress_dialog:
            try:
                self.progress_dialog.dismiss()
            except Exception as e:
                log(f"Failed to dismiss dialog: {e}")
            finally:
                self.progress_dialog = None
        
        new_params = {
            "peer": getattr(original_params, "peer", None),
            "message": final_message,
            "replyToMsg": getattr(original_params, "replyToMsg", None),
            "scheduleDate": getattr(original_params, "scheduleDate", 0)
        }
        
        send_message(new_params)
        
