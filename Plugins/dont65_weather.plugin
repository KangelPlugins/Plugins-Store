# –§–∞–π–ª: dont65_weather.py
# –ü–ª–∞–≥–∏–Ω: Weather & Space Monitor
# –ê–≤—Ç–æ—Ä: @dont65 (idea), Gemini (code)
# –í–µ—Ä—Å–∏—è 1.1.0 - –î–æ–±–∞–≤–ª–µ–Ω API –º–∞–≥–Ω–∏—Ç–Ω—ã—Ö –±—É—Ä—å
# –¢—Ä–µ–±—É–µ—Ç: Dont65 Library (dont65_lib)

from base_plugin import BasePlugin, HookResult, HookStrategy
from ui.settings import Header, Divider, Text, Switch, Input
import json
import urllib.request
import urllib.parse
import traceback
import time
import re

__name__ = "Weather Monitor"
__description__ = "üå§ –ü–æ–≥–æ–¥–∞ –∏ –º–∞–≥–Ω–∏—Ç–Ω—ã–µ –±—É—Ä–∏.\n–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: `.weather [–≥–æ—Ä–æ–¥]`"
__icon__ = "SunAndCloud/4" 
__version__ = "1.1.0"
__id__ = "dont65_weather"
__author__ = "@dont65"

class WeatherPlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self.Dont65Utils = None
        self.lib_missing = False
        self._check_library()
        self.kp_cache = None
        self.kp_cache_time = 0
        self.forecast_cache = None
        self.forecast_cache_time = 0

    def _check_library(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"""
        try:
            from dont65_lib import Dont65Utils
            self.Dont65Utils = Dont65Utils
            self.lib_missing = False
            from client_utils import log
            log(f"[{__id__}] –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ Dont65Lib –∑–∞–≥—Ä—É–∂–µ–Ω–∞")
        except ImportError:
            self.lib_missing = True
            from client_utils import log
            log(f"[{__id__}] –û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ dont65_lib –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    def create_settings(self):
        """–°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø–ª–∞–≥–∏–Ω–∞"""
        settings = [
            Header("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–≥–æ–¥—ã"),
            Text("–ü–ª–∞–≥–∏–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø–æ–≥–æ–¥—É –∏ –º–∞–≥–Ω–∏—Ç–Ω—ã–µ –±—É—Ä–∏."),
            Divider()
        ]
        
        if self.lib_missing:
            settings.extend([
                Text("‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è Dont65 Library!"),
                Divider(text="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω dont65_lib –¥–ª—è —Ä–∞–±–æ—Ç—ã"),
                Divider(),
                Divider(text="–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç")
            ])
        else:
            settings.extend([
                Switch(key="enable_plugin", text="–í–∫–ª—é—á–∏—Ç—å –ø–ª–∞–≥–∏–Ω (.weather)", default=True),
                Switch(key="show_magnetic", text="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –º–∞–≥–Ω–∏—Ç–Ω—ã–µ –±—É—Ä–∏", default=False),
                Switch(key="show_forecast", text="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥–Ω–æ–∑ –±—É—Ä—å", default=False),
                Input(
                    key="default_city",
                    text="–ì–æ—Ä–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é",
                    subtext="–ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞—Ç—å –≥–æ—Ä–æ–¥ –≤ –∫–æ–º–∞–Ω–¥–µ",
                    default="–ú–æ—Å–∫–≤–∞"
                ),
                Divider(text="–ü—Ä–∏–º–µ—Ä—ã –∫–æ–º–∞–Ω–¥:\n.weather –ú–æ—Å–∫–≤–∞\n.weather London\n.weather (–ø–æ–∫–∞–∂–µ—Ç –≥–æ—Ä–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)"),
                Divider(),
                Text("–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–∞–Ω–Ω—ã—Ö:\n‚Ä¢ –ü–æ–≥–æ–¥–∞: Open-Meteo\n‚Ä¢ –ú–∞–≥–Ω–∏—Ç–Ω—ã–µ –±—É—Ä–∏: NOAA (–°–®–ê)")
            ])
        
        return settings

    def _get_json(self, url):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ JSON –¥–∞–Ω–Ω—ã—Ö –∏–∑ API"""
        req = urllib.request.Request(
            url, 
            headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
        )
        with urllib.request.urlopen(req, timeout=10) as response:
            return json.loads(response.read().decode('utf-8'))

    def _get_text_data(self, url):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö"""
        req = urllib.request.Request(
            url,
            headers={'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
        )
        with urllib.request.urlopen(req, timeout=10) as response:
            return response.read().decode('utf-8')

    def _get_kp_index(self):
        """–ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π Kp-–∏–Ω–¥–µ–∫—Å –º–∞–≥–Ω–∏—Ç–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ (0-9)"""
        # –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 10 –º–∏–Ω—É—Ç
        if time.time() - self.kp_cache_time < 600 and self.kp_cache:
            return self.kp_cache
        
        try:
            # –û—Å–Ω–æ–≤–Ω–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ - NOAA (–°–®–ê)
            url = "https://services.swpc.noaa.gov/products/noaa-estimated-planetary-k-index.json"
            data = self._get_json(url)
            
            # –î–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: ["2024-03-15 12:00:00.000", "3.67"]
            # –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è
            kp_values = []
            count = 0
            
            # –ò–¥–µ–º —Å –∫–æ–Ω—Ü–∞ –º–∞—Å—Å–∏–≤–∞ (—Å–∞–º—ã–µ —Å–≤–µ–∂–∏–µ –¥–∞–Ω–Ω—ã–µ)
            for row in reversed(data):
                if len(row) >= 2 and row[1]:
                    try:
                        kp_value = float(row[1])
                        kp_values.append(kp_value)
                        count += 1
                        if count >= 3:  # –ë–µ—Ä–µ–º 3 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏—è
                            break
                    except (ValueError, TypeError):
                        continue
            
            if kp_values:
                current_kp = sum(kp_values) / len(kp_values)
                
                # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ —à–∫–∞–ª–µ NOAA
                if current_kp >= 5:
                    if current_kp < 6:
                        storm_level = "G1 (–°–ª–∞–±–∞—è)"
                        status = "üö® –ú–∞–≥–Ω–∏—Ç–Ω–∞—è –±—É—Ä—è"
                    elif current_kp < 7:
                        storm_level = "G2 (–£–º–µ—Ä–µ–Ω–Ω–∞—è)"
                        status = "üö®üö® –°—Ä–µ–¥–Ω—è—è –±—É—Ä—è"
                    elif current_kp < 8:
                        storm_level = "G3 (–°–∏–ª—å–Ω–∞—è)"
                        status = "üö®üö®üö® –°–∏–ª—å–Ω–∞—è –±—É—Ä—è"
                    elif current_kp < 9:
                        storm_level = "G4 (–û—á–µ–Ω—å —Å–∏–ª—å–Ω–∞—è)"
                        status = "üî•üî• –û—á–µ–Ω—å —Å–∏–ª—å–Ω–∞—è –±—É—Ä—è"
                    else:
                        storm_level = "G5 (–≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è)"
                        status = "üíÄüíÄüíÄ –≠–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–∞—è –±—É—Ä—è"
                elif current_kp >= 4:
                    storm_level = "–í–æ–∑–º—É—â–µ–Ω–Ω–æ"
                    status = "‚ö†Ô∏è –ù–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ"
                else:
                    storm_level = "–°–ø–æ–∫–æ–π–Ω–æ"
                    status = "‚úÖ –°—Ç–∞–±–∏–ª—å–Ω–æ"
                
                result = f"Kp {current_kp:.1f} ‚Äî {status}"
                self.kp_cache = result
                self.kp_cache_time = time.time()
                return result
            
        except Exception as e:
            # –†–µ–∑–µ—Ä–≤–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ - —Ç–µ–∫—Å—Ç–æ–≤–∞—è –≤–µ—Ä—Å–∏—è
            try:
                from client_utils import log
                log(f"[{__id__}] –û—Å–Ω–æ–≤–Ω–æ–π Kp API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –ø—Ä–æ–±—É–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–π: {e}")
                
                backup_url = "https://services.swpc.noaa.gov/text/3-day-geomag-forecast.txt"
                text_data = self._get_text_data(backup_url)
                
                # –ü–∞—Ä—Å–∏–º Kp-–∏–Ω–¥–µ–∫—Å –∏–∑ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø—Ä–æ–≥–Ω–æ–∑–∞
                lines = text_data.split('\n')
                for line in lines:
                    if '00-03UT' in line or '03-06UT' in line:
                        parts = line.split()
                        for part in parts:
                            if part.replace('.', '').isdigit():
                                try:
                                    kp_value = float(part)
                                    if 0 <= kp_value <= 9:
                                        if kp_value >= 5:
                                            status = "üö® –ë—É—Ä—è"
                                        elif kp_value >= 4:
                                            status = "‚ö†Ô∏è –í–æ–∑–º—É—â–µ–Ω–Ω–æ"
                                        else:
                                            status = "‚úÖ –°–ø–æ–∫–æ–π–Ω–æ"
                                        
                                        result = f"Kp {kp_value} ‚Äî {status}"
                                        self.kp_cache = result
                                        self.kp_cache_time = time.time()
                                        return result
                                except ValueError:
                                    continue
                
            except Exception as backup_error:
                from client_utils import log
                log(f"[{__id__}] –û—à–∏–±–∫–∞ —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ Kp: {backup_error}")
        
        return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –º–∞–≥–Ω–∏—Ç–Ω—ã—Ö –±—É—Ä—è—Ö"

    def _get_magnetic_forecast(self):
        """–ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥–Ω–æ–∑ –º–∞–≥–Ω–∏—Ç–Ω—ã—Ö –±—É—Ä—å –Ω–∞ 3 –¥–Ω—è"""
        # –ö—ç—à–∏—Ä—É–µ–º –Ω–∞ 1 —á–∞—Å (–ø—Ä–æ–≥–Ω–æ–∑ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —Ä–µ–∂–µ)
        if time.time() - self.forecast_cache_time < 3600 and self.forecast_cache:
            return self.forecast_cache
        
        try:
            # 3-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ –æ—Ç NOAA
            url = "https://services.swpc.noaa.gov/text/3-day-geomag-forecast.txt"
            text_data = self._get_text_data(url)
            
            lines = text_data.split('\n')
            forecast_text = ""
            parsing = False
            
            for line in lines:
                # –ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Å–∏–Ω–≥ –ø–æ—Å–ª–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞
                if "NOAA Kp index forecast" in line:
                    parsing = True
                    continue
                    
                if parsing and line.strip() and not line.startswith("#"):
                    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
                    if any(x in line for x in ["00-03UT", "03-06UT", "06-09UT", "09-12UT", 
                                                "12-15UT", "15-18UT", "18-21UT", "21-00UT"]):
                        parts = line.split()
                        if len(parts) >= 3:
                            time_range = parts[0]
                            day1 = parts[1] if len(parts) > 1 else "?"
                            day2 = parts[2] if len(parts) > 2 else "?"
                            day3 = parts[3] if len(parts) > 3 else "?"
                            
                            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —ç–º–æ–¥–∑–∏ –¥–ª—è —É—Ä–æ–≤–Ω—è
                            def get_kp_emoji(kp_str):
                                try:
                                    kp = float(kp_str)
                                    if kp >= 5:
                                        return "üî¥"
                                    elif kp >= 4:
                                        return "üü°"
                                    else:
                                        return "üü¢"
                                except:
                                    return "‚ö™"
                            
                            forecast_text += f"{time_range}: {get_kp_emoji(day1)} {day1} | {get_kp_emoji(day2)} {day2} | {get_kp_emoji(day3)} {day3}\n"
            
            if forecast_text:
                # –û–±—Ä–µ–∑–∞–µ–º –¥–æ –ø–µ—Ä–≤—ã—Ö 8 –ø–µ—Ä–∏–æ–¥–æ–≤
                forecast_lines = forecast_text.strip().split('\n')[:8]
                result = "\n".join(forecast_lines)
                self.forecast_cache = result
                self.forecast_cache_time = time.time()
                return result
                
        except Exception as e:
            from client_utils import log
            log(f"[{__id__}] –û—à–∏–±–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∞ –±—É—Ä—å: {e}")
        
        return "–ù–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞ –±—É—Ä—å"

    def on_plugin_load(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –ø–ª–∞–≥–∏–Ω–∞"""
        if not self.lib_missing:
            self.add_on_send_message_hook(priority=200)

    def on_send_message_hook(self, account, params):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π"""
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            if self.lib_missing:
                msg_text = params.message or params.caption or ""
                if msg_text.strip().startswith('.weather'):
                    header = "‚ùå –û—à–∏–±–∫–∞"
                    body = "–¢—Ä–µ–±—É–µ—Ç—Å—è Dont65 Library!\n–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω `dont65_lib` –¥–ª—è —Ä–∞–±–æ—Ç—ã Weather Monitor."
                    params.message = f"**{header}**\n{body}"
                    return HookResult(strategy=HookStrategy.MODIFY, params=params)
                return HookResult()

            if not self.get_setting("enable_plugin", True):
                return HookResult()

            msg_text = ""
            is_caption = False
            
            if hasattr(params, 'message') and params.message:
                msg_text = params.message
            elif hasattr(params, 'caption') and params.caption:
                msg_text = params.caption
                is_caption = True
            
            if not msg_text or not msg_text.lower().strip().startswith(".weather"):
                return HookResult()

            # –ü–æ–ª—É—á–∞–µ–º –∞—Ä–≥—É–º–µ–Ω—Ç—ã –∫–æ–º–∞–Ω–¥—ã
            args = msg_text[8:].strip()  # –£–±–∏—Ä–∞–µ–º ".weather "
            
            # –ï—Å–ª–∏ –≥–æ—Ä–æ–¥ –Ω–µ —É–∫–∞–∑–∞–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ä–æ–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            city_name = args if args else self.get_setting("default_city", "–ú–æ—Å–∫–≤–∞")
            
            if not city_name:
                body = "‚ùå –£–∫–∞–∂–∏—Ç–µ –≥–æ—Ä–æ–¥.\n–ü—Ä–∏–º–µ—Ä: `.weather –ú–æ—Å–∫–≤–∞`"
                header = "–û—à–∏–±–∫–∞"
            else:
                try:
                    # 1. –ì–µ–æ–∫–æ–¥–∏–Ω–≥ (–ù–∞—Ö–æ–¥–∏–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≥–æ—Ä–æ–¥–∞)
                    geo_url = f"https://geocoding-api.open-meteo.com/v1/search?name={urllib.parse.quote(city_name)}&count=1&language=ru"
                    geo_data = self._get_json(geo_url)
                    
                    if not geo_data.get("results"):
                        body = f"‚ùå –ì–æ—Ä–æ–¥ **{city_name}** –Ω–µ –Ω–∞–π–¥–µ–Ω.\n–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è."
                        header = "–û—à–∏–±–∫–∞"
                    else:
                        res = geo_data["results"][0]
                        lat, lon = res["latitude"], res["longitude"]
                        display_name = f"{res.get('name', '')}"
                        if res.get('admin1'):
                            display_name += f", {res.get('admin1')}"
                        if res.get('country'):
                            display_name += f", {res.get('country')}"

                        # 2. –ü–æ–ª—É—á–∞–µ–º –ø–æ–≥–æ–¥—É
                        weather_url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current_weather=true&timezone=auto&windspeed_unit=ms"
                        w_data = self._get_json(weather_url)
                        current = w_data["current_weather"]
                        
                        temp = current["temperature"]
                        wind = current["windspeed"]
                        wind_direction = current.get("winddirection", 0)
                        
                        # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ—Ç—Ä–∞ –≤ —Ç–µ–∫—Å—Ç
                        directions = ["–°", "–°–í", "–í", "–Æ–í", "–Æ", "–Æ–ó", "–ó", "–°–ó"]
                        idx = round(wind_direction / 45) % 8
                        wind_dir_text = directions[idx]
                        
                        # 3. –ú–∞–≥–Ω–∏—Ç–Ω—ã–µ –±—É—Ä–∏ (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
                        magnetic_info = ""
                        if self.get_setting("show_magnetic", True):
                            kp_info = self._get_kp_index()
                            magnetic_info = f"üß≤ –ú–∞–≥–Ω–∏—Ç–Ω—ã–π —Ñ–æ–Ω: `{kp_info}`\n"
                        
                        # 4. –ü—Ä–æ–≥–Ω–æ–∑ –±—É—Ä—å (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö)
                        forecast_info = ""
                        if self.get_setting("show_forecast", True):
                            forecast = self._get_magnetic_forecast()
                            if forecast and "–ù–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑–∞" not in forecast:
                                forecast_info = f"\nüìÖ **–ü—Ä–æ–≥–Ω–æ–∑ –±—É—Ä—å –Ω–∞ 3 –¥–Ω—è:**\n```\n{forecast}\n```\n*üü¢ <4 üü° 4-4.9 üî¥ ‚â•5*"
                        
                        # –§–æ—Ä–º–∏—Ä—É–µ–º –≤—ã–≤–æ–¥
                        header = f"üå§ {display_name}"
                        body = (
                            f"üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: `{temp:.1f}¬∞C`\n"
                            f"üí® –í–µ—Ç–µ—Ä: `{wind:.1f} –º/—Å {wind_dir_text}`\n"
                            f"{magnetic_info}"
                            f"üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: `{lat:.2f}¬∞, {lon:.2f}¬∞`"
                            f"{forecast_info}"
                        )
                        
                except urllib.error.URLError as url_err:
                    body = f"‚ùå –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É: {url_err}"
                    header = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"
                except json.JSONDecodeError as json_err:
                    body = f"‚ùå –û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö API: {json_err}"
                    header = "–û—à–∏–±–∫–∞ –¥–∞–Ω–Ω—ã—Ö"
                except Exception as e:
                    from client_utils import log
                    log(f"[{__id__}] –û—à–∏–±–∫–∞ –ø–æ–≥–æ–¥—ã: {str(e)}")
                    body = f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {str(e)[:100]}..."
                    header = "–û—à–∏–±–∫–∞"

            # –ò—Å–ø–æ–ª—å–∑—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—ã–≤–æ–¥–∞
            if not self.lib_missing and self.Dont65Utils:
                new_params = self.Dont65Utils.reply_with_style(
                    params,
                    body=body,
                    header=header,
                    source=None,
                    quote='block'
                )
                return HookResult(strategy=HookStrategy.MODIFY_FINAL, params=new_params)
            else:
                # –ï—Å–ª–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç
                if is_caption:
                    params.caption = f"**{header}**\n\n{body}"
                else:
                    params.message = f"**{header}**\n\n{body}"
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

        except Exception:
            from client_utils import log
            log(f"[{__id__}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:\n{traceback.format_exc()}")
            return HookResult()