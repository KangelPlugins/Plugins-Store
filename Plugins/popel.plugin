__id__ = "xo_tic_tac_toe_game"
__name__ = "XO Tic-Tac-Toe"
__description__ = "Play Tic-Tac-Toe (X and O) with friends in any chat"
__author__ = "GameDev"
__version__ = "1.0.0"
__min_version__ = "11.9.1"
__icon__ = "AnimatedEmojis/0"

from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import get_send_messages_helper
from android_utils import run_on_ui_thread
import time
import random

class XOGame:
    """Tic-Tac-Toe game instance"""
    
    def __init__(self, player1: int, player2: int, chat_id: int):
        self.player_x = player1
        self.player_o = player2
        self.chat_id = chat_id
        self.board = [' ' for _ in range(9)]
        self.current_player = 'X'
        self.message_id = None
        self.created_time = time.time()
        self.winner = None
        self.game_over = False
    
    def make_move(self, player_id: int, position: int) -> bool:
        """Make a move on the board (position 0-8)"""
        if self.game_over:
            return False
            
        if (self.current_player == 'X' and player_id != self.player_x) or \
           (self.current_player == 'O' and player_id != self.player_o):
            return False
            
        if position < 0 or position > 8 or self.board[position] != ' ':
            return False
            
        self.board[position] = self.current_player
        
        if self.check_winner():
            self.winner = self.current_player
            self.game_over = True
        elif self.is_board_full():
            self.game_over = True
        else:
            self.current_player = 'O' if self.current_player == 'X' else 'X'
            
        return True
    
    def check_winner(self) -> bool:
        """Check if there's a winner"""
        winning_combinations = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ]
        
        for combo in winning_combinations:
            if (self.board[combo[0]] == self.board[combo[1]] == 
                self.board[combo[2]] != ' '):
                return True
        return False
    
    def is_board_full(self) -> bool:
        """Check if board is full (draw)"""
        return ' ' not in self.board
    
    def get_board_display(self) -> str:
        """Convert board to visual representation"""
        board_chars = []
        for i, cell in enumerate(self.board):
            if cell == ' ':
                board_chars.append(str(i + 1))
            else:
                board_chars.append(cell)
        
        return (
            f"{board_chars[0]} | {board_chars[1]} | {board_chars[2]}\n"
            f"--+---+--\n"
            f"{board_chars[3]} | {board_chars[4]} | {board_chars[5]}\n"
            f"--+---+--\n"
            f"{board_chars[6]} | {board_chars[7]} | {board_chars[8]}"
        )

class XOTicTacToePlugin(BasePlugin):
    """Main plugin class for XO Tic-Tac-Toe game"""
    
    def __init__(self):
        super().__init__()
        self.active_games = {}  # chat_id -> game
    
    def on_plugin_load(self):
        """Called when plugin is loaded"""
        self.add_on_send_message_hook()
    
    def on_send_message_hook(self, account, params):
        """Handle incoming messages for game commands"""
        if not hasattr(params, 'message') or not isinstance(params.message, str):
            return HookResult()
        
        text = params.message.strip()
        
        # Get chat ID from message
        chat_id = self._get_chat_id(params)
        if not chat_id:
            return HookResult()
        
        # Get user ID from message  
        user_id = self._get_user_id(params)
        if not user_id:
            return HookResult()
        
        if text.startswith('/xostart'):
            self._start_game(chat_id, user_id, text, params)
            return HookResult(strategy=HookStrategy.CANCEL)
            
        elif text.startswith('/xomove'):
            self._make_move(chat_id, user_id, text, params)
            return HookResult(strategy=HookStrategy.CANCEL)
            
        elif text.startswith('/xostop'):
            self._stop_game(chat_id, user_id, params)
            return HookResult(strategy=HookStrategy.CANCEL)
            
        elif text.startswith('/xohelp'):
            self._show_help(chat_id, params)
            return HookResult(strategy=HookStrategy.CANCEL)
        
        return HookResult()
    
    def _get_chat_id(self, params):
        """Extract chat ID from message params"""
        try:
            peer = getattr(params, 'peer', None)
            if not peer:
                return None
            
            # Try different attribute names that might contain chat ID
            for attr in ['chat_id', 'user_id', 'channel_id']:
                if hasattr(peer, attr):
                    return getattr(peer, attr)
            
            # If none found, try to get from peer directly
            if hasattr(peer, 'value'):
                return peer.value
                
        except:
            pass
        return None
    
    def _get_user_id(self, params):
        """Extract user ID from message params"""
        try:
            # Try different attribute names for user ID
            for attr in ['from_id', 'user_id', 'sender_id']:
                if hasattr(params, attr):
                    return getattr(params, attr)
        except:
            pass
        return None
    
    def _send_message(self, chat_id, text, original_params=None):
        """Send message to chat using the same method as debug plugin"""
        try:
            # Create new params for sending message
            if original_params:
                # Copy the structure from original params
                params = type(original_params)()
                params.peer = original_params.peer
                params.message = text
                params.replyToMsg = getattr(original_params, 'replyToMsg', None)
                params.replyToTopMsg = getattr(original_params, 'replyToTopMsg', None)
            else:
                # Create minimal params if no original
                class SimpleParams:
                    def __init__(self, chat_id, text):
                        self.peer = type('Peer', (), {'chat_id': chat_id})()
                        self.message = text
                params = SimpleParams(chat_id, text)
            
            send_helper = get_send_messages_helper()
            result = send_helper.sendMessage(params)
            return result
        except Exception as e:
            return None
    
    def _start_game(self, chat_id: int, user_id: int, text: str, params):
        """Start a new XO game"""
        try:
            if chat_id in self.active_games:
                self._send_message(chat_id, "âŒ Game already running in this chat! Use /xostop to end it.", params)
                return
            
            opponent_id = -1  # Bot by default
            
            # Create new game
            game = XOGame(user_id, opponent_id, chat_id)
            self.active_games[chat_id] = game
            
            # Send initial board
            board_text = self._format_game_message(game)
            result = self._send_message(chat_id, board_text, params)
            
            # Try to get message ID for future edits
            if result and hasattr(result, 'id'):
                game.message_id = result.id
            
            self._send_message(chat_id, "ğŸ® XO Game started! Use `/xomove 1-9` to make moves", params)
            
        except Exception as e:
            self._send_message(chat_id, f"âŒ Failed to start game: {str(e)}", params)
    
    def _make_move(self, chat_id: int, user_id: int, text: str, params):
        """Process a move in the game"""
        try:
            if chat_id not in self.active_games:
                self._send_message(chat_id, "âŒ No active game in this chat. Use `/xostart` to begin.", params)
                return
            
            game = self.active_games[chat_id]
            
            parts = text.split()
            if len(parts) < 2:
                self._send_message(chat_id, "ğŸ“ Usage: `/xomove [1-9]` - Use numbers 1-9 for positions", params)
                return
            
            try:
                position = int(parts[1]) - 1  # Convert to 0-8
            except ValueError:
                self._send_message(chat_id, "âŒ Please use a number from 1 to 9", params)
                return
            
            if game.make_move(user_id, position):
                board_text = self._format_game_message(game)
                
                # For now, just send new message since editing is complex
                self._send_message(chat_id, board_text, params)
                
                if game.game_over:
                    if game.winner:
                        winner_name = "You" if game.winner == 'X' else "Bot"
                        self._send_message(chat_id, f"ğŸ‰ Game Over! {winner_name} win!", params)
                    else:
                        self._send_message(chat_id, "ğŸ¤ Game Over! It's a draw!", params)
                    
                    # Clean up game
                    if chat_id in self.active_games:
                        del self.active_games[chat_id]
                
                # Bot move (if single player and game still active)
                elif game.player_o == -1 and game.current_player == 'O' and chat_id in self.active_games:
                    # Small delay for bot move
                    def make_bot_move():
                        if chat_id in self.active_games:
                            self._make_bot_move(game, params)
                    
                    run_on_ui_thread(make_bot_move, delay=1000)
                    
            else:
                self._send_message(chat_id, "âŒ Invalid move! Either not your turn or position already taken.", params)
                
        except Exception as e:
            self._send_message(chat_id, f"âŒ Error: {str(e)}", params)
    
    def _make_bot_move(self, game: XOGame, params):
        """Make a move for the bot"""
        try:
            available_moves = [i for i, cell in enumerate(game.board) if cell == ' ']
            
            if not available_moves:
                return
            
            # Simple bot strategy
            for move in available_moves:
                test_board = game.board.copy()
                test_board[move] = 'O'
                if self._check_winning_move(test_board, 'O'):
                    game.make_move(-1, move)
                    break
            else:
                for move in available_moves:
                    test_board = game.board.copy()
                    test_board[move] = 'X'
                    if self._check_winning_move(test_board, 'X'):
                        game.make_move(-1, move)
                        break
                else:
                    if 4 in available_moves:
                        game.make_move(-1, 4)
                    else:
                        corners = [0, 2, 6, 8]
                        available_corners = [c for c in corners if c in available_moves]
                        if available_corners:
                            game.make_move(-1, random.choice(available_corners))
                        else:
                            game.make_move(-1, random.choice(available_moves))
            
            # Send updated board after bot move
            if game.game_over:
                board_text = self._format_game_message(game)
                self._send_message(game.chat_id, board_text, params)
                
                if game.winner:
                    winner_name = "You" if game.winner == 'X' else "Bot"
                    self._send_message(game.chat_id, f"ğŸ‰ Game Over! {winner_name} win!", params)
                else:
                    self._send_message(game.chat_id, "ğŸ¤ Game Over! It's a draw!", params)
                
                # Clean up game
                if game.chat_id in self.active_games:
                    del self.active_games[game.chat_id]
            else:
                board_text = self._format_game_message(game)
                self._send_message(game.chat_id, board_text, params)
            
        except Exception:
            pass
    
    def _check_winning_move(self, board: list, player: str) -> bool:
        """Check if a move would win the game"""
        winning_combinations = [
            [0, 1, 2], [3, 4, 5], [6, 7, 8],
            [0, 3, 6], [1, 4, 7], [2, 5, 8],
            [0, 4, 8], [2, 4, 6]
        ]
        
        for combo in winning_combinations:
            if (board[combo[0]] == board[combo[1]] == 
                board[combo[2]] == player):
                return True
        return False
    
    def _stop_game(self, chat_id: int, user_id: int, params):
        """Stop the current game in chat"""
        if chat_id in self.active_games:
            game = self.active_games[chat_id]
            if user_id in [game.player_x, game.player_o]:
                del self.active_games[chat_id]
                self._send_message(chat_id, "ğŸ›‘ Game stopped by player", params)
            else:
                self._send_message(chat_id, "âŒ You're not a player in this game", params)
        else:
            self._send_message(chat_id, "âŒ No active game in this chat", params)
    
    def _show_help(self, chat_id: int, params):
        """Show help message"""
        help_text = (
            "ğŸ® **XO Tic-Tac-Toe Commands:**\n\n"
            "`/xostart` - Start new game vs bot\n"
            "`/xomove [1-9]` - Make a move (positions 1-9)\n"
            "`/xostop` - Stop current game\n"
            "`/xohelp` - Show this help\n\n"
            "**Board Positions:**\n"
            "1 2 3\n"
            "4 5 6  \n"
            "7 8 9\n\n"
            "You play as âŒ, bot plays as â­•"
        )
        self._send_message(chat_id, help_text, params)
    
    def _format_game_message(self, game: XOGame) -> str:
        """Format the game state as a message"""
        status = ""
        if game.game_over:
            if game.winner:
                winner_name = "You (âŒ)" if game.winner == 'X' else "Bot (â­•)"
                status = f"ğŸ‰ **Game Over!** {winner_name} wins!\n\n"
            else:
                status = "ğŸ¤ **Game Over!** It's a draw!\n\n"
        else:
            turn = "Your turn (âŒ)" if game.current_player == 'X' else "Bot's turn (â­•)"
            status = f"ğŸ”„ **{turn}**\n\n"
        
        board_display = game.get_board_display()
        
        # Replace X and O with emojis for better visual
        board_display = board_display.replace('X', 'âŒ').replace('O', 'â­•')
        
        return (
            f"ğŸ® **XO Tic-Tac-Toe**\n\n"
            f"{status}"
            f"```\n{board_display}\n```\n\n"
            f"Use `/xomove 1-9` to play"
        )

# Plugin instance
plugin = XOTicTacToePlugin()