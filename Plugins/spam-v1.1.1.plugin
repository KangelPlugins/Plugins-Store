__id__ = "spam_troll"
__name__ = "Spam"
__author__ = "@Xewonsik"
__version__ = "1.1.0"
__description__ = """Тролит жертву спамом сообщений (версия с матом), пиши в чат .troll (чтобы остановить спам, напиши .stoptroll)"""

__icon__ = "ksdjofsjfosdfjosijf/92"
__min_version__ = "11.12.0"

import threading
import time
import random
from typing import Any

from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import send_message, get_last_fragment
from ui.settings import Header, Input, Divider, Text, Switch
from ui.bulletin import BulletinHelper

DEFAULT_TROLL_PHRASES = [
    "Твоя мамка так шлюхует, что у неё скулы от хуев треснули, мразь))",
    "Даже ИИ тупее тебя, а его учили на твоих кривых фото, уёбище)))",
    "Ты настолько еблан, что своё отражение в зеркале ебёт по-чёрному и платит себе же))",
    "Закрой ебало, а то из него воняет нищетой и спермой кентавров, мудила)))",
    "Ты родился потому, что презерватив порвался от жалости, долбоёб))",
    "Твои мозги — это две извилины, которые ебутся в очко за третью, дебил)))",
    "Иди нахуй, но аккуратно, чтоб не разбудить свои две спящие мозговые клетки))",
    "Ты как гондон — все тебя используют, но никто не хочет видеть после, урод)))",
    "Твоя жизнь — чёрная комедия, где тебя ебут в сраку без смазки на бис))",
    "У тебя лицо как у переёбанного крота в микроволновке, еблан)))",
    "Ты настолько бесполезен, что даже вирус тебя игнорирует, шлюха))",
    "Твои шутки проветривают мозги сильнее, чем удар кувалдой по яйцам)))",
    "Ты как пробка от шампанского — все радуются, когда тебя вынимают и выкидывают))",
    "Твоя родословная началась с ебли в сортире завода, урод)))",
    "Ты думаешь? Это похоже на предсмертные судороги твоего ебаного мозга))",
    "Заткнись, а то твой IQ уже вытекает через уши вместе с соплями, мудила)))",
    "Ты как анальная пробка — мешаешь всему нормальному выходить, засранец))",
    "Твоё существование оправдано только как мишень для дротиков с говном)))",
    "Ты настолько тупой, что даже инструкцию к воде не можешь прочитать, дегенерат))",
    "Твоя харизма как у выброшенного носка с грибком, мудила)))",
    "Иди нахуй, но по дороге подумай, зачем тебя вообще выебали в позоре))",
    "Ты как пук в лифте — все делают вид, что не заметили, но всем охуенно противно)))",
    "Твои мысли звучат как скрежет стиральной доски по ебаной черепной коробке))",
    "Ты — живое доказательство, что аборт нужно делать кувалдой после сорока недель)))",
    "У тебя в черепе вместо мозга заправка для ебаных тараканов, кретин))",
    "Твои шутки вызывают больше тошноты, чем тухлые яйца с дохлой кошкой)))",
    "Ты как глист — все знают, что тебя ебут, но стараются не замечать, мразь))",
    "Твоя мамка должна была тебя проглотить, как делают умные ебанаты с утра)))",
    "Ты настолько ничтожен, что даже бактерии тебя избегают как прокажённого))",
    "Твоё лицо просит, чтобы его забыли в морге на вечной проморозке)))",
    "Ты как бракованный презерватив — все надеются, что тебя не встретят в темноте))",
    "Твои слова имеют вес как пердёж в урагане из жидкого говна)))",
    "У тебя интеллект комнатной мухи, но та хоть ебётся, а ты просто смотришь))",
    "Ты как испорченная еда — сразу видно, что тебя нужно выебать и выбросить в мусорку)))",
    "Твои шутки вызывают больше боли, чем удар в пах гвоздодёром))",
    "Ты как пустая бутылка — единственная ценность в тебе — это этикетка 'убей себя']))", "Твоя жизнь — это анекдот, который даже бомжи не хотят рассказывать из-за стыда)))", "Ты настолько тупой, что даже калькулятор тебя презирает как ошибку в формуле))", "Твои мозги работают так медленно, что зависают при мысли о том, как дышать)))", "Ты как сортирная муха — летаешь вокруг говна и радуешься, что тебя не прихлопнули))", "Твоя мамка должна была тебя смыть, как неудобное воспоминание после пьянки)))", "Ты как громкая отрыжка в тихой комнате — все делают вид, что не слышат, но ебут тебя взглядом))", "Твои шутки старее, чем шутки про Кашпировского в доме престарелых)))", "Ты как пробка в унитазе — всё застревает на твоём уровне дебилизма))", "Твоё лицо выглядит так, будто его ебли остатками других лиц в мясорубке)))", "Ты настолько бесполезен, что даже ошибка 404 тебя игнорирует как пустое место))", "Твои мысли путаются как провода в руках пьяного электрика на смертельном токе)))", "Ты как пуканье в воде — не видно, но воняет ебучо сильно и надолго))", "Твоя жизнь — это чёрная дыра, которая засасывает всё хорошее и ебёт его в аду)))", "Ты как кривое зеркало — все, кто тебя видят, хотят выглядеть лучше, чем твое уродство))", "Твои шутки вызывают больше недоумения, чем клоун с бензопилой в детсаду)))", "Ты как пустая консервная банка — шумный и бесполезный мусор))", "Твоя мамка должна была тебя заморозить, как неудачный эксперимент по клонированию говна)))", "Ты настолько тупой, что даже телевизор тебя переключает на рекламу похоронных услуг))", "Твои мозги — это эхо в пустой комнате, которое само себя не слышит и ебёт само себя в забвении)))", "Ты как мусорный бак — все кидают в тебя своё дерьмо и поджигают))", "Твоё существование — это ошибка, которую не исправить даже перезагрузкой вселенной через пизду))", "Ты как вонючий сыр — чем дальше, тем противнее, и все хотят тебя закопать)))", "Твои шутки старее, чем мамкины анекдоты про Брежнева в гробу))", "Ты как громкая икота на похоронах — все хотят, чтобы ты заткнул ебало и сдох)))", "Твоя жизнь — это провалившийся спектакль, где тебя ебут на сцене, а зрители ржут))", "Ты как бракованный пазл — никому не нужен и не вписываешься даже в картину ада)))", "Твои мысли движутся медленнее, чем очередь в советском магазине за тухлым мясом))", "Ты как пуканье в лифте — все знают, что это ты, но делают вид, что нет, чтобы не воняло от твоего существования)))", "Твоя мамка должна была тебя отдать в цирк уродцев для плевков и унижений))", "Ты настолько тупой, что даже калькулятор на тебя ругается матом и просит удалить))", "Твои шутки вызывают больше боли, чем зубная боль без анестезии у садомазохиста)))", "Ты как испорченный плод — все обходят тебя стороной, чтобы не заразиться твоим идиотизмом))", "Твоё лицо просит, чтобы его использовали как мишень для тренировок по метанию ножей)))", "Ты как громкий пердёж в библиотеке — все смотрят с осуждением и мечтают о твоей смерти))", "Твоя жизнь — это анекдот, который даже Чак Норрис стесняется рассказывать из-за убогости)))", "Ты как пустая бутылка из-под водки — от тебя остаётся только плохое воспоминание и тошнота))", "Твои мозги работают так, будто их заряжают от розетки для утюга в ванной с водой)))", "Ты как сортирная бумага — все используют тебя в последнюю очередь, когда уже нечего терять кроме совести))", "Твоя мамка должна была тебя выкинуть, как ненужный хлам после оргии с алкоголиками)))", "Ты настолько бесполезен, что даже вирусы тебя избегают, боясь заразиться твоей дегенерацией))", "Твои шутки старее, чем мамкины прокладки, пролежавшие в шкафу со времён СССР)))", "Ты как громкая отрыжка в церкви — все делают вид, что не слышат, но молятся о твоём исчезновении))", "Твоё существование — это чёрная метка для человечества, которую нужно выжечь калёным железом)))", "Ты как пуканье в ветреный день — быстро рассеиваешься, но воняешь на всю округу годами))", "Твои мысли путаются как волосы в душевой трубе общественной бани))", "Ты как испорченная консерва — все боятся тебя открывать, чтобы не умереть от вони твоего содержания)))", "Твоя жизнь — это провал, который даже не заслуживает места в учебниках по патологической убогости))", "Ты как кривой табурет — все знают, что на тебя лучше не садиться, а то просрешь всю жизнь)))", "Твои шутки вызывают больше недоумения, чем клоун с бензопилой в реанимации))", "Ты как пустая банка из-под пива — все топчут тебя ногами и ссыют на тебя в подъезде))", "Твоя мамка должна была тебя засунуть обратно как неудачную попытку самоочистки организма)))", "Ты настолько тупой, что даже микрофон тебя избегает, боясь заразиться твоей немощью))", "Твои мозги — это эхо в пустой бочке из-под говна, которое само себя не слышит и захлёбывается в дерьме)))", "Ты как мусор на ветру — все хотят, чтобы тебя унесло в черную дыру и там разорвало на атомы))", "Твоё лицо выглядит так, будто его собирали из остатков пластиковых кукол на свалке)))", "Ты как громкий храп в кинотеатре — все хотят, чтобы ты задохнулся во сне и прекратил существовать))", "Твоя жизнь — это анекдот, который даже Ленин не стал бы рассказывать из-за его унизительной тупости)))", "Ты как пуканье в бассейне — все делают вид, что не заметили, но срочно эвакуируются и вызывают МЧС))", "Твои шутки старее, чем мамкины тампоны, которые она использует как семейную реликвию)))", "Ты как бракованный диван — все знают, что на тебе нельзя сидеть, а то провалишься в ад))", "Твои мысли движутся медленнее, чем черепаха в смоле по шоссе в час пик)))", "Ты как вонючий носок — все стараются тебя не нюхать, чтобы не потерять последние остатки рассудка))", "Твоя мамка должна была тебя сдать в утиль как металлолом, но даже там тебя забраковали)))", "Ты настолько бесполезен, что даже пыль на тебя не садится, боясь испортиться))", "Твои шутки вызывают больше боли, чем удар молотком по яйцам на бетонном полу))", "Ты как испорченное молоко — все выкидывают тебя, даже не открывая, чтобы не блевануть)))", "Твоё существование — это ошибка, которую не исправить даже переформатированием вселенной через анус бога))", "Ты как громкая икота на собрании — все смотрят с ненавистью и мечтают о твоём немедленном исчезновении))", "Твоя жизнь — это провал, который даже не стоит упоминания в списке самых жалких неудач)))", "Ты как пустая коробка из-под сока — все используют тебя как подставку для говна, а потом выкидывают под машину))", "Твои мозги работают так, будто их подключили к розетке в соседней галактике через перебитый провод)))", "Ты как сортирная крышка — все пользуются тобой, но брезгуют прикасаться голыми руками))", "Твоя мамка должна была тебя заморозить как неудачное блюдо для собачьей будки)))", "Ты настолько тупой, что даже телевизор тебя избегает, переключаясь на телемагазин гробов))", "Твои шутки старее, чем мамкины презервативы, которые она хранит как память о твоём зачатии))", "Ты как громкий пердёж в церкви — все делают вид, что не слышат, но молятся о твоём сгорании в аду)))", "Твоё лицо просит, чтобы его использовали как подставку для горячих сковородок с говном))", "Ты как пуканье в метро — все делают вид, что не заметили, но сходят на следующей остановке и моют себя кислотой)))", "Твоя жизнь — это анекдот, который даже Путин не стал бы рассказывать из-за его унизительной глупости))", "Ты как бракованная батарейка — все знают, что ты не работаешь, но всё равно пытаются использовать для вибратора))", "Твои мысли путаются как провода в старом телевизоре, который бьёт током при попытке включить)))", "Ты как вонючий тухляк — чем дальше, тем противнее, и все хотят тебя закопать в радиоактивных отходах))", "Твоя мамка должна была тебя выбросить как ненужный мусор в реактор Чернобыля)))", "Ты настолько бесполезен, что даже тень от тебя убегает и прячется в светлой комнате))", "Твои шутки вызывают больше недоумения, чем клоун с цепной пилой в родильном отделении)))", "Ты как испорченная рыба — все боятся тебя нюхать, чтобы не умереть от токсичного шока))", "Твоё существование — это чёрная дыра, которая засасывает всё хорошее и превращает в говно)))", "Ты как громкая отрыжка в театре — все смотрят с презрением и мечтают о твоём падении в оркестровую яму))", "Твоя жизнь — это провал, который даже не войдёт в учебники по психиатрии как пример крайней деградации))", "Ты как пустая бутылка из-под вина — все топчут тебя ногами и используют как пепельницу)))", "Твои мозги — это эхо в пустом холодильнике, которое умоляет о смерти от голода))", "Ты как мусор в дождь — все хотят, чтобы тебя смыло в канализацию к крысам)))", "Твоя мамка должна была тебя засунуть обратно как неудачный эксперимент по созданию жизни из говна и злобы))", "Ты настолько тупой, что даже калькулятор тебя ненавидит и показывает средний палец))", "Твои шутки старее, чем мамкины колготки, которые она не меняла со дня твоего зачатия)))", "Ты как громкий храп в музее — все хотят, чтобы ты задохнулся во сне и стал экспонатом))", "Твоё лицо выглядит так, будто его лепили из пластилина слепые дети с тремором)))", "Ты как пуканье в самолёте — все знают, что это ты, но делают вид, что нет, чтобы не вызвать панику))", "Твоя жизнь — это анекдот, который даже Ельцин не стал бы рассказывать в состоянии белой горячки))", "Ты как бракованный зонт — все знают, что ты не защищаешь от дождя, но всё равно пытаются использовать как дубину)))", "Твои мысли движутся медленнее, чем черепаха в асфальте во время ремонтных работ))", "Ты как вонючий подмышек — все стараются тебя избегать, чтобы не потерять обоняние навсегда)))", "Твоя мамка должна была тебя сдать в цирк как уродца для битья кнутом и плевков))", "Ты настолько бесполезен, что даже пыль на тебя не садится, боясь умереть от скуки))", "Твои шутки вызывают больше боли, чем удар кулаком в живот от чемпиона по боксу)))", "Ты как испорченный суп — все выкидывают тебя, даже не пробуя, чтобы не отравиться твоей сущностью))", "Твоё существование — это ошибка, которую не исправить даже перезагрузкой вселенной через чёрную дыру в анусе космоса)))", "Ты как громкая икота на экзамене — все смотрят с ненавистью и мечтают о твоём исчезновении в портале в ад))", "Твоя жизнь — это провал, который даже не заслуживает места в памяти человечества как пример полного фиаско)))", "Ты как пустая коробка из-под обуви — все используют тебя как контейнер для использованных презервативов, а потом выкидывают под поезд))", "Твои мозги работают так, будто их подключили к розетке для микроволновки в ванной с водой и включили на максимум)))", "Ты как сортирный веник — все пользуются тобой, но брезгуют прикасаться без противогаза))", "Твоя мамка должна была тебя заморозить как неудачное мороженое с вкусом говна и слёз)))", "Ты настолько тупой, что даже телевизор тебя выключает и просит вынести его на помойку))", "Твои шутки старее, чем мамкины прокладки, которые она использует как фильтр для самогона)))", "Ты как громкий пердёж в синагоге — все делают вид, что не слышат, но молятся о твоём падении в геенну огненную))", "Твоё лицо просит, чтобы его использовали как доску для разделки тухлого мяса в чумной лаборатории)))", "Ты как пуканье в лифте — все делают вид, что не заметили, но нажимают кнопку 'стоп' и вызывают сапёров))"
]

class TrollPlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self._cancel_events = {}

    def on_plugin_load(self):
        self.add_on_send_message_hook()
        self.log("Spam загружен!")

    def _get_all_phrases(self):
        """Собирает стандартные и/или пользовательские фразы в один список."""
        custom_phrases_pi = []
        custom_phrase_count = self.get_setting("custom_phrase_count", 0)
        for i in range(1, custom_phrase_count + 1):
            phrase = self.get_setting(f"custom_phrase_{i}", "").strip()
            if phrase:
                custom_phrases_pi.append(phrase)
        
        use_only_custom_pi = self.get_setting("only_custom_phrases", False)
        
        if use_only_custom_pi:
            
            return custom_phrases_pi
        else:
            all_pi_phrases = DEFAULT_TROLL_PHRASES[:]
            all_pi_phrases.extend(custom_phrases_pi)
            return all_pi_phrases

    def _refresh_settings_page(self):
        """Пересобирает страницу настроек, чтобы отобразить изменения."""
        try:
            fragment = get_last_fragment()
            if fragment and hasattr(fragment, "rebuildAllFragments"):
                fragment.rebuildAllFragments(True)
        except Exception as e:
            self.log(f"Не удалось обновить страницу настроек: {e}")

    def _add_phrase(self, view):
        """Увеличивает счетчик фраз и обновляет UI."""
        count = self.get_setting("custom_phrase_count", 0)
        self.set_setting("custom_phrase_count", count + 1)
        self._refresh_settings_page()

    def _remove_phrase(self, view, index_to_remove):
        """Удаляет фразу по индексу и сдвигает остальные."""
        count = self.get_setting("custom_phrase_count", 0)
        
        for i in range(index_to_remove, count):
            next_phrase = self.get_setting(f"custom_phrase_{i + 1}", "")
            self.set_setting(f"custom_phrase_{i}", next_phrase)
        
        self.set_setting(f"custom_phrase_{count}", "")
        self.set_setting("custom_phrase_count", count - 1)
        self._refresh_settings_page()

    def create_settings(self):
        """Создаем страницу настроек для плагина."""
        settings_list = [
            Header(text="Основные настройки"),
            Input(
                key="delay_ms", text="Задержка (мс)", default="200",
                subtext="Рекомендуется не менее 200 мс.",
                icon="msg_recent_solar"
            ),
            Input(
                key="count", text="Количество сообщений", default="20",
                subtext="Сколько сообщений отправить за раз.",
                icon="chats_replies_solar"
            ),
            Switch(
                key="only_custom_phrases",
                text="Использовать только свои фразы",
                subtext="Если включено, встроенные оскорбления использоваться не будут.",
                default=False,
                icon="filter_custom_solar"
            ),
            Divider(text="Команды: .troll - начать, .stoptroll - остановить. @PluginExtraGram | @xewonsik"),
            Header(text="Пользовательские фразы")
        ]
        
        custom_phrase_count = self.get_setting("custom_phrase_count", 0)
        display_count = max(1, custom_phrase_count)

        for i in range(1, display_count + 1):
            settings_list.extend([
                Input(
                    key=f"custom_phrase_{i}",
                    text=f"Своя фраза #{i}",
                    default="",
                    icon="msg_edit_solar"
                ),
            ])
            
            if i <= custom_phrase_count and custom_phrase_count > 0:
                settings_list.append(Text(
                    text=f"Удалить фразу #{i}",
                    icon="msg_delete_solar",
                    red=True,
                    on_click=lambda view, index=i: self._remove_phrase(view, index)
                ))
            settings_list.append(Divider())

        settings_list.append(Text(
            text="Добавить еще фразу",
            icon="msg_addfolder_solar",
            accent=True,
            on_click=self._add_phrase
        ))

        return settings_list

    def _troll_worker(self, peer_id, delay_ms, count, cancel_event):
        """Эта функция выполняется в отдельном потоке, чтобы не морозить приложение."""
        try:
            all_phrases = self._get_all_phrases()
            if not all_phrases:
                run_on_ui_thread(lambda: BulletinHelper.show_error("Нет фраз для отправки! Добавьте их в настройках.", get_last_fragment()))
                return 

            phrases_to_send = random.sample(all_phrases, min(count, len(all_phrases)))
            
            for _ in range(count):
                if cancel_event.is_set():
                    break 
                
                if not phrases_to_send:
                    
                    pi_random_phrase = random.choice(all_phrases)
                else:
                    pi_random_phrase = phrases_to_send.pop(0)
                
                send_message({"peer": peer_id, "message": pi_random_phrase})
                time.sleep(delay_ms / 1000.0)
            
            
            if not cancel_event.is_set():
                run_on_ui_thread(lambda: BulletinHelper.show_success("Троллинг завершен!", get_last_fragment()))
        except Exception as e:
            self.log(f"Ошибка в потоке троллинга: {e}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"Ошибка: {e}", get_last_fragment()))
        finally:
            
            if self._cancel_events.get(peer_id) is cancel_event:
                del self._cancel_events[peer_id]

    def on_send_message_hook(self, account, params: Any) -> HookResult:
        if not isinstance(params.message, str):
            return HookResult()

        msg = params.message.strip().lower()
        peer_id = params.peer

        if msg == ".troll":
            if peer_id in self._cancel_events:
                BulletinHelper.show_error("Троллинг в этом чате уже запущен.", get_last_fragment())
                return HookResult(strategy=HookStrategy.CANCEL)

            try:
                delay_pi = int(self.get_setting("delay_ms", "200"))
                count_pi = int(self.get_setting("count", "20"))
                if delay_pi < 0 or count_pi <= 0:
                    raise ValueError("Некорректные значения в настройках.")
            except ValueError:
                BulletinHelper.show_error("Ошибка в настройках! Проверьте, что введены числа.", get_last_fragment())
                return HookResult(strategy=HookStrategy.CANCEL)

            cancel_event = threading.Event()
            self._cancel_events[peer_id] = cancel_event

            threading.Thread(
                target=self._troll_worker,
                args=(peer_id, delay_pi, count_pi, cancel_event),
                daemon=True
            ).start()
            
            BulletinHelper.show_info("Троллинг запущен...", get_last_fragment())
            return HookResult(strategy=HookStrategy.CANCEL)

        elif msg == ".stoptroll":
            if peer_id in self._cancel_events:
                
                self._cancel_events[peer_id].set()
                BulletinHelper.show_success("Троллинг остановлен.", get_last_fragment())
            else:
                BulletinHelper.show_info("В этом чате нет активного троллинга.", get_last_fragment())
            return HookResult(strategy=HookStrategy.CANCEL)

        return HookResult()