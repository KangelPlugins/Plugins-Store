from typing import List, Tuple
from base_plugin import BasePlugin, HookResult, HookStrategy
from android_utils import log
from java.util import Locale
from ui.settings import Header, Input, Selector
from org.telegram.messenger import R, LocaleController, AndroidUtilities, MessageObject
from org.telegram.tgnet import TLRPC
from client_utils import get_send_messages_helper, get_last_fragment, get_account_instance, send_request, get_user_config, get_messages_controller, send_message
import json

__id__ = "deplugin"
__name__ = "Ð´ÐµÐ¿Ð°Ð¹ Ð¼Ñ€Ð°Ð·ÑŒ"
__version__ = "7.7.7"
__description__ = "Ð”Ð•ÐŸÐÐ™ Ð¢Ð’ÐÐ Ð¬\n.dep [Ñ‡Ñ‚Ð¾] [ÑÐºÐ¾Ð»ÑŒÐºÐ¾] \n.dodep [Ñ‡Ñ‚Ð¾] [ÑÐºÐ¾Ð»ÑŒÐºÐ¾]"
__author__ = "@hpdevfox, @nijon4rch | Fork by: @ArThirtyFour & @KangelPlugins"
__min_version__ = "11.9.0"
__icon__ = "FellowHarlequinJaguar_by_fStikBot/16"

GAME_SYMBOLS = ["ðŸŽ°"]
GAME_LABELS = ["slots"]
ALIASES = {
	"dep": "slots"
}

DEFAULT_GAME = 0
DEFAULT_TARGET = "ÑÐ²Ð¾ÐµÐ³Ð¾ Ð´Ñ€ÑƒÐ³Ð°"

class DepPlugin(BasePlugin):
	def create_settings(self):
		from java.util import Locale
		lang = Locale.getDefault().getLanguage()
		strings = {
			'ru': {
				'gamesel_text': "Ð’Ñ‹Ð±Ð¾Ñ€ Ð¸Ð³Ñ€Ñ‹ Ð´Ð»Ñ Ð´ÐµÐ¿Ð°",
				'depcount_text': "Ð”ÐµÐ¿Ð¾Ð² Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ",
				'depcount_subtext': "Ð§Ð¸ÑÐ»Ð¾ - ÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð´ÐµÐ¿Ð¾Ð² Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾ ÐµÑÐ»Ð¸ Ð² ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾",
				'default_target_text': "Ð¢ÐµÐºÑÑ‚ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ",
				'default_target_subtext': "Ð¢ÐµÐºÑÑ‚, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹ Ð±ÑƒÐ´ÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ, ÐµÑÐ»Ð¸ Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð½ Ð°Ñ€Ð³ÑƒÐ¼ÐµÐ½Ñ‚",
				'header': "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°"
			},
			'en': {
				'gamesel_text': "Game selection",
				'depcount_text': "Default dep count",
				'depcount_subtext': "number - count of deps to send if not specified in command explicitly",
				'default_target_text': "Default target text",
				'default_target_subtext': "Text that will be used if no argument is specified",
				'header': "Plugin settings"
			}
		} 

		lang_key = 'ru' if lang.startswith('ru') else 'en'
		s = strings[lang_key]

		return [
			Header(text=s['header']),
			Input(
				key="depcount",
				icon="menu_random",
				text=s["depcount_text"],
				subtext=s["depcount_subtext"],
				default="3"
			),
			Input(
				key="default_target",
				icon="menu_random",
				text=s["default_target_text"],
				subtext=s["default_target_subtext"],
				default=DEFAULT_TARGET
			)
		]

	def on_plugin_load(self):
		self.add_on_send_message_hook(priority = 0)

	def on_send_message_hook(self, account, params) -> HookStrategy:
		if not isinstance(params.message, str) or not (params.message.startswith(".dep") or params.message.startswith(".dodep")):
			return HookResult()

		command = params.message.split()
		last_arg = command[len(command)-1]
		game = GAME_SYMBOLS[0]
		count = self.get_setting("depcount", "3")
		default_target = self.get_setting("default_target", DEFAULT_TARGET)
		is_dodep = params.message.startswith(".dodep")

		if len(command) == 1:
			target = default_target
		else:
			command.remove(".dep" if not is_dodep else ".dodep")
			if len(command) == 0:
				target = default_target
			else:
				if len(command) >= 1:
					if last_arg.isnumeric():
						count = last_arg
						command.remove(last_arg)
				target = " ".join(command) if command else default_target
		
		for _ in range(int(count)):
			send_message({
				"peer": params.peer,
				"dialog_id": params.peer,
				"replyToMsg": params.replyToMsg,
				"replyToTopMsg": params.replyToTopMsg,
				"message": game
			})

		params.message = f"Ð´Ð¾Ð´ÐµÐ¿Ñ‹Ð²Ð°ÑŽ {target}" if is_dodep else f"Ð´ÐµÐ¿Ð°ÑŽ {target}"
		return HookResult(strategy=HookStrategy.MODIFY, params=params) 
