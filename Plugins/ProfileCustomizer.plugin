__id__ = "Extera_Profile"
__name__ = "Custom Extera Profile"
__author__ = "@jimu312"
__version__ = "1.6.1"
__description__ = "–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–π—Ç–µ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–µ –±–∞–Ω–Ω–µ—Ä—ã –ø—Ä–æ—Ñ–∏–ª—è –∏ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–π—Ç–µ –∫–∞—Å—Ç–æ–º–Ω—ã–µ –±–∞–Ω–Ω–µ—Ä—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∞–Ω–Ω–µ—Ä–æ–≤!"
__min_version__ = "11.12.0"
import json as _json
import os
import re
import threading
import time
import traceback
import weakref
from datetime import datetime
from base_plugin import BasePlugin, MenuItemData, MenuItemType, MethodHook
from hook_utils import find_class
from android_utils import run_on_ui_thread, log
from client_utils import get_last_fragment
from ui.bulletin import BulletinHelper
from ui.settings import Header, Input, Switch, Divider, Text
HAS_DIVIDER = True
try:
    Divider
except NameError:
    HAS_DIVIDER = False
from ui.alert import AlertDialogBuilder
from android.app import Activity
from android.content import Intent, ClipboardManager, ClipData, Context
from android.net import Uri
from android.view import View, ViewGroup
from android.widget import EditText
from android.text import InputType
from android.graphics import (
    BitmapFactory, Bitmap, Color, LinearGradient, Paint, Shader, Matrix
)
from java.io import File, BufferedInputStream, FileOutputStream
from org.telegram.messenger import ApplicationLoader, AndroidUtilities
try:
    from java import jclass, jarray
except Exception:
    jclass = None
    jarray = None
if jclass is not None:
    try:
        JCanvas = jclass("android.graphics.Canvas")
        JActionBar = jclass("org.telegram.ui.ActionBar.ActionBar")
    except Exception:
        JCanvas = None
        JActionBar = None
else:
    JCanvas = None
    JActionBar = None
JAVA_ARRAY_AVAILABLE = jarray is not None
_SENTINEL = object()
_TAG = "[CustomExteraProfile]"
class ProfileHeaderImagePlugin(BasePlugin):
    SETTINGS_ENABLE = "profileHeader.enable"
    SETTINGS_SOURCE_GLOBAL = "profileHeader.source"
    SETTINGS_FADE = "profileHeader.fade"
    SETTINGS_BLUR_INTENSITY = "profileHeader.blurIntensity"         
    SETTINGS_DARKEN_INTENSITY = "profileHeader.darkenIntensity"     
    SETTINGS_EFFECT_DEFAULT = "profileHeader.defaultEffect"         
    SETTINGS_AVATAR_BANNER_ENABLE = "profileHeader.avatarBanner.enable"     
    SETTINGS_AVATAR_BANNER_EFFECT = "profileHeader.avatarBanner.effect"     
    SETTINGS_DEBUG_ENABLE = "profileHeader.debug.enable"     
    SETTINGS_SERVER_URL = "profileHeader.server.url"               
    SETTINGS_SERVER_AUTO_UPLOAD = "profileHeader.server.autoUpload" 
    SETTINGS_SERVER_FETCH_OTHERS = "profileHeader.server.fetchOthers" 
    SETTINGS_SERVER_TOKEN = "profileHeader.server.token"             
    SETTINGS_CONSENT_UPLOAD = "profileHeader.server.consent"         
    SETTINGS_VIDEO_MUTE = "profileHeader.video.mute"                 
    SERVER_CACHE_TTL = 3600  
    USER_COUNT_CACHE_TTL = 300
    TEXTMODE_PREFIX = "profileHeader.textMode."  
    EFFECT_PREFIX = "profileHeader.effect."      
    FILE_PICKER_REQUEST_CODE = 33101
    def __init__(self):
        super().__init__()
        self._last_target_fragment_ref = None
        self._activity_hook = None
        try:
            run_on_ui_thread(lambda: BulletinHelper.show(f"Custom Extera Profile {__version__} –∑–∞–≥—Ä—É–∂–µ–Ω!"))
        except Exception:
            pass
        self._bmp_map = {}
        self._bmp_blur_map = {}
        self._bmp_order = []
        self._src_map = {}
        self._plugin_dir = ""
        self._hook_on_draw_ref = None
        self._hooked_topview_classname = None
        self._watcher_stop = False
        self._theme_hook_refs = []
        self._theme_keys = {}
        self._last_blur_percent = None
        self._log_buffer = []
        self._debug_enabled = False
        self._cache_lock = threading.Lock()
        self._server_cache = {}
        self._server_cache_dir = ""
        self._etag_cache = {}
        self._paint_bmp = None
        self._paint_darken = None
        self._paint_fade = None
        self._user_count_cache = {"count": 0, "fetched_at": 0}
        self._video_player = None      
        self._video_texture = None     
        self._video_source = None      
        self._video_topview = None     
        try:
            self._CanvasClass = find_class("android.graphics.Canvas")
        except Exception:
            self._CanvasClass = None
    def _log(self, msg: str, also_ui: bool = False):
        try:
            ts = datetime.now().strftime("%H:%M:%S")
            line = f"{ts} {msg}"
            self._log_buffer.append(line)
            if len(self._log_buffer) > 300:
                self._log_buffer = self._log_buffer[-200:]
            log(f"{_TAG} {msg}")
            if also_ui:
                self._notify(f"{_TAG} {msg}")
        except Exception:
            pass
    def _menu_show_logs(self, ctx):
        try:
            fragment = ctx.get("fragment")
            activity = fragment.getParentActivity() if fragment else None
            if not activity:
                BulletinHelper.show("–ù–µ—Ç –∞–∫—Ç–∏–≤–∏—Ç–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤")
                return
            self._dump_logs_dialog(activity)
        except Exception:
            pass
    def _dump_logs_dialog(self, parent_activity):
        try:
            text = "\n".join(self._log_buffer[-200:]) if self._log_buffer else "–õ–æ–≥–∏ –ø—É—Å—Ç—ã."
            b = AlertDialogBuilder(parent_activity)
            b.set_title("–õ–æ–≥–∏ CustomExteraProfile")
            b.set_message(text)
            b.set_positive_button("OK", None)
            b.set_neutral_button("–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞", lambda d, w: self._copy_logs_to_clipboard(parent_activity))
            b.show()
        except Exception:
            try:
                BulletinHelper.show("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏")
            except Exception:
                pass
    def _copy_logs_to_clipboard(self, parent_activity=None):
        try:
            text = "\n".join(self._log_buffer[-200:]) if self._log_buffer else "–õ–æ–≥–∏ –ø—É—Å—Ç—ã."
            clipboard = ApplicationLoader.applicationContext.getSystemService(Context.CLIPBOARD_SERVICE)
            clip = ClipData.newPlainText("CustomExteraProfile Logs", text)
            clipboard.setPrimaryClip(clip)
            BulletinHelper.show("–õ–æ–≥–∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞")
        except Exception as e:
            try:
                BulletinHelper.show("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –ª–æ–≥–∏ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞")
            except Exception:
                pass
    def on_plugin_load(self):
        self._ensure_defaults()
        self._ensure_plugin_dir()
        self._ensure_server_cache_dir()
        self._debug_enabled = self._get_bool(self.SETTINGS_DEBUG_ENABLE, False)
        try:
            self.add_menu_item(MenuItemData(
                menu_type=MenuItemType.PROFILE_ACTION_MENU,
                text="–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω",
                icon="msg_gallery",
                on_click=self._menu_set_custom_bg,
                priority=1000
            ))
        except Exception:
            pass
        self._install_theme_hooks()
        t = threading.Thread(target=self._watcher_loop, name="ExteraProfileWatcher", daemon=True)
        t.start()
    def on_plugin_unload(self):
        self._watcher_stop = True
        try:
            self._release_video()
        except Exception:
            pass
        try:
            self._reset_theme_colors()
        except Exception:
            pass
        if self._hook_on_draw_ref:
            try:
                self.unhook_method(self._hook_on_draw_ref)
            except Exception:
                pass
            self._hook_on_draw_ref = None
        self._hooked_topview_classname = None
        for ref in self._theme_hook_refs:
            try:
                if ref:
                    self.unhook_method(ref)
            except Exception:
                pass
        self._theme_hook_refs = []
        if self._activity_hook:
            try:
                self._activity_hook.unhook()
            except Exception:
                pass
            self._activity_hook = None
    def create_settings(self):
        return self._build_settings()
    def get_settings(self):
        return self._build_settings()
    def _build_settings(self):
        try:
            blur_percent = self._get_percent(self.SETTINGS_BLUR_INTENSITY, 60)
            darken_percent = self._get_percent(self.SETTINGS_DARKEN_INTENSITY, 70)
            is_avatar_banner_enabled = self._get_bool(self.SETTINGS_AVATAR_BANNER_ENABLE, True)
            effect_options = ["–†–∞–∑–º—ã—Ç–∏–µ", "–ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ", "–ë–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞"]
            effect_values = ["blur", "darken", "none"]
            current_effect_value = self._get_effect_str(self.SETTINGS_AVATAR_BANNER_EFFECT, "darken")
            try:
                effect_default_index = effect_values.index(current_effect_value)
            except ValueError:
                effect_default_index = 0
            rows = [
                Header(text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Profile Customizer")
            ]
            rows.append(Header(text="–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω"))
            rows.append(Input(
                key=self.SETTINGS_BLUR_INTENSITY,
                text="–°–∏–ª–∞ —Ä–∞–∑–º—ã—Ç–∏—è",
                subtext="–û—Ç 1 –¥–æ 100. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 60.",
                default=str(blur_percent),
                on_change=self._on_blur_intensity_changed
            ))
            rows.append(Input(
                key=self.SETTINGS_DARKEN_INTENSITY,
                text="–°–∏–ª–∞ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è",
                subtext="–û—Ç 1 –¥–æ 100. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 70.",
                default=str(darken_percent),
                on_change=self._on_darken_intensity_changed
            ))
            if HAS_DIVIDER:
                rows.append(Divider(text="–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ–Ω–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ '–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω' –≤ –º–µ–Ω—é."))
            else:
                rows.append(Text(
                    text="–î–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ñ–æ–Ω–∞ –æ—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –∏ –≤—ã–±–µ—Ä–∏—Ç–µ '–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω' –≤ –º–µ–Ω—é."
                ))
            if HAS_DIVIDER:
                rows.append(Divider())
            rows.append(Header(text="–ë–∞–Ω–Ω–µ—Ä –ø–æ –∞–≤–∞—Ç–∞—Ä–∫–µ"))
            rows.append(Switch(
                key=self.SETTINGS_AVATAR_BANNER_ENABLE,
                text="–í–∫–ª—é—á–∏—Ç—å –±–∞–Ω–Ω–µ—Ä –∏–∑ –∞–≤–∞—Ç–∞—Ä–∞",
                subtext="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–≤–∞—Ç–∞—Ä–∫—É –ø—Ä–æ—Ñ–∏–ª—è –∫–∞–∫ —Ñ–æ–Ω.",
                default=is_avatar_banner_enabled,
                on_change=self._on_avatar_banner_enable_changed
            ))
            if is_avatar_banner_enabled:
                rows.append(Text(
                    text=f"–≠—Ñ—Ñ–µ–∫—Ç –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞: {effect_options[effect_default_index]}",
                    on_click=lambda view: self._show_effect_choice_dialog()
                ))
            if HAS_DIVIDER:
                rows.append(Divider(text="–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ñ–æ–Ω–æ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –≤—Ä—É—á–Ω—É—é."))
            else:
                rows.append(Text(
                    text="–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞–¥ –∫–∞—Å—Ç–æ–º–Ω—ã–º —Ñ–æ–Ω–æ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –≤—Ä—É—á–Ω—É—é."
                ))
            if HAS_DIVIDER:
                rows.append(Divider())
            rows.append(Header(text="–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–∞–Ω–Ω–µ—Ä–æ–≤"))
            rows.append(Switch(
                key=self.SETTINGS_CONSENT_UPLOAD,
                text="–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö",
                subtext="–†–∞–∑—Ä–µ—à–∞—é –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –º–æ–π ID –∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª—ã –±–∞–Ω–Ω–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä api.xd1.me",
                default=self._get_bool(self.SETTINGS_CONSENT_UPLOAD, False),
                on_change=lambda v: self.set_setting(self.SETTINGS_CONSENT_UPLOAD, bool(v))
            ))
            rows.append(Input(
                key=self.SETTINGS_SERVER_TOKEN,
                text="–¢–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏",
                subtext="–û–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–Ω–Ω–µ—Ä–æ–≤. –í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –æ—Ç –±–æ—Ç–∞.",
                default=self._get_str(self.SETTINGS_SERVER_TOKEN, ""),
                on_change=lambda v: self.set_setting(self.SETTINGS_SERVER_TOKEN, str(v).strip())
            ))
            rows.append(Text(
                text="ü§ñ –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω (–û—Ç–∫—Ä—ã—Ç—å –ë–æ—Ç–∞)",
                on_click=lambda view: self._open_bot()
            ))
            rows.append(Switch(
                key=self.SETTINGS_SERVER_AUTO_UPLOAD,
                text="–ê–≤—Ç–æ-–∑–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä",
                subtext="–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–≤–æ–π –±–∞–Ω–Ω–µ—Ä –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ.",
                default=self._get_bool(self.SETTINGS_SERVER_AUTO_UPLOAD, True),
                on_change=lambda v: self.set_setting(self.SETTINGS_SERVER_AUTO_UPLOAD, bool(v))
            ))
            rows.append(Switch(
                key=self.SETTINGS_SERVER_FETCH_OTHERS,
                text="–ó–∞–≥—Ä—É–∂–∞—Ç—å –±–∞–Ω–Ω–µ—Ä—ã –¥—Ä—É–≥–∏—Ö",
                subtext="–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –±–∞–Ω–Ω–µ—Ä—ã –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –ø–ª–∞–≥–∏–Ω–æ–º.",
                default=self._get_bool(self.SETTINGS_SERVER_FETCH_OTHERS, True),
                on_change=lambda v: self.set_setting(self.SETTINGS_SERVER_FETCH_OTHERS, bool(v))
            ))
            rows.append(Switch(
                key=self.SETTINGS_VIDEO_MUTE,
                text="–ë–µ–∑–∑–≤—É—á–Ω—ã–π —Ä–µ–∂–∏–º –≤–∏–¥–µ–æ",
                subtext="–í–∏–¥–µ–æ-–±–∞–Ω–Ω–µ—Ä—ã –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è –±–µ–∑ –∑–≤—É–∫–∞.",
                default=self._get_bool(self.SETTINGS_VIDEO_MUTE, True),
                on_change=lambda v: self.set_setting(self.SETTINGS_VIDEO_MUTE, bool(v))
            ))
            if HAS_DIVIDER:
                rows.append(Divider(text="–í–Ω–∏–º–∞–Ω–∏–µ: –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–≤–∏–¥–µ–æ) –±–∞–Ω–Ω–µ—Ä—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –±–µ—Ç–µ –∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å –±–∞–≥–∏ –∏–ª–∏ –≥–ª–∏—Ç—á–∏."))
            else:
                rows.append(Text(text="–í–Ω–∏–º–∞–Ω–∏–µ: –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ (–≤–∏–¥–µ–æ) –±–∞–Ω–Ω–µ—Ä—ã –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –±–µ—Ç–µ –∏ –º–æ–≥—É—Ç –∏–º–µ—Ç—å –±–∞–≥–∏ –∏–ª–∏ –≥–ª–∏—Ç—á–∏."))
            if HAS_DIVIDER:
                rows.append(Divider())
            rows.append(Header(text="–°–æ–æ–±—â–µ—Å—Ç–≤–æ"))
            count = self._user_count_cache.get("count", 0)
            rows.append(Text(text=f"üë• –ë–∞–Ω–Ω–µ—Ä–æ–≤: {count}"))
            threading.Thread(target=self._fetch_user_count, daemon=True).start()
            if HAS_DIVIDER:
                rows.append(Divider())
            rows.append(Header(text="Debug"))
            rows.append(Switch(
                key=self.SETTINGS_DEBUG_ENABLE,
                text="–í–∫–ª—é—á–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ",
                subtext="–í–∫–ª—é—á–∏—Ç—å –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.",
                default=self._debug_enabled,
                on_change=self._on_debug_changed
            ))
            if self._debug_enabled:
                rows.append(Text(
                    text="–ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏",
                    on_click=lambda view: self._show_debug_logs()
                ))
            return rows
        except Exception:
            return [Header("Custom Extera Profile"), Text("–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫")]
    def _open_bot(self):
        try:
            from android.content import Intent
            from android.net import Uri
            from android_utils import run_on_ui_thread
            def _open():
                try:
                    ctx = ApplicationLoader.applicationContext
                    intent = Intent(Intent.ACTION_VIEW, Uri.parse("tg://resolve?domain=Extera_profile_bot"))
                    intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    ctx.startActivity(intent)
                    self._notify("–û—Ç–∫—Ä—ã—Ç Telegram. –ù–∞–π–¥–∏—Ç–µ —Å–≤–æ–µ–≥–æ –±–æ—Ç–∞.")
                except Exception as e:
                    self._log(f"Bot open error: {e}")
            run_on_ui_thread(_open)
        except Exception:
            pass
    def _show_effect_choice_dialog(self):
        try:
            fragment = get_last_fragment()
            parent = fragment.getParentActivity() if fragment else None
            if parent is None:
                self._notify("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω –¥–ª—è –¥–∏–∞–ª–æ–≥–∞.")
                return
            effect_options = ["–†–∞–∑–º—ã—Ç–∏–µ", "–ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ", "–ë–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞"]
            effect_values = ["blur", "darken", "none"]
            def on_effect_selected(dialog_builder, index):
                try:
                    selected_effect = effect_values[index]
                    self.set_setting(self.SETTINGS_AVATAR_BANNER_EFFECT, selected_effect)
                    self._reload_plugin_settings()
                    self._notify(f"–≠—Ñ—Ñ–µ–∫—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {effect_options[index]}")
                except IndexError:
                    pass
                except Exception:
                    pass
            builder = AlertDialogBuilder(parent)
            builder.set_title("–í—ã–±–æ—Ä —ç—Ñ—Ñ–µ–∫—Ç–∞ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞")
            builder.set_items(effect_options, on_effect_selected)
            builder.set_negative_button("–û—Ç–º–µ–Ω–∞", None)
            builder.show()
        except Exception:
            pass
    def _fetch_user_count(self):
        try:
            age = time.time() - self._user_count_cache.get("fetched_at", 0)
            if age < self.USER_COUNT_CACHE_TTL:
                return
            url = self._get_server_url()
            if not url:
                return
            code, body = self._http_get(f"{url}/api/user-count", timeout=10)
            if code == 200 and body:
                data = _json.loads(body.decode("utf-8"))
                count = data.get("count", 0)
                self._user_count_cache = {"count": count, "fetched_at": time.time()}
        except Exception:
            pass
    def _check_video_size(self, path):
        try:
            fsize = os.path.getsize(path)
            if fsize > 5 * 1024 * 1024:
                self._notify(f"‚ö†Ô∏è –í–∏–¥–µ–æ {fsize // (1024*1024)}–ú–ë ‚Äî —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω–∏—Ç—å (–º–∞–∫—Å 5–ú–ë)")
            from android.media import MediaMetadataRetriever
            mmr = MediaMetadataRetriever()
            try:
                mmr.setDataSource(str(path))
                w = int(mmr.extractMetadata(MediaMetadataRetriever.METADATA_KEY_VIDEO_WIDTH) or "0")
                h = int(mmr.extractMetadata(MediaMetadataRetriever.METADATA_KEY_VIDEO_HEIGHT) or "0")
                if w > 1920 or h > 1920:
                    self._notify(f"‚ö†Ô∏è –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ {w}x{h} ‚Äî —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –æ—Ç–∫–ª–æ–Ω–∏—Ç—å (–º–∞–∫—Å 1920)")
            finally:
                mmr.release()
        except Exception:
            pass
    def _menu_set_custom_bg(self, ctx):
        try:
            fragment = ctx.get("fragment")
            if fragment is None:
                self._alert("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ñ—Ä–∞–≥–º–µ–Ω—Ç –ø—Ä–æ—Ñ–∏–ª—è")
                return
            self._last_target_fragment_ref = weakref.ref(fragment)
            key = self._get_profile_key_from_fragment(fragment)
            if key is None:
                self._alert("–û—à–∏–±–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å")
                return
            parent = fragment.getParentActivity()
            if parent is None:
                self._alert("–û—à–∏–±–∫–∞", "–ù–µ—Ç –∞–∫—Ç–∏–≤–∏—Ç–∏")
                return
            my_uid = self._get_my_user_id()
            is_own_profile = key.startswith("uid_") and key[4:] == my_uid
            builder = AlertDialogBuilder(parent)
            builder.set_title("–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è")
            options = ["–õ–æ–∫–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä", "–£–¥–∞–ª–∏—Ç—å —Ñ–æ–Ω"]
            if is_own_profile:
                options.insert(1, "–°–µ—Ä–≤–µ—Ä–Ω—ã–π –±–∞–Ω–Ω–µ—Ä")
            def on_top_option(dlg, which):
                if which == 0:
                    self._show_local_banner_menu(parent, key, fragment)
                elif is_own_profile and which == 1:
                    self._show_server_banner_menu(parent, key, fragment)
                elif (is_own_profile and which == 2) or (not is_own_profile and which == 1):
                    # Fully delete the setting so server banners can show again
                    try:
                        self.delete_setting(self._k_src(key))
                    except Exception:
                        self._set_profile_source(key, "")
                    self._set_profile_text_mode(key, "")
                    try:
                        self.delete_setting(self._k_effect(key))
                    except Exception:
                        self._set_profile_effect(key, "none")
                    self._drop_bitmap_cache_for_key(key)
                    # Also release video if it was playing for this profile
                    if self._video_source and self._is_video_source(key):
                        try:
                            self._release_video()
                            self._active_video_args = None
                        except Exception:
                            pass
                    if is_own_profile:
                        self._server_delete_banner()
                    self._notify("–§–æ–Ω —É–¥–∞–ª—ë–Ω")
            builder.set_items(options, on_top_option)
            builder.set_negative_button("–û—Ç–º–µ–Ω–∞", None)
            builder.show()
        except Exception:
            pass
    def _show_local_banner_menu(self, parent, key, fragment):
        try:
            builder = AlertDialogBuilder(parent)
            builder.set_title("–õ–æ–∫–∞–ª—å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä")
            options = [
                "–£–∫–∞–∑–∞—Ç—å URL/–ø—É—Ç—å",
                "–í—ã–±—Ä–∞—Ç—å –∏–∑ –≥–∞–ª–µ—Ä–µ–∏",
                "–ë–∞–Ω–Ω–µ—Ä –∏–∑ –∞–≤–∞—Ç–∞—Ä–∞",
            ]
            def on_local_option(dlg, which):
                if which == 0:
                    self._show_url_input_dialog(parent, key)
                elif which == 1:
                    self._launch_file_picker(key)
                elif which == 2:
                    self._set_profile_source(key, f"avatar://{key}")
                    try:
                        self.delete_setting(self._k_effect(key))
                    except Exception:
                        pass
                    self._drop_bitmap_cache_for_key(key)
                    self._invalidate_profile_view(fragment)
                    self._notify("–§–æ–Ω —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: –±–∞–Ω–Ω–µ—Ä –∏–∑ –∞–≤–∞—Ç–∞—Ä–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)")
            builder.set_items(options, on_local_option)
            builder.set_negative_button("–ù–∞–∑–∞–¥", None)
            builder.show()
        except Exception:
            pass
    def _show_server_banner_menu(self, parent, key, fragment):
        try:
            builder = AlertDialogBuilder(parent)
            builder.set_title("–°–µ—Ä–≤–µ—Ä–Ω—ã–π –±–∞–Ω–Ω–µ—Ä")
            options = [
                "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ç–µ–∫—É—â–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä",
                "–£–¥–∞–ª–∏—Ç—å —Å —Å–µ—Ä–≤–µ—Ä–∞",
            ]
            def on_server_option(dlg, which):
                if which == 0:
                    self._upload_current_banner_to_server(key)
                elif which == 1:
                    self._server_delete_banner()
                    self._notify("–ë–∞–Ω–Ω–µ—Ä —É–¥–∞–ª—ë–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞")
            builder.set_items(options, on_server_option)
            builder.set_negative_button("–ù–∞–∑–∞–¥", None)
            builder.show()
        except Exception:
            pass
    def _show_url_input_dialog(self, parent, key):
        try:
            et = EditText(parent)
            et.setInputType(InputType.TYPE_CLASS_TEXT | InputType.TYPE_TEXT_VARIATION_URI)
            current = self._get_profile_source(key) or ""
            if not str(current).startswith("avatar://"):
                try:
                    if current:
                        et.setText(current)
                        et.setSelection(len(current))
                except Exception:
                    pass
            builder = AlertDialogBuilder(parent)
            builder.set_title("–ö–∞—Å—Ç–æ–º–Ω—ã–π —Ñ–æ–Ω –ø—Ä–æ—Ñ–∏–ª—è")
            builder.set_message(f"–ü—Ä–æ—Ñ–∏–ª—å: {key}\n–í—Å—Ç–∞–≤—å—Ç–µ URL/–ø—É—Ç—å/URI –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
            builder.set_view(et)
            builder.set_positive_button("–ü—Ä–∏–º–µ–Ω–∏—Ç—å", lambda dlg, which: self._apply_menu_input_for_key(et, key))
            builder.set_negative_button("–û—Ç–º–µ–Ω–∞", None)
            builder.show()
        except Exception:
            pass
    def _apply_menu_input_for_key(self, et, key):
        try:
            value = str(et.getText()).strip()
            if not value:
                self._notify("–ü—É—Å—Ç–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫")
                return
            self._set_profile_source(key, value)
            self._set_bool(self.SETTINGS_ENABLE, True)
            self._drop_bitmap_cache_for_key(key)
            self._notify("–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ—Ö—Ä–∞–Ω—ë–Ω (–ª–æ–∫–∞–ª—å–Ω–æ)")
            f = self._safe_get_fragment()
            self._invalidate_profile_view(f)
            run_on_ui_thread(lambda: self._prompt_effect_choice(key, then=lambda: self._prompt_text_mode_choice(key)))
        except Exception:
            pass
    class _ActivityResultHook(MethodHook):
        def __init__(self, plugin, profile_key):
            self.plugin = plugin
            self.profile_key = profile_key
        def before_hooked_method(self, param):
            try:
                request_code = param.args[0]
                result_code = param.args[1]
                data = param.args[2]
                if request_code == self.plugin.FILE_PICKER_REQUEST_CODE:
                    param.setResult(None)
                    if result_code == Activity.RESULT_OK and data is not None:
                        uri = data.getData()
                        if uri is not None:
                            threading.Thread(
                                target=self.plugin._handle_file_uri_for_key,
                                args=(uri, self.profile_key),
                                daemon=True
                            ).start()
                    try:
                        if self.plugin._activity_hook:
                            self.plugin._activity_hook.unhook()
                            self.plugin._activity_hook = None
                    except Exception:
                        pass
            except Exception as e:
                self.plugin._log(f"_ActivityResultHook error: {e}")
    def _launch_file_picker(self, profile_key):
        try:
            fragment = self._safe_get_fragment()
            activity = fragment.getParentActivity() if fragment else None
            if not activity:
                BulletinHelper.show("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π —ç–∫—Ä–∞–Ω.")
                return
            if self._activity_hook:
                try:
                    self._activity_hook.unhook()
                except Exception:
                    pass
                self._activity_hook = None
            IntegerTYPE = find_class("java.lang.Integer").TYPE
            method = activity.getClass().getDeclaredMethod("onActivityResult", IntegerTYPE, IntegerTYPE, Intent)
            self._activity_hook = self.hook_method(method, self._ActivityResultHook(self, profile_key))
            intent = Intent(Intent.ACTION_GET_CONTENT)
            intent.setType("*/*")
            activity.startActivityForResult(
                Intent.createChooser(intent, "–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –≤–∏–¥–µ–æ"),
                self.FILE_PICKER_REQUEST_CODE
            )
        except Exception:
            pass
    def _handle_file_uri_for_key(self, uri: Uri, profile_key: str):
        ins = None
        try:
            cr = ApplicationLoader.applicationContext.getContentResolver()
            ins = cr.openInputStream(uri)
            if not ins:
                run_on_ui_thread(lambda: BulletinHelper.show("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Ñ–∞–π–ª"))
                return
            mime_type = cr.getType(uri) or ""
            is_video = "video" in mime_type or "mp4" in mime_type
            ext = ".mp4" if is_video else ".jpg"
            fname = f"profile_{self._sanitize_key(profile_key)}{ext}"
            out_path = os.path.join(self._plugin_dir, fname)
            
            # CRITICAL: Kill old video player BEFORE overwriting the file!
            # The new video gets saved to the SAME path, so path-based guards
            # would think nothing changed and keep playing the old cached stream.
            if is_video or self._video_source == out_path:
                try:
                    run_on_ui_thread(lambda: self._release_video())
                    self._active_video_args = None
                    self._video_source = None
                    time.sleep(0.15)  # Let UI thread process the release
                except Exception:
                    pass
            
            # Drop bitmap cache so onDraw doesn't use stale frames
            self._drop_bitmap_cache_for_key(profile_key)
            
            if not is_video:
                try:
                    from android.graphics import BitmapFactory, Bitmap
                    opts = BitmapFactory.Options()
                    opts.inJustDecodeBounds = True
                    tmp_in = cr.openInputStream(uri)
                    BitmapFactory.decodeStream(tmp_in, None, opts)
                    tmp_in.close()
                    max_dim = 1280
                    scale = 1
                    if opts.outWidth > max_dim or opts.outHeight > max_dim:
                        scale = int(max(opts.outWidth, opts.outHeight) / max_dim)
                    opts.inJustDecodeBounds = False
                    opts.inSampleSize = scale
                    real_in = cr.openInputStream(uri)
                    bmp = BitmapFactory.decodeStream(real_in, None, opts)
                    real_in.close()
                    if bmp is not None:
                        out = FileOutputStream(out_path)
                        bmp.compress(Bitmap.CompressFormat.JPEG, 85, out)
                        out.close()
                        bmp.recycle()
                    else:
                        raise Exception("Failed to decode image")
                except Exception as e:
                    self._log(f"Image compress error: {e}")
                    out = FileOutputStream(out_path)
                    try:
                        ins_fb = cr.openInputStream(uri)
                        buf = bytearray(8192)
                        while True:
                            r = ins_fb.read(buf)
                            if r == -1: break
                            out.write(buf, 0, r)
                        ins_fb.close()
                    finally:
                        out.close()
            else:
                out = FileOutputStream(out_path)
                try:
                    buf = bytearray(8192)
                    while True:
                        r = ins.read(buf)
                        if r == -1:
                            break
                        out.write(buf, 0, r)
                finally:
                    out.close()
            self._set_profile_source(profile_key, out_path)
            self._set_bool(self.SETTINGS_ENABLE, True)
            if is_video:
                self._check_video_size(out_path)
            
            # Auto-upload to server if enabled and it's the user's own profile
            my_uid = self._get_my_user_id()
            is_own = profile_key.startswith("uid_") and profile_key[4:] == my_uid
            if is_own:
                effect = self._get_profile_effect(profile_key)
                text_mode = self._get_profile_text_mode(profile_key)
                self._server_upload_banner(out_path, effect, text_mode)
            
            what = "–í–∏–¥–µ–æ" if ext == ".mp4" else "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"
            def _done_ui():
                self._notify(f"{what} —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ")
                self._invalidate_profile_view(self._safe_get_fragment())
                if is_video:
                    self._prompt_text_mode_choice(profile_key)
                else:
                    self._prompt_effect_choice(profile_key, then=lambda: self._prompt_text_mode_choice(profile_key))
            run_on_ui_thread(_done_ui)
        except Exception:
            run_on_ui_thread(lambda: BulletinHelper.show("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞"))
        finally:
            if ins is not None:
                try:
                    ins.close()
                except Exception:
                    pass
    def _prompt_text_mode_choice(self, key: str):
        try:
            fragment = self._safe_get_fragment()
            parent = fragment.getParentActivity() if fragment else None
            if parent is None:
                return
            b = AlertDialogBuilder(parent)
            b.set_title("–°—Ç–∏–ª—å —Ç–µ–∫—Å—Ç–∞ –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–∞")
            b.set_message("–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –∞–≤–∞—Ç–∞—Ä–∫–æ–π –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è")
            b.set_positive_button("–°–≤–µ—Ç–ª—ã–π", lambda dlg, which: self._apply_text_mode_choice(key, "light"))
            b.set_negative_button("–¢—ë–º–Ω—ã–π", lambda dlg, which: self._apply_text_mode_choice(key, "dark"))
            b.set_neutral_button("–ù–µ –º–µ–Ω—è—Ç—å", lambda dlg, which: self._apply_text_mode_choice(key, ""))
            b.show()
        except Exception:
            pass
    def _apply_text_mode_choice(self, key: str, mode: str):
        try:
            self._set_profile_text_mode(key, mode)
            if not mode or mode == "":
                self._reset_theme_colors()
            self._invalidate_profile_view(self._safe_get_fragment())
            if mode == "light":
                self._notify("–¢–µ–∫—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: —Å–≤–µ—Ç–ª—ã–π")
            elif mode == "dark":
                self._notify("–¢–µ–∫—Å—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: —Ç—ë–º–Ω—ã–π")
            else:
                self._notify("–†–µ–∂–∏–º —Ç–µ–∫—Å—Ç–∞ —Å–±—Ä–æ—à–µ–Ω (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)")
        except Exception:
            pass
    def _get_profile_text_mode(self, key: str) -> str:
        try:
            v = self.get_setting(self._k_textmode(key), "")
            s = "" if v is None else str(v).strip().lower()
            if s in ("light", "dark"):
                return s
            srv_tm = self._get_server_text_mode_for_key(key)
            if srv_tm in ("light", "dark"):
                return srv_tm
            return ""
        except Exception:
            return ""
    def _set_profile_text_mode(self, key: str, value: str):
        try:
            value = (value or "").strip().lower()
            if value not in ("light", "dark", ""):
                value = ""
            self.set_setting(self._k_textmode(key), value)
        except Exception:
            pass
    def _k_textmode(self, key: str) -> str:
        return f"{self.TEXTMODE_PREFIX}{key}"
    def _sanitize_effect(self, value: str) -> str:
        s = (value or "").strip().lower()
        return s if s in ("none", "blur", "darken") else "none"
    def _prompt_effect_choice(self, key: str, then=None):
        try:
            fragment = self._safe_get_fragment()
            parent = fragment.getParentActivity() if fragment else None
            if parent is None:
                if then:
                    then()
                return
            b = AlertDialogBuilder(parent)
            b.set_title("–≠—Ñ—Ñ–µ–∫—Ç —Ñ–æ–Ω–∞")
            b.set_message("–í—ã–±–µ—Ä–∏—Ç–µ —ç—Ñ—Ñ–µ–∫—Ç –¥–ª—è –±–∞–Ω–Ω–µ—Ä–∞ –≤ —ç—Ç–æ–º –ø—Ä–æ—Ñ–∏–ª–µ")
            b.set_positive_button("–†–∞–∑–º—ã—Ç–∏–µ", lambda dlg, which: self._apply_effect_choice(key, "blur", then))
            b.set_negative_button("–ó–∞—Ç–µ–º–Ω–∏—Ç—å", lambda dlg, which: self._apply_effect_choice(key, "darken", then))
            b.set_neutral_button("–ë–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤", lambda dlg, which: self._apply_effect_choice(key, "none", then))
            b.show()
        except Exception:
            try:
                if then:
                    then()
            except Exception:
                pass
    def _apply_effect_choice(self, key: str, effect: str, then=None):
        try:
            self._set_profile_effect(key, effect)
            self._drop_bitmap_cache_for_key(key)
            self._invalidate_profile_view(self._safe_get_fragment())
            eff_name = {"none": "–±–µ–∑ —ç—Ñ—Ñ–µ–∫—Ç–æ–≤", "blur": "—Ä–∞–∑–º—ã—Ç–∏–µ", "darken": "–∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ"}.get(effect, effect)
            self._notify(f"–≠—Ñ—Ñ–µ–∫—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω: {eff_name}")
        except Exception:
            pass
        finally:
            try:
                if then:
                    then()
            except Exception:
                pass
    def _k_effect(self, key: str) -> str:
        return f"{self.EFFECT_PREFIX}{key}"
    def _get_profile_effect(self, key: str) -> str:
        try:
            src = self._get_profile_source(key)
            is_avatar_source = str(src).startswith("avatar://")
            v = self.get_setting(self._k_effect(key), None)
            if v is not None and str(v).strip() != "":
                s = self._sanitize_effect(v)
                if is_avatar_source and s == "none":
                    avatar_effect = self._get_effect_str(self.SETTINGS_AVATAR_BANNER_EFFECT, "darken")
                    return avatar_effect
                return s
            srv_eff = self._get_server_effect_for_key(key)
            if srv_eff in ("none", "blur", "darken"):
                return srv_eff
            if is_avatar_source:
                avatar_effect = self._get_effect_str(self.SETTINGS_AVATAR_BANNER_EFFECT, "darken")
                return avatar_effect
            default_effect = self._get_effect_str(self.SETTINGS_EFFECT_DEFAULT, "blur")
            return default_effect
        except Exception:
            return self._get_effect_str(self.SETTINGS_EFFECT_DEFAULT, "blur")
    def _set_profile_effect(self, key: str, value: str):
        try:
            self.set_setting(self._k_effect(key), self._sanitize_effect(value))
        except Exception:
            pass
    def _alloc_int_array(self, n: int):
        arr = None
        if JAVA_ARRAY_AVAILABLE:
            try:
                arr = jarray('i')(int(n))
            except Exception:
                try:
                    arr = jarray('I')(int(n))
                except Exception:
                    arr = None
        if arr is None:
            try:
                IntegerTYPE = find_class("java.lang.Integer").TYPE
                Array = find_class("java.lang.reflect.Array")
                arr = Array.newInstance(IntegerTYPE, int(n))
            except Exception:
                arr = None
        return arr
    def _array_get(self, arr, i: int) -> int:
        try:
            return int(arr[i])
        except Exception:
            try:
                Array = find_class("java.lang.reflect.Array")
                return int(Array.get(arr, int(i)))
            except Exception:
                return 0
    def _array_set(self, arr, i: int, val: int) -> bool:
        try:
            arr[i] = int(val)
            return True
        except Exception:
            try:
                Array = find_class("java.lang.reflect.Array")
                Array.set(arr, int(i), int(val))
                return True
            except Exception:
                return False
    def _get_blurred_bitmap_for_key(self, key: str, bmp):
        try:
            blur_percent = self._get_percent(self.SETTINGS_BLUR_INTENSITY, 60)
            if self._last_blur_percent != blur_percent:
                try:
                    self._bmp_blur_map.clear()
                except Exception:
                    self._bmp_blur_map = {}
                self._last_blur_percent = blur_percent
            cached = self._bmp_blur_map.get(key)
            if cached:
                cached_bmp, cached_percent = cached
                if cached_percent == blur_percent and cached_bmp is not None and not cached_bmp.isRecycled():
                    return cached_bmp
            bw = bmp.getWidth()
            bh = bmp.getHeight()
            if bw <= 2 or bh <= 2:
                return bmp
            ratio = max(1, min(100, int(blur_percent))) / 100.0
            max_side = max(bw, bh)
            downscale_factor = max(0.45, min(0.85, 0.85 - 0.40 * ratio))  
            target_side = int(max(360, max_side * downscale_factor))
            target_side = min(target_side, 1080)
            scale = min(1.0, float(target_side) / float(max_side))
            sw = max(2, int(bw * scale))
            sh = max(2, int(bh * scale))
            small = Bitmap.createScaledBitmap(bmp, sw, sh, True)
            radius = int(5 + ratio * 22)  
            radius = max(2, min(radius, max(2, min(sw, sh) // 2 - 1)))
            passes = 2 if blur_percent < 75 else 3
            blurred_small = None
            rs_radius = min(20.0, float(max(2.0, radius * 0.8)))  
            rs_passes = 1 if blur_percent < 85 else 2
            try:
                blurred_small = self._renderscript_blur(small, radius=rs_radius, passes=rs_passes)
            except Exception:
                blurred_small = None
            if blurred_small is None:
                blurred_small = self._box_blur_bitmap(small, radius=radius, passes=passes)
            if blurred_small is None:
                return bmp
            try:
                blurred = Bitmap.createScaledBitmap(blurred_small, sw, sh, True)
            except Exception:
                blurred = blurred_small
            try:
                if blurred_small is not None and blurred_small != blurred and not blurred_small.isRecycled():
                    blurred_small.recycle()
            except Exception:
                pass
            self._bmp_blur_map[key] = (blurred, blur_percent)
            return blurred
        except Exception:
            return bmp
    def _box_blur_bitmap(self, bmp, radius=10, passes=2):
        try:
            w = bmp.getWidth()
            h = bmp.getHeight()
            if w <= 1 or h <= 1:
                return bmp
            radius = max(1, int(radius))
            passes = max(1, int(passes))
            total = w * h
            arr_in = self._alloc_int_array(total)
            if arr_in is None:
                return bmp
            try:
                bmp.getPixels(arr_in, 0, w, 0, 0, w, h)
            except Exception:
                return bmp
            pixels = [self._array_get(arr_in, i) for i in range(total)]
            a = [0] * total
            r = [0] * total
            g = [0] * total
            b = [0] * total
            for i, px in enumerate(pixels):
                a[i] = (px >> 24) & 0xFF
                r[i] = (px >> 16) & 0xFF
                g[i] = (px >> 8) & 0xFF
                b[i] = px & 0xFF
            def blur_lines(buf_in, buf_out, line_count, line_len, rad):
                window = rad * 2 + 1
                for line in range(line_count):
                    base = line * line_len
                    acc = 0
                    for i in range(-rad, rad + 1):
                        idx = base + (0 if i < 0 else (line_len - 1 if i >= line_len else i))
                        acc += buf_in[idx]
                    for x in range(line_len):
                        buf_out[base + x] = acc // window
                        left = x - rad
                        right = x + rad + 1
                        left_idx = base + (0 if left < 0 else left)
                        right_idx = base + (line_len - 1 if right >= line_len else right)
                        acc += buf_in[right_idx] - buf_in[left_idx]
            def blur_cols(buf_in, buf_out, line_count, line_len, rad):
                window = rad * 2 + 1
                for x in range(line_len):
                    acc = 0
                    for i in range(-rad, rad + 1):
                        row = 0 if i < 0 else (line_count - 1 if i >= line_count else i)
                        acc += buf_in[row * line_len + x]
                    for y in range(line_count):
                        idx = y * line_len + x
                        buf_out[idx] = acc // window
                        up = y - rad
                        down = y + rad + 1
                        up_row = 0 if up < 0 else up
                        down_row = line_count - 1 if down >= line_count else down
                        acc += buf_in[down_row * line_len + x] - buf_in[up_row * line_len + x]
            tmp = [0] * total
            for _ in range(passes):
                blur_lines(r, tmp, h, w, radius); r, tmp = tmp, r
                blur_lines(g, tmp, h, w, radius); g, tmp = tmp, g
                blur_lines(b, tmp, h, w, radius); b, tmp = tmp, b
                blur_cols(r, tmp, h, w, radius); r, tmp = tmp, r
                blur_cols(g, tmp, h, w, radius); g, tmp = tmp, g
                blur_cols(b, tmp, h, w, radius); b, tmp = tmp, b
            out_pixels = [0] * total
            for i in range(total):
                out_pixels[i] = ((a[i] & 0xFF) << 24) | ((r[i] & 0xFF) << 16) | ((g[i] & 0xFF) << 8) | (b[i] & 0xFF)
            out_bmp = Bitmap.createBitmap(w, h, Bitmap.Config.ARGB_8888)
            arr_out = self._alloc_int_array(total)
            if arr_out is None:
                try:
                    out_bmp.setPixels(out_pixels, 0, w, 0, 0, w, h)
                    return out_bmp
                except Exception:
                    return bmp
            for i, v in enumerate(out_pixels):
                if not self._array_set(arr_out, i, v):
                    return bmp
            try:
                out_bmp.setPixels(arr_out, 0, w, 0, 0, w, h)
            except Exception:
                return bmp
            return out_bmp
        except Exception:
            return bmp
    def _watcher_loop(self):
        while not self._watcher_stop:
            try:
                fragment = get_last_fragment()
                if fragment is not None and fragment.getClass().getName().endswith(".ProfileActivity"):
                    topview = self._find_topview_instance(fragment)
                    if topview is not None:
                        self._ensure_hook_on_topview_instance(topview)
                time.sleep(2.0)
            except Exception:
                time.sleep(1.0)
    def _find_topview_instance(self, fragment):
        try:
            cls = fragment.getClass()
            for fname in ("topView", "mTopView"):
                try:
                    f = cls.getDeclaredField(fname)
                    f.setAccessible(True)
                    v = f.get(fragment)
                    if v is not None:
                        return v
                except Exception:
                    pass
        except Exception:
            pass
        try:
            root = fragment.getFragmentView()
            if root is None:
                return None
            stack = [root]
            while stack:
                v = stack.pop()
                try:
                    name = v.getClass().getName()
                    if name.endswith("ProfileActivity$TopView") or "ProfileActivity$TopView" in name:
                        return v
                except Exception:
                    pass
                if isinstance(v, ViewGroup):
                    for i in range(v.getChildCount() - 1, -1, -1):
                        try:
                            stack.append(v.getChildAt(i))
                        except Exception:
                            pass
        except Exception:
            pass
        return None
    def _ensure_hook_on_topview_instance(self, topview):
        try:
            cls = topview.getClass()
            clsname = cls.getName()
            if self._hook_on_draw_ref is not None and self._hooked_topview_classname == clsname:
                return
            if self._hook_on_draw_ref is not None and self._hooked_topview_classname is not None:
                try:
                    self.unhook_method(self._hook_on_draw_ref)
                except Exception:
                    pass
                self._hook_on_draw_ref = None
                self._hooked_topview_classname = None
            canvas_param = JCanvas if JCanvas is not None else self._CanvasClass
            if canvas_param is None:
                return
            ondraw = cls.getDeclaredMethod("onDraw", canvas_param)
            ondraw.setAccessible(True)
            self._hook_on_draw_ref = self.hook_method(ondraw, _TopViewOnDrawHook(self))
            self._hooked_topview_classname = clsname
        except Exception:
            pass
    def _load_avatar_bitmap(self, key: str):
        try:
            from android.graphics import BitmapFactory
            from java.io import File as JFile
            if key.startswith("uid_"):
                user_id = int(key[4:])
                is_user = True
            elif key.startswith("cid_"):
                chat_id = int(key[4:])
                is_user = False
            else:
                return None
            UserConfig = find_class("org.telegram.messenger.UserConfig")
            current_account = UserConfig.selectedAccount
            MessagesController = find_class("org.telegram.messenger.MessagesController")
            controller = MessagesController.getInstance(current_account)
            if is_user:
                User = find_class("org.telegram.tgnet.TLRPC$User")
                user = controller.getUser(user_id)
                if user is None:
                    return None
                photo = user.photo
                if photo is None:
                    return None
                file_location = photo.photo_big
            else:
                Chat = find_class("org.telegram.tgnet.TLRPC$Chat")
                chat = controller.getChat(abs(chat_id))
                if chat is None:
                    return None
                photo = chat.photo
                if photo is None:
                    return None
                file_location = photo.photo_big
            if file_location is None:
                return None
            FileLoader = find_class("org.telegram.messenger.FileLoader")
            file_loader = FileLoader.getInstance(current_account)
            avatar_file = file_loader.getPathToAttach(file_location, True)
            if avatar_file is None or not avatar_file.exists():
                return None
            bitmap = BitmapFactory.decodeFile(avatar_file.getAbsolutePath())
            return bitmap
        except Exception as e:
            return None
    MAX_BMP_CACHE = 10
    def _ensure_bitmap_for_key(self, key: str):
        if not self._get_bool(self.SETTINGS_ENABLE, False):
            return None
        src = self._get_profile_source(key)
        if not src:
            return None
        cached = self._bmp_map.get(key)
        if cached is not None and self._src_map.get(key) == src and not cached.isRecycled():
            return cached
        bmp = None
        try:
            if str(src).startswith("avatar://"):
                try:
                    bmp = self._load_avatar_bitmap(key)
                    if bmp is not None:
                        bmp = self._cap_bitmap_size(bmp, 4096, 4096)
                        self._bmp_map[key] = bmp
                        self._src_map[key] = str(src)
                        self._evict_bmp_cache(key)
                        return bmp
                    else:
                        global_src = self._get_str(self.SETTINGS_SOURCE_GLOBAL, "").strip()
                        if global_src and not global_src.startswith("avatar://"):
                            src = global_src
                        else:
                            return None
                except Exception:
                    global_src = self._get_str(self.SETTINGS_SOURCE_GLOBAL, "").strip()
                    if global_src and not global_src.startswith("avatar://"):
                        src = global_src
                    else:
                        return None
            if str(src).startswith("file://"):
                try:
                    p = Uri.parse(src).getPath()
                    src = p if p else src[7:]
                except Exception:
                    src = src[7:]
            is_video_src = str(src).lower().endswith(".mp4")
            if is_video_src:
                try:
                    placeholder = Bitmap.createBitmap(1, 1, Bitmap.Config.ARGB_8888)
                    placeholder.eraseColor(Color.BLACK)
                    self._bmp_map[key] = placeholder
                    self._src_map[key] = str(src)
                    
                    if not hasattr(self, "_extracting_keys"):
                        self._extracting_keys = set()
                        
                    if key not in self._extracting_keys:
                        self._extracting_keys.add(key)
                        def _extract_video_frame():
                            try:
                                bmp_frame = self._decode_bitmap_file(str(src))
                                if bmp_frame is not None:
                                    bmp_frame = self._cap_bitmap_size(bmp_frame, 4096, 4096)
                                    self._bmp_map[key] = bmp_frame
                                    self._evict_bmp_cache(key)
                                    from android_utils import run_on_ui_thread
                                    run_on_ui_thread(lambda: self._invalidate_profile_view(None))
                            except Exception as e:
                                self._log(f"Async frame extraction error: {e}")
                            finally:
                                self._extracting_keys.discard(key)
                        
                        import threading
                        threading.Thread(target=_extract_video_frame, daemon=True).start()
                    
                    return placeholder
                except Exception:
                    pass
            
            if str(src).startswith("http://") or str(src).startswith("https://"):
                target = self._get_cache_path_for_key(key)
                ok = False
                try:
                    import requests
                    headers = {
                        "User-Agent": "Mozilla/5.0 (Android 13; exteraGram Plugin)",
                        "Accept": "image/avif,image/webp,image/apng,image/*,*/*;q=0.8",
                        "Referer": str(src)
                    }
                    r = requests.get(str(src), stream=True, timeout=25, headers=headers, allow_redirects=True, verify=True)
                    r.raise_for_status()
                    with open(target, "wb") as f:
                        for chunk in r.iter_content(65536):
                            if chunk:
                                f.write(chunk)
                    ok = True
                except Exception:
                    ok = False
                if not ok:
                    try:
                        from java.net import URL as JURL
                        conn = JURL(str(src)).openConnection()
                        try:
                            conn.setInstanceFollowRedirects(True)
                            conn.setConnectTimeout(20000)
                            conn.setReadTimeout(25000)
                            conn.setRequestProperty("User-Agent", "Mozilla/5.0 (Android 13; exteraGram Plugin)")
                            conn.setRequestProperty("Accept", "image/avif,image/webp,image/apng,image/*,*/*;q=0.8")
                            conn.setRequestProperty("Referer", str(src))
                        except Exception:
                            pass
                        inp = BufferedInputStream(conn.getInputStream())
                        out = FileOutputStream(target)
                        try:
                            buf = bytearray(64 * 1024)
                            while True:
                                read = inp.read(buf)
                                if read == -1:
                                    break
                                out.write(buf, 0, read)
                        finally:
                            try: out.close()
                            except Exception: pass
                            try: inp.close()
                            except Exception: pass
                            try: conn.disconnect()
                            except Exception: pass
                        ok = True
                    except Exception:
                        ok = False
                if ok:
                    bmp = self._decode_bitmap_file(target)
                else:
                    self._alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏", "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
                    return None
            elif str(src).startswith("content://"):
                try:
                    ctx = ApplicationLoader.applicationContext
                    uri = Uri.parse(str(src))
                    stream = ctx.getContentResolver().openInputStream(uri)
                    if stream is not None:
                        bis = BufferedInputStream(stream)
                        bmp = BitmapFactory.decodeStream(bis)
                        try:
                            bis.close(); stream.close()
                        except Exception:
                            pass
                except Exception:
                    self._alert("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è URI", "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç")
            else:
                bmp = self._decode_bitmap_file(str(src))
            if bmp is None:
                self._alert("–ö–∞—Ä—Ç–∏–Ω–∫–∞", "–ù–µ —É–¥–∞–ª–æ—Å—å –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ")
                return None
            bmp = self._cap_bitmap_size(bmp, 4096, 4096)
            self._bmp_map[key] = bmp
            self._src_map[key] = str(src)
            self._evict_bmp_cache(key)
            return bmp
        except Exception as e:
            self._log(f"Ensure bitmap error: {e}")
            return None
    def _evict_bmp_cache(self, new_key):
        try:
            if new_key in self._bmp_order:
                self._bmp_order.remove(new_key)
            self._bmp_order.append(new_key)
            while len(self._bmp_order) > self.MAX_BMP_CACHE:
                oldest = self._bmp_order.pop(0)
                old_bmp = self._bmp_map.pop(oldest, None)
                self._bmp_blur_map.pop(oldest, None)
                self._src_map.pop(oldest, None)
                if old_bmp is not None:
                    try:
                        if not old_bmp.isRecycled():
                            old_bmp.recycle()
                    except Exception:
                        pass
        except Exception:
            pass
    def _decode_bitmap_file(self, path):
        try:
            if not path:
                return None
            f = File(path)
            if not f.exists():
                return None
            if str(path).lower().endswith(".mp4"):
                try:
                    from android.media import MediaMetadataRetriever
                    mmr = MediaMetadataRetriever()
                    mmr.setDataSource(str(path))
                    bmp = mmr.getFrameAtTime(0)  
                    mmr.release()
                    return bmp
                except Exception:
                    return None
            opts = BitmapFactory.Options()
            opts.inPreferredConfig = Bitmap.Config.ARGB_8888
            bmp = BitmapFactory.decodeFile(path, opts)
            return bmp
        except Exception:
            return None
    def _is_video_source(self, key):
        src = self._src_map.get(key, "")
        return src.lower().endswith(".mp4") if src else False
    def _is_fetching_server_banner(self, key):
        """Check if a server banner fetch is in progress for this profile key."""
        try:
            if not key.startswith("uid_"):
                return False
            uid_str = key[4:]
            return uid_str in getattr(self, "_fetching_users", set())
        except Exception:
            return False
    def _setup_video_overlay(self, topview, video_path, width, height):
        try:
            if (self._video_player is not None and
                self._video_source == video_path and
                self._video_topview == topview):
                if self._video_texture is not None:
                    try:
                        lp = self._video_texture.getLayoutParams()
                        if lp is not None and (lp.width != int(width) or lp.height != int(height)):
                            lp.width = int(width)
                            lp.height = int(height)
                            self._video_texture.setLayoutParams(lp)
                            self._apply_center_crop_matrix(self._video_texture, width, height)
                    except Exception:
                        pass
                return
            self._release_video()
            
            from android.view import TextureView as JTextureView
            from android.widget import FrameLayout as JFrameLayout
            from android.media import MediaPlayer as JMediaPlayer
            from android.view import Surface as JSurface
            import threading
            import time
            
            # Sweep forcefully any leftover TextureViews to prevent ghost videos
            try:
                for i in range(topview.getChildCount() - 1, -1, -1):
                    child = topview.getChildAt(i)
                    if isinstance(child, JTextureView):
                        topview.removeViewAt(i)
            except Exception as e:
                self._log(f"Sweep views error: {e}")
                
            texture = JTextureView(topview.getContext())
            lp = JFrameLayout.LayoutParams(int(width), int(height))
            topview.addView(texture, 0, lp)
            
            player = JMediaPlayer()
            is_muted = self._get_bool(self.SETTINGS_VIDEO_MUTE, True)
            
            def _video_thread():
                try:
                    st = None
                    for _ in range(20): 
                        st = texture.getSurfaceTexture()
                        if st is not None:
                            break
                        time.sleep(0.1)
                    if st is None:
                        return
                    surface = JSurface(st)
                    player.setSurface(surface)
                    player.setDataSource(video_path)
                    player.prepare()
                    if is_muted:
                        player.setVolume(0.0, 0.0)
                    else:
                        player.setVolume(1.0, 1.0)
                    player.start()
                    vid_w = player.getVideoWidth()
                    vid_h = player.getVideoHeight()
                    duration = player.getDuration()
                    if vid_w > 0 and vid_h > 0:
                        from android_utils import run_on_ui_thread
                        run_on_ui_thread(lambda: self._apply_center_crop_matrix(texture, width, height, vid_w, vid_h))
                    try:
                        from java import jclass, dynamic_proxy
                        OnCompletionListener = jclass("android.media.MediaPlayer$OnCompletionListener")
                        class MPListener(dynamic_proxy(OnCompletionListener)):
                            def __init__(self, p):
                                super().__init__()
                                self.p = p
                            def onCompletion(self, mp):
                                try:
                                    mp.seekTo(0)
                                    mp.start()
                                except Exception:
                                    pass
                        player.setOnCompletionListener(MPListener(player))
                    except Exception as e:
                        self._log(f"CompletionListener set error: {e}")
                    while self._video_player == player and not self._watcher_stop:
                        if not topview.isAttachedToWindow():
                            from android_utils import run_on_ui_thread
                            run_on_ui_thread(lambda: self._release_video())
                            break
                        if duration > 0 and player.isPlaying():
                            pos = player.getCurrentPosition()
                            if duration - pos < 150: 
                                player.seekTo(0)
                        time.sleep(0.5)
                except Exception as e:
                    self._log(f"Video thread error: {e}")
            threading.Thread(target=_video_thread, daemon=True).start()
            self._video_player = player
            self._video_texture = texture
            self._video_source = video_path
            self._video_topview = topview
        except Exception as e:
            self._log(f"Video setup error: {e}")
    def _apply_center_crop_matrix(self, texture, view_w, view_h, vid_w=None, vid_h=None):
        try:
            from android.graphics import Matrix as JMatrix
            if vid_w is None or vid_h is None:
                if self._video_player:
                    vid_w = self._video_player.getVideoWidth()
                    vid_h = self._video_player.getVideoHeight()
            if not vid_w or not vid_h or not view_w or not view_h:
                return
            matrix = JMatrix()
            scaleX = float(view_w) / float(vid_w)
            scaleY = float(view_h) / float(vid_h)
            scale = max(scaleX, scaleY)
            sx = scale / scaleX
            sy = scale / scaleY
            pivotX = view_w / 2.0
            pivotY = view_h / 2.0
            matrix.setScale(sx, sy, pivotX, pivotY)
            texture.setTransform(matrix)
        except Exception as e:
            self._log(f"Matrix crop error: {e}")
    def _release_video(self):
        try:
            if self._video_player is not None:
                vp = self._video_player
                self._video_player = None 
                try:
                    vp.stop()
                    vp.release()
                except Exception:
                    pass
            if self._video_texture is not None and self._video_topview is not None:
                try:
                    self._video_topview.removeView(self._video_texture)
                except Exception:
                    pass
                self._video_texture = None
            self._video_source = None
            self._video_topview = None
        except Exception:
            pass
    def _cap_bitmap_size(self, bmp, max_w=2048, max_h=2048):
        try:
            w = bmp.getWidth()
            h = bmp.getHeight()
            if w <= max_w and h <= max_h:
                return bmp
            scale = min(max_w / float(max(1, w)), max_h / float(max(1, h)))
            nw = max(1, int(w * scale))
            nh = max(1, int(h * scale))
            scaled = Bitmap.createScaledBitmap(bmp, nw, nh, True)
            if scaled != bmp:
                try:
                    if not bmp.isRecycled():
                        bmp.recycle()
                except Exception:
                    pass
            return scaled
        except Exception:
            return bmp
    def _ensure_plugin_dir(self):
        try:
            base_dir = ApplicationLoader.getFilesDirFixed()
            if base_dir:
                plugin_folder = File(base_dir, self.id)
                if not plugin_folder.exists():
                    plugin_folder.mkdirs()
                self._plugin_dir = plugin_folder.getAbsolutePath()
        except Exception:
            pass
    def _get_profile_source(self, key: str) -> str:
        per = self.get_setting(self._k_src(key), "")
        per_str = str(per).strip()
        if per_str == "none":
            return ""
        if per_str:
            return per_str
        srv_path = self._try_server_source_for_key(key)
        if srv_path:
            return srv_path
        is_avatar_banner_enabled = self._get_bool(self.SETTINGS_AVATAR_BANNER_ENABLE, True)
        if is_avatar_banner_enabled:
            global_src = self._get_str(self.SETTINGS_SOURCE_GLOBAL, "").strip()
            if global_src and not global_src.startswith("avatar://"):
                return global_src
            else:
                return f"avatar://{key}"
        return self._get_str(self.SETTINGS_SOURCE_GLOBAL, "").strip()
    def _set_profile_source(self, key: str, value: str):
        self.set_setting(self._k_src(key), value)
    def _k_src(self, key: str) -> str:
        return f"profileHeader.source.{key}"
    def _sanitize_key(self, key: str) -> str:
        return re.sub(r"[^a-zA-Z0-9_\-\.]", "_", key)
    def _get_cache_path_for_key(self, key: str):
        fname = f"cache_{self._sanitize_key(key)}.jpg"
        try:
            base = self._plugin_dir or ApplicationLoader.applicationContext.getFilesDir().getAbsolutePath()
        except Exception:
            base = ApplicationLoader.applicationContext.getFilesDir().getAbsolutePath()
        return os.path.join(base, fname)
    def _drop_bitmap_cache_for_key(self, key: str):
        try:
            if key in self._bmp_map:
                del self._bmp_map[key]
            if key in self._bmp_blur_map:
                try:
                    del self._bmp_blur_map[key]
                except Exception:
                    pass
            if key in self._src_map:
                del self._src_map[key]
        except Exception:
            pass
    def _safe_get_fragment(self):
        try:
            if self._last_target_fragment_ref:
                f = self._last_target_fragment_ref()
                if f is not None:
                    return f
        except Exception:
            pass
        try:
            return get_last_fragment()
        except Exception:
            return None
    def _invalidate_profile_view(self, fragment):
        try:
            if fragment is None:
                fragment = get_last_fragment()
            if fragment is not None and fragment.getClass().getName().endswith(".ProfileActivity"):
                view = fragment.getFragmentView()
                if view is not None:
                    run_on_ui_thread(lambda: view.invalidate())
        except Exception:
            pass
    def _get_profile_key_from_fragment(self, fragment) -> str:
        try:
            cls = fragment.getClass()
            try:
                m = cls.getDeclaredMethod("getDialogId")
                m.setAccessible(True)
                did = m.invoke(fragment)
                if did is not None:
                    val = int(did)
                    return f"cid_{-val}" if val < 0 else f"uid_{val}"
            except Exception:
                pass
            for name in ("dialogId", "dialog_id"):
                try:
                    f = cls.getDeclaredField(name)
                    f.setAccessible(True)
                    val = f.get(fragment)
                    if val is not None:
                        val = int(val)
                        return f"cid_{-val}" if val < 0 else f"uid_{val}"
                except Exception:
                    pass
            uid = None
            cid = None
            for name in ("userId", "user_id"):
                try:
                    f = cls.getDeclaredField(name)
                    f.setAccessible(True)
                    uid = int(f.get(fragment)); break
                except Exception:
                    pass
            for name in ("chatId", "chat_id"):
                try:
                    f = cls.getDeclaredField(name)
                    f.setAccessible(True)
                    cid = int(f.get(fragment)); break
                except Exception:
                    pass
            if cid and cid > 0:
                return f"cid_{cid}"
            if uid and uid > 0:
                return f"uid_{uid}"
        except Exception:
            pass
        return "unknown"
    def _install_theme_hooks(self):
        try:
            ThemeClass = find_class("org.telegram.ui.ActionBar.Theme")
            StringClass = find_class("java.lang.String")
            IntegerTYPE = find_class("java.lang.Integer").TYPE
            BooleanTYPE = find_class("java.lang.Boolean").TYPE
            RPClass = None
            try:
                RPClass = find_class("org.telegram.ui.ActionBar.Theme$ResourcesProvider")
            except Exception:
                RPClass = None
            self._theme_keys = {}
            for name in ("key_profile_title", "key_avatar_subtitleInProfileBue", "key_avatar_subtitleInProfileBlue"):
                try:
                    f = ThemeClass.getDeclaredField(name)
                    f.setAccessible(True)
                    val = int(f.get(None))
                    self._theme_keys[name] = val
                except Exception:
                    pass
            methods_to_hook = []
            for sig in (
                ("getColor", (IntegerTYPE,)),
                ("getColor", (IntegerTYPE, BooleanTYPE)),
                ("getColorOrDefault", (IntegerTYPE,)),
            ):
                try:
                    m = ThemeClass.getDeclaredMethod(sig[0], *sig[1])
                    methods_to_hook.append(("int", m))
                except Exception:
                    pass
            if RPClass is not None:
                for sig in (
                    ("getColor", (IntegerTYPE, RPClass)),
                    ("getColorOrDefault", (IntegerTYPE, RPClass)),
                ):
                    try:
                        m = ThemeClass.getDeclaredMethod(sig[0], *sig[1])
                        methods_to_hook.append(("int", m))
                    except Exception:
                        pass
            for sig in (
                ("getColor", (StringClass,)),
                ("getColorOrDefault", (StringClass,)),
            ):
                try:
                    m = ThemeClass.getDeclaredMethod(sig[0], *sig[1])
                    methods_to_hook.append(("str", m))
                except Exception:
                    pass
            if RPClass is not None:
                for sig in (
                    ("getColor", (StringClass, RPClass)),
                    ("getColorOrDefault", (StringClass, RPClass)),
                ):
                    try:
                        m = ThemeClass.getDeclaredMethod(sig[0], *sig[1])
                        methods_to_hook.append(("str", m))
                    except Exception:
                        pass
            self._theme_hook_refs = []
            for kind, method in methods_to_hook:
                try:
                    if kind == "int":
                        ref = self.hook_method(method, _ThemeGetColorIntHook(self))
                    else:
                        ref = self.hook_method(method, _ThemeGetColorStrHook(self))
                    if ref:
                        self._theme_hook_refs.append(ref)
                except Exception:
                    pass
        except Exception:
            pass
    def _resolve_text_colors(self, mode: str):
        if mode == "light":
            return (Color.WHITE, Color.argb(230, 255, 255, 255))
        else:
            return (Color.BLACK, Color.argb(210, 0, 0, 0))
    def _current_profile_textmode(self):
        try:
            fragment = get_last_fragment()
            if fragment is None:
                return ("", None)
        except Exception:
            return ("", None)
        try:
            name = fragment.getClass().getName()
            if not (name.endswith(".ProfileActivity") or name.endswith("ProfileActivity")):
                return ("", fragment)
            key = self._get_profile_key_from_fragment(fragment)
            mode = self._get_profile_text_mode(key)
            return (mode, fragment)
        except Exception:
            return ("", fragment)
    def _apply_theme_overrides(self, mode: str):
        try:
            name_color, sub_color = self._resolve_text_colors(mode)
            ThemeClass = find_class("org.telegram.ui.ActionBar.Theme")
            StringClass = find_class("java.lang.String")
            IntegerTYPE = find_class("java.lang.Integer").TYPE
        except Exception:
            return
        for key, color in (("profile_title", name_color),
                           ("avatar_subtitleInProfileBue", sub_color),
                           ("avatar_subtitleInProfileBlue", sub_color)):
            try:
                m = ThemeClass.getDeclaredMethod("setColor", StringClass, IntegerTYPE)
                m.setAccessible(True)
                m.invoke(None, key, int(color))
            except Exception:
                pass
            try:
                BooleanTYPE = find_class("java.lang.Boolean").TYPE
                m2 = ThemeClass.getDeclaredMethod("setColor", StringClass, IntegerTYPE, BooleanTYPE)
                m2.setAccessible(True)
                m2.invoke(None, key, int(color), False)
            except Exception:
                pass
        try:
            k = self._theme_keys
            for ikey, color in (
                (k.get("key_profile_title"), name_color),
                (k.get("key_avatar_subtitleInProfileBue"), sub_color),
                (k.get("key_avatar_subtitleInProfileBlue"), sub_color),
            ):
                if ikey is None:
                    continue
                try:
                    m = ThemeClass.getDeclaredMethod("setColor", IntegerTYPE, IntegerTYPE)
                    m.setAccessible(True)
                    m.invoke(None, int(ikey), int(color))
                except Exception:
                    pass
                try:
                    BooleanTYPE = find_class("java.lang.Boolean").TYPE
                    m2 = ThemeClass.getDeclaredMethod("setColor", IntegerTYPE, IntegerTYPE, BooleanTYPE)
                    m2.setAccessible(True)
                    m2.invoke(None, int(ikey), int(color), False)
                except Exception:
                    pass
        except Exception:
            pass
    def _reset_theme_colors(self):
        try:
            ThemeClass = find_class("org.telegram.ui.ActionBar.Theme")
            StringClass = find_class("java.lang.String")
            IntegerTYPE = find_class("java.lang.Integer").TYPE
            try:
                m = ThemeClass.getDeclaredMethod("removeCustomColors", StringClass)
                m.setAccessible(True)
                for key_name in ("profile_title", "avatar_subtitleInProfileBue", "avatar_subtitleInProfileBlue"):
                    try:
                        m.invoke(None, key_name)
                    except Exception:
                        pass
            except Exception:
                pass
            try:
                BooleanTYPE = find_class("java.lang.Boolean").TYPE
                m_set = ThemeClass.getDeclaredMethod("setColor", StringClass, IntegerTYPE, BooleanTYPE)
                m_set.setAccessible(True)
                m_default = ThemeClass.getDeclaredMethod("getDefaultColor", StringClass)
                m_default.setAccessible(True)
                for key_name in ("profile_title", "avatar_subtitleInProfileBue", "avatar_subtitleInProfileBlue"):
                    try:
                        default_color = m_default.invoke(None, key_name)
                        m_set.invoke(None, key_name, int(default_color), False)
                    except Exception:
                        pass
            except Exception:
                pass
            try:
                BooleanTYPE = find_class("java.lang.Boolean").TYPE
                m_set = ThemeClass.getDeclaredMethod("setColor", IntegerTYPE, IntegerTYPE, BooleanTYPE)
                m_set.setAccessible(True)
                m_default = ThemeClass.getDeclaredMethod("getDefaultColor", IntegerTYPE)
                m_default.setAccessible(True)
                k = self._theme_keys
                for key_name, ikey in k.items():
                    if ikey is None:
                        continue
                    try:
                        default_color = m_default.invoke(None, int(ikey))
                        m_set.invoke(None, int(ikey), int(default_color), False)
                    except Exception:
                        pass
            except Exception:
                pass
        except Exception:
            pass
    def _apply_text_colors(self, topview, outer, mode: str):
        try:
            if not mode:
                return
            name_color, sub_color = self._resolve_text_colors(mode)
            use_shadow = (mode == "light")
            shadow_color = Color.argb(110, 0, 0, 0) if use_shadow else Color.argb(0, 0, 0, 0)
            # Theme hooks handle color overrides dynamically;
            # do NOT call _apply_theme_overrides() here as it permanently
            # modifies Theme.setColor() and corrupts sidebar/drawer colors.
            def _apply_to_tv_or_array(val, is_primary: bool):
                try:
                    try:
                        val.setTextColor(name_color if is_primary else sub_color)
                        val.setShadowLayer(
                            2.0 if (is_primary and use_shadow) else (1.5 if (not is_primary and use_shadow) else 0.0),
                            0.0,
                            1.0 if (is_primary and use_shadow) else (0.5 if (not is_primary and use_shadow) else 0.0),
                            shadow_color
                        )
                        return
                    except Exception:
                        pass
                    length = None
                    try:
                        length = len(val)
                    except Exception:
                        try:
                            length = val.length
                        except Exception:
                            length = None
                    if length is None:
                        try:
                            Array = find_class("java.lang.reflect.Array")
                            length = Array.getLength(val)
                            for i in range(int(length)):
                                try:
                                    item = Array.get(val, i)
                                except Exception:
                                    item = None
                                if item is None:
                                    continue
                                try:
                                    item.setTextColor(name_color if is_primary else sub_color)
                                    item.setShadowLayer(
                                        2.0 if (is_primary and use_shadow) else (1.5 if (not is_primary and use_shadow) else 0.0),
                                        0.0,
                                        1.0 if (is_primary and use_shadow) else (0.5 if (not is_primary and use_shadow) else 0.0),
                                        shadow_color
                                    )
                                except Exception:
                                    pass
                            return
                        except Exception:
                            return
                    for i in range(int(length)):
                        try:
                            item = val[i]
                        except Exception:
                            try:
                                Array = find_class("java.lang.reflect.Array")
                                item = Array.get(val, i)
                            except Exception:
                                item = None
                        if item is None:
                            continue
                        try:
                            item.setTextColor(name_color if is_primary else sub_color)
                            item.setShadowLayer(
                                2.0 if (is_primary and use_shadow) else (1.5 if (not is_primary and use_shadow) else 0.0),
                                0.0,
                                1.0 if (is_primary and use_shadow) else (0.5 if (not is_primary and use_shadow) else 0.0),
                                shadow_color
                            )
                        except Exception:
                            pass
                except Exception:
                    pass
            for host in (topview, outer):
                if host is None:
                    continue
                cls = host.getClass()
                for fname in ("nameTextView", "titleTextView", "nameView", "titleView"):
                    try:
                        f = cls.getDeclaredField(fname); f.setAccessible(True)
                        val = f.get(host)
                        if val is not None:
                            _apply_to_tv_or_array(val, is_primary=True)
                    except Exception:
                        pass
                for fname in ("onlineTextView", "statusTextView", "subtitleTextView", "subtitleView"):
                    try:
                        f = cls.getDeclaredField(fname); f.setAccessible(True)
                        val = f.get(host)
                        if val is not None:
                            _apply_to_tv_or_array(val, is_primary=False)
                    except Exception:
                        pass
        except Exception:
            pass
    def _ensure_server_cache_dir(self):
        try:
            base = self._plugin_dir or ApplicationLoader.applicationContext.getFilesDir().getAbsolutePath()
            d = os.path.join(base, "server_cache")
            os.makedirs(d, exist_ok=True)
            self._server_cache_dir = d
        except Exception:
            pass
    def _get_server_url(self) -> str:
        return "https://api.xd1.me"
    def _get_my_user_id(self) -> str:
        try:
            UserConfig = find_class("org.telegram.messenger.UserConfig")
            current_account = UserConfig.selectedAccount
            inst = UserConfig.getInstance(current_account)
            uid = inst.getClientUserId()
            return str(int(uid))
        except Exception:
            return ""
    def _http_get(self, url, timeout=15):
        try:
            import requests as _req
            r = _req.get(url, timeout=timeout, verify=True)
            return r.status_code, r.content
        except ImportError:
            pass
        conn = None
        stream = None
        try:
            from java.net import URL, HttpURLConnection
            conn = URL(url).openConnection()
            conn.setRequestMethod("GET")
            conn.setConnectTimeout(timeout * 1000)
            conn.setReadTimeout(timeout * 1000)
            code = conn.getResponseCode()
            stream = conn.getInputStream() if code < 400 else conn.getErrorStream()
            chunks = []
            buf = bytearray(8192)
            while True:
                n = stream.read(buf)
                if n == -1:
                    break
                chunks.append(bytes(buf[:n]))
            return code, b"".join(chunks)
        except Exception as e:
            self._log(f"HTTP GET failed: {e}")
            return 0, b""
        finally:
            try:
                if stream: stream.close()
            except Exception: pass
            try:
                if conn: conn.disconnect()
            except Exception: pass
    def _http_get_with_etag(self, url, etag=None, timeout=15):
        headers = {}
        if etag:
            headers["If-None-Match"] = etag
        resp_etag = ""
        try:
            import requests as _req
            r = _req.get(url, headers=headers, timeout=timeout, verify=True)
            resp_etag = r.headers.get("ETag", "")
            return r.status_code, r.content, resp_etag
        except ImportError:
            pass
        conn = None
        stream = None
        try:
            from java.net import URL, HttpURLConnection
            conn = URL(url).openConnection()
            conn.setRequestMethod("GET")
            if etag:
                conn.setRequestProperty("If-None-Match", etag)
            conn.setConnectTimeout(timeout * 1000)
            conn.setReadTimeout(timeout * 1000)
            code = conn.getResponseCode()
            resp_etag = conn.getHeaderField("ETag") or ""
            if code == 304:
                return 304, b"", resp_etag
            stream = conn.getInputStream() if code < 400 else conn.getErrorStream()
            chunks = []
            buf = bytearray(8192)
            while True:
                n = stream.read(buf)
                if n == -1:
                    break
                chunks.append(bytes(buf[:n]))
            return code, b"".join(chunks), resp_etag
        except Exception as e:
            self._log(f"HTTP GET (etag) failed: {e}")
            return 0, b"", ""
        finally:
            try:
                if stream: stream.close()
            except Exception: pass
            try:
                if conn: conn.disconnect()
            except Exception: pass
    def _http_get_json(self, url, timeout=15):
        code, body = self._http_get(url, timeout)
        if code == 200 and body:
            try:
                return _json.loads(body.decode("utf-8"))
            except Exception:
                pass
        return None
    def _http_delete(self, url, timeout=10):
        token = self._get_str(self.SETTINGS_SERVER_TOKEN, "").strip()
        headers = {"Authorization": f"Bearer {token}"} if token else {}
        try:
            import requests as _req
            r = _req.delete(url, headers=headers, timeout=timeout, verify=True)
            return r.status_code
        except ImportError:
            pass
        try:
            from java.net import URL, HttpURLConnection
            conn = URL(url).openConnection()
            conn.setRequestMethod("DELETE")
            if token:
                conn.setRequestProperty("Authorization", f"Bearer {token}")
            conn.setConnectTimeout(timeout * 1000)
            conn.setReadTimeout(timeout * 1000)
            code = conn.getResponseCode()
            conn.disconnect()
            return code
        except Exception:
            return 0
    def _http_post_multipart(self, url, fields, file_path, timeout=30):
        ext = os.path.splitext(file_path)[1].lower()
        if ext == ".gif":
            ct = "image/gif"
            fname = "banner.gif"
        elif ext == ".png":
            ct = "image/png"
            fname = "banner.png"
        elif ext == ".webp":
            ct = "image/webp"
            fname = "banner.webp"
        elif ext == ".mp4":
            ct = "video/mp4"
            fname = "banner.mp4"
        else:
            ct = "image/jpeg"
            fname = "banner.jpg"
        token = self._get_str(self.SETTINGS_SERVER_TOKEN, "").strip()
        headers = {"Authorization": f"Bearer {token}"} if token else {}
        try:
            import requests as _req
            with open(file_path, "rb") as f:
                resp = _req.post(
                    url,
                    headers=headers,
                    data=fields,
                    files={"file": (fname, f, ct)},
                    timeout=timeout,
                    verify=True,
                )
            return resp.status_code, resp.text
        except ImportError:
            pass
        try:
            from java.net import URL, HttpURLConnection
            boundary = "----BannerUpload" + str(int(time.time() * 1000))
            conn = URL(url).openConnection()
            conn.setRequestMethod("POST")
            if token:
                conn.setRequestProperty("Authorization", f"Bearer {token}")
            conn.setDoOutput(True)
            conn.setConnectTimeout(timeout * 1000)
            conn.setReadTimeout(timeout * 1000)
            conn.setRequestProperty("Content-Type", f"multipart/form-data; boundary={boundary}")
            out = conn.getOutputStream()
            for name, value in fields.items():
                part = f"--{boundary}\r\nContent-Disposition: form-data; name=\"{name}\"\r\n\r\n{value}\r\n"
                out.write(part.encode("utf-8"))
            file_header = (
                f"--{boundary}\r\n"
                f"Content-Disposition: form-data; name=\"file\"; filename=\"{fname}\"\r\n"
                f"Content-Type: {ct}\r\n\r\n"
            )
            out.write(file_header.encode("utf-8"))
            with open(file_path, "rb") as f:
                while True:
                    chunk = f.read(8192)
                    if not chunk:
                        break
                    out.write(chunk)
            out.write(f"\r\n--{boundary}--\r\n".encode("utf-8"))
            out.flush()
            out.close()
            code = conn.getResponseCode()
            stream = conn.getInputStream() if code < 400 else conn.getErrorStream()
            resp_body = ""
            if stream:
                chunks = []
                buf = bytearray(4096)
                while True:
                    n = stream.read(buf)
                    if n == -1:
                        break
                    chunks.append(bytes(buf[:n]))
                stream.close()
                resp_body = b"".join(chunks).decode("utf-8", errors="replace")
            conn.disconnect()
            return code, resp_body
        except Exception as e:
            self._log(f"Multipart upload Java fallback error: {e}")
            return 0, str(e)
    def _upload_current_banner_to_server(self, key):
        url = self._get_server_url()
        if not url:
            self._notify("–°–µ—Ä–≤–µ—Ä –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω ‚Äî —É–∫–∞–∂–∏—Ç–µ URL –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–ª–∞–≥–∏–Ω–∞.")
            return
        src = self._get_profile_source(key)
        if not src or src == "none":
            self._notify("–°–Ω–∞—á–∞–ª–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –±–∞–Ω–Ω–µ—Ä –ª–æ–∫–∞–ª—å–Ω–æ (URL, –≥–∞–ª–µ—Ä–µ—è –∏–ª–∏ –∞–≤–∞—Ç–∞—Ä).")
            return
        effect = self._get_profile_effect(key)
        text_mode = self._get_profile_text_mode(key)
        if src.startswith("avatar://"):
            try:
                bmp = self._ensure_bitmap_for_key(key)
                if bmp is not None:
                    self._server_upload_bitmap(bmp, effect, text_mode)
                    self._notify("–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–Ω–µ—Ä–∞ –∏–∑ –∞–≤–∞—Ç–∞—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...")
                else:
                    self._notify("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∞–Ω–Ω–µ—Ä –∏–∑ –∞–≤–∞—Ç–∞—Ä–∞.")
            except Exception as e:
                self._log(f"Upload avatar banner error: {e}")
                self._notify("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–≤–∞—Ç–∞—Ä-–±–∞–Ω–Ω–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.")
        elif os.path.isfile(src):
            self._server_upload_banner(src, effect, text_mode, force=True)
            self._notify("–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–Ω–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...")
        elif src.startswith("http://") or src.startswith("https://"):
            def _dl_and_upload():
                try:
                    code, data = self._http_get(src, timeout=20)
                    if code == 200 and data and len(data) > 100:
                        tmp = os.path.join(self._server_cache_dir or self._plugin_dir, "_server_tmp.jpg")
                        with open(tmp, "wb") as f:
                            f.write(data)
                        self._server_upload_banner(tmp, effect, text_mode, force=True)
                    else:
                        self._log("Failed to download URL for server upload", also_ui=True)
                except Exception as e:
                    self._log(f"URL download for server upload error: {e}")
            threading.Thread(target=_dl_and_upload, daemon=True).start()
            self._notify("–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–Ω–µ—Ä–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...")
        else:
            self._notify("–ù–µ —É–¥–∞—ë—Ç—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å: –∏—Å—Ç–æ—á–Ω–∏–∫ –±–∞–Ω–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.")
    def _server_upload_banner(self, file_path, effect="none", text_mode="", force=False):
        if not self._get_bool(self.SETTINGS_CONSENT_UPLOAD, False):
            msg = "‚ùó –í–∫–ª—é—á–∏—Ç–µ '–°–æ–≥–ª–∞—Å–∏–µ –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –¥–∞–Ω–Ω—ã—Ö' –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–ª–∞–≥–∏–Ω–∞!" if force else "‚ö†Ô∏è –î–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø—Ä–∏–º–∏—Ç–µ —Å–æ–≥–ª–∞—Å–∏–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–ª–∞–≥–∏–Ω–∞."
            self._log(msg, also_ui=True)
            return
        url = self._get_server_url()
        if not url:
            return
        if not force and not self._get_bool(self.SETTINGS_SERVER_AUTO_UPLOAD, True):
            return
        uid = self._get_my_user_id()
        if not uid:
            return
        def _upload():
            try:
                code, body = self._http_post_multipart(
                    f"{url}/api/banner/upload",
                    {"user_id": uid, "effect": str(effect), "text_mode": str(text_mode)},
                    file_path,
                )
                if code == 200:
                    self._log("–ë–∞–Ω–Ω–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è –≤—Å–µ—Ö!", also_ui=True)
                else:
                    err = ""
                    try:
                        import json
                        err = json.loads(body).get("detail", "")
                    except Exception:
                        pass
                    if not err:
                        if code == 413:
                            err = "–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π"
                        elif code == 429:
                            err = "–°–ª–∏—à–∫–æ–º —á–∞—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã"
                        elif code == 401:
                            err = "–ù–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏"
                        elif code == 507:
                            err = "–°–µ—Ä–≤–µ—Ä –ø–µ—Ä–µ–ø–æ–ª–Ω–µ–Ω"
                        else:
                            err = f"–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–±–æ–π (–ö–æ–¥: {code})"
                    self._log(f"‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: {err}", also_ui=True)
            except Exception as e:
                self._log(f"Server upload error: {e}")
        threading.Thread(target=_upload, daemon=True).start()
    def _server_upload_bitmap(self, bmp, effect="none", text_mode=""):
        try:
            tmp_path = os.path.join(self._server_cache_dir or self._plugin_dir, "_upload_tmp.jpg")
            out = FileOutputStream(tmp_path)
            bmp.compress(Bitmap.CompressFormat.JPEG, 85, out)
            out.close()
            self._server_upload_banner(tmp_path, effect, text_mode)
        except Exception as e:
            self._log(f"Server upload bitmap error: {e}")
    def _server_delete_banner(self):
        if not self._get_bool(self.SETTINGS_CONSENT_UPLOAD, False):
            return
        url = self._get_server_url()
        if not url:
            return
        uid = self._get_my_user_id()
        if not uid:
            return
        def _delete():
            try:
                code = self._http_delete(f"{url}/api/banner/{uid}")
                if code == 200:
                    self._log("Server banner deleted")
            except Exception:
                pass
        threading.Thread(target=_delete, daemon=True).start()
    def _invalidate_ui(self):
        try:
            frag = self._safe_get_fragment()
            if frag is None:
                frag = get_last_fragment()
            if frag is not None:
                view = None
                try:
                    view = frag.getFragmentView()
                except Exception:
                    pass
                if view is not None:
                    try:
                        view.invalidate()
                        from android.view import ViewGroup as JVG
                        if isinstance(view, JVG):
                            for i in range(view.getChildCount()):
                                try:
                                    view.getChildAt(i).invalidate()
                                except Exception:
                                    pass
                    except Exception:
                        pass
        except Exception:
            pass
    def _server_fetch_banner(self, user_id_str):
        url = self._get_server_url()
        if not url:
            return None
        if not self._get_bool(self.SETTINGS_SERVER_FETCH_OTHERS, True):
            return None
        with self._cache_lock:
            cached = self._server_cache.get(user_id_str)
        if cached:
            age = time.time() - cached.get("fetched_at", 0)
            if age < self.SERVER_CACHE_TTL:
                p = cached.get("path", "")
                if p and os.path.exists(p):
                    return cached
                return None
        if not hasattr(self, "_fetching_users"):
            self._fetching_users = set()
        if user_id_str in self._fetching_users:
            return None
        self._fetching_users.add(user_id_str)
        def _bg_fetch():
            try:
                stored_etag = ""
                with self._cache_lock:
                    stored_etag = self._etag_cache.get(user_id_str, "")
                has_cached_file = cached and cached.get("path") and os.path.exists(cached.get("path", ""))
                if has_cached_file and stored_etag:
                    code, file_data, new_etag = self._http_get_with_etag(
                        f"{url}/api/banner/{user_id_str}", etag=stored_etag, timeout=25
                    )
                    if code == 304:
                        cached["fetched_at"] = time.time()
                        with self._cache_lock:
                            self._server_cache[user_id_str] = cached
                        self._log(f"Banner for {user_id_str} unchanged (304)")
                        return
                    if new_etag:
                        with self._cache_lock:
                            self._etag_cache[user_id_str] = new_etag
                    if code == 200 and file_data and len(file_data) >= 100:
                        with open(cached["path"], "wb") as f:
                            f.write(file_data)
                        cached["fetched_at"] = time.time()
                        with self._cache_lock:
                            self._server_cache[user_id_str] = cached
                        self._log(f"Banner for {user_id_str} updated from server")
                        run_on_ui_thread(lambda: self._invalidate_ui())
                        return
                meta = self._http_get_json(f"{url}/api/banner/{user_id_str}/meta", timeout=10)
                if meta is None or not meta.get("exists", False):
                    with self._cache_lock:
                        self._server_cache[user_id_str] = {"path": "", "fetched_at": time.time()}
                    return
                fmt = meta.get("format", "jpeg")
                if fmt == "mp4" or meta.get("type") == "video":
                    ext = ".mp4"
                else:
                    ext = ".jpg"
                code, file_data, new_etag = self._http_get_with_etag(
                    f"{url}/api/banner/{user_id_str}", timeout=25
                )
                if new_etag:
                    with self._cache_lock:
                        self._etag_cache[user_id_str] = new_etag
                if code != 200 or not file_data or len(file_data) < 100:
                    with self._cache_lock:
                        self._server_cache[user_id_str] = {"path": "", "fetched_at": time.time()}
                    return
                cache_dir = self._server_cache_dir or self._plugin_dir
                cache_path = os.path.join(cache_dir, f"srv_{user_id_str}{ext}")
                with open(cache_path, "wb") as f:
                    f.write(file_data)
                entry = {
                    "path": cache_path,
                    "effect": meta.get("effect", "none"),
                    "text_mode": meta.get("text_mode", ""),
                    "type": meta.get("type", "image"),
                    "fetched_at": time.time(),
                }
                with self._cache_lock:
                    self._server_cache[user_id_str] = entry
                self._log(f"Fetched banner for {user_id_str} from server")
                run_on_ui_thread(lambda: self._invalidate_ui())
            except Exception as e:
                self._log(f"Server fetch error for {user_id_str}: {e}")
            finally:
                self._fetching_users.discard(user_id_str)
        threading.Thread(target=_bg_fetch, daemon=True).start()
        return None
    def _try_server_source_for_key(self, key):
        if not key.startswith("uid_"):
            return ""
        uid_str = key[4:]
        my_uid = self._get_my_user_id()
        if uid_str == my_uid:
            return ""  
        entry = self._server_fetch_banner(uid_str)
        if entry and entry.get("path"):
            return entry["path"]
        return ""
    def _get_server_effect_for_key(self, key):
        if not key.startswith("uid_"):
            return ""
        uid_str = key[4:]
        with self._cache_lock:
            cached = self._server_cache.get(uid_str)
        if cached:
            return cached.get("effect", "")
        return ""
    def _get_server_text_mode_for_key(self, key):
        if not key.startswith("uid_"):
            return ""
        uid_str = key[4:]
        with self._cache_lock:
            cached = self._server_cache.get(uid_str)
        if cached:
            return cached.get("text_mode", "")
        return ""
    def _ensure_defaults(self):
        try:
            if self.get_setting(self.SETTINGS_ENABLE, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_ENABLE, True)
            if self.get_setting(self.SETTINGS_SOURCE_GLOBAL, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_SOURCE_GLOBAL, "")
            if self.get_setting(self.SETTINGS_FADE, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_FADE, 90)
            if self.get_setting(self.SETTINGS_BLUR_INTENSITY, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_BLUR_INTENSITY, 60)
            if self.get_setting(self.SETTINGS_DARKEN_INTENSITY, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_DARKEN_INTENSITY, 70)
            if self.get_setting(self.SETTINGS_EFFECT_DEFAULT, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_EFFECT_DEFAULT, "blur")
            if self.get_setting(self.SETTINGS_DEBUG_ENABLE, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_DEBUG_ENABLE, False)
            if self.get_setting(self.SETTINGS_AVATAR_BANNER_ENABLE, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_AVATAR_BANNER_ENABLE, True)
            if self.get_setting(self.SETTINGS_AVATAR_BANNER_EFFECT, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_AVATAR_BANNER_EFFECT, "darken")
            if self.get_setting(self.SETTINGS_SERVER_AUTO_UPLOAD, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_SERVER_AUTO_UPLOAD, True)
            if self.get_setting(self.SETTINGS_SERVER_FETCH_OTHERS, _SENTINEL) is _SENTINEL:
                self.set_setting(self.SETTINGS_SERVER_FETCH_OTHERS, True)
            self._last_blur_percent = self._get_percent(self.SETTINGS_BLUR_INTENSITY, 60)
        except Exception:
            pass
    def _get_bool(self, key, default=False):
        try:
            v = self.get_setting(key, default)
            if v is default:
                return default
            if isinstance(v, bool):
                return v
            if isinstance(v, int):
                return v != 0
            if isinstance(v, str):
                return v.strip().lower() in ("1", "true", "yes", "on", "y")
            return bool(v)
        except Exception:
            return default
    def _set_bool(self, key, value: bool):
        try:
            self.set_setting(key, bool(value))
        except Exception:
            pass
    def _get_str(self, key, default=""):
        try:
            v = self.get_setting(key, default)
            return "" if v is None else str(v)
        except Exception:
            return default
    def _set_str(self, key, value: str):
        try:
            self.set_setting(key, value)
        except Exception:
            pass
    def _get_int(self, key, default=0):
        try:
            v = self.get_setting(key, default)
            if v is default:
                return default
            return int(v)
        except Exception:
            return default
    def _set_int(self, key, value: int):
        try:
            self.set_setting(key, int(value))
        except Exception:
            pass
    def _get_percent(self, key, default=50):
        try:
            v = self.get_setting(key, default)
            v = int(v)
        except Exception:
            v = default
        return max(1, min(100, int(v)))
    def _set_percent(self, key, value: int):
        self._set_int(key, max(1, min(100, int(value))))
        self._reload_plugin_settings()
    def _get_effect_str(self, key, default="none"):
        try:
            v = self.get_setting(key, default)
            s = ("" if v is None else str(v)).strip().lower()
            return s if s in ("none", "blur", "darken") else default
        except Exception:
            return default
    def _can_use_bulletin(self):
        try:
            if hasattr(self, "_bulletin_ok"):
                return bool(self._bulletin_ok)
        except Exception:
            pass
        ok = False
        try:
            B = find_class("org.telegram.ui.Components.Bulletin")
            try:
                inners = B.getDeclaredClasses()
                Array = find_class("java.lang.reflect.Array")
                ln = Array.getLength(inners)
                for i in range(int(ln)):
                    try:
                        cls = Array.get(inners, i)
                        name = cls.getName()
                        if name.endswith("$BottomSheet") or name.endswith("BottomSheet"):
                            ok = True; break
                    except Exception:
                        pass
            except Exception:
                ok = False
        except Exception:
            ok = False
        try:
            self._bulletin_ok = ok
        except Exception:
            pass
        return ok
    def _toast(self, text):
        from android_utils import run_on_ui_thread
        def _do():
            try:
                Toast = find_class("android.widget.Toast")
                ctx = ApplicationLoader.applicationContext
                dur = getattr(Toast, "LENGTH_SHORT", 0)
                t = Toast.makeText(ctx, str(text), int(dur))
                t.show()
            except Exception:
                pass
        run_on_ui_thread(_do)
    def _notify(self, text):
        from android_utils import run_on_ui_thread
        def _do():
            try:
                if self._can_use_bulletin():
                    BulletinHelper.show(text)
                    return
            except Exception:
                pass
            try:
                Toast = find_class("android.widget.Toast")
                ctx = ApplicationLoader.applicationContext
                dur = getattr(Toast, "LENGTH_SHORT", 0)
                t = Toast.makeText(ctx, str(text), int(dur))
                t.show()
            except Exception:
                pass
        run_on_ui_thread(_do)
    def _alert(self, title, message):
        from android_utils import run_on_ui_thread
        def _do():
            try:
                if self._can_use_bulletin():
                    BulletinHelper.show(f"{title}: {message}")
                    return
            except Exception:
                pass
            try:
                Toast = find_class("android.widget.Toast")
                ctx = ApplicationLoader.applicationContext
                dur = getattr(Toast, "LENGTH_SHORT", 0)
                t = Toast.makeText(ctx, str(f"{title}: {message}"), int(dur))
                t.show()
            except Exception:
                pass
        run_on_ui_thread(_do)
    def _reload_plugin_settings(self):
        try:
            PC = find_class("com.exteragram.messenger.plugins.PluginsController")
            inst = PC.getInstance()
            try:
                inst.loadPluginSettings(self.id)
            except Exception:
                inst.loadPluginSettings()
        except Exception:
            pass
    def _renderscript_blur(self, bmp, radius=12.0, passes=1):
        try:
            RS = find_class("android.renderscript.RenderScript")
            Allocation = find_class("android.renderscript.Allocation")
            ScriptIntrinsicBlur = find_class("android.renderscript.ScriptIntrinsicBlur")
            Element = find_class("android.renderscript.Element")
        except Exception:
            return None
        try:
            ctx = ApplicationLoader.applicationContext
            rs = RS.create(ctx)
        except Exception:
            return None
        try:
            in_bmp = bmp
            out_bmp = None
            r = float(radius)
            if r < 0.1:
                r = 0.1
            if r > 25.0:
                r = 25.0
            pcount = max(1, int(passes))
            for _ in range(pcount):
                try:
                    inp = Allocation.createFromBitmap(rs, in_bmp)
                    out = Allocation.createTyped(rs, inp.getType())
                    script = ScriptIntrinsicBlur.create(rs, Element.U8_4(rs))
                    script.setRadius(r)
                    script.setInput(inp)
                    script.forEach(out)
                    tmp = Bitmap.createBitmap(in_bmp.getWidth(), in_bmp.getHeight(), Bitmap.Config.ARGB_8888)
                    out.copyTo(tmp)
                    try:
                        script.destroy(); inp.destroy(); out.destroy()
                    except Exception:
                        pass
                    in_bmp = tmp
                    out_bmp = tmp
                except Exception:
                    out_bmp = None
                    break
            try:
                rs.destroy()
            except Exception:
                pass
            return out_bmp
        except Exception:
            try:
                rs.destroy()
            except Exception:
                pass
            return None
    def _add_numeric_input(self, rows, key, label, default_value, subtext, on_change):
        try:
            rows.append(Input(key=key, text=label, default=str(default_value), subtext=subtext, on_change=on_change))
            return
        except Exception:
            pass
        try:
            rows.append(Input(key=key, title=label, hint=subtext or "", default=str(default_value), on_change=on_change))
            return
        except Exception:
            pass
        try:
            rows.append(Input(key=key, text=label, default=str(default_value)))
            return
        except Exception:
            pass
    def _on_blur_intensity_changed(self, value):
        try:
            v = int(str(value).strip())
            v = max(1, min(100, v))
            self.set_setting(self.SETTINGS_BLUR_INTENSITY, v)
        except (ValueError, TypeError):
            pass
    def _on_darken_intensity_changed(self, value):
        try:
            v = int(str(value).strip())
            v = max(1, min(100, v))
            self.set_setting(self.SETTINGS_DARKEN_INTENSITY, v)
        except (ValueError, TypeError):
            pass
    def _on_avatar_banner_enable_changed(self, new_value):
        try:
            self.set_setting(self.SETTINGS_AVATAR_BANNER_ENABLE, bool(new_value))
            self._reload_plugin_settings()
        except Exception:
            pass
    def _on_debug_changed(self, new_value):
        try:
            self._debug_enabled = bool(new_value)
            self.set_setting(self.SETTINGS_DEBUG_ENABLE, bool(new_value))
            self._reload_plugin_settings()
            if self._debug_enabled:
                self._log("Debug mode enabled", also_ui=True)
            else:
                BulletinHelper.show("Debug mode disabled")
        except Exception:
            pass
    def _show_debug_logs(self):
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            if not activity:
                BulletinHelper.show("–ù–µ—Ç –∞–∫—Ç–∏–≤–∏—Ç–∏ –¥–ª—è –ø–æ–∫–∞–∑–∞ –ª–æ–≥–æ–≤")
                return
            self._dump_logs_dialog(activity)
        except Exception:
            pass
class _ThemeGetColorIntHook(MethodHook):
    def __init__(self, plugin: ProfileHeaderImagePlugin):
        self.p = plugin
    def before_hooked_method(self, param):
        try:
            mode, fragment = self.p._current_profile_textmode()
            if not mode:
                return
            clsname = fragment.getClass().getName() if fragment else ""
            if not (clsname.endswith(".ProfileActivity") or clsname.endswith("ProfileActivity")):
                return
            key_int = int(param.args[0])
            name_color, sub_color = self.p._resolve_text_colors(mode)
            k = self.p._theme_keys
            if key_int == k.get("key_profile_title"):
                param.setResult(name_color)
            elif key_int == k.get("key_avatar_subtitleInProfileBue") or key_int == k.get("key_avatar_subtitleInProfileBlue"):
                param.setResult(sub_color)
        except Exception:
            return
class _ThemeGetColorStrHook(MethodHook):
    def __init__(self, plugin: ProfileHeaderImagePlugin):
        self.p = plugin
    def before_hooked_method(self, param):
        try:
            mode, fragment = self.p._current_profile_textmode()
            if not mode:
                return
            clsname = fragment.getClass().getName() if fragment else ""
            if not (clsname.endswith(".ProfileActivity") or clsname.endswith("ProfileActivity")):
                return
            key_str = str(param.args[0] or "").strip()
            if not key_str:
                return
            name_color, sub_color = self.p._resolve_text_colors(mode)
            if key_str == "profile_title":
                param.setResult(name_color)
            elif key_str in ("avatar_subtitleInProfileBue", "avatar_subtitleInProfileBlue"):
                param.setResult(sub_color)
        except Exception:
            return
class _TopViewOnDrawHook(MethodHook):
    def __init__(self, plugin: ProfileHeaderImagePlugin):
        self.p = plugin
    def before_hooked_method(self, param):
        try:
            if not self.p._get_bool(self.p.SETTINGS_ENABLE, False):
                return
            topview = param.thisObject
            if topview is None:
                return
            outer = None
            try:
                f = topview.getClass().getDeclaredField("this$0")
                f.setAccessible(True)
                outer = f.get(topview)
            except Exception:
                outer = None
            if outer is None:
                return
            key = self.p._get_profile_key_from_fragment(outer)
            mode = self.p._get_profile_text_mode(key)
            if mode:
                self.p._apply_text_colors(topview, outer, mode)
        except Exception as e:
            self.p._log(f"before onDraw error: {e}")
    def after_hooked_method(self, param):
        try:
            if not self.p._get_bool(self.p.SETTINGS_ENABLE, False):
                return
            topview = param.thisObject
            canvas = param.args[0]
            if canvas is None or topview is None:
                return
            outer = None
            try:
                f = topview.getClass().getDeclaredField("this$0")
                f.setAccessible(True)
                outer = f.get(topview)
            except Exception:
                outer = None
            key = "unknown"
            try:
                if outer is not None:
                    key = self.p._get_profile_key_from_fragment(outer)
            except Exception:
                pass
            bmp = self.p._ensure_bitmap_for_key(key)
            is_video = self.p._is_video_source(key)
            video_path = self.p._src_map.get(key, "") if is_video else ""
            if bmp is None and not is_video:
                return
            try:
                effect = self.p._get_profile_effect(key)
            except Exception:
                effect = self.p._get_effect_str(self.p.SETTINGS_EFFECT_DEFAULT, "blur")
            if effect not in ("blur", "darken", "none"):
                effect = "blur"
            y1 = None
            progress = 0.0
            try:
                actionBar = outer.getActionBar() if outer is not None else None
                status = AndroidUtilities.statusBarHeight
                try:
                    ab_h = JActionBar.getCurrentActionBarHeight()
                except Exception:
                    ab_h = AndroidUtilities.dp(56)
                height = ab_h + (status if (actionBar is not None and actionBar.getOccupyStatusBar()) else 0)
                extraHeight = 0.0
                searchTransitionOffset = 0.0
                mediaHeaderAnimationProgress = 0.0
                for fname in ("extraHeight", "searchTransitionOffset", "mediaHeaderAnimationProgress"):
                    try:
                        ff = outer.getClass().getDeclaredField(fname)
                        ff.setAccessible(True)
                        val = ff.get(outer)
                        if fname == "extraHeight":
                            extraHeight = float(val)
                        elif fname == "searchTransitionOffset":
                            searchTransitionOffset = float(val)
                        else:
                            mediaHeaderAnimationProgress = float(val)
                    except Exception:
                        pass
                progress = max(0.0, min(1.0, float(mediaHeaderAnimationProgress)))
                v_total = float(extraHeight + height + searchTransitionOffset)
                y1 = int(v_total * (1.0 - progress))
            except Exception:
                pass
            if y1 is None or y1 <= 0:
                y1 = AndroidUtilities.dp(240)
            try:
                tvh = topview.getMeasuredHeight()
                if tvh > 0:
                    y1 = min(int(y1), int(tvh))
            except Exception:
                pass
            w = topview.getMeasuredWidth()
            if w <= 0 or y1 <= 0:
                return
            if effect == "blur":
                bmp_draw = self.p._get_blurred_bitmap_for_key(key, bmp)
            else:
                bmp_draw = bmp
            bw = bmp_draw.getWidth()
            bh = bmp_draw.getHeight()
            if bw <= 0 or bh <= 0:
                return
            visible_factor = 1.0 - progress
            if visible_factor <= 0.02:
                return
            scale = max(w / float(bw), y1 / float(bh)) * 1.02
            sw = bw * scale
            sh = bh * scale
            dx = (w - sw) * 0.5
            dy = (y1 - sh) * 0.5
            matrix = Matrix()
            matrix.reset()
            matrix.postScale(float(scale), float(scale))
            matrix.postTranslate(float(dx), float(dy))
            save_id = canvas.save()
            try:
                try:
                    canvas.clipRect(0, 0, int(w), int(y1))
                except Exception:
                    canvas.clipRect(int(0), int(0), int(w), int(y1))
                if self.p._paint_bmp is None:
                    self.p._paint_bmp = Paint()
                    self.p._paint_bmp.setFilterBitmap(True)
                    self.p._paint_bmp.setDither(True)
                
                # Draw the static image preview ONLY if the video isn't ready/playing yet
                draw_img = True
                if is_video and self.p._video_player is not None:
                    try:
                        if self.p._video_player.isPlaying():
                            draw_img = False
                    except Exception:
                        pass
                
                if draw_img:
                    self.p._paint_bmp.setAlpha(255)
                    canvas.drawBitmap(bmp_draw, matrix, self.p._paint_bmp)
                if effect == "darken":
                    try:
                        darken_percent = self.p._get_percent(self.p.SETTINGS_DARKEN_INTENSITY, 70)
                        overlay_alpha = int(255 * (darken_percent / 100.0))
                        if overlay_alpha > 0:
                            if self.p._paint_darken is None:
                                self.p._paint_darken = Paint()
                                self.p._paint_darken.setStyle(Paint.Style.FILL)
                                self.p._paint_darken.setDither(True)
                                self.p._paint_darken.setAntiAlias(True)
                            self.p._paint_darken.setARGB(overlay_alpha, 0, 0, 0)
                            canvas.drawRect(0, 0, w, y1, self.p._paint_darken)
                    except Exception as e:
                        self.p._log(f"darken overlay error: {e}")
                fade_alpha = self.p._get_int(self.p.SETTINGS_FADE, 90)
                fade_alpha = int(max(0, min(255, int(fade_alpha * (1.0 - progress)))))
                if fade_alpha > 0:
                    grad_h = int(max(1, y1 * 0.35))
                    if self.p._paint_fade is None:
                        self.p._paint_fade = Paint()
                    fade_key = (y1, grad_h, fade_alpha)
                    if getattr(self.p, "_last_fade_key", None) != fade_key:
                        self.p._last_fade_key = fade_key
                        shader = LinearGradient(
                            0, y1 - grad_h, 0, y1,
                            Color.argb(0, 0, 0, 0),
                            Color.argb(fade_alpha, 0, 0, 0),
                            Shader.TileMode.CLAMP
                        )
                        self.p._paint_fade.setShader(shader)
                    canvas.drawRect(0, y1 - grad_h, w, y1, self.p._paint_fade)
                # Loading overlay: show on top of avatar/banner while server fetch is in progress
                if self.p._is_fetching_server_banner(key):
                    try:
                        from android.graphics import Typeface
                        tp = Paint()
                        tp.setColor(Color.WHITE)
                        tp.setTextSize(float(AndroidUtilities.dp(13)))
                        tp.setAntiAlias(True)
                        try:
                            tp.setTypeface(Typeface.DEFAULT_BOLD)
                        except Exception:
                            pass
                        text = "‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–Ω–µ—Ä–∞..."
                        tw = tp.measureText(text)
                        tx = (w - tw) / 2.0
                        ty = y1 / 2.0
                        # Shadow behind text for readability
                        tp.setShadowLayer(4.0, 0.0, 1.0, Color.argb(180, 0, 0, 0))
                        canvas.drawText(text, float(tx), float(ty), tp)
                    except Exception:
                        pass
                if is_video and video_path:
                    _tv = topview
                    _vp = video_path
                    _w = int(w)
                    _h = int(y1)
                    
                    if getattr(self.p, "_active_video_args", None) != (_tv, _vp, _w, _h):
                        self.p._active_video_args = (_tv, _vp, _w, _h)
                        run_on_ui_thread(lambda: self.p._setup_video_overlay(_tv, _vp, _w, _h))
                elif not is_video:
                    if self.p._video_player is not None:
                        if getattr(self.p, "_active_video_args", None) is not None:
                            self.p._active_video_args = None
                        run_on_ui_thread(lambda: self.p._release_video())
            finally:
                try:
                    canvas.restoreToCount(save_id)
                except Exception:
                    try:
                        canvas.restore()
                    except Exception:
                        pass
        except Exception as e:
            self.p._log(f"after onDraw error: {e}")
Plugin = ProfileHeaderImagePlugin
