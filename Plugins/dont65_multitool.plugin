# –ü–ª–∞–≥–∏–Ω: MultiTool (All-in-One)
# –ê–≤—Ç–æ—Ä: @dont65
# –í–µ—Ä—Å–∏—è 1.10.0
# –¢—Ä–µ–±—É–µ—Ç: Dont65 Library (dont65_lib)

from base_plugin import BasePlugin, HookResult, HookStrategy
from client_utils import log
from ui.settings import Header, Divider, Text, Switch
from android_utils import run_on_ui_thread
from client_utils import get_messages_controller, get_last_fragment
import traceback
import re
import urllib.parse
import math
import datetime

__name__ = "MultiTool Plugin"
__description__ = "üß∞ MultiTool ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (—Ç—Ä–µ–±—É–µ—Ç Dont65 Library)\n\n–ö–æ–º–∞–Ω–¥—ã:\n‚Ä¢ .id ‚Äî –ò–Ω—Ñ–æ –æ —Å–æ–æ–±—â–µ–Ω–∏–∏\n‚Ä¢ .layout ‚Äî –ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å–∫–ª–∞–¥–∫—É\n‚Ä¢ .symbols ‚Äî –ü–æ–¥—Å—á–µ—Ç —Å–∏–º–≤–æ–ª–æ–≤\n‚Ä¢ .upper / .lower / .swap ‚Äî –†–µ–≥–∏—Å—Ç—Ä\n‚Ä¢ .sort ‚Äî –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ —Å–ª–æ–≤\n‚Ä¢ .find ‚Äî –ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞\n‚Ä¢ .tglink ‚Äî –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Å—ã–ª–æ–∫\n‚Ä¢ .calc ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä\n‚Ä¢ .time ‚Äî –í—Ä–µ–º—è\n‚Ä¢ .rev ‚Äî –†–µ–≤–µ—Ä—Å —Ç–µ–∫—Å—Ç–∞\n‚Ä¢ .translit ‚Äî –¢—Ä–∞–Ω—Å–ª–∏—Ç"
__icon__ = "ItCBa/1"
__version__ = "1.10.0"
__id__ = "dont65_multitool"
__author__ = "@dont65"
__min_version__ = "11.12.0"

# –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
AUTOUPDATE_CHANNEL_ID = 3624287619  # @dontplugin
AUTOUPDATE_MSG_ID = 12              # ID –ø–æ—Å—Ç–∞ —Å —ç—Ç–∏–º –ø–ª–∞–≥–∏–Ω–æ–º

class MultiToolPlugin(BasePlugin):

    def __init__(self):
        super().__init__()
        self.lib_missing = False
        self.Dont65Utils = None
        self.logger = None
        self._check_library()

    def _check_library(self):
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"""
        try:
            from dont65_lib import Dont65Utils as LibUtils
            self.Dont65Utils = LibUtils
            self.lib_missing = False
            # –õ–æ–≥–≥–µ—Ä —Å–æ–∑–¥–∞–¥–∏–º –ø–æ–∑–∂–µ, –∫–æ–≥–¥–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –±—É–¥–µ—Ç —Ç–æ—á–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞
        except ImportError:
            self.lib_missing = True
            log(f"[{__id__}] –û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ dont65_lib –Ω–µ –Ω–∞–π–¥–µ–Ω–∞")

    def _show_library_check_dialog(self, context):
        """–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏"""
        try:
            from dont65_lib import Dont65Utils as LibUtils
            self.Dont65Utils = LibUtils
            self.lib_missing = False
            context.show_alert(
                "‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–∞–π–¥–µ–Ω–∞",
                f"Dont65 Library v{self.Dont65Utils.__version__ if hasattr(self.Dont65Utils, '__version__') else '1.0.6'}\n\n–í—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–æ—Å—Ç—É–ø–Ω—ã."
            )
        except ImportError:
            self.lib_missing = True
            self.Dont65Utils = None
            context.show_alert(
                "‚ùå –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞",
                "–ü–ª–∞–≥–∏–Ω dont65_lib –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω!\n\n–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Dont65 Library –¥–ª—è —Ä–∞–±–æ—Ç—ã MultiTool."
            )

    # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (UI) ---
    def create_settings(self):
        settings = [
            Header("MultiTool Plugin"),
            Text(f"–í–µ—Ä—Å–∏—è: {__version__}"),
            Divider()
        ]

        if self.lib_missing:
            settings.extend([
                Text("‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è Dont65 Library!"),
                Divider(text="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω dont65_lib –¥–ª—è —Ä–∞–±–æ—Ç—ã"),
                Divider(),
                Divider(text="–ü–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏\n–ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç")
            ])
        else:
            settings.extend([
                Header("–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏"),
                Divider(text="–û—Ç–∫–ª—é—á–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤–∞–º –Ω–µ –Ω—É–∂–Ω—ã."),
                Divider(),
                Switch(key="enable_id", text="–ò–Ω—Ñ–æ ID (.id)", default=True),
                Switch(key="enable_layout", text="–°–º–µ–Ω–∞ —Ä–∞—Å–∫–ª–∞–¥–∫–∏ (.layout)", default=True),
                Switch(key="enable_calc", text="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä (.calc)", default=True),
                Switch(key="enable_symbols", text="–°—á–µ—Ç—á–∏–∫ —Å–∏–º–≤–æ–ª–æ–≤ (.symbols)", default=True),
                Switch(key="enable_links", text="–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Å—ã–ª–æ–∫ (.tglink)", default=True),
                Switch(key="enable_time", text="–í—Ä–µ–º—è –∏ –î–∞—Ç–∞ (.time, .date)", default=True),
                Switch(key="enable_text_utils", text="–¢–µ–∫—Å—Ç (.rev, .translit)", default=True),
                Switch(key="enable_case", text="–†–µ–≥–∏—Å—Ç—Ä (.upper, .lower, .swap)", default=True),
                Switch(key="enable_sort", text="–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (.sort)", default=True),
                Switch(key="enable_find", text="–ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞ (.find)", default=True),
                Divider()
            ])

        # –ö–Ω–æ–ø–∫–∞ –Ω–∞ –∞–≤—Ç–æ—Ä–∞ –≤–Ω–∏–∑—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–≤—Å–µ–≥–¥–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è)
        settings.append(
            Text(
                text="–ê–≤—Ç–æ—Ä: @dont65",
                accent=False,
                on_click=lambda view: run_on_ui_thread(
                    lambda: get_messages_controller().openByUserName(
                        "dont65", get_last_fragment(), 1
                    )
                )
            )
        )
        settings.append(Divider())

        return settings

    # --- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã ---
    def _get_target_text(self, params, cmd_length):
        msg_text = params.message or params.caption or ""
        if len(msg_text) > cmd_length:
            args = msg_text[cmd_length:].strip()
            if args:
                return args

        reply_message_object = getattr(params, 'replyToMsg', None)
        if reply_message_object:
            extracted = self.Dont65Utils.extract_text_aggressively(reply_message_object)
            if extracted:
                return extracted
        return None

    # --- –õ–æ–≥–∏–∫–∞ —Ñ—É–Ω–∫—Ü–∏–π ---
    def calculate_expression(self, expression):
        try:
            safe_expr = re.sub(r'[^0-9+\-*/().,^% \w]', '', expression)
            safe_expr = safe_expr.replace('^', '**')
            allowed_names = {"__builtins__": None, "math": math}
            result = eval(safe_expr, allowed_names, {})
            header = "üî¢ *–†–µ–∑—É–ª—å—Ç–∞—Ç:*"
            body = f"`{expression} = {result}`"
            return header, body
        except Exception:
            return None, "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ."

    def generate_tg_links(self, command_args):
        parts = command_args.split(maxsplit=1)
        if not parts:
            return "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.tglink [username] [—Ç–µ–∫—Å—Ç]`"

        username = parts[0].replace('@', '')
        text_param = parts[1] if len(parts) > 1 else ""

        res = [
            f"üîó *–°—Å—ã–ª–∫–∏ –¥–ª—è* {username}:",
            f"‚Ä¢ @{username}",
            f"‚Ä¢ t.me/{username}",
            f"‚Ä¢ {username}.t.me"
        ]

        if text_param:
            encoded_text = urllib.parse.quote(text_param)
            link_with_text = f"https://t.me/{username}?text={encoded_text}"
            res.append(f"‚Ä¢ *–°—Å—ã–ª–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º:*\n{link_with_text}")
        return "\n".join(res)

    def get_time_info(self, arg):
        utcnow = datetime.datetime.utcnow()
        if arg:
            try:
                offset = int(arg.replace('+', ''))
                target_time = utcnow + datetime.timedelta(hours=offset)
                sign = "+" if offset >= 0 else ""

                header = f"üïí *–í—Ä–µ–º—è (UTC{sign}{offset}):*"
                body = f"`{target_time.strftime('%H:%M:%S')}`"
                return (header, body, 'block')
            except ValueError:
                return (None, "‚ö†Ô∏è *–û—à–∏–±–∫–∞.* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç: `.time` –∏–ª–∏ `.time +3`", None)

        header = "üïí *–ú–∏—Ä–æ–≤–æ–µ –≤—Ä–µ–º—è (UTC):*"
        res = []
        for i in range(-11, 13):
            t = utcnow + datetime.timedelta(hours=i)
            sign = "+" if i >= 0 else ""
            res.append(f"UTC{sign}{i}: {t.strftime('%H:%M')}")

        body = "\n".join(res)
        return (header, body, 'collapsed')

    # --- –•—É–∫–∏ ---
    def on_plugin_load(self):
        if not self.lib_missing:
            try:
                # –°–æ–∑–¥–∞—ë–º –ª–æ–≥–≥–µ—Ä —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É
                self.logger = self.Dont65Utils.build_log(__id__)
                self.logger.info("Plugin loaded, library detected")

                # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                self.Dont65Utils.add_autoupdater_task(
                    __id__,
                    AUTOUPDATE_CHANNEL_ID,
                    AUTOUPDATE_MSG_ID
                )
                self.logger.info("Auto-updater task registered (msg_id=12)")

                # –•—É–∫ —Å–æ–æ–±—â–µ–Ω–∏–π
                self.add_on_send_message_hook(priority=200)

            except Exception as e:
                log(f"[{__id__}] Error during library init: {traceback.format_exc()}")
                self.lib_missing = True
        else:
            log(f"[{__id__}] –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Ö—É–∫ –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")

    def on_send_message_hook(self, account, params):
        try:
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
            if self.lib_missing:
                msg_text = params.message or params.caption or ""
                if msg_text.strip().startswith('.'):
                    params.message = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –¢—Ä–µ–±—É–µ—Ç—Å—è Dont65 Library!\n–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω `dont65_lib` –¥–ª—è —Ä–∞–±–æ—Ç—ã MultiTool."
                    return HookResult(strategy=HookStrategy.MODIFY, params=params)
                return HookResult()

            msg_text = ""
            if hasattr(params, 'message') and params.message:
                msg_text = params.message
            elif hasattr(params, 'caption') and params.caption:
                msg_text = params.caption

            if not msg_text:
                return HookResult()

            low_text = msg_text.strip().lower()

            # Result vars
            final_text = None
            source_preview = None
            res_quote_style = None
            header_outside = None

            # --- .id ---
            if low_text == ".id":
                if self.get_setting("enable_id", True):
                    reply = getattr(params, 'replyToMsg', None)
                    if not reply:
                        final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –°–¥–µ–ª–∞–π—Ç–µ —Ä–µ–ø–ª–∞–π –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."
                    else:
                        info = self.Dont65Utils.get_message_info(reply, params)
                        final_text = (
                            f"‚ÑπÔ∏è *Message Info:*\n\n"
                            f"üë§ *Author ID:* `{info['sender_id']}`\n"
                            f"üì¢ *Chat ID:* `{info['chat_id']}`\n"
                            f"üí¨ *Msg ID:* `{info['msg_id']}`\n\n"
                            f"üîó [Link to Message]({info['link']})"
                        )
                    res_quote_style = None

            # --- .layout ---
            elif low_text.startswith(".layout"):
                if self.get_setting("enable_layout", True):
                    target = self._get_target_text(params, 7)
                    if target:
                        source_preview = target
                        res = self.Dont65Utils.switch_layout(target)
                        final_text = f"‚å®Ô∏è *–†–∞—Å–∫–ª–∞–¥–∫–∞:*\n`{res}`"
                        res_quote_style = None
                    else:
                        final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."

            # --- .symbols ---
            elif low_text.startswith(".symbols"):
                if self.get_setting("enable_symbols", True):
                    target = self._get_target_text(params, 8)
                    if target:
                        source_preview = target
                        total, no_nl, no_sp = self.Dont65Utils.quality_symbols(target)
                        final_text = (
                            f"üìä *–ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—Å—Ç–∞:*\n"
                            f"‚Ä¢ –í—Å–µ–≥–æ —Å–∏–º–≤–æ–ª–æ–≤: `{total}`\n"
                            f"‚Ä¢ –ë–µ–∑ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤: `{no_nl}`\n"
                            f"‚Ä¢ –ë–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤: `{no_sp}`"
                        )
                        res_quote_style = None
                    else:
                        final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."

            # --- .tglink ---
            elif low_text.startswith(".tglink"):
                if self.get_setting("enable_links", True):
                    args = msg_text[7:].strip()
                    source_preview = args
                    final_text = self.generate_tg_links(args)
                    res_quote_style = None

            # --- .calc ---
            elif low_text.startswith(".calc"):
                if self.get_setting("enable_calc", True):
                    expression = msg_text[5:].strip()
                    if expression:
                        header_outside, final_text = self.calculate_expression(expression)
                        res_quote_style = 'block'

            # --- .time ---
            elif low_text.startswith(".time"):
                if self.get_setting("enable_time", True):
                    header_outside, final_text, res_quote_style = self.get_time_info(msg_text[5:].strip())

            # --- .date ---
            elif low_text == ".date":
                if self.get_setting("enable_time", True):
                    now = datetime.datetime.now()
                    header_outside = "üìÖ *–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è:*"
                    final_text = f"`{now.strftime('%d.%m.%Y %H:%M:%S')}`"
                    res_quote_style = 'block'

            # --- .swap ---
            elif low_text.startswith(".swap"):
                if self.get_setting("enable_case", True):
                    target = self._get_target_text(params, 5)
                    if target:
                        source_preview = target
                        final_text = f"üî† *Swap Case:*\n`{target.swapcase()}`"
                        res_quote_style = None
                    else:
                        final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."

            # --- .sort ---
            elif low_text.startswith(".sort"):
                if self.get_setting("enable_sort", True):
                    target = self._get_target_text(params, 5)
                    if target:
                        source_preview = target
                        words = target.split()
                        words.sort(key=lambda x: (not x.isdigit(), x.lower()))
                        sorted_text = " ".join(words)
                        final_text = f"üî¢ *–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:*\n`{sorted_text}`"
                        res_quote_style = None
                    else:
                        final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."

            # --- .find ---
            elif low_text.startswith(".find"):
                if self.get_setting("enable_find", True):
                    parts = msg_text.split(maxsplit=1)
                    if len(parts) > 1:
                        word_to_find = parts[1].strip()
                        reply_message_object = getattr(params, 'replyToMsg', None)
                        if reply_message_object:
                            target = self.Dont65Utils.extract_text_aggressively(reply_message_object)
                            if target:
                                source_preview = target
                                count = len(re.findall(re.escape(word_to_find), target, re.IGNORECASE))
                                final_text = f"üîç –ü–æ–∏—Å–∫ —Å–ª–æ–≤–∞ `{word_to_find}`:\n–ù–∞–π–¥–µ–Ω–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π: `{count}`"
                                res_quote_style = None
                            else:
                                final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –°–æ–æ–±—â–µ–Ω–∏–µ –ø—É—Å—Ç–æ–µ."
                        else:
                            final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `.find [—Å–ª–æ–≤–æ]` –≤ –æ—Ç–≤–µ—Ç –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."
                    else:
                        final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –í–≤–µ–¥–∏—Ç–µ —Å–ª–æ–≤–æ –¥–ª—è –ø–æ–∏—Å–∫–∞."

            # --- .rev / .translit / .upper / .lower ---
            elif low_text.startswith((".rev", ".translit", ".upper", ".lower")):
                cmd = low_text.split()[0]
                target = self._get_target_text(params, len(cmd))
                if target:
                    source_preview = target
                    if cmd == ".rev":
                        final_text = f"üîÑ *–†–µ–≤–µ—Ä—Å:*\n`{target[::-1]}`"
                    elif cmd == ".translit":
                        result = self.Dont65Utils.do_translit(target)
                        final_text = f"üî§ *–¢—Ä–∞–Ω—Å–ª–∏—Ç:*\n`{result}`"
                    elif cmd == ".upper":
                        final_text = f"‚¨ÜÔ∏è *Upper:*\n`{target.upper()}`"
                    elif cmd == ".lower":
                        final_text = f"‚¨áÔ∏è *Lower:*\n`{target.lower()}`"
                    res_quote_style = None
                else:
                    final_text = "‚ö†Ô∏è *–û—à–∏–±–∫–∞:* –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ –æ—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ."

            if final_text:
                new_params = self.Dont65Utils.reply_with_style(
                    params,
                    body=final_text,
                    header=header_outside,
                    source=source_preview,
                    quote=res_quote_style
                )
                return HookResult(strategy=HookStrategy.MODIFY_FINAL, params=new_params)

            return HookResult()

        except Exception as e:
            if self.logger:
                self.logger.error(f"Error in hook: {self.Dont65Utils.format_exc_only(e)}")
            else:
                log(f"[{__id__}] –û—à–∏–±–∫–∞:\n{traceback.format_exc()}")
            return HookResult()

    def on_plugin_unload(self):
        if not self.lib_missing and self.Dont65Utils:
            try:
                self.Dont65Utils.remove_autoupdater_task(__id__)
                if self.logger:
                    self.logger.info("Auto-updater task removed")
            except Exception as e:
                if self.logger:
                    self.logger.error(f"Failed to remove autoupdater task: {e}")
        # –õ–æ–≥–≥–µ—Ä —É–Ω–∏—á—Ç–æ–∂–∏—Ç—Å—è —Å–∞–º
        pass