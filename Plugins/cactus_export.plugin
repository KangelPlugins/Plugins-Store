import os
import time
import json
import zlib
import base64
import zipfile
import shutil
import re
import ast 
import threading
import traceback
import sys

from base_plugin import BasePlugin, MethodHook, HookResult, HookStrategy, MenuItemData, MenuItemType
from client_utils import send_document, run_on_queue, get_last_fragment
from file_utils import get_plugins_dir
from android_utils import log, run_on_ui_thread
from ui.bulletin import BulletinHelper
from ui.settings import Header, Input, Text, Divider, Switch
from com.exteragram.messenger.plugins import PluginsController
from hook_utils import find_class
from org.telegram.messenger import ApplicationLoader, NotificationCenter

from java import dynamic_proxy, jarray, jbyte
from java.net import URL
from java.nio import ByteBuffer
from java.util import ArrayList, HashMap, Locale
from dalvik.system import InMemoryDexClassLoader

try:
    import plugin_settings as engine_settings
except ImportError:
    engine_settings = None

__id__ = "cactus_export"
__name__ = "Cactus Export"
__description__ = "Ð¡Ð´ÐµÐ»Ð°Ð» (Ð¿Ð¾Ñ‡Ñ‚Ð¸) Ñ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ ÐºÐ»Ð¾Ð½ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°/Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð¾Ñ‚ cactuslib Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð½Ð° Ð½Ð¾Ð²Ñ‹Ðµ Ð²ÐµÑ€ÑÐ¸Ð¸ exteraGram. Ð’ÑÐµÑ… Ñƒ ÐºÐ¾Ð³Ð¾ Ñ Ñ‡Ð¾-Ñ‚Ð¾ Ð¿Ð¸Ð·Ð´Ð¸Ð» Ð¾Ñ‚Ð¼ÐµÑ‚Ð¸Ð» Ð² Ð°Ð²Ñ‚Ð¾Ñ€Ð°Ñ… âœ…. ÐŸÐžÐ¡Ð›Ð• Ð£Ð¡Ð¢ÐÐÐžÐ’ÐšÐ˜ ÐžÐ‘Ð•Ð—ÐÐ¢Ð•Ð›Ð¬ÐÐž ÐŸÐ•Ð Ð•Ð—ÐÐŸÐ£Ð¡Ð¢Ð˜Ð¢Ð• EXTERAGRAMâ˜ï¸â˜ï¸â˜ï¸"
__author__ = "@chillden4ik, @oodze. Credits: @Playerqwe, @ArThirtyFour"
__version__ = "1.0"
__icon__ = "CactuslibSuka/0"
__min_version__ = "11.12.1"

DEX_URL = "https://github.com/Den4ikSuperOstryyPer4ik/CactusPlugins/raw/refs/heads/main/CactusLib/classes.dex"

DefaultItemAnimator = find_class("androidx.recyclerview.widget.DefaultItemAnimator")
CubicBezierInterpolator = find_class("org.telegram.ui.Components.CubicBezierInterpolator")
Utilities = find_class("org.telegram.messenger.Utilities")
AndroidUtilities = find_class("org.telegram.messenger.AndroidUtilities")
FileClass = find_class("java.io.File")
Activity = find_class("android.app.Activity")

class Callback5(dynamic_proxy(Utilities.Callback5)):
    def __init__(self, fun):
        super().__init__()
        self.fun = fun
    def run(self, t1, t2, t3, t4, t5):
        self.fun(t1, t2, t3, t4, t5)

class OpenFileHook(MethodHook):
    def __init__(self, plugin):
        self.plugin = plugin
        
    def before_hooked_method(self, param):
        try:
            file_obj = param.args[0]
            if not file_obj: return
            path = file_obj.getAbsolutePath()
            
            if path.endswith(".cactusexport"):
                param.setResult(True) 
                self.plugin.open_import_ui(path)
        except: pass

class PluginDumper(BasePlugin):
    STRINGS = {
        "en": {
            "import_alert_title": "Import Plugins",
            "import_info": "The file contains plugins with saved data.",
            "import_warning": "Note: You may lose the current plugins settings and data.",
            "import_progress": "Processed {}",
            "import_done": "Successfully imported {}!",
            "import": "Import",

            "export_alert_title": "Export Plugins",
            "export2": "Export",
            "export_progress": "Loaded {}",
            "export_info": "The file contains plugins with fully-saved data.",
            "export_warning": "The settings may contain confidential data.",
            "export_done": "export :D",
            
            "cancel": "Cancel",
            "plugins": "Plugins",
            "include_data_and_settings": "Include data and settings",
            "export_error": "Export failed: {}",
            "import_error": "Import failed: {}",
            "restart_needed": "Please restart exteraGram!"
        },
        "ru": {
            "import_alert_title": "Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "import_info": "Ð’ Ñ„Ð°Ð¹Ð»Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ Ñ Ð¿Ð¾Ð»Ð½Ð¾ÑÑ‚ÑŒÑŽ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸.",
            "import_warning": "Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¿Ð¾Ñ‚ÐµÑ€ÑÑ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð².",
            "import_progress": "Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ {}",
            "import_done": "Ð£ÑÐ¿ÐµÑˆÐ½Ð¾ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ {}!",
            "import": "Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚",

            "export_alert_title": "Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "export2": "Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚",
            "export_progress": "Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ {}",
            "export_info": "Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ñ‚ Ñ„Ð°Ð¹Ð» Ñ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¼Ð¸ Ð²ÐµÑ€ÑÐ¸ÑÐ¼Ð¸ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸.",
            "export_warning": "Ð’ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ð¼Ð¾Ð³ÑƒÑ‚ ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒÑÑ ÐºÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ.",
            "export_done": "export :D",
            
            "cancel": "ÐžÑ‚Ð¼ÐµÐ½Ð°",
            "plugins": "ÐŸÐ»Ð°Ð³Ð¸Ð½Ñ‹",
            "include_data_and_settings": "Ð’ÐºÐ»ÑŽÑ‡Ð°Ñ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸",
            "export_error": "ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°: {}",
            "import_error": "ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚Ð°: {}",
            "restart_needed": "Ð¢Ñ€ÐµÐ±ÑƒÐµÑ‚ÑÑ Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ!"
        }
    }

    def __init__(self):
        super().__init__()
        self.dex_class = None
        self.plugin_metadata = {}
        self.metadata_loading = False
        self.file_hook = None

    def on_plugin_load(self):
        self.add_on_send_message_hook()
        self.add_menu_item(
            MenuItemData(
                menu_type=MenuItemType.CHAT_ACTION_MENU,
                item_id="dumper_open_menu",
                icon="msg_filled_data_sent",
                text="ðŸ“¤ Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ ÐŸÐ»Ð°Ð³Ð¸Ð½Ð¾Ð²",
                on_click=lambda _: self._manual_dump(None)
            )
        )
        
        try:
            method = AndroidUtilities.getClass().getDeclaredMethod(
                "openForView", 
                [FileClass, find_class("java.lang.String"), find_class("java.lang.String"), Activity, ThemeResourcesProvider, getattr(find_class("boolean"), "TYPE", bool)]
            )
            self.file_hook = self.hook_method(method, OpenFileHook(self))
        except:
            try:
                for m in AndroidUtilities.getClass().getDeclaredMethods():
                    if m.getName() == "openForView":
                        self.file_hook = self.hook_method(m, OpenFileHook(self))
                        break
            except: pass

        if not engine_settings:
            log("[CactusExport] Warning: plugin_settings module not found. Settings backup might fail.")

        import threading
        threading.Thread(target=self._ensure_dex_and_metadata_loaded).start()

    def on_plugin_unload(self):
        self.remove_menu_item("dumper_open_menu")
        if self.file_hook:
             self.unhook_method(self.file_hook)

    def create_settings(self):
        return [
            Header("Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ"),
            Input(key="trigger_command", text="ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð¼ÐµÐ½ÑŽ", default=".sexport"),
        ]

    def on_send_message_hook(self, account, params) -> HookResult:
        if not isinstance(params.message, str): return HookResult()
        msg = params.message.strip()
        
        if msg == self.get_setting("trigger_command", ".sexport"):
            if self.metadata_loading:
                run_on_ui_thread(lambda: BulletinHelper.show_info("Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²..."))
                return HookResult(strategy=HookStrategy.CANCEL)
            
            run_on_queue(lambda: self._prepare_dump(params.peer))
            return HookResult(strategy=HookStrategy.CANCEL)
            
        return HookResult()
    
    def _load_dex(self):
        if self.dex_class: return True
        try:
            url = URL(DEX_URL)
            stream = url.openStream()
            bytes_out = find_class("java.io.ByteArrayOutputStream")()
            buffer = jarray(jbyte)(4096)
            while True:
                read = stream.read(buffer)
                if read == -1: break
                bytes_out.write(buffer, 0, read)
            
            dex_bytes = bytes_out.toByteArray()
            stream.close()
            
            loader = InMemoryDexClassLoader(
                ByteBuffer.wrap(dex_bytes),
                ApplicationLoader.applicationContext.getClassLoader()
            )
            self.dex_class = loader.loadClass("org.den4iksop.cactuslib.ImportExportBottomSheet")
            return True
        except Exception as e:
            log(f"[CactusExport] DEX Load Error: {e}")
            return False

    def _ensure_dex_and_metadata_loaded(self):
        if self.dex_class is None:
            self._load_dex()
        if self.dex_class:
            self._load_all_metadata_in_background()

    def _load_all_metadata_in_background(self):
        if self.metadata_loading: return
        self.metadata_loading = True
        
        plugins_dir = get_plugins_dir()
        files_to_check = [f for f in os.listdir(plugins_dir) if f.endswith(('.py', '.plugin'))]
        
        new_metadata = {}
        for fname in files_to_check:
            fpath = os.path.join(plugins_dir, fname)
            new_metadata[fname] = self._read_plugin_metadata(fpath)
            
        self.plugin_metadata = new_metadata
        self.metadata_loading = False

    def _read_plugin_metadata(self, filepath):
        metadata = {}
        try:
            with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                content = f.read(1024 * 5)
            try:
                tree = ast.parse(content)
                for node in ast.walk(tree):
                    if isinstance(node, ast.Assign):
                        for target in node.targets:
                            if isinstance(target, ast.Name) and target.id in ['__id__', '__name__', '__version__']:
                                if isinstance(node.value, (ast.Constant, ast.Str)):
                                    metadata[target.id] = node.value.value if isinstance(node.value, ast.Constant) else node.value.s
            except: pass
            
            if not metadata:
                patterns = {
                    '__id__': r'^__id__\s*=\s*[\'"]([^\'"]+)[\'"]',
                    '__name__': r'^__name__\s*=\s*[\'"]([^\'"]+)[\'"]',
                    '__version__': r'^__version__\s*=\s*[\'"]([^\'"]+)[\'"]'
                }
                for key, pattern in patterns.items():
                    if m := re.search(pattern, content, re.MULTILINE):
                        metadata[key] = m.group(1)
            return metadata
        except Exception as e:
            return metadata

    def _manual_dump(self, v):
        frag = get_last_fragment()
        if frag:
            try: 
                pid = frag.getDialogId()
                if pid: run_on_queue(lambda: self._prepare_dump(pid))
            except: pass

    def _prepare_dump(self, peer_id):
        if not self.dex_class:
            run_on_ui_thread(lambda: BulletinHelper.show_error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ DEX!"))
            return

        plugins_dir = get_plugins_dir()
        if not os.path.exists(plugins_dir): return
        
        all_files = sorted([f for f in os.listdir(plugins_dir) if f.endswith(('.py', '.plugin'))])
        
        all_files = [f for f in all_files if not f.startswith(".temp")]
        
        run_on_ui_thread(lambda: self._show_cactus_ui(peer_id, all_files, True))

    def open_import_ui(self, filepath):
        try:
            with open(filepath, "rb") as f: content = f.read()
            data = json.loads(self.decode_and_decompress(content))
            
            plugins_map = {}
            if "file_content" in data:
                meta = data.get("plugin_meta", {})
                pid = meta.get("id", "unknown")
                plugins_map[pid] = data
            else:
                plugins_map = data

            run_on_ui_thread(lambda: self._show_cactus_ui(None, plugins_map, False, plugins_map))
        except Exception as e: 
            err = str(e)
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ñ„Ð°Ð¹Ð»Ð°: {err}"))

    def _get_java_strings_map(self):
        lang = Locale.getDefault().getLanguage()
        if lang not in self.STRINGS: lang = "en"
        string_dict = self.STRINGS[lang]
        java_map = HashMap()
        for k, v in string_dict.items(): java_map.put(k, v)
        return java_map

    def _get_string_by_key(self, key):
        lang = Locale.getDefault().getLanguage()
        if lang not in self.STRINGS: lang = "en"
        return self.STRINGS[lang].get(key, key)

    def _show_cactus_ui(self, peer_id, files_data, is_export_mode, parsed_import_data=None):
        frag = get_last_fragment()
        if not frag: return
        if not self.dex_class: return

        j_strings = self._get_java_strings_map()
        j_plugins = ArrayList()
        j_names = HashMap()
        j_versions = HashMap()
        j_icons = HashMap()
        
        if is_export_mode:
            for f in files_data:
                j_plugins.add(f)
                meta = self.plugin_metadata.get(f, {})
                plugin_id_key = meta.get('__id__', os.path.splitext(f)[0]) 
                j_names.put(f, meta.get('__name__', plugin_id_key))
                j_versions.put(f, meta.get('__version__', "1.0"))
        else:
            for pid, pdata in files_data.items():
                if not pdata: continue
                j_plugins.add(pid)
                meta = pdata.get("plugin_meta", {})
                j_names.put(pid, meta.get("name", pid))
                j_versions.put(pid, meta.get("version", "1.0"))

        animator = DefaultItemAnimator()
        animator.setSupportsChangeAnimations(False)
        animator.setDelayAnimations(False)
        animator.setInterpolator(CubicBezierInterpolator.EASE_OUT_QUINT)
        animator.setDurations(350)

        try:
            ctor = self.dex_class.getConstructors()[0]
            sheet = ctor.newInstance(
                frag, is_export_mode, j_strings, j_plugins, animator, j_names, j_versions, j_icons
            )
            
            def on_done_python(sheet_view, selected_list, on_err, on_succ, with_data):
                sel_files = list(selected_list.toArray())
                if not sel_files: return
                
                include_data = bool(with_data)
                
                if is_export_mode:
                    run_on_queue(lambda: self._process_export_cactus(peer_id, sel_files, include_data))
                else:
                    run_on_queue(lambda: self._process_import_selected(parsed_import_data, sel_files, include_data))
                
                run_on_ui_thread(lambda: sheet_view.dismiss())

            sheet.setOnDone(Callback5(on_done_python))
            sheet.show()
            
        except Exception as e:
            err_str = str(e)
            if "proxy" in err_str or "ImportExportBottomSheet" in err_str:
                 run_on_ui_thread(lambda: BulletinHelper.show_error(self._get_string_by_key("restart_needed")))
            else:
                 log(f"[CactusExport] UI Error: {e}")
                 BulletinHelper.show_error(f"UI Error: {e}")

    def _get_settings_native(self, pid):
        if not engine_settings: return {}
        try:
            return engine_settings.get_all_settings(pid) or {}
        except: return {}

    def _set_setting_native(self, pid, key, value):
        if not engine_settings: return
        try:
            engine_settings.set_setting(pid, key, value)
        except: pass

    def _clear_settings_native(self, pid):
        if not engine_settings: return
        try:
            if hasattr(engine_settings, "clear_settings"):
                engine_settings.clear_settings(pid)
        except: pass

    def _process_export_cactus(self, peer_id, files, include_settings):
        plugins_dir = get_plugins_dir()
        msg = self._get_string_by_key("export_progress").format(len(files))
        run_on_ui_thread(lambda: BulletinHelper.show_info(msg))
        
        master_data = {}
        for fname in files:
            fpath = os.path.join(plugins_dir, fname)
            try:
                meta = self.plugin_metadata.get(fname, self._read_plugin_metadata(fpath))
                dump = self._dump_single_plugin(fpath, include_settings, meta)
                if dump:
                    master_data[os.path.splitext(fname)[0]] = dump
            except Exception as e:
                pass
        
        if not master_data:
            run_on_ui_thread(lambda: BulletinHelper.show_error("ÐžÑˆÐ¸Ð±ÐºÐ°: ÐŸÑƒÑÑ‚Ð¾Ð¹ Ð´Ð°Ð¼Ð¿"))
            return
        
        try:
            json_str = json.dumps(master_data)
            final_blob = base64.b64encode(zlib.compress(json_str.encode('utf-8'), level=9)).decode('utf-8')
            export_name = "plugins-export.cactusexport"
            export_path = os.path.join(plugins_dir, export_name)
            with open(export_path, "wb") as f:
                f.write(final_blob.encode('utf-8'))
            send_document(peer_id, export_path, caption=self._get_string_by_key("export_done"))
            time.sleep(1)
            os.remove(export_path)
        except Exception as e:
            err = str(e)
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"Export Error: {err}"))
            log(f"[CactusExport] Export Error: {e}")

    def _force_reload_plugins(self):
        try:
            controller = PluginsController.getInstance()
            if controller and hasattr(controller, 'engines'):
                engine = controller.engines.get("python")
                if engine:
                    engine.loadPlugins(None)
            
            run_on_ui_thread(lambda: NotificationCenter.getGlobalInstance().postNotificationName(NotificationCenter.pluginsUpdated))
        except Exception as e:
            log(f"[CactusExport] Reload Error: {e}")

    def _process_import_selected(self, all_data, selected_ids, with_settings):
        count = 0
        plugins_dir = get_plugins_dir()
        
        try:
            files_dir = ApplicationLoader.getFilesDirFixed().getAbsolutePath()
            datastores_dir = os.path.join(files_dir, "datastores")
            if not os.path.exists(datastores_dir):
                os.makedirs(datastores_dir)
        except:
            datastores_dir = None

        try:
            for pid in selected_ids:
                if pid in all_data:
                    pdata = all_data[pid]
                    if not pdata: continue

                    try:
                        enc_content = pdata.get("file_content")
                        if enc_content:
                            code = self.decode_and_decompress(enc_content)
                            
                            target_path = os.path.join(plugins_dir, f"{pid}.py")
                            with open(target_path, "wb") as f:
                                f.write(code)
                            
                            if with_settings and engine_settings:
                                self._clear_settings_native(pid)
                                
                                settings = pdata.get("settings", {})
                                for k, v in settings.items():
                                    self._set_setting_native(pid, k, v)
                                
                                if datastores_dir and "data" in pdata and pdata["data"]:
                                    try:
                                        db_path = os.path.join(datastores_dir, f"{pid}_db.json")
                                        with open(db_path, "w", encoding="utf-8") as f:
                                            json.dump(pdata["data"], f, ensure_ascii=False)
                                    except: pass
                            
                            count += 1
                    except Exception as e: 
                        log(f"[CactusExport] Import Error {pid}: {e}")

            if count > 0:
                self._force_reload_plugins()

            msg = self._get_string_by_key("import_done").format(count)
            run_on_ui_thread(lambda: BulletinHelper.show_success(msg))
            
        except Exception as e:
            err = str(e)
            log(f"[CactusExport] Import Fatal Error: {e}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"Import Error: {err}"))

    def _dump_single_plugin(self, filepath, include_settings, meta):
        try:
            with open(filepath, "rb") as f: raw_content = f.read()
            file_content_enc = base64.b64encode(zlib.compress(raw_content, level=9)).decode('utf-8')
            plugin_id = meta.get('__id__', os.path.splitext(os.path.basename(filepath))[0])
            
            settings = None
            data_content = None
            
            if include_settings:
                settings = self._get_settings_native(plugin_id)
                try:
                    files_dir = ApplicationLoader.getFilesDirFixed().getAbsolutePath()
                    db_path = os.path.join(files_dir, "datastores", f"{plugin_id}_db.json")
                    if os.path.exists(db_path):
                        with open(db_path, "r", encoding="utf-8") as f:
                            data_content = json.load(f)
                except: pass

            return {
                "file_content": file_content_enc,
                "settings": settings,
                "data": data_content,
                "plugin_meta": {
                    "id": plugin_id,
                    "name": meta.get('__name__', plugin_id),
                    "version": meta.get('__version__', '1.0'),
                    "enabled": True
                }
            }
        except: return None
    
    def compress_and_encode(self, data):
        if not data: return ""
        if isinstance(data, str): data = data.encode('utf-8')
        return base64.b64encode(zlib.compress(data, level=9)).decode('utf-8')

    def decode_and_decompress(self, data):
        if not data: return b""
        return zlib.decompress(base64.b64decode(data))

    def _get_settings_reflection(self, pid):
        return {}
