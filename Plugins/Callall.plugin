from base_plugin import BasePlugin, HookResult, HookStrategy
from typing import Any

__id__ = "call_all"
__name__ = "Call All"
__description__ = "–£–ø–æ–º–∏–Ω–∞–µ—Ç –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–∞—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π .call –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç –¥–æ–±–∞–≤–ª—è—Ç—å —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è"
__author__ = "pkow"
__version__ = "pre-release"
__icon__ = "megaphone"
__min_version__ = "11.12.0"


class CallAllPlugin(BasePlugin):
    def on_plugin_load(self):
        self.add_on_send_message_hook()

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        try:
            if not hasattr(params, 'message') or not isinstance(params.message, str):
                return HookResult()

            message_text = params.message.strip()

            if not message_text.startswith(".call"):
                return HookResult()

            # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è
            parts = message_text.split(maxsplit=1)
            if len(parts) == 1:
                # –ø—Ä–æ—Å—Ç–æ ".call" ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                return HookResult()

            announcement = parts[1].strip()

            from client_utils import get_messages_controller

            if not hasattr(params, 'peer'):
                params.message = "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —á–∞—Ç"
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

            dialog_id = params.peer
            controller = get_messages_controller()

            if dialog_id > 0:
                params.message = "‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö"
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

            chat_id = -dialog_id
            chat_full = controller.getChatFull(chat_id)

            if not chat_full or not hasattr(chat_full, 'participants') or not chat_full.participants:
                params.message = "‚ùå –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

            participants = chat_full.participants.participants
            participants_count = participants.size()

            mentions = []

            for i in range(participants_count):
                participant = participants.get(i)
                user = controller.getUser(participant.user_id)
                if user and not user.bot and not user.deleted:
                    username = getattr(user, "username", None)
                    if username:
                        mentions.append(f"@{username}")

            if not mentions:
                params.message = "‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å username"
                return HookResult(strategy=HookStrategy.MODIFY, params=params)

            # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º
            mention_lines = [" ".join(mentions[i:i+5]) for i in range(0, len(mentions), 5)]
            params.message = f"üì¢ {announcement}\n" + "\n".join(mention_lines)

            return HookResult(strategy=HookStrategy.MODIFY, params=params)

        except Exception:
            params.message = "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã"
            return HookResult(strategy=HookStrategy.MODIFY, params=params)

    def on_plugin_unload(self):
        pass


# Plugin fixes assisted by ai