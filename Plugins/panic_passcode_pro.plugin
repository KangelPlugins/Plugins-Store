from base_plugin import BasePlugin, MethodHook
from ui.bulletin import BulletinHelper
from ui.settings import Header, Switch, Text, Divider
from ui.alert import AlertDialogBuilder
from client_utils import get_last_fragment
from java import jclass
from java.lang import String as jString
from java.io import File
from android.os import SystemClock, Process, Environment
from android.content import Context
import threading
import time
import re
import sys

__id__ = "panic_passcode_pro"
__name__ = "Panic Passcode Pro"
__version__ = "1.0.57"
__description__ = "âœ… Universal panic passcode for all Telegram forks"
__icon__ = "msg_lock"
__min_version__ = "12.2.3"
__author__ = "@chestertech"
__dependencies__ = []
__settings__ = True

STRINGS = {
    'en': {
        'plugin_loaded': 'âœ… Panic Passcode Pro loaded',
        'enable_passcode_first': 'Enable passcode in Telegram!',
        'set_panic_first': 'Set panic code!',
        'panic_code_removed': 'âœ… Panic code removed',
        'panic_code_set_enabled': 'âœ… Panic code set and enabled',
        'hash_error': 'Hashing error',
        'codes_dont_match': "Codes don't match!",
        'only_4_digits': 'Must be 4 digits!',
        'cant_match_main': "Can't match passcode!",
        'panic_full_title': 'âš ï¸ Panic Passcode Pro',
        'panic_full_desc': 'ðŸ—‘ï¸ FULL data wipe on panic',
        'sharedconfig_error': 'ðŸ”’ SharedConfig unavailable',
        'passcode_and_panic_on': 'ðŸ” Passcode and Panic enabled',
        'passcode_on_panic_off': 'ðŸ” Passcode enabled, Panic disabled',
        'passcode_off': 'ðŸ” Passcode not enabled',
        'panic_management': 'âš™ï¸ Panic Code Management',
        'enable_in_settings': 'Settings â†’ Privacy â†’ Passcode',
        'enable_panic_switch': 'Enable Panic Code',
        'change_panic_code': 'âœï¸ Change Panic Code',
        'remove_panic_code': 'ðŸ—‘ï¸ Remove Panic Code',
        'set_panic_code': 'ðŸ”‘ Set Panic Code',
        'remove_confirm_title': 'Remove Panic Code?',
        'remove_confirm_msg': 'Switch will be turned off',
        'remove_button': 'Remove',
        'cancel_button': 'Cancel',
        'set_panic_title': 'Set Panic Code',
        'enter_4_digits': 'Enter 4 digits',
        'repeat_4_digits': 'Repeat 4 digits',
        'set_button': 'Set',
        'wipe_error': 'âŒ Data wipe error',
    },
    'ru': {
        'plugin_loaded': 'âœ… Panic Passcode Pro Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½',
        'enable_passcode_first': 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚Ðµ ÐºÐ¾Ð´-Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð² Telegram!',
        'set_panic_first': 'Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ panic ÐºÐ¾Ð´!',
        'panic_code_removed': 'âœ… Panic ÐºÐ¾Ð´ ÑƒÐ´Ð°Ð»Ñ‘Ð½',
        'panic_code_set_enabled': 'âœ… Panic ÐºÐ¾Ð´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½',
        'hash_error': 'ÐžÑˆÐ¸Ð±ÐºÐ° Ñ…ÐµÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ',
        'codes_dont_match': 'ÐšÐ¾Ð´Ñ‹ Ð½Ðµ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°ÑŽÑ‚!',
        'only_4_digits': 'ÐÑƒÐ¶Ð½Ð¾ 4 Ñ†Ð¸Ñ„Ñ€Ñ‹!',
        'cant_match_main': 'ÐÐµ Ð¼Ð¾Ð¶ÐµÑ‚ ÑÐ¾Ð²Ð¿Ð°Ð´Ð°Ñ‚ÑŒ Ñ ÐºÐ¾Ð´-Ð¿Ð°Ñ€Ð¾Ð»ÐµÐ¼!',
        'panic_full_title': 'âš ï¸ Panic Passcode Pro',
        'panic_full_desc': 'ðŸ—‘ï¸ ÐŸÐžÐ›ÐÐÐ¯ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ñ…',
        'sharedconfig_error': 'ðŸ”’ SharedConfig Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½',
        'passcode_and_panic_on': 'ðŸ” ÐšÐ¾Ð´-Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¸ Panic Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹',
        'passcode_on_panic_off': 'ðŸ” ÐšÐ¾Ð´-Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð²ÐºÐ»ÑŽÑ‡Ñ‘Ð½, Panic Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½',
        'passcode_off': 'ðŸ” ÐšÐ¾Ð´-Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð½Ðµ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½',
        'panic_management': 'âš™ï¸ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Panic Code',
        'enable_in_settings': 'ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ â†’ ÐšÐ¾Ð½Ñ„Ð¸Ð´ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ â†’ ÐšÐ¾Ð´-Ð¿Ð°Ñ€Ð¾Ð»ÑŒ',
        'enable_panic_switch': 'Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Panic Code',
        'change_panic_code': 'âœï¸ Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Panic ÐšÐ¾Ð´',
        'remove_panic_code': 'ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Panic ÐšÐ¾Ð´',
        'set_panic_code': 'ðŸ”‘ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Panic ÐšÐ¾Ð´',
        'remove_confirm_title': 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Panic ÐšÐ¾Ð´?',
        'remove_confirm_msg': 'ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»ÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹ÐºÐ»ÑŽÑ‡ÐµÐ½.',
        'remove_button': 'Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ',
        'cancel_button': 'ÐžÑ‚Ð¼ÐµÐ½Ð°',
        'set_panic_title': 'Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Panic ÐšÐ¾Ð´',
        'enter_4_digits': 'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ 4 Ñ†Ð¸Ñ„Ñ€Ñ‹',
        'repeat_4_digits': 'ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚Ðµ 4 Ñ†Ð¸Ñ„Ñ€Ñ‹',
        'set_button': 'Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ',
        'wipe_error': 'âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ…',
    }
}

try:
    LocaleController = jclass("org.telegram.messenger.LocaleController")
except Exception:
    LocaleController = None


def _init_jclasses():
    cls_map = {
        "UserConfig": "org.telegram.messenger.UserConfig",
        "MessagesController": "org.telegram.messenger.MessagesController",
        "ConnectionsManager": "org.telegram.tgnet.ConnectionsManager",
        "Utilities": "org.telegram.messenger.Utilities",
        "ApplicationLoader": "org.telegram.messenger.ApplicationLoader",
        "SharedConfig": "org.telegram.messenger.SharedConfig",
        "NotificationCenter": "org.telegram.messenger.NotificationCenter",
        "AccountInstance": "org.telegram.messenger.AccountInstance",
        "MessagesStorage": "org.telegram.messenger.MessagesStorage",
    }
    for name, path in cls_map.items():
        try:
            cls = jclass(path)
            globals()[name] = cls
        except Exception:
            pass


def compute_simple_hash(password):
    Utilities = globals().get("Utilities")
    if not Utilities or not password:
        return None
    try:
        s = jString(password)
        b = s.getBytes("UTF-8")
        h = Utilities.computeSHA256(b, 0, len(b))
        return Utilities.bytesToHex(h)
    except Exception:
        return None


class SharedConfigCheckHook(MethodHook):
    def __init__(self, plugin):
        self.plugin = plugin

    def before_hooked_method(self, param):
        try:
            entered = str(param.args[0]) if param.args and param.args[0] else None
            if not entered:
                return
            p = self.plugin
            panic_hash = p.get_setting("panic_hash", "")
            panic_enabled = p.get_setting("panic_enabled", False)
            if not (panic_enabled and panic_hash):
                return
            h = compute_simple_hash(entered)
            if not h:
                return
            if h == panic_hash:
                param.setResult(False)
                p._sync_logout_and_restart()
        except Exception:
            pass


def _get_sharedconfig_attr(attr, default=None):
    sc = globals().get("SharedConfig")
    return getattr(sc, attr, default) if sc else default


def get_passcode_state():
    h = _get_sharedconfig_attr("passcodeHash", "")
    h_str = str(h) if h else ""
    return bool(h_str.strip()), h_str


def get_panic_state(plugin):
    panic_hash = plugin.get_setting("panic_hash", "")
    panic_enabled = plugin.get_setting("panic_enabled", False)
    return panic_hash, panic_enabled


class PanicPasscodePlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self.hook_installed_shared = False
        self.unhook_objects = []
        self.initialized = False
        self.main_page_cache = {
            "passcode_state": (False, ""),
            "panic_state": ("", False),
            "timestamp": 0
        }
        self.cache_ttl = 1

    def _(self, key):
        lang = 'en'
        if LocaleController:
            try:
                lc = LocaleController.getInstance()
                if lc and hasattr(lc, 'getCurrentLocale'):
                    locale = lc.getCurrentLocale()
                    if locale and hasattr(locale, 'getLanguage'):
                        lang_code = locale.getLanguage()
                        if lang_code == 'ru':
                            lang = 'ru'
            except Exception:
                pass
        return STRINGS.get(lang, STRINGS['en']).get(key, key)

    def _get_cached_main_page_data(self):
        current_time = time.time()
        if current_time - self.main_page_cache["timestamp"] > self.cache_ttl:
            self.main_page_cache["passcode_state"] = get_passcode_state()
            self.main_page_cache["panic_state"] = get_panic_state(self)
            self.main_page_cache["timestamp"] = current_time
        return self.main_page_cache["passcode_state"], self.main_page_cache["panic_state"]

    def _invalidate_main_page_cache(self):
        self.main_page_cache["timestamp"] = 0

    def on_plugin_load(self):
        if self.initialized:
            return
        try:
            _init_jclasses()
            self.setup_sharedconfig_hook()
            self.initialized = True
            BulletinHelper.show_success(self._('plugin_loaded'), get_last_fragment())
        except Exception:
            pass

    def setup_sharedconfig_hook(self):
        try:
            SharedConfig = globals().get("SharedConfig")
            if not SharedConfig:
                return
            hook = SharedConfigCheckHook(self)
            method = SharedConfig.getClass().getDeclaredMethod("checkPasscode", jclass("java.lang.String"))
            method.setAccessible(True)
            unhook = self.hook_method(method, hook)
            if unhook:
                self.unhook_objects.append(unhook)
                self.hook_installed_shared = True
        except Exception:
            pass

    def on_switch_changed(self, enabled):
        panic_hash = self.get_setting("panic_hash", "")
        if enabled:
            if not panic_hash:
                BulletinHelper.show_error(self._('set_panic_first'), get_last_fragment())
                self.set_setting("panic_enabled", False, reload_settings=True)
                return False
        self.set_setting("panic_enabled", enabled, reload_settings=True)
        self._invalidate_main_page_cache()
        self.notify_settings_changed()
        return True

    def create_settings(self):
        passcode_enabled, passcode_hash_str = self._get_cached_main_page_data()[0]
        panic_hash, panic_enabled = self._get_cached_main_page_data()[1]
        s = []
        try:
            s.append(Header(self._('panic_full_title')))
            s.append(Text(self._('panic_full_desc'), icon="msg_info"))
            s.append(Divider())

            SharedConfig = globals().get("SharedConfig")
            if not SharedConfig:
                status_text = self._('sharedconfig_error')
                icon_name = "msg_warning"
            else:
                if passcode_enabled and passcode_hash_str:
                    if panic_enabled and panic_hash:
                        status_text = self._('passcode_and_panic_on')
                        icon_name = "msg_lock"
                    else:
                        status_text = self._('passcode_on_panic_off')
                        icon_name = "msg_lock"
                else:
                    status_text = self._('passcode_off')
                    icon_name = "msg_lock"
            s.append(Text(status_text, icon=icon_name))
            s.append(Divider())
            s.append(Text(self._('panic_management'),
                          icon="msg_settings",
                          create_sub_fragment=self._create_management_subpage))
        except Exception:
            s = [Header("Error"), Text("Error loading settings", icon="msg_info")]
        return s

    def _create_management_subpage(self):
        passcode_enabled, passcode_hash_str = get_passcode_state()
        panic_hash, panic_enabled = get_panic_state(self)
        s = []
        try:
            s.append(Header(self._('panic_management')))
            SharedConfig = globals().get("SharedConfig")
            if not SharedConfig:
                s.append(Text(self._('sharedconfig_error'), icon="msg_warning"))
            else:
                if not passcode_enabled:
                    s.append(Text(self._('enable_passcode_first'), icon="msg_warning"))
                    s.append(Text(self._('enable_in_settings'), icon="msg_info"))
                else:
                    s.append(Switch("panic_enabled", self._('enable_panic_switch'),
                                    panic_enabled,
                                    icon="msg_permissions",
                                    on_change=self.on_switch_changed))
                    s.append(Divider())
                    if panic_hash:
                        s.append(Text(self._('change_panic_code'), icon="msg_secret", on_click=self.show_set_panic_dialog))
                        s.append(Text(self._('remove_panic_code'), icon="msg_delete", on_click=self.remove_panic_code))
                    else:
                        s.append(Text(self._('set_panic_code'), icon="msg_secret", on_click=self.show_set_panic_dialog))
        except Exception:
            s = [Header("Error"), Text("Error loading subpage", icon="msg_info")]
        return s

    def remove_panic_code(self, view=None):
        f = get_last_fragment()
        if not f:
            return

        def confirm_removal(*_):
            self.set_setting("panic_hash", "", reload_settings=True)
            self.set_setting("panic_enabled", False, reload_settings=True)
            BulletinHelper.show_success(self._('panic_code_removed'), f)
            self._invalidate_main_page_cache()
            self.notify_settings_changed()

        AlertDialogBuilder(f.getParentActivity()).set_title(self._('remove_confirm_title')) \
            .set_message(self._('remove_confirm_msg')) \
            .set_positive_button(self._('remove_button'), confirm_removal) \
            .set_negative_button(self._('cancel_button'), lambda *_: None) \
            .show()

    def show_set_panic_dialog(self, view=None):
        f = get_last_fragment()
        if not f:
            return
        ctx = f.getParentActivity()
        try:
            from android.widget import EditText, LinearLayout
            from android.text import InputType, InputFilter
            from android.text.method import PasswordTransformationMethod
            from android.view import ViewGroup

            layout = LinearLayout(ctx)
            layout.setOrientation(LinearLayout.VERTICAL)
            layout.setPadding(48, 24, 48, 24)

            code1 = EditText(ctx)
            code1.setHint(self._('enter_4_digits'))
            code1.setInputType(InputType.TYPE_CLASS_NUMBER)
            code1.setTransformationMethod(PasswordTransformationMethod())
            code1.setFilters([InputFilter.LengthFilter(4)])
            layout.addView(code1, LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT))

            spacer = LinearLayout(ctx)
            spacer.setMinimumHeight(24)
            layout.addView(spacer)

            code2 = EditText(ctx)
            code2.setHint(self._('repeat_4_digits'))
            code2.setInputType(InputType.TYPE_CLASS_NUMBER)
            code2.setTransformationMethod(PasswordTransformationMethod())
            code2.setFilters([InputFilter.LengthFilter(4)])
            layout.addView(code2, LinearLayout.LayoutParams(ViewGroup.LayoutParams.MATCH_PARENT, ViewGroup.LayoutParams.WRAP_CONTENT))

            builder = AlertDialogBuilder(ctx)
            builder.set_title(self._('set_panic_title'))
            builder.set_view(layout)

            def on_set(dialog, which):
                c1 = str(code1.getText()).strip()
                c2 = str(code2.getText()).strip()
                if len(c1) != 4 or not c1.isdecimal():
                    BulletinHelper.show_error(self._('only_4_digits'), f)
                    return
                if c1 != c2:
                    BulletinHelper.show_error(self._('codes_dont_match'), f)
                    return

                SharedConfig = globals().get("SharedConfig")
                if SharedConfig and hasattr(SharedConfig, 'checkPasscode'):
                    try:
                        if SharedConfig.checkPasscode(jString(c1)):
                            BulletinHelper.show_error(self._('cant_match_main'), f)
                            return
                    except Exception:
                        pass

                h = compute_simple_hash(c1)
                if not h:
                    BulletinHelper.show_error(self._('hash_error'), f)
                    return
                self.set_setting("panic_hash", str(h), reload_settings=True)
                self.set_setting("panic_enabled", True, reload_settings=True)
                BulletinHelper.show_success(self._('panic_code_set_enabled'), f)
                self._invalidate_main_page_cache()
                self.notify_settings_changed()

            builder.set_positive_button(self._('set_button'), on_set)
            builder.set_negative_button(self._('cancel_button'), None)
            builder.show()
        except Exception:
            BulletinHelper.show_error(self._('hash_error'), f)

    def _safe_delete(self, path, filter_fn=None):
        if not path or not path.exists():
            return 0
        try:
            if path.isDirectory():
                children = path.listFiles() or []
                total = sum(self._safe_delete(child, filter_fn) for child in children)
                return total + (1 if path.delete() else 0)
            else:
                name = path.getName()
                if not filter_fn or filter_fn(name):
                    if re.search(r'\.(db|xml)(\.|$)', name, re.IGNORECASE):
                        try:
                            from java.io import FileOutputStream
                            fos = FileOutputStream(path, False)
                            fos.write(bytearray())
                            fos.close()
                        except Exception:
                            pass
                    return 1 if path.delete() else 0
        except Exception:
            pass
        return 0

    def _cleanup_databases(self):
        try:
            MessagesStorage = globals().get("MessagesStorage")
            UserConfig = globals().get("UserConfig")
            if MessagesStorage and UserConfig:
                cnt = 1
                if hasattr(UserConfig, 'getActivatedAccountsCount'):
                    cnt = UserConfig.getActivatedAccountsCount()
                for aid in range(cnt):
                    ms = MessagesStorage.getInstance(aid)
                    if hasattr(ms, 'cleanUp'):
                        ms.cleanUp(True)
                    if hasattr(ms, 'clearMediaDatabase'):
                        ms.clearMediaDatabase()
        except Exception:
            pass

    def _wipe_all_data(self, ctx):
        try:
            self._cleanup_databases()
            package_name = ctx.getPackageName()
            targets = []

            internal_base = ctx.getFilesDir().getParentFile()
            targets.extend([
                ctx.getCacheDir(),
                ctx.getFilesDir(),
                File(internal_base, "databases"),
                File(internal_base, "shared_prefs"),
                File(internal_base, "code_cache"),
                File(internal_base, "no_backup"),
            ])

            for name in ["Telegram", "stickers", "wallpapers", "tmp", "Cache", "downloads"]:
                d = File(ctx.getFilesDir(), name)
                if d.exists():
                    targets.append(d)

            ext_files = ctx.getExternalFilesDir(None)
            if ext_files and ext_files.exists():
                targets.append(ext_files)
            ext_cache = ctx.getExternalCacheDir()
            if ext_cache and ext_cache.exists():
                targets.append(ext_cache)

            try:
                sdcard = Environment.getExternalStorageDirectory()
                if sdcard:
                    for subdir in [
                        f"Android/data/{package_name}",
                        f"Android/media/{package_name}",
                        f"Android/obb/{package_name}"
                    ]:
                        f = File(sdcard, subdir)
                        if f.exists():
                            targets.append(f)
            except Exception:
                pass

            media_dirs = ctx.getExternalMediaDirs()
            if media_dirs:
                for md in media_dirs:
                    if md and md.exists():
                        targets.append(md)

            for target in targets:
                if target and target.exists():
                    self._safe_delete(target, None)

        except Exception:
            pass

    def _sync_logout_and_restart(self):
        if not hasattr(self, '_sync_lock'):
            self._sync_lock = threading.Lock()
        with self._sync_lock:
            threading.Thread(target=self._force_logout, daemon=True, name="PanicLogout").start()

    def _force_logout(self):
        try:
            SharedConfig = globals().get("SharedConfig")
            if SharedConfig:
                SharedConfig.passcodeHash = ""
                SharedConfig.appLocked = False
                if hasattr(SharedConfig, 'saveConfigSync'):
                    SharedConfig.saveConfigSync()
                else:
                    SharedConfig.saveConfig()

            ApplicationLoader = globals().get("ApplicationLoader")
            if ApplicationLoader and hasattr(ApplicationLoader, 'mainInterface'):
                ApplicationLoader.mainInterface.post(self._do_logout_in_ui)

            if ApplicationLoader and ApplicationLoader.applicationContext:
                ctx = ApplicationLoader.applicationContext
                self._wipe_all_data(ctx)

            NotificationCenter = globals().get("NotificationCenter")
            if NotificationCenter:
                nc = NotificationCenter.getGlobalInstance()
                if hasattr(NotificationCenter, 'didLogoutFromAllAccounts'):
                    nc.postNotificationName(NotificationCenter.didLogoutFromAllAccounts)

        except Exception:
            BulletinHelper.show_error(self._('wipe_error'), get_last_fragment())
        finally:
            time.sleep(2.0)
            self._do_restart()

    def _do_logout_in_ui(self):
        try:
            AccountInstance = globals().get("AccountInstance")
            MessagesController = globals().get("MessagesController")
            if not (AccountInstance and MessagesController):
                return

            UserConfig = globals().get("UserConfig")
            cnt = UserConfig.getActivatedAccountsCount() if UserConfig else 1
            for i in range(cnt):
                try:
                    acc = AccountInstance.getInstance(i)
                    if not acc:
                        continue
                    mc = acc.getMessagesController() if hasattr(acc, 'getMessagesController') else MessagesController.getInstance(i)
                    if mc and hasattr(mc, 'performLogout'):
                        mc.performLogout(1)
                except Exception:
                    pass
        except Exception:
            pass

    def _do_restart(self):
        try:
            ApplicationLoader = globals().get("ApplicationLoader")
            if not ApplicationLoader or not ApplicationLoader.applicationContext:
                self._force_kill()
                return

            ctx = ApplicationLoader.applicationContext
            pm = ctx.getPackageManager()
            intent = pm.getLaunchIntentForPackage(ctx.getPackageName())
            if intent:
                from android.content import Intent
                intent.addFlags(
                    Intent.FLAG_ACTIVITY_CLEAR_TASK |
                    Intent.FLAG_ACTIVITY_NEW_TASK |
                    Intent.FLAG_ACTIVITY_CLEAR_TOP |
                    Intent.FLAG_ACTIVITY_NO_ANIMATION
                )
                intent.putExtra("force_logout", True)
                ctx.startActivity(intent)

            time.sleep(0.5)
        except Exception:
            pass

        self._force_kill()

    def _force_kill(self):
        try:
            Process.killProcess(Process.myPid())
        except:
            pass
        try:
            System = jclass("java.lang.System")
            System.exit(1)
        except:
            pass
        try:
            Runtime = jclass("java.lang.Runtime")
            Runtime.getRuntime().halt(1)
        except:
            pass


def create_plugin():
    return PanicPasscodePlugin()