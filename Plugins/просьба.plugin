"""
‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ïó   ‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó      ‚îÇ
‚îÇ  ‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ñà‚ñà‚ïó  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù      ‚îÇ
‚îÇ  ‚ñà‚ñà‚ïî‚ñà‚ñà‚ñà‚ñà‚ïî‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó        ‚îÇ
‚îÇ  ‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë‚ïö‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïî‚ïê‚ïê‚ïù        ‚îÇ
‚îÇ  ‚ñà‚ñà‚ïë ‚ïö‚ïê‚ïù ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë ‚ïö‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïî‚ïù‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó      ‚îÇ
‚îÇ  ‚ïö‚ïê‚ïù     ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïê‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù      ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ         ‚ñà‚ñà‚ñà‚ñà‚ñà‚ïó ‚ñà‚ñà‚ïó                                          ‚îÇ
‚îÇ        ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïó‚ñà‚ñà‚ïë    ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ                 ‚îÇ
‚îÇ        ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë    ‚îÇ¬© 2024-2025        ‚îÇ                 ‚îÇ
‚îÇ        ‚ñà‚ñà‚ïî‚ïê‚ïê‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë    ‚îÇLicensed Product   ‚îÇ                 ‚îÇ
‚îÇ        ‚ñà‚ñà‚ïë  ‚ñà‚ñà‚ïë‚ñà‚ñà‚ïë    ‚îÇAll Rights Reserved‚îÇ                 ‚îÇ
‚îÇ        ‚ïö‚ïê‚ïù  ‚ïö‚ïê‚ïù‚ïö‚ïê‚ïù    ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ                 ‚îÇ
‚îÇ                                                             ‚îÇ
‚îÇ  ‚ï≠‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïÆ  ‚îÇ
‚îÇ  ‚îÇ Unauthorized use, reproduction or distribution        ‚îÇ  ‚îÇ
‚îÇ  ‚îÇ of this software is strictly prohibited               ‚îÇ  ‚îÇ
‚îÇ  ‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ  ‚îÇ
‚îÇ                                                             ‚îÇ
‚ï∞‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ïØ
"""
#      _.-._
#    .'_|_|_'.
#   / | o o | \
#  |/    _    \|
#  ( \ '---' / )
#   `._.,*.,_.'
#     / \/ \
# –ö–ê–ü–ò–ë–ê–†–ê-–°–¢–ê–¢–ò–°–¢

__id__ = "chat_word_stats"
__name__ = "ChatWordStats"
__version__ = "1.0"
__author__ = """MandreAI & –°–≤–∞–≥–∞–ù–µ–¢—É—Ç–∞
@swagnonher & @MandreAI_bot"""
__description__ = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∞–º—ã—Ö –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Å–ª–æ–≤. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .chatstat [–ª–∏–º–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏–π] –≤ –ª—é–±–æ–º —á–∞—Ç–µ. –†–∞–±–æ—Ç–∞–µ—Ç –≤ —Ñ–æ–Ω–µ."
__min_version__ = "11.9.0"
__icon__ = "msg_stats_solar"

import re
import traceback
import time
import threading
from collections import Counter

from base_plugin import BasePlugin, HookResult
from client_utils import (
    get_messages_controller,
    run_on_queue,
    send_message,
    send_request,
)
from android_utils import run_on_ui_thread, log
from ui.bulletin import BulletinHelper
from ui.settings import Header, Input, Divider
from org.telegram.tgnet import TLRPC
from markdown_utils import parse_markdown
from mandre_lib import Mandre

# –ë–∞–∑–æ–≤—ã–π —Å–ø–∏—Å–æ–∫ —Å—Ç–æ–ø-—Å–ª–æ–≤ –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ –∏ –∞–Ω–≥–ª–∏–π—Å–∫–æ–≥–æ —è–∑—ã–∫–æ–≤
DEFAULT_STOP_WORDS = {
    "–∏", "–≤", "–Ω–µ", "–Ω–∞", "—è", "—Å", "—á—Ç–æ", "–∞", "–ø–æ", "—ç—Ç–æ", "–∫–∞–∫", "—Ç–æ", "–Ω–æ",
    "–∫", "—É", "–∂–µ", "–≤—Å–µ", "–æ–Ω", "–∑–∞", "—Ç–∞–∫", "—Ç—ã", "–Ω—É", "–∂–µ", "–±—ã", "–≤–æ—Ç", "–¥–∞",
    "a", "an", "the", "in", "on", "of", "to", "is", "it", "i", "you", "he", "she",
    "they", "we", "and", "but", "or", "for", "with", "at", "from", "by", "that", "this"
}

class ChatWordStatsPlugin(BasePlugin):
    def on_plugin_load(self):
        Mandre.use_persistent_storage(self)
        Mandre.register_command(self, "chatstat", self._handle_command)
        self.add_on_send_message_hook()
        log(f"[{self.id}] –ü–ª–∞–≥–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É –∫–æ–º–∞–Ω–¥.")

    def on_plugin_unload(self):
        log(f"[{self.id}] –ü–ª–∞–≥–∏–Ω –≤—ã–≥—Ä—É–∂–µ–Ω.")

    def on_send_message_hook(self, account, params):
        """–ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –∏—Å—Ö–æ–¥—è—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥."""
        result = Mandre.handle_outgoing_command(params)
        if result is not None:
            return result
        return HookResult()

    def create_settings(self):
        return [
            Header(text="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–ª–æ–≤"),
            Input(
                key="top_words_count",
                text="–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–ª–æ–≤ –≤ —Ç–æ–ø–µ",
                default="20",
                icon="msg_list"
            ),
            Input(
                key="min_word_length",
                text="–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ —Å–ª–æ–≤–∞",
                default="3",
                icon="msg_zoomout_stats"
            ),
            Input(
                key="custom_stop_words",
                text="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞",
                subtext="–ß–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤. –ù–∞–ø—Ä–∏–º–µ—Ä: –ø—Ä–∏–≤–µ—Ç,–ø–æ–∫–∞,–æ–∫",
                default="",
                icon="msg_block2"
            ),
            Divider(text="–°–ª–æ–≤–∞ –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞ –Ω–µ –±—É–¥—É—Ç —É—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –≤ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–µ.")
        ]

    def _handle_command(self, plugin_instance, args: str, params):
        """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã .chatstat, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ—Ä–µ–∑ MandreLib."""
        log(f"[{self.id}] –ö–æ–º–∞–Ω–¥–∞ .chatstat –ø–æ–ª—É—á–µ–Ω–∞ —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏: '{args}'")
        try:
            limit_str = args.strip()
            # –ï—Å–ª–∏ 0 –∏–ª–∏ –ø—É—Å—Ç–æ - –∑–Ω–∞—á–∏—Ç, –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å—ë
            limit = int(limit_str) if limit_str.isdigit() and limit_str != '0' else float('inf')
        except ValueError:
            limit = 1000

        peer_id = params.peer
        
        if peer_id > 0:
             run_on_ui_thread(lambda: BulletinHelper.show_error("–≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –≤ –≥—Ä—É–ø–ø–∞—Ö –∏ –∫–∞–Ω–∞–ª–∞—Ö."))
             return
        
        limit_text = "–≤—Å–µ–π –∏—Å—Ç–æ—Ä–∏–∏" if limit == float('inf') else f"{int(limit)} —Å–æ–æ–±—â–µ–Ω–∏–π"
        run_on_ui_thread(lambda: BulletinHelper.show_info(f"–ù–∞—á–∏–Ω–∞—é –∞–Ω–∞–ª–∏–∑ {limit_text}..."))

        # –í–µ—Å—å —Ç—è–∂–µ–ª—ã–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ñ–æ–Ω–æ–≤–æ–º –ø–æ—Ç–æ–∫–µ, –Ω–µ –±–ª–æ–∫–∏—Ä—É—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
        run_on_queue(lambda: self._start_collecting(peer_id, limit, params))
        return

    def _start_collecting(self, peer_id, limit, params):
        """–û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª —Å–±–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π."""
        try:
            top_n = int(self.get_setting("top_words_count", "20"))
            min_len = int(self.get_setting("min_word_length", "3"))
            custom_stop_words_str = self.get_setting("custom_stop_words", "")
            custom_stop_words = {word.strip().lower() for word in custom_stop_words_str.split(',') if word.strip()}
            stop_words = DEFAULT_STOP_WORDS.union(custom_stop_words)
            
            word_counter = Counter()
            processed_count = 0
            offset_id = 0
            start_time = time.time()
            last_log_time = start_time

            while processed_count < limit:
                batch_event = threading.Event()
                batch_result = {"messages": None, "error": None}

                req = TLRPC.TL_messages_getHistory()
                req.peer = get_messages_controller().getInputPeer(peer_id)
                req.limit = 500
                req.offset_id = offset_id

                def on_response(response, error):
                    if error:
                        batch_result["error"] = error
                    else:
                        batch_result["messages"] = response.messages
                    batch_event.set()

                send_request(req, on_response)
                
                # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞ (—Å —Ç–∞–π–º–∞—É—Ç–æ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
                batch_event.wait(timeout=30.0)

                if batch_result["error"]:
                    log(f"[{self.id}] –û—à–∏–±–∫–∞ API: {batch_result['error'].text}")
                    run_on_ui_thread(lambda: BulletinHelper.show_error(f"–û—à–∏–±–∫–∞ API: {batch_result['error'].text}"))
                    break
                
                messages = batch_result["messages"]
                if not messages or messages.isEmpty():
                    log(f"[{self.id}] –î–æ—Å—Ç–∏–≥–Ω—É—Ç –∫–æ–Ω–µ—Ü –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞.")
                    break
                
                last_message_id = messages.get(messages.size() - 1).id
                if last_message_id == offset_id:
                    log(f"[{self.id}] –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏–µ (offset_id –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è). –ü—Ä–µ—Ä—ã–≤–∞–Ω–∏–µ.")
                    break
                offset_id = last_message_id

                for i in range(messages.size()):
                    if processed_count >= limit:
                        break
                    
                    msg = messages.get(i)
                    if isinstance(msg, TLRPC.TL_message) and msg.message:
                        text = msg.message.lower()
                        words = re.findall(r'\b[–∞-—èa-z-]{' + str(min_len) + r',}\b', text)
                        word_counter.update(word for word in words if word not in stop_words)
                    
                    processed_count += 1

                current_time = time.time()
                if current_time - last_log_time > 5.0: # –õ–æ–≥–∏—Ä—É–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
                    elapsed = current_time - start_time
                    if elapsed > 0:
                        speed = processed_count / elapsed
                        eta_str = "‚àû" if limit == float('inf') else self._format_eta((limit - processed_count) / speed if speed > 0 else 0)
                        
                        limit_text = "‚àû" if limit == float('inf') else limit
                        progress_text_log = (f"–ü—Ä–æ–≥—Ä–µ—Å—Å: {processed_count}/{limit_text} "
                                             f"({speed:.1f} —Å–æ–æ–±—â/—Å–µ–∫, ETA: ~{eta_str})")
                        log(f"[{self.id}] {progress_text_log}")
                    last_log_time = current_time

            self._finalize_and_send(peer_id, processed_count, params, top_n, word_counter)

        except Exception as e:
            log(f"[{self.id}] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ü–∏–∫–ª–µ —Å–±–æ—Ä–∞: {traceback.format_exc()}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {e}"))

    def _format_eta(self, seconds):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Å–µ–∫—É–Ω–¥—ã –≤ —á–∏—Ç–∞–µ–º—ã–π –≤–∏–¥."""
        if seconds <= 0:
            return "–∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ..."
        if seconds < 60:
            return f"{int(seconds)} —Å–µ–∫"
        minutes = int(seconds / 60)
        secs = int(seconds % 60)
        return f"{minutes} –º–∏–Ω {secs} —Å–µ–∫"

    def _finalize_and_send(self, peer_id, total_processed, params, top_n, word_counter):
        """–§–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç."""
        log(f"[{self.id}] –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–∞ –¥–ª—è {total_processed} —Å–æ–æ–±—â–µ–Ω–∏–π.")
        
        if not word_counter:
            run_on_ui_thread(lambda: BulletinHelper.show_info("–ù–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Å–ª–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏."))
            return

        chat = get_messages_controller().getChat(-peer_id)
        chat_title = chat.title if chat else f"Chat ID {peer_id}"

        top_words = word_counter.most_common(top_n)

        result_text = f"üìä **–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–ª–æ–≤ –≤ —á–∞—Ç–µ ¬´{chat_title}¬ª**\n"
        result_text += f"_–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π: {total_processed}_\n\n"
        
        for i, (word, count) in enumerate(top_words, 1):
            result_text += f"`{i:02d}.` `{word}` ‚Äî *{count} —Ä–∞–∑*\n"
            
        result_text += f"\n*–ü–ª–∞–≥–∏–Ω –æ—Ç @MandreAI_bot*"

        try:
            parsed = parse_markdown(result_text)
            
            tlrpc_entities = [entity.to_tlrpc_object() for entity in parsed.entities]

            send_params = {
                "peer": params.peer,
                "message": parsed.text,
                "entities": tlrpc_entities,
            }
            send_message(send_params)
            log(f"[{self.id}] –û—Ç—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.")
            run_on_ui_thread(lambda: BulletinHelper.show_success("–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–ª–æ–≤ –≥–æ—Ç–æ–≤–∞!"))
        except Exception as e:
            log(f"[{self.id}] –û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏: {traceback.format_exc()}")
            run_on_ui_thread(lambda: BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç."))