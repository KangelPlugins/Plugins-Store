# -*- coding: utf-8 -*-

import traceback

from base_plugin import BasePlugin, MenuItemData, MenuItemType, MethodHook, HookResult, HookStrategy
from android_utils import run_on_ui_thread, log
from client_utils import get_last_fragment
from ui.alert import AlertDialogBuilder
from ui.bulletin import BulletinHelper

from org.telegram.messenger import AndroidUtilities, MessageObject
from org.telegram.ui.ActionBar import Theme
from org.telegram.ui import ChatActivity
from org.telegram.ui.Cells import ChatMessageCell
from java.lang import Boolean

from hook_utils import find_class
# –†–µ—Ñ–ª–µ–∫—Å–∏—è - –Ω–∞ –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö —É–∂–µ –≤ hook_utils (–≤—Ä–æ–¥–µ) –Ω–æ –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–æ–¥—Å—Ç—Ä–∞—Ö—É–µ–º—Å—è
try:
    from hook_utils import get_private_field, set_private_field
except Exception:
    try:
        from hook_utils import get_private_field
    except Exception:
        get_private_field = None
    try:
        from hook_utils import set_private_field
    except Exception:
        set_private_field = None

try:
    import zwylib
except ImportError:
    zwylib = None


__id__ = "LocalEdictor"
__name__ = "Local Edictor"
__description__ = (
    "–ü–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏–π –ª–æ–∫–∞–ª—å–Ω–æ! \n–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏, —Ç–∞–∫–∂–µ –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π. \n\n\n–ß—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ –≤ 1.2.0?\n1. –£–ª—É—á—à–µ–Ω–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è\n2. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –º–Ω–æ–≥–∏–µ –∫—Ä–∞—à–∏/–±–∞–≥–∏\n3. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π ExteraGram/AyuGram\n\n\n*–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ\n–ï—Å—Ç—å –±–∞–≥ —á—Ç–æ –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —Å —Ñ–∞–π–ª–∞–º–∏/—Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ. –≠—Ç–æ –±—É–¥–µ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –±—É–¥—É—â–∏—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è—Ö.\n–ü—Ä–æ—Å—å–±–∞ –Ω–µ –ø–∏—Å–∞—Ç—å –∞–≤—Ç–æ—Ä—É –ø–ª–∞–≥–∏–Ω–∞ –ø–æ —ç—Ç–æ–º—É –ø–æ–≤–æ–¥—É!\n\n\n‚õîÔ∏è‚õîÔ∏è‚õîÔ∏è‚õî –ë–ï–ó –ë–ò–ë–õ–ò–û–¢–ï–ö–ò zwyLib –ù–ï –ë–£–î–ï–¢ –†–ê–ë–û–¢–ê–¢–¨!‚õîÔ∏è‚õîÔ∏è‚õîÔ∏è")
__author__ = "@Nikita218000"
__version__ = "1.2.0"
__min_version__ = "12.1.1"
__icon__ = "IconForPlugins_by_TgEmodziBot/2"

HOOK_PRIORITY = 10

# –í—Å–µ –≤ try –ø–æ—Ç–æ–º—É —á—Ç–æ –∑–∞–¥–æ–ª–±–∞–ª–∏ –∫—Ä–∞—à–∏ –∏ —è —Ö–∑ —á—Ç–æ —Å –Ω–∏–º–∏ –¥–µ–ª–∞—Ç—å
try:
    class LocalHook(MethodHook):
        def __init__(self, plugin):
            self.plugin = plugin

        def before_hooked_method(self, param):
            cache = self.plugin.edited_messages_cache
            if not cache or not cache.content:
                return HookResult(HookStrategy.DEFAULT)

            try:
                if not param.args or param.args[0] is None:
                    return HookResult(HookStrategy.DEFAULT)

                message_object = param.args[0]
                try:
                    _ = message_object.getId()
                except Exception:
                    return HookResult(HookStrategy.DEFAULT)

                key = f"{message_object.getId()}_{message_object.getDialogId()}"
                new_text = cache.content.get(key)
                if not new_text or not isinstance(new_text, str):
                    return HookResult(HookStrategy.DEFAULT)

                applied = self.plugin._safe_apply_text_to_message_object(message_object, new_text)

                try:
                    setattr(message_object, "le_local_applied", Boolean(applied))
                except Exception:
                    pass
                try:
                    setattr(message_object, "forceUpdate", True)
                except Exception:
                    pass

                if applied:
                    try:
                        cell = param.thisObject
                        if isinstance(cell, ChatMessageCell):
                            cell.invalidate()
                            cell.requestLayout()
                    except Exception:
                        pass
            except Exception as e:
                log(f"[{__name__}] Hook(before) error: {e}")
                traceback.print_exc()
            return HookResult(HookStrategy.DEFAULT)

        def after_hooked_method(self, param):
            try:
                if not param.args or param.args[0] is None:
                    return HookResult(HookStrategy.DEFAULT)

                message_object = param.args[0]
                applied_flag = False
                try:
                    applied_flag = bool(getattr(message_object, "le_local_applied", False))
                except Exception:
                    pass

                if applied_flag:
                    cell = param.thisObject
                    if isinstance(cell, ChatMessageCell):
                        try:
                            setattr(message_object, "le_local_applied", Boolean(False))
                        except Exception:
                            pass
                        cell.invalidate()
                        cell.requestLayout()
            except Exception as e:
                log(f"[{__name__}] Hook(after) error: {e}")
                traceback.print_exc()
            return HookResult(HookStrategy.DEFAULT)


    # –°–∞–º –ø–ª–∞–≥–∏–Ω
    class LocalEditPlugin(BasePlugin):
        def __init__(self):
            super().__init__()
            self.edited_messages_cache = None
            self.unhooks = []

        def on_plugin_load(self):
            if zwylib is None:
                log(f"[{__name__}] zwylib –Ω–µ –Ω–∞–π–¥–µ–Ω! –ü–ª–∞–≥–∏–Ω –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å.")
                run_on_ui_thread(lambda: BulletinHelper.show_error("zwylib –Ω–µ –Ω–∞–π–¥–µ–Ω! Local Edictor –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å."))
                return

            try:
                self.edited_messages_cache = zwylib.JsonCacheFile("LocalEdictor_data", {})

                self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.MESSAGE_CONTEXT_MENU,
                    text="–ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ",
                    on_click=self.handle_edit_click,
                    icon="msg_edit"
                ))

                self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.CHAT_ACTION_MENU,
                    text="–°–±—Ä–æ—Å–∏—Ç—å –ª–æ–∫. –∏–∑–º–µ–Ω–µ–Ω–∏—è",
                    on_click=self.handle_reset_click,
                    icon="msg_delete"
                ))

                self._install_hooks()
            except Exception as e:
                log(f"[{__name__}] –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–ª–∞–≥–∏–Ω–∞: {str(e)}")
                traceback.print_exc()

        def _install_hooks(self):
            try:
                ChatMessageCellClass = find_class("org.telegram.ui.Cells.ChatMessageCell")
                if ChatMessageCellClass is None:
                    raise RuntimeError("–ö–ª–∞—Å—Å ChatMessageCell –Ω–µ –Ω–∞–π–¥–µ–Ω")

                handler = LocalHook(self)
                all_methods = ChatMessageCellClass.getClass().getDeclaredMethods()
                hooked = 0

                for method in all_methods:
                    if method.getName() == "setMessageContent":
                        try:
                            unhook = self.hook_method(method, handler, priority=HOOK_PRIORITY)
                            if unhook:
                                self.unhooks.append(unhook)
                                hooked += 1
                        except Exception as e:
                            log(f"[{__name__}] –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ö—É–∫–∞—Ç—å {method.getName()}: {e}")

                if not self.unhooks:
                    log(f"[{__name__}] –ö–†–ò–¢–ò–ß–ù–û: –Ω–µ –∑–∞—Ö—É–∫–∞–ª–∏ –Ω–∏ –æ–¥–∏–Ω –º–µ—Ç–æ–¥. –°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –ø—Ä–æ–±–ª–µ–º–∞ —É–∂–µ –≤ —Å–∞–º–æ–º –∫–ª–∏–µ–Ω—Ç–µ.")
                    run_on_ui_thread(lambda: BulletinHelper.show_error("Local Edictor: –Ω–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ö—É–∫–∏."))
                else:
                    log(f"[{__name__}] –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ {len(self.unhooks)} —Ö—É–∫–æ–≤ –Ω–∞ ChatMessageCell.")
            except Exception as e:
                log(f"[{__name__}] –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ö—É–∫–æ–≤: {e}")
                traceback.print_exc()
                run_on_ui_thread(lambda: BulletinHelper.show_error("–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ö—É–∫–∞ Local Edictor."))

        def handle_edit_click(self, context):
            if not self.edited_messages_cache:
                BulletinHelper.show_error("–û—à–∏–±–∫–∞: –∫—ç—à –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω (zwylib?).")
                return

            try:
                message_object = context.get("message")
                if not message_object:
                    BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è.")
                    return

                last_fragment = get_last_fragment()
                if not last_fragment or not last_fragment.getParentActivity():
                    BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞.")
                    return

                activity = last_fragment.getParentActivity()
                LinearLayout = find_class("android.widget.LinearLayout")
                EditText = find_class("android.widget.EditText")

                layout = LinearLayout(activity)
                layout.setOrientation(LinearLayout.VERTICAL)
                padding = AndroidUtilities.dp(20)
                layout.setPadding(padding, AndroidUtilities.dp(10), padding, AndroidUtilities.dp(10))

                edit_text = EditText(activity)
                msg_id = message_object.getId()
                dlg_id = message_object.getDialogId()
                key = f"{msg_id}_{dlg_id}"
                original = str(message_object.messageText) if message_object.messageText else ""
                current = self.edited_messages_cache.content.get(key, original)

                edit_text.setText(current)
                edit_text.setHint("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç")
                edit_text.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                edit_text.setHintTextColor(Theme.getColor(Theme.key_dialogTextHint))
                layout.addView(edit_text)

                builder = AlertDialogBuilder(activity)
                builder.set_title("–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ")
                builder.set_view(layout)

                def save_click(dialog, which):
                    new_text = edit_text.getText().toString()
                    self._apply_local_edit(message_object, new_text)
                    dialog.dismiss()

                builder.set_positive_button("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", save_click)
                builder.set_negative_button("–û—Ç–º–µ–Ω–∞", lambda d, w: d.dismiss())
                run_on_ui_thread(builder.show)
            except Exception as e:
                log(f"[{__name__}] –û—à–∏–±–∫–∞ –≤ handle_edit_click: {str(e)}")
                traceback.print_exc()
                BulletinHelper.show_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞.")

        def handle_reset_click(self, context):
            if not self.edited_messages_cache:
                BulletinHelper.show_error("–ö—ç—à –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω.")
                return
            try:
                self._reset_messages()
            except Exception as e:
                log(f"[{__name__}] –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞: {str(e)}")
                traceback.print_exc()

        def _safe_apply_text_to_message_object(self, message_object, new_text: str) -> bool:
            applied = False
            try:
                message_object.applyNewText(new_text)
                applied = True
            except Exception:
                pass

            if not applied:
                try:
                    message_object.messageText = str(new_text)
                    applied = True
                except Exception:
                    pass

                if applied and set_private_field is not None:
                    for field in ("textLayoutBlocks", "textLayout", "instantText", "spannableString", "animatedEmojiStack"):
                        try:
                            set_private_field(message_object, field, None)
                        except Exception:
                            pass
                    try:
                        setattr(message_object, "forceUpdate", True)
                    except Exception:
                        pass
            return applied

        def _apply_local_edit(self, message_object, new_text):
            try:
                msg_id = message_object.getId()
                dlg_id = message_object.getDialogId()
                key = f"{msg_id}_{dlg_id}"

                if not new_text or not new_text.strip():
                    if key in self.edited_messages_cache.content:
                        del self.edited_messages_cache.content[key]
                        self.edited_messages_cache.write()
                        BulletinHelper.show_success("–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å–±—Ä–æ—à–µ–Ω–æ! üò∏") # –î–∞–∂–µ —Å–º–∞–π–ª–∏–∫ –Ω–∞—à–µ–ª!
                    else:
                        return
                else:
                    self.edited_messages_cache.content[key] = new_text
                    self.edited_messages_cache.write()
                    self._safe_apply_text_to_message_object(message_object, new_text)
                    BulletinHelper.show_success("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ! üò∏")
                    
            except Exception as e:
                log(f"[{__name__}] –û—à–∏–±–∫–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∫–∏: {str(e)}")
                traceback.print_exc()
                BulletinHelper.show_error("–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å. üòø")

        def _reset_messages(self):
            try:
                self.edited_messages_cache.content.clear()
                self.edited_messages_cache.write()
                # –£–±—Ä–∞–ª–∏ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                run_on_ui_thread(lambda: BulletinHelper.show_success("–í—Å–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã! üò∏"))
            except Exception as e:
                log(f"[{__name__}] –û—à–∏–±–∫–∞ —Å–±—Ä–æ—Å–∞: {e}")
                traceback.print_exc()
                run_on_ui_thread(lambda: BulletinHelper.show_error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ. üòø"))

        def _get_chat_list_view(self, fragment):
            view = None
            try:
                view = fragment.getChatListView()
            except Exception:
                pass

            if view is None and get_private_field:
                for name in ("chatListView", "chatRecyclerListView", "messagesListView"):
                    try:
                        view = get_private_field(fragment, name)
                        if view:
                            break
                    except Exception:
                        continue
            return view

except Exception as e:
    log(f"[{__name__}] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –í –Ø–î–†–ï –ü–õ–ê–ì–ò–ù–ê: {e}")
    traceback.print_exc()
    run_on_ui_thread(lambda: BulletinHelper.show_error("Local Edictor: –ø–ª–∞–≥–∏–Ω –æ—Ç–∫–ª—é—á—ë–Ω –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏."))