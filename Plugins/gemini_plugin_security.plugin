import os
import time
import json
import requests
import threading
import traceback
import ast
from typing import Any, Dict, Optional, Tuple, List

from base_plugin import BasePlugin, HookResult, HookStrategy, MenuItemData, MenuItemType
from client_utils import (
    get_file_loader, run_on_queue, send_message, get_last_fragment,
    get_messages_controller, get_user_config
)
from markdown_utils import parse_markdown
from ui.settings import Header, Input, Divider, Switch, Selector, Text
from ui.bulletin import BulletinHelper
from ui.alert import AlertDialogBuilder
from android_utils import run_on_ui_thread, log

from java.util import Locale
from org.telegram.tgnet import TLRPC
from org.telegram.messenger import MessageObject, FileLoader, AndroidUtilities, ChatObject

__id__ = "gemini_plugin_security"
__name__ = "Gemini Plugin Security"
__description__ = "Checks Extera plugin code for security risks using Google Gemini API."
__author__ = "@mihailkotovski & @mishabotov"
__version__ = "4.0.0 [release]"
__min_version__ = "11.12.1"
__icon__ = "DateRegBot_by_MoiStikiBot/8"

AUTOUPDATE_CHANNEL_ID = 2349438816
AUTOUPDATE_CHANNEL_USERNAME = "mishabotov"
AUTOUPDATE_MESSAGE_ID = 96

zwylib: Optional[Any] = None

GEMINI_BASE_URL = "https://generativelanguage.googleapis.com/v1beta/models/"
MODEL_DISPLAY_NAMES = [
    "Gemini 2.5 Pro",
    "Gemini 2.5 Flash",
    "Gemini 2.5 Flash Lite"
]
MODEL_API_NAMES = [
    "gemini-2.5-pro",
    "gemini-2.5-flash",
    "gemini-2.5-flash-lite-preview-06-17"
]
DEFAULT_COMMAND = ".gpa"

PREMIUM_EMOJI_MAP = {
    "âŒ": "[âŒ](5210952531676504517)",
    "ğŸ“›": "[â—ï¸](5834951734358707402)",
    "âš ï¸": "[âš ï¸](5447644880824181073)",
    "â”": "[â”](5467461928647399673)",
    "âœ…": "[âœ…](5219899949281453881)",
    "ğŸ›¡ï¸": "[â„¹ï¸](5404366668635865453)",
    "â—ˆ": "[âŒ](5258453452631056344)",
    "â˜¶": "[ğŸ“](5256230583717079814)",
    "â": "[âœï¸](5337063551854999885)",
    "â€¢": "[ğŸŸ¦](5404724576850573443)"
}

def replace_with_premium_emoji(text: str) -> str:
    result = text
    for regular_emoji, premium_emoji in PREMIUM_EMOJI_MAP.items():
        result = result.replace(regular_emoji, premium_emoji)
    return result

def get_regular_emoji_for_bulletin(text: str) -> str:
    result = text
    for regular_emoji, premium_emoji in PREMIUM_EMOJI_MAP.items():
        result = result.replace(premium_emoji, regular_emoji)
    return result

DEFAULT_PROMPT_MARKDOWN = (
    "Ğ¢Ñ‹ â€” Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº Ğ¿Ğ¾ ĞºĞ¸Ğ±ĞµÑ€Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸, ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ÑÑ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ½Ğ° Ğ°ÑƒĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ² Ğ´Ğ»Ñ Ñ„Ñ€ĞµĞ¹Ğ¼Ğ²Ğ¾Ñ€ĞºĞ° ExteraGram. Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°ÑƒĞ´Ğ¸Ñ‚ ĞºĞ¾Ğ´Ğ° Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° '{plugin_name}' (v{plugin_version}), Ğ¾Ğ¿Ğ¸Ñ€Ğ°ÑÑÑŒ Ğ½Ğ° Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ ĞµĞ³Ğ¾ API, Ğ¸ Ğ²Ñ‹Ğ½ĞµÑÑ‚Ğ¸ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ€Ğ´Ğ¸ĞºÑ‚ Ğ¿Ğ¾ 5-ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ¾Ğ¹ ÑˆĞºĞ°Ğ»Ğµ Ñ€Ğ¸ÑĞºĞ°. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: ĞºĞ¾Ğ´ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½ Ğ´Ğ»Ñ Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ¸), Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ.\n\n"
    "--- ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ ExteraGram API (Ğ­Ñ‚Ğ¾ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğœ) ---\n"
    "Ğ›ÑĞ±Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… API ExteraGram ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğ¹ Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¾Ğ¹, Ğ° Ğ½Ğµ ÑƒĞ³Ñ€Ğ¾Ğ·Ğ¾Ğ¹:\n\n"
    "â€¢ Ğ‘ĞĞ—ĞĞ’Ğ«Ğ™ ĞŸĞ›ĞĞ“Ğ˜Ğ API (base_plugin):\n"
    "  - BasePlugin ĞºĞ»Ğ°ÑÑ Ğ¸ ĞµĞ³Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ (on_plugin_load, on_plugin_unload, create_settings)\n"
    "  - HookResult, HookStrategy Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ğ° Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²\n"
    "  - Ğ¥ÑƒĞºĞ¸: add_hook, add_on_send_message_hook, pre_request_hook, post_request_hook\n"
    "  - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸: get_setting, set_setting Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸\n"
    "  - Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: self.log() Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹\n\n"
    "â€¢ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ¡ĞšĞ˜Ğ• Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« (client_utils):\n"
    "  - ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: send_message Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸ peer, message, entities, replyToMsg\n"
    "  - API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹: send_request Ñ TLRPC Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ RequestCallback\n"
    "  - Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸: run_on_queue Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑĞ¼Ğ¸ PLUGINS_QUEUE, GLOBAL_QUEUE, EXTERNAL_NETWORK_QUEUE\n"
    "  - ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€Ñ‹: get_messages_controller, get_user_config, get_file_loader, get_last_fragment\n"
    "  - ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: get_account_instance, get_connections_manager\n\n"
    "â€¢ ANDROID Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« (android_utils):\n"
    "  - UI Ğ¿Ğ¾Ñ‚Ğ¾Ğº: run_on_ui_thread Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°\n"
    "  - Ğ‘ÑƒÑ„ĞµÑ€ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°: AndroidUtilities.addToClipboard\n"
    "  - Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: log() Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸\n\n"
    "â€¢ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¬Ğ¡ĞšĞ˜Ğ™ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡:\n"
    "  - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (ui.settings): Header, Input, Switch, Selector, Text, Divider\n"
    "  - Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ (ui.alert): AlertDialogBuilder Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ ALERT_TYPE_MESSAGE, ALERT_TYPE_SPINNER\n"
    "  - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ (ui.bulletin): BulletinHelper.show_info, show_error, show_success\n\n"
    "â€¢ TELEGRAM API (TLRPC):\n"
    "  - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²: TLRPC.TL_messages_*, TLRPC.TL_users_*, TLRPC.TL_channels_*\n"
    "  - ĞĞ±ÑŠĞµĞºÑ‚Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: MessageObject, TLRPC.Message\n"
    "  - ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸ Ñ‡Ğ°Ñ‚Ñ‹: TLRPC.User, TLRPC.Chat, TLRPC.UserFull\n"
    "  - ĞœĞµĞ´Ğ¸Ğ°: TLRPC.Document, TLRPC.Photo, FileLoader Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²\n\n"
    "â€¢ Ğ ĞĞ—ĞœĞ•Ğ¢ĞšĞ Ğ˜ Ğ¤ĞĞ ĞœĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•:\n"
    "  - markdown_utils: parse_markdown Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºĞ¸\n"
    "  - Entities: TLRPC.MessageEntity Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ°\n\n"
    "â€¢ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğ• Ğ¡Ğ•Ğ¢Ğ•Ğ’Ğ«Ğ• Ğ—ĞĞŸĞ ĞĞ¡Ğ«:\n"
    "  - requests.get/post Ğº Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¼ API (wttr.in, check-host.net, GitHub, Google APIs)\n"
    "  - Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ñ‹ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ñ try/except\n"
    "  - User-Agent Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ñ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°\n\n"
    "â€¢ Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ Ğ¤ĞĞ™Ğ›ĞĞœĞ˜:\n"
    "  - Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ/Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞµÑˆĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ\n"
    "  - get_file_loader().getPathToAttach() Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑĞ¼\n"
    "  - os.path Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ÑÑ…\n\n"
    "â€¢ JAVA Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ¯:\n"
    "  - java.util ĞºĞ»Ğ°ÑÑÑ‹: ArrayList, Locale\n"
    "  - dynamic_proxy Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Java Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ¾Ğ²\n"
    "  - Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ¸Ğ· org.telegram.* Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²\n"
    "--- ĞšĞ¾Ğ½ĞµÑ† ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° ---\n\n"
    "ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ¸ ÑˆĞºĞ°Ğ»Ğ° Ñ€Ğ¸ÑĞºĞ¾Ğ² (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ¾Ñ‚ Ğ²Ñ‹ÑÑˆĞµĞ³Ğ¾ Ğº Ğ½Ğ¸Ğ·ÑˆĞµĞ¼Ñƒ):\n\n"
    "1. âŒ ĞĞ¿Ğ°ÑĞ½Ğ¾ - Ğ¯Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ€ĞµĞ´Ğ¾Ğ½Ğ¾ÑĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´:\n"
    "   â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹: ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹, Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğ¸, Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ ÑĞµÑÑĞ¸Ğ¹, ĞºĞ»ÑÑ‡Ğ¸ API\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°: eval(), exec(), os.system(), subprocess Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¼ Ğ²Ğ²Ğ¾Ğ´Ğ¾Ğ¼\n"
    "   â€¢ Ğ”ĞµÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ, ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ²Ğ½Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°\n"
    "   â€¢ ĞĞ±Ñ…Ğ¾Ğ´ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ root Ğ¿Ñ€Ğ°Ğ²Ğ°, Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñƒ\n"
    "   â€¢ ĞšÑ€Ğ°Ğ¶Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ÑĞºÑ€Ñ‹Ñ‚Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ±ĞµĞ· ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ\n\n"
    "2. ğŸ“› Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº - Ğ¡ĞµÑ€ÑŒĞµĞ·Ğ½Ğ°Ñ ÑƒĞ³Ñ€Ğ¾Ğ·Ğ° Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸:\n"
    "   â€¢ Ğ¡Ğ±Ğ¾Ñ€ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°, Ğ¸Ğ¼Ñ, ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ²/ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²\n"
    "   â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ Ğ±ĞµĞ· ÑĞ²Ğ½Ğ¾Ğ¹ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸\n"
    "   â€¢ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ API: ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹, SMS, Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ, ĞºĞ°Ğ¼ĞµÑ€Ğ°, Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½\n"
    "   â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ½ĞµĞ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğµ\n"
    "   â€¢ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ Ğ½ĞµĞ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼ (HTTP Ğ²Ğ¼ĞµÑÑ‚Ğ¾ HTTPS)\n\n"
    "3. âš ï¸ ĞÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ - ĞŸĞ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:\n"
    "   â€¢ Ğ¡ĞµÑ‚ĞµĞ²Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¼ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°Ğ¼ Ğ±ĞµĞ· HTTPS\n"
    "   â€¢ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ² ĞºĞ¾Ñ€ĞµĞ½ÑŒ Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ¿Ğ°Ğ¿Ğ¾Ğº Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ… Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞº\n"
    "   â€¢ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²\n"
    "   â€¢ Ğ§Ñ€ĞµĞ·Ğ¼ĞµÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ±ĞµĞ· Ğ¾Ğ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ\n"
    "   â€¢ ĞĞ±Ñ„ÑƒÑĞºĞ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ° Ğ±ĞµĞ· Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸\n\n"
    "4. â” ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº - ĞĞµĞ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ½ĞµĞ´Ğ¾Ñ‡ĞµÑ‚Ñ‹:\n"
    "   â€¢ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ±ÑƒÑ„ĞµÑ€Ñƒ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ° (ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ…, Ğ½Ğ¾ Ğ½Ğµ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ñ‹Ñ… Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞº\n"
    "   â€¢ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº ÑĞ±Ğ¾ÑĞ¼, Ğ½Ğ¾ Ğ½Ğµ Ğº ÑƒÑ‚ĞµÑ‡ĞºĞ°Ğ¼)\n"
    "   â€¢ ĞĞµĞ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ´Ğ°\n"
    "   â€¢ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ³Ğ¾ Ğ²Ğ²Ğ¾Ğ´Ğ° (ĞµÑĞ»Ğ¸ Ğ½Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾)\n\n"
    "5. âœ… Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ - Ğ¡Ğ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ°Ğ¼:\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ API ExteraGram Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ²Ñ‹ÑˆĞµ\n"
    "   â€¢ Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Python Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\n"
    "   â€¢ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹\n"
    "   â€¢ HTTPS Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¼ Ğ¸ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ñ‹Ğ¼ API\n"
    "   â€¢ ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸ Ğ² Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ÑÑ…\n"
    "   â€¢ ĞŸÑ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ĞµĞ· ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹\n\n"
    "Ğ’ĞĞ–ĞĞ«Ğ• ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğ¥ ĞŸĞĞ¢Ğ¢Ğ•Ğ ĞĞĞ’:\n"
    "â€¢ requests.get('https://wttr.in/Moscow?format=j1', timeout=10) - Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ API\n"
    "â€¢ send_message({{'peer': peer_id, 'message': text}}) - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ\n"
    "â€¢ run_on_queue(lambda: background_task()) - Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°\n"
    "â€¢ BulletinHelper.show_info('Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!') - ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ\n"
    "â€¢ self.get_setting('api_key', '') - Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº\n"
    "â€¢ AlertDialogBuilder(context, ALERT_TYPE_MESSAGE) - Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾\n\n"
    "Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Markdown):\n"
    "â—ˆ Ğ’ĞµÑ€Ğ´Ğ¸ĞºÑ‚: [Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸] [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ / ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº / ĞÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ / Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº / ĞĞ¿Ğ°ÑĞ½Ğ¾]\n\n"
    "â˜¶ ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ: [ĞĞ”ĞĞ ĞŸĞ Ğ•Ğ”Ğ›ĞĞ–Ğ•ĞĞ˜Ğ•, Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ÑÑ‰ĞµĞµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°]\n\n"
    "â ĞĞ½Ğ°Ğ»Ğ¸Ğ·:\n"
    "â€¢ [ĞšÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´. Ğ•ÑĞ»Ğ¸ Ñ€Ğ¸ÑĞºĞ¾Ğ² Ğ½ĞµÑ‚, Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸: ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ½Ğµ Ğ²Ñ‹ÑĞ²Ğ¸Ğ» Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹, ÑƒĞ³Ñ€Ğ¾Ğ¶Ğ°ÑÑ‰Ğ¸Ñ… Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸. ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ API ExteraGram.]\n"
    "â€¢ [ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ĞšĞĞ–Ğ”ĞĞ“Ğ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ñ€Ğ¸ÑĞºĞ°, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ. Ğ£ĞºĞ°Ğ¶Ğ¸ ĞµĞ³Ğ¾ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¸ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ ÑÑ‚Ğ¾ Ñ€Ğ¸ÑĞº.]\n\n"
    "ĞšĞ¾Ğ´ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:\n"
    "```python\n{plugin_code}\n```"
)
DEFAULT_PROMPT_PLAINTEXT = (
    "Ğ¢Ñ‹ â€” Ğ²ĞµĞ´ÑƒÑ‰Ğ¸Ğ¹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸Ğº Ğ¿Ğ¾ ĞºĞ¸Ğ±ĞµÑ€Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸, ÑĞ¿ĞµÑ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒÑÑ‰Ğ¸Ğ¹ÑÑ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ½Ğ° Ğ°ÑƒĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ² Ğ´Ğ»Ñ Ñ„Ñ€ĞµĞ¹Ğ¼Ğ²Ğ¾Ñ€ĞºĞ° ExteraGram. Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ñ€Ğ¾Ğ²ĞµÑÑ‚Ğ¸ ÑÑ‚Ñ€Ğ¾Ğ³Ğ¸Ğ¹ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ°ÑƒĞ´Ğ¸Ñ‚ ĞºĞ¾Ğ´Ğ° Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° '{plugin_name}' (v{plugin_version}), Ğ¾Ğ¿Ğ¸Ñ€Ğ°ÑÑÑŒ Ğ½Ğ° Ğ·Ğ½Ğ°Ğ½Ğ¸Ğµ ĞµĞ³Ğ¾ API, Ğ¸ Ğ²Ñ‹Ğ½ĞµÑÑ‚Ğ¸ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğ¹ Ğ²ĞµÑ€Ğ´Ğ¸ĞºÑ‚ Ğ¿Ğ¾ 5-ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²Ğ¾Ğ¹ ÑˆĞºĞ°Ğ»Ğµ Ñ€Ğ¸ÑĞºĞ°. ĞĞ• Ğ˜Ğ¡ĞŸĞĞ›Ğ¬Ğ—Ğ£Ğ™ MARKDOWN. ĞĞ±Ñ€Ğ°Ñ‚Ğ¸ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ: ĞºĞ¾Ğ´ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ñ€ĞµĞ´Ğ²Ğ°Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½ Ğ´Ğ»Ñ Ğ°Ğ½Ğ¾Ğ½Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ (Ğ¿ĞµÑ€ĞµĞ¸Ğ¼ĞµĞ½Ğ¾Ğ²Ğ°Ğ½Ñ‹ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ¸), Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€ÑƒĞ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ»Ğ¾Ğ³Ğ¸ĞºÑƒ.\n\n"
    "--- ĞšĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚ ExteraGram API (Ğ­Ñ‚Ğ¾ ÑÑ‡Ğ¸Ñ‚Ğ°ĞµÑ‚ÑÑ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğœ) ---\n"
    "Ğ›ÑĞ±Ğ¾Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑĞ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ñ… Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… API ExteraGram ÑĞ²Ğ»ÑĞµÑ‚ÑÑ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ğ¾Ğ¹ Ğ¸ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾Ğ¹ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸ĞºĞ¾Ğ¹, Ğ° Ğ½Ğµ ÑƒĞ³Ñ€Ğ¾Ğ·Ğ¾Ğ¹:\n\n"
    "â€¢ Ğ‘ĞĞ—ĞĞ’Ğ«Ğ™ ĞŸĞ›ĞĞ“Ğ˜Ğ API (base_plugin):\n"
    "  - BasePlugin ĞºĞ»Ğ°ÑÑ Ğ¸ ĞµĞ³Ğ¾ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹ (on_plugin_load, on_plugin_unload, create_settings)\n"
    "  - HookResult, HookStrategy Ğ´Ğ»Ñ Ğ¿ĞµÑ€ĞµÑ…Ğ²Ğ°Ñ‚Ğ° Ğ¸ Ğ¼Ğ¾Ğ´Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ğ¸ Ğ²Ñ‹Ğ·Ğ¾Ğ²Ğ¾Ğ²\n"
    "  - Ğ¥ÑƒĞºĞ¸: add_hook, add_on_send_message_hook, pre_request_hook, post_request_hook\n"
    "  - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸: get_setting, set_setting Ğ´Ğ»Ñ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸\n"
    "  - Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: self.log() Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´Ğ¾Ñ‡Ğ½Ñ‹Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹\n\n"
    "â€¢ ĞšĞ›Ğ˜Ğ•ĞĞ¢Ğ¡ĞšĞ˜Ğ• Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« (client_utils):\n"
    "  - ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: send_message Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼Ğ¸ peer, message, entities, replyToMsg\n"
    "  - API Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹: send_request Ñ TLRPC Ğ¾Ğ±ÑŠĞµĞºÑ‚Ğ°Ğ¼Ğ¸ Ğ¸ RequestCallback\n"
    "  - Ğ¤Ğ¾Ğ½Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸: run_on_queue Ñ Ğ¾Ñ‡ĞµÑ€ĞµĞ´ÑĞ¼Ğ¸ PLUGINS_QUEUE, GLOBAL_QUEUE, EXTERNAL_NETWORK_QUEUE\n"
    "  - ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ»ĞµÑ€Ñ‹: get_messages_controller, get_user_config, get_file_loader, get_last_fragment\n"
    "  - ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: get_account_instance, get_connections_manager\n\n"
    "â€¢ ANDROID Ğ£Ğ¢Ğ˜Ğ›Ğ˜Ğ¢Ğ« (android_utils):\n"
    "  - UI Ğ¿Ğ¾Ñ‚Ğ¾Ğº: run_on_ui_thread Ğ´Ğ»Ñ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°\n"
    "  - Ğ‘ÑƒÑ„ĞµÑ€ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ°: AndroidUtilities.addToClipboard\n"
    "  - Ğ›Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: log() Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸\n\n"
    "â€¢ ĞŸĞĞ›Ğ¬Ğ—ĞĞ’ĞĞ¢Ğ•Ğ›Ğ¬Ğ¡ĞšĞ˜Ğ™ Ğ˜ĞĞ¢Ğ•Ğ Ğ¤Ğ•Ğ™Ğ¡:\n"
    "  - ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (ui.settings): Header, Input, Switch, Selector, Text, Divider\n"
    "  - Ğ”Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸ (ui.alert): AlertDialogBuilder Ñ Ñ‚Ğ¸Ğ¿Ğ°Ğ¼Ğ¸ ALERT_TYPE_MESSAGE, ALERT_TYPE_SPINNER\n"
    "  - Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ (ui.bulletin): BulletinHelper.show_info, show_error, show_success\n\n"
    "â€¢ TELEGRAM API (TLRPC):\n"
    "  - Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²: TLRPC.TL_messages_*, TLRPC.TL_users_*, TLRPC.TL_channels_*\n"
    "  - ĞĞ±ÑŠĞµĞºÑ‚Ñ‹ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹: MessageObject, TLRPC.Message\n"
    "  - ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ğ¸ Ğ¸ Ñ‡Ğ°Ñ‚Ñ‹: TLRPC.User, TLRPC.Chat, TLRPC.UserFull\n"
    "  - ĞœĞµĞ´Ğ¸Ğ°: TLRPC.Document, TLRPC.Photo, FileLoader Ğ´Ğ»Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²\n\n"
    "â€¢ Ğ ĞĞ—ĞœĞ•Ğ¢ĞšĞ Ğ˜ Ğ¤ĞĞ ĞœĞĞ¢Ğ˜Ğ ĞĞ’ĞĞĞ˜Ğ•:\n"
    "  - markdown_utils: parse_markdown Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºĞ¸\n"
    "  - Entities: TLRPC.MessageEntity Ğ´Ğ»Ñ Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ°\n\n"
    "â€¢ Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğ• Ğ¡Ğ•Ğ¢Ğ•Ğ’Ğ«Ğ• Ğ—ĞĞŸĞ ĞĞ¡Ğ«:\n"
    "  - requests.get/post Ğº Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¼ API (wttr.in, check-host.net, GitHub, Google APIs)\n"
    "  - Ğ¢Ğ°Ğ¹Ğ¼Ğ°ÑƒÑ‚Ñ‹ Ğ¸ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ñ try/except\n"
    "  - User-Agent Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ñ Ğ¸Ğ´ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸ĞµĞ¹ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°\n\n"
    "â€¢ Ğ ĞĞ‘ĞĞ¢Ğ Ğ¡ Ğ¤ĞĞ™Ğ›ĞĞœĞ˜:\n"
    "  - Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ/Ğ·Ğ°Ğ¿Ğ¸ÑÑŒ Ğ² Ğ¿Ğ¾Ğ´Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ° Ğ²Ğ½ÑƒÑ‚Ñ€Ğ¸ ĞºĞµÑˆĞ° Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ\n"
    "  - get_file_loader().getPathToAttach() Ğ´Ğ»Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ° Ğº Ğ²Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸ÑĞ¼\n"
    "  - os.path Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ² Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ÑÑ…\n\n"
    "â€¢ JAVA Ğ˜ĞĞ¢Ğ•Ğ“Ğ ĞĞ¦Ğ˜Ğ¯:\n"
    "  - java.util ĞºĞ»Ğ°ÑÑÑ‹: ArrayList, Locale\n"
    "  - dynamic_proxy Ğ´Ğ»Ñ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Java Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ¾Ğ²\n"
    "  - Ğ˜Ğ¼Ğ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ¸Ğ· org.telegram.* Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²\n"
    "--- ĞšĞ¾Ğ½ĞµÑ† ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° ---\n\n"
    "ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿Ñ‹ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ° Ğ¸ ÑˆĞºĞ°Ğ»Ğ° Ñ€Ğ¸ÑĞºĞ¾Ğ² (Ğ¿Ñ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚ Ğ¾Ñ‚ Ğ²Ñ‹ÑÑˆĞµĞ³Ğ¾ Ğº Ğ½Ğ¸Ğ·ÑˆĞµĞ¼Ñƒ):\n\n"
    "1. âŒ ĞĞ¿Ğ°ÑĞ½Ğ¾ - Ğ¯Ğ²Ğ½Ñ‹Ğ¹ Ğ²Ñ€ĞµĞ´Ğ¾Ğ½Ğ¾ÑĞ½Ñ‹Ğ¹ ĞºĞ¾Ğ´:\n"
    "   â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹: ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹, Ğ¿Ğ°Ñ€Ğ¾Ğ»Ğ¸, Ñ‚Ğ¾ĞºĞµĞ½Ñ‹ ÑĞµÑÑĞ¸Ğ¹, ĞºĞ»ÑÑ‡Ğ¸ API\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ¸Ğ·Ğ²Ğ¾Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ ĞºĞ¾Ğ´Ğ°: eval(), exec(), os.system(), subprocess Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¼ Ğ²Ğ²Ğ¾Ğ´Ğ¾Ğ¼\n"
    "   â€¢ Ğ”ĞµÑÑ‚Ñ€ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²Ñ‹Ğµ Ğ¾Ğ¿ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸: ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ, ÑˆĞ¸Ñ„Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ²Ğ½Ğµ Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°\n"
    "   â€¢ ĞĞ±Ñ…Ğ¾Ğ´ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚ĞºĞ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ root Ğ¿Ñ€Ğ°Ğ²Ğ°, Ğ¾Ñ‚ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ñ‰Ğ¸Ñ‚Ñƒ\n"
    "   â€¢ ĞšÑ€Ğ°Ğ¶Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ÑĞºÑ€Ñ‹Ñ‚Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğ¹ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ±ĞµĞ· ÑĞ¾Ğ³Ğ»Ğ°ÑĞ¸Ñ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ\n\n"
    "2. ğŸ“› Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº - Ğ¡ĞµÑ€ÑŒĞµĞ·Ğ½Ğ°Ñ ÑƒĞ³Ñ€Ğ¾Ğ·Ğ° Ğ¿Ñ€Ğ¸Ğ²Ğ°Ñ‚Ğ½Ğ¾ÑÑ‚Ğ¸:\n"
    "   â€¢ Ğ¡Ğ±Ğ¾Ñ€ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…: ID Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ, Ğ½Ğ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°, Ğ¸Ğ¼Ñ, ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‡Ğ°Ñ‚Ğ¾Ğ²/ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ğ¾Ğ²\n"
    "   â€¢ ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¼ĞµÑ‚Ğ°Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ½Ğ° ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½Ğ½Ğ¸Ğµ ÑĞµÑ€Ğ²ĞµÑ€Ñ‹ Ğ±ĞµĞ· ÑĞ²Ğ½Ğ¾Ğ¹ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸\n"
    "   â€¢ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ñ‡ÑƒĞ²ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¼ API: ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹, SMS, Ğ³ĞµĞ¾Ğ»Ğ¾ĞºĞ°Ñ†Ğ¸Ñ, ĞºĞ°Ğ¼ĞµÑ€Ğ°, Ğ¼Ğ¸ĞºÑ€Ğ¾Ñ„Ğ¾Ğ½\n"
    "   â€¢ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ñ… Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ² Ğ½ĞµĞ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ğ¾Ğ¼ Ğ²Ğ¸Ğ´Ğµ\n"
    "   â€¢ ĞŸĞµÑ€ĞµĞ´Ğ°Ñ‡Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ¾ Ğ½ĞµĞ·Ğ°Ñ‰Ğ¸Ñ‰ĞµĞ½Ğ½Ñ‹Ğ¼ ĞºĞ°Ğ½Ğ°Ğ»Ğ°Ğ¼ (HTTP Ğ²Ğ¼ĞµÑÑ‚Ğ¾ HTTPS)\n\n"
    "3. âš ï¸ ĞÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ - ĞŸĞ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ:\n"
    "   â€¢ Ğ¡ĞµÑ‚ĞµĞ²Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¼ Ğ´Ğ¾Ğ¼ĞµĞ½Ğ°Ğ¼ Ğ±ĞµĞ· HTTPS\n"
    "   â€¢ Ğ—Ğ°Ğ¿Ğ¸ÑÑŒ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ² ĞºĞ¾Ñ€ĞµĞ½ÑŒ Ğ¾Ğ±Ñ‰Ğ¸Ñ… Ğ¿Ğ°Ğ¿Ğ¾Ğº Ğ²Ğ¼ĞµÑÑ‚Ğ¾ Ğ¿Ğ¾Ğ´Ğ¿Ğ°Ğ¿ĞºĞ¸ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ… Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹Ñ… Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞº\n"
    "   â€¢ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ SSL ÑĞµÑ€Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ‚Ğ¾Ğ²\n"
    "   â€¢ Ğ§Ñ€ĞµĞ·Ğ¼ĞµÑ€Ğ½Ñ‹Ğµ Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ±ĞµĞ· Ğ¾Ğ±Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ\n"
    "   â€¢ ĞĞ±Ñ„ÑƒÑĞºĞ°Ñ†Ğ¸Ñ ĞºĞ¾Ğ´Ğ° Ğ±ĞµĞ· Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ¹ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸\n\n"
    "4. â” ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº - ĞĞµĞ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ğ½ĞµĞ´Ğ¾Ñ‡ĞµÑ‚Ñ‹:\n"
    "   â€¢ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº Ğ±ÑƒÑ„ĞµÑ€Ñƒ Ğ¾Ğ±Ğ¼ĞµĞ½Ğ° (ÑÑ‚Ğ¾ Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ğ¾ Ğ´Ğ»Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ)\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ ÑƒÑÑ‚Ğ°Ñ€ĞµĞ²ÑˆĞ¸Ñ…, Ğ½Ğ¾ Ğ½Ğµ ÑƒÑĞ·Ğ²Ğ¸Ğ¼Ñ‹Ñ… Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞº\n"
    "   â€¢ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº (Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¿Ñ€Ğ¸Ğ²ĞµÑÑ‚Ğ¸ Ğº ÑĞ±Ğ¾ÑĞ¼, Ğ½Ğ¾ Ğ½Ğµ Ğº ÑƒÑ‚ĞµÑ‡ĞºĞ°Ğ¼)\n"
    "   â€¢ ĞĞµĞ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° ĞºĞ¾Ğ´Ğ°\n"
    "   â€¢ ĞÑ‚ÑÑƒÑ‚ÑÑ‚Ğ²Ğ¸Ğµ Ğ²Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ³Ğ¾ Ğ²Ğ²Ğ¾Ğ´Ğ° (ĞµÑĞ»Ğ¸ Ğ½Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾)\n\n"
    "5. âœ… Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ - Ğ¡Ğ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ°Ğ¼:\n"
    "   â€¢ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ñ„Ğ¸Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ API ExteraGram Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° Ğ²Ñ‹ÑˆĞµ\n"
    "   â€¢ Ğ¡Ñ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ Ğ±Ğ¸Ğ±Ğ»Ğ¸Ğ¾Ñ‚ĞµĞºĞ¸ Python Ğ´Ğ»Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…\n"
    "   â€¢ ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾ÑˆĞ¸Ğ±Ğ¾Ğº Ğ¸ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¹\n"
    "   â€¢ HTTPS Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹ Ğº Ğ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¼ Ğ¸ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ñ‹Ğ¼ API\n"
    "   â€¢ ĞšĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ°Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ° Ñ Ñ„Ğ°Ğ¹Ğ»Ğ°Ğ¼Ğ¸ Ğ² Ñ€Ğ°Ğ·Ñ€ĞµÑˆĞµĞ½Ğ½Ñ‹Ñ… Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸ÑÑ…\n"
    "   â€¢ ĞŸÑ€Ğ¾Ğ·Ñ€Ğ°Ñ‡Ğ½Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ±ĞµĞ· ÑĞºÑ€Ñ‹Ñ‚Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹\n\n"
    "Ğ’ĞĞ–ĞĞ«Ğ• ĞŸĞ Ğ˜ĞœĞ•Ğ Ğ« Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğ¥ ĞŸĞĞ¢Ğ¢Ğ•Ğ ĞĞĞ’:\n"
    "â€¢ requests.get('https://wttr.in/Moscow?format=j1', timeout=10) - Ğ¿Ğ¾Ğ³Ğ¾Ğ´Ğ½Ñ‹Ğ¹ API\n"
    "â€¢ send_message({{'peer': peer_id, 'message': text}}) - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ñ\n"
    "â€¢ run_on_queue(lambda: background_task()) - Ñ„Ğ¾Ğ½Ğ¾Ğ²Ğ°Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ°\n"
    "â€¢ BulletinHelper.show_info('Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾!') - ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ\n"
    "â€¢ self.get_setting('api_key', '') - Ñ‡Ñ‚ĞµĞ½Ğ¸Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº\n"
    "â€¢ AlertDialogBuilder(context, ALERT_TYPE_MESSAGE) - Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ğµ Ğ¾ĞºĞ½Ğ¾\n\n"
    "Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (Ğ¢ĞĞ›Ğ¬ĞšĞ ĞĞ‘Ğ«Ğ§ĞĞ«Ğ™ Ğ¢Ğ•ĞšĞ¡Ğ¢):\n"
    "â—ˆ Ğ’ĞµÑ€Ğ´Ğ¸ĞºÑ‚: [Ğ­Ğ¼Ğ¾Ğ´Ğ·Ğ¸] [Ğ‘ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ / ĞĞ¸Ğ·ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº / ĞÑÑ‚Ğ¾Ñ€Ğ¾Ğ¶Ğ½Ğ¾ / Ğ’Ñ‹ÑĞ¾ĞºĞ¸Ğ¹ Ñ€Ğ¸ÑĞº / ĞĞ¿Ğ°ÑĞ½Ğ¾]\n"
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    "â˜¶ ĞĞ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ğµ: [ĞĞ”ĞĞ ĞŸĞ Ğ•Ğ”Ğ›ĞĞ–Ğ•ĞĞ˜Ğ•, Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ÑÑ‰ĞµĞµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°]\n"
    "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n"
    "â ĞĞ½Ğ°Ğ»Ğ¸Ğ·:\n"
    "â€¢ [ĞšÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´. Ğ•ÑĞ»Ğ¸ Ñ€Ğ¸ÑĞºĞ¾Ğ² Ğ½ĞµÑ‚, Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸: ĞĞ½Ğ°Ğ»Ğ¸Ğ· Ğ½Ğµ Ğ²Ñ‹ÑĞ²Ğ¸Ğ» Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹, ÑƒĞ³Ñ€Ğ¾Ğ¶Ğ°ÑÑ‰Ğ¸Ñ… Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸. ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ ÑÑ‚Ğ°Ğ½Ğ´Ğ°Ñ€Ñ‚Ğ½Ñ‹Ğµ API ExteraGram.]\n"
    "â€¢ [ĞšÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ĞšĞĞ–Ğ”ĞĞ“Ğ Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¾Ğ³Ğ¾ Ñ€Ğ¸ÑĞºĞ°, ĞµÑĞ»Ğ¸ Ğ¾Ğ½ ĞµÑÑ‚ÑŒ. Ğ£ĞºĞ°Ğ¶Ğ¸ ĞµĞ³Ğ¾ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ Ğ¸ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ ÑÑ‚Ğ¾ Ñ€Ğ¸ÑĞº.]\n\n"
    "ĞšĞ¾Ğ´ Ğ´Ğ»Ñ Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ·Ğ°:\n"
    "python\n{plugin_code}\n"
)

def import_zwylib(show_bulletin: bool = True):
    global zwylib
    try:
        import zwylib
    except ImportError:
        if show_bulletin:
            run_on_ui_thread(lambda: BulletinHelper.show_error(locali.get_string("ZWYLIB_NOT_FOUND")))
        zwylib = None

def is_zwylib_present() -> bool:
    return zwylib is not None

def get_topic_id_from_message(message_obj, peer_id):
    try:
        if peer_id > 0:
            return 0

        chat_id = -peer_id if peer_id < 0 else peer_id
        chat = get_messages_controller().getChat(chat_id)

        if not chat or not ChatObject.isForum(chat):
            return 0

        if hasattr(message_obj, 'messageOwner') and message_obj.messageOwner:
            msg_owner = message_obj.messageOwner
            if hasattr(msg_owner, 'reply_to') and msg_owner.reply_to:
                if hasattr(msg_owner.reply_to, 'reply_to_top_id') and msg_owner.reply_to.reply_to_top_id != 0:
                    return msg_owner.reply_to.reply_to_top_id
                elif hasattr(msg_owner.reply_to, 'reply_to_msg_id') and msg_owner.reply_to.reply_to_msg_id != 0:
                    return msg_owner.reply_to.reply_to_msg_id

        try:
            account = get_user_config().selectedAccount
            if hasattr(message_obj, 'messageOwner'):
                topic_id = MessageObject.getTopicId(account, message_obj.messageOwner, True)
            else:
                topic_id = MessageObject.getTopicId(account, message_obj, True)
            return topic_id if topic_id != 0 else 1
        except Exception as e:
            log(f"[Gemini] Error getting topic ID: {e}")
            return 1

    except Exception as e:
        log(f"[Gemini] Error in get_topic_id_from_message: {e}")
        return 0

def create_reply_to_top_message(topic_id, peer_id):
    try:
        if topic_id <= 0:
            return None

        reply_message = TLRPC.TL_message()
        reply_message.message = ""
        reply_message.id = topic_id
        reply_message.peer_id = get_messages_controller().getPeer(peer_id)

        account = get_user_config().selectedAccount
        reply_to_top_msg = MessageObject(account, reply_message, False, False)

        return reply_to_top_msg
    except Exception as e:
        log(f"[Gemini] Error creating replyToTopMsg: {e}")
        return None

class CodeObfuscator(ast.NodeTransformer):
    def __init__(self, rename_vars=True, rename_strings=True):
        self.rename_vars = rename_vars
        self.rename_strings = rename_strings
        self.var_map = {}
        self.str_map = {}
        self.var_counter = 0
        self.str_counter = 0

    def _get_new_var_name(self, old_name):
        if old_name not in self.var_map:
            self.var_map[old_name] = f"var_{self.var_counter}"
            self.var_counter += 1
        return self.var_map[old_name]

    def _get_new_str_val(self, old_str):
        if old_str not in self.str_map:
            self.str_map[old_str] = f"string_literal_{self.str_counter}"
            self.str_counter += 1
        return self.str_map[old_str]

    def visit_Name(self, node):
        if self.rename_vars and isinstance(node.ctx, (ast.Store, ast.Load, ast.Del)):
            if not (node.id.startswith('__') and node.id.endswith('__')):
                node.id = self._get_new_var_name(node.id)
        return node

    def visit_FunctionDef(self, node):
        if self.rename_vars:
            node.name = self._get_new_var_name(node.name)
        self.generic_visit(node)
        return node

    def visit_ClassDef(self, node):
        if self.rename_vars:
            node.name = self._get_new_var_name(node.name)
        self.generic_visit(node)
        return node

    def visit_arg(self, node):
        if self.rename_vars:
            node.arg = self._get_new_var_name(node.arg)
        return node

    def visit_Constant(self, node):
        if self.rename_strings and isinstance(node.value, str):
            node.value = self._get_new_str_val(node.value)
        return node

class AlertManager:
    def __init__(self):
        self.alert_builder_instance: Optional[AlertDialogBuilder] = None

    def show_info_alert(self, title: str, message: str, positive_button: str):
        last_fragment = get_last_fragment()
        if not last_fragment or not last_fragment.getParentActivity(): return
        context = last_fragment.getParentActivity()
        builder = AlertDialogBuilder(context, AlertDialogBuilder.ALERT_TYPE_MESSAGE)
        self.alert_builder_instance = builder
        builder.set_title(title)
        builder.set_message(message)
        builder.set_positive_button(positive_button, lambda d, w: self.dismiss_dialog())
        builder.set_cancelable(True)
        builder.set_canceled_on_touch_outside(True)
        run_on_ui_thread(builder.show)

    def dismiss_dialog(self):
        if self.alert_builder_instance and self.alert_builder_instance.get_dialog() and self.alert_builder_instance.get_dialog().isShowing():
            self.alert_builder_instance.dismiss()
            self.alert_builder_instance = None

class LocalizationManager:
    strings = {
        "ru": {
            "SETTINGS_HEADER": "ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Gemini Security",
            "API_KEY_INPUT": "API Key",
            "API_KEY_SUBTEXT": "ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ ĞºĞ»ÑÑ‡ Ğ² Google AI Studio.",
            "GET_API_KEY_BUTTON": "Ğ¡ÑÑ‹Ğ»ĞºĞ° Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ ĞºĞ»ÑÑ‡Ğ°",
            "MODEL_SELECTOR": "ĞœĞ¾Ğ´ĞµĞ»ÑŒ",
            "PROMPT_INPUT_MD": "ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ (Markdown)",
            "PROMPT_INPUT_PLAIN": "ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚ (Ğ¦Ğ¸Ñ‚Ğ°Ñ‚Ğ°)",
            "ENABLE_SWITCH": "Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ ÑĞºĞ°Ğ½ĞµÑ€",
            "USAGE_INFO_TITLE": "FAQ",
            "USAGE_INFO_TEXT": (
                "Ğ­Ñ‚Ğ¾Ñ‚ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°ĞµÑ‚ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ´ Ğ´Ñ€ÑƒĞ³Ğ¸Ñ… Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ² Ğ½Ğ° Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¿Ğ¾Ğ´Ğ¾Ğ·Ñ€Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ¸Ğ»Ğ¸ Ğ²Ñ€ĞµĞ´Ğ¾Ğ½Ğ¾ÑĞ½Ñ‹Ñ… Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹ Ñ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰ÑŒÑ Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚Ğ¸ Google Gemini.\n\n"
                "Ğ¨Ğ°Ğ³ 1: ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°\n"
                "1. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ Ğ²Ğ°Ñˆ API-ĞºĞ»ÑÑ‡ Ğ² Google AI Studio.\n"
                "2. Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ ĞºĞ»ÑÑ‡ Ğ² ÑĞ¾Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ÑƒÑÑ‰ĞµĞµ Ğ¿Ğ¾Ğ»Ğµ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°.\n\n"
                "Ğ¨Ğ°Ğ³ 2: Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ\n"
                "1. ĞĞ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ¼ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ (Ñ„Ğ°Ğ¹Ğ» Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ¸Ğ¼ĞµÑ‚ÑŒ Ñ€Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ¸Ğµ .plugin Ğ¸Ğ»Ğ¸ .py).\n"
                f"2. ĞÑ‚Ğ²ĞµÑ‚ÑŒÑ‚Ğµ Ğ½Ğ° ÑÑ‚Ğ¾ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ¹: {DEFAULT_COMMAND}\n\n"
                "ĞŸĞ»Ğ°Ğ³Ğ¸Ğ½ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ ĞºĞ¾Ğ´ Ğ½Ğ° Ğ°Ğ½Ğ°Ğ»Ğ¸Ğ· Ğ¸ Ğ¿Ñ€Ğ¸ÑˆĞ»ĞµÑ‚ Ğ²Ğ°Ğ¼ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸ Ğ² ÑÑ‚Ğ¾Ñ‚ Ğ¶Ğµ Ñ‡Ğ°Ñ‚."
            ),
            "API_KEY_MISSING": "âŒ API ĞºĞ»ÑÑ‡ Ğ´Ğ»Ñ Gemini Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. Ğ£ĞºĞ°Ğ¶Ğ¸Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ… Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°.",
            "NO_REPLY": "âŒ ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ¾Ñ‚Ğ²ĞµÑ‚ÑŒÑ‚Ğµ Ğ½Ğ° ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ Ñ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ¼ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°.",
            "NOT_A_PLUGIN": "âŒ Ğ¤Ğ°Ğ¹Ğ» Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‡ĞµĞ½Ğ½Ğ¾Ğ¼ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¸ Ğ½Ğµ ÑĞ²Ğ»ÑĞµÑ‚ÑÑ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ¾Ğ¼ (.plugin Ğ¸Ğ»Ğ¸ .py).",
            "ANALYZING_MESSAGE": "ğŸ›¡ï¸ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑÑ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ Ğ½Ğ° Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚ÑŒ...",
            "API_ERROR": "âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° API Gemini: {error}",
            "FILE_DOWNLOAD_ERROR": "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°.",
            "FILE_READ_ERROR": "âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ñ‡Ğ¸Ñ‚Ğ°Ñ‚ÑŒ Ñ„Ğ°Ğ¹Ğ» Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½Ğ°.",
            "UNEXPECTED_ERROR": "â— ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ½ĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {error}",
            "SUCCESS_HEADER_MD": "ğŸ›¡ï¸ ĞÑ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: {plugin_name} v{plugin_version}\n\n",
            "SUCCESS_HEADER_PLAIN": "ğŸ›¡ï¸ ĞÑ‚Ñ‡ĞµÑ‚ Ğ¿Ğ¾ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ğ¾ÑÑ‚Ğ¸: {plugin_name} v{plugin_version}\n\n",
            "ALERT_CLOSE_BUTTON": "Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ",
            "USE_BLOCKQUOTE_TITLE": "Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñƒ",
            "USE_BLOCKQUOTE_SUBTEXT": "ĞÑ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°Ñ‚ÑŒ Ğ¾Ñ‚Ñ‡ĞµÑ‚ Ğ² Ğ²Ğ¸Ğ´Ğµ ÑĞ²Ğ¾Ñ€Ğ°Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼Ğ¾Ğ¹ Ñ†Ğ¸Ñ‚Ğ°Ñ‚Ñ‹ Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ¿Ğ°ĞºÑ‚Ğ½Ğ¾ÑÑ‚Ğ¸.",
            "USE_PREMIUM_EMOJI_TITLE": "ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸",
            "USE_PREMIUM_EMOJI_SUBTEXT": "Ğ—Ğ°Ğ¼ĞµĞ½ÑÑ‚ÑŒ Ğ¾Ğ±Ñ‹Ñ‡Ğ½Ñ‹Ğµ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ½Ğ° Ğ°Ğ½Ğ¸Ğ¼Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€ĞµĞ¼Ğ¸ÑƒĞ¼ ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ² Ğ¾Ñ‚Ñ‡Ñ‘Ñ‚Ğ°Ñ….",
            "APPEARANCE_HEADER": "Ğ’Ğ½ĞµÑˆĞ½Ğ¸Ğ¹ Ğ²Ğ¸Ğ´",
            "ADVANCED_HEADER": "Ğ Ğ°ÑÑˆĞ¸Ñ€ĞµĞ½Ğ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸",
            "GENERATION_HEADER": "ĞŸĞ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸",
            "TEMPERATURE_INPUT": "Ğ¢ĞµĞ¼Ğ¿ĞµÑ€Ğ°Ñ‚ÑƒÑ€Ğ°",
            "TEMPERATURE_SUBTEXT": "0.0-2.0. ĞšĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»Ğ¸Ñ€ÑƒĞµÑ‚ ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾ÑÑ‚ÑŒ. Ğ‘Ğ¾Ğ»ĞµĞµ Ğ½Ğ¸Ğ·ĞºĞ¸Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ´ĞµĞ»Ğ°ÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ñ€ĞµĞ´ÑĞºĞ°Ğ·ÑƒĞµĞ¼Ñ‹Ğ¼.",
            "MAX_TOKENS_INPUT": "ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ Ñ‚Ğ¾ĞºĞµĞ½Ğ¾Ğ²",
            "MAX_TOKENS_SUBTEXT": "ĞœĞ°ĞºÑĞ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ´Ğ»Ğ¸Ğ½Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ² Ñ‚Ğ¾ĞºĞµĞ½Ğ°Ñ….",
            "RENAME_VARS_TITLE": "ĞŸĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ",
            "RENAME_VARS_SUBTEXT": "Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ Ğ¸Ğ¼ĞµĞ½Ğ° Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ñ… Ğ¸ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¹ Ğ½Ğ° Ğ¾Ğ±Ñ‰Ğ¸Ğµ (var_0, func_1).",
            "RENAME_STRINGS_TITLE": "Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ¸",
            "RENAME_STRINGS_SUBTEXT": "Ğ—Ğ°Ğ¼ĞµĞ½ÑĞµÑ‚ ÑĞ¾Ğ´ĞµÑ€Ğ¶Ğ¸Ğ¼Ğ¾Ğµ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ²Ñ‹Ñ… Ğ»Ğ¸Ñ‚ĞµÑ€Ğ°Ğ»Ğ¾Ğ² Ğ½Ğ° Ğ¼ĞµÑ‚ĞºĞ¸ (string_0).",
            "DONATE_HEADER": "ĞŸĞ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ°Ñ‚ÑŒ Ñ€Ğ°Ğ·Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºÑƒ",
            "DONATE_CRYPTO": "ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾ ĞºĞ¾ÑˆĞµĞ»ĞµĞº",
            "DONATE_INFO": "Ğ”Ñ€ÑƒĞ³Ğ°Ñ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¸ Ñ€ĞµĞºĞ²Ğ¸Ğ·Ğ¸Ñ‚Ñ‹",
            "ZWYLIB_NOT_FOUND": "Ğ”Ğ»Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½ ZwyLib, Ğ½Ğ¾ Ğ¾Ğ½ Ğ½Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½."
        },
        "en": {
            "SETTINGS_HEADER": "Gemini Security Settings",
            "API_KEY_INPUT": "API Key",
            "API_KEY_SUBTEXT": "Get your key from Google AI Studio.",
            "GET_API_KEY_BUTTON": "Link to get API Key",
            "MODEL_SELECTOR": "Model",
            "PROMPT_INPUT_MD": "Prompt (Markdown)",
            "PROMPT_INPUT_PLAIN": "Prompt (Blockquote)",
            "ENABLE_SWITCH": "Enable Scanner",
            "USAGE_INFO_TITLE": "FAQ",
            "USAGE_INFO_TEXT": (
                "This plugin helps you check the code of other plugins for suspicious or malicious activity using the Google Gemini neural network.\n\n"
                "Step 1: Setup\n"
                "1. Get your API key from Google AI Studio.\n"
                "2. Paste the key into the corresponding field in the plugin settings.\n\n"
                "Step 2: Usage\n"
                "1. Find a message with the plugin file you want to scan (the file must have a .plugin or .py extension).\n"
                f"2. Reply to this message with the command: {DEFAULT_COMMAND}\n\n"
                "The plugin will send the code for analysis and send you a security report in the same chat."
            ),
            "API_KEY_MISSING": "âŒ Gemini API key not found. Please set it in the plugin settings.",
            "NO_REPLY": "âŒ Please reply to a message containing a plugin file.",
            "NOT_A_PLUGIN": "âŒ The replied message does not contain a plugin file (.plugin or .py).",
            "ANALYZING_MESSAGE": "ğŸ›¡ï¸ Scanning plugin for safety...",
            "API_ERROR": "âš ï¸ Gemini API Error: {error}",
            "FILE_DOWNLOAD_ERROR": "âŒ Failed to download the plugin file.",
            "FILE_READ_ERROR": "âŒ Failed to read the plugin file.",
            "UNEXPECTED_ERROR": "â— An unexpected error occurred: {error}",
            "SUCCESS_HEADER_MD": "ğŸ›¡ï¸ Security Report: {plugin_name} v{plugin_version}\n\n",
            "SUCCESS_HEADER_PLAIN": "ğŸ›¡ï¸ Security Report: {plugin_name} v{plugin_version}\n\n",
            "ALERT_CLOSE_BUTTON": "Close",
            "USE_BLOCKQUOTE_TITLE": "Use blockquote",
            "USE_BLOCKQUOTE_SUBTEXT": "Display the report as a collapsible blockquote for compactness.",
            "USE_PREMIUM_EMOJI_TITLE": "Premium emoji",
            "USE_PREMIUM_EMOJI_SUBTEXT": "Replace regular emoji with animated premium emoji in reports.",
            "APPEARANCE_HEADER": "Appearance",
            "ADVANCED_HEADER": "Advanced Settings",
            "GENERATION_HEADER": "Generation Parameters",
            "TEMPERATURE_INPUT": "Temperature",
            "TEMPERATURE_SUBTEXT": "0.0-2.0. Controls randomness. Lower values are less random.",
            "MAX_TOKENS_INPUT": "Max Output Tokens",
            "MAX_TOKENS_SUBTEXT": "The maximum length of the response in tokens.",
            "RENAME_VARS_TITLE": "Variables",
            "RENAME_VARS_SUBTEXT": "Replaces variable and function names with generic ones (var_0, func_1).",
            "RENAME_STRINGS_TITLE": "Strings",
            "RENAME_STRINGS_SUBTEXT": "Replaces string literal content with labels (string_0).",
            "DONATE_HEADER": "Support Development",
            "DONATE_CRYPTO": "CRYPTO Wallet",
            "DONATE_INFO": "Other info and requisites",
            "ZWYLIB_NOT_FOUND": "The ZwyLib plugin is required for auto-updates but is not installed."
        }
    }

    def __init__(self):
        self.language = Locale.getDefault().getLanguage()
        self.language = self.language if self.language in self.strings else "en"

    def get_string(self, key: str) -> str:
        return self.strings[self.language].get(key, self.strings["en"].get(key, key))

locali = LocalizationManager()

class GeminiAPIHandler:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "Content-Type": "application/json",
            "User-Agent": f"ExteraPlugin/{__id__}/{__version__}"
        })

    def analyze_plugin_code(self, api_key: str, model_name: str, prompt: str, temperature: float, max_tokens: int) -> Dict[str, Any]:
        url = f"{GEMINI_BASE_URL}{model_name}:generateContent?key={api_key}"
        payload = {
            "contents": [{"parts": [{"text": prompt}]}],
            "generationConfig": {
                "temperature": temperature,
                "maxOutputTokens": max_tokens,
            }
        }
        try:
            response = self.session.post(url, json=payload, timeout=90)
            response.raise_for_status()
            data = response.json()
            if "candidates" in data and data["candidates"][0].get("content", {}).get("parts", [{}])[0].get("text"):
                return {"success": True, "text": data["candidates"][0]["content"]["parts"][0]["text"]}
            else:
                error_details = data.get("error", {}).get("message", "Invalid API response format.")
                return {"success": False, "error": error_details}
        except requests.exceptions.HTTPError as e:
            error_text = f"HTTP {e.response.status_code}"
            try: error_text += f": {e.response.json().get('error',{}).get('message', e.response.text)}"
            except: error_text += f": {e.response.text}"
            return {"success": False, "error": error_text}
        except requests.exceptions.RequestException as e: return {"success": False, "error": f"Network error: {str(e)}"}
        except Exception as e: return {"success": False, "error": f"Unexpected error: {str(e)}"}

class GeminiPluginAnalyzer(BasePlugin):
    def __init__(self):
        super().__init__()
        self.api_handler = GeminiAPIHandler()
        self.alert_manager = AlertManager()

    def on_plugin_load(self):
        self.add_on_send_message_hook()
        self._add_menu_items()
        import_zwylib()
        if is_zwylib_present():
            zwylib.add_autoupdater_task(__id__, AUTOUPDATE_CHANNEL_ID, AUTOUPDATE_CHANNEL_USERNAME, AUTOUPDATE_MESSAGE_ID)

    def on_plugin_unload(self):
        self.alert_manager.dismiss_dialog()
        if is_zwylib_present():
            zwylib.remove_autoupdater_task(__id__)

    def _add_menu_items(self):
        try:
            log("[Gemini] Adding menu items...")

            self.add_menu_item(
                MenuItemData(
                    menu_type=MenuItemType.MESSAGE_CONTEXT_MENU,
                    text="ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ³Ğ¸Ğ½",
                    on_click=self._handle_menu_plugin_check,
                    icon="menu_privacy_policy",
                    item_id="gemini_plugin_check",
                    condition="message != null && message.getDocument() != null && (message.getDocument().file_name_fixed.endsWith('.plugin') || message.getDocument().file_name_fixed.endsWith('.py'))"
                )
            )
            log("[Gemini] Added plugin check menu item")

        except Exception as e:
            log(f"[Gemini] Error adding menu items: {str(e)}")
            log(f"[Gemini] Traceback: {traceback.format_exc()}")

    def _handle_menu_plugin_check(self, context):
        try:
            log("[Gemini] Plugin check menu item clicked")

            try:
                context_keys = []
                key_set = context.keySet()
                iterator = key_set.iterator()
                while iterator.hasNext():
                    key = iterator.next()
                    context_keys.append(str(key))
                log(f"[Gemini] Available context keys: {context_keys}")
            except Exception as e:
                log(f"[Gemini] Error getting context keys: {e}")

            if not self.get_setting("enabled", True):
                self._show_error_bulletin("API_KEY_MISSING")
                return

            api_key = self.get_setting("gemini_api_key", "")
            if not api_key:
                self._show_error_bulletin("API_KEY_MISSING")
                return

            message = None
            possible_keys = ["message", "messageObject", "selectedMessage", "currentMessage"]

            for key in possible_keys:
                try:
                    if context.containsKey(key):
                        message = context.get(key)
                        log(f"[Gemini] Found message using key: {key}")
                        break
                except Exception as e:
                    log(f"[Gemini] Error checking key {key}: {e}")
                    continue

            if not message:
                log("[Gemini] No message found in context with any known key")
                self._show_error_bulletin("NO_REPLY")
                return

            try:
                log(f"[Gemini] Message type: {type(message)}")
                if hasattr(message, 'messageOwner'):
                    log("[Gemini] Message has messageOwner")
                    document = MessageObject.getDocument(message.messageOwner)
                elif hasattr(message, 'messageText'):
                    log("[Gemini] Message has messageText, trying direct document access")
                    document = MessageObject.getDocument(message)
                else:
                    log("[Gemini] Trying direct document access")
                    document = MessageObject.getDocument(message)

                log(f"[Gemini] Document: {document}")
                if document:
                    log(f"[Gemini] Document filename: {document.file_name_fixed}")

            except Exception as e:
                log(f"[Gemini] Error getting document: {e}")
                document = None

            if not document or not any(str(document.file_name_fixed).endswith(ext) for ext in [".plugin", ".py"]):
                log(f"[Gemini] Invalid document or filename: {document}")
                self._show_error_bulletin("NOT_A_PLUGIN")
                return

            log(f"[Gemini] Starting analysis of plugin file from menu: {document.file_name_fixed}")
            BulletinHelper.show_info(locali.get_string("ANALYZING_MESSAGE"))

            class MenuParams:
                def __init__(self, message_obj, context_data):
                    self.message = DEFAULT_COMMAND
                    self.replyToMsg = message_obj

                    try:
                        self.peer = context_data.get("dialog_id") if context_data.containsKey("dialog_id") else 0
                    except:
                        self.peer = 0

                    if self.peer == 0:
                        try:
                            last_fragment = get_last_fragment()
                            if last_fragment and hasattr(last_fragment, "getDialogId"):
                                self.peer = last_fragment.getDialogId()
                        except:
                            pass

                    self.replyToTopMsg = None
                    try:
                        if context_data.containsKey("replyToTopMsg"):
                            self.replyToTopMsg = context_data.get("replyToTopMsg")
                        else:
                            topic_id = get_topic_id_from_message(message_obj, self.peer)
                            if topic_id > 0:
                                self.replyToTopMsg = create_reply_to_top_message(topic_id, self.peer)
                                log(f"[Gemini] Created replyToTopMsg for topic {topic_id}")
                    except Exception as e:
                        log(f"[Gemini] Error setting up replyToTopMsg: {e}")
                        self.replyToTopMsg = None

            params = MenuParams(message, context)
            run_on_queue(lambda: self._process_analysis_in_background(params, document))

        except Exception as e:
            log(f"[Gemini] Error in menu plugin check: {str(e)}")
            log(f"[Gemini] Traceback: {traceback.format_exc()}")
            self._show_error_bulletin("UNEXPECTED_ERROR", error=str(e))

    def _open_link(self, url: str):
        from android.content import Intent
        from android.net import Uri
        last_fragment = get_last_fragment()
        if not last_fragment: return
        context = last_fragment.getParentActivity()
        if not context: return
        intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
        context.startActivity(intent)

    def _copy_to_clipboard(self, label, text):
        if AndroidUtilities.addToClipboard(text):
            BulletinHelper.show_info(f"Copied {label} to clipboard")
    
    def _show_error_bulletin(self, key: str, **kwargs):
        message = locali.get_string(key).format(**kwargs)
        run_on_ui_thread(lambda: BulletinHelper.show_error(message))

    def _handle_show_info_alert_click(self, view):
        title = locali.get_string("USAGE_INFO_TITLE")
        text = locali.get_string("USAGE_INFO_TEXT")
        close_button = locali.get_string("ALERT_CLOSE_BUTTON")
        parsed_text = parse_markdown(text)
        self.alert_manager.show_info_alert(title, parsed_text.text, close_button)

    def create_settings(self) -> List[Any]:
        return [
            Header(text=locali.get_string("SETTINGS_HEADER")),
            Switch(key="enabled", text=locali.get_string("ENABLE_SWITCH"), icon="menu_privacy_policy", default=True),
            Input(key="gemini_api_key", text=locali.get_string("API_KEY_INPUT"), icon="msg_limit_links", default="", subtext=locali.get_string("API_KEY_SUBTEXT")),
            Text(
                text=locali.get_string("GET_API_KEY_BUTTON"),
                icon="msg_link",
                accent=True,
                on_click=lambda view: self._open_link("https://aistudio.google.com/app/apikey")
            ),
            Divider(),
            Header(text="Model and Prompt"),
            Selector(key="model_selection", text=locali.get_string("MODEL_SELECTOR"), icon="msg_media", default=0, items=MODEL_DISPLAY_NAMES),
            Input(key="custom_prompt_md", text=locali.get_string("PROMPT_INPUT_MD"), icon="filled_unknown", default=DEFAULT_PROMPT_MARKDOWN),
            Input(key="custom_prompt_plain", text=locali.get_string("PROMPT_INPUT_PLAIN"), icon="filled_unknown", default=DEFAULT_PROMPT_PLAINTEXT),
            Divider(),
            Header(text=locali.get_string("GENERATION_HEADER")),
            Input(key="gemini_temperature", text=locali.get_string("TEMPERATURE_INPUT"), icon="msg_photo_settings", default="0.7", subtext=locali.get_string("TEMPERATURE_SUBTEXT")),
            Input(key="gemini_max_tokens", text=locali.get_string("MAX_TOKENS_INPUT"), icon="msg_photo_settings", default="4096", subtext=locali.get_string("MAX_TOKENS_SUBTEXT")),
            Divider(),
            Header(text=locali.get_string("APPEARANCE_HEADER")),
            Switch(
                key="use_blockquote",
                text=locali.get_string("USE_BLOCKQUOTE_TITLE"),
                subtext=locali.get_string("USE_BLOCKQUOTE_SUBTEXT"),
                icon="header_goinline_solar",
                default=True
            ),
            Switch(
                key="use_premium_emoji",
                text=locali.get_string("USE_PREMIUM_EMOJI_TITLE"),
                subtext=locali.get_string("USE_PREMIUM_EMOJI_SUBTEXT"),
                icon="menu_feature_reactions_remix",
                default=False
            ),
            Divider(),
            Header(text=locali.get_string("ADVANCED_HEADER")),
            Switch(key="rename_variables", text=locali.get_string("RENAME_VARS_TITLE"), subtext=locali.get_string("RENAME_VARS_SUBTEXT"), icon="large_hidden", default=True),
            Switch(key="rename_strings", text=locali.get_string("RENAME_STRINGS_TITLE"), subtext=locali.get_string("RENAME_STRINGS_SUBTEXT"), icon="large_hidden", default=True),
            Divider(),
            Text(text=locali.get_string("USAGE_INFO_TITLE"), icon="msg_info", on_click=self._handle_show_info_alert_click),
            Divider(),
            Header(text=locali.get_string("DONATE_HEADER")),
            Text(
                text=locali.get_string("DONATE_CRYPTO"),
                icon="menu_cashtag",
                accent=True,
                on_click=lambda view: run_on_ui_thread(lambda: self._copy_to_clipboard("CRYPTO", "http://t.me/send?start=IVaZsLfW7aSn"))
            ),
            Text(
                text=locali.get_string("DONATE_INFO"),
                icon="msg_info",
                accent=True,
                on_click=lambda view: run_on_ui_thread(lambda: get_messages_controller().openByUserName("mishabotov", get_last_fragment(), 1))
            )
        ]

    def _get_plugin_metadata(self, code: str) -> Tuple[str, str]:
        name = "Unknown Plugin"; version = "Unknown Version"
        try:
            tree = ast.parse(code)
            for node in ast.walk(tree):
                if isinstance(node, ast.Assign):
                    for target in node.targets:
                        if isinstance(target, ast.Name):
                            if target.id == "__name__": name = ast.literal_eval(node.value)
                            elif target.id == "__version__": version = ast.literal_eval(node.value)
        except Exception:
            pass
        return name, version

    def _get_chat_id_from_params(self, params: Any) -> int:
        peer = getattr(params, 'peer', None)
        if not peer:
            log("[Gemini] No peer found in params")
            return 0

        if hasattr(peer, 'channel_id') and peer.channel_id != 0:
            chat_id = -peer.channel_id
            log(f"[Gemini] Found channel_id: {chat_id}")
            return chat_id
        if hasattr(peer, 'chat_id') and peer.chat_id != 0:
            chat_id = -peer.chat_id
            log(f"[Gemini] Found chat_id: {chat_id}")
            return chat_id
        if hasattr(peer, 'user_id') and peer.user_id != 0:
            chat_id = peer.user_id
            log(f"[Gemini] Found user_id: {chat_id}")
            return chat_id

        log(f"[Gemini] Peer object has no recognizable ID fields: {peer}")
        return 0

    def _wait_for_file(self, file_path: str, document: Any) -> bool:
        if os.path.exists(file_path): return True
        get_file_loader().loadFile(document, "gemini_analyzer", FileLoader.PRIORITY_HIGH, 1)
        for _ in range(30):
            if os.path.exists(file_path): return True
            time.sleep(1)
        return False
    
    def _get_obfuscated_code(self, code: str) -> str:
        lines = []
        for line in code.split('\n'):
            stripped_line = line.split('#', 1)[0]
            lines.append(stripped_line)
        clean_code = '\n'.join(lines)

        rename_vars = self.get_setting("rename_variables", True)
        rename_strings = self.get_setting("rename_strings", True)

        if not rename_vars and not rename_strings:
            return '\n'.join(line for line in clean_code.split('\n') if line.strip())

        try:
            tree = ast.parse(clean_code)
            transformer = CodeObfuscator(rename_vars, rename_strings)
            new_tree = transformer.visit(tree)
            ast.fix_missing_locations(new_tree)
            return ast.unparse(new_tree)
        except Exception:
            return '\n'.join(line for line in clean_code.split('\n') if line.strip())

    def _process_analysis_in_background(self, params: Any, document: Any):
        try:
            file_path_obj = get_file_loader().getPathToAttach(document, True)
            if not self._wait_for_file(file_path_obj.getAbsolutePath(), document):
                self._show_error_bulletin("FILE_DOWNLOAD_ERROR")
                return

            try:
                with open(file_path_obj.getAbsolutePath(), "r", encoding="utf-8", errors="ignore") as f:
                    plugin_code = f.read()
                plugin_name, plugin_version = self._get_plugin_metadata(plugin_code)
            except Exception as e:
                self._show_error_bulletin("FILE_READ_ERROR", e=str(e))
                return

            processed_code = self._get_obfuscated_code(plugin_code)

            api_key = self.get_setting("gemini_api_key", "")
            model_idx = self.get_setting("model_selection", 0)
            model_name = MODEL_API_NAMES[model_idx]
            use_blockquote = self.get_setting("use_blockquote", True)
            
            try:
                temperature = float(self.get_setting("gemini_temperature", "0.5"))
            except (ValueError, TypeError):
                temperature = 0.5

            try:
                max_tokens = int(self.get_setting("gemini_max_tokens", "8192"))
            except (ValueError, TypeError):
                max_tokens = 8192
            
            prompt_template = self.get_setting("custom_prompt_plain" if use_blockquote else "custom_prompt_md", 
                                             DEFAULT_PROMPT_PLAINTEXT if use_blockquote else DEFAULT_PROMPT_MARKDOWN)

            full_prompt = prompt_template.format(plugin_code=processed_code, plugin_name=plugin_name, plugin_version=plugin_version)
            result = self.api_handler.analyze_plugin_code(api_key, model_name, full_prompt, temperature, max_tokens)
            
            if result.get("success"):
                self._send_report(params, result["text"], plugin_name, plugin_version, use_blockquote)
            else: 
                self._show_error_bulletin("API_ERROR", error=result.get("error", "Unknown"))

        except Exception as e:
            log(f"[Gemini] Exception in _process_analysis_in_background: {e}")
            log(f"[Gemini] Exception type: {type(e)}")
            log(f"[Gemini] Traceback: {traceback.format_exc()}")
            self._show_error_bulletin("UNEXPECTED_ERROR", error=str(e))
            traceback.print_exc()

    def _send_report(self, params: Any, response_text: str, plugin_name: str, plugin_version: str, use_blockquote: bool):
        try:
            header_key = "SUCCESS_HEADER_PLAIN" if use_blockquote else "SUCCESS_HEADER_MD"
            header = locali.get_string(header_key).format(plugin_name=plugin_name, plugin_version=plugin_version)

            use_premium_emoji = self.get_setting("use_premium_emoji", False)
            if use_premium_emoji:
                enhanced_header = replace_with_premium_emoji(header)
                enhanced_response_text = replace_with_premium_emoji(response_text)
                report_text = enhanced_header + enhanced_response_text
            else:
                report_text = header + response_text

            log(f"[Gemini] Sending report with blockquote={use_blockquote}, text_length={len(report_text)}")

        except Exception as e:
            log(f"[Gemini] Error preparing report text: {e}")
            fallback_text = f"ğŸ›¡ï¸ Security Report: {plugin_name} v{plugin_version}\n\n{response_text}"
            use_premium_emoji = self.get_setting("use_premium_emoji", False)
            if use_premium_emoji:
                report_text = replace_with_premium_emoji(fallback_text)
            else:
                report_text = fallback_text
        
        try:
            peer_id = getattr(params, "peer", None)
            reply_to_msg = getattr(params, "replyToMsg", None)
            reply_to_top_msg = getattr(params, "replyToTopMsg", None)

            log(f"[Gemini] Raw peer from params: {peer_id}")
            log(f"[Gemini] replyToMsg: {reply_to_msg}")
            log(f"[Gemini] replyToTopMsg: {reply_to_top_msg}")

            message_payload = {
                "peer": peer_id,
                "replyToMsg": reply_to_msg,
                "replyToTopMsg": reply_to_top_msg
            }
            log(f"[Gemini] Created message_payload successfully")
        except Exception as e:
            log(f"[Gemini] Error in simple peer approach: {e}")
            try:
                last_fragment = get_last_fragment()
                if last_fragment and hasattr(last_fragment, "getDialogId"):
                    peer_id = last_fragment.getDialogId()
                    log(f"[Gemini] Fallback: got peer from fragment: {peer_id}")
                else:
                    peer_id = 0
                    log("[Gemini] Fallback: using peer_id = 0")

                message_payload = {
                    "peer": peer_id,
                    "message": "Fallback message"
                }
            except Exception as e2:
                log(f"[Gemini] Fallback also failed: {e2}")
                return

        try:
            parsed = parse_markdown(report_text)
            entities = []

            if use_blockquote and parsed.text and len(parsed.text.strip()) > 0:
                blockquote_entity = TLRPC.TL_messageEntityBlockquote()
                blockquote_entity.collapsed = True
                blockquote_entity.offset = 0
                try:
                    blockquote_entity.length = len(parsed.text.encode('utf-16le')) // 2
                except:
                    blockquote_entity.length = len(parsed.text)
                entities.append(blockquote_entity)
                log(f"[Gemini] Added blockquote entity with length {blockquote_entity.length}")
            if parsed.entities:
                for entity in parsed.entities:
                    try:
                        tlrpc_entity = entity.to_tlrpc_object()
                        if tlrpc_entity is not None:
                            entities.append(tlrpc_entity)
                    except Exception as e:
                        log(f"[Gemini] Entity error: {e}")

            message_payload["message"] = parsed.text
            message_payload["entities"] = entities if entities else None
            send_message(message_payload)
            log(f"[Gemini] Report sent with {len(entities)} entities")

        except Exception as e:
            log(f"[Gemini] Send failed, using fallback: {e}")
            try:
                clean_text = report_text.replace('**', '').replace('__', '').replace('`', '')
                clean_text = get_regular_emoji_for_bulletin(clean_text)

                fallback_entities = []
                if use_blockquote and clean_text and len(clean_text.strip()) > 0:
                    blockquote_entity = TLRPC.TL_messageEntityBlockquote()
                    blockquote_entity.collapsed = True
                    blockquote_entity.offset = 0
                    try:
                        blockquote_entity.length = len(clean_text.encode('utf-16le')) // 2
                    except:
                        blockquote_entity.length = len(clean_text)
                    fallback_entities.append(blockquote_entity)
                    log(f"[Gemini] Added fallback blockquote entity with length {blockquote_entity.length} for text length {len(clean_text)}")

                message_payload["message"] = clean_text
                message_payload["entities"] = fallback_entities if fallback_entities else None
                send_message(message_payload)
                log(f"[Gemini] Fallback send successful with {len(fallback_entities)} entities")
            except Exception as e2:
                log(f"[Gemini] Fallback failed: {e2}")
                self._show_error_bulletin("UNEXPECTED_ERROR", error="Failed to send report")

        verdict_line = response_text.split('\n', 1)[0].strip()
        clean_verdict = verdict_line.replace("â—ˆ Ğ’ĞµÑ€Ğ´Ğ¸ĞºÑ‚:", "").strip()

        bulletin_verdict = get_regular_emoji_for_bulletin(clean_verdict)

        def show_verdict_bulletin():
            if "âœ…" in verdict_line:
                BulletinHelper.show_success(bulletin_verdict)
            elif "âŒ" in verdict_line or "ğŸ“›" in verdict_line:
                BulletinHelper.show_error(bulletin_verdict)
            else:
                BulletinHelper.show_info(bulletin_verdict)
        run_on_ui_thread(show_verdict_bulletin)

    def on_send_message_hook(self, account: int, params: Any) -> HookResult:
        if not hasattr(params, "message") or not isinstance(params.message, str): return HookResult()

        message_text = params.message.strip()
        if message_text.lower() != DEFAULT_COMMAND or not self.get_setting("enabled", True): return HookResult()

        log(f"[Gemini] Processing command {DEFAULT_COMMAND}")

        try:
            params_attrs = [attr for attr in dir(params) if not attr.startswith('_')]
            log(f"[Gemini] Available params attributes: {params_attrs}")

            if hasattr(params, 'peer'):
                log(f"[Gemini] params.peer exists: {params.peer}")
            if hasattr(params, 'dialog_id'):
                log(f"[Gemini] params.dialog_id exists: {params.dialog_id}")
            if hasattr(params, 'chat_id'):
                log(f"[Gemini] params.chat_id exists: {params.chat_id}")
        except Exception as e:
            log(f"[Gemini] Error inspecting params: {e}")

        api_key = self.get_setting("gemini_api_key", "")
        if not api_key:
            self._show_error_bulletin("API_KEY_MISSING")
            return HookResult(strategy=HookStrategy.CANCEL)

        if not hasattr(params, "replyToMsg") or not params.replyToMsg:
            self._show_error_bulletin("NO_REPLY")
            return HookResult(strategy=HookStrategy.CANCEL)

        try:
            log(f"[Gemini] Command params.replyToMsg: {params.replyToMsg}")
            log(f"[Gemini] Command params.replyToTopMsg: {getattr(params, 'replyToTopMsg', None)}")

            if not hasattr(params, 'replyToTopMsg') or not params.replyToTopMsg:
                topic_id = get_topic_id_from_message(params.replyToMsg, params.peer)
                if topic_id > 0:
                    params.replyToTopMsg = create_reply_to_top_message(topic_id, params.peer)
                    log(f"[Gemini] Created replyToTopMsg for command, topic {topic_id}")
        except Exception as e:
            log(f"[Gemini] Error setting up topic for command: {e}")

        document = MessageObject.getDocument(params.replyToMsg.messageOwner)
        if not document or not any(str(document.file_name_fixed).endswith(ext) for ext in [".plugin", ".py"]):
            self._show_error_bulletin("NOT_A_PLUGIN")
            return HookResult(strategy=HookStrategy.CANCEL)

        log(f"[Gemini] Starting analysis of plugin file: {document.file_name_fixed}")
        BulletinHelper.show_info(locali.get_string("ANALYZING_MESSAGE"))
        run_on_queue(lambda: self._process_analysis_in_background(params, document))
        return HookResult(strategy=HookStrategy.CANCEL)