"""
                            Ð”Ð˜Ð¡ÐšÐ›Ð•Ð™ÐœÐ•Ð 

ÐšÐ¾Ñ€Ð¾Ñ‡Ðµ , ÐµÑÐ»Ð¸ Ñ‚ÐµÐ±Ðµ Ð½ÑƒÐ¶ÐµÐ½ ÐºÑƒÑÐ¾Ðº ÐºÐ¾Ð´Ð° Ð¸Ð· ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð° , Ñ‚Ð¾ Ð¿Ð¶
ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°Ð¹ Ð² Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ð¸ Ð¸Ð»Ð¸ Ð³Ð´Ðµ-Ñ‚Ð¾ ÐµÑ‰Ðµ , Ñ‡Ñ‚Ð¾ Ð²Ð·ÑÐ» ÐºÐ¾Ð´ Ñ @KangelPlugins
                              Ð¡Ð¿Ð°ÑÐ¸Ð±Ð¾
                        ðŸ™ Ð‘Ð›ÐÐ“ÐžÐ¡Ð›ÐÐ’Ð›Ð•ÐÐ˜Ð• ðŸ™

â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£€â£€â¡¤â ¤â£„â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¤â¡¤â£¤â¡€â €â €â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£ â žâ ‰â¢€â£¤â ¶â ®â ·â£¤â£€â¡€â €â €â¢€â €â €â €â €â €â €â €â €â¢€â¡¼â ‹â ˆâ£½â£†â ¹â£¦â¡€â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â¢€â£¤â ¶â ¶â ¶â ¶â£„â €â €â €â£žâ£â£ â ´â ¯â °â ¶â ¶â ¶â£¾â â ™â£¯â£³â£¥â žâ¢¹â €â €â €â €â €â €â¡¾â €â¢ â¡¾â â¢¹â €â¢»â£§â €â €â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â£ â â €â£Šâ£€â£â£€â¡ˆâ¢“â£¦â¡–â ‹â â €â¡°â ‚â €â €â €â €â£¹â¢ â£„â£½â ¬â£¾â ‰â¢¹â ³â¡„â €â €â €â¢¸â ‡â €â¢¸â €â¢€â¡¼â¡‡â¢ˆâ¡¾â¡¦â£„â €â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â¢°â¡â£ â¡¾â ‰â¢€â €â£€â¡½â ›â¢ƒâ¡„â €â €â¡œâ €â €â €â €â €â €â ™â ›â ›â¢§â¡€â ˆâ »â¢¾â¡„â ˆâ¢§â¡€â €â¢¸â €â €â¢¸â¡°â¡¿â ›â¡§â Šâ¡„â£¿â£®â ³â£„â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â¡¾â¢¹â¡‡â €â €â£´â ›â €â¢€â Žâ €â €â£¼â €â €â €â €â €â €â €â €â €â €â¢¸â¡¹â£¦â¡€â €â£³â ¶â£¾â£³â¡„â£¸â €â €â¢¸â ƒâ¢€â£´â ƒâ €â¢¡â£§â£½â €â ¹â¡„â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â¢¸â¡‡â¢¸â¡‡â¢°â¡¾â “â €â €â¡Žâ €â €â¢ â£¿â €â €â €â €â €â €â €â €â €â €â¡žâ¡‰â¢ºâ£¯â£«â¡·â ¦â¡¿â ™â¢·â¡‡â €â¢€â¡â£ â ¿â¡Ÿâ €â¢ â£¾â¡–â¡Ÿâ¡†â €â¡‡â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â ˜â¢§â €â£³â¢¿â¡¾â €â €â£¼â â €â£€â£¾â£¿â €â €â¡„â €â €â €â €â €â¢°â €â ·â¢¿â¡Ÿâ â ˆâ »â£§â¡‡â£ â¢¾â£‡â£¤â žâ£´â ƒâ¡¾â â¢€â¡¿â ‰â ’â¢»â¡‡â €â¡‡â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â¢»â£§â¡¾â¢ â ƒâ¢€â¡‡â €â¢€â¡¾â â ¸â£¼â¡€â£‡â €â €â €â£†â €â¢¸â¡†â €â¢ â¢§â¡€â €â €â¡·â£žâ£¡â Žâ£‡â£¤â žâ â¡¼â â¢€â¡¿â â €â €â¢¹â â¢ â ‡â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â£€â¡ â €â¢€â£¿â£â¡‡â¢¸â¡€â €â¡‡â €â£¾â ƒâ €â €â ‰â »â â “â ¶â ¶â ¿â¢¤â£€â¡·â¢„â£¸â¢®â£¿â¡¦â£¤â¡Ÿâ ‰â£¿â¢¸â¡â â €â£¸â â¢€â¡žâ ƒâ €â €â ”â¡¿â €â¡¾â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â ¹â¡’â €â ˜â£¿â£¿â¡‡â ¸â£‡â¢°â¡‡â¢°â£§â£¶â£¶â£¶â¡†â €â €â €â €â£´â£–â£„â£’â£¦â£¼â£â£°â£¾â ¿â¢¾â£¯â£‰â£â£¾â¡‡â €â €â¡‡â €â£¼â â €â €â €â£°â ƒâ£¼â …â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â ™â ³â ›â ¶â£½â¡‡â €â£¿â¡„â¢»â£¸â£Žâ ‰â ‰â â €â €â €â €â €â €â ‰â ‰â ‰â ‰â â¢¹â¡â â €â£¸â¡â ™â¡¿â£»â ‘â¢„â €â£§â €â¡Ÿâ¡†â €â €â¢¨â â¡´â¡‡â €â €â €â €â €â €
â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â£¿â¢·â €â£¿â¢¹â£„â£¿â ¿â¡‚â €â €â €â ‰â €â €â €â €â €â €â €â €â €â¢¾â â €â €â¡¿â£§â žâ£±â ‡â €â¡˜â ¦â¡½â£„â£¿â ¹â£„â¡´â¢‰â ”â â¢³â €â €â €â €â €â €
â €â €â €â €â €â €â €â¢€â£€â¡€â €â €â €â €â¢°â¡¿â¢¸â£§â ˜â£Ÿâ ™â£¿â¡„â €â €â¢€â¡€â €â €â €â €â €â €â €â €â €â¢ â£¯â –â €â¢°â£·â¢‡â¡¼â ƒâ¢€â žâ €â¡†â €â ™â£¿â¡¦â ™â¢¶â¡â €â €â €â â €â €â €â €â €
â €â €â €â €â ²â¢¿â ‹â ‰â ‰â ™â¢¦â£€â €â €â£¿â¡‡â¢¸â£¿â¡·â ¼â¢¶â ½â£¿â£†â €â ˆâ »â ¤â ¤â ¤â žâ €â €â €â €â¢´â£¿â ‡â €â €â£¸â¡¿â ‹â €â €â Žâ €â¡žâ €â£ â žâ¢â ½â¢¦â¡€â ™â¢¦â£€â €â €â €â €â €â €â €
â €â €â¢€â €â €â¢¸â£…â €â €â ˆâ ‰â ›â ‰â ”â£»â£¸â¢¸â£¿â ¿â£ â¡â£§â ™â¢¿â£§â£„â €â €â €â €â €â €â €â£€â£´â£¾â ƒâ €â €â¢°â ‡â €â €â €â €â €â €â£ â žâ¢â¡”â ƒâ €â â ‹â —â¢¦â£ˆâ ³â£„â €â €â €â €â €
â €â €â¢¿â£â¢¦â£¸â¡œâ£†â €â €â €â €â¡€â €â£§â¡‡â €â¡¿â €â €â €â ‰â â €â ‰â ›â¢·â£„â£€â£ â£´â žâ ‰â¢â¡¾â â €â €â£°â â €â €â €â €â €â¢ â£¾â ƒâ¢°â â €â €â €â €â €â €â €â ‰â ›â¢·â£µâ£„â €â €â €
â¢»â£Ÿâ£¿â¡»â£Žâ¢£â£³â¡˜â£†â €â¢ â¡žâ¡â €â£¾â£§â €â£§â €â €â €â €â €â €â €â €â €â¢ â¡Ÿâ£¿â €â£ â¢‚â£Ÿâ£¡â „â£ â¢¾â£‹â£€â£€â£€â¡€â €â¢°â£¿â ƒâ¢ â¡â €â €â €â €â €â €â €â €â €â €â €â ™â£¿â »â£„â €
â¡ˆâ¢»â£†â »â¡Ÿâ£†â¢»â£§â¢»â£„â¡¼â¢¸â¡‡â£¦â£¿â¡¼â£§â£½â¡„â €â €â €â €â €â €â¢€â£´â£‹â£¤â£¿â¢ˆâ Ÿâ¢¹â¡¿â£¡â¡žâ ‰â ‰â €â €â£°â£¶â£™â£·â£¯â¡â €â£¸â â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ£·â ˆâ¢§
â£–â ¦â£¾â£·â¡™â ¿â €â ™â €â¢»â¡‡â¢¸â¡‡â ˜â¢¿â£·â¡Œâ »â£¿â£¤â €â €â €â£ â£¶â¡¿â ‹â£±â£¿â Ÿâ â£ â£¿â¢ â¡â €â €â¢€â¡¾â Ÿâ ‹â â €â£¨â¢¿â¡‡â €â¡‡â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˆâ£§â €
â ˜â¢¿â£Žâ¡™â ›â ‚â €â €â €â¡¼â ƒâ¢¸â ‡â ˜â¡„â ™â ›â €â ˆâ ‰â €â£ â£¾â¢â¡œâ¢¡â¡¾â ›â €â£ â¡¾â ‰â¢»â£¿â£„â£€â¡¾â ›â €â €â €â¡ â Šâ €â €â¢³â €â¢³â €â €â €â €â €â €â €â €â €â €â €â €â €â €â €â ˜â¡„
â €â €â ™â¢¿â£¦â¡€â €â €â €â â €â¢¸â£‡â €â €â €â €â €â €â¢€â£¾â£¿â ƒâ¡Žâ¢ â¡¿â ¥â£¤â žâ ‰â¢°â£¦â£€â¡½â ›â ›â €â €â €â¢ â Žâ €â €â €â €â ¸â£†â ˜â£‡â €â €â €â €â €â €â €â €â €â €â£„â¢‡â €â €â €â¢³
â €â €â €â €â£¿â¢¹â£†â¡€â €â €â¡€â£ˆâ£¿â¢»â¡€â €â €â €â¢€â£¾â¢¿â£‡â ˜â¢ â¡Ÿâ¢€â¡´â ‹â£€â£¸â£·â£¿â ‹â â €â €â €â €â¢€â¡‡â €â €â €â €â €â €â¢»â£·â£Œâ ³â£„â¡€â €â €â €â €â €â €â €â ˆâ ‰â €â €â €â¢¸
â €â €â €â €â ˆâ¢»â£™â ›â ›â ‰â ‰â ‰â €â£¾â£¾â¡€â €â¢€â£¾â¢â£¾â¡¾â¢€â¡žâ¢ â¡¾â£·â£¿â£¿â£¿â ‹â €â €â €â €â €â¡€â¢€â¡žâ €â €â €â €â €â €â €â¢˜â¡Œâ ™â ·â£¬â¡»â£—â ’â ’â ¦â ¤â ¤â ¤â¢¤â£„â£€â €â €â¢¸
â €â €â €â €â €â ¾â¢¯â¡â €â €â €â €â  â¢žâ£»â¢·â£¤â£¾â£â£¸â¢¹â£§â£¸â££â¢Ÿâ£¤â£¿â£¿â¡¿â ¥â¡„â €â €â €â €â €â£§â£¸â €â €â €â €â €â €â €â €â¢¸â¡‡â €â €â €â ‰â ™â ³â ¤â ¤â ¤â£„â£€â£€â €â ˆâ ‰â “â ¿
â €â €â €â €â â ¦â¡¼â ¥â ¤â ¤â¢„â¡¤â –â ‹â â ˜â¡Ÿâ €â ˆâ ³â£œâ£¿â£¿â££â£¾â Ÿâ ‹â â €â¢¸â¡‡â €â €â €â €â €â¢¸â ‡â €â €â €â €â €â €â €â €â €â¢³â €â €â €â €â €â €â €â €â €â €â €â ‰â ¹â£²â£¤â¡€â €
â €â €â €â €â €â €â¡‡â €â €â €â¢€â¡¬â£â ‚â €â €â¡‡â €â €â£¤â£™â¡Ÿâ ‰â¡¯â ¤â ¤â €â €â  â¡¿â €â €â €â €â €â €â ˆâ£‡â €â €â €â €â €â €â €â €â €â£¸â €â €â €â €â €â €â €â €â €â €â£ â ´â ›â â €â ™â£¦
â €â €â €â €â €â €â¡‡â €â €â €â ƒâ €â£¸â €â¢€â£´â¡Ÿâ €â  â ”â ’â£§â£¤â£·â¡¦â¡„â €â €â €â£§â €â €â €â €â €â €â €â¢¸â €â €â €â €â €â €â €â €â €â¡‡â €â €â €â €â €â €â €â¢€â£¤â žâ â €â €â¢€â¡¤â Žâ €
â €â €â €â €â €â¢ˆâ£¿â €â €â €â¢ â €â ƒâ¢ â â¡¼â €â €â €â£ â¡¼â£¿â£â¡â¢¿â¢„â €â €â €â¡â¢§â¡€â €â €â €â €â €â¢¸â¡†â €â €â €â €â €â €â €â €â¡‡â €â €â €â €â €â¢€â¡´â ‹â €â¢€â£¤â ´â Ÿâ ‰â €â €â €
â €â €â €â €â €â¢›â¡»â¡‡â €â €â ˆâ †â €â¢¸â¡„â §â ¤â ´â ›â ‰â£¸â£§â¢»â €â ˜â €â ›â ¦â ¼â ƒâ£€â£¹â †â €â €â €â €â ˆâ¡‡â €â €â €â €â €â €â €â €â¢£â €â €â €â¢€â¡´â ‹â¢€â£¤â žâ ‰â €â €â €â €â €â €â €
â €â €â €â €â ‰â €â ˜â£¿â¡„â €â €â €â €â €â¢»â¡€â €â €â¢€â¡¼â£»â¡½â¢¸â €â €â €â €â¢€â£ â£â â €â €â €â €â €â €â €â£³â €â €â €â €â €â €â €â €â ˜â¡†â €â¢ â¡Ÿâ¢€â¡´â ‹â €â €â €â €â €â €â €â €â €â €

                            DISCLAIMER

Anyway, if you need a piece of code from this plugin,
please mention in the description or somewhere else that you got it from @KangelPlugins
                             Thanks.
                            ðŸ™BLESSðŸ™
"""
import hashlib
import json
import os
import re
import shutil
import time
import traceback
import requests
from android import R as android_R
from android.content import ClipboardManager, ClipData, Context, Intent
from android.net import Uri
from android.text import SpannableString, Spanned, TextWatcher, TextUtils
from android.text.style import StrikethroughSpan
from android.util import TypedValue
from android.view import Gravity, View, ViewGroup
import threading
import urllib.request
import uuid


MKSTATS_API_URL = os.getenv("MKSTATS_API_URL", "https://mkstats.mk69.su/api")
MKSTATS_PING_INTERVAL = int(os.getenv("MKSTATS_PING_INTERVAL", "1500"))
MKSTATS_POW_SOLVE_SECONDS = int(os.getenv("MKSTATS_POW_SOLVE_SECONDS", "6"))

def generate_user_hash(device_id: str, plugin_id: str) -> str:
    payload = f"{device_id}:{plugin_id}:mkstats:v1"
    return hashlib.sha256(payload.encode("utf-8")).hexdigest()

def generate_device_fingerprint(device_id: str) -> str:
    payload = f"{device_id}:mkstats:device:v1"
    return hashlib.sha256(payload.encode("utf-8")).hexdigest()

def _normalize_api_base(api_url: str) -> str:
    base = api_url.rstrip("/")
    if base.endswith("/api"):
        return f"{base}/v1"
    return base

def _post_json(url: str, payload: dict) -> dict:
    data = json.dumps(payload).encode("utf-8")
    request = urllib.request.Request(
        url, data=data, headers={"Content-Type": "application/json"}
    )
    with urllib.request.urlopen(request, timeout=10) as response:
        body = response.read().decode("utf-8")
    return json.loads(body)

def _pow_valid(challenge: str, nonce: str, difficulty: int) -> bool:
    if not challenge or not nonce or difficulty <= 0:
        return False
    prefix = "0" * max(1, int(difficulty))
    digest = hashlib.sha256(f"{challenge}:{nonce}".encode("utf-8")).hexdigest()
    return digest.startswith(prefix)

def _solve_pow(challenge: str, difficulty: int, max_seconds: int = MKSTATS_POW_SOLVE_SECONDS) -> str | None:
    difficulty = max(1, int(difficulty or 0))
    deadline = time.time() + max(1, int(max_seconds or 0))
    nonce = 0
    prefix = "0" * difficulty
    while time.time() < deadline:
        candidate = format(nonce, "x")
        digest = hashlib.sha256(f"{challenge}:{candidate}".encode("utf-8")).hexdigest()
        if digest.startswith(prefix):
            return candidate
        nonce += 1
    return None

class MkStatsCoreClient:
    def __init__(self, api_url: str, plugin_id: str, plugin_version: str, user_hash: str, device_fingerprint: str, client_version: str | None = None, client_name: str | None = None) -> None:
        self.api_base = _normalize_api_base(api_url)
        self.plugin_id = plugin_id
        self.plugin_version = plugin_version
        self.client_version = client_version
        self.client_name = client_name
        self.user_hash = user_hash
        self.device_fingerprint = device_fingerprint

    def handshake(self) -> dict:
        payload = {
            "plugin_id": self.plugin_id,
            "version": self.plugin_version,
            "client_name": self.client_name,
            "client_version": self.client_version,
            "user_hash": self.user_hash,
            "device_fingerprint": self.device_fingerprint,
        }
        response = _post_json(f"{self.api_base}/handshake", payload)
        token = (response or {}).get("install_token", "")
        if token:
            return response
        pow_required = bool((response or {}).get("pow_required"))
        pow_challenge = (response or {}).get("pow_challenge")
        if pow_required and pow_challenge:
            difficulty = int((response or {}).get("pow_difficulty") or 0)
            nonce = _solve_pow(pow_challenge, difficulty)
            if nonce and _pow_valid(pow_challenge, nonce, difficulty):
                payload["pow_challenge"] = pow_challenge
                payload["pow_nonce"] = nonce
                response = _post_json(f"{self.api_base}/handshake", payload)
        return response

    def send_ping(self, install_token: str, timestamp=None) -> dict:
        payload = {
            "plugin_id": self.plugin_id,
            "version": self.plugin_version,
            "client_name": self.client_name,
            "client_version": self.client_version,
            "user_hash": self.user_hash,
            "device_fingerprint": self.device_fingerprint,
            "install_token": install_token,
            "timestamp": timestamp or int(time.time()),
        }
        return _post_json(f"{self.api_base}/data", payload)

    def send_event(self, install_token: str, event: str, count: int = 1, timestamp=None) -> dict:
        payload = {
            "plugin_id": self.plugin_id,
            "version": self.plugin_version,
            "client_name": self.client_name,
            "client_version": self.client_version,
            "user_hash": self.user_hash,
            "device_fingerprint": self.device_fingerprint,
            "install_token": install_token,
            "event": event,
            "count": count,
            "timestamp": timestamp or int(time.time()),
        }
        return _post_json(f"{self.api_base}/event", payload)
# === mkStats: embed client end ===

from android.widget import (AbsListView, AdapterView, ArrayAdapter,
                            BaseAdapter, EditText, FrameLayout, ImageView,
                            LinearLayout, ListView)
from android.widget import TextView
from android.widget import TextView as AndroidTextView
from android_utils import log as _android_log, run_on_ui_thread
from androidx.core.widget import NestedScrollView
from base_plugin import BasePlugin, MenuItemData, MenuItemType, MethodHook
from client_utils import (get_last_fragment, get_messages_controller,
                          run_on_queue, send_document)
from com.exteragram.messenger.plugins import Plugin, PluginsController
from com.exteragram.messenger.plugins.ui import PluginSettingsActivity
from com.exteragram.messenger.plugins.ui.components import PluginCellDelegate
from com.exteragram.messenger.plugins.ui.components.templates import \
    UniversalFragment
from hook_utils import find_class, get_private_field
from java import dynamic_proxy
from java.lang import String
from java.util import ArrayList, Locale
from org.telegram.messenger import (AndroidUtilities, ApplicationLoader,
                                    ImageLocation, MediaDataController,
                                    NotificationCenter)
from org.telegram.messenger import R as R_tg
from org.telegram.messenger import Utilities
from org.telegram.tgnet import TLRPC
from org.telegram.ui.ActionBar import (AlertDialog, BottomSheet,
                                       SimpleTextView, Theme)
from org.telegram.ui.Components import (BackupImageView, LayoutHelper, UItem,
                                        UniversalRecyclerView)
from ui.alert import AlertDialogBuilder
from ui.bulletin import BulletinHelper
from ui.settings import Divider, Header, Selector, Switch, Text

__id__ = "kangel_plugins_manager"
__name__ = "Kangel Plugins Manager"
__description__ = """
ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² , Ð¿Ñ€ÐµÐ´Ð»Ð°Ð³Ð°ÑŽÑ‰Ð¸Ð¹ ÑƒÐ´Ð¾Ð±Ð½Ð¾Ðµ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°Ð¼Ð¸
Ð¢Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ: exteraGram/Ayugram 12.1.1 Ð¸ Ð²Ñ‹ÑˆÐµ

First plugin store with easy plugin management
Requirements:exteraGram/AyuGram 12.1.1 or higher
"""
__author__ = "@ArThirtyFour | @KangelPlugins"
__min_version__ = "12.1.1"
__icon__ = "Kangelcons_by_fStikBot/5"
__version__ = "1.2"

PLUGINS_DIR = f'/data/user/0/{ApplicationLoader.applicationContext.getPackageName()}/files/plugins'

_kpm_instance = None

def _kpm_logs_enabled():
    inst = globals().get("_kpm_instance")
    if inst is None:
        return True
    try:
        return bool(inst.get_setting("logs_enabled", True))
    except Exception:
        return True

def log(*args, **kwargs):
    try:
        if _kpm_logs_enabled():
            _android_log(*args, **kwargs)
    except Exception:
        pass

def _get_lang():
    lang = Locale.getDefault().getLanguage().lower()
    return "ru" if lang.startswith("ru") else "en"

def _tr(key):
    lang = _get_lang()
    strings = {
        "en": {
            "header": "Kangel Plugins Manager",
            "updates_header": "Updates",
            "actions_header": "Actions",
            "author_header": "Author",
            "auto_update": "Auto-update on start",
            "auto_update_sub": "Update plugins list when app starts",
            "auto_update_installed": "Auto-update installed plugins",
            "auto_update_installed_sub": "Update installed plugins on app start",
            "refresh_list": "Refresh plugins list",
            "install_plugin": "Install plugin",
            "update_plugins": "Update installed plugins",
            "delete_plugin": "Delete plugin",
            "send_to_bot": "Send plugin to bot",
            "open_author_channel": "Open author's channel",
            "open_forum": "Open forum",
            "install_title": "Install plugin",
            "delete_title": "Delete plugin",
            "cancel": "Cancel",
            "search_hint": "Search...",
            "list_empty": "List is empty",
            "no_installed": "All plugins are currently up to date.",
            "file_not_found": "File not found",
            "installed": "Installed {}",
            "deleted": "Deleted {}",
            "error_download": "Download error: {}",
            "error_write": "Write error: {}",
            "error_delete": "Delete error: {}",
            "updated_stats": "Updated: {}, unchanged: {}, errors: {}",
            "installing_deps": "Installing dependencies...",
            "dep_installed": "Dependency installed: {}",
            "dep_error": "Dependency error: {}",
            "clear_cache": "Clear cache",
            "cache_cleared": "Cache cleared successfully",
            "error_window": "All plugins are cached, you can open install menu",
            "install_button": "Install",
            "delete_button": "Delete",
            "version": "Version",
            "author": "Author",
            "no_description": "Description not available",
            "show_drawer_menu": "Show in drawer menu",
            "show_drawer_menu_sub": "Display Plugin Manager in side menu",
            "show_add_button": "Show '+' button in plugins menu",
            "show_add_button_sub": "Display install button in PluginsActivity menu",
            "show_update_button": "Show update button in plugins menu",
            "show_update_button_sub": "Display update-installed button in PluginsActivity menu",
            "plugins_sort": "Plugins sorting",
            "plugins_sort_sub": "Sort plugins by name",
            "sort_none": "No sorting",
            "sort_az": "A-Z",
            "sort_za": "Z-A",
            "sort_author_az": "Author A-Z",
            "sort_author_za": "Author Z-A",
            "first_run_title": "First run detected",
            "first_run_desc": "Loading plugins for the first time may take a while. Please wait...",
            "first_run_hint": "The cache will be created automatically",
            "install_dependencies": "Install dependencies",
            "install_dependencies_sub": "Install required dependencies before installing the plugin",
            "store_loaded": "Loaded {} plugins from JSON store",
            "store_load_failed": "Cannot load store.json",
            "share_title": "Plugin",
            "share_copy_link": "Copy link",
            "share_send_file": "Send to Telegram (Saved Messages)",
            "share_system": "System share",
            "plugin_management": "Plugin Management",
            "auto_updates": "Auto-Updates",
            "ui_settings": "UI Settings",
            "about_plugin": "About Plugin",
            "open_github": "GitHub repository",
            "faq": "FAQ",
            "other_settings": "Other",
            "status_plugin": "Plugin",
            "status_library": "Library",
            "status_customization": "Customization",
            "status_utilities": "Utilities",
            "status_informational": "Informational",
            "status_fun": "Fun",
            "status_messages": "Messages",
            "sort_status": "By status",
            "kpm_use_md3": "MD3 containers",
            "kpm_use_md3_sub": "Use Material Design 3 style for plugin list",
            "share_view_raw": "View raw URL",
            "share_raw_title": "Raw URL",
            "share_open": "Open",
            "filter_status": "Filter",
            "filter_all": "All",
            "telemetry": "Telemetry (mkStats)",
            "telemetry_sub": "Send anonymous usage metrics",
            "logs": "Logs",
            "logs_sub": "Enable internal debug logs",
        },
        "ru": {
            "header": "Kangel Plugins Manager",
            "updates_header": "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ",
            "actions_header": "Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ",
            "author_header": "ÐÐ²Ñ‚Ð¾Ñ€",
            "auto_update": "ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð·Ð°Ð¿ÑƒÑÐºÐµ",
            "auto_update_sub": "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ",
            "auto_update_installed": "ÐÐ²Ñ‚Ð¾Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ…",
            "auto_update_installed_sub": "ÐžÐ±Ð½Ð¾Ð²Ð»ÑÑ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ",
            "refresh_list": "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "install_plugin": "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½",
            "update_plugins": "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹",
            "delete_plugin": "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½",
            "send_to_bot": "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð² Ð±Ð¾Ñ‚Ð°",
            "open_author_channel": "ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² ÐºÐ°Ð½Ð°Ð» Ð°Ð²Ñ‚Ð¾Ñ€Ð°",
            "open_forum": "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ„Ð¾Ñ€ÑƒÐ¼",
            "install_title": "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°",
            "delete_title": "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½",
            "cancel": "ÐžÑ‚Ð¼ÐµÐ½Ð°",
            "search_hint": "ÐŸÐ¾Ð¸ÑÐº...",
            "list_empty": "Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð¿ÑƒÑÑ‚",
            "no_installed": "Ð’ÑÐµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ ÑÐµÐ¹Ñ‡Ð°Ñ Ð°ÐºÑ‚ÑƒÐ°Ð»ÑŒÐ½Ð¾Ð¹ Ð²ÐµÑ€ÑÐ¸Ð¸",
            "file_not_found": "Ð¤Ð°Ð¹Ð» Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½",
            "installed": "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ {}",
            "deleted": "Ð£Ð´Ð°Ð»Ñ‘Ð½ {}",
            "error_download": "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: {}",
            "error_write": "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿Ð¸ÑÐ¸: {}",
            "error_delete": "ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ: {}",
            "updated_stats": "ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: {}, Ð±ÐµÐ· Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹: {}, Ð¾ÑˆÐ¸Ð±Ð¾Ðº: {}",
            "installing_deps": "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹...",
            "dep_installed": "Ð—Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑŒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð°: {}",
            "dep_error": "ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸: {}",
            "clear_cache": "ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ ÐºÑÑˆ",
            "cache_cleared": "ÐšÑÑˆ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½",
            "error_window": "Ð’ÑÐµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹ , Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¼ÐµÐ½ÑŽ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸",
            "install_button": "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ",
            "delete_button": "Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ",
            "version": "Ð’ÐµÑ€ÑÐ¸Ñ",
            "author": "ÐÐ²Ñ‚Ð¾Ñ€",
            "no_description": "ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¾Ñ‚ÑÑƒÑ‚ÑÑ‚Ð²ÑƒÐµÑ‚",
            "show_drawer_menu": "ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð² Ð±Ð¾ÐºÐ¾Ð²Ð¾Ð¼ Ð¼ÐµÐ½ÑŽ",
            "show_drawer_menu_sub": "ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒ Plugin Manager Ð² Ð±Ð¾ÐºÐ¾Ð²Ð¾Ð¹ Ð¿Ð°Ð½ÐµÐ»Ð¸",
            "show_add_button": "ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ '+' Ð² Ð¼ÐµÐ½ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "show_add_button_sub": "ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð² Ð¼ÐµÐ½ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "show_update_button": "ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð² Ð¼ÐµÐ½ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "show_update_button_sub": "ÐžÑ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ‚ÑŒ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð² Ð¼ÐµÐ½ÑŽ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "plugins_sort": "Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "plugins_sort_sub": "Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½Ñ‹ Ð¿Ð¾ Ð¸Ð¼ÐµÐ½Ð¸",
            "sort_none": "ÐÐµ ÑÐ¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ",
            "sort_az": "Ð-Ð¯",
            "sort_za": "Ð¯-Ð",
            "sort_author_az": "ÐŸÐ¾ Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ Ð-Ð¯",
            "sort_author_za": "ÐŸÐ¾ Ð°Ð²Ñ‚Ð¾Ñ€Ñƒ Ð¯-Ð",
            "first_run_title": "ÐžÐ±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº",
            "first_run_desc": "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð² Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ñ€Ð°Ð· Ð¼Ð¾Ð¶ÐµÑ‚ Ð·Ð°Ð½ÑÑ‚ÑŒ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ...",
            "first_run_hint": "ÐšÑÑˆ Ð±ÑƒÐ´ÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸",
            "install_dependencies": "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸",
            "install_dependencies_sub": "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿ÐµÑ€ÐµÐ´ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¾Ð¹ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°",
            "store_loaded": "Ð—Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð¾ {} Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð² Ð¸Ð· JSON ÑÑ‚Ð¾Ñ€Ð°",
            "store_load_failed": "ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ store.json",
            "share_title": "ÐŸÐ»Ð°Ð³Ð¸Ð½",
            "share_copy_link": "Ð¡ÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑÑ‹Ð»ÐºÑƒ",
            "share_send_file": "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ð² Telegram (Ð² Ð¸Ð·Ð±Ñ€Ð°Ð½Ð½Ð¾Ðµ)",
            "share_system": "ÐŸÐ¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ (ÑÐ¸ÑÑ‚ÐµÐ¼Ð½Ð¾)",
            "plugin_management": "Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°Ð¼Ð¸",
            "auto_updates": "ÐÐ²Ñ‚Ð¾-ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ",
            "ui_settings": "Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ",
            "about_plugin": "Ðž Ð¿Ð»Ð°Ð³Ð¸Ð½Ðµ",
            "open_github": "Ð ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ GitHub",
            "faq": "FAQ",
            "other_settings": "ÐŸÑ€Ð¾Ñ‡ÐµÐµ",
            "status_plugin": "ÐŸÐ»Ð°Ð³Ð¸Ð½",
            "status_library": "Ð‘Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÐ°",
            "status_customization": "ÐšÐ°ÑÑ‚Ð¾Ð¼Ð¸Ð·Ð°Ñ†Ð¸Ñ",
            "status_utilities": "Ð£Ñ‚Ð¸Ð»Ð¸Ñ‚Ñ‹",
            "status_informational": "Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ",
            "status_fun": "Ð Ð°Ð·Ð²Ð»ÐµÑ‡ÐµÐ½Ð¸Ñ",
            "status_messages": "Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ",
            "sort_status": "ÐŸÐ¾ ÑÑ‚Ð°Ñ‚ÑƒÑÑƒ",
            "kpm_use_md3": "MD3 ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ñ‹",
            "kpm_use_md3_sub": "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‚Ð¸Ð»ÑŒ Material Design 3 Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²",
            "share_view_raw": "Raw ÑÑÑ‹Ð»ÐºÐ°",
            "share_raw_title": "Raw ÑÑÑ‹Ð»ÐºÐ°",
            "share_open": "ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ",
            "filter_status": "Ð¤Ð¸Ð»ÑŒÑ‚Ñ€",
            "filter_all": "Ð’ÑÐµ",
            "telemetry": "Ð¢ÐµÐ»ÐµÐ¼ÐµÑ‚Ñ€Ð¸Ñ (mkStats)",
            "telemetry_sub": "ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÑ‚ÑŒ Ð°Ð½Ð¾Ð½Ð¸Ð¼Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ñ€Ð¸ÐºÐ¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ",
            "logs": "Ð›Ð¾Ð³Ð¸",
            "logs_sub": "Ð’ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ Ð²Ð½ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ debug-Ð»Ð¾Ð³Ð¸",
        }
    }
    return strings.get(lang, strings["en"]).get(key, key)

def _status_label(status: str):
    try:
        s = (status or "plugin").lower()
    except Exception:
        s = "plugin"
    if s == "library":
        return _tr("status_library")
    if s == "customization":
        return _tr("status_customization")
    if s == "utilities":
        return _tr("status_utilities")
    if s == "informational":
        return _tr("status_informational")
    if s == "fun":
        return _tr("status_fun")
    if s == "messages":
        return _tr("status_messages")
    return _tr("status_plugin")

def _status_sort_key(status: str):
    try:
        s = (status or "plugin").lower()
    except Exception:
        s = "plugin"
    order = {
        "library": 0,
        "customization": 1,
        "utilities": 2,
        "informational": 3,
        "messages": 4,
        "fun": 5,
    }
    return order.get(s, 99)

def open_link(url):
    fragment = get_last_fragment()
    if not fragment:
        return
    context = fragment.getParentActivity()
    if not context:
        return
    intent = Intent(Intent.ACTION_VIEW, Uri.parse(url))
    run_on_ui_thread(lambda: context.startActivity(intent))

def _get_current_account(fragment):
    try:
        return fragment.getCurrentAccount()
    except Exception:
        try:
            return fragment.currentAccount
        except Exception:
            return 0

def open_username(username):
    def go():
        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            account = _get_current_account(fragment)
            ok = False
            try:
                ok = get_messages_controller().openByUserName(username, fragment, account)
            except Exception as e:
                log(f"[KPM] openByUserName error: {e}")
            if not ok:
                try:
                    context = fragment.getParentActivity()
                    if context:
                        intent = Intent(Intent.ACTION_VIEW, Uri.parse(f"tg://resolve?domain={username}"))
                        context.startActivity(intent)
                        return
                except Exception as e2:
                    log(f"[KPM] tg://resolve fallback error: {e2}")
                open_link(f"https://t.me/{username}")
        except Exception as e:
            log(f"[KPM] open_username error: {e}")
            open_link(f"https://t.me/{username}")
    run_on_ui_thread(go)

class KPMSettingsHeaderHook:
    def __init__(self, plugin):
        self.plugin = plugin
    
    def after_hooked_method(self, param):
        try:
            activity = param.thisObject
            items = param.args[0]
            if not items or items.size() == 0:
                return
            
            plugin_obj = get_private_field(activity, "plugin")
            if not plugin_obj or str(plugin_obj.getId()) != "kangel_plugins_manager":
                return
            
            if get_private_field(activity, "createSubFragmentCallback") is not None:
                return
            
            header = self.plugin._create_settings_header(activity.getContext())
            if header:
                from com.exteragram.messenger.plugins.models import \
                    HeaderSetting
                from org.telegram.ui.Components import UItem
                item = UItem.asCustom(header)
                item.settingItem = HeaderSetting("kpm_header")
                try: 
                    item.setTransparent(True)
                except: 
                    pass
                items.add(0, item)
                items.add(1, UItem.asShadow())
        except Exception as e:
            log(f"[KPM] Error in settings header hook: {e}")

class KangelPluginsManager(BasePlugin):
    def __init__(self):
        super().__init__()
        global _kpm_instance
        _kpm_instance = self
        self.store_json_urls = [
            "https://raw.githubusercontent.com/KangelPlugins/Plugins-Store/refs/heads/main/store.json",
            "https://raw.githubusercontent.com/KangelPlugins/Plugins-Store/main/store.json",
        ]
        self.github_api_url = "https://api.github.com/repos/KangelPlugins/Plugins-Store/commits/main"
        self.cache_file = os.path.join(PLUGINS_DIR, ".kpm_cache.json")
        self.plugins_list = {}
        self.plugin_names_cache = {}
        self._install_dialog_views_cache = {}
        self._trigram_index = {}
        self._search_text_cache = {}
        self.auto_update = True
        self.load_cache()
        try:
            run_on_queue(lambda: self._mkstats_ping_if_needed())
        except Exception:
            pass

    def has_settings(self):
        return True

    def _open_faq(self, *_):
        try:
            lang = str(LocaleController.getInstance().getCurrentLocale().getLanguage())
        except Exception:
            lang = "en"
        if lang == "ru":
            open_link("https://t.me/KangelPluginsManager/166/172")
        else:
            open_link("https://t.me/KangelPluginsManager/166/6441")

    def create_settings(self):
        return [
            Header(text=_tr("header")),
            Text(
                text=_tr("plugin_management"),
                icon="msg_addbot",
                create_sub_fragment=self._create_plugin_management_settings
            ),
            Text(
                text=_tr("auto_updates"),
                icon="files_storage",
                create_sub_fragment=self._create_auto_updates_settings
            ),
            Text(
                text=_tr("ui_settings"),
                icon="msg_theme",
                create_sub_fragment=self._create_ui_settings
            ),
            Text(
                text=_tr("other_settings"),
                icon="msg_info",
                create_sub_fragment=self._create_other_settings
            ),
            Text(
                text=_tr("about_plugin"),
                icon="mentionbutton",
                create_sub_fragment=self._create_about_settings
            )
        ]
    
    def _create_plugin_management_settings(self):
        return [
            Header(text=_tr("actions_header")),
            Text(
                text=_tr("refresh_list"),
                icon="msg_download",
                on_click=lambda _: run_on_queue(lambda: self.refresh_store())
            ),
            Text(
                text=_tr("install_plugin"),
                icon="msg_addbot",
                on_click=lambda _: self.open_install_dialog()
            ),
            Text(
                text=_tr("update_plugins"),
                icon="menu_browser_refresh",
                on_click=lambda _: self.open_update_dialog()
            ),
            Text(
                text=_tr("delete_plugin"),
                icon="msg_delete",
                on_click=lambda _: self.open_delete_dialog()
            ),
            Text(
                text=_tr("clear_cache"),
                icon="msg_clear",
                on_click=lambda _: run_on_queue(lambda: self.clear_cache())
            )
        ]
    
    def _create_builds_settings(self):
        try:
            builds = self._list_builds()
            log(f"[KPM] Creating builds settings, found {len(builds)} builds")
            
            def safe_create_build_dialog(v):
                try:
                    log("[KPM] Create build dialog clicked, button pressed")
                    self._show_create_build_dialog()
                except Exception as e:
                    log(f"[KPM] Error in create build dialog: {e}")
                    import traceback
                    log(f"[KPM] Traceback: {traceback.format_exc()}")
                    try:
                        run_on_ui_thread(lambda: BulletinHelper.show_error(f"ÐžÑˆÐ¸Ð±ÐºÐ°: {e}"))
                    except:
                        pass
            
            settings = [
                Header(text=_tr("builds_header")),
                Text(
                    text=_tr("create_build"),
                    icon="msg_saved",
                    on_click=safe_create_build_dialog
                )
            ]
            
            if builds:
                settings.append(Divider())
                for build_name in sorted(builds):
                    def make_load_handler(name):
                        def handler(v):
                            try:
                                log(f"[KPM] Loading build: {name}")
                                self._load_build(name)
                            except Exception as e:
                                log(f"[KPM] Error loading build {name}: {e}")
                                import traceback
                                log(f"[KPM] Traceback: {traceback.format_exc()}")
                                run_on_ui_thread(lambda: BulletinHelper.show_error(f"ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸: {e}"))
                        return handler
                    
                    def make_delete_handler(name):
                        def handler(v):
                            try:
                                log(f"[KPM] Delete build dialog for: {name}")
                                self._show_delete_build_dialog(name)
                            except Exception as e:
                                log(f"[KPM] Error showing delete dialog for {name}: {e}")
                                import traceback
                                log(f"[KPM] Traceback: {traceback.format_exc()}")
                                run_on_ui_thread(lambda: BulletinHelper.show_error(f"ÐžÑˆÐ¸Ð±ÐºÐ°: {e}"))
                        return handler
                    
                    settings.append(
                        Text(
                            text=f"ðŸ“¦ {build_name}",
                            on_click=make_load_handler(build_name),
                            on_long_click=make_delete_handler(build_name)
                        )
                    )
            else:
                settings.append(
                    Text(
                        text=_tr("no_builds"),
                        accent=False
                    )
                )
            
            return settings
        except Exception as e:
            log(f"[KPM] Error in _create_builds_settings: {e}")
            import traceback
            log(f"[KPM] Traceback: {traceback.format_exc()}")
            return [
                Header(text=_tr("builds_header")),
                Text(
                    text="ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸",
                    subtext=f"ÐžÑˆÐ¸Ð±ÐºÐ°: {e}",
                    on_click=lambda _: run_on_ui_thread(lambda: BulletinHelper.show_error(f"ÐžÑˆÐ¸Ð±ÐºÐ°: {e}"))
                )
            ]
    
    def _create_auto_updates_settings(self):
        return [
            Header(text=_tr("updates_header")),
            Switch(
                key="auto_update_on_start",
                text=_tr("auto_update"),
                default=False,
                icon="files_storage",
                subtext=_tr("auto_update_sub")
            ),
            Switch(
                key="auto_update_installed",
                text=_tr("auto_update_installed"),
                default=False,
                icon="avd_flip",
                subtext=_tr("auto_update_installed_sub")
            )
        ]
    
    def _create_ui_settings(self):
        return [
            Header(text=_tr("ui_settings")),
            Switch(
                key="show_drawer_menu",
                text=_tr("show_drawer_menu"),
                default=True,
                icon="msg_addbot",
                subtext=_tr("show_drawer_menu_sub"),
                on_change=lambda v: self._update_drawer_menu()
            ),
            Switch(
                key="show_add_button",
                text=_tr("show_add_button"),
                default=True,
                icon="msg_add",
                subtext=_tr("show_add_button_sub")
            ),
            Switch(
                key="show_update_button",
                text=_tr("show_update_button"),
                default=True,
                icon="menu_browser_refresh",
                subtext=_tr("show_update_button_sub")
            ),
            Switch(
                key="kpm_use_md3",
                text=_tr("kpm_use_md3"),
                default=True,
                icon="avd_flip",
                subtext=_tr("kpm_use_md3_sub")
            ),
        ]

    def _create_other_settings(self):
        return [
            Header(text=_tr("other_settings")),
            Switch(
                key="telemetry_enabled",
                text=_tr("telemetry"),
                default=True,
                icon="menu_2sv_on",
                subtext=_tr("telemetry_sub")
            ),
            Switch(
                key="logs_enabled",
                text=_tr("logs"),
                default=True,
                icon="msg_info",
                subtext=_tr("logs_sub")
            ),
            Divider(),
            Text(
                text=_tr("faq"),
                icon="msg_info",
                on_click=lambda _: self._open_faq()
            ),
        ]
    
    def _update_drawer_menu(self):
        try:
            self.remove_menu_item(MenuItemType.DRAWER_MENU, "Plugin Manager")
            self.add_drawer_menu_item()
        except Exception as e:
            log(f"[KPM] Error updating drawer menu: {e}")
    
    def _create_about_settings(self):
        return [
            Header(text=_tr("author_header")),
            Text(
                text=_tr("open_author_channel"),
                icon="input_smile_solar",
                on_click=lambda _: open_username("KangelPlugins")
            ),
            Text(
                text=_tr("open_forum"),
                icon="msg_groups_solar",
                on_click=lambda _: open_username("KangelPluginsManager")
            ),
            Text(
                text=_tr("send_to_bot"),
                icon="msg_forward",
                on_click=lambda _: open_username("KPMAppealBot")
            ),
            Text(
                text=_tr("open_github"),
                icon="msg_link",
                on_click=lambda _: open_link("https://github.com/KangelPlugins/Plugins-Store")
            ),
            Divider(),
            Text(
                text=self._get_plugin_info_text(),
                icon="info",
                on_click=lambda _: self._show_about_dialog()
            )
        ]
    
    def _setup_settings_header_hook(self):
        try:
            PSA = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
            if not PSA:
                return
            method = PSA.getClass().getDeclaredMethod("fillItems", find_class("java.util.ArrayList"), find_class("org.telegram.ui.Components.UniversalAdapter"))
            method.setAccessible(True)
            self.hook_settings_header_ref = self.hook_method(method, KPMSettingsHeaderHook(self))
        except Exception as e:
            log(f"[KPM] Error setting up settings header hook: {e}")
    
    def _create_settings_header(self, context):
        try:
            from android.util import TypedValue
            from android.view import Gravity
            from android.widget import FrameLayout, LinearLayout, TextView
            from org.telegram.messenger import (AndroidUtilities,
                                                ImageLocation,
                                                MediaDataController)
            from org.telegram.ui.ActionBar import Theme
            from org.telegram.ui.Components import (BackupImageView,
                                                    LayoutHelper)
            
            container = FrameLayout(context)
            main_layout = LinearLayout(context)
            main_layout.setOrientation(LinearLayout.HORIZONTAL)
            main_layout.setGravity(Gravity.CENTER_VERTICAL)
            main_layout.setPadding(AndroidUtilities.dp(20), AndroidUtilities.dp(20), AndroidUtilities.dp(20), AndroidUtilities.dp(20))
            
            imageView = BackupImageView(context)
            imageView.setRoundRadius(0)
            
            def try_load_sticker(img):
                try:
                    icon_parts = __icon__.split("/")
                    if len(icon_parts) == 2:
                        sticker_set_name = icon_parts[0]
                        sticker_index = int(icon_parts[1])
                        ss = MediaDataController.getInstance(0).getStickerSetByName(sticker_set_name) or MediaDataController.getInstance(0).getStickerSetByEmojiOrName(sticker_set_name)
                        if ss and ss.documents and ss.documents.size() > sticker_index:
                            img.setImage(ImageLocation.getForDocument(ss.documents.get(sticker_index)), "72_72", None, None, 0, 1)
                            return True
                except:
                    pass
                return False
            
            if not try_load_sticker(imageView):
                try:
                    icon_parts = __icon__.split("/")
                    if len(icon_parts) == 2:
                        sticker_set_name = icon_parts[0]
                        MediaDataController.getInstance(0).loadStickersByEmojiOrName(sticker_set_name, False, False)
                        run_on_ui_thread(lambda: try_load_sticker(imageView), 1500)
                except:
                    pass
            
            main_layout.addView(imageView, LayoutHelper.createLinear(72, 72, 0, 0, 16, 0))
            
            text_container = LinearLayout(context)
            text_container.setOrientation(LinearLayout.VERTICAL)
            text_container.setGravity(Gravity.CENTER_VERTICAL)
            
            title = TextView(context)
            title.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
            title.setTypeface(AndroidUtilities.getTypeface(AndroidUtilities.TYPEFACE_ROBOTO_MEDIUM))
            title.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18)
            title.setText(f"{__name__} {__version__}")
            title.setSingleLine(True)
            title.setGravity(Gravity.START)
            text_container.addView(title, LayoutHelper.createLinear(-1, -2, 0, 0, 4, 0))
            
            lang = _get_lang()
            plugin_count = len(self.plugins_list) if self.plugins_list else 0
            if lang == "ru":
                subtitle_text = f"ÐŸÐµÑ€Ð²Ñ‹Ð¹ Ð¿Ð»Ð°Ð³Ð¸Ð½ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ð»Ð°Ð³Ð¸Ð½Ð°Ð¼Ð¸ Ñ‡ÐµÑ€ÐµÐ· GUI â€¢  {plugin_count} Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²"
            else:
                subtitle_text = f"First plugin for managing plugins through GUI â€¢ {plugin_count} plugins"
            
            subtitle = TextView(context)
            subtitle.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText))
            subtitle.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            subtitle.setText(subtitle_text)
            subtitle.setGravity(Gravity.START)
            text_container.addView(subtitle, LayoutHelper.createLinear(-1, -2))
            
            main_layout.addView(text_container, LayoutHelper.createLinear(0, -2, 1.0))
            container.addView(main_layout, LayoutHelper.createFrame(-1, -2, Gravity.TOP | Gravity.START, 0, 0, 0, 0))
            
            return container
        except Exception as e:
            log(f"[KPM] Error creating settings header: {e}")
            return None
    
    def _get_plugin_info_text(self):

        plugin_count = len(self.plugins_list) if self.plugins_list else 0
        lang = _get_lang()
        if lang == "ru":
            return f"KPM v{__version__} â€¢ {plugin_count} Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²"
        else:
            return f"KPM v{__version__} â€¢ {plugin_count} plugins"
    
    def _show_about_dialog(self):

        try:
            fragment = get_last_fragment()
            if not fragment:
                return
            
            context = fragment.getParentActivity()
            if not context:
                return
            
            plugin_count = len(self.plugins_list) if self.plugins_list else 0
            installed_count = len(self.list_installed_plugins())
            lang = _get_lang()
            
            bottom_sheet = BottomSheet(context, False, fragment.getResourceProvider())
            bottom_sheet.setApplyBottomPadding(False)
            bottom_sheet.setApplyTopPadding(False)
            bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
            
            linear_layout = LinearLayout(context)
            linear_layout.setOrientation(LinearLayout.VERTICAL)
            linear_layout.setClickable(True)
            
            frame_layout = FrameLayout(context)
            frame_layout.addView(linear_layout)
            
            scroll_view = NestedScrollView(context)
            scroll_view.addView(frame_layout)
            bottom_sheet.setCustomView(scroll_view)
            close_view = ImageView(context)
            close_view.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_listSelector)))
            close_view.setColorFilter(Theme.getColor(Theme.key_sheet_other))
            close_view.setImageResource(R_tg.drawable.ic_layer_close)
            OnClickInterface = find_class("android.view.View$OnClickListener")
            OnClick = dynamic_proxy(OnClickInterface)
            class CloseClickImpl(OnClick):
                def __init__(self, bottom_sheet):
                    super().__init__()
                    self.bottom_sheet = bottom_sheet
                def onClick(self, v):
                    self.bottom_sheet.dismiss()
            close_view.setOnClickListener(CloseClickImpl(bottom_sheet))
            close_padding = AndroidUtilities.dp(8)
            close_view.setPadding(close_padding, close_padding, close_padding, close_padding)
            frame_layout.addView(close_view, LayoutHelper.createFrame(36, 36, Gravity.TOP | Gravity.END, 6, 8, 8, 0))

            sticker_image_view = BackupImageView(context)
            sticker_image_view.setRoundRadius(0)
            sticker_image_view.getImageReceiver().setCrossfadeWithOldImage(True)
            linear_layout.addView(sticker_image_view, LayoutHelper.createLinear(90, 90, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 0, 27, 0, 0))

            try:
                current_account = 0
                try:
                    current_account = fragment.getCurrentAccount()
                except Exception:
                    current_account = 0

                media_controller = MediaDataController.getInstance(current_account)
                sticker_set = media_controller.getStickerSetByName("Rain_Stickers_Set")
                if sticker_set and sticker_set.documents and sticker_set.documents.size() > 2:
                    sticker_document = sticker_set.documents.get(2)
                    image_location = ImageLocation.getForDocument(sticker_document)
                    sticker_image_view.setImage(image_location, "90_90", None, 0, sticker_document)
                    log("[KPM] Sticker loaded from cache: LostChocolateFlamingo_by_fStikBot/74")
                else:
                    log("[KPM] Sticker cache miss, requesting set")
                    try:
                        input_set = TLRPC.TL_inputStickerSetShortName()
                        input_set.short_name = "Rain_Stickers_Set"

                        def _on_set_response(result):
                            try:
                                if result and result.documents and result.documents.size() > 2:
                                    doc = result.documents.get(2)
                                    img_loc = ImageLocation.getForDocument(doc)
                                    run_on_ui_thread(lambda: sticker_image_view.setImage(img_loc, "90_90", None, 0, doc))
                                    log("[KPM] Sticker loaded after fetch: LostChocolateFlamingo_by_fStikBot/74")
                            except Exception as _e_inner:
                                log(f"[KPM] Error applying fetched sticker: {_e_inner}")

                        class Callback1(dynamic_proxy(Utilities.Callback)):
                            def __init__(self, fn):
                                super().__init__()
                                self._fn = fn
                            def run(self, arg):
                                try:
                                    self._fn(arg)
                                except Exception as e:
                                    log(f"[KPM] Callback error: {str(e)}")

                        media_controller.getStickerSet(input_set, None, False, Callback1(_on_set_response))
                    except Exception as _e_fetch:
                        log(f"[KPM] Error requesting sticker set 'Rain_Stickers_Set': {_e_fetch}")
            except Exception as e:
                pass
            

            title_text_view = SimpleTextView(context)
            title_text_view.setTypeface(AndroidUtilities.bold())
            title_text_view.setTextSize(20)
            title_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            title_text = "Kangel Plugins Manager"
            
            title_text_view.setText(title_text)
            title_text_view.setGravity(Gravity.CENTER)
            linear_layout.addView(title_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 27, 10, 0))

            version_text = TextView(context)
            version_text.setGravity(Gravity.CENTER)
            version_text.setText(f"{__version__} | 'Angel Yamu'")
            version_text.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
            version_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            linear_layout.addView(version_text, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 4, 24, 0))

            info_text = TextView(context)
            info_text.setGravity(Gravity.CENTER)
            if lang == "ru":
                info_lines = [
                    "-Ð“Ñ€ÑƒÑÑ‚Ð½Ð¾ ÐšÐ°Ð½Ð³ÐµÐ» ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ \n-Ð§ÐµÐ»Ð¾Ð²ÐµÐº Ð¾Ð±Ð¾Ð¸ ÑÐºÐ°Ñ‡Ð°Ñ‚ÑŒ... Ð•Ð‘Ð›ÐÐ"
                ]
            else:
                    info_lines = [
                    "-Sad Kangel download \n-Man wallpaper download... BLYAT"
                ]
            info_text.setText("\n".join(info_lines))
            info_text.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            info_text.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            linear_layout.addView(info_text, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 20, 24, 20))
            
            bottom_sheet.show()
            log("[KPM] About dialog shown (easter egg)")
        except Exception as e:
            log(f"[KPM] Error showing about dialog: {e}")
            log(traceback.format_exc())

    def on_plugin_load(self):
        self._mkstats_start()
        self.add_on_send_message_hook()
        self.add_deeplink_hook()
        self.add_drawer_menu_item()
        self.add_install_sheet_hook()
        self.add_plugins_activity_hook()
        self._setup_settings_header_hook()
        if self.get_setting("auto_update_on_start", False): run_on_queue(self.refresh_store)
        if self.get_setting("auto_update_installed", False): run_on_queue(self.update_installed_from_store)
        self.search_listener_hooks = None

    def on_plugin_unload(self):
        if hasattr(self, "_mkstats_stop"):
            self._mkstats_stop.set()
            self._mkstats_log("mkStats: stop requested")
            try:
                if hasattr(self, "_mkstats_thread") and self._mkstats_thread is not None:
                    self._mkstats_thread.join(timeout=1.0)
            except Exception:
                pass
        self.remove_hook("on_send_message_hook")
    
    def add_drawer_menu_item(self):
        try:
            if self.get_setting("show_drawer_menu", True):
                self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.DRAWER_MENU,
                    text="Plugin Manager",
                    icon="msg_addbot",
                    on_click=lambda ctx: self.open_settings_page()
                ))
                log("[KPM] Drawer menu item added")
            else:
                log("[KPM] Drawer menu disabled in settings")
        except Exception as e:
            log(f"[KPM] Error adding drawer menu: {e}")
    
    def open_settings_page(self):
        try:
            
            java_plugin = PluginsController.getInstance().plugins.get(self.id)
            fragment = get_last_fragment()
            if java_plugin and fragment:
                run_on_ui_thread(lambda: fragment.presentFragment(PluginSettingsActivity(java_plugin)))
            else:
                log("[KPM] Could not open settings - plugin or fragment is None")
        except Exception as e:
            log(f"[KPM] Error opening settings: {e}")
    
    def add_deeplink_hook(self):
        try:
            
            class KPMDeeplinkHook:
                def __init__(self, plugin):
                    self.plugin = plugin
                
                def before_hooked_method(self, param):
                    try:
                        if len(param.args) < 1:
                            return
                        intent = param.args[0]
                        if not intent or intent.getAction() != "android.intent.action.VIEW":
                            return
                        data = intent.getData()
                        if not data:
                            return
                        url = str(data)
                        
                        if url.startswith("tg://kpm_install"):
                            uri = Uri.parse(url)
                            plugin_id = uri.getQueryParameter("plugin")
                            if plugin_id:
                                log(f"[KPM] Deep link install: {plugin_id}")
                                run_on_ui_thread(lambda: self.plugin.show_plugin_info_and_install(plugin_id))
                                param.setResult(None)
                        elif url.startswith("tg://kpm_list"):
                            log(f"[KPM] Deep link refresh list")
                            run_on_queue(lambda: self.plugin.refresh_store(force=True))
                            param.setResult(None)
                    except Exception as e:
                        log(f"[KPM] Error in deeplink hook: {e}")
                
                def after_hooked_method(self, param):
                    pass
            
            LaunchActivity = find_class("org.telegram.ui.LaunchActivity")
            if LaunchActivity:
                method = LaunchActivity.getClass().getDeclaredMethod("handleIntent",
                    find_class("android.content.Intent").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("org.telegram.messenger.browser.Browser$Progress").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE)
                method.setAccessible(True)
                self.hook_method(method, KPMDeeplinkHook(self))
                log("[KPM] Deeplink hook installed successfully")
        except Exception as e:
            log(f"[KPM] Error adding deeplink hook: {e}")
            log(traceback.format_exc())
    
    def add_install_sheet_hook(self):
        try:
            from base_plugin import MethodHook
            
            class InstallSheetHook(MethodHook):
                def __init__(self, plugin):
                    self.plugin = plugin
                
                def after_hooked_method(self, param):
                    def to_java_color(hex_val):
                        val = int(hex_val)
                        if val > 0x7FFFFFFF:
                            val -= 0x100000000
                        return val
                    
                    def modify_ui():
                        try:
                            sheet = param.thisObject
                            install_params = param.args[2]
                            
                            if not sheet or not install_params:
                                return
                            
                            file_path = None
                            try:
                                path_field = install_params.getClass().getDeclaredField("filePath")
                                path_field.setAccessible(True)
                                file_path = path_field.get(install_params)
                            except Exception as e:
                                log(f"[KPM] Error getting file path: {e}")
                                return
                            
                            if not file_path:
                                return
                            
                            file_path_str = str(file_path)

                            dependencies = self.plugin._get_dependencies_from_file(file_path_str)
                            if not dependencies:
                                filename = os.path.basename(file_path_str)
                                plugin_id_from_file = filename.replace('.plugin', '').replace('.py', '').strip()
                                if plugin_id_from_file.startswith('.temp_'):
                                    plugin_id_from_file = plugin_id_from_file.replace('.temp_', '')
                                if plugin_id_from_file:
                                    pid_lower = plugin_id_from_file.lower()
                                    matched = next((k for k in self.plugin.plugins_list if k.lower() == pid_lower), None)
                                    if matched:
                                        plugin_info = self.plugin.plugins_list[matched]
                                        if isinstance(plugin_info, dict):
                                            dependencies = plugin_info.get("dependencies", [])
                                        log(f"[KPM] Got dependencies from store for {matched}: {dependencies}")
                            if dependencies:
                                log(f"[KPM] Found dependencies: {dependencies}")

                            custom_view = None
                            try:
                                curr_cls = sheet.getClass()
                                while curr_cls is not None:
                                    try:
                                        f = curr_cls.getDeclaredField("customView")
                                        f.setAccessible(True)
                                        custom_view = f.get(sheet)
                                        if custom_view:
                                            break
                                    except:
                                        pass
                                    curr_cls = curr_cls.getSuperclass()
                            except:
                                pass
                            
                            if not custom_view:
                                try:
                                    f = sheet.getClass().getSuperclass().getDeclaredField("containerView")
                                    f.setAccessible(True)
                                    custom_view = f.get(sheet)
                                except:
                                    pass
                            
                            if not custom_view:
                                return

                            ButtonWithCounterView = find_class("org.telegram.ui.Stories.recorder.ButtonWithCounterView")
                            ViewGroup = find_class("android.view.ViewGroup")
                            LinearLayout = find_class("android.widget.LinearLayout")
                            Theme = find_class("org.telegram.ui.ActionBar.Theme")
                            AndroidUtilities = find_class("org.telegram.messenger.AndroidUtilities")
                            LayoutHelper = find_class("org.telegram.ui.Components.LayoutHelper")

                            install_btn = None
                            parent_layout = None
                            
                            def scan_view(view, depth=0):
                                nonlocal install_btn, parent_layout
                                if not view:
                                    return
                                
                                if isinstance(view, ButtonWithCounterView):
                                    try:
                                        btn_text = str(view.getText())
                                        if btn_text and ("Install" in btn_text or "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" in btn_text or "Update" in btn_text or "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ" in btn_text):
                                            if not install_btn:  
                                                install_btn = view
                                                parent_layout = view.getParent()
                                                log(f"[KPM] Found install button: {btn_text}")
                                    except:
                                        if not install_btn:
                                            install_btn = view
                                            parent_layout = view.getParent()
                                
                                if isinstance(view, ViewGroup):
                                    count = view.getChildCount()
                                    for i in range(count):
                                        scan_view(view.getChildAt(i), depth + 1)
                            
                            scan_view(custom_view)
                            
                            if not install_btn:
                                log("[KPM] Install button not found in dialog")
                                return
                            
                            if not parent_layout:
                                log("[KPM] Parent layout not found for install button")
                                return
                            
                            context = sheet.getContext()
                            resources_provider = None
                            try:
                                curr_cls = sheet.getClass()
                                while curr_cls is not None:
                                    try:
                                        m = curr_cls.getDeclaredMethod("getResourceProvider")
                                        m.setAccessible(True)
                                        resources_provider = m.invoke(sheet)
                                        if resources_provider:
                                            break
                                    except:
                                        pass
                                    curr_cls = curr_cls.getSuperclass()
                            except:
                                pass
                            
                            if dependencies:
                                log(f"[KPM] Adding dependencies button")
                                deps_btn = ButtonWithCounterView(context, True, resources_provider)
                                deps_btn.setText(_tr("install_dependencies"), False)
                                if resources_provider:
                                    deps_color = Theme.getColor(Theme.key_featuredStickers_addButton, resources_provider)
                                    deps_pressed = Theme.getColor(Theme.key_featuredStickers_addButtonPressed, resources_provider)
                                else:
                                    deps_color = to_java_color(0xFF4CAF50)
                                    deps_pressed = to_java_color(0xFF388E3C)
                                deps_bg = Theme.createSimpleSelectorRoundRectDrawable(
                                    AndroidUtilities.dp(8),
                                    deps_color,
                                    deps_pressed
                                )
                                deps_btn.setBackground(deps_bg)
                                OnClickListener = find_class("android.view.View$OnClickListener")
                                class DepsClickListener(dynamic_proxy(OnClickListener)):
                                    def __init__(self, plugin_instance, deps_list):
                                        super().__init__()
                                        self.plugin_instance = plugin_instance
                                        self.deps_list = deps_list
                                    def onClick(self, v):
                                        run_on_queue(lambda: self._install_dependencies())
                                    def _install_dependencies(self):
                                        def show_dialog(title, message):
                                            try:
                                                fragment = get_last_fragment()
                                                if not fragment:
                                                    return
                                                activity = fragment.getParentActivity()
                                                if not activity:
                                                    return
                                                builder = AlertDialogBuilder(activity)
                                                builder.set_title(title)
                                                builder.set_message(message)
                                                builder.set_positive_button("OK" if _get_lang() != "ru" else "ÐžÐš", lambda d, w: d.dismiss())
                                                builder.set_cancelable(True)
                                                builder.show()
                                            except Exception as e:
                                                log(f"[KPM] Error showing dialog: {e}")
                                        try:
                                            success_count = 0
                                            failed_count = 0
                                            failed_deps = []
                                            for dep_id in self.deps_list:
                                                try:
                                                    log(f"[KPM] Installing dependency: {dep_id}")
                                                    self.plugin_instance.install_plugin_by_id(dep_id, enable_after=True)
                                                    log(f"[KPM] Successfully installed dependency: {dep_id}")
                                                    success_count += 1
                                                except Exception as e:
                                                    failed_count += 1
                                                    failed_deps.append(dep_id)
                                                    log(f"[KPM] ERROR installing dependency {dep_id}: {e}")
                                            lang = _get_lang()
                                            result_lines = []
                                            for dep_id in self.deps_list:
                                                dep_name = self.plugin_instance.get_plugin_display_name(dep_id)
                                                display_name = dep_name if dep_name != dep_id else dep_id
                                                if dep_id in failed_deps:
                                                    result_lines.append(f"âŒ {display_name}")
                                                else:
                                                    result_lines.append(f"âœ… {display_name}")
                                            if lang == "ru":
                                                if failed_count == 0:
                                                    final_title = "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°"
                                                    final_msg = f"âœ… Ð’ÑÐµ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ ({success_count}/{len(self.deps_list)})\n\n" + "\n".join(result_lines)
                                                else:
                                                    final_title = "Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°Ð¼Ð¸"
                                                    final_msg = f"Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: {success_count}/{len(self.deps_list)}\nÐžÑˆÐ¸Ð±Ð¾Ðº: {failed_count}\n\n" + "\n".join(result_lines)
                                            else:
                                                if failed_count == 0:
                                                    final_title = "Installation complete"
                                                    final_msg = f"âœ… All dependencies installed ({success_count}/{len(self.deps_list)})\n\n" + "\n".join(result_lines)
                                                else:
                                                    final_title = "Installation completed with errors"
                                                    final_msg = f"Installed: {success_count}/{len(self.deps_list)}\nErrors: {failed_count}\n\n" + "\n".join(result_lines)
                                            run_on_ui_thread(lambda t=final_title, m=final_msg: show_dialog(t, m))
                                        except Exception as e:
                                            log(f"[KPM] Error in _install_dependencies: {e}")
                                            lang = _get_lang()
                                            if lang == "ru":
                                                error_title = "ÐžÑˆÐ¸Ð±ÐºÐ°"
                                                error_msg = f"ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹:\n{str(e)[:200]}"
                                            else:
                                                error_title = "Error"
                                                error_msg = f"Dependency installation error:\n{str(e)[:200]}"
                                            run_on_ui_thread(lambda t=error_title, m=error_msg: show_dialog(t, m))
                                deps_btn.setOnClickListener(DepsClickListener(self.plugin, dependencies))
                                try:
                                    install_btn.setText(_tr("install_button"), False)
                                except:
                                    pass
                                idx = -1
                                for i in range(parent_layout.getChildCount()):
                                    if parent_layout.getChildAt(i) == install_btn:
                                        idx = i
                                        break
                                if idx >= 0:
                                    try:
                                        old_lp = install_btn.getLayoutParams()
                                        if isinstance(old_lp, LinearLayout.LayoutParams):
                                            old_lp.topMargin = AndroidUtilities.dp(16)
                                            old_lp.bottomMargin = 0
                                            install_btn.setLayoutParams(old_lp)
                                            deps_lp = LinearLayout.LayoutParams(old_lp)
                                            deps_lp.topMargin = AndroidUtilities.dp(8)
                                            deps_lp.bottomMargin = AndroidUtilities.dp(8)
                                            parent_layout.addView(deps_btn, idx, deps_lp)
                                            log("[KPM] Dependencies button added to install dialog")
                                        else:
                                            parent_layout.addView(deps_btn, idx, LayoutHelper.createLinear(-1, 48, 0, 16, 28, 8, 0))
                                            log("[KPM] Dependencies button added to install dialog (fallback)")
                                    except Exception as e:
                                        log(f"[KPM] Error adding dependencies button: {e}")
                                        try:
                                            parent_layout.addView(deps_btn, idx, LayoutHelper.createLinear(-1, 48, 0, 16, 28, 8, 0))
                                            log("[KPM] Dependencies button added (simple fallback)")
                                        except Exception as e2:
                                            log(f"[KPM] Failed to add button: {e2}")
                            filename = os.path.basename(file_path_str)
                            plugin_id_raw = filename.replace(".plugin", "").replace(".py", "").strip()
                            if plugin_id_raw.startswith(".temp_"):
                                plugin_id_raw = plugin_id_raw.replace(".temp_", "")
                            status = "plugin"
                            if plugin_id_raw:
                                plugin_id_lower = plugin_id_raw.lower()
                                matched_key = next((k for k in self.plugin.plugins_list if k.lower() == plugin_id_lower), None)
                                if matched_key:
                                    plugin_info = self.plugin.plugins_list.get(matched_key)
                                    if isinstance(plugin_info, dict):
                                        status = plugin_info.get("status", "plugin")
                            status_label = _status_label(status)
                            try:
                                from android.util import TypedValue
                                from android.view import Gravity
                                TextView = find_class("android.widget.TextView")
                                status_container = None
                                trusted_insert_index = None
                                if isinstance(custom_view, ViewGroup) and custom_view.getChildCount() > 0:
                                    first_child = custom_view.getChildAt(0)
                                    if isinstance(first_child, ViewGroup):
                                        status_container = first_child
                                        def find_trusted_view(view, depth=0):
                                            nonlocal trusted_insert_index
                                            if not view or depth > 15:
                                                return
                                            try:
                                                if isinstance(view, TextView):
                                                    txt = str(view.getText() or "")
                                                    if "rust" in txt or "Ð¾Ð²ÐµÑ€ÐµÐ½" in txt or "rust" in txt.lower() or "trusted" in txt.lower():
                                                        p = view.getParent()
                                                        if isinstance(p, ViewGroup):
                                                            for i in range(p.getChildCount()):
                                                                if p.getChildAt(i) == view:
                                                                    trusted_insert_index = (p, i)
                                                                    return
                                                            trusted_insert_index = (p, 0)
                                                        return
                                            except Exception:
                                                pass
                                            if isinstance(view, ViewGroup):
                                                for i in range(view.getChildCount()):
                                                    find_trusted_view(view.getChildAt(i), depth + 1)
                                                    if trusted_insert_index:
                                                        return
                                        find_trusted_view(status_container)
                                pill_bg_color = Theme.getColor(Theme.key_dialogSearchBackground, resources_provider) if resources_provider else Theme.getColor(Theme.key_dialogSearchBackground)
                                pill_drawable = Theme.createRoundRectDrawable(AndroidUtilities.dp(8), pill_bg_color)
                                pill_layout = LinearLayout(sheet.getContext())
                                pill_layout.setOrientation(LinearLayout.HORIZONTAL)
                                pill_layout.setGravity(Gravity.CENTER)
                                pill_layout.setBackground(pill_drawable)
                                pill_layout.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(6), AndroidUtilities.dp(12), AndroidUtilities.dp(6))
                                status_tv = TextView(sheet.getContext())
                                if resources_provider:
                                    status_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack, resources_provider))
                                else:
                                    status_tv.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                                status_tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
                                status_tv.setText(status_label)
                                status_tv.setGravity(Gravity.CENTER)
                                pill_layout.addView(status_tv, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL))
                                # fixed by @AGeekApple
                                pill_lp = LayoutHelper.createLinear(-2, -2, 0, 16, 8, 16, 8)
                                if status_container is not None and trusted_insert_index is not None:
                                    trusted_parent, idx = trusted_insert_index
                                    try:
                                        ref_idx = idx if idx < trusted_parent.getChildCount() else max(0, trusted_parent.getChildCount() - 1)
                                        ref_view = trusted_parent.getChildAt(ref_idx)
                                        ref_lp = ref_view.getLayoutParams() if ref_view else None
                                        if ref_lp is not None:
                                            try:
                                                LinearLayoutLayoutParams = find_class("android.widget.LinearLayout$LayoutParams")
                                                if LinearLayoutLayoutParams and isinstance(ref_lp, LinearLayoutLayoutParams):
                                                    cloned_lp = LinearLayoutLayoutParams(ref_lp)
                                                    pill_lp = cloned_lp
                                            except Exception:
                                                pass
                                    except Exception:
                                        pass
                                    trusted_parent.addView(pill_layout, idx, pill_lp)
                                    log(f"[KPM] Status pill added before trusted: {status_label}")
                                elif status_container is not None:
                                    status_container.addView(pill_layout, 0, pill_lp)
                                    log(f"[KPM] Status pill added at top: {status_label}")
                                else:
                                    parent_layout.addView(pill_layout, pill_lp)
                                    log(f"[KPM] Status pill added: {status_label}")
                            except Exception as status_err:
                                log(f"[KPM] Could not add status pill: {status_err}")
                        
                        except Exception as e:
                            log(f"[KPM] Error modifying install sheet UI: {e}")
                            log(traceback.format_exc())
                    Handler = find_class("android.os.Handler")
                    Looper = find_class("android.os.Looper")
                    Runnable = find_class("java.lang.Runnable")
                    
                    class ModifyUIRunnable(dynamic_proxy(Runnable)):
                        def __init__(self):
                            super().__init__()
                        
                        def run(self):
                            modify_ui()
                    
                    handler = Handler(Looper.getMainLooper())
                    handler.postDelayed(ModifyUIRunnable(), 100)
            

            try:
                JavaClass = find_class("java.lang.Class")
                SheetClassJava = JavaClass.forName("com.exteragram.messenger.plugins.ui.components.InstallPluginBottomSheet")
            except Exception:
                SheetClassWrapper = find_class("com.exteragram.messenger.plugins.ui.components.InstallPluginBottomSheet")
                if SheetClassWrapper:
                    SheetClassJava = SheetClassWrapper.class_
                else:
                    log("[KPM] InstallPluginBottomSheet class not found")
                    return
            
            if not SheetClassJava:
                log("[KPM] InstallPluginBottomSheet class not found")
                return
            target_ctor = None
            constructors = SheetClassJava.getDeclaredConstructors()
            
            for ctor in constructors:
                params = ctor.getParameterTypes()
                if len(params) == 3:
                    p0 = params[0].getName()
                    p2 = params[2].getName()
                    if "BaseFragment" in p0 and "PluginInstallParams" in p2:
                        target_ctor = ctor
                        break
            
            if target_ctor:
                target_ctor.setAccessible(True)
                self.hook_method(target_ctor, InstallSheetHook(self))
                log("[KPM] Install sheet hook installed successfully")
            else:
                log("[KPM] InstallPluginBottomSheet constructor not found")
        
        except Exception as e:
            log(f"[KPM] Error adding install sheet hook: {e}")
            log(traceback.format_exc())
    
    def add_plugins_activity_hook(self):
        try:
            from base_plugin import MethodHook
            
            class PluginsActivityHook(MethodHook):
                def __init__(self, plugin):
                    self.plugin = plugin
                
                def after_hooked_method(self, param):
                    try:
                        if not self.plugin.get_setting("show_add_button", True):
                            return
                        
                        activity = param.thisObject
                        action_bar = activity.actionBar
                        if not action_bar:
                            log("[KPM] ActionBar is None")
                            return
                        
                        menu = action_bar.menu
                        if not menu:
                            log("[KPM] Menu is None")
                            return     
                        try:
                            if hasattr(menu, 'ids') and menu.ids:
                                if 2 in [int(x) for x in menu.ids]:
                                    log("[KPM] Button '+' already exists (checked via ids)")
                                    return
                        except Exception as check_error:
                            log(f"[KPM] Could not check existing items: {check_error}")
                        
                        from org.telegram.messenger import R
                        
                        class AddButtonClickListener(dynamic_proxy(View.OnClickListener)):
                            def __init__(self, plugin_instance):
                                super().__init__()
                                self.plugin_instance = plugin_instance
                            
                            def onClick(self, v):
                                self.plugin_instance.open_install_dialog()
                        
                        class UpdateButtonClickListener(dynamic_proxy(View.OnClickListener)):
                            def __init__(self, plugin_instance):
                                super().__init__()
                                self.plugin_instance = plugin_instance
                            
                            def onClick(self, v):
                                self.plugin_instance.open_update_dialog()
                        
                        add_item = menu.addItem(2, R.drawable.msg_add)
                        add_item.setOnClickListener(AddButtonClickListener(self.plugin))
                        if self.plugin.get_setting("show_update_button", True):
                            update_item = menu.addItem(3, R.drawable.menu_browser_refresh)
                            update_item.setOnClickListener(UpdateButtonClickListener(self.plugin))
                            log("[KPM] Added '+' and update buttons to PluginsActivity menu")
                        else:
                            log("[KPM] Added '+' button to PluginsActivity menu (update button hidden by settings)")
                    except Exception as e:
                        log(f"[KPM] Error in PluginsActivity hook: {e}")
                        log(traceback.format_exc())
            
            PluginsActivity = find_class("com.exteragram.messenger.plugins.ui.PluginsActivity")
            if PluginsActivity:
                method = PluginsActivity.getClass().getDeclaredMethod("createView", find_class("android.content.Context").getClass())
                method.setAccessible(True)
                self.hook_method(method, PluginsActivityHook(self))
                log("[KPM] PluginsActivity hook installed successfully")
            else:
                log("[KPM] PluginsActivity class not found")
        except Exception as e:
            log(f"[KPM] Error adding PluginsActivity hook: {e}")
            log(traceback.format_exc())
    
    def _get_dependencies_from_file(self, file_path):
        try:
            if not os.path.exists(file_path):
                return []

            with open(file_path, 'r', encoding='utf-8') as f:
                content = f.read()

            import re
            pattern = r'__dependencies__\s*=\s*\[(.*?)\]'
            match = re.search(pattern, content, re.DOTALL)
            
            if match:
                deps_str = match.group(1)

                deps = []
                for dep in deps_str.split(','):
                    dep = dep.strip().strip('"').strip("'")
                    if dep:
                        deps.append(dep)
                return deps
            
            return []
        
        except Exception as e:
            log(f"[KPM] Error getting dependencies from file: {e}")
            return []

    def load_cache(self):
        try:
            if os.path.exists(self.cache_file):
                with open(self.cache_file, "r", encoding="utf-8") as f:
                    cache_data = json.load(f)
                    self.plugins_list = cache_data.get("plugins_list", {})
                    self.plugin_names_cache = cache_data.get("plugin_names", {})
                    cached_commit = cache_data.get("commit_sha", "")
                    log(f"[KPM] Loaded cache with {len(self.plugins_list)} plugins, {len(self.plugin_names_cache)} names (commit: {cached_commit[:7]})")
                    try:
                        self._build_trigram_index()
                    except Exception as e:
                        log(f"[KPM] Trigram index build (cache) failed: {e}")
        except Exception as e:
            log(f"[KPM] Error loading cache: {e}")

    def _normalize_search_text(self, text: str) -> str:
        try:
            if not text:
                return ""
            s = str(text).lower()
            s = re.sub(r"[^0-9a-zÐ°-ÑÑ‘_\-\s]", " ", s, flags=re.IGNORECASE)
            s = re.sub(r"\s+", " ", s).strip()
            return s
        except Exception:
            return ""

    def _iter_trigrams(self, text: str):
        s = self._normalize_search_text(text)
        if not s:
            return []
        if len(s) < 3:
            return []
        return [s[i:i+3] for i in range(0, len(s) - 2)]

    def _build_trigram_index(self):
        self._trigram_index = {}
        self._search_text_cache = {}
        for pid, info in (self.plugins_list or {}).items():
            try:
                name = ""
                author = ""
                if isinstance(info, dict):
                    name = info.get("name") or ""
                    author = info.get("author") or ""
                text = f"{pid} {name} {author}"
                norm = self._normalize_search_text(text)
                self._search_text_cache[pid] = norm
                for tri in self._iter_trigrams(norm):
                    bucket = self._trigram_index.get(tri)
                    if bucket is None:
                        bucket = set()
                        self._trigram_index[tri] = bucket
                    bucket.add(pid)
            except Exception:
                continue
        log(f"[KPM] Trigram index built: {len(self._trigram_index)} keys")

    def _trigram_search(self, query: str, allowed_ids=None):
        q = self._normalize_search_text(query)
        if not q:
            return []
        if len(q) < 3:
            return []

        trigs = self._iter_trigrams(q)
        if not trigs:
            return []

        allowed_set = set(allowed_ids) if allowed_ids is not None else None
        scores = {}
        for tri in trigs:
            ids = self._trigram_index.get(tri)
            if not ids:
                continue
            if allowed_set is None:
                for pid in ids:
                    scores[pid] = scores.get(pid, 0) + 1
            else:
                for pid in ids:
                    if pid in allowed_set:
                        scores[pid] = scores.get(pid, 0) + 1

        if not scores:
            return []

        min_score = max(1, int(len(trigs) * 0.35))
        filtered = [(pid, sc) for pid, sc in scores.items() if sc >= min_score]
        filtered.sort(key=lambda x: (-x[1], x[0]))
        return [pid for pid, _ in filtered]

    def save_cache(self, commit_sha):
        try:
            cache_data = {
                "plugins_list": self.plugins_list,
                "plugin_names": self.plugin_names_cache,
                "commit_sha": commit_sha,
                "timestamp": int(time.time())
            }
            with open(self.cache_file, "w", encoding="utf-8") as f:
                json.dump(cache_data, f, ensure_ascii=False, indent=2)
            log(f"[KPM] Saved cache with {len(self.plugins_list)} plugins, {len(self.plugin_names_cache)} names (commit: {commit_sha[:7]})")
        except Exception as e:
            log(f"[KPM] Error saving cache: {e}")
    
    def clear_cache(self):
        try:
            if os.path.exists(self.cache_file):
                os.remove(self.cache_file)
                log("[KPM] Cache file deleted")
            
            self.plugins_list.clear()
            self.plugin_names_cache.clear()
            log("[KPM] Cache cleared from memory")
            
            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("cache_cleared")))
        except Exception as e:
            log(f"[KPM] Error clearing cache: {e}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(f"ÐžÑˆÐ¸Ð±ÐºÐ°: {e}"))

    def get_latest_commit_sha(self):
        try:
            log(f"[KPM] Checking latest commit from GitHub API...")
            r = requests.get(self.github_api_url, timeout=10)
            if r.status_code == 200:
                commit_data = json.loads(r.text)
                sha = commit_data.get("sha", "")
                log(f"[KPM] Latest commit: {sha[:7]}")
                return sha
        except Exception as e:
            log(f"[KPM] Error getting commit SHA: {e}")
        return None

    def get_cached_commit_sha(self):
        try:
            if os.path.exists(self.cache_file):
                with open(self.cache_file, "r", encoding="utf-8") as f:
                    cache_data = json.load(f)
                    return cache_data.get("commit_sha", "")
        except Exception:
            pass
        return ""

    def _compare_versions(self, v1, v2):
        try:
            def parse_version(v):
                return [int(x) if x.isdigit() else x for x in re.split(r'(\d+)', str(v))]
            
            p1 = parse_version(v1)
            p2 = parse_version(v2)
            
            for a, b in zip(p1, p2):
                if a == b: continue
                if isinstance(a, int) and isinstance(b, int):
                    return 1 if a > b else -1
                return 1 if str(a) > str(b) else -1
            return len(p1) - len(p2)
        except Exception:
            return 0

    def is_cache_valid(self):
        cached_sha = self.get_cached_commit_sha()
        if not cached_sha:
            log("[KPM] No cached commit SHA, cache invalid")
            return False

        latest_sha = self.get_latest_commit_sha()
        if not latest_sha:
            log("[KPM] Could not get latest commit SHA, using cache")
            return True

        is_valid = cached_sha == latest_sha
        log(f"[KPM] Cache valid: {is_valid} (cached: {cached_sha[:7]}, latest: {latest_sha[:7]})")
        return is_valid

    def force_refresh_store(self):
        log("[KPM] Force refreshing store (clearing cache)...")
        self.plugins_list.clear()
        self.refresh_store(force=True)


    def refresh_store(self, force=False):
        def do_refresh():
            if not force and self.is_cache_valid():
                log("[KPM] Cache is valid, skipping refresh")
                run_on_ui_thread(lambda: BulletinHelper.show_error(f"Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ ÐºÑÑˆ ({len(self.plugins_list)} Ð¿Ð»Ð°Ð³Ð¸Ð½Ð¾Ð²)"))
                return

            log("[KPM] Refreshing store from URLs...")

            for url in self.store_json_urls:
                try:
                    log(f"[KPM] Trying JSON URL: {url}")
                    r = requests.get(url, timeout=20)
                    log(f"[KPM] Response status: {r.status_code}")
                    if r.status_code == 200 and r.text:
                        try:
                            store_data = json.loads(r.text)
                        except Exception as e:
                            log(f"[KPM] JSON parse error: {e}")
                            continue
                        
                        if isinstance(store_data, dict):
                            normalized = {}
                            for pid, value in store_data.items():
                                if isinstance(value, str):
                                    normalized[pid] = {"url": value}
                                elif isinstance(value, dict):
                                    normalized[pid] = {
                                        "url": value.get("url", ""),
                                        "dependencies": value.get("dependencies", [])
                                    }
                                   
                                    if value.get("name"):
                                        normalized[pid]["name"] = value.get("name")
                                    if value.get("version"):
                                        normalized[pid]["version"] = value.get("version")
                                    if value.get("icon"):
                                        normalized[pid]["icon"] = value.get("icon")
                                    if value.get("author"):
                                        normalized[pid]["author"] = value.get("author")
                                    if value.get("description"):
                                        normalized[pid]["description"] = value.get("description")
                                    normalized[pid]["status"] = value.get("status", "plugin")
                            

                            all_deps = set()
                            for plugin_info in normalized.values():
                                if isinstance(plugin_info, dict):
                                    deps = plugin_info.get("dependencies", [])
                                    all_deps.update(deps)
                            
                            libs = []
                            plugins = []
                            
                            for pid, plugin_info in normalized.items():
                                is_lib = pid in all_deps or "lib" in pid.lower()
                                if is_lib:
                                    libs.append((pid, plugin_info))
                                else:
                                    plugins.append((pid, plugin_info))
                            
                        
                            sorted_plugins = {}
                            for pid, plugin_info in libs:
                                sorted_plugins[pid] = plugin_info
                            for pid, plugin_info in plugins:
                                sorted_plugins[pid] = plugin_info
                            
                            self.plugins_list = sorted_plugins
                            try:
                                self._build_trigram_index()
                            except Exception as e:
                                log(f"[KPM] Trigram index build (refresh) failed: {e}")
                            
                            latest_sha = self.get_latest_commit_sha()
                            if latest_sha:
                                self.save_cache(latest_sha)
                            
                            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("store_loaded").format(len(self.plugins_list))))
                            return
                except Exception as e:
                    log(f"[KPM] JSON store fetch fail {url}: {e}")

            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("store_load_failed")))

        run_on_queue(do_refresh)

    def list_available_ids(self):
        if not self.plugins_list:
            self.load_cache()
        if not self.plugins_list:
            self.refresh_store()
        
        return list(self.plugins_list.keys())

    def parse_plugin_metadata(self, content):
        metadata = {
            "name": None,
            "description": None,
            "author": None,
            "version": None,
            "icon": None,
        }
        try:
            lines = content.decode('utf-8', errors='ignore').split('\n')
            in_multiline = False
            multiline_key = None
            multiline_value = []
            
            for line in lines:
                line_stripped = line.strip()
                if in_multiline:
                    if '"""' in line_stripped:
                        multiline_value.append(line_stripped.split('"""')[0])
                        metadata[multiline_key] = '\n'.join(multiline_value).strip()
                        in_multiline = False
                        multiline_key = None
                        multiline_value = []
                    else:
                        multiline_value.append(line_stripped)
                    continue
                
                for key in ['__name__', '__description__', '__author__', '__version__', '__icon__']:
                    if line_stripped.startswith(key):
                        parts = line_stripped.split('=', 1)
                        if len(parts) == 2:
                            value = parts[1].strip()
                            if value.startswith('"""'):
                                if value.count('"""') >= 2:
                                    metadata[key[2:-2]] = value.strip('"').strip()
                                else:
                                    in_multiline = True
                                    multiline_key = key[2:-2]
                                    multiline_value = [value[3:]]
                            else:
                                metadata[key[2:-2]] = value.strip('"').strip("'")
                        break
                
                if all(metadata.values()):
                    break
        except Exception as e:
            log(f"[KPM] Error parsing metadata: {e}")
        return metadata

    def get_plugin_display_name(self, plugin_id):
        if plugin_id in self.plugin_names_cache:
            return self.plugin_names_cache[plugin_id]
        
        if plugin_id not in self.plugins_list:
            return plugin_id
        
        try:
            plugin_info = self.plugins_list[plugin_id]

            if isinstance(plugin_info, dict) and plugin_info.get("name"):
                name = plugin_info.get("name")
                self.plugin_names_cache[plugin_id] = name
                return name

            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
            content = self.fetch_remote_bytes(url)
            metadata = self.parse_plugin_metadata(content)
            if metadata["name"]:
                self.plugin_names_cache[plugin_id] = metadata["name"]
                return metadata["name"]
        except Exception as e:
            log(f"[KPM] Error getting display name for {plugin_id}: {e}")
        
        self.plugin_names_cache[plugin_id] = plugin_id
        return plugin_id

    def open_update_dialog(self):
        def load_and_show():
            try:
                installed = self.list_installed_plugins()
                if not installed:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("no_installed")))
                    return

                if not self.plugins_list:
                    self.refresh_store()
                
                updates = []
                display_names = {"d": {}, "ic": {}, "vers": {}}
                
                for pid in installed:
                    try:
                        plugin_info = self.plugins_list.get(pid)
                        if not plugin_info:
                            continue
                        
                        local_path = os.path.join(PLUGINS_DIR, f"{pid}.py")
                        if not os.path.exists(local_path):
                            continue
                        
                        local_bytes = self.read_file_bytes(local_path)
                        if not local_bytes:
                            continue
                        
                        local_metadata = self.parse_plugin_metadata(local_bytes)
                        local_version = local_metadata.get("version", "1.0")
                        
                        remote_version = str(plugin_info.get("version", "0"))
                        
                        if remote_version != local_version:
                            updates.append(pid)
                            display_names["d"][pid] = plugin_info.get("name", pid)
                            display_names["ic"][pid] = plugin_info.get("icon")
                            display_names["vers"][pid] = (local_version, remote_version)
                    except Exception as e:
                        log(f"[KPM] Error checking {pid}: {e}")
                        continue
                
                def show_dialog():
                    if not updates:
                        BulletinHelper.show_error(_tr("no_installed"))
                        return
                    self._show_plugin_list(_tr("update_plugins"), updates, display_names, KangelPluginsManager.UPDATE)
                
                run_on_ui_thread(show_dialog)
            except Exception as e:
                log(f"[KPM] Error loading updates: {e}")
        
        run_on_queue(load_and_show)

    def update_selected_plugins(self, plugin_ids, fn):
        updated = 0
        failed = 0
        for pid in plugin_ids:
            try:
                plugin_info = self.plugins_list.get(pid)
                if not plugin_info:
                    failed += 1
                    continue
                
                url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                filename = f"{pid}.py"
                local_path = os.path.join(PLUGINS_DIR, filename)
                
                if not os.path.exists(local_path):
                    failed += 1
                    continue
                with open(local_path, "rb") as f:
                    local_bytes = f.read()
                if not local_bytes:
                    failed += 1
                    continue
                
                try:
                    remote = self.fetch_remote_bytes(url)
                    local_metadata = self.parse_plugin_metadata(local_bytes)
                    remote_metadata = self.parse_plugin_metadata(remote)
                    local_version = local_metadata.get("version", "0")
                    remote_version = remote_metadata.get("version", "0")
                except Exception:
                    failed += 1
                    continue
                
                if local_version != remote_version:
                    try:
                        tmp = local_path + ".tmp"
                        with open(tmp, "wb") as f:
                            f.write(remote)
                        if os.path.exists(local_path):
                            os.remove(local_path)
                        shutil.move(tmp, local_path)
                        updated += 1
                    except Exception:
                        failed += 1
                else:
                    log(f"[KPM] Plugin {pid} is already up to date")
            except Exception as e:
                log(f"[KPM] Error updating {pid}: {e}")
                failed += 1
        
        msg = f"ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾: {updated}, Ð¾ÑˆÐ¸Ð±Ð¾Ðº: {failed}" if _get_lang() == "ru" else f"Updated: {updated}, errors: {failed}"
        fn()
        run_on_ui_thread(lambda: BulletinHelper.show_error(msg))
    
    def show_plugin_info_and_install(self, plugin_id, enable_after=False):
        def load_info():
            try:
                try:
                    self._mkstats_event("install_dialog_opened", 1)
                except Exception:
                    pass
                if not self.plugins_list:
                    log(f"[KPM] plugins_list is empty, refreshing store...")
                    self.refresh_store()
                
                plugin_info = self.plugins_list.get(plugin_id)
                if not plugin_info:
                    error_msg = f"Plugin {plugin_id} not found in store.json"
                    log(f"[KPM] {error_msg}")
                    run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg))
                    return
                
                url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                if not url:
                    error_msg = f"No URL found in store.json for plugin {plugin_id}"
                    log(f"[KPM] {error_msg}")
                    run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg))
                    return
                
                log(f"[KPM] Installing {plugin_id} from store.json URL: {url}")
                
                info = self.get_plugin_full_info(plugin_id)
                if not info:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(f"Failed to load {plugin_id}"))
                    return
                
                if not info.get('url') or info['url'] != url:
                    log(f"[KPM] Warning: URL mismatch, using store.json URL: {url}")
                    info['url'] = url
                
                dependencies = info.get("dependencies", [])
                
                def install_main_plugin():
                    try:
                        fragment = get_last_fragment()
                        if not fragment:
                            return
                        
                        temp_path = os.path.join(PLUGINS_DIR, f".temp_{plugin_id}.plugin")
                        error_msg = None
                        try:
                            plugin_url = info.get('url')
                            if not plugin_url:
                                raise Exception(f"No URL in info for {plugin_id}")
                            
                            log(f"[KPM] Downloading plugin from URL: {plugin_url}")
                            plugin_content = self.fetch_remote_bytes(plugin_url)
                            with open(temp_path, 'wb') as f:
                                f.write(plugin_content)
                            
                            PluginsController.getInstance().showInstallDialog(fragment, temp_path, True)
                            try:
                                self._mkstats_event("install_dialog_shown", 1)
                            except Exception:
                                pass
                            
                            log(f"[KPM] Opened Extera install dialog for {plugin_id}")
                        except Exception as download_error:
                            error_msg = str(download_error)
                            log(f"[KPM] Error downloading plugin for install dialog: {error_msg}")
                            if os.path.exists(temp_path):
                                try:
                                    os.remove(temp_path)
                                except:
                                    pass
                        
                        if error_msg:
                            run_on_ui_thread(lambda msg=error_msg: BulletinHelper.show_error(f"Error: {msg}"))
                    except Exception as e:
                        log(f"[KPM] Error showing Extera install dialog: {e}")
                        log(traceback.format_exc())
                
                if dependencies:
                    log(f"[KPM] Found {len(dependencies)} dependencies for {plugin_id}: {dependencies}")
                    def install_deps_then_open():
                        failed = []
                        for dep_id in dependencies:
                            try:
                                log(f"[KPM] Installing dependency: {dep_id}")
                                self.install_plugin_by_id(dep_id, enable_after=True)
                            except Exception as dep_e:
                                failed.append(dep_id)
                                log(f"[KPM] ERROR installing dependency {dep_id}: {dep_e}")
                        if failed:
                            try:
                                run_on_ui_thread(lambda: BulletinHelper.show_error(f"Deps failed: {', '.join(failed)}"))
                            except Exception:
                                pass
                        run_on_ui_thread(install_main_plugin)
                    run_on_queue(install_deps_then_open)
                else:
                    run_on_ui_thread(install_main_plugin)
                
            except Exception as e:
                log(f"[KPM] Error loading plugin info: {e}")
        
        run_on_queue(load_info)
    def _mkstats_get_setting(self, key: str, default):
        try:
            if hasattr(self, "get_setting"):
                return self.get_setting(key, default)
            if hasattr(self, "getsetting"):
                return self.getsetting(key, default)
        except Exception:
            pass
        return default

    def _mkstats_set_setting(self, key: str, value, reload_settings: bool = False):
        try:
            if hasattr(self, "set_setting"):
                return self.set_setting(key, value, reload_settings=reload_settings)
            if hasattr(self, "setsetting"):
                return self.setsetting(key, value, reloadsettings=reload_settings)
        except Exception:
            pass
        return None

    def _mkstats_get_device_id(self) -> str:
        device_id = self._mkstats_get_setting("mkstats_device_id", "")
        if not device_id:
            device_id = uuid.uuid4().hex
            self._mkstats_set_setting("mkstats_device_id", device_id, reload_settings=False)
        return device_id

    def _mkstats_get_client_version(self) -> str:
        try:
            from org.telegram.messenger import BuildVars
            version = getattr(BuildVars, "BUILD_VERSION_STRING", None) or getattr(BuildVars, "BUILD_VERSION", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from org.telegram.messenger import BuildConfig as TgBuildConfig
            version = getattr(TgBuildConfig, "VERSION_NAME", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from com.radolyn.ayugram import BuildConfig as AyuBuildConfig
            version = getattr(AyuBuildConfig, "VERSION_NAME", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from com.exteragram.messenger import BuildConfig as ExBuildConfig
            version = getattr(ExBuildConfig, "VERSION_NAME", None)
            if version:
                return str(version)
        except Exception:
            pass
        try:
            from org.telegram.messenger import ApplicationLoader
            ctx = ApplicationLoader.applicationContext
            if ctx:
                pm = ctx.getPackageManager()
                pkg = ctx.getPackageName()
                info = pm.getPackageInfo(pkg, 0)
                version = getattr(info, "versionName", None) or getattr(info, "versionCode", None)
                if version:
                    return str(version)
        except Exception:
            pass
        return "unknown"

    def _mkstats_get_client_name(self) -> str:
        try:
            from org.telegram.messenger import ApplicationLoader
            ctx = ApplicationLoader.applicationContext
            if ctx:
                pkg = ctx.getPackageName()
                if pkg == "com.radolyn.ayugram":
                    return "AyuGram"
                if pkg == "com.exteragram.messenger":
                    return "exteraGram"
        except Exception:
            pass
        try:
            from com.radolyn.ayugram import BuildConfig as AyuBuildConfig
            _ = AyuBuildConfig.VERSION_NAME
            return "AyuGram"
        except Exception:
            pass
        try:
            from com.exteragram.messenger import BuildConfig as ExBuildConfig
            _ = ExBuildConfig.VERSION_NAME
            return "exteraGram"
        except Exception:
            pass
        return "unknown"

    def _mkstats_log(self, message: str) -> None:
        if hasattr(self, "log"):
            try:
                self.log(message)
            except Exception:
                pass

    def _mkstats_event(self, event: str, count: int = 1) -> None:
        if not event:
            return
        if not bool(self._mkstats_get_setting("telemetry_enabled", True)):
            return

        def _send():
            try:
                if not hasattr(self, "_mkstats_client"):
                    return
                if not getattr(self, "_mkstats_token", ""):
                    data = self._mkstats_client.handshake()
                    self._mkstats_token = data.get("install_token", "")
                    if self._mkstats_token:
                        self._mkstats_set_setting("mkstats_install_token", self._mkstats_token, reload_settings=False)
                if self._mkstats_token:
                    self._mkstats_client.send_event(self._mkstats_token, event, count=count)
            except Exception as exc:
                self._mkstats_log(f"mkStats: event error {exc}")
                self._mkstats_token = ""
                self._mkstats_set_setting("mkstats_install_token", "", reload_settings=False)

        try:
            threading.Thread(target=_send, daemon=True).start()
        except Exception:
            pass

    def _mkstats_loop(self):
        while not self._mkstats_stop.is_set():
            try:
                if not bool(self._mkstats_get_setting("telemetry_enabled", True)):
                    self._mkstats_stop.wait(MKSTATS_PING_INTERVAL)
                    continue

                if not self._mkstats_token:
                    self._mkstats_log("mkStats: handshake start")
                    data = self._mkstats_client.handshake()
                    self._mkstats_token = data.get("install_token", "")
                    if self._mkstats_token:
                        self._mkstats_set_setting("mkstats_install_token", self._mkstats_token, reload_settings=False)
                        self._mkstats_log("mkStats: handshake ok, token stored")
                    else:
                        self._mkstats_log("mkStats: handshake response missing token")

                if self._mkstats_token:
                    self._mkstats_log("mkStats: sending ping")
                    self._mkstats_client.send_ping(self._mkstats_token)
                    self._mkstats_log("mkStats: ping sent")
            except Exception as exc:
                self._mkstats_log(f"mkStats: error {exc}")
                self._mkstats_token = ""
                self._mkstats_set_setting("mkstats_install_token", "", reload_settings=False)
            self._mkstats_stop.wait(MKSTATS_PING_INTERVAL)

    def _mkstats_start(self):
        try:
            device_id = self._mkstats_get_device_id()
            user_hash = generate_user_hash(device_id, "kangel_plugins_manager")
            device_fingerprint = generate_device_fingerprint(device_id)
            client_name = self._mkstats_get_client_name()
            client_version = self._mkstats_get_client_version()
            self._mkstats_client = MkStatsCoreClient(MKSTATS_API_URL, "kangel_plugins_manager", "1.2", user_hash, device_fingerprint, client_version, client_name)
            self._mkstats_stop = threading.Event()
            self._mkstats_token = self._mkstats_get_setting("mkstats_install_token", "")
            self._mkstats_thread = threading.Thread(target=self._mkstats_loop, daemon=True)
            self._mkstats_thread.start()
            self._mkstats_log(f"mkStats: client started ({self._mkstats_client.api_base})")
        except Exception:
            pass
    def __init__(self):
        super().__init__()
        global _kpm_instance
        _kpm_instance = self
        self.store_json_urls = [
            "https://raw.githubusercontent.com/KangelPlugins/Plugins-Store/refs/heads/main/store.json",
            "https://raw.githubusercontent.com/KangelPlugins/Plugins-Store/main/store.json",
        ]
        self.github_api_url = "https://api.github.com/repos/KangelPlugins/Plugins-Store/commits/main"
        self.cache_file = os.path.join(PLUGINS_DIR, ".kpm_cache.json")
        self.plugins_list = {}
        self.plugin_names_cache = {}
        self._install_dialog_views_cache = {}
        self._trigram_index = {}
        self._search_text_cache = {}
        self.auto_update = True
        self.load_cache()
        self._mkstats_start()

    def show_plugin_info_and_delete(self, plugin_id, fn = None):
        log('taaakk')
        def load_info():
            try:
                log('getting')
                info = self.get_plugin_full_info(plugin_id)
                if not info:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(f"Failed to load {plugin_id}"))
                    return
                
                def show_dialog():
                    try:
                        fragment = get_last_fragment()
                        if not fragment:
                            return
                        
                        lang = _get_lang()
                        if lang == "ru":
                            title = f"Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð»Ð°Ð³Ð¸Ð½?"
                            message = f"{info['name']}\n\n{_tr('version')}: {info['version']}\n{_tr('author')}: {info['author']}"
                        else:
                            title = f"Delete plugin?"
                            message = f"{info['name']}\n\n{_tr('version')}: {info['version']}\n{_tr('author')}: {info['author']}"
                        
                        builder = AlertDialogBuilder(fragment.getParentActivity())
                        builder.set_title(title)
                        builder.set_message(message)
                        builder.set_positive_button(_tr("delete_button"), lambda d, w: run_on_queue(
                            lambda: self.delete_plugin_by_id(plugin_id, fn)
                        ))
                        builder.set_negative_button(_tr("cancel"), lambda d, w: d.dismiss())
                        builder.show()
                    except Exception as e:
                        log(f"[KPM] Error showing delete dialog: {e}")
                        import traceback
                        log(traceback.format_exc())
                
                run_on_ui_thread(show_dialog)
            except Exception as e:
                log(f"[KPM] Error loading plugin info for delete: {e}")
        
        run_on_queue(load_info)
    
    def get_plugin_full_info(self, plugin_id):
        try:
            plugin_info = self.plugins_list.get(plugin_id)
            if not plugin_info:
                log(f"[KPM] Plugin {plugin_id} not found in plugins_list")
                return None
            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
            filename = f"{plugin_id}.py"
            local_path = os.path.join(PLUGINS_DIR, filename)
            
            if os.path.exists(local_path):
                with open(local_path, "rb") as f:
                    content = f.read()
            else:
                content = self.fetch_remote_bytes(url)
            
            metadata = self.parse_plugin_metadata(content)
            
            metadata["plugin_id"] = plugin_id
            metadata["url"] = url  
            metadata["dependencies"] = plugin_info.get("dependencies", []) if isinstance(plugin_info, dict) else []
            
            if isinstance(plugin_info, dict):
                if plugin_info.get("name"):
                    metadata["name"] = plugin_info.get("name")
                if plugin_info.get("version"):
                    metadata["version"] = plugin_info.get("version")
                if plugin_info.get("author"):
                    metadata["author"] = plugin_info.get("author")
                if plugin_info.get("description"):
                    metadata["description"] = plugin_info.get("description")
            
            if not metadata["name"]:
                metadata["name"] = plugin_id
            if not metadata["description"]:
                metadata["description"] = _tr("no_description")
            if not metadata["author"]:
                metadata["author"] = "Unknown"
            if not metadata["version"]:
                metadata["version"] = "1.0"
            
            return metadata
        except Exception as e:
            log(f"[KPM] Error getting full info: {e}")
            return None
    
    def _show_searchable_dialog(self, fragment, title, plugin_ids, display_names, on_click_callback):
        try:
            log(f"[KPM] _show_searchable_dialog called: title={title}, plugin_ids count={len(plugin_ids)}")
            context = fragment.getParentActivity()
            if not context:
                log("[KPM] Error: context is None")
                return
            
            log(f"[KPM] Context obtained, getting icons for {len(plugin_ids)} plugins")
            icons = {}
            for pid in plugin_ids:
                plugin_info = self.plugins_list.get(pid)
                if isinstance(plugin_info, dict):
                    icon_str = plugin_info.get("icon")
                    if icon_str:
                        icons[pid] = icon_str
            log(f"[KPM] Found {len(icons)} icons")
            
            builder = AlertDialog.Builder(context)
            builder.setTitle(title)
            
            container = LinearLayout(context)
            container.setOrientation(LinearLayout.VERTICAL)
            container.setPadding(
                AndroidUtilities.dp(16),
                AndroidUtilities.dp(8),
                AndroidUtilities.dp(16),
                AndroidUtilities.dp(8)
            )
            
            search_edit = EditText(context)
            search_edit.setHint(_tr("search_hint"))
            search_edit.setSingleLine(True)
            search_edit.setTextSize(16)
            search_edit.setPadding(
                AndroidUtilities.dp(12),
                AndroidUtilities.dp(8),
                AndroidUtilities.dp(12),
                AndroidUtilities.dp(8)
            )
            
            try:
                search_edit.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
                search_edit.setHintTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteHintText))
                search_edit.setBackground(Theme.createRoundRectDrawable(
                    AndroidUtilities.dp(6),
                    Theme.getColor(Theme.key_windowBackgroundWhite)
                ))
            except Exception as e:
                log(f"[KPM] Error setting EditText colors: {e}")
            
            container.addView(search_edit, LinearLayout.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                ViewGroup.LayoutParams.WRAP_CONTENT
            ))

            from android.view import Gravity
            from android.widget import ScrollView
            from org.telegram.messenger import MediaDataController
            from org.telegram.ui.Components import BackupImageView
            
            scroll_view = ScrollView(context)
            items_container = LinearLayout(context)
            items_container.setOrientation(LinearLayout.VERTICAL)
            scroll_view.addView(items_container)
            
            current_account = 0
            try:
                current_account = fragment.getCurrentAccount()
            except Exception:
                current_account = 0
            media_controller = MediaDataController.getInstance(current_account)
            icon_size_dp = 32
            
            log(f"[KPM] Creating items container with {len(plugin_ids)} plugins")
            
            plugins_info = {}
            for pid in plugin_ids:
                plugin_info = self.plugins_list.get(pid)
                if isinstance(plugin_info, dict):
                    author = plugin_info.get("author", "")
                    description = plugin_info.get("description", "")
                    plugins_info[pid] = {
                        "author": author,
                        "description": description
                    }
            
            def create_item_view(pid, display_name, icon_str):
                try:

                    item_layout = LinearLayout(context)
                    item_layout.setOrientation(LinearLayout.HORIZONTAL)
                    item_layout.setGravity(Gravity.TOP)
                    item_layout.setPadding(
                        AndroidUtilities.dp(16),
                        AndroidUtilities.dp(12),
                        AndroidUtilities.dp(16),
                        AndroidUtilities.dp(12)
                    )
                    item_layout.setBackground(Theme.getSelectorDrawable(False))
                    item_layout.setClickable(True)
                    item_layout.setFocusable(True)
                    if icon_str:
                        icon_view = BackupImageView(context)
                        icon_view.setRoundRadius(0)
                        icon_view.getImageReceiver().setCrossfadeWithOldImage(True)
                        icon_size_px = AndroidUtilities.dp(icon_size_dp)
                        icon_lp = LinearLayout.LayoutParams(icon_size_px, icon_size_px)
                        icon_lp.rightMargin = AndroidUtilities.dp(12)
                        icon_lp.topMargin = AndroidUtilities.dp(2)
                        item_layout.addView(icon_view, icon_lp)
                        
                        try:
                            if "/" in icon_str:
                                pack_name, index_str = icon_str.split("/", 1)
                                try:
                                    sticker_index = int(index_str)
                                    media_controller.setPlaceholderImageByIndex(icon_view, pack_name, sticker_index, f"{icon_size_dp}_{icon_size_dp}")
                                except ValueError:
                                    pass
                        except Exception as e:
                            log(f"[KPM] Error loading icon for {pid}: {e}")

                    text_container = LinearLayout(context)
                    text_container.setOrientation(LinearLayout.VERTICAL)
                    text_container.setLayoutParams(LinearLayout.LayoutParams(
                        ViewGroup.LayoutParams.MATCH_PARENT,
                        ViewGroup.LayoutParams.WRAP_CONTENT
                    ))
                    
                    name_view = AndroidTextView(context)
                    name_view.setText(display_name)
                    name_view.setTextSize(16)
                    name_view.setTypeface(AndroidUtilities.getTypeface(AndroidUtilities.TYPEFACE_ROBOTO_MEDIUM))
                    name_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                    name_view.setGravity(Gravity.START)
                    name_view.setSingleLine(True)
                    text_container.addView(name_view, LinearLayout.LayoutParams(
                        ViewGroup.LayoutParams.MATCH_PARENT,
                        ViewGroup.LayoutParams.WRAP_CONTENT
                    ))
                    
                    plugin_data = plugins_info.get(pid, {})
                    author_text = plugin_data.get("author", "")
                    if author_text:
                        author_view = AndroidTextView(context)
                        author_view.setText(author_text)
                        author_view.setTextSize(13)
                        author_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
                        author_view.setGravity(Gravity.START)
                        author_view.setSingleLine(True)
                        author_view.setPadding(0, AndroidUtilities.dp(2), 0, 0)
                        text_container.addView(author_view, LinearLayout.LayoutParams(
                            ViewGroup.LayoutParams.MATCH_PARENT,
                            ViewGroup.LayoutParams.WRAP_CONTENT
                        ))
                    

                    description_text = plugin_data.get("description", "")
                    if description_text:
        
                        desc_view = AndroidTextView(context)
                        desc_view.setText(description_text)
                        desc_view.setTextSize(13)
                        desc_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray2))
                        desc_view.setGravity(Gravity.START)
                        desc_view.setMaxLines(10 ** 8)
                        desc_view.setEllipsize(TextUtils.TruncateAt.END)
                        desc_view.setPadding(0, AndroidUtilities.dp(4), 0, 0)
                        text_container.addView(desc_view, LinearLayout.LayoutParams(
                            ViewGroup.LayoutParams.MATCH_PARENT,
                            ViewGroup.LayoutParams.WRAP_CONTENT
                        ))
                    
                    item_layout.addView(text_container)
                    
                    return item_layout
                except Exception as e:
                    log(f"[KPM] Error creating view for {pid}: {e}")
                    import traceback
                    log(f"[KPM] Traceback: {traceback.format_exc()}")
                    return None
            

            item_views = {}
            BATCH_SIZE = 30
            
            class ItemClickProxy(dynamic_proxy(View.OnClickListener)):
                def __init__(self, plugin_id, callback):
                    super().__init__()
                    self.plugin_id = plugin_id
                    self.callback = callback
                
                def onClick(self, v):
                    self.callback(self.plugin_id)
            
            class ItemLongClickProxy(dynamic_proxy(View.OnLongClickListener)):
                def __init__(self, plugin_id):
                    super().__init__()
                    self.plugin_id = plugin_id
                
                def onLongClick(self, v):
                    try:
                        link = f"tg://kpm_install?plugin={self.plugin_id}"
                        clipboard = context.getSystemService(Context.CLIPBOARD_SERVICE)
                        clip = ClipData.newPlainText("KPM Link", link)
                        clipboard.setPrimaryClip(clip)
                        lang = _get_lang()
                        msg = f"Ð¡ÑÑ‹Ð»ÐºÐ° ÑÐºÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°: {link}" if lang == "ru" else f"Link copied: {link}"
                        run_on_ui_thread(lambda: BulletinHelper.show_error(msg))
                        return True
                    except Exception as e:
                        log(f"[KPM] Error copying link: {e}")
                    return False
            
            def add_batch(start_idx):
                try:
                    end_idx = min(start_idx + BATCH_SIZE, len(plugin_ids))
                    batch_pids = plugin_ids[start_idx:end_idx]
                    batch_views = []
                    
                    for pid in batch_pids:
                        display_name = display_names.get(pid, pid)
                        icon_str = icons.get(pid)
                        item_layout = create_item_view(pid, display_name, icon_str)
                        
                        if item_layout:
                            item_layout.setOnClickListener(ItemClickProxy(pid, on_click_callback))
                            item_layout.setOnLongClickListener(ItemLongClickProxy(pid))
                            item_views[pid] = item_layout
                            batch_views.append((pid, item_layout))
                    
                    def add_to_ui():
                        for pid, item_layout in batch_views:
                            items_container.addView(item_layout, LinearLayout.LayoutParams(
                                ViewGroup.LayoutParams.MATCH_PARENT,
                                ViewGroup.LayoutParams.WRAP_CONTENT
                            ))
                        log(f"[KPM] Added batch {start_idx}-{end_idx} ({len(batch_views)} items) to UI")
                    
                    run_on_ui_thread(add_to_ui)

                    if end_idx < len(plugin_ids):
                        Handler = find_class("android.os.Handler")
                        Looper = find_class("android.os.Looper")
                        Runnable = find_class("java.lang.Runnable")
                        
                        class BatchRunnable(dynamic_proxy(Runnable)):
                            def __init__(self, next_idx):
                                super().__init__()
                                self.next_idx = next_idx
                            
                            def run(self):
                                run_on_queue(lambda: add_batch(self.next_idx))
                        
                        handler = Handler(Looper.getMainLooper())
                        handler.postDelayed(BatchRunnable(end_idx), 50)
                    else:
                        log(f"[KPM] All {len(item_views)} item views created")
                except Exception as e:
                    log(f"[KPM] Error adding batch: {e}")
                    log(traceback.format_exc())

            log(f"[KPM] Starting async view creation in batches of {BATCH_SIZE}")
            run_on_queue(lambda: add_batch(0))
            
            scroll_params = LinearLayout.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                AndroidUtilities.dp(400)
            )
            scroll_params.topMargin = AndroidUtilities.dp(8)
            container.addView(scroll_view, scroll_params)

            def filter_items(query):
                try:
                    query_lower = query.lower() if query else ""
                    visible_count = 0
                    for pid in plugin_ids:
                        item_view = item_views.get(pid)
                        if item_view:
                            display_name = display_names.get(pid, pid)
                            if not query_lower or query_lower in display_name.lower() or query_lower in pid.lower():
                                item_view.setVisibility(View.VISIBLE)
                                visible_count += 1
                            else:
                                item_view.setVisibility(View.GONE)
                    log(f"[KPM] Filtered items: {visible_count} visible out of {len(plugin_ids)}")
                except Exception as e:
                    log(f"[KPM] Error filtering items: {e}")
            
            filter_items("")
            
            builder.setView(container)
            builder.setNegativeButton(_tr("cancel"), None)
            
            dialog = builder.create()
            current_dialog = [dialog]
            log(f"[KPM] Dialog created, showing...")
            
            class SearchTextWatcher(dynamic_proxy(TextWatcher)):
                def __init__(self, filter_func):
                    super().__init__()
                    self.filter_func = filter_func
                
                def beforeTextChanged(self, s, start, count, after):
                    pass
                
                def onTextChanged(self, s, start, before, count):
                    pass
                
                def afterTextChanged(self, editable):
                    try:
                        query = str(editable)
                        self.filter_func(query)
                    except Exception as e:
                        log(f"[KPM] Search error: {e}")
            
            watcher = SearchTextWatcher(filter_items)
            search_edit.addTextChangedListener(watcher)
            
            log(f"[KPM] Showing dialog...")
            dialog.show()
            log(f"[KPM] Dialog shown")
        except Exception as e:
            log(f"[KPM] Error creating searchable dialog: {e}")
            log(traceback.format_exc())

    def open_install_dialog(self):
        fragment = get_last_fragment()
        if not fragment:
            return
        attempts = [0]
        
        def load_and_show():
            try:
                ids = self.list_available_ids()
                if not ids:
                    if attempts[0] < 3:
                        attempts[0] += 1
                        try:
                            self.refresh_store(force=True)
                        except Exception:
                            pass
                        try:
                            import time
                            time.sleep(1.0)
                        except Exception:
                            pass
                        run_on_queue(load_and_show)
                        return
                    run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("list_empty")))
                    return
                
                log(f"[KPM] Loading display names for {len(ids)} plugins from cache...")
                display_names = {}
                
                for pid in ids:
                    if pid in self.plugin_names_cache:
                        display_names[pid] = self.plugin_names_cache[pid]
                    else:
                        display_names[pid] = pid
                
                log(f"[KPM] Loaded {len(display_names)} display names from cache")
                
                def create_dialog():
                    try:
                        current_fragment = get_last_fragment()
                        if not current_fragment:
                            log("[KPM] Fragment is None when creating install dialog")
                            return
                        self._show_plugin_list(_tr('install_title'), ids, display_names)
                    
                    except Exception as e:
                        log(f"[KPM] Error creating install dialog: {e}")
                
                run_on_ui_thread(create_dialog)
                
                def update_names_in_background():
                    try:
                        failed_pids = []
                        for pid in ids:
                            if pid not in self.plugin_names_cache:
                                try:
                                    name = self.get_plugin_display_name(pid)
                                    if name != pid:
                                        display_names[pid] = name
                                        log(f"[KPM] Updated name for {pid}: {name}")
                                except Exception as e:
                                    log(f"[KPM] Error updating name for {pid}: {e}")
                                    failed_pids.append(pid)
                    except Exception as e:
                        log(f"[KPM] Error in background name update: {e}")
                
                run_on_queue(update_names_in_background)
                
            except Exception as e:
                log(f"[KPM] Error loading plugins: {e}")
                run_on_ui_thread(lambda: BulletinHelper.show_error(f"ÐžÑˆÐ¸Ð±ÐºÐ°: {e}"))
        
        run_on_queue(load_and_show)
    
    def _show_plugin_list(self, title, ids, display_names, type = 0):
        current_fragment = get_last_fragment()
        delegate = self.PluginListFragment(self, title, ids, display_names, type)
        fragment = UniversalFragment(delegate)
        current_fragment.presentFragment(fragment)
        fragment.setTitle(title, False, 0)
        base_title = title
        from java.lang import Boolean, Integer
        from org.telegram.ui.ActionBar import (ActionBar, ActionBarMenuItem,
                                               BackDrawable)
        
        if self.search_listener_hooks:
            for h in self.search_listener_hooks:
                self.unhook_method(h)
        self.search_listener_hooks = []
        id = 0
        def update_query(query):
            if query == delegate.search_query:
                return
            nonlocal id
            id += 1
            delegate.search_query = query
            def update(cid):
                nonlocal id
                if id != cid:
                    return
                delegate.adapter.update(True)
            
            run_on_ui_thread(lambda: update(id), 500)
            
        class SearchCollapseHook(MethodHook):
            def after_hooked_method(self, param):
                if param.thisObject != item or param.args[0] == True:
                    return
                param.setResult(None)
                update_query(None)
                
        hook = self.hook_method(ActionBarMenuItem.getClass().getDeclaredMethod("toggleSearch", Boolean.TYPE), SearchCollapseHook())
        self.search_listener_hooks.append(hook)

        class SearchTextChangedHook(MethodHook):
            def before_hooked_method(self, param):
                if param.thisObject != listener:
                    return
                search_query: str = search_field.getText().toString()
                if search_query.isspace():
                    search_query = None
                update_query(search_query)
        
        item = fragment.getActionBar().createMenu().addItem(0, R_tg.drawable.ic_ab_search).setIsSearchField(True)
        search_field = item.getSearchField()
        listener = get_private_field(search_field, "mListeners").get(0)
        from java.lang import CharSequence
        hook = self.hook_method(listener.getClass().getDeclaredMethod("onTextChanged", CharSequence, Integer.TYPE, Integer.TYPE, Integer.TYPE), SearchTextChangedHook())
        self.search_listener_hooks.append(hook)  

        try:
            from android_utils import OnClickListener

            def show_sort_dialog(*_):
                try:
                    items = [
                        _tr("sort_none"),
                        _tr("sort_az"),
                        _tr("sort_za"),
                        _tr("sort_author_az"),
                        _tr("sort_author_za"),
                    ]
                    current = int(self.get_setting("plugins_sort_mode", 0) or 0)

                    def on_pick(bld, which):
                        try:
                            self.set_setting("plugins_sort_mode", int(which), reload_settings=False)
                        except Exception:
                            self.set_setting("plugins_sort_mode", int(which))
                        try:
                            delegate.adapter.update(True)
                        except Exception:
                            pass
                        try:
                            bld.dismiss()
                        except Exception:
                            pass

                    builder = AlertDialogBuilder(fragment.getParentActivity())
                    builder.set_title(_tr("plugins_sort"))
                    builder.set_items(items, on_pick)
                    builder.set_negative_button(_tr("cancel"), lambda b, w: b.dismiss())
                    builder.show()
                except Exception as e:
                    log(f"[KPM] sort dialog error: {e}")

            fragment.getActionBar().createMenu().addItem(5, R_tg.drawable.menu_sort_value).setOnClickListener(OnClickListener(show_sort_dialog))
        except Exception as e:
            log(f"[KPM] Failed to add sort button: {e}")

        try:
            from android_utils import OnClickListener

            statuses = [
                ("*", _tr("filter_all")),
                ("customization", _tr("status_customization")),
                ("utilities", _tr("status_utilities")),
                ("informational", _tr("status_informational")),
                ("messages", _tr("status_messages")),
                ("fun", _tr("status_fun")),
                ("library", _tr("status_library")),
            ]

            action_bar = fragment.getActionBar()
            title_tv = None
            try:
                title_tv = action_bar.getTitleTextView()
            except Exception:
                title_tv = None

            def _label_for(key):
                try:
                    for k, l in statuses:
                        if k == key:
                            return l
                except Exception:
                    pass
                return _tr("filter_all")

            def _apply_header_label(key):
                try:
                    label = _label_for(key)
                    txt = f"{base_title}"
                    if title_tv is not None:
                        try:
                            title_tv.setLeftDrawable(R_tg.drawable.menu_filter)
                        except Exception:
                            pass
                        try:
                            try:
                                title_tv.setLeftDrawableOutside(True)
                            except Exception:
                                pass
                            title_tv.setGravity(Gravity.CENTER)
                        except Exception:
                            try:
                                title_tv.setGravity(Gravity.CENTER)
                            except Exception:
                                pass
                        try:
                            title_tv.setDrawablePadding(AndroidUtilities.dp(4.0))
                        except Exception:
                            pass
                        title_tv.setText(txt)
                        try:
                            action_bar.setSubtitle(str(label))
                        except Exception:
                            pass
                        try:
                            stv = action_bar.getSubtitleTextView()
                            if stv is not None:
                                try:
                                    stv.setGravity(Gravity.CENTER)
                                except Exception:
                                    pass
                                try:
                                    stv.setLayoutParams(LayoutHelper.createFrame(-1, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL))
                                except Exception:
                                    pass
                        except Exception:
                            pass
                    else:
                        action_bar.setTitle(txt)
                        try:
                            action_bar.setSubtitle(str(label))
                        except Exception:
                            pass
                        try:
                            stv = action_bar.getSubtitleTextView()
                            if stv is not None:
                                try:
                                    stv.setGravity(Gravity.CENTER)
                                except Exception:
                                    pass
                                try:
                                    stv.setLayoutParams(LayoutHelper.createFrame(-1, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL))
                                except Exception:
                                    pass
                        except Exception:
                            pass
                except Exception:
                    pass

            def show_filter_dialog(*_):
                try:
                    labels = [x[1] for x in statuses]
                    current = str(self.get_setting("plugins_status_filter", "*") or "*")

                    def on_pick(bld, which):
                        try:
                            key = statuses[int(which)][0]
                            try:
                                self.set_setting("plugins_status_filter", key, reload_settings=False)
                            except Exception:
                                self.set_setting("plugins_status_filter", key)
                            try:
                                self._mkstats_event("filter_status_changed", 1)
                            except Exception:
                                pass
                            _apply_header_label(key)
                            try:
                                delegate.adapter.update(True)
                            except Exception:
                                pass
                            try:
                                bld.dismiss()
                            except Exception:
                                pass
                        except Exception:
                            pass

                    builder = AlertDialogBuilder(fragment.getParentActivity())
                    builder.set_title(_tr("filter_status"))
                    builder.set_items(labels, on_pick)
                    builder.set_negative_button(_tr("cancel"), lambda b, w: b.dismiss())
                    builder.show()
                except Exception as e:
                    log(f"[KPM] filter dialog error: {e}")

            if title_tv is not None:
                try:
                    title_tv.setOnClickListener(OnClickListener(show_filter_dialog))
                except Exception:
                    pass
            else:
                try:
                    action_bar.setOnClickListener(OnClickListener(show_filter_dialog))
                except Exception:
                    pass

            try:
                current = str(self.get_setting("plugins_status_filter", "*") or "*")
            except Exception:
                current = "*"
            _apply_header_label(current)
        except Exception as e:
            log(f"[KPM] Failed to setup filter title: {e}")

    INSTALL = 0
    DELETE = 1
    UPDATE = 2
     
    class PluginListFragment(dynamic_proxy(UniversalFragment.UniversalFragmentDelegate)):
        
        class Callback2(dynamic_proxy(Utilities.Callback2)):
            def __init__(self, fn):
                super().__init__()
                self.fn = fn
            
            def run(self, *args):
                self.fn(*args)
    
        class Callback5(dynamic_proxy(Utilities.Callback5)):
            def __init__(self, fn):
                super().__init__()
                self.fn = fn
            
            def run(self, *args):
                self.fn(*args)
        
        class Callback5Return(dynamic_proxy(Utilities.Callback5Return)):
            def __init__(self, fn):
                super().__init__()
                self.fn = fn
            
            def run(self, *args):
                return self.fn(*args)
        
        class PluginCellDelegate(dynamic_proxy(PluginCellDelegate)):
            def __init__(self, id, outer: "KangelPluginsManager.PluginListFragment"):
                super().__init__()
                self.id = id
                self.outer = outer
                
            def canOpenInExternalApp(self):
                return False

            def deletePlugin(self):
                try:
                    def on_delete(pid):
                        self.outer.plugin_ids.remove(self.id)
                        self.outer.adapter.update(True)
                    self.outer.pl.show_plugin_info_and_delete(self.id, on_delete)
                except Exception as e:
                    log(str(e))

            def openInExternalApp(self):
                pass

            def openPluginSettings(self):
                pass

            def pinPlugin(self,view):
                pass

            def sharePlugin(self):
                if not self.id:
                    return

                fragment = get_last_fragment()
                if not fragment:
                    return

                plugin_id = self.id
                link = f"tg://kpm_install?plugin={plugin_id}"

                def copy_link():
                    AndroidUtilities.addToClipboard(link)
                    BulletinHelper.show_copied_to_clipboard()

                def view_raw_url():
                    try:
                        try:
                            self.outer.pl._mkstats_event("raw_opened", 1)
                        except Exception:
                            pass
                        plugin_info = self.outer.pl.plugins_list.get(plugin_id)
                        if not plugin_info:
                            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("list_empty")))
                            return
                        url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                        if not url:
                            run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("error_download").format("No URL")))
                            return

                        def show_dialog():
                            try:
                                builder = AlertDialogBuilder(fragment.getParentActivity())
                                builder.set_title(_tr("share_raw_title"))
                                builder.set_message(str(url))
                                builder.set_positive_button(_tr("share_copy_link"), lambda d, w: AndroidUtilities.addToClipboard(str(url)))
                                builder.set_neutral_button(_tr("share_open"), lambda d, w: open_link(str(url)))
                                builder.set_negative_button(_tr("cancel"), lambda d, w: d.dismiss())
                                builder.show()
                            except Exception as e:
                                log(f"[KPM] raw url dialog error: {e}")
                                open_link(str(url))

                        run_on_ui_thread(show_dialog)
                    except Exception as e:
                        log(f"[KPM] view_raw_url error: {e}")

                def send_to_tg():
                    def do_send():
                        try:
                            plugin_info = self.outer.pl.plugins_list.get(plugin_id)
                            if not plugin_info:
                                run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("list_empty")))
                                return
                            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                            if not url:
                                run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("error_download").format("No URL")))
                                return

                            temp_path = os.path.join(PLUGINS_DIR, f"{plugin_id}.plugin")
                            data = self.outer.pl.fetch_remote_bytes(url)
                            with open(temp_path, "wb") as f:
                                f.write(data)

                            try:
                                from org.telegram.messenger import UserConfig
                                account = _get_current_account(fragment)
                                my_id = UserConfig.getInstance(account).getClientUserId()
                                run_on_ui_thread(lambda: send_document(my_id, temp_path, caption=f"{plugin_id}.plugin"))
                                BulletinHelper.show_success(_tr("share_send_file"))
                            except Exception as e:
                                run_on_ui_thread(lambda: BulletinHelper.show_error(str(e)))

                            def cleanup():
                                try:
                                    time.sleep(30)
                                    if os.path.exists(temp_path):
                                        os.remove(temp_path)
                                except Exception:
                                    pass
                            run_on_queue(cleanup)
                        except Exception as e:
                            err = str(e)
                            run_on_ui_thread(lambda err=err: BulletinHelper.show_error(_tr("error_download").format(err)))
                    run_on_queue(do_send)

                def send_as_file():
                    def do_send():
                        try:
                            plugin_info = self.outer.pl.plugins_list.get(plugin_id)
                            if not plugin_info:
                                run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("list_empty")))
                                return
                            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                            if not url:
                                run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("error_download").format("No URL")))
                                return

                            temp_path = os.path.join(PLUGINS_DIR, f"{plugin_id}.plugin")
                            data = self.outer.pl.fetch_remote_bytes(url)
                            with open(temp_path, "wb") as f:
                                f.write(data)

                            def share_intent():
                                try:
                                    activity = fragment.getParentActivity()
                                    if not activity:
                                        return

                                    from org.telegram.messenger import ApplicationLoader
                                    from androidx.core.content import FileProvider
                                    from java.io import File
                                    from android.os import Build

                                    file_obj = File(temp_path)
                                    if Build.VERSION.SDK_INT >= 24:
                                        uri = FileProvider.getUriForFile(activity, ApplicationLoader.getApplicationId() + ".provider", file_obj)
                                    else:
                                        uri = Uri.fromFile(file_obj)

                                    intent = Intent(Intent.ACTION_SEND)
                                    intent.setType("application/octet-stream")
                                    intent.putExtra(Intent.EXTRA_STREAM, uri)
                                    intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                                    activity.startActivity(Intent.createChooser(intent, _tr("share_title")))
                                    BulletinHelper.show_success(_tr("share_system"))
                                except Exception as e:
                                    BulletinHelper.show_error(str(e))

                            run_on_ui_thread(share_intent)

                            def cleanup():
                                try:
                                    if os.path.exists(temp_path):
                                        os.remove(temp_path)
                                except Exception:
                                    pass
                            run_on_queue(cleanup)
                        except Exception as e:
                            err = str(e)
                            run_on_ui_thread(lambda err=err: BulletinHelper.show_error(_tr("error_download").format(err)))

                    run_on_queue(do_send)

                def show_actions():
                    try:
                        try:
                            self.outer.pl._mkstats_event("share_menu_opened", 1)
                        except Exception:
                            pass
                        builder = AlertDialogBuilder(fragment.getParentActivity())
                        builder.set_title(_tr("share_title"))
                        builder.set_items([
                            _tr("share_copy_link"),
                            _tr("share_send_file"),
                            _tr("share_system"),
                        ], lambda _, which: (
                            copy_link() if which == 0 else
                            send_to_tg() if which == 1 else
                            send_as_file() if which == 2 else None
                        ))
                        builder.set_negative_button(_tr("cancel"), lambda d, w: d.dismiss())
                        builder.show()
                    except Exception as e:
                        log(f"[KPM] share actions error: {e}")

                run_on_ui_thread(show_actions)

            def togglePlugin(self, view):
                pass
        
        class PluginCellHook(MethodHook):
            def __init__(self, outer: "KangelPluginsManager.PluginListFragment"):
                self.create_button_method = None
                self.outer = outer
                
            def after_hooked_method(self, param):
                from android_utils import OnClickListener
                from java import jint
                from java.lang import Boolean, Integer
                try:
                    this = param.thisObject
                    p = param.args[0]
                    if not p or p.getEngine() != __id__:
                        return
                    
                    try:
                        this.setNeedDivider(False)
                    except Exception:
                        pass
                    
                    get_private_field(this, "pinButton").setVisibility(View.GONE)
                    get_private_field(this, "checkBox").setVisibility(View.GONE)
                    delete_button = get_private_field(this, "deleteButton")
                    if self.outer.type != KangelPluginsManager.DELETE:
                        delete_button.setVisibility(View.GONE)
                    plugin_id = p.getId()
                    plugin_info = self.outer.pl.plugins_list.get(plugin_id)
                    author = ""
                    description = ""
                    if isinstance(plugin_info, dict):
                        author = plugin_info.get("author", "")
                        description = plugin_info.get("description", "")
                        log(f"[KPM] PluginCellHook: {plugin_id} - author='{author[:30] if author else 'None'}', description='{description if description else 'None'}'")
                    
                    desc = get_private_field(this, "subtitleView")
                    if self.outer.type == KangelPluginsManager.UPDATE:
                        old, new = self.outer.display_names["vers"][plugin_id]
                        label = f'{old} -> {new}'
                        s = SpannableString(label)
                        try:
                            s.setSpan(StrikethroughSpan(), 0, len(old), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE)
                        except Exception:
                            pass
                        desc.setText(s)
                    else:
                        version_text = p.getVersion() or ""
                        if author:
                            if version_text:
                                desc.setText(f"{version_text} â€¢ {author}")
                            else:
                                desc.setText(author)
                        else:
                            desc.setText(version_text)
                    
                    description_view = get_private_field(this, "descriptionView")
                    if description:
                        description_view.setVisibility(View.VISIBLE)
                        description_view.setText(description)
                        description_view.setMaxLines(10 ** 8)
                        description_view.setEllipsize(TextUtils.TruncateAt.END)
                    else:
                        description_view.setVisibility(View.GONE)
                    share_button = get_private_field(this, "shareButton")
                    if self.outer.type != KangelPluginsManager.INSTALL:
                        share_button.setVisibility(View.GONE)
                    parent = share_button.getParent()
                    if parent:
                        parent.setVisibility(View.VISIBLE)
                    
                    if not getattr(self.outer, "md3_enabled", False):
                        try:
                            bg_color = Theme.getColor(Theme.key_dialogSearchBackground)
                            this.setBackground(Theme.createRoundRectDrawable(AndroidUtilities.dp(12), bg_color))
                        except Exception:
                            pass
                    
                    
                    if not self.create_button_method:
                        self.create_button_method = this.getClass().getDeclaredMethod("createButton", Context, Integer.TYPE, Boolean.TYPE, View.OnClickListener)
                        self.create_button_method.setAccessible(True)
                       
                    def create_button(icon, fn):
                        return self.create_button_method.invoke(
                            this,
                            get_last_fragment().getContext(), 
                            jint(icon), 
                            False, 
                            OnClickListener(lambda *_: fn()))
                        
                    button = None
                    view_button = None
                    if self.outer.type == KangelPluginsManager.INSTALL:
                        button = create_button(R_tg.drawable.msg_download, lambda: self.outer.pl.show_plugin_info_and_install(p.getId()))
                        def open_raw():
                            try:
                                try:
                                    self.outer.pl._mkstats_event("raw_opened", 1)
                                except Exception:
                                    pass
                                plugin_id2 = p.getId()
                                plugin_info2 = self.outer.pl.plugins_list.get(plugin_id2)
                                if not plugin_info2:
                                    run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("list_empty")))
                                    return
                                url2 = plugin_info2.get("url") if isinstance(plugin_info2, dict) else plugin_info2
                                if not url2:
                                    run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("error_download").format("No URL")))
                                    return
                                open_link(str(url2))
                            except Exception as e:
                                log(f"[KPM] open_raw error: {e}")
                        try:
                            view_button = create_button(R_tg.drawable.menu_instant_view, open_raw)
                        except Exception:
                            view_button = create_button(R_tg.drawable.menu_instant_view, open_raw)
                    elif self.outer.type == KangelPluginsManager.UPDATE:
                        def on_update():
                            self.outer.plugin_ids.remove(p.getId())
                            self.outer.adapter.update(True)
                        button = create_button(R_tg.drawable.menu_browser_refresh, lambda: self.outer.pl.update_selected_plugins([p.getId()], on_update)) 
                    existing_layout = this.findViewWithTag("kpm_buttons")
                    if existing_layout:
                        this.removeView(existing_layout)
                    
                    new_buttons_layout = LinearLayout(get_last_fragment().getContext())
                    new_buttons_layout.setTag("kpm_buttons")
                    new_buttons_layout.setOrientation(LinearLayout.HORIZONTAL)
                    gravity = Gravity.BOTTOM
                    if self.outer.type == KangelPluginsManager.INSTALL:
                        gravity = Gravity.BOTTOM
                        if share_button.getParent():
                            share_button.getParent().removeView(share_button)
                        new_buttons_layout.addView(share_button, share_button.getLayoutParams())
                        if view_button is not None:
                            new_buttons_layout.addView(view_button, share_button.getLayoutParams())
                    elif self.outer.type == KangelPluginsManager.DELETE:
                        if delete_button.getParent():
                            delete_button.getParent().removeView(delete_button)
                        new_buttons_layout.addView(delete_button, delete_button.getLayoutParams())
                    
                    if button is not None:
                        new_buttons_layout.addView(button, share_button.getLayoutParams())
                    
                    this.addView(new_buttons_layout, LayoutHelper.createFrame(-2, -2, gravity | Gravity.RIGHT, 0, 0, 0, 8))
                except Exception as e:
                    log(str(e))
        
        
        def __init__(self, pl: "KangelPluginsManager", title, plugin_ids, display_names, type = 0):
            super().__init__()
            self.title = title
            self.plugin_ids = plugin_ids
            self.display_names = display_names
            self.pl = pl
            self.search_query = None
            self.adapter = None
            self.type = type
            self.fill_id = 0
        
        def beforeCreateView(self):        
            self.content_view = FrameLayout(get_last_fragment().getContext())
            try:
                from com.exteragram.messenger import ExteraConfig
                sys_md3 = bool(getattr(ExteraConfig, "md3Containers", False))
            except Exception:
                sys_md3 = False

            kpm_md3 = self.pl.get_setting("kpm_use_md3", True)
            use_md3 = sys_md3 and kpm_md3

            self.md3_enabled = use_md3
            self.content_view.setBackgroundColor(
                Theme.getColor(Theme.key_windowBackgroundGray) if use_md3 else Theme.getColor(Theme.key_windowBackgroundWhite)
            )

            self.recycler = UniversalRecyclerView(
                get_last_fragment(),
                self.Callback2(self.fillItems),
                self.Callback5(self.onClick),
                self.Callback5Return(self.onLongClick)
            )

            self.content_view.addView(self.recycler, LayoutHelper.createFrame(-1, -1))

            if self.type == KangelPluginsManager.UPDATE and len(self.plugin_ids) > 0:
                from android_utils import OnClickListener
                updating = False
                def on_click(*_):
                    nonlocal updating
                    if updating:
                        return
                    updating = True
                    def on_update():
                        self.plugin_ids.clear()
                        self.adapter.update(True)
                    self.pl.update_selected_plugins(self.plugin_ids, on_update)
                    
                update_all_button = TextView(get_last_fragment().getContext())
                update_all_button.setPadding(AndroidUtilities.dp(34), 0, AndroidUtilities.dp(34), 0)
                update_all_button.setGravity(Gravity.CENTER)
                update_all_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
                update_all_button.setTypeface(AndroidUtilities.bold())
                update_all_button.setText(_tr("update_plugins"))

                update_all_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
                update_all_button.setBackground(Theme.AdaptiveRipple.filledRectByKey(Theme.key_featuredStickers_addButton, 4))
                update_all_button.setOnClickListener(OnClickListener(on_click))
                self.content_view.addView(update_all_button, LayoutHelper.createFrame(-1, 48, Gravity.BOTTOM, 7, 0, 7, 0))

            return self.content_view
        
        def getTitle(self):
            return self.title
        
        def onBackPressed(self):
            get_last_fragment().finishFragment()
            return None
        
        def fillItems(self, items, adapter):
            self.adapter = adapter
            self.items = items
            self.fill_id += 1
            try:
                status_filter = str(self.pl.get_setting("plugins_status_filter", "*") or "*")
            except Exception:
                status_filter = "*"

            def _passes_status(pid):
                if status_filter == "*":
                    return True
                try:
                    info = self.pl.plugins_list.get(pid)
                    if isinstance(info, dict):
                        return (info.get("status") or "plugin") == status_filter
                except Exception:
                    pass
                return status_filter == "plugin"
            if self.search_query:
                query = str(self.search_query)
                if len(query.strip()) >= 3 and getattr(self.pl, "_trigram_index", None):
                    ranked = self.pl._trigram_search(query, allowed_ids=self.plugin_ids)
                    if ranked:
                        plugin_ids = [pid for pid in ranked if _passes_status(pid)]
                    else:
                        plugin_ids = []
                else:
                    def match(pid):
                        name = self.display_names.get(pid)
                        if not name:
                            name = pid
                        elif not isinstance(name, str):
                            name = name.get("name", pid)

                        query_lower = query.lower()
                        return query_lower in name.lower() or query_lower in pid.lower()

                    plugin_ids = [pid for pid in self.plugin_ids if match(pid) and _passes_status(pid)]
            else:
                plugin_ids = [pid for pid in self.plugin_ids if _passes_status(pid)]

            try:
                mode = int(self.pl.get_setting("plugins_sort_mode", 0) or 0)

                def _name_for_sort(pid):
                    name = self.display_names.get(pid)
                    if not name:
                        return pid
                    if isinstance(name, str):
                        return name
                    if isinstance(name, dict):
                        return name.get("name", pid)
                    return pid

                def _author_for_sort(pid):
                    try:
                        info = self.pl.plugins_list.get(pid)
                        if isinstance(info, dict):
                            return (info.get("author") or "").lower()
                    except Exception:
                        pass
                    return ""

                def _status_for_sort(pid):
                    try:
                        info = self.pl.plugins_list.get(pid)
                        if isinstance(info, dict):
                            return info.get("status", "plugin")
                    except Exception:
                        pass
                    return "plugin"

                if mode == 1:
                    plugin_ids = sorted(plugin_ids, key=lambda pid: _name_for_sort(pid).lower(), reverse=False)
                elif mode == 2:
                    plugin_ids = sorted(plugin_ids, key=lambda pid: _name_for_sort(pid).lower(), reverse=True)
                elif mode == 3:
                    plugin_ids = sorted(plugin_ids, key=lambda pid: (_author_for_sort(pid), _name_for_sort(pid).lower()), reverse=False)
                elif mode == 4:
                    plugin_ids = sorted(plugin_ids, key=lambda pid: (_author_for_sort(pid), _name_for_sort(pid).lower()), reverse=True)
                elif mode == 5:
                    plugin_ids = sorted(plugin_ids, key=lambda pid: (_status_sort_key(_status_for_sort(pid)), _name_for_sort(pid).lower()), reverse=False)

            except Exception as e:
                log(f"[KPM] Sort error: {e}")
        
            self.addItems(0, plugin_ids, items, self.fill_id)
        
        chunk_size = 25
        def addItems(self, i, plugins_ids, items, fid):
            try:
                if fid != self.fill_id:
                    return
                from_ = i*self.chunk_size
                len_ = len(plugins_ids)
                get_ = min(self.chunk_size, len_ - from_)
                stop = from_ + get_
                for j in range(from_, stop):
                    pid = plugins_ids[j]
                    if self.type == KangelPluginsManager.DELETE:
                        name = self.display_names[pid].get("name", pid) if isinstance(self.display_names[pid], dict) else self.display_names[pid]
                    elif self.type == KangelPluginsManager.UPDATE:
                        name = self.display_names["d"].get(pid, pid)
                    else:
                        name = self.display_names.get(pid, pid)
                        
                    p = Plugin(pid, name)
                    p.setEngine(__id__)
                    icon = None
                    ver = None
                    if self.type == KangelPluginsManager.INSTALL:
                        info = self.pl.plugins_list.get(pid)
                        if not info:
                            continue
                        icon = info.get("icon")
                        ver = info.get("version")  
                    elif self.type == KangelPluginsManager.DELETE:
                        mt = self.display_names.get(pid)
                        if isinstance(mt, dict):
                            icon = mt.get("icon")
                            ver = mt.get("version")
                        else: continue
                    elif self.type == KangelPluginsManager.UPDATE:
                        info = self.pl.plugins_list.get(pid)
                        if info:
                            icon = info.get("icon")
                            ver = info.get("version")
                        
                    if isinstance(icon, str):
                        p.setIcon(icon) 
                    if isinstance(ver, str):
                        p.setVersion(ver)   
                        
                    from com.exteragram.messenger.plugins.ui.components import \
                        PluginCell
                    try:
                        items.add(PluginCell.Factory.asPlugin(p, self.PluginCellDelegate(pid, self)))
                    except Exception as e:
                        log(f"[KPM] PluginCell.Factory.asPlugin failed, trying UItem.asPlugin: {e}")
                        try:
                            items.add(UItem.asPlugin(1, p, self.PluginCellDelegate(pid, self)))
                        except Exception as e2:
                            log(f"[KPM] UItem.asPlugin also failed: {e2}")
                if stop >= len_ and self.type == KangelPluginsManager.UPDATE:
                    items.add(UItem.asSpace(AndroidUtilities.dp(48)))
                
                if i != 0:
                    self.adapter.notifyItemRangeInserted(from_, get_)
                
                if stop >= len_:
                    return
                delay = 100 if i < 2 else 200
                run_on_ui_thread(lambda: self.addItems(i + 1, plugins_ids, items, fid), delay)
            except Exception as e:
                log(str(e))
        
        def onClick(self, item, view, position, x, y):
            return False
    
        def onLongClick(self, item, view, position, x, y):
            return False
        
        def afterCreateView(self, view):
            pass
        
        def onFragmentCreate(self, *_):
            from com.exteragram.messenger.plugins.ui.components import \
                PluginCell
            self.set_hook = self.pl.hook_method(PluginCell.getClass().getDeclaredMethod("set", Plugin, PluginCellDelegate), self.PluginCellHook(self))

            if getattr(self, "md3_enabled", False):
                try:
                    adapter = self.recycler.getAdapter()
                    if adapter and hasattr(adapter, "setApplyBackground"):
                        adapter.setApplyBackground(True)
                    else:
                        self.md3_enabled = False
                except Exception as e:
                    self.md3_enabled = False
                    log(f"[KPM] Failed to enable MD3: {e}")

            if not getattr(self, "md3_enabled", False):
                try:
                    self.content_view.setBackgroundColor(Theme.getColor(Theme.key_windowBackgroundWhite))
                except Exception:
                    pass
        
        def onFragmentDestroy(self, *_):
            self.fill_id += 1
            self.content_view.getParent().removeView(self.content_view)
            if self.set_hook:
                self.pl.unhook_method(self.set_hook)
            if self.pl.search_listener_hooks:
                for h in self.pl.search_listener_hooks:
                    self.pl.unhook_method(h)
            self.set_hook = None
            self.pl.search_listener_hooks = None
            
        def onMenuItemClick(self, *_):
            pass

    def open_delete_dialog(self):
        def load_and_show():
            try:
                installed = self.list_installed_plugins()
                if not installed:
                    run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("no_installed")))
                    return

                mt = {}
                for pid in installed:
                    filename = f"{pid}.py"
                    local_path = os.path.join(PLUGINS_DIR, filename)
                    try:
                        if os.path.exists(local_path):
                            with open(local_path, "rb") as f:
                                content = f.read()
                            if content:
                                metadata = self.parse_plugin_metadata(content)
                                metadata["name"] = metadata["name"] if metadata["name"] else pid
                                mt[pid] = metadata
                            else:
                                mt[pid] = {"name": pid}
                        else:
                            mt[pid] = {"name": pid}
                    except Exception:
                        mt[pid] = {"name": pid}
                
                def show_dialog():
                    try:
                        current_fragment = get_last_fragment()
                        if not current_fragment:
                            return
                        self._show_plugin_list(_tr("delete_title"), installed, mt, KangelPluginsManager.DELETE)
                    except Exception as e:
                        log(f"[KPM] Error creating delete dialog: {e}")
                
                run_on_ui_thread(show_dialog)
            except Exception as e:
                log(f"[KPM] Error in open_delete_dialog: {e}")

        run_on_queue(load_and_show)

    def list_installed_plugins(self):
        installed = []
        try:
            if not os.path.isdir(PLUGINS_DIR):
                return installed
            if hasattr(self, '_installed_cache_time') and (time.time() - self._installed_cache_time) < 5:
                if hasattr(self, '_installed_cache'):
                    return self._installed_cache

            files = os.listdir(PLUGINS_DIR)
            for name in files:
                if not name.endswith(".py"):
                    continue
                path = os.path.join(PLUGINS_DIR, name)
                try:
                    with open(path, "rb") as f:
                        content = f.read()
                    
                    plugin_id = None
                    if content:
                        import re
                        match = re.search(rb'__id__\s*=\s*["\'](.*?)["\']', content)
                        if match:
                            plugin_id = match.group(1).decode('utf-8', errors='ignore')
                    
                    if not plugin_id:
                        plugin_id = name[:-3]
                    
                    installed.append(plugin_id)
                except Exception:
                    continue

            installed = list(set(installed))
            self._installed_cache = installed
            self._installed_cache_time = time.time()
            
            return installed
        except Exception as e:
            log(f"[KPM] Error listing installed plugins: {e}")
            return installed

    def delete_plugin_by_id(self, plugin_id, fn = None):
        def on_delete_callback(error):
            def update_ui():
                if error:
                    BulletinHelper.show_error(_tr("error_delete").format(str(error)))
                else:
                    BulletinHelper.show_success(_tr("deleted").format(plugin_id))
                if fn:
                    fn(plugin_id)
            
            run_on_ui_thread(update_ui)
        
        try:
            class DeleteCallback(dynamic_proxy(Utilities.Callback)):
                def __init__(self, fn):
                    super().__init__()
                    self._fn = fn
                def run(self, arg):
                    try:
                        self._fn(arg)
                    except Exception as e:
                        log(f"[KPM] Error in delete callback: {e}")
            
            PluginsController.getInstance().deletePlugin(plugin_id, DeleteCallback(on_delete_callback))
            log(f"[KPM] Initiated deletion of plugin: {plugin_id}")
        except Exception as e:
            log(f"[KPM] Error deleting plugin {plugin_id}: {e}")
            run_on_ui_thread(lambda err=str(e): BulletinHelper.show_error(_tr("error_delete").format(err)))

    def get_local_plugin_path(self, plugin_id):
        return os.path.join(PLUGINS_DIR, f"{plugin_id}.plugin")

    def read_file_bytes(self, path):
        try:
            with open(path, "rb") as f:
                return f.read()
        except Exception:
            return None

    def sha256(self, data):
        h = hashlib.sha256()
        h.update(data)
        return h.hexdigest()

    def fetch_remote_bytes(self, url):
        r = requests.get(url, timeout=30)
        if r.status_code != 200:
            raise Exception(f"HTTP {r.status_code}")
        return r.content

    def install_plugin_by_id(self, plugin_id, _installing_deps=None, enable_after=False):
        def do_install():
            try:
                deps_set = _installing_deps if _installing_deps is not None else set()
                if plugin_id in deps_set:
                    return              
                if not self.plugins_list:
                    self.refresh_store()             
                if plugin_id not in self.plugins_list:
                    error_msg = f"Plugin {plugin_id} not found in store"
                    run_on_ui_thread(lambda: BulletinHelper.show_error(error_msg))
                    return
                
                plugin_info = self.plugins_list[plugin_id]
                url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
                dependencies = plugin_info.get("dependencies", []) if isinstance(plugin_info, dict) else []
                
                remote = self.fetch_remote_bytes(url)
                
                target = os.path.join(PLUGINS_DIR, f"{plugin_id}.py")
                tmp = target + ".tmp"
                
                with open(tmp, "wb") as f:
                    f.write(remote)
                
                if os.path.exists(target):
                    os.remove(target)
                shutil.move(tmp, target)
                
                def notify_installed():
                    try:
                        controller = PluginsController.getInstance()
                        if controller and hasattr(controller, 'engines'):
                            engine = controller.engines.get("python")
                            if engine:
                                engine.loadPlugins(None)
                        NotificationCenter.getGlobalInstance().postNotificationName(NotificationCenter.pluginsUpdated)
                        
                        if enable_after:
                            controller.setPluginEnabled(plugin_id, True, None)
                    except Exception as e:
                        log(f"[KPM] Error reloading plugins: {e}")
                    BulletinHelper.show_error(_tr("installed").format(f"{plugin_id}.py"))
                
                run_on_ui_thread(notify_installed)
            except Exception as e:
                log(f"[KPM] ERROR installing {plugin_id}: {e}")
                run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("error_write").format(e)))

        run_on_queue(do_install)

    def update_installed_from_store(self):
        if not self.plugins_list:
            self.refresh_store()
        if not self.plugins_list:
            return
        updated = 0
        skipped = 0
        failed = 0
        installed_ids = self.list_installed_plugins()
        for pid in installed_ids:
            plugin_info = self.plugins_list.get(pid)
            if not plugin_info:
                continue
            url = plugin_info.get("url") if isinstance(plugin_info, dict) else plugin_info
            local_path = os.path.join(PLUGINS_DIR, f"{pid}.py")
            if not os.path.exists(local_path):
                continue
            
            try:
                local_bytes = self.read_file_bytes(local_path)
                if not local_bytes:
                    continue
                local_metadata = self.parse_plugin_metadata(local_bytes)
                local_version = local_metadata.get("version", "1.0")
                remote_version = str(plugin_info.get("version", "0"))
                if remote_version != local_version:
                    try:
                        remote = self.fetch_remote_bytes(url)
                        tmp = local_path + ".tmp"
                        with open(tmp, "wb") as f:
                            f.write(remote)
                        if os.path.exists(local_path):
                            os.remove(local_path)
                        shutil.move(tmp, local_path)
                        updated += 1
                    except Exception:
                        failed += 1
                else:
                    skipped += 1
            except Exception:
                failed += 1
        run_on_ui_thread(lambda: BulletinHelper.show_error(_tr("updated_stats").format(updated, skipped, failed)))
