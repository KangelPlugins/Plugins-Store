from base_plugin import BasePlugin, HookResult, HookStrategy, MenuItemData, MenuItemType
from hook_utils import find_class
from java import jclass
from ui.settings import Selector, Input, Divider, Switch, Text
from ui.alert import AlertDialogBuilder
from ui.bulletin import BulletinHelper
from org.telegram.messenger import R as R_tg, AndroidUtilities
from android.text import SpannableStringBuilder
from android.text import Spanned
from android.text.style import TypefaceSpan
from android.graphics import Typeface
import urllib.parse
import hashlib
import time
import os
import json
from java.io import File
from client_utils import get_last_fragment, get_messages_controller
from android_utils import run_on_ui_thread, OnClickListener
from com.exteragram.messenger.plugins import PluginsController
from com.exteragram.messenger.plugins.ui import PluginSettingsActivity
from org.telegram.ui.ActionBar import BottomSheet, Theme, SimpleTextView
from org.telegram.ui.Components import LayoutHelper
from android.view import Gravity
from android.widget import FrameLayout, ImageView, TextView
from android.util import TypedValue

# Refer√™ncias para classes nativas do Android
LinearLayout = find_class("android.widget.LinearLayout")
WebView = find_class("android.webkit.WebView")
WebViewClient = find_class("android.webkit.WebViewClient")
EditText = find_class("android.widget.EditText")

# Classes para navegador nativo - Opcional
try:
    ApplicationLoader = find_class("org.telegram.messenger.ApplicationLoader")
    Browser = find_class("org.telegram.messenger.browser.Browser")
except Exception:
    ApplicationLoader = None
    Browser = None

__id__ = "searchit"
__name__ = "Search It"
__description__ = (
    "Search It lets you quickly search the web using search engines like Google, Yandex, Bing, and more, "
    "directly from the chat, formatting menu, or via command.\n\n"
    "Usage:\n"
    "- Chat menu: tap Plugins ‚Üí Search to open the search box.\n"
    "- Formatting menu: select a word or text and choose Search to see results.\n"
    "- Command: type .sr <term> for direct results, or just .sr to open the search box.\n\n"
    "You can configure your preferred search engine or a custom URL in settings with .panel.\n\n"
    "by @ApplePlugins Lab ‚Ä¢ @exteraDevPlugins"
)
__author__ = "@AGeekApple"
__version__ = "1.0.2"
__min_version__ = "11.12.0"
__icon__ = "AppleDevIcon/2"

# Diret√≥rio de cache local - Experimental
CACHE_DIR = "/storage/emulated/0/Android/media/com.exteragram.messenger/searchit"
HISTORY_FILE = os.path.join(CACHE_DIR, "search_history.json")
LAST_URL_FILE = os.path.join(CACHE_DIR, "last_url.txt")

# Dicion√°rio de tradu√ß√£o e ajudantes
TRANSLATIONS = {
    "language": {"en": "Language", "ru": "–Ø–∑—ã–∫", "pt": "Idioma", "es": "Idioma", "fr": "Langue", "it": "Lingua"},
    "lang_en": {"en": "English", "ru": "–ê–Ω–≥–ª–∏–π—Å–∫–∏–π", "pt": "Ingl√™s", "es": "Ingl√©s", "fr": "Anglais", "it": "Inglese"},
    "lang_ru": {"en": "Russian", "ru": "–†—É—Å—Å–∫–∏–π", "pt": "Russo", "es": "Ruso", "fr": "Russe", "it": "Russo"},
    "lang_pt": {"en": "Portuguese", "ru": "–ü–æ—Ä—Ç—É–≥–∞–ª—å—Å–∫–∏–π", "pt": "Portugu√™s", "es": "Portugu√©s", "fr": "Portugais", "it": "Portoghese"},
    "lang_es": {"en": "Spanish", "ru": "–ò—Å–ø–∞–Ω—Å–∫–∏–π", "pt": "Espanhol", "es": "Espa√±ol", "fr": "Espagnol", "it": "Spagnolo"},
    "lang_fr": {"en": "French", "ru": "–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π", "pt": "Franc√™s", "es": "Franc√©s", "fr": "Fran√ßais", "it": "Francese"},
    "lang_it": {"en": "Italian", "ru": "–ò—Ç–∞–ª—å—è–Ω—Å–∫–∏–π", "pt": "Italiano", "es": "Italiano", "fr": "Italien", "it": "Italiano"},

    "extras_section": {"en": "Extras", "ru": "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ", "pt": "Extras", "es": "Extras", "fr": "Extras", "it": "Extra"},
    "enable_switch_title": {"en": "Enable in formatting menu", "ru": "–í–∫–ª—é—á–∏—Ç—å –≤ –º–µ–Ω—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", "pt": "Habilitar no menu de formata√ß√£o", "es": "Habilitar en el men√∫ de formato", "fr": "Activer dans le menu de formatage", "it": "Abilita nel menu di formattazione"},
    "enable_switch_subtext": {"en": "Adds ‚ÄòSearch‚Äô option to composer formatting actions", "ru": "–î–æ–±–∞–≤–ª—è–µ—Ç –ø—É–Ω–∫—Ç ‚Äò–ü–æ–∏—Å–∫‚Äô –∫ –¥–µ–π—Å—Ç–≤–∏—è–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è", "pt": "Adiciona op√ß√£o ‚ÄòPesquisar‚Äô √†s a√ß√µes de formata√ß√£o do editor", "es": "A√±ade la opci√≥n ‚ÄòBuscar‚Äô a las acciones de formato del editor", "fr": "Ajoute l‚Äôoption ‚ÄòRechercher‚Äô aux actions de formatage", "it": "Aggiunge l‚Äôopzione ‚ÄòCerca‚Äô alle azioni di formattazione"},
    "show_chat_menu_title": {"en": "Show in chat menu", "ru": "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –º–µ–Ω—é —á–∞—Ç–∞", "pt": "Mostrar no menu do chat", "es": "Mostrar en el men√∫ del chat", "fr": "Afficher dans le menu du chat", "it": "Mostra nel menu della chat"},
    "show_chat_menu_subtext": {"en": "Adds ‚ÄòSearch‚Äô to Plugins in chat overflow", "ru": "–î–æ–±–∞–≤–ª—è–µ—Ç ‚Äò–ü–æ–∏—Å–∫‚Äô –≤ \"Plugins\" –≤ –º–µ–Ω—é —á–∞—Ç–∞", "pt": "Adiciona ‚ÄòPesquisar‚Äô em Plugins no menu do chat", "es": "A√±ade ‚ÄòBuscar‚Äô en Plugins del men√∫ del chat", "fr": "Ajoute ‚ÄòRecherche‚Äô dans Plugins du menu de chat", "it": "Aggiunge ‚ÄòCerca‚Äô in Plugins nel menu della chat"},
    "provider_section": {"en": "Search Provider", "ru": "–ü–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞", "pt": "Provedor de Pesquisa", "es": "Proveedor de b√∫squeda", "fr": "Moteur de recherche", "it": "Motore di ricerca"},
    "search_provider": {"en": "Search Provider", "ru": "–ü–æ–∏—Å–∫–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞", "pt": "Provedor de Pesquisa", "es": "Proveedor de b√∫squeda", "fr": "Moteur de recherche", "it": "Motore di ricerca"},
    "custom_provider_url": {"en": "Custom Provider URL", "ru": "URL –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞", "pt": "URL do Provedor Customizado", "es": "URL del proveedor personalizado", "fr": "URL du fournisseur personnalis√©", "it": "URL del provider personalizzato"},
    "search_title": {"en": "Search", "ru": "–ü–æ–∏—Å–∫", "pt": "Pesquisar", "es": "Buscar", "fr": "Recherche", "it": "Cerca"},
    "menu_item_search": {"en": "Search", "ru": "–ü–æ–∏—Å–∫", "pt": "Pesquisar", "es": "Buscar", "fr": "Recherche", "it": "Cerca"},
    "search_input_hint": {"en": "Type your query", "ru": "–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å", "pt": "Digite sua pesquisa", "es": "Escribe tu consulta", "fr": "Tapez votre requ√™te", "it": "Digita la tua ricerca"},
    "usage_sr": {"en": "Usage: .sr <term>", "ru": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: .sr <—Ç–µ–∫—Å—Ç>", "pt": "Uso: .sr <termo>", "es": "Uso: .sr <t√©rmino>", "fr": "Utilisation : .sr <terme>", "it": "Uso: .sr <termine>"},
    "panel_open_error": {"en": "Error opening settings", "ru": "–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫", "pt": "Erro ao abrir configura√ß√µes", "es": "Error al abrir la configuraci√≥n", "fr": "Erreur d‚Äôouverture des param√®tres", "it": "Errore nell‚Äôaprire le impostazioni"},

    "ctc_chat_title": {"en": "CTC: Chat Menu", "ru": "CTC: –ú–µ–Ω—é —á–∞—Ç–∞", "pt": "CTC: Menu do Chat", "es": "CTC: Men√∫ del chat", "fr": "CTC: Menu du chat", "it": "CTC: Menu della chat"},
    "ctc_chat_sub": {"en": "Adds Circle to Search to Plugins in chat overflow", "ru": "–î–æ–±–∞–≤–ª—è–µ—Ç ‚ÄòCircle to Search‚Äô –≤ Plugins –≤ –º–µ–Ω—é —á–∞—Ç–∞", "pt": "Adiciona ‚ÄòCircle to Search‚Äô em Plugins no menu do chat", "es": "A√±ade ‚ÄòCircle to Search‚Äô en Plugins del men√∫ del chat", "fr": "Ajoute ‚ÄòCircle to Search‚Äô dans Plugins du menu de chat", "it": "Aggiunge ‚ÄòCircle to Search‚Äô in Plugins nel menu della chat"},
    "ctc_ctx_title": {"en": "CTC: Context Menu", "ru": "CTC: –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é", "pt": "CTC: Menu de Contexto", "es": "CTC: Men√∫ contextual", "fr": "CTC: Menu contextuel", "it": "CTC: Menu contestuale"},
    "ctc_ctx_sub": {"en": "Triggers Circle to Search via context menu shortcut", "ru": "–í—ã–∑—ã–≤–∞–µ—Ç Circle to Search —á–µ—Ä–µ–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é", "pt": "Aciona o Circle to Search via atalho no menu de contexto", "es": "Activa Circle to Search a trav√©s del men√∫ contextual", "fr": "D√©clenche Circle to Search via le menu contextuel", "it": "Attiva Circle to Search tramite il menu contestuale"},
    "ctc_menu_item": {"en": "Circle to Search", "ru": "Circle to Search", "pt": "Circle to Search", "es": "Circle to Search", "fr": "Circle to Search", "it": "Circle to Search"}
}
TRANSLATIONS.update({
    "command_selector_title": {"en": "Command Trigger", "ru": "–¢—Ä–∏–≥–≥–µ—Ä –∫–æ–º–∞–Ω–¥—ã", "pt": "Acionador do comando", "es": "Disparador del comando", "fr": "D√©clencheur de commande", "it": "Trigger comando"},
    "command_option_default": {"en": "Default (.sr)", "ru": "–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é (.sr)", "pt": "Padr√£o (.sr)", "es": "Predeterminado (.sr)", "fr": "Par d√©faut (.sr)", "it": "Predefinito (.sr)"},
    "command_option_custom": {"en": "Custom", "ru": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π", "pt": "Personalizado", "es": "Personalizado", "fr": "Personnalis√©", "it": "Personalizzato"},
    "custom_command_label": {"en": "Custom Command", "ru": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞", "pt": "Comando personalizado", "es": "Comando personalizado", "fr": "Commande personnalis√©e", "it": "Comando personalizzato"},
    "dotted_credit": {"en": "Dotted Plugins", "ru": "Dotted Plugins", "pt": "Dotted Plugins", "es": "Dotted Plugins", "fr": "Dotted Plugins", "it": "Dotted Plugins"}
})

# Op√ß√µes de Exibi√ß√£o: Tela Cheia e Janela Flutuante
TRANSLATIONS.update({
    "fullscreen_title": {
    "en": "Fullscreen Mode",
    "ru": "–†–µ–∂–∏–º –ø–æ–ª–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞",
    "pt": "Tela Adaptativa",
    "es": "Modo Pantalla Completa",
    "fr": "Mode Plein √âcran",
    "it": "Modalit√† Schermo Intero"
    },
    "screen_options": {
        "en": "Display Mode",
        "ru": "–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è",
        "pt": "Modo de Exibi√ß√£o",
        "es": "Modo de Pantalla",
        "fr": "Mode d‚Äôaffichage",
        "it": "Modalit√† Schermo"
    },
    "fullscreen_subtext": {
        "en": "Display results in an expanded view for better visibility.",
        "ru": "–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–º –æ–∫–Ω–µ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏.",
        "pt": "Exibe os resultados em uma visualiza√ß√£o ampliada para melhor visualiza√ß√£o.",
        "es": "Muestra los resultados en una vista ampliada para una mejor visualizaci√≥n.",
        "fr": "Affiche les r√©sultats dans une vue agrandie pour une meilleure visibilit√©.",
        "it": "Mostra i risultati in una vista ampliata per una migliore visibilit√†."
    },
    "floating_window_title": {
    "en": "Floating Window",
    "ru": "–ü–ª–∞–≤–∞—é—â–µ–µ –æ–∫–Ω–æ",
    "pt": "Janela Flutuante",
    "es": "Ventana Flotante",
    "fr": "Fen√™tre Flottante",
    "it": "Finestra Fluttuante"
    },
    "floating_window_subtext": {
    "en": "Keep results visible in a small draggable window while you browse other content.",
    "ru": "–î–µ—Ä–∂–∏—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤–∏–¥–∏–º—ã–º–∏ –≤ –Ω–µ–±–æ–ª—å—à–æ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–µ–º–æ–º –æ–∫–Ω–µ, –ø–æ–∫–∞ –≤—ã –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞–µ—Ç–µ –¥—Ä—É–≥–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç.",
    "pt": "Mantenha os resultados vis√≠veis em uma pequena janela que pode ser arrastada enquanto voc√™ navega em outros conte√∫dos.",
    "es": "Mant√©n los resultados visibles en una peque√±a ventana desplazable mientras navegas por otros contenidos.",
    "fr": "Gardez les r√©sultats visibles dans une petite fen√™tre que vous pouvez d√©placer tout en naviguant dans d‚Äôautres contenus.",
    "it": "Mantieni i risultati visibili in una piccola finestra trascinabile mentre navighi altri contenuti."
    },
    "overlay_minimize": {"en": "Min", "ru": "–°–≤.", "pt": "Min", "es": "Min", "fr": "Min", "it": "Min"},
    "overlay_open_webview": {"en": "Results", "ru": "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã", "pt": "Resultados", "es": "Resultados", "fr": "R√©sultats", "it": "Risultati"},
    "overlay_close": {"en": "Close", "ru": "–ó–∞–∫—Ä—ã—Ç—å", "pt": "Fechar", "es": "Cerrar", "fr": "Fermer", "it": "Chiudi"},
    "overlay_actions": {"en": "Actions", "ru": "–î–µ–π—Å—Ç–≤–∏—è", "pt": "A√ß√µes", "es": "Acciones", "fr": "Actions", "it": "Azioni"}
})
TRANSLATIONS.update({
    "overlay_buttons_mode_title": {
        "en": "Show Icon Names",
        "ru": "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –∏–∫–æ–Ω–æ–∫",
        "pt": "Mostrar nomes dos √≠cones",
        "es": "Mostrar nombres de iconos",
        "fr": "Afficher les noms des ic√¥nes",
        "it": "Mostra nomi icone"
    },
    "overlay_buttons_mode_icons_only": {
        "en": "Icons Only",
        "ru": "–¢–æ–ª—å–∫–æ –∏–∫–æ–Ω–∫–∏",
        "pt": "Apenas √≠cones",
        "es": "Solo iconos",
        "fr": "Ic√¥nes uniquement",
        "it": "Solo icone"
    },
    "overlay_buttons_mode_icon_names": {
        "en": "Icon & Names",
        "ru": "–ò–∫–æ–Ω–∫–∞ –∏ –Ω–∞–∑–≤–∞–Ω–∏—è",
        "pt": "√çcone e nomes",
        "es": "Icono y nombres",
        "fr": "Ic√¥ne et noms",
        "it": "Icona e nomi"
    },
    "native_browser_title": {
        "en": "Use Native Browser",
        "ru": "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä",
        "pt": "Usar Navegador Nativo",
        "es": "Usar Navegador Nativo",
        "fr": "Utiliser le navigateur natif",
        "it": "Usa Browser Nativo"
    },
    "native_browser_subtext": {
        "en": "Open search results in the system's default browser instead of in-app WebView",
        "ru": "–û—Ç–∫—Ä—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤–æ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –±—Ä–∞—É–∑–µ—Ä–µ —Å–∏—Å—Ç–µ–º—ã –≤–º–µ—Å—Ç–æ WebView",
        "pt": "Abrir resultados de pesquisa no navegador padr√£o do sistema em vez do WebView interno",
        "es": "Abrir resultados de b√∫squeda en el navegador predeterminado del sistema en lugar del WebView interno",
        "fr": "Ouvrir les r√©sultats de recherche dans le navigateur par d√©faut du syst√®me au lieu du WebView int√©gr√©",
        "it": "Apri i risultati di ricerca nel browser predefinito del sistema invece del WebView integrato"
    },
    "advanced_options_title": {
        "en": "Advanced Options",
        "ru": "–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏",
        "pt": "Op√ß√µes Avan√ßadas",
        "es": "Opciones Avanzadas",
        "fr": "Options Avanc√©es",
        "it": "Opzioni Avanzate"
    },
    "advanced_options_subtext": {
        "en": "Interface integration, native browser, custom commands, and context menu options",
        "ru": "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é",
        "pt": "Integra√ß√£o de interface, navegador nativo, comandos personalizados e menu de contexto",
        "es": "Integraci√≥n de interfaz, navegador nativo, comandos personalizados y men√∫ contextual",
        "fr": "Int√©gration d'interface, navigateur natif, commandes personnalis√©es et menu contextuel",
        "it": "Integrazione interfaccia, browser nativo, comandi personalizzati e menu contestuale"
    },

    "recent_searches_title": {
        "en": "Your recent searches:",
        "ru": "–í–∞—à–∏ –Ω–µ–¥–∞–≤–Ω–∏–µ –ø–æ–∏—Å–∫–∏:",
        "pt": "Suas pesquisas recentes:",
        "es": "Sus b√∫squedas recientes:",
        "fr": "Vos recherches r√©centes:",
        "it": "Le tue ricerche recenti:"
    },
    "copy_button": {
        "en": "Copy",
        "ru": "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å",
        "pt": "Copiar",
        "es": "Copiar",
        "fr": "Copier",
        "it": "Copia"
    },
    "no_recent_searches": {
        "en": "No recent searches found",
        "ru": "–ù–µ–¥–∞–≤–Ω–∏–µ –ø–æ–∏—Å–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã",
        "pt": "Nenhuma pesquisa recente encontrada",
        "es": "No se encontraron b√∫squedas recientes",
        "fr": "Aucune recherche r√©cente trouv√©e",
        "it": "Nessuna ricerca recente trovata"
    },
    "overlay_buttons_mode_names_only": {
        "en": "Only Names",
        "ru": "–¢–æ–ª—å–∫–æ –Ω–∞–∑–≤–∞–Ω–∏—è",
        "pt": "Apenas nomes",
        "es": "Solo nombres",
        "fr": "Uniquement les noms",
        "it": "Solo nomi"
    },
    "overlay_back": {
        "en": "Back",
        "ru": "–ù–∞–∑–∞–¥",
        "pt": "Voltar",
        "es": "Atr√°s",
        "fr": "Retour",
        "it": "Indietro"
    },
    "overlay_forward": {
        "en": "Forward",
        "ru": "–í–ø–µ—Ä—ë–¥",
        "pt": "Avan√ßar",
        "es": "Adelante",
        "fr": "Avancer",
        "it": "Avanti"
    }
})

# Navega√ß√£o e hist√≥rico
TRANSLATIONS.update({
    "navigation_section": {"en": "Navigation", "ru": "–ù–∞–≤–∏–≥–∞—Ü–∏—è", "pt": "Navega√ß√£o", "es": "Navegaci√≥n", "fr": "Navigation", "it": "Navigazione"},
    "history_title": {
    "en": "Save History (Experimental)",
    "ru": "–°–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é (—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω–æ)",
    "pt": "Salvar hist√≥rico (experimental)",
    "es": "Guardar historial (experimental)",
    "fr": "Enregistrer l‚Äôhistorique (exp√©rimental)",
    "it": "Salva cronologia (sperimentale)"
    },
    "history_subtext": {
    "en": "When disabled, your search history and cache are cleared automatically after each search",
    "ru": "–ï—Å–ª–∏ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∫–ª—é—á–µ–Ω–∞, –∏—Å—Ç–æ—Ä–∏—è –∏ –∫—ç—à –æ—á–∏—â–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–∏—Å–∫–∞",
    "pt": "Quando desativado, o hist√≥rico e o cache s√£o limpos automaticamente ap√≥s cada pesquisa",
    "es": "Cuando est√° desactivado, el historial y la cach√© se borran autom√°ticamente despu√©s de cada b√∫squeda",
    "fr": "Lorsqu‚Äôelle est d√©sactiv√©e, l‚Äôhistorique et le cache sont effac√©s automatiquement apr√®s chaque recherche",
    "it": "Quando disattivato, la cronologia e la cache vengono eliminate automaticamente dopo ogni ricerca"
    },
    "keep_open_info": {"en": "Use .open to reopen the last page", "ru": "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ .open —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É", "pt": "Use .open para reabrir a √∫ltima p√°gina", "es": "Usa .open para reabrir la √∫ltima p√°gina", "fr": "Utilisez .open pour rouvrir la derni√®re page", "it": "Usa .open per riaprire l‚Äôultima pagina"},
    "open_no_last_url": {"en": "No last page to open", "ru": "–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è", "pt": "Nenhuma p√°gina anterior para abrir", "es": "No hay √∫ltima p√°gina para abrir", "fr": "Aucune derni√®re page √† ouvrir", "it": "Nessuna ultima pagina da aprire"}
})

# Strings da folha "Como Usar"
TRANSLATIONS.update({
    "howto_title": {"en": "How to Use", "ru": "–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å", "pt": "Como Usar", "es": "C√≥mo usar", "fr": "Comment utiliser", "it": "Come usare"},
    "howto_subtitle": {"en": "Quick guide", "ru": "–ö—Ä–∞—Ç–∫–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ", "pt": "Guia r√°pido", "es": "Gu√≠a r√°pida", "fr": "Guide rapide", "it": "Guida rapida"},
    "howto_description": {
        "en": (
            "SearchIt lets you search in four ways:\n\n"
            "- Chat menu: enable ‚ÄòShow in chat menu‚Äô and tap Plugins ‚Üí Search to open the search box.\n"
            "- Formatting menu: select text in the composer and choose Search to open results.\n"
            "- Command: type .sr <term> to open results directly, or just .sr to open the search box. If you set a Custom Command in settings, use it instead of .sr.\n"
            "- Choose a provider: select a search provider directly in chat with .select <provider> (Google, Bing, etc.) or open settings to choose it there.\n\n"
            "You can also search directly on supported video platforms:\n"
            "‚Ä¢ YouTube ‚Äî use .sr yt <term>.\n"
            "‚Ä¢ VK Video ‚Äî use .sr vk <term>.\n\n"
            "Open settings with .panel to set a provider or define a custom URL (supports {q} in patterns)."
        ),
        "ru": (
            "SearchIt –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–∫–∞—Ç—å —á–µ—Ç—ã—Ä—å–º—è —Å–ø–æ—Å–æ–±–∞–º–∏:\n\n"
            "- –ú–µ–Ω—é —á–∞—Ç–∞: –≤–∫–ª—é—á–∏—Ç–µ ‚Äò–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤ –º–µ–Ω—é —á–∞—Ç–∞‚Äô –∏ –Ω–∞–∂–º–∏—Ç–µ Plugins ‚Üí –ü–æ–∏—Å–∫, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–æ–∏—Å–∫–∞.\n"
            "- –ú–µ–Ω—é —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è: –≤—ã–¥–µ–ª–∏—Ç–µ —Ç–µ–∫—Å—Ç –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –ü–æ–∏—Å–∫, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã.\n"
            "- –ö–æ–º–∞–Ω–¥–∞: –≤–≤–µ–¥–∏—Ç–µ .sr <—Ç–µ–∫—Å—Ç> –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ .sr –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –æ–∫–Ω–∞ –ø–æ–∏—Å–∫–∞. –ï—Å–ª–∏ –∑–∞–¥–∞–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—ë –≤–º–µ—Å—Ç–æ .sr.\n"
            "- –í—ã–±–æ—Ä –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞: –≤—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∏—Å–∫–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –Ω–∞–ø—Ä—è–º—É—é –≤ —á–∞—Ç–µ —Å –ø–æ–º–æ—â—å—é .select <–ø—Ä–æ–≤–∞–π–¥–µ—Ä> (Google, Bing –∏ –¥—Ä.) –∏–ª–∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å —Ç–∞–º.\n\n"
            "–¢–∞–∫–∂–µ —Ç–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –∏—Å–∫–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ –≤–∏–¥–µ–æ–ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö:\n"
            "‚Ä¢ YouTube ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ .sr yt <–∑–∞–ø—Ä–æ—Å>.\n"
            "‚Ä¢ VK Video ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ .sr vk <–∑–∞–ø—Ä–æ—Å>.\n\n"
            "–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ .panel, —á—Ç–æ–±—ã –≤—ã–±—Ä–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏–ª–∏ —É–∫–∞–∑–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π URL (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç {q})."
        ),
        "pt": (
            "O SearchIt permite pesquisar de quatro formas:\n\n"
            "- Menu do chat: ative ‚ÄòMostrar no menu do chat‚Äô e toque em Plugins ‚Üí Pesquisar para abrir a caixa de pesquisa.\n"
            "- Menu de formata√ß√£o: selecione o texto no editor e escolha Pesquisar para ver os resultados.\n"
            "- Comando: digite .sr <termo> para abrir resultados diretamente ou apenas .sr para abrir a caixa de pesquisa. Se voc√™ definir um Comando Personalizado nas configura√ß√µes, use-o no lugar de .sr.\n"
            "- Escolha do provedor: selecione um provedor de pesquisa diretamente no chat com .select <provedor> (Google, Bing, etc.) ou abra as configura√ß√µes para escolher l√°.\n\n"
            "Agora tamb√©m √© poss√≠vel fazer pesquisas diretas em plataformas de v√≠deo compat√≠veis:\n"
            "‚Ä¢ YouTube ‚Äî use .sr yt <termo>.\n"
            "‚Ä¢ VK Video ‚Äî use .sr vk <termo>.\n\n"
            "Abra as configura√ß√µes com .panel para definir um provedor ou uma URL personalizada (suporta {q} nos padr√µes)."
        ),
        "es": (
            "SearchIt permite buscar de cuatro maneras:\n\n"
            "- Men√∫ del chat: active ‚ÄòMostrar en el men√∫ del chat‚Äô y toque Plugins ‚Üí Buscar para abrir el cuadro de b√∫squeda.\n"
            "- Men√∫ de formato: seleccione texto en el editor y elija Buscar para ver los resultados.\n"
            "- Comando: escriba .sr <t√©rmino> para abrir resultados directamente, o solo .sr para abrir el cuadro de b√∫squeda. Si configura un Comando Personalizado, √∫selo en lugar de .sr.\n"
            "- Selecci√≥n del proveedor: elija un proveedor de b√∫squeda directamente en el chat con .select <proveedor> (Google, Bing, etc.) o abra los ajustes para seleccionarlo all√≠.\n\n"
            "Tambi√©n puede buscar directamente en plataformas de video compatibles:\n"
            "‚Ä¢ YouTube ‚Äî use .sr yt <t√©rmino>.\n"
            "‚Ä¢ VK Video ‚Äî use .sr vk <t√©rmino>.\n\n"
            "Abra los ajustes con .panel para elegir un proveedor o definir una URL personalizada (admite {q})."
        ),
        "fr": (
            "SearchIt permet de rechercher de quatre fa√ßons :\n\n"
            "- Menu du chat : activez ‚ÄòAfficher dans le menu du chat‚Äô et touchez Plugins ‚Üí Recherche pour ouvrir la bo√Æte de recherche.\n"
            "- Menu de formatage : s√©lectionnez du texte dans l‚Äô√©diteur et choisissez Recherche pour afficher les r√©sultats.\n"
            "- Commande : tapez .sr <terme> pour ouvrir directement les r√©sultats, ou juste .sr pour ouvrir la bo√Æte de recherche. Si vous d√©finissez une commande personnalis√©e, utilisez-la √† la place de .sr.\n"
            "- Choix du moteur : s√©lectionnez un moteur de recherche directement dans le chat avec .select <moteur> (Google, Bing, etc.) ou ouvrez les param√®tres pour le choisir l√†.\n\n"
            "Il est d√©sormais possible de rechercher directement sur les plateformes vid√©o prises en charge :\n"
            "‚Ä¢ YouTube ‚Äî utilisez .sr yt <terme>.\n"
            "‚Ä¢ VK Video ‚Äî utilisez .sr vk <terme>.\n\n"
            "Ouvrez les param√®tres avec .panel pour choisir un moteur ou d√©finir une URL personnalis√©e (prend en charge {q})."
        ),
        "it": (
            "SearchIt consente di cercare in quattro modi:\n\n"
            "- Menu chat: abilita ‚ÄòMostra nel menu della chat‚Äô e tocca Plugins ‚Üí Cerca per aprire la casella di ricerca.\n"
            "- Menu di formattazione: seleziona il testo nell‚Äôeditor e scegli Cerca per visualizzare i risultati.\n"
            "- Comando: digita .sr <termine> per aprire direttamente i risultati, oppure solo .sr per aprire la casella di ricerca. Se imposti un Comando personalizzato, usalo al posto di .sr.\n"
            "- Scelta del provider: seleziona un provider di ricerca direttamente nella chat con .select <provider> (Google, Bing, ecc.) oppure apri le impostazioni per sceglierlo l√¨.\n\n"
            "Ora √® anche possibile cercare direttamente sulle piattaforme video supportate:\n"
            "‚Ä¢ YouTube ‚Äî usa .sr yt <termine>.\n"
            "‚Ä¢ VK Video ‚Äî usa .sr vk <termine>.\n\n"
            "Apri le impostazioni con .panel per scegliere un provider o impostare un URL personalizzato (supporta {q})."
        )
    },

    "understood": {"en": "Understood", "ru": "–ü–æ–Ω—è—Ç–Ω–æ", "pt": "Entendi", "es": "Entendido", "fr": "Compris", "it": "Capito"}
})

# Tradu√ß√µes para sele√ß√£o de provedor (.select)
TRANSLATIONS.update({
    "select_provider_title": {
        "en": "Select Provider",
        "ru": "–í—ã–±—Ä–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞",
        "pt": "Selecionar Provedor",
        "es": "Seleccionar proveedor",
        "fr": "S√©lectionner le fournisseur",
        "it": "Seleziona provider"
    },
    "provider_selected": {
        "en": "Provider selected: {name}",
        "ru": "–ü—Ä–æ–≤–∞–π–¥–µ—Ä –≤—ã–±—Ä–∞–Ω: {name}",
        "pt": "Provedor selecionado: {name}",
        "es": "Proveedor seleccionado: {name}",
        "fr": "Fournisseur s√©lectionn√©¬†: {name}",
        "it": "Provider selezionato: {name}"
    }
})

class SearchItPlugin(BasePlugin):
    def __init__(self):
        super().__init__()
        self.hook_fill_action_mode_menu_ref = None
        self.hook_perform_menu_action_ref = None
        self.hook_message_text_touch_ref = None
        # ID de item de menu est√°vel e determin√≠stico
        try:
            self.menu_item_id = int(hashlib.md5(f"{__id__}:menu_search".encode()).hexdigest()[:8], 16)
        except Exception:
            self.menu_item_id = 10010
        # Estado da janela flutuante
        self._overlay_root = None
        self._overlay_header = None
        self._overlay_content = None
        self._overlay_webview = None
        self._overlay_visible = False
        self._overlay_collapsed = False
        self._overlay_wm = None
        # √öltima URL navegada para suporte ao comando .open
        self._last_url = None

    # Ajudantes de localiza√ß√£o
    def _get_lang(self):
        try:
            Locale = find_class("java.util.Locale")
            lang = None
            try:
                lang = Locale.getDefault().getLanguage() if Locale else None
            except Exception:
                lang = None
            # Normaliza e mapea
            try:
                l = (lang or "en").lower()
                if l.startswith("pt"):
                    return "pt"
                if l.startswith("es"):
                    return "es"
                if l.startswith("fr"):
                    return "fr"
                if l.startswith("it"):
                    return "it"
                if l.startswith("ru"):
                    return "ru"
                # default English
                return "en"
            except Exception:
                return "en"
        except Exception:
            return "en"

    def _t(self, key: str) -> str:
        try:
            lang = self._get_lang()
            d = TRANSLATIONS.get(key, {})
            return d.get(lang, d.get("en", key))
        except Exception:
            return key

    def create_settings(self):
        settings = []
        # (Unificado)
        # Se√ß√£o de provedor
        settings.append(Divider(text=self._t("provider_section")))
        provider_items = [
            "Google", "Bing", "DuckDuckGo", "Yahoo", "Yandex", "Brave", "Ecosia", "Startpage", "Qwant", "Custom"
        ]
        default_provider_index = self.get_setting("search_provider", 0)
        if isinstance(default_provider_index, str):
            try:
                default_provider_index = provider_items.index(default_provider_index)
            except Exception:
                default_provider_index = 0
        settings.append(Selector(
            key="search_provider",
            text=self._t("search_provider"),
            items=provider_items,
            default=default_provider_index,
            icon="msg_openin"
        ))

        # URL personalizada - 'Custom'
        try:
            current_provider_index = self.get_setting("search_provider", 0)
            if isinstance(current_provider_index, str):
                try:
                    current_provider_index = provider_items.index(current_provider_index)
                except Exception:
                    current_provider_index = 0
        except Exception:
            current_provider_index = 0
        if current_provider_index == len(provider_items) - 1:
            settings.append(Input(
                key="custom_search_url",
                text=self._t("custom_provider_url"),
                icon="msg_link2_remix",
                default=self.get_setting("custom_search_url", "")
            ))

        # Verificar se navegador nativo est√° ativo para ocultar op√ß√µes de display
        try:
            use_native_browser = bool(self.get_setting("use_native_browser", False))
        except Exception:
            use_native_browser = False
        
        # Exibi√ß√£o: Tela Cheia e Janela Flutuante (ocultar se navegador nativo ativo)
        if not use_native_browser:
            settings.append(Divider(text=self._t("screen_options")))
            settings.append(Switch(
                key="fullscreen_mode",
                text=self._t("fullscreen_title"),
                subtext=self._t("fullscreen_subtext"),
                icon="pip_enlarge",
                default=self.get_setting("fullscreen_mode", False)
            ))
            settings.append(Switch(
                key="floating_window_mode",
                text=self._t("floating_window_title"),
                subtext=self._t("floating_window_subtext"),
                icon="menu_video_pip",
                default=self.get_setting("floating_window_mode", False)
            ))
        # Mostrar "Show Icon Names" apenas quando a Janela Flutuante estiver ativada E o navegador nativo estiver desativado
        try:
            is_floating = bool(self.get_setting("floating_window_mode", False))
        except Exception:
            is_floating = False
        if is_floating and not use_native_browser:
            try:
                mode_items = [
                    self._t("overlay_buttons_mode_icons_only"),
                    self._t("overlay_buttons_mode_icon_names"),
                    self._t("overlay_buttons_mode_names_only")
                ]
                try:
                    overlay_mode = int(self.get_setting("overlay_buttons_mode", 0) or 0)
                except Exception:
                    overlay_mode = 0
                settings.append(Selector(
                    key="overlay_buttons_mode",
                    text=self._t("overlay_buttons_mode_title"),
                    items=mode_items,
                    default=overlay_mode,
                    icon="profile_list"
                ))
            except Exception:
                pass

        # Se√ß√£o: Navega√ß√£o e Hist√≥rico
        settings.append(Divider(text=self._t("navigation_section")))
        # Hist√≥rico de navega√ß√£o: quando desativado, limpar cache/hist√≥rico a cada pesquisa
        settings.append(Switch(
            key="history_enabled",
            text=self._t("history_title"),
            subtext=self._t("history_subtext"),
            icon="msg_recent",
            default=self.get_setting("history_enabled", False)
        ))
        # Dica do recurso Keep Open (.open)
        settings.append(Text(
            text=self._t("keep_open_info"),
            icon="msg_language_solar",
            accent=True
        ))

        # Se√ß√£o: Op√ß√µes Avan√ßadas (colapso)
        settings.append(Divider(text=self._t("extras_section")))
        
        # Switch para mostrar/ocultar op√ß√µes avan√ßadas
        settings.append(Switch(
            key="show_advanced_options",
            text=self._t("advanced_options_title"),
            subtext=self._t("advanced_options_subtext"),
            icon="msg_settings_old",
            default=self.get_setting("show_advanced_options", False)
        ))
        
        # Verificar se deve mostrar op√ß√µes avan√ßadas
        try:
            show_advanced = bool(self.get_setting("show_advanced_options", False))
        except Exception:
            show_advanced = False
        
        if show_advanced:
            # Se√ß√£o: Interface Integration
            settings.append(Divider(text="Interface Integration"))
            
            # Enable in formatting menu
            settings.append(Switch(
                key="enable_search_composer",
                text=self._t("enable_switch_title"),
                subtext=self._t("enable_switch_subtext"),
                icon="menu_browser_search",
                default=self.get_setting("enable_search_composer", True),
                on_change=lambda v: self._toggle_formatting_menu(v)
            ))
            
            # Show in chat menu
            settings.append(Switch(
                key="show_chat_menu",
                text=self._t("show_chat_menu_title"),
                subtext=self._t("show_chat_menu_subtext"),
                icon="preview_dots",
                default=self.get_setting("show_chat_menu", True),
                on_change=lambda v: self._toggle_chat_menu_item(v)
            ))
            
            # Context Menu (MESSAGE_CONTEXT_MENU)
            settings.append(Switch(
                key="enable_context_menu",
                text="Context Menu",
                subtext="L√™ a mensagem, interpreta o texto e abre a pesquisa",
                icon="menu_browser_search",
                default=self.get_setting("enable_context_menu", False),
                on_change=lambda v: self._toggle_context_menu_item(v)
            ))
            
            # CTC: Chat Menu
            settings.append(Switch(
                key="show_circle_chat_menu",
                text=self._t("ctc_chat_title"),
                subtext=self._t("ctc_chat_sub"),
                icon="msg_viewchats",
                default=self.get_setting("show_circle_chat_menu", True),
                on_change=lambda v: self._toggle_circle_chat_menu_item(v)
            ))
            
            # CTC: Context Menu
            settings.append(Switch(
                key="enable_circle_context_menu",
                text=self._t("ctc_ctx_title"),
                subtext=self._t("ctc_ctx_sub"),
                icon="msg_download_settings",
                default=self.get_setting("enable_circle_context_menu", False),
                on_change=lambda v: self._toggle_circle_context_menu_item(v)
            ))
            
            # Se√ß√£o: Browser Settings
            settings.append(Divider(text="Browser Settings"))
            
            # Native Browser
            settings.append(Switch(
                key="use_native_browser",
                text=self._t("native_browser_title"),
                subtext=self._t("native_browser_subtext"),
                icon="msg_language_solar",
                default=self.get_setting("use_native_browser", False)
            ))
            
            # Se√ß√£o: Command Configuration
            settings.append(Divider(text="Command Configuration"))
            
            # Command Trigger (Default/Custom)
            try:
                command_items = [self._t("command_option_default"), self._t("command_option_custom")]
                command_mode = self.get_setting("command_mode", 0)
                if isinstance(command_mode, str):
                    try:
                        command_mode = command_items.index(command_mode)
                    except Exception:
                        command_mode = 0
                settings.append(Selector(
                    key="command_mode",
                    text=self._t("command_selector_title"),
                    icon="input_bot2",
                    items=command_items,
                    default=command_mode
                ))
                if int(command_mode) == 1:
                    settings.append(Input(
                        key="custom_command",
                        text=self._t("custom_command_label"),
                        icon="input_bot1",
                        default=self.get_setting("custom_command", ".sr")
                    ))
            except Exception:
                pass

        # Divider para separar Extras de How to Use / Dotted Plugins
        settings.append(Divider())
        # How to Use entry
        try:
            settings.append(Text(
                text=self._t("howto_title"),
                icon="msg_info_remix",
                on_click=lambda view: run_on_ui_thread(self._show_how_to_use_sheet)
            ))
        except Exception:
            pass
        try:
            settings.append(Text(
                text=self._t("dotted_credit"),
                icon="etg_settings",
                accent=True,
                on_click=lambda view: run_on_ui_thread(lambda: get_messages_controller().openByUserName("exteraDevPlugins", get_last_fragment(), 1))
            ))
        except Exception:
            pass
        return settings

    def _ensure_cache_dir(self):
        """Garante que o diret√≥rio de cache existe"""
        try:
            if not os.path.exists(CACHE_DIR):
                os.makedirs(CACHE_DIR)
            return True
        except Exception:
            return False

    def _save_last_url_to_file(self, url):
        """Salva a √∫ltima URL em arquivo local"""
        try:
            if self._ensure_cache_dir():
                with open(LAST_URL_FILE, 'w', encoding='utf-8') as f:
                    f.write(url)
                return True
        except Exception:
            pass
        return False

    def _load_last_url_from_file(self):
        """Carrega a √∫ltima URL do arquivo local"""
        try:
            if os.path.exists(LAST_URL_FILE):
                with open(LAST_URL_FILE, 'r', encoding='utf-8') as f:
                    url = f.read().strip()
                    return url if url else None
        except Exception:
            pass
        return None

    def _save_history_to_file(self, history):
        """Salva o hist√≥rico em arquivo local"""
        try:
            if self._ensure_cache_dir():
                with open(HISTORY_FILE, 'w', encoding='utf-8') as f:
                    json.dump(history, f, ensure_ascii=False, indent=2)
                # Debug tempor√°rio
                BulletinHelper.show_info(f"Hist√≥rico salvo: {len(history)} itens")
                return True
        except Exception as e:
            # Debug tempor√°rio
            BulletinHelper.show_error(f"Erro ao salvar hist√≥rico: {str(e)}")
        return False

    def _load_history_from_file(self):
        """Carrega o hist√≥rico do arquivo local"""
        try:
            if os.path.exists(HISTORY_FILE):
                with open(HISTORY_FILE, 'r', encoding='utf-8') as f:
                    history = json.load(f)
                    result = history if isinstance(history, list) else []
                    # Debug tempor√°rio
                    BulletinHelper.show_info(f"Hist√≥rico carregado do arquivo: {len(result)} itens")
                    return result
            else:
                # Debug tempor√°rio
                BulletinHelper.show_info(f"Arquivo de hist√≥rico n√£o existe: {HISTORY_FILE}")
        except Exception as e:
            # Debug tempor√°rio
            BulletinHelper.show_error(f"Erro ao carregar hist√≥rico: {str(e)}")
        return []

    def _save_last_url(self, url):
        """Salva a √∫ltima URL na mem√≥ria, configura√ß√µes e arquivo local"""
        try:
            if url and url.strip():
                self._last_url = url
                self.set_setting("searchit_last_url", url)
                self._save_last_url_to_file(url)
        except Exception:
            pass

    def _show_search_history(self):
        """Mostra o hist√≥rico de pesquisas recentes"""
        try:
            # Debug tempor√°rio
            BulletinHelper.show_info("Carregando hist√≥rico...")
            
            # Obter hist√≥rico de pesquisas do arquivo local primeiro, depois das configura√ß√µes
            history_data = self._load_history_from_file()
            BulletinHelper.show_info(f"Hist√≥rico do arquivo: {len(history_data) if history_data else 0} itens")
            
            if not history_data or len(history_data) == 0:
                history_data = self.get_setting("search_history", [])
                BulletinHelper.show_info(f"Hist√≥rico das config: {len(history_data) if history_data else 0} itens")
            
            if not history_data or len(history_data) == 0:
                # Mostrar mensagem de que n√£o h√° hist√≥rico
                try:
                    BulletinHelper.show_info(self._t("no_recent_searches"))
                except Exception:
                    pass
                return
            
            # Criar BottomSheet para mostrar o hist√≥rico
            fragment = get_last_fragment()
            if not fragment:
                return
                
            activity = fragment.getParentActivity()
            if not activity:
                return
                
            # Criar BottomSheet (aprimorar nas futuraas vers√µes)
            sheet = BottomSheet(activity, False)
            sheet.setTitle(self._t("recent_searches_title"))
            
            # Container principal
            container = LinearLayout(activity)
            container.setOrientation(LinearLayout.VERTICAL)
            container.setPadding(
                AndroidUtilities.dp(16), AndroidUtilities.dp(8),
                AndroidUtilities.dp(16), AndroidUtilities.dp(16)
            )
            
            # Adicionar cada item do hist√≥rico
            for i, search_item in enumerate(reversed(history_data[-10:])):  # √öltimas 10 pesquisas
                if not search_item or not isinstance(search_item, dict):
                    continue
                    
                query = search_item.get("query", "")
                provider = search_item.get("provider", "Google")
                
                if not query:
                    continue
                
                # Container do item
                item_container = LinearLayout(activity)
                item_container.setOrientation(LinearLayout.HORIZONTAL)
                item_container.setPadding(0, AndroidUtilities.dp(8), 0, AndroidUtilities.dp(8))
                
                # TextView para o texto da pesquisa
                text_view = SimpleTextView(activity)
                text_view.setText(f"{query} ({provider})")
                text_view.setTextSize(16)
                text_view.setTextColor(Theme.getColor("windowBackgroundWhiteBlackText"))
                text_view.setGravity(Gravity.CENTER_VERTICAL)
                
                # Bot√£o de pesquisar novamente
                search_btn = SimpleTextView(activity)
                search_btn.setText("üîç")
                search_btn.setTextSize(18)
                search_btn.setGravity(Gravity.CENTER)
                search_btn.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(8), AndroidUtilities.dp(12), AndroidUtilities.dp(8))
                
                # Bot√£o de copiar
                copy_btn = SimpleTextView(activity)
                copy_btn.setText("üìã")
                copy_btn.setTextSize(18)
                copy_btn.setGravity(Gravity.CENTER)
                copy_btn.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(8), AndroidUtilities.dp(12), AndroidUtilities.dp(8))
                
                # Adicionar click listeners
                def make_search_click(q, p):
                    def on_click(v):
                        try:
                            sheet.dismiss()
                            # Executar pesquisa
                            self._perform_search(q, p)
                        except Exception:
                            pass
                    return on_click
                
                def make_copy_click(q):
                    def on_click(v):
                        try:
                            self._copy_to_clipboard(q)
                            sheet.dismiss()
                        except Exception:
                            pass
                    return on_click
                
                search_btn.setOnClickListener(OnClickListener(make_search_click(query, provider)))
                copy_btn.setOnClickListener(OnClickListener(make_copy_click(query)))
                
                # Adicionar views ao container do item
                item_container.addView(text_view, LayoutHelper.createLinear(-1, -2, 1.0))
                item_container.addView(search_btn, LayoutHelper.createLinear(-2, -2))
                item_container.addView(copy_btn, LayoutHelper.createLinear(-2, -2))
                
                container.addView(item_container, LayoutHelper.createLinear(-1, -2))
                
                # Adicionar divisor (exceto no √∫ltimo item)
                if i < min(len(history_data), 10) - 1:
                    divider = FrameLayout(activity)
                    divider.setBackgroundColor(Theme.getColor("divider"))
                    container.addView(divider, LayoutHelper.createLinear(-1, 1))
            
            sheet.setCustomView(container)
            sheet.show()
            
        except Exception:
            # Fallback: mostrar mensagem simples
            try:
                BulletinHelper.show_info(self._t("no_recent_searches"))
            except Exception:
                pass

    def _perform_search(self, query, provider_name=None):
        """Executa uma pesquisa com a query e provider especificados"""
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            
            # Determinar provider override baseado no nome
            provider_override = None
            if provider_name:
                provider_lower = provider_name.lower()
                if "youtube" in provider_lower:
                    provider_override = "youtube"
                elif "vk" in provider_lower:
                    provider_override = "vkvideo"
                elif "tiktok" in provider_lower:
                    provider_override = "tiktok"
                elif "twitter" in provider_lower:
                    provider_override = "twitter"
            
            # Experimental
            # Adicionar ao hist√≥rico (n√£o duplicar se j√° foi adicionado pelo _show_search_dialog)
            # Este m√©todo √© usado principalmente pelo hist√≥rico, ent√£o n√£o adiciona novamente
            
            # Verificar se deve usar navegador nativo
            try:
                use_native_browser = self.get_setting("use_native_browser", False)
                if use_native_browser and ApplicationLoader and Browser:
                    # Construir URL de pesquisa
                    if provider_override == "youtube":
                        url = f"https://www.youtube.com/results?search_query={urllib.parse.quote_plus(query)}"
                    elif provider_override == "vkvideo":
                        url = f"https://m.vk.com/video?q={urllib.parse.quote_plus(query)}"
                    elif provider_override == "tiktok":
                        url = f"https://www.tiktok.com/search?q={urllib.parse.quote_plus(query)}"
                    elif provider_override == "twitter":
                        url = f"https://twitter.com/search?q={urllib.parse.quote_plus(query)}"
                    else:
                        url = self._build_search_url(query)
                    
                    # Abrir no navegador nativo
                    app_context = ApplicationLoader.applicationContext
                    if app_context:
                        run_on_ui_thread(lambda: Browser.openUrl(app_context, url))
                        return
            except Exception:
                pass
            
            # Se n√£o usar navegador nativo, usar o m√©todo normal
            self._show_search_dialog(activity, query, provider_override)
            
        except Exception:
            pass

    def _copy_to_clipboard(self, text):
        """Copia texto para a √°rea de transfer√™ncia"""
        try:
            ClipboardManager = find_class("android.content.ClipboardManager")
            ClipData = find_class("android.content.ClipData")
            Context = find_class("android.content.Context")
            
            fragment = get_last_fragment()
            if fragment:
                activity = fragment.getParentActivity()
                if activity:
                    clipboard = activity.getSystemService(Context.CLIPBOARD_SERVICE)
                    if clipboard and ClipData:
                        clip = ClipData.newPlainText("SearchIt", text)
                        clipboard.setPrimaryClip(clip)
                        try:
                            BulletinHelper.show_info(f"{self._t('copy_button')}: {text}")
                        except Exception:
                            pass
        except Exception:
            pass

    def _add_to_search_history(self, query, provider_name):
        """Adiciona uma pesquisa ao hist√≥rico"""
        try:
            if not query or not query.strip():
                return
            
            # Debug tempor√°rio
            BulletinHelper.show_info(f"Salvando no hist√≥rico: {query} ({provider_name})")
                
            # Obter hist√≥rico atual do arquivo local primeiro
            history = self._load_history_from_file()
            if not history:
                history = self.get_setting("search_history", [])
            if not isinstance(history, list):
                history = []
            
            # Criar item do hist√≥rico
            search_item = {
                "query": query.strip(),
                "provider": provider_name or "Google",
                "timestamp": int(time.time()) if 'time' in globals() else 0
            }
            
            # Remover duplicatas (mesma query e provider)
            history = [item for item in history if not (
                isinstance(item, dict) and 
                item.get("query") == search_item["query"] and 
                item.get("provider") == search_item["provider"]
            )]
            
            # Adicionar novo item no final
            history.append(search_item)
            
            # Manter apenas os √∫ltimos 50 itens
            if len(history) > 50:
                history = history[-50:]
            
            # Salvar hist√≥rico no arquivo local e nas configura√ß√µes
            self._save_history_to_file(history)
            self.set_setting("search_history", history)
            
        except Exception:
            pass

    def on_plugin_load(self):
        # Habilita tratamento de comandos (.sr / .panel)
        try:
            self.add_on_send_message_hook()
        except Exception:
            pass
        try:
            if self.get_setting("enable_search_composer", True):
                self._hook_formatting_menu()
        except Exception:
            pass
        # Sempre habilita busca ao tocar na palavra no texto da mensagem
        try:
            self._hook_message_text_touch()
        except Exception:
            pass
        # Adiciona item ao menu do chat se habilitado
        try:
            if self.get_setting("show_chat_menu", True):
                self._add_chat_menu_item()
        except Exception:
            pass
        # Adiciona item ao menu de contexto se habilitado
        try:
            if self.get_setting("enable_context_menu", False):
                self._add_context_menu_item()
        except Exception:
            pass
        # Adiciona item ‚ÄòCircle to Search‚Äô ao menu do chat se habilitado
        try:
            if self.get_setting("show_circle_chat_menu", True):
                self._add_circle_chat_menu_item()
        except Exception:
            pass
        # Adiciona item ‚ÄòCircle to Search‚Äô ao menu de contexto se habilitado
        try:
            if self.get_setting("enable_circle_context_menu", False):
                self._add_circle_context_menu_item()
        except Exception:
            pass

    def on_send_message_hook(self, account, params) -> HookResult:
        try:
            if not hasattr(params, 'message') or not isinstance(params.message, str):
                return HookResult()

            msg = params.message.strip()
            if len(msg) == 0:
                return HookResult()

            lower = msg.lower()
            # Comando para selecionar provedor (.select)
            if lower.startswith(".select"):
                try:
                    run_on_ui_thread(self._show_provider_select_sheet)
                except Exception:
                    self._show_provider_select_sheet()
                return HookResult(strategy=HookStrategy.CANCEL, params=params)
            # Open settings panel
            if lower.startswith(".panel"):
                self._open_plugin_settings()
                return HookResult(strategy=HookStrategy.CANCEL, params=params)

            # Comando .circle: aciona Circle to Search
            if lower.startswith(".circle"):
                fragment = get_last_fragment()
                activity = fragment.getParentActivity() if fragment else None
                try:
                    run_on_ui_thread(lambda: self._trigger_circle_to_search(activity))
                except Exception:
                    self._trigger_circle_to_search(activity)
                return HookResult(strategy=HookStrategy.CANCEL, params=params)

            # Comando .open: reabrir a √∫ltima p√°gina exibida
            if lower.startswith(".open"):
                # Priorizar URL do arquivo local, depois configura√ß√µes, depois mem√≥ria
                last = self._load_last_url_from_file()
                if not last:
                    try:
                        last = str(self.get_setting("searchit_last_url", "") or "")
                    except Exception:
                        last = None
                if not last:
                    try:
                        last = getattr(self, "_last_url", None)
                    except Exception:
                        last = None
                if not last:
                    try:
                        BulletinHelper.show_info(self._t("open_no_last_url"))
                    except Exception:
                        pass
                    return HookResult(strategy=HookStrategy.CANCEL, params=params)
                
                # Verificar se deve usar navegador nativo
                try:
                    use_native_browser = self.get_setting("use_native_browser", False)
                    if use_native_browser and ApplicationLoader and Browser:
                        # Abrir no navegador nativo
                        try:
                            app_context = ApplicationLoader.applicationContext
                            if app_context:
                                run_on_ui_thread(lambda: Browser.openUrl(app_context, last))
                                return HookResult(strategy=HookStrategy.CANCEL, params=params)
                        except Exception:
                            pass
                except Exception:
                    pass
                
                fragment = get_last_fragment()
                activity = fragment.getParentActivity() if fragment else None
                
                # Verificar modo de exibi√ß√£o
                try:
                    is_float = bool(self.get_setting("floating_window_mode", False))
                except Exception:
                    is_float = False
                
                try:
                    is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
                except Exception:
                    is_fullscreen = False
                
                # Escolher m√©todo de exibi√ß√£o baseado nas configura√ß√µes
                try:
                    if is_float:
                        run_on_ui_thread(lambda: self._show_search_overlay(activity, last))
                    else:
                        # Usar _show_search_dialog que j√° lida com fullscreen e outros modos
                        run_on_ui_thread(lambda: self._show_url_dialog(activity, last))
                except Exception:
                    try:
                        if is_float:
                            self._show_search_overlay(activity, last)
                        else:
                            self._show_url_dialog(activity, last)
                    except Exception:
                        pass
                return HookResult(strategy=HookStrategy.CANCEL, params=params)

            # Handle history command (.his)
            if lower.startswith(".his"):
                try:
                    # Debug tempor√°rio
                    BulletinHelper.show_info("Comando .his detectado!")
                    run_on_ui_thread(lambda: self._show_search_history())
                except Exception as e:
                    try:
                        BulletinHelper.show_error(f"Erro .his: {str(e)}")
                        self._show_search_history()
                    except Exception:
                        pass
                return HookResult(strategy=HookStrategy.CANCEL, params=params)

            # Handle command (.sr, alias .de, or custom)
            try:
                command_mode = int(self.get_setting("command_mode", 0) or 0)
            except Exception:
                command_mode = 0
            default_cmd = ".sr"
            alias_cmd = ".de"
            custom_cmd = str(self.get_setting("custom_command", default_cmd) or default_cmd).strip()
            base_cmds = [default_cmd, alias_cmd]
            commands = base_cmds if command_mode == 0 else (base_cmds + ([custom_cmd] if custom_cmd else []))

            for cmd in commands:
                if lower.startswith(cmd.lower()):
                    try:
                        query = msg[len(cmd):].strip()
                    except Exception:
                        query = ""
                    if not query:
                        # Sem termo: abrir o painel de input igual ao menu de chat
                        try:
                            run_on_ui_thread(lambda: self._open_chat_search_panel())
                        except Exception:
                            self._open_chat_search_panel()
                        return HookResult(strategy=HookStrategy.CANCEL, params=params)

                    # Subcomandos diretos: YouTube (yr/yt) e VK V√≠deo (vk)
                    provider_override = None
                    term = query
                    try:
                        ql = query.lower()
                        # Formatos aceitos: "yr + termo", "yt + termo", "vk + termo", "tk + termo" ou sem '+'
                        if ql.startswith("yr ") or ql.startswith("yr+") or ql.startswith("yt ") or ql.startswith("yt+"):
                            provider_override = "youtube"
                            if "+" in query:
                                try:
                                    term = query.split("+", 1)[1].strip()
                                except Exception:
                                    term = query[2:].strip()
                            else:
                                term = query[2:].strip()
                        elif ql.startswith("vk ") or ql.startswith("vk+"):
                            provider_override = "vkvideo"
                            if "+" in query:
                                try:
                                    term = query.split("+", 1)[1].strip()
                                except Exception:
                                    term = query[2:].strip()
                            else:
                                term = query[2:].strip()
                        elif ql.startswith("tk ") or ql.startswith("tk+"):
                            provider_override = "tiktok"
                            if "+" in query:
                                try:
                                    term = query.split("+", 1)[1].strip()
                                except Exception:
                                    term = query[2:].strip()
                            else:
                                term = query[2:].strip()
                    except Exception:
                        provider_override = None
                        term = query

                    fragment = get_last_fragment()
                    activity = fragment.getParentActivity() if fragment else None
                    try:
                        run_on_ui_thread(lambda: self._show_search_dialog(activity, term, provider_override))
                    except Exception:
                        self._show_search_dialog(activity, term, provider_override)
                    return HookResult(strategy=HookStrategy.CANCEL, params=params)

            return HookResult()
        except Exception:
            return HookResult()

    def _show_provider_select_sheet(self):
        # Mostra BottomSheet para selecionar provedor de busca
        try:
            fragment = get_last_fragment()
            ctx = fragment.getParentActivity() if fragment and fragment.getParentActivity() else None
            if not ctx:
                return

            sheet = BottomSheet(ctx, True)

            container = LinearLayout(ctx)
            container.setOrientation(LinearLayout.VERTICAL)

            # T√≠tulo
            title_view = TextView(ctx)
            title_view.setText(self._t("select_provider_title"))
            try:
                title_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
            except Exception:
                pass
            title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18)
            title_view.setGravity(Gravity.START)
            container.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 16, 24, 8))

            providers = [
                "Google", "Bing", "DuckDuckGo", "Yahoo", "Yandex", "Brave", "Ecosia", "Startpage", "Qwant", "Custom"
            ]

            # Lista de itens clic√°veis
            for i, name in enumerate(providers):
                item = SimpleTextView(ctx)
                item.setText(name)
                item.setTextSize(16)
                try:
                    item.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                except Exception:
                    pass
                item.setGravity(Gravity.START | Gravity.CENTER_VERTICAL)

                def make_click(index, prov_name):
                    def _on_click(v):
                        try:
                            self.set_setting("search_provider", index)
                            try:
                                BulletinHelper.show_success(self._t("provider_selected").format(name=prov_name))
                            except Exception:
                                pass
                            try:
                                sheet.dismiss()
                            except Exception:
                                pass
                        except Exception:
                            pass
                    return OnClickListener(_on_click)

                item.setOnClickListener(make_click(i, name))
                container.addView(item, LayoutHelper.createLinear(-1, 48, Gravity.TOP, 24, 4, 24, 4))

            sheet.setCustomView(container)
            run_on_ui_thread(sheet.show)
        except Exception:
            pass

    def _open_plugin_settings(self):
        try:
            def present():
                try:
                    plugin = PluginsController.getInstance().plugins.get(self.id)
                    fragment = get_last_fragment()
                    if fragment is not None:
                        fragment.presentFragment(PluginSettingsActivity(plugin))
                        return
                except Exception as e:
                    try:
                        BulletinHelper.show_error(f"{self._t('panel_open_error')}: {e}")
                    except Exception:
                        pass

            run_on_ui_thread(present)
        except Exception:
            try:
                BulletinHelper.show_error(self._t("panel_open_error"))
            except Exception:
                pass

    def on_plugin_unload(self):
        try:
            if self.hook_fill_action_mode_menu_ref:
                self.unhook_method(self.hook_fill_action_mode_menu_ref)
                self.hook_fill_action_mode_menu_ref = None
            if self.hook_perform_menu_action_ref:
                self.unhook_method(self.hook_perform_menu_action_ref)
                self.hook_perform_menu_action_ref = None
            if self.hook_message_text_touch_ref:
                self.unhook_method(self.hook_message_text_touch_ref)
                self.hook_message_text_touch_ref = None
        except Exception:
            pass

    def _hook_formatting_menu(self):
        try:
            ChatActivity = find_class("org.telegram.ui.ChatActivity")
            EditTextCaption = find_class("org.telegram.ui.Components.EditTextCaption")
            if ChatActivity is None or EditTextCaption is None:
                return

            boolean_type = find_class("java.lang.Boolean").TYPE
            fillActionModeMenu_method = ChatActivity.getClass().getDeclaredMethod(
                "fillActionModeMenu",
                find_class("android.view.Menu"),
                jclass("org.telegram.tgnet.TLRPC$EncryptedChat"),
                boolean_type,
            )
            fillActionModeMenu_method.setAccessible(True)

            performMenuAction_method = EditTextCaption.getClass().getDeclaredMethod(
                "performMenuAction",
                find_class("java.lang.Integer").TYPE,
            )
            performMenuAction_method.setAccessible(True)

            self.hook_fill_action_mode_menu_ref = self.hook_method(
                fillActionModeMenu_method, SearchItActionModeMenuHook(self)
            )
            self.hook_perform_menu_action_ref = self.hook_method(
                performMenuAction_method, SearchItPerformMenuActionHook(self)
            )
        except Exception:
            pass

    def _toggle_formatting_menu(self, enabled: bool):
        # Alterna a integra√ß√£o no menu de formata√ß√£o
        try:
            if enabled:
                self._hook_formatting_menu()
            else:
                try:
                    if self.hook_fill_action_mode_menu_ref:
                        self.unhook_method(self.hook_fill_action_mode_menu_ref)
                        self.hook_fill_action_mode_menu_ref = None
                except Exception:
                    pass
                try:
                    if self.hook_perform_menu_action_ref:
                        self.unhook_method(self.hook_perform_menu_action_ref)
                        self.hook_perform_menu_action_ref = None
                except Exception:
                    pass
        except Exception:
            pass

    def _build_search_url(self, query: str) -> str:
        # Subcomandos diretos: YouTube (yr) e VK V√≠deo (vk)
        try:
            qraw = str(query or "")
            lower = qraw.lower().strip()
            if lower.startswith("yr ") or lower.startswith("youtube "):
                term = qraw.split(None, 1)[1] if len(qraw.split(None, 1)) > 1 else ""
                term = term.lstrip("+").strip()
                qq = urllib.parse.quote_plus(term)
                if term:
                    return f"https://www.youtube.com/results?search_query={qq}"
            if lower.startswith("vk ") or lower.startswith("vkvideo ") or lower.startswith("vk v√≠deo "):
                term = qraw.split(None, 1)[1] if len(qraw.split(None, 1)) > 1 else ""
                term = term.lstrip("+").strip()
                qq = urllib.parse.quote_plus(term)
                if term:
                    return f"https://vk.com/video?q={qq}"
        except Exception:
            pass
        providers = [
            "Google",
            "Bing",
            "DuckDuckGo",
            "Yahoo",
            "Yandex",
            "Brave",
            "Ecosia",
            "Startpage",
            "Qwant",
            "Custom",
        ]
        provider = self.get_setting("search_provider", 0)
        try:
            if isinstance(provider, int):
                provider_name = providers[provider] if 0 <= provider < len(providers) else "Google"
            else:
                provider_name = provider if provider in providers else "Google"
        except Exception:
            provider_name = "Google"

        q = urllib.parse.quote_plus(query)
        if provider_name == "Google":
            return f"https://www.google.com/search?q={q}"
        if provider_name == "Bing":
            return f"https://www.bing.com/search?q={q}"
        if provider_name == "DuckDuckGo":
            return f"https://duckduckgo.com/?q={q}"
        if provider_name == "Yahoo":
            return f"https://search.yahoo.com/search?p={q}"
        if provider_name == "Yandex":
            return f"https://yandex.com/search/?text={q}"
        if provider_name == "Brave":
            return f"https://search.brave.com/search?q={q}"
        if provider_name == "Ecosia":
            return f"https://www.ecosia.org/search?q={q}"
        if provider_name == "Startpage":
            return f"https://www.startpage.com/do/search?q={q}"
        if provider_name == "Qwant":
            return f"https://www.qwant.com/?q={q}"

        # Custom
        pattern = self.get_setting("custom_search_url", "")
        try:
            if pattern and "{q}" in pattern:
                return pattern.replace("{q}", q)
            if pattern:
                sep = "&" if "?" in pattern else "?"
                return f"{pattern}{sep}q={q}"
        except Exception:
            pass
        return f"https://www.google.com/search?q={q}"

    def _resolve_drawable_id(self, name: str) -> int:
        try:
            ApplicationLoader = find_class("org.telegram.messenger.ApplicationLoader")
            ctx = ApplicationLoader.applicationContext if ApplicationLoader else None
            if ctx is None:
                return 0
            res = ctx.getResources()
            pkg = ctx.getPackageName()
            return res.getIdentifier(name, "drawable", pkg)
        except Exception:
            return 0

    def _show_search_dialog(self, activity, query: str, provider_override: str = None):
        if activity is None or query is None or not str(query).strip():
            return

        # Adicionar ao hist√≥rico de pesquisas
        try:
            provider_name = "Google"  # Default
            if provider_override == "youtube":
                provider_name = "YouTube"
            elif provider_override == "vkvideo":
                provider_name = "VK Video"
            elif provider_override == "tiktok":
                provider_name = "TikTok"
            elif provider_override == "twitter":
                provider_name = "Twitter"
            else:
                # Obter nome do provider das configura√ß√µes
                try:
                    provider_items = ["Google", "Bing", "DuckDuckGo", "Yahoo", "Yandex", "Brave", "Ecosia", "Startpage", "Qwant", "Custom"]
                    provider_index = self.get_setting("search_provider", 0)
                    if isinstance(provider_index, int) and 0 <= provider_index < len(provider_items):
                        provider_name = provider_items[provider_index]
                except Exception:
                    pass
            
            self._add_to_search_history(query, provider_name)
        except Exception:
            pass

        # Verificar se deve usar navegador nativo
        try:
            use_native_browser = self.get_setting("use_native_browser", False)
            if use_native_browser and ApplicationLoader and Browser:
                # Construir URL de pesquisa
                url = None
                try:
                    if provider_override == "youtube":
                        url = f"https://www.youtube.com/results?search_query={urllib.parse.quote_plus(query)}"
                    elif provider_override == "vkvideo":
                        url = f"https://vk.com/video?q={urllib.parse.quote_plus(query)}"
                    else:
                        url = self._build_search_url(query)
                except Exception:
                    url = self._build_search_url(query)
                
                # Abrir no navegador nativo
                try:
                    app_context = ApplicationLoader.applicationContext
                    if app_context:
                        run_on_ui_thread(lambda: Browser.openUrl(app_context, url))
                        return  # Sair da fun√ß√£o ap√≥s abrir no navegador nativo
                except Exception as e:
                    # Se falhar, continuar com WebView normal
                    pass
        except Exception:
            pass

        try:
            builder = AlertDialogBuilder(activity)
            builder.set_title(self._t("search_title"))

            # Se janela flutuante estiver habilitada, usar overlay em vez de di√°logo
            try:
                if self.get_setting("floating_window_mode", False):
                    # Respeitar override direto para YouTube/VK quando habilitado
                    url = None
                    try:
                        if provider_override == "youtube":
                            url = f"https://www.youtube.com/results?search_query={urllib.parse.quote_plus(query)}"
                        elif provider_override == "vkvideo":
                            url = f"https://vk.com/video?q={urllib.parse.quote_plus(query)}"
                    except Exception:
                        url = None
                    if not url:
                        url = self._build_search_url(query)
                    self._show_search_overlay(activity, url)
                    return
            except Exception:
                pass

            container = LinearLayout(activity)
            container.setOrientation(LinearLayout.VERTICAL)
            pad = AndroidUtilities.dp(12)
            container.setPadding(pad, pad, pad, pad)
            # Em fullscreen sem janela flutuante, remover padding para ocupar 100% da tela
            try:
                is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
            except Exception:
                is_fullscreen = False
            try:
                is_floating = bool(self.get_setting("floating_window_mode", False))
            except Exception:
                is_floating = False
            try:
                if is_fullscreen and not is_floating:
                    container.setPadding(0, 0, 0, 0)
            except Exception:
                pass
            # Garantir que o cont√™iner permita foco para entrada de texto
            try:
                container.setFocusable(True)
                container.setFocusableInTouchMode(True)
            except Exception:
                pass

            # Fake input oculto para acionar IME de forma confi√°vel
            try:
                fake_input = EditText(activity)
                fake_input.setHint("...")
                # Permitir que o EditText receba foco mesmo oculto
                try:
                    fake_input.setFocusable(True)
                    fake_input.setFocusableInTouchMode(True)
                except Exception:
                    pass
                # Padr√£o do Surfee (alpha version): manter GONE e apenas pedir foco ap√≥s show()
                fake_input.setVisibility(8)  # GONE
                container.addView(fake_input)
            except Exception:
                fake_input = None

            webview = WebView(activity)
            try:
                webview.getSettings().setJavaScriptEnabled(True)
            except Exception:
                pass
            # Pol√≠tica de hist√≥rico/cache conforme configura√ß√£o
            try:
                history_enabled = bool(self.get_setting("history_enabled", True))
            except Exception:
                history_enabled = True
            # WebViewClient com callback para abrir o teclado ap√≥s carregar a p√°gina
            try:
                plugin_self = self  # capturar inst√¢ncia do plugin para persistir URL
                he = history_enabled
                class SearchItWebViewClient(dynamic_proxy(WebViewClient)):
                    def __init__(self, wv):
                        self._wv = wv
                    def onPageFinished(self, view, url):
                        try:
                            # Persistir √∫ltima URL visitada para .open
                            try:
                                plugin_self._save_last_url(url)
                            except Exception:
                                pass
                            # Se hist√≥rico estiver desativado, limpar hist√≥rico ap√≥s carregar
                            try:
                                if not he:
                                    view.clearHistory()
                            except Exception:
                                pass
                            view.requestFocus()
                            # Atraso maior para garantir que a p√°gina terminou de preparar inputs
                            run_on_ui_thread(lambda: AndroidUtilities.showKeyboard(view), delay=200)
                            # For√ßar foco no primeiro campo de entrada via JS
                            try:
                                view.evaluateJavascript("document.querySelector('input, textarea, [contenteditable]')?.focus();", None)
                            except Exception:
                                pass
                        except Exception:
                            pass
                webview.setWebViewClient(SearchItWebViewClient(webview))
            except Exception:
                try:
                    webview.setWebViewClient(WebViewClient())
                except Exception:
                    pass
            webview.setFocusable(True)
            webview.setFocusableInTouchMode(True)
            # Solicitar foco ao WebView para permitir teclado
            try:
                webview.requestFocus()
                webview.requestFocusFromTouch()
            except Exception:
                pass
            try:
                def _on_click(v):
                    try:
                        v.requestFocus()
                    except Exception:
                        pass
                    try:
                        AndroidUtilities.showKeyboard(v)
                    except Exception:
                        pass
                webview.setOnClickListener(OnClickListener(_on_click))
            except Exception:
                pass
            # Mostrar teclado quando o WebView ganha foco
            try:
                OnFocusChangeListenerCls = find_class("android.view.View$OnFocusChangeListener")
                class SearchItFocusListener(dynamic_proxy(OnFocusChangeListenerCls)):
                    def onFocusChange(self, v, hasFocus):
                        try:
                            if hasFocus:
                                v.requestFocus()
                                AndroidUtilities.showKeyboard(v)
                        except Exception:
                            pass
                webview.setOnFocusChangeListener(SearchItFocusListener())
            except Exception:
                pass
            # Habilitar DOM Storage para compatibilidade com inputs modernos
            try:
                webview.getSettings().setDomStorageEnabled(True)
            except Exception:
                pass
            # Aplicar modo de cache conforme hist√≥rico
            try:
                webview.getSettings().setCacheMode(0 if history_enabled else 2)  # 0: DEFAULT, 2: NO_CACHE
            except Exception:
                pass
            # Se hist√≥rico desativado, limpar cache/hist√≥rico antes de carregar
            try:
                if not history_enabled:
                    webview.clearCache(True)
                    webview.clearHistory()
            except Exception:
                pass
            # For√ßar foco e teclado ao tocar dentro do WebView (inclui campos de input)
            try:
                # Listener correto para toque, garantindo foco e teclado
                OnTouchListenerCls = find_class("android.view.View$OnTouchListener")
                MotionEvent = find_class("android.view.MotionEvent")
                ACTION_UP = MotionEvent.ACTION_UP if MotionEvent is not None else 1
                class SearchItTouchListener(dynamic_proxy(OnTouchListenerCls)):
                    def onTouch(self, v, event):
                        try:
                            v.requestFocus()
                        except Exception:
                            pass
                        try:
                            AndroidUtilities.showKeyboard(v)
                        except Exception:
                            pass
                        # Focar o primeiro input via JS ap√≥s o toque
                        try:
                            if event is not None and event.getAction() == ACTION_UP:
                                v.evaluateJavascript("document.querySelector('input, textarea, [contenteditable]')?.focus();", None)
                        except Exception:
                            pass
                        return False
                webview.setOnTouchListener(SearchItTouchListener())
            except Exception:
                try:
                    # Fallback simples
                    def _on_touch(v, event):
                        try:
                            v.requestFocus()
                        except Exception:
                            pass
                        try:
                            AndroidUtilities.showKeyboard(v)
                        except Exception:
                            pass
                        return False
                    webview.setOnTouchListener(OnTouchListener(_on_touch))
                except Exception:
                    pass

            # Construir URL respeitando override direto (YouTube/VK) quando aplic√°vel
            url = None
            try:
                if provider_override == "youtube":
                    url = f"https://www.youtube.com/results?search_query={urllib.parse.quote_plus(query)}"
                elif provider_override == "vkvideo":
                    url = f"https://vk.com/video?q={urllib.parse.quote_plus(query)}"
            except Exception:
                url = None
            if not url:
                url = self._build_search_url(query)
            webview.loadUrl(url)

            # Ajustar altura conforme Tela Cheia
            try:
                is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
            except Exception:
                is_fullscreen = False
            container.addView(webview, LinearLayout.LayoutParams(-1, (-1 if is_fullscreen else AndroidUtilities.dp(600))))

            builder.set_view(container)
            # Adotar exatamente o padr√£o Surfee: show() e configurar IME depois
            dialog = builder.show()
            try:
                w = dialog.getWindow() if dialog else None
                if w is not None:
                    WindowManagerLayoutParams = find_class("android.view.WindowManager$LayoutParams")
                    if WindowManagerLayoutParams is not None:
                        try:
                            w.clearFlags(WindowManagerLayoutParams.FLAG_ALT_FOCUSABLE_IM)
                        except Exception:
                            pass
                        w.setSoftInputMode(
                            WindowManagerLayoutParams.SOFT_INPUT_ADJUST_RESIZE |
                            WindowManagerLayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE
                        )
                        # Tela cheia: ajustar tamanho da janela para ocupar a tela
                        try:
                            if is_fullscreen:
                                w.setLayout(-1, -1)
                        except Exception:
                            pass
                        # Em fullscreen sem janela flutuante, garantir flags para ocupar toda a tela
                        try:
                            if is_fullscreen and not bool(self.get_setting("floating_window_mode", False)):
                                try:
                                    w.addFlags(
                                        WindowManagerLayoutParams.FLAG_LAYOUT_IN_SCREEN |
                                        WindowManagerLayoutParams.FLAG_LAYOUT_NO_LIMITS |
                                        WindowManagerLayoutParams.FLAG_FULLSCREEN
                                    )
                                except Exception:
                                    pass
                                # Ocultar barras do sistema para experi√™ncia truly fullscreen
                                try:
                                    ViewCls = find_class("android.view.View")
                                    decor = w.getDecorView()
                                    if ViewCls and decor:
                                        decor.setSystemUiVisibility(
                                            ViewCls.SYSTEM_UI_FLAG_LAYOUT_STABLE |
                                            ViewCls.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION |
                                            ViewCls.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN |
                                            ViewCls.SYSTEM_UI_FLAG_HIDE_NAVIGATION |
                                            ViewCls.SYSTEM_UI_FLAG_FULLSCREEN |
                                            ViewCls.SYSTEM_UI_FLAG_IMMERSIVE_STICKY
                                        )
                                except Exception:
                                    pass
                        except Exception:
                            pass
            except Exception:
                pass
            # Focar o fake_input para garantir abertura do teclado
            try:
                if fake_input:
                    fake_input.post(lambda: fake_input.requestFocus())
            except Exception:
                pass
            # (Sem chamadas extras ao teclado aqui; seguimos o comportamento simples do Surfee)
            except Exception:
                pass
            return dialog
        except Exception:
            pass

    # Abrir um di√°logo com uma URL direta (usado por .open)
    def _show_url_dialog(self, activity, url: str):
        if activity is None or url is None or not str(url).strip():
            return
        try:
            builder = AlertDialogBuilder(activity)
            builder.set_title(self._t("search_title"))

            container = LinearLayout(activity)
            container.setOrientation(LinearLayout.VERTICAL)
            pad = AndroidUtilities.dp(12)
            container.setPadding(pad, pad, pad, pad)
            # Em fullscreen sem janela flutuante, remover padding para ocupar 100% da tela
            try:
                is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
            except Exception:
                is_fullscreen = False
            try:
                is_floating = bool(self.get_setting("floating_window_mode", False))
            except Exception:
                is_floating = False
            try:
                if is_fullscreen and not is_floating:
                    container.setPadding(0, 0, 0, 0)
            except Exception:
                pass

            wv = WebView(activity)
            try:
                wv.getSettings().setJavaScriptEnabled(True)
                wv.getSettings().setDomStorageEnabled(True)
            except Exception:
                pass
            # Pol√≠tica de hist√≥rico/cache
            try:
                history_enabled = bool(self.get_setting("history_enabled", True))
            except Exception:
                history_enabled = True
            try:
                wv.getSettings().setCacheMode(0 if history_enabled else 2)
            except Exception:
                pass
            try:
                if not history_enabled:
                    wv.clearCache(True)
                    wv.clearHistory()
            except Exception:
                pass

            # Client para persistir √∫ltima URL
            try:
                plugin_self = self
                he = history_enabled
                class _DirectWebClient(dynamic_proxy(WebViewClient)):
                    def onPageFinished(self, view, u):
                        try:
                            plugin_self._save_last_url(u)
                        except Exception:
                            pass
                            if not he:
                                try:
                                    view.clearHistory()
                                except Exception:
                                    pass
                        except Exception:
                            pass
                wv.setWebViewClient(_DirectWebClient())
            except Exception:
                try:
                    wv.setWebViewClient(WebViewClient())
                except Exception:
                    pass

            try:
                wv.loadUrl(url)
            except Exception:
                pass

            # Persistir imediatamente a URL carregada para garantir independ√™ncia de modo
            try:
                self._last_url = url
                try:
                    self.set_setting("searchit_last_url", url)
                except Exception:
                    pass
            except Exception:
                pass

            try:
                container.addView(wv, LinearLayout.LayoutParams(-1, (-1 if is_fullscreen else AndroidUtilities.dp(600))))
            except Exception:
                pass
            
            # Persistir imediatamente a URL carregada para garantir independ√™ncia de modo
            try:
                self._save_last_url(url)
            except Exception:
                pass
            
            dialog = None
            return dialog
        except Exception:
            pass

    def _show_search_overlay(self, activity, url: str):
        try:
            ApplicationLoader = find_class("org.telegram.messenger.ApplicationLoader")
            ctx = ApplicationLoader.applicationContext if ApplicationLoader else None
            if ctx is None:
                return
            # Se j√° existe overlay vis√≠vel, encerre antes de criar outro
            try:
                if self._overlay_visible and self._overlay_root is not None:
                    self._hide_search_overlay()
            except Exception:
                pass
            WindowManager = find_class("android.view.WindowManager")
            LayoutParams = find_class("android.view.WindowManager$LayoutParams")
            Gravity = find_class("android.view.Gravity")
            ThemeCls = find_class("org.telegram.ui.ActionBar.Theme")
            TextView = find_class("android.widget.TextView")
            GradientDrawable = find_class("android.graphics.drawable.GradientDrawable")
            ColorCls = find_class("android.graphics.Color")
            if WindowManager is None or LayoutParams is None:
                return

            # Usar WindowManager da Activity quando poss√≠vel (melhora IME em overlays)
            wm = (activity.getSystemService("window") if activity else ctx.getSystemService("window"))
            if wm is None:
                return
            try:
                self._overlay_wm = wm
            except Exception:
                pass

            # Root
            root = LinearLayout(ctx)
            root.setOrientation(LinearLayout.VERTICAL)
            pad = AndroidUtilities.dp(10)
            root.setPadding(pad, pad, pad, pad)
            # Evitar disputa de foco: o overlay n√£o deve pegar foco
            try:
                root.setFocusable(False)
                root.setFocusableInTouchMode(False)
            except Exception:
                pass
            # Fundo com estilo de cart√£o para organizar visualmente
            try:
                bg = GradientDrawable()
                bg.setShape(GradientDrawable.RECTANGLE)
                card_color = ThemeCls.getColor(ThemeCls.key_windowBackgroundWhite) if ThemeCls else 0xFFFFFFFF
                stroke_color = ThemeCls.getColor(ThemeCls.key_divider) if ThemeCls else 0x33000000
                bg.setColor(card_color)
                bg.setCornerRadius(float(AndroidUtilities.dp(12)))
                bg.setStroke(int(AndroidUtilities.dp(1)), stroke_color)
                root.setBackground(bg)
                # Guardar fundo e padding originais para restaurar ao expandir
                try:
                    self._overlay_bg = bg
                    self._overlay_pad = pad
                except Exception:
                    pass
            except Exception:
                pass

            # Header com a√ß√µes
            header = LinearLayout(ctx)
            header.setOrientation(LinearLayout.HORIZONTAL)
            try:
                header.setPadding(pad, pad, pad, pad)
            except Exception:
                pass
            # Centralizar por padr√£o (horizontal e vertical)
            try:
                header.setGravity(Gravity.CENTER)
            except Exception:
                pass

            # Helper para criar bot√£o conforme modo de exibi√ß√£o escolhido
            def make_icon_btn(icon_name, on_click, fallback_text=None, label_text=None):
                try:
                    mode = int(self.get_setting("overlay_buttons_mode", 0) or 0)
                except Exception:
                    mode = 0
                label = label_text if label_text is not None else (fallback_text if fallback_text is not None else "?")

                container = LinearLayout(ctx)
                try:
                    container.setOrientation(LinearLayout.HORIZONTAL)
                    container.setGravity(Gravity.CENTER_VERTICAL)
                except Exception:
                    pass

                iv = ImageView(ctx)
                rid = 0
                try:
                    rid = self._resolve_drawable_id(icon_name) if icon_name else 0
                except Exception:
                    rid = 0
                try:
                    if rid:
                        iv.setImageResource(rid)
                        iv.setScaleType(ImageView.ScaleType.CENTER_INSIDE)
                        iv.setAdjustViewBounds(True)
                        accent = ThemeCls.getColor(ThemeCls.key_dialogButtonBlue) if ThemeCls else 0xFF3D8BF7
                        iv.setColorFilter(accent)
                        p = AndroidUtilities.dp(8)
                        iv.setPadding(p, p, p, p)
                except Exception:
                    pass

                tv = TextView(ctx)
                try:
                    tv.setText(label)
                    tv.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
                    accent = ThemeCls.getColor(ThemeCls.key_dialogButtonBlue) if ThemeCls else 0xFF3D8BF7
                    tv.setTextColor(accent)
                    tv.setSingleLine(True)
                    tv.setMaxLines(1)
                    # Evitar corte de descendentes (ex.: "d") e quebra de linha
                    tv.setIncludeFontPadding(True)
                    try:
                        TextUtils = find_class("android.text.TextUtils")
                        if TextUtils is not None:
                            tv.setEllipsize(TextUtils.TruncateAt.END)
                    except Exception:
                        pass
                    tv.setPadding(AndroidUtilities.dp(6), AndroidUtilities.dp(8), AndroidUtilities.dp(6), AndroidUtilities.dp(8))
                except Exception:
                    pass

                # Visibilidade conforme modo: 0=√≠cones, 1=√≠cone+noms, 2=nomes
                try:
                    if mode == 0:
                        if rid:
                            tv.setVisibility(8)
                        else:
                            tv.setVisibility(0)
                            iv.setVisibility(8)
                    elif mode == 1:
                        iv.setVisibility(0 if rid else 8)
                        tv.setVisibility(0)
                    else:
                        tv.setVisibility(0)
                        iv.setVisibility(8)
                except Exception:
                    pass

                try:
                    container.addView(iv, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 0, 0))
                    # Espa√ßo pequeno entre √≠cone e nome (6dp)
                    container.addView(tv, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, AndroidUtilities.dp(6), 0, 0, 0))
                except Exception:
                    pass
                try:
                    container.setOnClickListener(OnClickListener(on_click))
                except Exception:
                    pass
                return container

            # Bot√£o Minimizar com √≠cone
            btn_min = make_icon_btn("zoom_minus", lambda v: None, fallback_text=self._t("overlay_minimize"), label_text=self._t("overlay_minimize"))

            # Estiliza√ß√£o tipo "chip" dos bot√µes
            def _style_btn(tv):
                try:
                    tv.setIncludeFontPadding(False)
                    tv.setPadding(AndroidUtilities.dp(12), AndroidUtilities.dp(6), AndroidUtilities.dp(12), AndroidUtilities.dp(6))
                    tv.setMinimumHeight(AndroidUtilities.dp(32))
                    tv.setSingleLine(True)
                    tv.setMaxLines(1)
                except Exception:
                    pass
                try:
                    btn_bg = GradientDrawable()
                    btn_bg.setShape(GradientDrawable.RECTANGLE)
                    accent = ThemeCls.getColor(ThemeCls.key_dialogButtonBlue) if ThemeCls else 0xFF3D8BF7
                    # Estilo de borda (outline): sem preenchimento, apenas stroke
                    try:
                        btn_bg.setColor(0x00FFFFFF)
                    except Exception:
                        pass
                    try:
                        btn_bg.setStroke(int(AndroidUtilities.dp(1)), accent)
                    except Exception:
                        pass
                    btn_bg.setCornerRadius(float(AndroidUtilities.dp(16)))
                    tv.setBackground(btn_bg)
                    # Texto na cor de destaque para combinar com a borda
                    try:
                        tv.setTextColor(accent)
                    except Exception:
                        pass
                except Exception:
                    pass

            try:
                _style_btn(btn_min)
            except Exception:
                pass

            # Bot√µes de navega√ß√£o com √≠cones
            btn_back = make_icon_btn("msg_arrow_back", lambda v: None, fallback_text=self._t("overlay_back"), label_text=self._t("overlay_back"))
            btn_forward = make_icon_btn("msg_arrow_forward", lambda v: None, fallback_text=self._t("overlay_forward"), label_text=self._t("overlay_forward"))

            # Bolha circular com fundo vis√≠vel: container + √≠cone
            bubble_container = FrameLayout(ctx)
            try:
                # Fundo circular no container para garantir a forma
                bubble_bg = GradientDrawable()
                try:
                    bubble_bg.setShape(GradientDrawable.OVAL)
                except Exception:
                    bubble_bg.setShape(GradientDrawable.RECTANGLE)
                    bubble_bg.setCornerRadius(float(AndroidUtilities.dp(28)))
                try:
                    accent = ThemeCls.getColor(ThemeCls.key_dialogButtonBlue) if ThemeCls else 0xFF3D8BF7
                    # Cor fixa do orbe: branco
                    bubble_bg.setColor(0xFFFFFFFF)
                    try:
                        bubble_bg.setStroke(int(AndroidUtilities.dp(2)), accent)
                    except Exception:
                        pass
                except Exception:
                    pass
                bubble_container.setBackground(bubble_bg)
                # √çcone/Sticker dentro do container (usa o mesmo √≠cone do plugin)
                iv_bubble = ImageView(ctx)
                try:
                    icon_name = __icon__ if '__icon__' in globals() else None
                    res_id = self._resolve_drawable_id(icon_name) if icon_name else 0
                    if not res_id:
                        # Fallback para um √≠cone nativo caso __icon__ n√£o mapeie para drawable
                        res_id = self._resolve_drawable_id("msg_search_remix") or self._resolve_drawable_id("msg_info_remix")
                    if res_id:
                        iv_bubble.setImageResource(res_id)
                        try:
                            iv_bubble.setScaleType(ImageView.ScaleType.CENTER_INSIDE)
                            iv_bubble.setAdjustViewBounds(True)
                        except Exception:
                            pass
                except Exception:
                    pass
                bubble_container.addView(iv_bubble, LayoutHelper.createFrame(-1, -1, Gravity.CENTER))
                # Inicialmente oculto; ser√° mostrado somente quando minimizado
                bubble_container.setVisibility(8)
            except Exception:
                pass

            # Ordem: bolha, <, Minimize, Close, >
            header.addView(bubble_container, LayoutHelper.createLinear(AndroidUtilities.dp(12), AndroidUtilities.dp(12), Gravity.CENTER_VERTICAL, 0, 0, 12, 0))
            # Ordem: <, Minimize, Close, > (margens consistentes)
            header.addView(btn_back, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 12, 0))
            header.addView(btn_min, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 12, 0))

            # Bot√£o de fechar overlay com √≠cone
            btn_close = make_icon_btn("ic_layer_close", lambda v: None, fallback_text=self._t("overlay_close"), label_text=self._t("overlay_close"))
            header.addView(btn_close, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 12, 0))
            header.addView(btn_forward, LayoutHelper.createLinear(-2, -2, Gravity.CENTER_VERTICAL, 0, 0, 0, 0))
            root.addView(header, LayoutHelper.createLinear(-1, -2))

            content = LinearLayout(ctx)
            content.setOrientation(LinearLayout.VERTICAL)
            root.addView(content, LayoutHelper.createLinear(-1, -2))


            # A√ß√µes: abrir conte√∫do ao expandir
            def open_webview(_):
                try:
                    # Ocultar bolha e mostrar chips ao abrir resultados
                    try:
                        bubble_container.setVisibility(8)
                        btn_min.setVisibility(0)
                        btn_close.setVisibility(0)
                    except Exception:
                        pass
                    # Garantir que os bot√µes de navega√ß√£o estejam vis√≠veis ao abrir
                    try:
                        btn_back.setVisibility(0)
                        btn_forward.setVisibility(0)
                    except Exception:
                        pass
                    if self._overlay_webview is None:
                        # Criar WebView com contexto da Activity para melhor integra√ß√£o com IME
                        wv = WebView(activity if activity else ctx)
                        try:
                            wv.getSettings().setJavaScriptEnabled(True)
                            wv.getSettings().setDomStorageEnabled(True)
                            # Pol√≠tica de hist√≥rico/cache
                            try:
                                he = bool(self.get_setting("history_enabled", True))
                            except Exception:
                                he = True
                            try:
                                wv.getSettings().setCacheMode(0 if he else 2)
                            except Exception:
                                pass
                            try:
                                if not he:
                                    wv.clearCache(True)
                                    wv.clearHistory()
                            except Exception:
                                pass
                            # Manter navega√ß√£o dentro do WebView: definir WebViewClient
                            try:
                                plugin_self = self
                                class _OverlayClient(dynamic_proxy(WebViewClient)):
                                    def onPageFinished(self, view, u):
                                        try:
                                            plugin_self._save_last_url(u)
                                        except Exception:
                                            pass
                                            if not he:
                                                try:
                                                    view.clearHistory()
                                                except Exception:
                                                    pass
                                        except Exception:
                                            pass
                                wv.setWebViewClient(_OverlayClient())
                            except Exception:
                                try:
                                    wv.setWebViewClient(WebViewClient())
                                except Exception:
                                    pass
                        except Exception:
                            pass
                        wv.loadUrl(url)
                        try:
                            is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
                        except Exception:
                            is_fullscreen = False
                        content.addView(wv, LinearLayout.LayoutParams((-1 if is_fullscreen else AndroidUtilities.dp(360)), (-1 if is_fullscreen else AndroidUtilities.dp(500))))
                        self._overlay_webview = wv
                        self._overlay_collapsed = False
                        # Ao abrir resultados, garantir que o container de conte√∫do esteja vis√≠vel
                        try:
                            content.setVisibility(0)
                        except Exception:
                            pass
                        # Permitir foco/IME na WebView
                        try:
                            wv.setFocusable(True)
                            wv.setFocusableInTouchMode(True)
                            wv.requestFocus()
                            wv.requestFocusFromTouch()
                        except Exception:
                            pass
                        # Expandir a janela e torn√°-la foc√°vel para digitar
                        try:
                            lp2 = self._overlay_lp or lp
                            lp2.width = (-1 if is_fullscreen else -2)
                            lp2.height = (-1 if is_fullscreen else -2)
                            # Foc√°vel: n√£o usar ALT_FOCUSABLE_IM
                            lp2.flags = (
                                LayoutParams.FLAG_LAYOUT_IN_SCREEN |
                                LayoutParams.FLAG_NOT_TOUCH_MODAL
                            )
                            try:
                                lp2.softInputMode = (
                                    LayoutParams.SOFT_INPUT_ADJUST_RESIZE |
                                    LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE
                                )
                            except Exception:
                                pass
                            # Restaurar fundo e padding originais ao expandir
                            try:
                                if getattr(self, "_overlay_bg", None):
                                    root.setBackground(self._overlay_bg)
                                p = getattr(self, "_overlay_pad", AndroidUtilities.dp(10))
                                if is_fullscreen:
                                    root.setPadding(0, 0, 0, 0)
                                else:
                                    root.setPadding(p, p, p, p)
                            except Exception:
                                pass
                            wm.updateViewLayout(self._overlay_root, lp2)
                        except Exception:
                            pass
                    else:
                        try:
                            self._overlay_webview.setVisibility(0)
                            # Ao reabrir os resultados, voltar a mostrar o bot√£o Minimize
                            try:
                                btn_min.setVisibility(0)
                            except Exception:
                                pass
                            # Evitar refresh ao reabrir: n√£o chamar reload no WebView
                            self._overlay_collapsed = False
                            # Tornar o container de conte√∫do vis√≠vel novamente
                            try:
                                content.setVisibility(0)
                            except Exception:
                                pass
                            # Reajustar tamanho e permitir foco/IME ao abrir resultados
                            try:
                                is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
                            except Exception:
                                is_fullscreen = False
                            try:
                                lp2 = self._overlay_lp or lp
                                lp2.width = (-1 if is_fullscreen else -2)
                                lp2.height = (-1 if is_fullscreen else -2)
                                lp2.flags = (
                                    LayoutParams.FLAG_LAYOUT_IN_SCREEN |
                                    LayoutParams.FLAG_NOT_TOUCH_MODAL
                                )
                                try:
                                    lp2.softInputMode = (
                                        LayoutParams.SOFT_INPUT_ADJUST_RESIZE |
                                        LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE
                                    )
                                except Exception:
                                    pass
                                # Restaurar fundo e padding ao expandir; remover padding em fullscreen
                                try:
                                    if getattr(self, "_overlay_bg", None):
                                        root.setBackground(self._overlay_bg)
                                    p = getattr(self, "_overlay_pad", AndroidUtilities.dp(10))
                                    if is_fullscreen:
                                        root.setPadding(0, 0, 0, 0)
                                    else:
                                        root.setPadding(p, p, p, p)
                                except Exception:
                                    pass
                                wm.updateViewLayout(self._overlay_root, lp2)
                            except Exception:
                                pass
                        except Exception:
                            pass
                except Exception:
                    pass

            def toggle_minimize(_):
                try:
                    if self._overlay_webview is not None:
                        # Apenas ocultar; reabrir s√≥ com "Results"
                        self._overlay_webview.setVisibility(8)
                        self._overlay_collapsed = True
                        # Esconder o chip Minimize enquanto estiver minimizado
                        try:
                            btn_min.setVisibility(8)
                            btn_back.setVisibility(8)
                            btn_forward.setVisibility(8)
                            btn_close.setVisibility(8)
                            bubble_container.setVisibility(0)
                            try:
                                bubble_container.bringToFront()
                            except Exception:
                                pass
                        except Exception:
                            pass
                        # Ocultar toda a √°rea de conte√∫do para n√£o cobrir o app por tr√°s
                        try:
                            content.setVisibility(8)
                        except Exception:
                            pass
                        # Deixar root sem fundo e sem padding para destacar apenas a bolha
                        try:
                            root.setBackground(None)
                            root.setPadding(0, 0, 0, 0)
                        except Exception:
                            pass
                        # Reduzir a janela para envolver apenas o cabe√ßalho (menu flutuante)
                        try:
                            lp2 = self._overlay_lp or lp
                            lp2.width = -2
                            lp2.height = -2
                            # Posicionar pr√≥ximo ao topo √† direita, sem encostar
                            try:
                                lp2.gravity = Gravity.TOP | Gravity.LEFT
                                Point = find_class("android.graphics.Point")
                                disp = wm.getDefaultDisplay() if wm else None
                                pt = Point() if Point else None
                                if disp and pt:
                                    disp.getSize(pt)
                                    bubble = AndroidUtilities.dp(12)
                                    margin = AndroidUtilities.dp(16)
                                    extra_offset = AndroidUtilities.dp(4)
                                    extra_offset_y = AndroidUtilities.dp(48)
                                    lp2.x = max(0, int(pt.x - bubble - margin - extra_offset))
                                    lp2.y = max(0, AndroidUtilities.dp(100) + extra_offset_y)
                                # Ao minimizar, garantir que o overlay n√£o capture foco/teclado
                                try:
                                    lp2.flags = (
                                        LayoutParams.FLAG_NOT_FOCUSABLE |
                                        LayoutParams.FLAG_LAYOUT_IN_SCREEN |
                                        LayoutParams.FLAG_NOT_TOUCH_MODAL
                                    )
                                    lp2.softInputMode = (
                                        LayoutParams.SOFT_INPUT_ADJUST_NOTHING |
                                        LayoutParams.SOFT_INPUT_STATE_UNCHANGED
                                    )
                                except Exception:
                                    pass
                            except Exception:
                                pass
                            try:
                                wm.updateViewLayout(self._overlay_root, lp2)
                            except Exception:
                                pass
                        except Exception:
                            pass
                except Exception:
                    pass

            # Abrir resultados ao tocar na bolha
            try:
                bubble_container.setOnClickListener(OnClickListener(open_webview))
            except Exception:
                pass
            btn_min.setOnClickListener(OnClickListener(toggle_minimize))
            btn_close.setOnClickListener(OnClickListener(lambda v: self._hide_search_overlay()))
            # Navega√ß√£o WebView
            def _do_back(_):
                try:
                    wv = self._overlay_webview
                    if wv is not None and wv.canGoBack():
                        wv.goBack()
                except Exception:
                    pass

            def _do_forward(_):
                try:
                    wv = self._overlay_webview
                    if wv is not None and wv.canGoForward():
                        wv.goForward()
                except Exception:
                    pass

            try:
                btn_back.setOnClickListener(OnClickListener(_do_back))
                btn_forward.setOnClickListener(OnClickListener(_do_forward))
            except Exception:
                pass
            # N√£o abrir resultados automaticamente (evita foco prematuro)

            # Layout params
            lp = LayoutParams()
            try:
                # Respeitar op√ß√£o de tela cheia tamb√©m no overlay
                try:
                    is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
                except Exception:
                    is_fullscreen = False
                lp.width = (-1 if is_fullscreen else -2)
                lp.height = (-1 if is_fullscreen else -2)
                lp.gravity = Gravity.CENTER
                try:
                    # Posi√ß√£o inicial
                    lp.x = 0
                    lp.y = 0
                except Exception:
                    pass
                # Estado inicial: n√£o foc√°vel para n√£o bloquear o teclado do app por tr√°s
                lp.flags = (
                    LayoutParams.FLAG_NOT_FOCUSABLE |
                    LayoutParams.FLAG_LAYOUT_IN_SCREEN |
                    LayoutParams.FLAG_NOT_TOUCH_MODAL
                )
                try:
                    lp.softInputMode = (
                        LayoutParams.SOFT_INPUT_ADJUST_NOTHING |
                        LayoutParams.SOFT_INPUT_STATE_UNCHANGED
                    )
                except Exception:
                    pass
                lp.format = 1
                Build_VERSION = find_class("android.os.Build$VERSION")
                try:
                    # Preferir painel anexado ao token da Activity para IME funcionar
                    lp.type = LayoutParams.TYPE_APPLICATION_PANEL
                    lp.token = activity.getWindow().getDecorView().getWindowToken()
                except Exception:
                    if Build_VERSION and Build_VERSION.SDK_INT >= 26:
                        lp.type = LayoutParams.TYPE_APPLICATION_OVERLAY
                    else:
                        lp.type = LayoutParams.TYPE_PHONE
            except Exception:
                pass

            wm.addView(root, lp)
            self._overlay_root = root
            self._overlay_lp = lp
            self._overlay_header = header
            self._overlay_content = content
            self._overlay_visible = True

            # Pr√©-carregar a WebView em segundo plano para evitar lentid√£o no primeiro carregamento
            try:
                if self._overlay_webview is None:
                    wv = WebView(activity if activity else ctx)
                    try:
                        wv.getSettings().setJavaScriptEnabled(True)
                        wv.getSettings().setDomStorageEnabled(True)
                        try:
                            he = bool(self.get_setting("history_enabled", True))
                        except Exception:
                            he = True
                        try:
                            wv.getSettings().setCacheMode(0 if he else 2)
                        except Exception:
                            pass
                        try:
                            if not he:
                                wv.clearCache(True)
                                wv.clearHistory()
                        except Exception:
                            pass
                        try:
                            plugin_self = self
                            class _OverlayPreloadClient(dynamic_proxy(WebViewClient)):
                                def onPageFinished(self, view, u):
                                    try:
                                        plugin_self._save_last_url(u)
                                    except Exception:
                                        pass
                                        if not he:
                                            try:
                                                view.clearHistory()
                                            except Exception:
                                                pass
                                    except Exception:
                                        pass
                            wv.setWebViewClient(_OverlayPreloadClient())
                        except Exception:
                            try:
                                wv.setWebViewClient(WebViewClient())
                            except Exception:
                                pass
                    except Exception:
                        pass
                    try:
                        is_fullscreen = bool(self.get_setting("fullscreen_mode", False))
                    except Exception:
                        is_fullscreen = False
                    try:
                        content.addView(wv, LinearLayout.LayoutParams((-1 if is_fullscreen else AndroidUtilities.dp(360)), (-1 if is_fullscreen else AndroidUtilities.dp(500))))
                    except Exception:
                        pass
                    try:
                        wv.setVisibility(8)
                    except Exception:
                        pass
                    try:
                        wv.loadUrl(url)
                    except Exception:
                        pass
                    self._overlay_webview = wv
            except Exception:
                pass

            # Abrir resultados imediatamente ao anexar (n√£o iniciar minimizado)
            try:
                run_on_ui_thread(lambda: open_webview(None))
            except Exception:
                pass

            # Tornar o overlay arrast√°vel pelo cabe√ßalho
            try:
                MotionEvent = find_class("android.view.MotionEvent")
                ACTION_DOWN = MotionEvent.ACTION_DOWN if MotionEvent else 0
                ACTION_MOVE = MotionEvent.ACTION_MOVE if MotionEvent else 2

                def _on_header_touch(v, event):
                    try:
                        act = event.getAction()
                        if act == ACTION_DOWN:
                            self._initial_touch_x = int(event.getRawX())
                            self._initial_touch_y = int(event.getRawY())
                            return True
                        elif act == ACTION_MOVE:
                            dx = int(event.getRawX()) - getattr(self, "_initial_touch_x", int(event.getRawX()))
                            dy = int(event.getRawY()) - getattr(self, "_initial_touch_y", int(event.getRawY()))
                            self._initial_touch_x = int(event.getRawX())
                            self._initial_touch_y = int(event.getRawY())
                            lp2 = self._overlay_lp or lp
                            try:
                                lp2.x = int(lp2.x + dx)
                                lp2.y = int(lp2.y + dy)
                            except Exception:
                                pass
                            try:
                                wm.updateViewLayout(self._overlay_root, lp2)
                            except Exception:
                                pass
                            return True
                    except Exception:
                        pass
                    return False

                header.setOnTouchListener(OnTouchListener(_on_header_touch))
            except Exception:
                pass
        except Exception:
            pass

    def _hide_search_overlay(self):
        try:
            if self._overlay_root is not None and self._overlay_wm is not None:
                try:
                    self._overlay_wm.removeView(self._overlay_root)
                except Exception:
                    pass
            # Persistir √∫ltima URL ao fechar overlay
            try:
                if self._overlay_webview is not None:
                    u = None
                    try:
                        u = self._overlay_webview.getUrl()
                    except Exception:
                        u = None
                    if u:
                        self._save_last_url(u)
            except Exception:
                pass
            self._overlay_root = None
            self._overlay_header = None
            self._overlay_content = None
            self._overlay_webview = None
            self._overlay_visible = False
            self._overlay_collapsed = False
        except Exception:
            pass

    def _open_chat_search_panel(self):
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            if not activity:
                return

            builder = AlertDialogBuilder(activity)
            builder.set_title(self._t("search_title"))

            container = LinearLayout(activity)
            pad = AndroidUtilities.dp(12)
            container.setPadding(pad, pad, pad, pad)

            # Input field for query
            EditText = find_class("android.widget.EditText")
            if EditText is None:
                return
            query_input = EditText(activity)
            try:
                query_input.setHint(self._t("search_input_hint"))
            except Exception:
                pass
            # Ajustes de cor para modo escuro e claro (experimental, melhorias em progresso)
            try:
                Theme = find_class("org.telegram.ui.ActionBar.Theme")
                if Theme is not None:
                    # Cor do texto e do hint seguindo o tema atual
                    try:
                        query_input.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
                    except Exception:
                        pass
                    try:
                        query_input.setHintTextColor(Theme.getColor(Theme.key_dialogTextHint))
                    except Exception:
                        pass
            except Exception:
                pass

            # Par√¢metros de layout
            lp_match = LinearLayout.LayoutParams(-1, -2)
            container.addView(query_input, lp_match)

            builder.set_view(container)

            # Bot√£o positivo abre o di√°logo de pesquisa
            builder.set_positive_button(self._t("menu_item_search"), lambda d, w: (self._show_search_dialog(activity, query_input.getText().toString()), d.dismiss()))

            builder.show()
        except Exception:
            pass

    def _add_chat_menu_item(self):
        try:
            # Evita duplicatas removendo o ID anterior salvo
            if hasattr(self, "chat_menu_item_id") and self.chat_menu_item_id:
                try:
                    self.remove_menu_item(self.chat_menu_item_id)
                except Exception:
                    pass

            item_id = self.add_menu_item(MenuItemData(
                menu_type=MenuItemType.CHAT_ACTION_MENU,
                text=self._t("menu_item_search"),
                icon="msg_search_remix",
                priority=5,
                on_click=lambda ctx: run_on_ui_thread(lambda: self._open_chat_search_panel())
            ))
            try:
                self.chat_menu_item_id = item_id
            except Exception:
                pass
        except Exception:
            pass

    def _toggle_chat_menu_item(self, enabled: bool):
        try:
            if enabled:
                self._add_chat_menu_item()
            else:
                if hasattr(self, "chat_menu_item_id") and self.chat_menu_item_id:
                    try:
                        self.remove_menu_item(self.chat_menu_item_id)
                    except Exception:
                        pass
                    self.chat_menu_item_id = None
        except Exception:
            pass

    def _add_context_menu_item(self):
        try:
            # Evita duplicatas
            if hasattr(self, "context_menu_item_id") and self.context_menu_item_id:
                try:
                    self.remove_menu_item(self.context_menu_item_id)
                except Exception:
                    pass

            item_id = self.add_menu_item(MenuItemData(
                menu_type=MenuItemType.MESSAGE_CONTEXT_MENU,
                text=self._t("menu_item_search"),
                icon="menu_browser_search",
                on_click=lambda ctx: run_on_ui_thread(lambda: self._on_context_menu_click(ctx))
            ))
            try:
                self.context_menu_item_id = item_id
            except Exception:
                pass
        except Exception:
            pass

    def _toggle_context_menu_item(self, enabled: bool):
        try:
            if enabled:
                self._add_context_menu_item()
            else:
                if hasattr(self, "context_menu_item_id") and self.context_menu_item_id:
                    try:
                        self.remove_menu_item(self.context_menu_item_id)
                    except Exception:
                        pass
                    self.context_menu_item_id = None
        except Exception:
            pass

    # ----- Circle to Search integration -----
    def _add_circle_chat_menu_item(self):
        try:
            if hasattr(self, "circle_chat_menu_item_id") and self.circle_chat_menu_item_id:
                try:
                    self.remove_menu_item(self.circle_chat_menu_item_id)
                except Exception:
                    pass
            item_id = self.add_menu_item(MenuItemData(
                menu_type=MenuItemType.CHAT_ACTION_MENU,
                text=self._t("ctc_menu_item"),
                icon="msg_search_remix",
                priority=6,
                on_click=lambda ctx: run_on_ui_thread(lambda: self._circle_trigger_from_chat_menu(ctx))
            ))
            try:
                self.circle_chat_menu_item_id = item_id
            except Exception:
                pass
        except Exception:
            pass

    def _circle_trigger_from_chat_menu(self, ctx=None):
        try:
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            self._trigger_circle_to_search(activity)
        except Exception:
            pass

    def _toggle_circle_chat_menu_item(self, enabled: bool):
        try:
            if enabled:
                self._add_circle_chat_menu_item()
            else:
                if hasattr(self, "circle_chat_menu_item_id") and self.circle_chat_menu_item_id:
                    try:
                        self.remove_menu_item(self.circle_chat_menu_item_id)
                    except Exception:
                        pass
                    self.circle_chat_menu_item_id = None
        except Exception:
            pass

    def _add_circle_context_menu_item(self):
        try:
            if hasattr(self, "circle_context_menu_item_id") and self.circle_context_menu_item_id:
                try:
                    self.remove_menu_item(self.circle_context_menu_item_id)
                except Exception:
                    pass
            item_id = self.add_menu_item(MenuItemData(
                menu_type=MenuItemType.MESSAGE_CONTEXT_MENU,
                text=self._t("ctc_menu_item"),
                icon="menu_browser_search",
                on_click=lambda ctx: run_on_ui_thread(lambda: self._on_circle_context_menu_click(ctx))
            ))
            try:
                self.circle_context_menu_item_id = item_id
            except Exception:
                pass
        except Exception:
            pass

    def _toggle_circle_context_menu_item(self, enabled: bool):
        try:
            if enabled:
                self._add_circle_context_menu_item()
            else:
                if hasattr(self, "circle_context_menu_item_id") and self.circle_context_menu_item_id:
                    try:
                        self.remove_menu_item(self.circle_context_menu_item_id)
                    except Exception:
                        pass
                    self.circle_context_menu_item_id = None
        except Exception:
            pass

    def _on_circle_context_menu_click(self, ctx):
        try:
            activity = None
            try:
                fragment = ctx.get("fragment") if ctx else None
                activity = fragment.getParentActivity() if fragment else None
            except Exception:
                activity = None
            if activity is None:
                fragment = get_last_fragment()
                activity = fragment.getParentActivity() if fragment else None
            self._trigger_circle_to_search(activity)
        except Exception:
            pass

    def _trigger_circle_to_search(self, activity=None):
        try:
            ApplicationLoader = find_class("org.telegram.messenger.ApplicationLoader")
            Intent = find_class("android.content.Intent")
            Context = find_class("android.content.Context")
            PackageManager = find_class("android.content.pm.PackageManager")
            if activity is None:
                try:
                    fragment = get_last_fragment()
                    activity = fragment.getParentActivity() if fragment else None
                except Exception:
                    activity = None
            ctx = activity or (ApplicationLoader and ApplicationLoader.applicationContext)
            if ctx is None:
                return False

            # Ripple visual feedback (center of screen)
            try:
                def _make_ripple():
                    try:
                        view = None
                        try:
                            window = activity.getWindow() if activity else None
                            if window:
                                view = window.getDecorView()
                        except Exception:
                            view = None
                        try:
                            width = float(view.getWidth()) if view else float(getattr(AndroidUtilities, "displaySize").x)
                            height = float(view.getHeight()) if view else float(getattr(AndroidUtilities, "displaySize").y)
                        except Exception:
                            width = 540.0
                            height = 960.0
                        cx = width / 2.0
                        cy = height / 2.0
                        try:
                            LaunchActivity = find_class("org.telegram.ui.LaunchActivity")
                            LaunchActivity.makeRipple(float(cx), float(cy), float(3.0))
                        except Exception:
                            pass
                    except Exception:
                        pass
                try:
                    run_on_ui_thread(_make_ripple)
                except Exception:
                    _make_ripple()
            except Exception:
                pass

            pm = ctx.getPackageManager() if ctx else None

            # Prefer MiCTS if installed
            try:
                launch = pm.getLaunchIntentForPackage("com.parallelc.micts") if pm else None
            except Exception:
                launch = None
            if launch:
                try:
                    if Intent and hasattr(Intent, "FLAG_ACTIVITY_NEW_TASK"):
                        launch.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                except Exception:
                    pass
                try:
                    ctx.startActivity(launch)
                    return True
                except Exception:
                    pass

            # Fallback: open Google app
            google_launch = None
            try:
                google_launch = pm.getLaunchIntentForPackage("com.google.android.googlequicksearchbox") if pm else None
            except Exception:
                google_launch = None
            if google_launch:
                try:
                    if Intent and hasattr(Intent, "FLAG_ACTIVITY_NEW_TASK"):
                        google_launch.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                except Exception:
                    pass
                try:
                    ctx.startActivity(google_launch)
                    return True
                except Exception:
                    pass

            # Fallback: ACTION_ASSIST
            try:
                assist_intent = Intent("android.intent.action.ASSIST")
                if assist_intent:
                    ctx.startActivity(assist_intent)
                    return True
            except Exception:
                pass

            return False
        except Exception:
            return False

    def _on_context_menu_click(self, ctx):
        try:
            message = None
            try:
                message = ctx.get("message") if ctx else None
            except Exception:
                message = None
            if not message:
                try:
                    message = ctx.get("message_object") or ctx.get("msg") if ctx else None
                except Exception:
                    message = None
            if not message:
                return
            if not self._message_has_text(message):
                return
            # Usa o fluxo existente: extrai o texto e abre a pesquisa
            self._on_search_message_click(message)
        except Exception:
            pass

    def _show_how_to_use_sheet(self):
        try:
            fragment = get_last_fragment()
            ctx = fragment.getParentActivity() if fragment and fragment.getParentActivity() else None
            if not ctx:
                return

            sheet = BottomSheet(ctx, True)

            container = LinearLayout(ctx)
            container.setOrientation(LinearLayout.VERTICAL)

            # T√≠tulo
            title_view = TextView(ctx)
            title_view.setText(self._t("howto_title"))
            try:
                title_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
            except Exception:
                pass
            title_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 18)
            title_view.setGravity(Gravity.START)
            container.addView(title_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 16, 24, 8))

            # √çcone
            try:
                iv = ImageView(ctx)
                rid = self._resolve_drawable_id("msg_info_remix") or self._resolve_drawable_id("msg_search_remix")
                if rid:
                    iv.setImageResource(rid)
                container.addView(iv, LayoutHelper.createLinear(36, 36, Gravity.TOP | Gravity.START, 24, 4, 24, 8))
            except Exception:
                pass

            # Descri√ß√£o
            desc_view = TextView(ctx)
            desc_view.setText(self._t("howto_description"))
            try:
                desc_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
            except Exception:
                pass
            desc_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            desc_view.setGravity(Gravity.START)
            container.addView(desc_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 0, 24, 16))

            # Bot√£o "Entendi" (aprimorar)
            button_container = FrameLayout(ctx)
            btn = SimpleTextView(ctx)
            btn.setText(self._t("understood"))
            btn.setTextSize(16)
            try:
                btn.setTextColor(Theme.getColor(Theme.key_dialogTextBlue))
            except Exception:
                pass
            btn.setGravity(Gravity.CENTER)
            button_container.addView(btn, LayoutHelper.createFrame(-1, 48, Gravity.CENTER))

            def _dismiss(*args):
                try:
                    sheet.dismiss()
                except Exception:
                    pass

            btn.setOnClickListener(OnClickListener(_dismiss))
            container.addView(button_container, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 8, 24, 16))

            sheet.setCustomView(container)
            run_on_ui_thread(sheet.show)
        except Exception:
            pass

    def _message_has_text(self, m) -> bool:
        try:
            if m is None:
                return False
            # Try common fields
            txt = None
            try:
                txt = getattr(m.messageOwner, 'message', None)
            except Exception:
                txt = None
            if not txt:
                try:
                    txt = getattr(m, 'messageText', None)
                except Exception:
                    txt = None
            if not txt:
                try:
                    txt = m.getMessageText()
                except Exception:
                    txt = None
            return bool(txt and str(txt).strip())
        except Exception:
            return False

    def _extract_text_from_message(self, m) -> str:
        try:
            txt = None
            try:
                txt = getattr(m.messageOwner, 'message', None)
            except Exception:
                txt = None
            if not txt:
                try:
                    txt = getattr(m, 'messageText', None)
                except Exception:
                    txt = None
            if not txt:
                try:
                    txt = m.getMessageText()
                except Exception:
                    txt = None
            return (txt or '').strip()
        except Exception:
            return ''

    def _on_search_message_click(self, *args, **kwargs):
        try:
            # First arg is likely the MessageObject
            message = args[0] if args and args[0] is not None else None
            query = self._extract_text_from_message(message)
            fragment = get_last_fragment()
            activity = fragment.getParentActivity() if fragment else None
            self._show_search_dialog(activity, query)
        except Exception:
            pass

    def _get_message_from_text_view(self, text_view):
        try:
            # Tenta getter direto
            try:
                return text_view.getMessageObject()
            except Exception:
                pass
            # Percorre os pais para encontrar ChatMessageCell
            parent = None
            try:
                parent = text_view.getParent()
            except Exception:
                parent = None
            depth = 0
            while parent is not None and depth < 6:
                try:
                    cls_name = parent.getClass().getName()
                except Exception:
                    cls_name = ""
                if "ChatMessageCell" in str(cls_name):
                    try:
                        msg = getattr(parent, 'currentMessageObject', None)
                        if not msg:
                            msg = getattr(parent, 'messageObject', None)
                        if msg:
                            return msg
                    except Exception:
                        pass
                try:
                    parent = parent.getParent()
                except Exception:
                    parent = None
                depth += 1
        except Exception:
            pass
        return None

    def _get_word_at_offset(self, text: str, offset: int) -> str:
        try:
            if text is None:
                return ""
            s = str(text)
            n = len(s)
            if n == 0:
                return ""
            if offset is None or offset < 0:
                offset = 0
            if offset >= n:
                offset = n - 1
            start = offset
            end = offset
            while start > 0 and s[start-1].isalnum():
                start -= 1
            while end < n and s[end].isalnum():
                end += 1
            return s[start:end]
        except Exception:
            return ""

    def _hook_message_text_touch(self):
        try:
            MessageTextView = find_class("org.telegram.ui.Components.MessageTextView")
            MotionEvent = find_class("android.view.MotionEvent")
            if MessageTextView is None or MotionEvent is None:
                return

            on_touch = MessageTextView.getClass().getDeclaredMethod(
                "onTouchEvent",
                MotionEvent,
            )
            on_touch.setAccessible(True)

            self.hook_message_text_touch_ref = self.hook_method(
                on_touch, SearchItMsgTextTouchHook(self)
            )
        except Exception:
            pass


class SearchItActionModeMenuHook:
    def __init__(self, plugin: SearchItPlugin):
        self.plugin = plugin

    def before_hooked_method(self, param):
        try:
            menu = param.args[0]
            if menu is None:
                return

            # Avoid duplicates
            if menu.findItem(self.plugin.menu_item_id) is not None:
                return

            title = SpannableStringBuilder(self.plugin._t("menu_item_search"))
            try:
                title.setSpan(TypefaceSpan(Typeface.DEFAULT), 0, title.length(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE)
            except Exception:
                pass

            # Order after common formatting items
            # Order 0 to appear early; group matches formatting items
            item = menu.add(R_tg.id.menu_groupbolditalic, self.plugin.menu_item_id, 0, title)
            try:
                # √çcone do item (msg_search_remix)
                res_id = self.plugin._resolve_drawable_id("msg_search_remix")
                if res_id:
                    item.setIcon(res_id)
            except Exception:
                pass
        except Exception:
            pass


class SearchItPerformMenuActionHook:
    def __init__(self, plugin: SearchItPlugin):
        self.plugin = plugin

    def before_hooked_method(self, param):
        try:
            item_id = param.args[0]
            edit_text = param.thisObject
            if item_id != self.plugin.menu_item_id:
                return

            start = edit_text.getSelectionStart()
            end = edit_text.getSelectionEnd()
            if start is None or end is None or start < 0 or end < 0 or start == end:
                return

            text = edit_text.getText()
            if text is None:
                return
            try:
                selected = text.subSequence(start, end).toString()
            except Exception:
                selected = None

            activity = edit_text.getContext()
            self.plugin._show_search_dialog(activity, selected)
        except Exception:
            pass


class SearchItMsgTextTouchHook:
    def __init__(self, plugin: SearchItPlugin):
        self.plugin = plugin

    def after_hooked_method(self, param):
        try:
            text_view = param.thisObject
            motion_event = param.args[0]
            if text_view is None or motion_event is None:
                return

            # MotionEvent.ACTION_UP
            try:
                ACTION_UP = find_class("android.view.MotionEvent").ACTION_UP
            except Exception:
                ACTION_UP = 1

            action = motion_event.getAction()
            if action != ACTION_UP:
                return

            x = motion_event.getX()
            y = motion_event.getY()
            try:
                offset = text_view.getOffsetForPosition(x, y)
            except Exception:
                offset = None

            full_text = None
            try:
                txt = text_view.getText()
                if txt is not None:
                    full_text = txt.toString()
            except Exception:
                full_text = None

            if not full_text:
                message = self.plugin._get_message_from_text_view(text_view)
                full_text = self.plugin._extract_text_from_message(message)

            word = self.plugin._get_word_at_offset(full_text or "", offset or 0)
            if not word or not str(word).strip():
                return

            if word and str(word).strip():
                try:
                    activity = text_view.getContext()
                except Exception:
                    activity = None
                self.plugin._show_search_dialog(activity, word.strip())
        except Exception:
            pass